//
//                              VELOXCHEM
//         ----------------------------------------------------
//                     An Electronic Structure Code
//
//  Copyright © 2018-2023 by VeloxChem developers. All rights reserved.
//  Contact: https://veloxchem.org/contact
//
//  SPDX-License-Identifier: LGPL-3.0-or-later
//
//  This file is part of VeloxChem.
//
//  VeloxChem is free software: you can redistribute it and/or modify it under
//  the terms of the GNU Lesser General Public License as published by the Free
//  Software Foundation, either version 3 of the License, or (at your option)
//  any later version.
//
//  VeloxChem is distributed in the hope that it will be useful, but WITHOUT
//  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
//  FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public
//  License for more details.
//
//  You should have received a copy of the GNU Lesser General Public License
//  along with VeloxChem. If not, see <https://www.gnu.org/licenses/>.

#include <hip/hip_runtime.h>

#include "BoysFuncGPU.hpp"
#include "GpuConstants.hpp"

namespace gpu {  // gpu namespace

__global__ void
computeCoulombFockSSSS(double*         mat_J,
                       const double*   ss_mat_D,
                       const double*   ss_mat_Q_local,
                       const double*   ss_mat_Q,
                       const double*   ss_pair_data_local,
                       const uint32_t  ss_prim_pair_count_local,
                       const double*   ss_pair_data,
                       const uint32_t  ss_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double a_i, a_j, x_P, y_P, z_P, S_ij_00;

    if (ij < ss_prim_pair_count_local)
    {
        a_i     = ss_pair_data_local[ij + ss_prim_pair_count_local * 0];
        a_j     = ss_pair_data_local[ij + ss_prim_pair_count_local * 1];
        //x_ij    = ss_pair_data_local[ij + ss_prim_pair_count_local * 2];
        //y_ij    = ss_pair_data_local[ij + ss_prim_pair_count_local * 3];
        //z_ij    = ss_pair_data_local[ij + ss_prim_pair_count_local * 4];
        x_P     = ss_pair_data_local[ij + ss_prim_pair_count_local * 5];
        y_P     = ss_pair_data_local[ij + ss_prim_pair_count_local * 6];
        z_P     = ss_pair_data_local[ij + ss_prim_pair_count_local * 7];
        S_ij_00 = ss_pair_data_local[ij + ss_prim_pair_count_local * 8];
    }

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (ss_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < ss_prim_pair_count) && (ij < ss_prim_pair_count_local) && (fabs(ss_mat_Q_local[ij] * ss_mat_Q[kl] * ss_mat_D[kl]) > eri_threshold))
        {
            const auto a_k     = ss_pair_data[kl + ss_prim_pair_count * 0];
            const auto a_l     = ss_pair_data[kl + ss_prim_pair_count * 1];
            //const auto x_kl    = ss_pair_data[kl + ss_prim_pair_count * 2];
            //const auto y_kl    = ss_pair_data[kl + ss_prim_pair_count * 3];
            //const auto z_kl    = ss_pair_data[kl + ss_prim_pair_count * 4];
            const auto x_Q     = ss_pair_data[kl + ss_prim_pair_count * 5];
            const auto y_Q     = ss_pair_data[kl + ss_prim_pair_count * 6];
            const auto z_Q     = ss_pair_data[kl + ss_prim_pair_count * 7];
            const auto S_kl_00 = ss_pair_data[kl + ss_prim_pair_count * 8];
            const auto sym_kl  = ss_pair_data[kl + ss_prim_pair_count * 9];

            const double PQ[3] = {x_Q - x_P, y_Q - y_P, z_Q - z_P};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F0_t[1];

            gpu::computeBoysFunction(F0_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 0, boys_func_table, boys_func_ft);

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = Lambda * S_ij_00 * S_kl_00 * F0_t[0] * ss_mat_D[kl] * sym_kl;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < ss_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockSSSP(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   sp_mat_D,
                       const double*   ss_mat_Q_local,
                       const double*   sp_mat_Q,
                       const uint32_t* ss_first_inds_local,
                       const uint32_t* ss_second_inds_local,
                       const uint32_t  ss_prim_pair_count_local,
                       const uint32_t* sp_first_inds,
                       const uint32_t* sp_second_inds,
                       const uint32_t  sp_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (sp_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < sp_prim_pair_count) && (ij < ss_prim_pair_count_local) && (fabs(ss_mat_Q_local[ij] * sp_mat_Q[kl] * sp_mat_D[kl]) > eri_threshold))
        {
            const auto i = ss_first_inds_local[ij];
            const auto j = ss_second_inds_local[ij];

            const auto k = sp_first_inds[kl];
            const auto l = sp_second_inds[kl];

            const auto a_i = s_prim_info[i + s_prim_count * 0];
            const auto c_i = s_prim_info[i + s_prim_count * 1];
            const auto x_i = s_prim_info[i + s_prim_count * 2];
            const auto y_i = s_prim_info[i + s_prim_count * 3];
            const auto z_i = s_prim_info[i + s_prim_count * 4];

            const auto a_j = s_prim_info[j + s_prim_count * 0];
            const auto c_j = s_prim_info[j + s_prim_count * 1];
            const auto x_j = s_prim_info[j + s_prim_count * 2];
            const auto y_j = s_prim_info[j + s_prim_count * 3];
            const auto z_j = s_prim_info[j + s_prim_count * 4];

            const auto a_k = s_prim_info[k + s_prim_count * 0];
            const auto c_k = s_prim_info[k + s_prim_count * 1];
            const auto x_k = s_prim_info[k + s_prim_count * 2];
            const auto y_k = s_prim_info[k + s_prim_count * 3];
            const auto z_k = s_prim_info[k + s_prim_count * 4];

            const auto a_l = p_prim_info[l / 3 + p_prim_count * 0];
            const auto c_l = p_prim_info[l / 3 + p_prim_count * 1];
            const auto x_l = p_prim_info[l / 3 + p_prim_count * 2];
            const auto y_l = p_prim_info[l / 3 + p_prim_count * 3];
            const auto z_l = p_prim_info[l / 3 + p_prim_count * 4];

            const auto d0 = l % 3;

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F1_t[2];

            gpu::computeBoysFunction(F1_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 1, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F1_t[0] * (-a_k / (a_k + a_l)) * rkl[d0]

                    + F1_t[1] * (a_i + a_j) / (a_i + a_j + a_k + a_l) * PQ[d0] * (-1.0)

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * sp_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < ss_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockSSSD(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   sd_mat_D,
                       const double*   ss_mat_Q_local,
                       const double*   sd_mat_Q,
                       const uint32_t* ss_first_inds_local,
                       const uint32_t* ss_second_inds_local,
                       const uint32_t  ss_prim_pair_count_local,
                       const uint32_t* sd_first_inds,
                       const uint32_t* sd_second_inds,
                       const uint32_t  sd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (sd_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < sd_prim_pair_count) && (ij < ss_prim_pair_count_local) && (fabs(ss_mat_Q_local[ij] * sd_mat_Q[kl] * sd_mat_D[kl]) > eri_threshold))
        {
            const auto i = ss_first_inds_local[ij];
            const auto j = ss_second_inds_local[ij];

            const auto k = sd_first_inds[kl];
            const auto l = sd_second_inds[kl];

            const auto a_i = s_prim_info[i + s_prim_count * 0];
            const auto c_i = s_prim_info[i + s_prim_count * 1];
            const auto x_i = s_prim_info[i + s_prim_count * 2];
            const auto y_i = s_prim_info[i + s_prim_count * 3];
            const auto z_i = s_prim_info[i + s_prim_count * 4];

            const auto a_j = s_prim_info[j + s_prim_count * 0];
            const auto c_j = s_prim_info[j + s_prim_count * 1];
            const auto x_j = s_prim_info[j + s_prim_count * 2];
            const auto y_j = s_prim_info[j + s_prim_count * 3];
            const auto z_j = s_prim_info[j + s_prim_count * 4];

            const auto a_k = s_prim_info[k + s_prim_count * 0];
            const auto c_k = s_prim_info[k + s_prim_count * 1];
            const auto x_k = s_prim_info[k + s_prim_count * 2];
            const auto y_k = s_prim_info[k + s_prim_count * 3];
            const auto z_k = s_prim_info[k + s_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F2_t[3];

            gpu::computeBoysFunction(F2_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F2_t[0] * (

                        0.5 / S2 * (
                            delta[d0][d1]
                        )

                        + (
                            QD_0 * QD_1
                        )

                    )

                    + F2_t[1] * (

                        0.5 * S1 / ( S2 * S4 ) * (
                            delta[d0][d1] * (-1.0)
                        )

                        + S1 / S4 * (
                            PQ[d0] * QD_1 * (-1.0)
                            + PQ[d1] * QD_0 * (-1.0)
                        )

                    )

                    + F2_t[2] * (

                        ( S1 * S1 ) / ( S4 * S4 ) * (
                            PQ[d0] * PQ[d1]
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * sd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < ss_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockSSPP(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   pp_mat_D,
                       const double*   ss_mat_Q_local,
                       const double*   pp_mat_Q,
                       const uint32_t* ss_first_inds_local,
                       const uint32_t* ss_second_inds_local,
                       const uint32_t  ss_prim_pair_count_local,
                       const uint32_t* pp_first_inds,
                       const uint32_t* pp_second_inds,
                       const uint32_t  pp_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pp_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < pp_prim_pair_count) && (ij < ss_prim_pair_count_local) && (fabs(ss_mat_Q_local[ij] * pp_mat_Q[kl] * pp_mat_D[kl]) > eri_threshold))
        {
            const auto i = ss_first_inds_local[ij];
            const auto j = ss_second_inds_local[ij];

            const auto k = pp_first_inds[kl];
            const auto l = pp_second_inds[kl];

            const auto a_i = s_prim_info[i + s_prim_count * 0];
            const auto c_i = s_prim_info[i + s_prim_count * 1];
            const auto x_i = s_prim_info[i + s_prim_count * 2];
            const auto y_i = s_prim_info[i + s_prim_count * 3];
            const auto z_i = s_prim_info[i + s_prim_count * 4];

            const auto a_j = s_prim_info[j + s_prim_count * 0];
            const auto c_j = s_prim_info[j + s_prim_count * 1];
            const auto x_j = s_prim_info[j + s_prim_count * 2];
            const auto y_j = s_prim_info[j + s_prim_count * 3];
            const auto z_j = s_prim_info[j + s_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = p_prim_info[l / 3 + p_prim_count * 0];
            const auto c_l = p_prim_info[l / 3 + p_prim_count * 1];
            const auto x_l = p_prim_info[l / 3 + p_prim_count * 2];
            const auto y_l = p_prim_info[l / 3 + p_prim_count * 3];
            const auto z_l = p_prim_info[l / 3 + p_prim_count * 4];

            const auto c0 = k % 3;
            const auto d0 = l % 3;

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F2_t[3];

            gpu::computeBoysFunction(F2_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F2_t[0] * (

                        (

                            + QD_0 * QC_0
                        )

                        + 0.5 / S2 * (
                            delta[d0][c0]
                        )

                    )

                    + F2_t[1] * (

                        0.5 * S1 / ( S2 * S4 ) * (
                            delta[d0][c0] * (-1.0)
                        )

                        + S1 / S4 * (
                            PQ[c0] * QD_0 * (-1.0)
                            + PQ[d0] * QC_0 * (-1.0)
                        )

                    )

                    + F2_t[2] * (

                        ( S1 * S1 ) / ( S4 * S4 ) * (
                            PQ[c0] * PQ[d0]
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pp_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < ss_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockSSPD(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   ss_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* ss_first_inds_local,
                       const uint32_t* ss_second_inds_local,
                       const uint32_t  ss_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < ss_prim_pair_count_local) && (fabs(ss_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = ss_first_inds_local[ij];
            const auto j = ss_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = s_prim_info[i + s_prim_count * 0];
            const auto c_i = s_prim_info[i + s_prim_count * 1];
            const auto x_i = s_prim_info[i + s_prim_count * 2];
            const auto y_i = s_prim_info[i + s_prim_count * 3];
            const auto z_i = s_prim_info[i + s_prim_count * 4];

            const auto a_j = s_prim_info[j + s_prim_count * 0];
            const auto c_j = s_prim_info[j + s_prim_count * 1];
            const auto x_j = s_prim_info[j + s_prim_count * 2];
            const auto y_j = s_prim_info[j + s_prim_count * 3];
            const auto z_j = s_prim_info[j + s_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F3_t[4];

            gpu::computeBoysFunction(F3_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F3_t[0] * (

                        0.5 / S2 * (
                            delta[d0][d1] * QC_0
                            + delta[d1][c0] * QD_0
                            + delta[d0][c0] * QD_1
                        )

                        + (

                            + QD_0 * QD_1 * QC_0
                        )

                    )

                    + F3_t[1] * (

                        0.5 * S1 / ( S2 * S4 ) * (
                            delta[d0][d1] * (PQ[c0] * (-1.0) + QC_0 * (-1.0))
                            + delta[d1][c0] * (PQ[d0] * (-1.0) + QD_0 * (-1.0))
                            + delta[d0][c0] * (PQ[d1] * (-1.0) + QD_1 * (-1.0))
                        )

                        + S1 / S4 * (
                            PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PQ[d1] * QD_0 * QC_0 * (-1.0)
                        )

                    )

                    + F3_t[2] * (

                        ( S1 * S1 ) / ( S4 * S4 ) * (
                            PQ[c0] * PQ[d0] * QD_1
                            + PQ[c0] * PQ[d1] * QD_0
                            + PQ[d0] * PQ[d1] * QC_0
                        )

                        + 0.5 * ( S1 * S1 ) / ( S2 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[c0])
                            + delta[d1][c0] * (PQ[d0])
                            + delta[d0][c0] * (PQ[d1])
                        )

                    )

                    + F3_t[3] * (

                        ( S1 * S1 * S1 ) / ( S4 * S4 * S4 ) * (
                            PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < ss_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockSSDD(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   ss_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* ss_first_inds_local,
                       const uint32_t* ss_second_inds_local,
                       const uint32_t  ss_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < ss_prim_pair_count_local) && (fabs(ss_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = ss_first_inds_local[ij];
            const auto j = ss_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = s_prim_info[i + s_prim_count * 0];
            const auto c_i = s_prim_info[i + s_prim_count * 1];
            const auto x_i = s_prim_info[i + s_prim_count * 2];
            const auto y_i = s_prim_info[i + s_prim_count * 3];
            const auto z_i = s_prim_info[i + s_prim_count * 4];

            const auto a_j = s_prim_info[j + s_prim_count * 0];
            const auto c_j = s_prim_info[j + s_prim_count * 1];
            const auto x_j = s_prim_info[j + s_prim_count * 2];
            const auto y_j = s_prim_info[j + s_prim_count * 3];
            const auto z_j = s_prim_info[j + s_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F4_t[5];

            gpu::computeBoysFunction(F4_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F4_t[0] * (

                        0.5 / S2 * (
                            delta[d0][d1] * (QC_0 * QC_1)
                            + delta[d1][c1] * (QD_0 * QC_0)
                            + delta[d0][c1] * (QD_1 * QC_0)
                            + delta[d1][c0] * (QD_0 * QC_1)
                            + delta[d0][c0] * (QD_1 * QC_1)
                            + delta[c1][c0] * (QD_0 * QD_1)
                        )

                        + (

                            + QD_0 * QD_1 * QC_0 * QC_1
                        )

                        + 0.25 / ( S2 * S2 ) * (
                            delta[c1][c0] * delta[d0][d1]
                            + delta[d0][c0] * delta[d1][c1]
                            + delta[d0][c1] * delta[d1][c0]
                        )

                    )

                    + F4_t[1] * (

                        0.25 * S1 / ( S2 * S2 * S4 ) * (
                            delta[c1][c0] * delta[d0][d1] * (-2.0)
                            + delta[d0][c0] * delta[d1][c1] * (-2.0)
                            + delta[d0][c1] * delta[d1][c0] * (-2.0)
                        )

                        + 0.5 * S1 / ( S2 * S4 ) * (
                            delta[d0][d1] * (PQ[c0] * QC_1 * (-1.0) + PQ[c1] * QC_0 * (-1.0) + QC_0 * QC_1 * (-1.0))
                            + delta[d1][c1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0) + QD_0 * QC_0 * (-1.0))
                            + delta[d0][c1] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0) + QD_1 * QC_0 * (-1.0))
                            + delta[d1][c0] * (PQ[c1] * QD_0 * (-1.0) + PQ[d0] * QC_1 * (-1.0) + QD_0 * QC_1 * (-1.0))
                            + delta[d0][c0] * (PQ[c1] * QD_1 * (-1.0) + PQ[d1] * QC_1 * (-1.0) + QD_1 * QC_1 * (-1.0))
                            + delta[c1][c0] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0) + QD_0 * QD_1 * (-1.0))
                        )

                        + S1 / S4 * (

                            + PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                        )

                    )

                    + F4_t[2] * (

                        ( S1 * S1 ) / ( S4 * S4 ) * (
                            PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PQ[d0] * PQ[d1] * QC_0 * QC_1
                        )

                        + 0.5 * ( S1 * S1 ) / ( S2 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[c0] * PQ[c1] + PQ[c0] * QC_1 + PQ[c1] * QC_0)
                            + delta[d1][c1] * (PQ[c0] * PQ[d0] + PQ[c0] * QD_0 + PQ[d0] * QC_0)
                            + delta[d1][c0] * (PQ[c1] * PQ[d0] + PQ[c1] * QD_0 + PQ[d0] * QC_1)
                            + delta[d0][c1] * (PQ[c0] * PQ[d1] + PQ[c0] * QD_1 + PQ[d1] * QC_0)
                            + delta[d0][c0] * (PQ[c1] * PQ[d1] + PQ[c1] * QD_1 + PQ[d1] * QC_1)
                            + delta[c1][c0] * (PQ[d0] * PQ[d1] + PQ[d0] * QD_1 + PQ[d1] * QD_0)
                        )

                        + 0.25 * ( S1 * S1 ) / ( S2 * S2 * S4 * S4 ) * (
                            delta[c1][c0] * delta[d0][d1]
                            + delta[d0][c0] * delta[d1][c1]
                            + delta[d0][c1] * delta[d1][c0]
                        )

                    )

                    + F4_t[3] * (

                        ( S1 * S1 * S1 ) / ( S4 * S4 * S4 ) * (

                            + PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                        )

                        + 0.5 * ( S1 * S1 * S1 ) / ( S2 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[c0] * PQ[c1] * (-1.0))
                            + delta[d1][c1] * (PQ[c0] * PQ[d0] * (-1.0))
                            + delta[d0][c1] * (PQ[c0] * PQ[d1] * (-1.0))
                            + delta[d1][c0] * (PQ[c1] * PQ[d0] * (-1.0))
                            + delta[d0][c0] * (PQ[c1] * PQ[d1] * (-1.0))
                            + delta[c1][c0] * (PQ[d0] * PQ[d1] * (-1.0))
                        )

                    )

                    + F4_t[4] * (

                        ( S1 * S1 * S1 * S1 ) / ( S4 * S4 * S4 * S4 ) * (
                            PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < ss_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockSPSS(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   ss_mat_D,
                       const double*   sp_mat_Q_local,
                       const double*   ss_mat_Q,
                       const uint32_t* sp_first_inds_local,
                       const uint32_t* sp_second_inds_local,
                       const uint32_t  sp_prim_pair_count_local,
                       const uint32_t* ss_first_inds,
                       const uint32_t* ss_second_inds,
                       const uint32_t  ss_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (ss_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < ss_prim_pair_count) && (ij < sp_prim_pair_count_local) && (fabs(sp_mat_Q_local[ij] * ss_mat_Q[kl] * ss_mat_D[kl]) > eri_threshold))
        {
            const auto i = sp_first_inds_local[ij];
            const auto j = sp_second_inds_local[ij];

            const auto k = ss_first_inds[kl];
            const auto l = ss_second_inds[kl];

            const auto a_i = s_prim_info[i + s_prim_count * 0];
            const auto c_i = s_prim_info[i + s_prim_count * 1];
            const auto x_i = s_prim_info[i + s_prim_count * 2];
            const auto y_i = s_prim_info[i + s_prim_count * 3];
            const auto z_i = s_prim_info[i + s_prim_count * 4];

            const auto a_j = p_prim_info[j / 3 + p_prim_count * 0];
            const auto c_j = p_prim_info[j / 3 + p_prim_count * 1];
            const auto x_j = p_prim_info[j / 3 + p_prim_count * 2];
            const auto y_j = p_prim_info[j / 3 + p_prim_count * 3];
            const auto z_j = p_prim_info[j / 3 + p_prim_count * 4];

            const auto a_k = s_prim_info[k + s_prim_count * 0];
            const auto c_k = s_prim_info[k + s_prim_count * 1];
            const auto x_k = s_prim_info[k + s_prim_count * 2];
            const auto y_k = s_prim_info[k + s_prim_count * 3];
            const auto z_k = s_prim_info[k + s_prim_count * 4];

            const auto a_l = s_prim_info[l + s_prim_count * 0];
            const auto c_l = s_prim_info[l + s_prim_count * 1];
            const auto x_l = s_prim_info[l + s_prim_count * 2];
            const auto y_l = s_prim_info[l + s_prim_count * 3];
            const auto z_l = s_prim_info[l + s_prim_count * 4];

            const auto b0 = j % 3;

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F1_t[2];

            gpu::computeBoysFunction(F1_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 1, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F1_t[0] * (-a_i / (a_i + a_j)) * rij[b0]

                    + F1_t[1] * (a_k + a_l) / (a_i + a_j + a_k + a_l) * PQ[b0]

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * ss_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < sp_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockSPSP(double*         mat_J,
                       const double*   sp_mat_D,
                       const double*   sp_mat_Q_local,
                       const double*   sp_mat_Q,
                       const double*   sp_pair_data_local,
                       const uint32_t* sp_pair_cart_local,
                       const uint32_t  sp_prim_pair_count_local,
                       const double*   sp_pair_data,
                       const uint32_t* sp_pair_cart,
                       const uint32_t  sp_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double a_i, a_j, rij[3], rP[3], S_ij_00;

    uint32_t b0;

    if (ij < sp_prim_pair_count_local)
    {
        a_i     = sp_pair_data_local[ij + sp_prim_pair_count_local * 0];
        a_j     = sp_pair_data_local[ij + sp_prim_pair_count_local * 1];
        rij[0]  = sp_pair_data_local[ij + sp_prim_pair_count_local * 2];
        rij[1]  = sp_pair_data_local[ij + sp_prim_pair_count_local * 3];
        rij[2]  = sp_pair_data_local[ij + sp_prim_pair_count_local * 4];
        rP[0]   = sp_pair_data_local[ij + sp_prim_pair_count_local * 5];
        rP[1]   = sp_pair_data_local[ij + sp_prim_pair_count_local * 6];
        rP[2]   = sp_pair_data_local[ij + sp_prim_pair_count_local * 7];
        S_ij_00 = sp_pair_data_local[ij + sp_prim_pair_count_local * 8];

        b0 = sp_pair_cart_local[ij + sp_prim_pair_count_local * 0];
    }

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (sp_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < sp_prim_pair_count) && (ij < sp_prim_pair_count_local) && (fabs(sp_mat_Q_local[ij] * sp_mat_Q[kl] * sp_mat_D[kl]) > eri_threshold))
        {
            const auto a_k      =  sp_pair_data[kl + sp_prim_pair_count * 0];
            const auto a_l      =  sp_pair_data[kl + sp_prim_pair_count * 1];
            const double rkl[3] = {sp_pair_data[kl + sp_prim_pair_count * 2],
                                   sp_pair_data[kl + sp_prim_pair_count * 3],
                                   sp_pair_data[kl + sp_prim_pair_count * 4]};
            const double rQ[3]  = {sp_pair_data[kl + sp_prim_pair_count * 5],
                                   sp_pair_data[kl + sp_prim_pair_count * 6],
                                   sp_pair_data[kl + sp_prim_pair_count * 7]};
            const auto S_kl_00  =  sp_pair_data[kl + sp_prim_pair_count * 8];

            const auto d0 = sp_pair_cart[kl + sp_prim_pair_count * 0];

            const double PQ[3] = {rQ[0] - rP[0], rQ[1] - rP[1], rQ[2] - rP[2]};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = S1 + S2;

            const auto Lambda = sqrt(4.0 * S1 * S2 / (MATH_CONST_PI * S4));

            double F2_t[3];

            gpu::computeBoysFunction(F2_t, S1 * S2 / S4 * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto PB_0 = (-a_i / S1) * rij[b0];
            const auto QD_0 = (-a_k / S2) * rkl[d0];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F2_t[0] * (

                        (
                            PB_0 * QD_0
                        )

                    )

                    + F2_t[1] * (

                        S1 / S4 * (
                            PB_0 * PQ[d0] * (-1.0)
                        )

                        + 0.5 / S4 * (
                            delta[b0][d0]
                        )

                        + S2 / S4 * (
                            PQ[b0] * QD_0
                        )

                    )

                    + F2_t[2] * (

                        ( S1 * S2 ) / ( S4 * S4 ) * (
                            PQ[b0] * PQ[d0] * (-1.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * sp_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < sp_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockSPSD(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   sd_mat_D,
                       const double*   sp_mat_Q_local,
                       const double*   sd_mat_Q,
                       const uint32_t* sp_first_inds_local,
                       const uint32_t* sp_second_inds_local,
                       const uint32_t  sp_prim_pair_count_local,
                       const uint32_t* sd_first_inds,
                       const uint32_t* sd_second_inds,
                       const uint32_t  sd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (sd_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < sd_prim_pair_count) && (ij < sp_prim_pair_count_local) && (fabs(sp_mat_Q_local[ij] * sd_mat_Q[kl] * sd_mat_D[kl]) > eri_threshold))
        {
            const auto i = sp_first_inds_local[ij];
            const auto j = sp_second_inds_local[ij];

            const auto k = sd_first_inds[kl];
            const auto l = sd_second_inds[kl];

            const auto a_i = s_prim_info[i + s_prim_count * 0];
            const auto c_i = s_prim_info[i + s_prim_count * 1];
            const auto x_i = s_prim_info[i + s_prim_count * 2];
            const auto y_i = s_prim_info[i + s_prim_count * 3];
            const auto z_i = s_prim_info[i + s_prim_count * 4];

            const auto a_j = p_prim_info[j / 3 + p_prim_count * 0];
            const auto c_j = p_prim_info[j / 3 + p_prim_count * 1];
            const auto x_j = p_prim_info[j / 3 + p_prim_count * 2];
            const auto y_j = p_prim_info[j / 3 + p_prim_count * 3];
            const auto z_j = p_prim_info[j / 3 + p_prim_count * 4];

            const auto a_k = s_prim_info[k + s_prim_count * 0];
            const auto c_k = s_prim_info[k + s_prim_count * 1];
            const auto x_k = s_prim_info[k + s_prim_count * 2];
            const auto y_k = s_prim_info[k + s_prim_count * 3];
            const auto z_k = s_prim_info[k + s_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto b0 = j % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F3_t[4];

            gpu::computeBoysFunction(F3_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F3_t[0] * (

                        0.5 / S2 * (
                            delta[d0][d1] * PB_0
                        )

                        + (
                            PB_0 * QD_0 * QD_1
                        )

                    )

                    + F3_t[1] * (

                        0.5 * S1 / ( S2 * S4 ) * (
                            delta[d0][d1] * (PB_0 * (-1.0))
                        )

                        + S1 / S4 * (
                            PB_0 * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PQ[d1] * QD_0 * (-1.0)
                        )

                        + 0.5 / S4 * (
                            delta[d0][d1] * (PQ[b0])
                            + delta[b0][d1] * QD_0
                            + delta[b0][d0] * QD_1
                        )

                        + S2 / S4 * (
                            PQ[b0] * QD_0 * QD_1
                        )

                    )

                    + F3_t[2] * (

                        ( S1 * S1 ) / ( S4 * S4 ) * (
                            PB_0 * PQ[d0] * PQ[d1]
                        )

                        + 0.5 * S1 / ( S4 * S4 ) * (
                            delta[d0][d1] * (PQ[b0] * (-1.0))
                            + delta[b0][d1] * (PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PQ[d1] * (-1.0))
                        )

                        + ( S1 * S2 ) / ( S4 * S4 ) * (
                            PQ[b0] * PQ[d0] * QD_1 * (-1.0)
                            + PQ[b0] * PQ[d1] * QD_0 * (-1.0)
                        )

                    )

                    + F3_t[3] * (

                        ( S1 * S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            PQ[b0] * PQ[d0] * PQ[d1]
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * sd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < sp_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockSPPP(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   pp_mat_D,
                       const double*   sp_mat_Q_local,
                       const double*   pp_mat_Q,
                       const uint32_t* sp_first_inds_local,
                       const uint32_t* sp_second_inds_local,
                       const uint32_t  sp_prim_pair_count_local,
                       const uint32_t* pp_first_inds,
                       const uint32_t* pp_second_inds,
                       const uint32_t  pp_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pp_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < pp_prim_pair_count) && (ij < sp_prim_pair_count_local) && (fabs(sp_mat_Q_local[ij] * pp_mat_Q[kl] * pp_mat_D[kl]) > eri_threshold))
        {
            const auto i = sp_first_inds_local[ij];
            const auto j = sp_second_inds_local[ij];

            const auto k = pp_first_inds[kl];
            const auto l = pp_second_inds[kl];

            const auto a_i = s_prim_info[i + s_prim_count * 0];
            const auto c_i = s_prim_info[i + s_prim_count * 1];
            const auto x_i = s_prim_info[i + s_prim_count * 2];
            const auto y_i = s_prim_info[i + s_prim_count * 3];
            const auto z_i = s_prim_info[i + s_prim_count * 4];

            const auto a_j = p_prim_info[j / 3 + p_prim_count * 0];
            const auto c_j = p_prim_info[j / 3 + p_prim_count * 1];
            const auto x_j = p_prim_info[j / 3 + p_prim_count * 2];
            const auto y_j = p_prim_info[j / 3 + p_prim_count * 3];
            const auto z_j = p_prim_info[j / 3 + p_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = p_prim_info[l / 3 + p_prim_count * 0];
            const auto c_l = p_prim_info[l / 3 + p_prim_count * 1];
            const auto x_l = p_prim_info[l / 3 + p_prim_count * 2];
            const auto y_l = p_prim_info[l / 3 + p_prim_count * 3];
            const auto z_l = p_prim_info[l / 3 + p_prim_count * 4];

            const auto b0 = j % 3;
            const auto c0 = k % 3;
            const auto d0 = l % 3;

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F3_t[4];

            gpu::computeBoysFunction(F3_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F3_t[0] * (

                        (

                            + PB_0 * QD_0 * QC_0
                        )

                        + 0.5 / S2 * (
                            delta[d0][c0] * PB_0
                        )

                    )

                    + F3_t[1] * (

                        0.5 * S1 / ( S2 * S4 ) * (
                            delta[d0][c0] * (PB_0 * (-1.0))
                        )

                        + 0.5 / S4 * (
                            delta[b0][d0] * QC_0
                            + delta[d0][c0] * (PQ[b0])
                            + delta[b0][c0] * QD_0
                        )

                        + S1 / S4 * (
                            PB_0 * PQ[c0] * QD_0 * (-1.0)
                            + PB_0 * PQ[d0] * QC_0 * (-1.0)
                        )

                        + S2 / S4 * (

                            + PQ[b0] * QD_0 * QC_0
                        )

                    )

                    + F3_t[2] * (

                        ( S1 * S1 ) / ( S4 * S4 ) * (
                            PB_0 * PQ[c0] * PQ[d0]
                        )

                        + ( S1 * S2 ) / ( S4 * S4 ) * (

                            + PQ[b0] * PQ[c0] * QD_0 * (-1.0)
                            + PQ[b0] * PQ[d0] * QC_0 * (-1.0)
                        )

                        + 0.5 * S1 / ( S4 * S4 ) * (
                            delta[d0][c0] * (PQ[b0] * (-1.0))
                            + delta[b0][d0] * (PQ[c0] * (-1.0))
                            + delta[b0][c0] * (PQ[d0] * (-1.0))
                        )

                    )

                    + F3_t[3] * (

                        ( S1 * S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            PQ[b0] * PQ[c0] * PQ[d0]
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pp_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < sp_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockSPPD(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   sp_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* sp_first_inds_local,
                       const uint32_t* sp_second_inds_local,
                       const uint32_t  sp_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < sp_prim_pair_count_local) && (fabs(sp_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = sp_first_inds_local[ij];
            const auto j = sp_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = s_prim_info[i + s_prim_count * 0];
            const auto c_i = s_prim_info[i + s_prim_count * 1];
            const auto x_i = s_prim_info[i + s_prim_count * 2];
            const auto y_i = s_prim_info[i + s_prim_count * 3];
            const auto z_i = s_prim_info[i + s_prim_count * 4];

            const auto a_j = p_prim_info[j / 3 + p_prim_count * 0];
            const auto c_j = p_prim_info[j / 3 + p_prim_count * 1];
            const auto x_j = p_prim_info[j / 3 + p_prim_count * 2];
            const auto y_j = p_prim_info[j / 3 + p_prim_count * 3];
            const auto z_j = p_prim_info[j / 3 + p_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto b0 = j % 3;
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F4_t[5];

            gpu::computeBoysFunction(F4_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F4_t[0] * (

                        0.5 / S2 * (
                            delta[d0][d1] * (PB_0 * QC_0)
                            + delta[d1][c0] * (PB_0 * QD_0)
                            + delta[d0][c0] * (PB_0 * QD_1)
                        )

                        + (

                            + PB_0 * QD_0 * QD_1 * QC_0
                        )

                    )

                    + F4_t[1] * (

                        0.5 * S1 / ( S2 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[c0] * (-1.0) + PB_0 * QC_0 * (-1.0))
                            + delta[d1][c0] * (PB_0 * PQ[d0] * (-1.0) + PB_0 * QD_0 * (-1.0))
                            + delta[d0][c0] * (PB_0 * PQ[d1] * (-1.0) + PB_0 * QD_1 * (-1.0))
                        )

                        + 0.5 / S4 * (
                            delta[d0][d1] * (PQ[b0] * QC_0)
                            + delta[b0][d1] * (QD_0 * QC_0)
                            + delta[b0][d0] * (QD_1 * QC_0)
                            + delta[d1][c0] * (PQ[b0] * QD_0)
                            + delta[d0][c0] * (PQ[b0] * QD_1)
                            + delta[b0][c0] * (QD_0 * QD_1)
                        )

                        + S1 / S4 * (
                            PB_0 * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PB_0 * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PQ[d1] * QD_0 * QC_0 * (-1.0)
                        )

                        + S2 / S4 * (

                            + PQ[b0] * QD_0 * QD_1 * QC_0
                        )

                        + 0.25 / ( S2 * S4 ) * (
                            delta[b0][c0] * delta[d0][d1]
                            + delta[b0][d0] * delta[d1][c0]
                            + delta[b0][d1] * delta[d0][c0]
                        )

                    )

                    + F4_t[2] * (

                        ( S1 * S1 ) / ( S4 * S4 ) * (
                            PB_0 * PQ[c0] * PQ[d0] * QD_1
                            + PB_0 * PQ[c0] * PQ[d1] * QD_0
                            + PB_0 * PQ[d0] * PQ[d1] * QC_0
                        )

                        + ( S1 * S2 ) / ( S4 * S4 ) * (

                            + PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                        )

                        + 0.25 * S1 / ( S2 * S4 * S4 ) * (
                            delta[b0][c0] * delta[d0][d1] * (-1.0)
                            + delta[b0][d0] * delta[d1][c0] * (-1.0)
                            + delta[b0][d1] * delta[d0][c0] * (-1.0)
                        )

                        + 0.5 * S1 / ( S4 * S4 ) * (
                            delta[d0][d1] * (PQ[b0] * PQ[c0] * (-1.0) + PQ[b0] * QC_0 * (-1.0))
                            + delta[d1][c0] * (PQ[b0] * PQ[d0] * (-1.0) + PQ[b0] * QD_0 * (-1.0))
                            + delta[d0][c0] * (PQ[b0] * PQ[d1] * (-1.0) + PQ[b0] * QD_1 * (-1.0))
                            + delta[b0][d1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][d0] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][c0] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                        )

                        + 0.5 * ( S1 * S1 ) / ( S2 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[c0])
                            + delta[d1][c0] * (PB_0 * PQ[d0])
                            + delta[d0][c0] * (PB_0 * PQ[d1])
                        )

                    )

                    + F4_t[3] * (

                        ( S1 * S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            PQ[b0] * PQ[c0] * PQ[d0] * QD_1
                            + PQ[b0] * PQ[c0] * PQ[d1] * QD_0
                            + PQ[b0] * PQ[d0] * PQ[d1] * QC_0
                        )

                        + ( S1 * S1 * S1 ) / ( S4 * S4 * S4 ) * (
                            PB_0 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                        )

                        + 0.5 * ( S1 * S1 ) / ( S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[b0] * PQ[c0])
                            + delta[d1][c0] * (PQ[b0] * PQ[d0])
                            + delta[d0][c0] * (PQ[b0] * PQ[d1])
                            + delta[b0][d1] * (PQ[c0] * PQ[d0])
                            + delta[b0][d0] * (PQ[c0] * PQ[d1])
                            + delta[b0][c0] * (PQ[d0] * PQ[d1])
                        )

                    )

                    + F4_t[4] * (

                        ( S1 * S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < sp_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPPSS(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   ss_mat_D,
                       const double*   pp_mat_Q_local,
                       const double*   ss_mat_Q,
                       const uint32_t* pp_first_inds_local,
                       const uint32_t* pp_second_inds_local,
                       const uint32_t  pp_prim_pair_count_local,
                       const uint32_t* ss_first_inds,
                       const uint32_t* ss_second_inds,
                       const uint32_t  ss_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (ss_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < ss_prim_pair_count) && (ij < pp_prim_pair_count_local) && (fabs(pp_mat_Q_local[ij] * ss_mat_Q[kl] * ss_mat_D[kl]) > eri_threshold))
        {
            const auto i = pp_first_inds_local[ij];
            const auto j = pp_second_inds_local[ij];

            const auto k = ss_first_inds[kl];
            const auto l = ss_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = p_prim_info[j / 3 + p_prim_count * 0];
            const auto c_j = p_prim_info[j / 3 + p_prim_count * 1];
            const auto x_j = p_prim_info[j / 3 + p_prim_count * 2];
            const auto y_j = p_prim_info[j / 3 + p_prim_count * 3];
            const auto z_j = p_prim_info[j / 3 + p_prim_count * 4];

            const auto a_k = s_prim_info[k + s_prim_count * 0];
            const auto c_k = s_prim_info[k + s_prim_count * 1];
            const auto x_k = s_prim_info[k + s_prim_count * 2];
            const auto y_k = s_prim_info[k + s_prim_count * 3];
            const auto z_k = s_prim_info[k + s_prim_count * 4];

            const auto a_l = s_prim_info[l + s_prim_count * 0];
            const auto c_l = s_prim_info[l + s_prim_count * 1];
            const auto x_l = s_prim_info[l + s_prim_count * 2];
            const auto y_l = s_prim_info[l + s_prim_count * 3];
            const auto z_l = s_prim_info[l + s_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = j % 3;

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F2_t[3];

            gpu::computeBoysFunction(F2_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F2_t[0] * (

                        (

                            + PB_0 * PA_0
                        )

                        + 0.5 / S1 * (
                            delta[b0][a0]
                        )

                    )

                    + F2_t[1] * (

                        0.5 * S2 / ( S1 * S4 ) * (
                            delta[b0][a0] * (-1.0)
                        )

                        + S2 / S4 * (

                            + PB_0 * PQ[a0]
                            + PA_0 * PQ[b0]
                        )

                    )

                    + F2_t[2] * (

                        ( S2 * S2 ) / ( S4 * S4 ) * (
                            PQ[a0] * PQ[b0]
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * ss_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pp_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPPSP(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   sp_mat_D,
                       const double*   pp_mat_Q_local,
                       const double*   sp_mat_Q,
                       const uint32_t* pp_first_inds_local,
                       const uint32_t* pp_second_inds_local,
                       const uint32_t  pp_prim_pair_count_local,
                       const uint32_t* sp_first_inds,
                       const uint32_t* sp_second_inds,
                       const uint32_t  sp_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (sp_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < sp_prim_pair_count) && (ij < pp_prim_pair_count_local) && (fabs(pp_mat_Q_local[ij] * sp_mat_Q[kl] * sp_mat_D[kl]) > eri_threshold))
        {
            const auto i = pp_first_inds_local[ij];
            const auto j = pp_second_inds_local[ij];

            const auto k = sp_first_inds[kl];
            const auto l = sp_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = p_prim_info[j / 3 + p_prim_count * 0];
            const auto c_j = p_prim_info[j / 3 + p_prim_count * 1];
            const auto x_j = p_prim_info[j / 3 + p_prim_count * 2];
            const auto y_j = p_prim_info[j / 3 + p_prim_count * 3];
            const auto z_j = p_prim_info[j / 3 + p_prim_count * 4];

            const auto a_k = s_prim_info[k + s_prim_count * 0];
            const auto c_k = s_prim_info[k + s_prim_count * 1];
            const auto x_k = s_prim_info[k + s_prim_count * 2];
            const auto y_k = s_prim_info[k + s_prim_count * 3];
            const auto z_k = s_prim_info[k + s_prim_count * 4];

            const auto a_l = p_prim_info[l / 3 + p_prim_count * 0];
            const auto c_l = p_prim_info[l / 3 + p_prim_count * 1];
            const auto x_l = p_prim_info[l / 3 + p_prim_count * 2];
            const auto y_l = p_prim_info[l / 3 + p_prim_count * 3];
            const auto z_l = p_prim_info[l / 3 + p_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = j % 3;
            const auto d0 = l % 3;

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F3_t[4];

            gpu::computeBoysFunction(F3_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F3_t[0] * (

                        (

                            + PB_0 * PA_0 * QD_0
                        )

                        + 0.5 / S1 * (
                            delta[b0][a0] * QD_0
                        )

                    )

                    + F3_t[1] * (

                        0.5 * S2 / ( S1 * S4 ) * (
                            delta[b0][a0] * (QD_0 * (-1.0))
                        )

                        + 0.5 / S4 * (
                            delta[b0][d0] * PA_0
                            + delta[b0][a0] * (PQ[d0] * (-1.0))
                            + delta[a0][d0] * PB_0
                        )

                        + S1 / S4 * (

                            + PB_0 * PA_0 * PQ[d0] * (-1.0)
                        )

                        + S2 / S4 * (

                            + PB_0 * PQ[a0] * QD_0
                            + PA_0 * PQ[b0] * QD_0
                        )

                    )

                    + F3_t[2] * (

                        ( S1 * S2 ) / ( S4 * S4 ) * (

                            + PB_0 * PQ[a0] * PQ[d0] * (-1.0)
                            + PA_0 * PQ[b0] * PQ[d0] * (-1.0)
                        )

                        + ( S2 * S2 ) / ( S4 * S4 ) * (
                            PQ[a0] * PQ[b0] * QD_0
                        )

                        + 0.5 * S2 / ( S4 * S4 ) * (
                            delta[b0][d0] * (PQ[a0])
                            + delta[a0][d0] * (PQ[b0])
                            + delta[b0][a0] * (PQ[d0])
                        )

                    )

                    + F3_t[3] * (

                        ( S1 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[b0] * PQ[d0] * (-1.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * sp_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pp_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockSDSS(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   ss_mat_D,
                       const double*   sd_mat_Q_local,
                       const double*   ss_mat_Q,
                       const uint32_t* sd_first_inds_local,
                       const uint32_t* sd_second_inds_local,
                       const uint32_t  sd_prim_pair_count_local,
                       const uint32_t* ss_first_inds,
                       const uint32_t* ss_second_inds,
                       const uint32_t  ss_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (ss_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < ss_prim_pair_count) && (ij < sd_prim_pair_count_local) && (fabs(sd_mat_Q_local[ij] * ss_mat_Q[kl] * ss_mat_D[kl]) > eri_threshold))
        {
            const auto i = sd_first_inds_local[ij];
            const auto j = sd_second_inds_local[ij];

            const auto k = ss_first_inds[kl];
            const auto l = ss_second_inds[kl];

            const auto a_i = s_prim_info[i + s_prim_count * 0];
            const auto c_i = s_prim_info[i + s_prim_count * 1];
            const auto x_i = s_prim_info[i + s_prim_count * 2];
            const auto y_i = s_prim_info[i + s_prim_count * 3];
            const auto z_i = s_prim_info[i + s_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = s_prim_info[k + s_prim_count * 0];
            const auto c_k = s_prim_info[k + s_prim_count * 1];
            const auto x_k = s_prim_info[k + s_prim_count * 2];
            const auto y_k = s_prim_info[k + s_prim_count * 3];
            const auto z_k = s_prim_info[k + s_prim_count * 4];

            const auto a_l = s_prim_info[l + s_prim_count * 0];
            const auto c_l = s_prim_info[l + s_prim_count * 1];
            const auto x_l = s_prim_info[l + s_prim_count * 2];
            const auto y_l = s_prim_info[l + s_prim_count * 3];
            const auto z_l = s_prim_info[l + s_prim_count * 4];

            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F2_t[3];

            gpu::computeBoysFunction(F2_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F2_t[0] * (

                        0.5 / S1 * (
                            delta[b0][b1]
                        )

                        + (
                            PB_0 * PB_1
                        )

                    )

                    + F2_t[1] * (

                        0.5 * S2 / ( S1 * S4 ) * (
                            delta[b0][b1] * (-1.0)
                        )

                        + S2 / S4 * (
                            PB_0 * PQ[b1]
                            + PB_1 * PQ[b0]
                        )

                    )

                    + F2_t[2] * (

                        ( S2 * S2 ) / ( S4 * S4 ) * (
                            PQ[b0] * PQ[b1]
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * ss_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < sd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockSDSP(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   sp_mat_D,
                       const double*   sd_mat_Q_local,
                       const double*   sp_mat_Q,
                       const uint32_t* sd_first_inds_local,
                       const uint32_t* sd_second_inds_local,
                       const uint32_t  sd_prim_pair_count_local,
                       const uint32_t* sp_first_inds,
                       const uint32_t* sp_second_inds,
                       const uint32_t  sp_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (sp_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < sp_prim_pair_count) && (ij < sd_prim_pair_count_local) && (fabs(sd_mat_Q_local[ij] * sp_mat_Q[kl] * sp_mat_D[kl]) > eri_threshold))
        {
            const auto i = sd_first_inds_local[ij];
            const auto j = sd_second_inds_local[ij];

            const auto k = sp_first_inds[kl];
            const auto l = sp_second_inds[kl];

            const auto a_i = s_prim_info[i + s_prim_count * 0];
            const auto c_i = s_prim_info[i + s_prim_count * 1];
            const auto x_i = s_prim_info[i + s_prim_count * 2];
            const auto y_i = s_prim_info[i + s_prim_count * 3];
            const auto z_i = s_prim_info[i + s_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = s_prim_info[k + s_prim_count * 0];
            const auto c_k = s_prim_info[k + s_prim_count * 1];
            const auto x_k = s_prim_info[k + s_prim_count * 2];
            const auto y_k = s_prim_info[k + s_prim_count * 3];
            const auto z_k = s_prim_info[k + s_prim_count * 4];

            const auto a_l = p_prim_info[l / 3 + p_prim_count * 0];
            const auto c_l = p_prim_info[l / 3 + p_prim_count * 1];
            const auto x_l = p_prim_info[l / 3 + p_prim_count * 2];
            const auto y_l = p_prim_info[l / 3 + p_prim_count * 3];
            const auto z_l = p_prim_info[l / 3 + p_prim_count * 4];

            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto d0 = l % 3;

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F3_t[4];

            gpu::computeBoysFunction(F3_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F3_t[0] * (

                        0.5 / S1 * (
                            delta[b0][b1] * QD_0
                        )

                        + (
                            PB_0 * PB_1 * QD_0
                        )

                    )

                    + F3_t[1] * (

                        0.5 * S2 / ( S1 * S4 ) * (
                            delta[b0][b1] * (QD_0 * (-1.0))
                        )

                        + 0.5 / S4 * (
                            delta[b0][b1] * (PQ[d0] * (-1.0))
                            + delta[b1][d0] * PB_0
                            + delta[b0][d0] * PB_1
                        )

                        + S1 / S4 * (
                            PB_0 * PB_1 * PQ[d0] * (-1.0)
                        )

                        + S2 / S4 * (
                            PB_0 * PQ[b1] * QD_0
                            + PB_1 * PQ[b0] * QD_0
                        )

                    )

                    + F3_t[2] * (

                        ( S2 * S2 ) / ( S4 * S4 ) * (
                            PQ[b0] * PQ[b1] * QD_0
                        )

                        + ( S1 * S2 ) / ( S4 * S4 ) * (
                            PB_0 * PQ[b1] * PQ[d0] * (-1.0)
                            + PB_1 * PQ[b0] * PQ[d0] * (-1.0)
                        )

                        + 0.5 * S2 / ( S4 * S4 ) * (
                            delta[b1][d0] * (PQ[b0])
                            + delta[b0][d0] * (PQ[b1])
                            + delta[b0][b1] * (PQ[d0])
                        )

                    )

                    + F3_t[3] * (

                        ( S1 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            PQ[b0] * PQ[b1] * PQ[d0] * (-1.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * sp_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < sd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDSS(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   ss_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   ss_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* ss_first_inds,
                       const uint32_t* ss_second_inds,
                       const uint32_t  ss_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (ss_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < ss_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * ss_mat_Q[kl] * ss_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = ss_first_inds[kl];
            const auto l = ss_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = s_prim_info[k + s_prim_count * 0];
            const auto c_k = s_prim_info[k + s_prim_count * 1];
            const auto x_k = s_prim_info[k + s_prim_count * 2];
            const auto y_k = s_prim_info[k + s_prim_count * 3];
            const auto z_k = s_prim_info[k + s_prim_count * 4];

            const auto a_l = s_prim_info[l + s_prim_count * 0];
            const auto c_l = s_prim_info[l + s_prim_count * 1];
            const auto x_l = s_prim_info[l + s_prim_count * 2];
            const auto y_l = s_prim_info[l + s_prim_count * 3];
            const auto z_l = s_prim_info[l + s_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F3_t[4];

            gpu::computeBoysFunction(F3_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F3_t[0] * (

                        0.5 / S1 * (
                            delta[b0][b1] * PA_0
                            + delta[b1][a0] * PB_0
                            + delta[b0][a0] * PB_1
                        )

                        + (

                            + PB_0 * PB_1 * PA_0
                        )

                    )

                    + F3_t[1] * (

                        0.5 * S2 / ( S1 * S4 ) * (
                            delta[b0][b1] * (PA_0 * (-1.0) + PQ[a0])
                            + delta[b1][a0] * (PB_0 * (-1.0) + PQ[b0])
                            + delta[b0][a0] * (PB_1 * (-1.0) + PQ[b1])
                        )

                        + S2 / S4 * (

                            + PB_0 * PB_1 * PQ[a0]
                            + PB_0 * PA_0 * PQ[b1]
                            + PB_1 * PA_0 * PQ[b0]
                        )

                    )

                    + F3_t[2] * (

                        ( S2 * S2 ) / ( S4 * S4 ) * (

                            + PB_0 * PQ[a0] * PQ[b1]
                            + PB_1 * PQ[a0] * PQ[b0]
                            + PA_0 * PQ[b0] * PQ[b1]
                        )

                        + 0.5 * ( S2 * S2 ) / ( S1 * S4 * S4 ) * (
                            delta[b0][b1] * (PQ[a0] * (-1.0))
                            + delta[b1][a0] * (PQ[b0] * (-1.0))
                            + delta[b0][a0] * (PQ[b1] * (-1.0))
                        )

                    )

                    + F3_t[3] * (

                        ( S2 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[b0] * PQ[b1]
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * ss_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDSP(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   sp_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   sp_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* sp_first_inds,
                       const uint32_t* sp_second_inds,
                       const uint32_t  sp_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (sp_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < sp_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * sp_mat_Q[kl] * sp_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = sp_first_inds[kl];
            const auto l = sp_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = s_prim_info[k + s_prim_count * 0];
            const auto c_k = s_prim_info[k + s_prim_count * 1];
            const auto x_k = s_prim_info[k + s_prim_count * 2];
            const auto y_k = s_prim_info[k + s_prim_count * 3];
            const auto z_k = s_prim_info[k + s_prim_count * 4];

            const auto a_l = p_prim_info[l / 3 + p_prim_count * 0];
            const auto c_l = p_prim_info[l / 3 + p_prim_count * 1];
            const auto x_l = p_prim_info[l / 3 + p_prim_count * 2];
            const auto y_l = p_prim_info[l / 3 + p_prim_count * 3];
            const auto z_l = p_prim_info[l / 3 + p_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto d0 = l % 3;

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F4_t[5];

            gpu::computeBoysFunction(F4_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F4_t[0] * (

                        0.5 / S1 * (
                            delta[b0][b1] * (PA_0 * QD_0)
                            + delta[b1][a0] * (PB_0 * QD_0)
                            + delta[b0][a0] * (PB_1 * QD_0)
                        )

                        + (

                            + PB_0 * PB_1 * PA_0 * QD_0
                        )

                    )

                    + F4_t[1] * (

                        0.5 * S2 / ( S1 * S4 ) * (
                            delta[b0][b1] * (PA_0 * QD_0 * (-1.0) + PQ[a0] * QD_0)
                            + delta[b1][a0] * (PB_0 * QD_0 * (-1.0) + PQ[b0] * QD_0)
                            + delta[b0][a0] * (PB_1 * QD_0 * (-1.0) + PQ[b1] * QD_0)
                        )

                        + 0.5 / S4 * (
                            delta[b1][d0] * (PB_0 * PA_0)
                            + delta[b0][d0] * (PB_1 * PA_0)
                            + delta[b0][b1] * (PA_0 * PQ[d0] * (-1.0))
                            + delta[b1][a0] * (PB_0 * PQ[d0] * (-1.0))
                            + delta[b0][a0] * (PB_1 * PQ[d0] * (-1.0))
                            + delta[a0][d0] * (PB_0 * PB_1)
                        )

                        + S1 / S4 * (

                            + PB_0 * PB_1 * PA_0 * PQ[d0] * (-1.0)
                        )

                        + S2 / S4 * (

                            + PB_0 * PB_1 * PQ[a0] * QD_0
                            + PB_0 * PA_0 * PQ[b1] * QD_0
                            + PB_1 * PA_0 * PQ[b0] * QD_0
                        )

                        + 0.25 / ( S1 * S4 ) * (
                            delta[a0][d0] * delta[b0][b1]
                            + delta[b0][a0] * delta[b1][d0]
                            + delta[b0][d0] * delta[b1][a0]
                        )

                    )

                    + F4_t[2] * (

                        ( S1 * S2 ) / ( S4 * S4 ) * (

                            + PB_0 * PB_1 * PQ[a0] * PQ[d0] * (-1.0)
                            + PB_0 * PA_0 * PQ[b1] * PQ[d0] * (-1.0)
                            + PB_1 * PA_0 * PQ[b0] * PQ[d0] * (-1.0)
                        )

                        + ( S2 * S2 ) / ( S4 * S4 ) * (

                            + PB_0 * PQ[a0] * PQ[b1] * QD_0
                            + PB_1 * PQ[a0] * PQ[b0] * QD_0
                            + PA_0 * PQ[b0] * PQ[b1] * QD_0
                        )

                        + 0.25 * S2 / ( S1 * S4 * S4 ) * (
                            delta[a0][d0] * delta[b0][b1] * (-1.0)
                            + delta[b0][a0] * delta[b1][d0] * (-1.0)
                            + delta[b0][d0] * delta[b1][a0] * (-1.0)
                        )

                        + 0.5 * ( S2 * S2 ) / ( S1 * S4 * S4 ) * (
                            delta[b0][b1] * (PQ[a0] * QD_0 * (-1.0))
                            + delta[b1][a0] * (PQ[b0] * QD_0 * (-1.0))
                            + delta[b0][a0] * (PQ[b1] * QD_0 * (-1.0))
                        )

                        + 0.5 * S2 / ( S4 * S4 ) * (
                            delta[b1][d0] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[b0][d0] * (PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[b0][b1] * (PQ[a0] * PQ[d0] * (-1.0) + PA_0 * PQ[d0])
                            + delta[b1][a0] * (PQ[b0] * PQ[d0] * (-1.0) + PB_0 * PQ[d0])
                            + delta[b0][a0] * (PQ[b1] * PQ[d0] * (-1.0) + PB_1 * PQ[d0])
                            + delta[a0][d0] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                        )

                    )

                    + F4_t[3] * (

                        ( S1 * S2 * S2 ) / ( S4 * S4 * S4 ) * (

                            + PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * (-1.0)
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * (-1.0)
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0)
                        )

                        + ( S2 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[b0] * PQ[b1] * QD_0
                        )

                        + 0.5 * ( S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            delta[b1][d0] * (PQ[a0] * PQ[b0])
                            + delta[b0][d0] * (PQ[a0] * PQ[b1])
                            + delta[b0][b1] * (PQ[a0] * PQ[d0])
                            + delta[a0][d0] * (PQ[b0] * PQ[b1])
                            + delta[b1][a0] * (PQ[b0] * PQ[d0])
                            + delta[b0][a0] * (PQ[b1] * PQ[d0])
                        )

                    )

                    + F4_t[4] * (

                        ( S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * sp_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDSS(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   ss_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   ss_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* ss_first_inds,
                       const uint32_t* ss_second_inds,
                       const uint32_t  ss_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (ss_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < ss_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * ss_mat_Q[kl] * ss_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = ss_first_inds[kl];
            const auto l = ss_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = s_prim_info[k + s_prim_count * 0];
            const auto c_k = s_prim_info[k + s_prim_count * 1];
            const auto x_k = s_prim_info[k + s_prim_count * 2];
            const auto y_k = s_prim_info[k + s_prim_count * 3];
            const auto z_k = s_prim_info[k + s_prim_count * 4];

            const auto a_l = s_prim_info[l + s_prim_count * 0];
            const auto c_l = s_prim_info[l + s_prim_count * 1];
            const auto x_l = s_prim_info[l + s_prim_count * 2];
            const auto y_l = s_prim_info[l + s_prim_count * 3];
            const auto z_l = s_prim_info[l + s_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F4_t[5];

            gpu::computeBoysFunction(F4_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F4_t[0] * (

                        0.5 / S1 * (
                            delta[b0][b1] * (PA_0 * PA_1)
                            + delta[b1][a1] * (PB_0 * PA_0)
                            + delta[b0][a1] * (PB_1 * PA_0)
                            + delta[b1][a0] * (PB_0 * PA_1)
                            + delta[b0][a0] * (PB_1 * PA_1)
                            + delta[a1][a0] * (PB_0 * PB_1)
                        )

                        + (

                            + PB_0 * PB_1 * PA_0 * PA_1
                        )

                        + 0.25 / ( S1 * S1 ) * (
                            delta[a1][a0] * delta[b0][b1]
                            + delta[b0][a0] * delta[b1][a1]
                            + delta[b0][a1] * delta[b1][a0]
                        )

                    )

                    + F4_t[1] * (

                        0.25 * S2 / ( S1 * S1 * S4 ) * (
                            delta[a1][a0] * delta[b0][b1] * (-2.0)
                            + delta[b0][a0] * delta[b1][a1] * (-2.0)
                            + delta[b0][a1] * delta[b1][a0] * (-2.0)
                        )

                        + 0.5 * S2 / ( S1 * S4 ) * (
                            delta[b0][b1] * (PA_0 * PA_1 * (-1.0) + PA_0 * PQ[a1] + PA_1 * PQ[a0])
                            + delta[b1][a1] * (PB_0 * PA_0 * (-1.0) + PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[b0][a1] * (PB_1 * PA_0 * (-1.0) + PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[b1][a0] * (PB_0 * PA_1 * (-1.0) + PB_0 * PQ[a1] + PA_1 * PQ[b0])
                            + delta[b0][a0] * (PB_1 * PA_1 * (-1.0) + PB_1 * PQ[a1] + PA_1 * PQ[b1])
                            + delta[a1][a0] * (PB_0 * PB_1 * (-1.0) + PB_0 * PQ[b1] + PB_1 * PQ[b0])
                        )

                        + S2 / S4 * (

                            + PB_0 * PB_1 * PA_0 * PQ[a1]
                            + PB_0 * PB_1 * PA_1 * PQ[a0]
                            + PB_0 * PA_0 * PA_1 * PQ[b1]
                            + PB_1 * PA_0 * PA_1 * PQ[b0]
                        )

                    )

                    + F4_t[2] * (

                        ( S2 * S2 ) / ( S4 * S4 ) * (

                            + PB_0 * PB_1 * PQ[a0] * PQ[a1]
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1]
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1]
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0]
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0]
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1]
                        )

                        + 0.5 * ( S2 * S2 ) / ( S1 * S4 * S4 ) * (
                            delta[b0][b1] * (PA_0 * PQ[a1] * (-1.0) + PA_1 * PQ[a0] * (-1.0) + PQ[a0] * PQ[a1])
                            + delta[b1][a1] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0) + PQ[a0] * PQ[b0])
                            + delta[b0][a1] * (PB_1 * PQ[a0] * (-1.0) + PA_0 * PQ[b1] * (-1.0) + PQ[a0] * PQ[b1])
                            + delta[b1][a0] * (PB_0 * PQ[a1] * (-1.0) + PA_1 * PQ[b0] * (-1.0) + PQ[a1] * PQ[b0])
                            + delta[b0][a0] * (PB_1 * PQ[a1] * (-1.0) + PA_1 * PQ[b1] * (-1.0) + PQ[a1] * PQ[b1])
                            + delta[a1][a0] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0) + PQ[b0] * PQ[b1])
                        )

                        + 0.25 * ( S2 * S2 ) / ( S1 * S1 * S4 * S4 ) * (
                            delta[a1][a0] * delta[b0][b1]
                            + delta[b0][a0] * delta[b1][a1]
                            + delta[b0][a1] * delta[b1][a0]
                        )

                    )

                    + F4_t[3] * (

                        ( S2 * S2 * S2 ) / ( S4 * S4 * S4 ) * (

                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1]
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0]
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1]
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1]
                        )

                        + 0.5 * ( S2 * S2 * S2 ) / ( S1 * S4 * S4 * S4 ) * (
                            delta[b0][b1] * (PQ[a0] * PQ[a1] * (-1.0))
                            + delta[b1][a1] * (PQ[a0] * PQ[b0] * (-1.0))
                            + delta[b0][a1] * (PQ[a0] * PQ[b1] * (-1.0))
                            + delta[b1][a0] * (PQ[a1] * PQ[b0] * (-1.0))
                            + delta[b0][a0] * (PQ[a1] * PQ[b1] * (-1.0))
                            + delta[a1][a0] * (PQ[b0] * PQ[b1] * (-1.0))
                        )

                    )

                    + F4_t[4] * (

                        ( S2 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1]
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * ss_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDPD0(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[2];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 1, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[0] * (

                        0.125 / ( S1 * S1 * S2 ) * (
                            delta[a0][a1] * delta[b0][b1] * delta[d0][d1] * (QC_0)
                            + delta[a0][b0] * delta[a1][b1] * delta[d0][d1] * (QC_0)
                            + delta[a1][b0] * delta[a0][b1] * delta[d0][d1] * (QC_0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d1] * (QD_0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d1] * (QD_0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d1] * (QD_0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * (QD_1)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * (QD_1)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * (QD_1)
                        )

                    )

                    +

                    F7_t[0] * (

                        0.25 / ( S1 * S1 ) * (
                            delta[a0][a1] * delta[b0][b1] * (QD_0 * QD_1 * QC_0)
                            + delta[a0][b0] * delta[a1][b1] * (QD_0 * QD_1 * QC_0)
                            + delta[a1][b0] * delta[a0][b1] * (QD_0 * QD_1 * QC_0)
                        )

                    )

                    +

                    F7_t[0] * (

                        0.25 / ( S1 * S2 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PA_0 * PA_1 * QC_0)
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * PA_1 * QD_0)
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * PA_1 * QD_1)
                            + delta[a1][b1] * delta[d0][d1] * (PB_0 * PA_0 * QC_0)
                            + delta[a1][b1] * delta[c0][d1] * (PB_0 * PA_0 * QD_0)
                            + delta[a1][b1] * delta[c0][d0] * (PB_0 * PA_0 * QD_1)
                            + delta[a1][b0] * delta[d0][d1] * (PB_1 * PA_0 * QC_0)
                            + delta[a1][b0] * delta[c0][d1] * (PB_1 * PA_0 * QD_0)
                            + delta[a1][b0] * delta[c0][d0] * (PB_1 * PA_0 * QD_1)
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PA_1 * QC_0)
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * PA_1 * QD_0)
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PA_1 * QD_1)
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PA_1 * QC_0)
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * PA_1 * QD_0)
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PA_1 * QD_1)
                            + delta[a0][a1] * delta[d0][d1] * (PB_0 * PB_1 * QC_0)
                            + delta[a0][a1] * delta[c0][d1] * (PB_0 * PB_1 * QD_0)
                            + delta[a0][a1] * delta[c0][d0] * (PB_0 * PB_1 * QD_1)
                        )

                    )

                    +

                    F7_t[0] * (

                        0.5 / S1 * (
                            delta[b0][b1] * (PA_0 * PA_1 * QD_0 * QD_1 * QC_0)
                            + delta[a1][b1] * (PB_0 * PA_0 * QD_0 * QD_1 * QC_0)
                            + delta[a1][b0] * (PB_1 * PA_0 * QD_0 * QD_1 * QC_0)
                            + delta[a0][b1] * (PB_0 * PA_1 * QD_0 * QD_1 * QC_0)
                            + delta[a0][b0] * (PB_1 * PA_1 * QD_0 * QD_1 * QC_0)
                            + delta[a0][a1] * (PB_0 * PB_1 * QD_0 * QD_1 * QC_0)
                        )

                    )

                    +

                    F7_t[0] * (

                        0.5 / S2 * (
                            delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PA_1 * QC_0)
                            + delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PA_1 * QD_0)
                            + delta[c0][d0] * (PB_0 * PB_1 * PA_0 * PA_1 * QD_1)
                        )

                    )

                    +

                    F7_t[0] * (

                        (
                            
                            + PB_0 * PB_1 * PA_0 * PA_1 * QD_0 * QD_1 * QC_0
                        )

                    )

                    +

                    F7_t[1] * (

                        0.125 / ( S1 * S1 * S4 ) * (
                            delta[a0][a1] * delta[b0][b1] * delta[d0][d1] * (QC_0 * (-2.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[d0][d1] * (QC_0 * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[d0][d1] * (QC_0 * (-2.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d1] * (QD_0 * (-2.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d1] * (QD_0 * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d1] * (QD_0 * (-2.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * (QD_1 * (-2.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * (QD_1 * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * (QD_1 * (-2.0))
                        )

                    )

                    +

                    F7_t[1] * (

                        0.125 / ( S1 * S2 * S4 ) * (
                            delta[a1][c0] * delta[b0][b1] * delta[d0][d1] * (PA_0)
                            + delta[a1][d0] * delta[b0][b1] * delta[c0][d1] * (PA_0)
                            + delta[a1][d1] * delta[b0][b1] * delta[c0][d0] * (PA_0)
                            + delta[a1][b0] * delta[b1][c0] * delta[d0][d1] * (PA_0)
                            + delta[a1][b0] * delta[b1][d0] * delta[c0][d1] * (PA_0)
                            + delta[a1][b0] * delta[b1][d1] * delta[c0][d0] * (PA_0)
                            + delta[b0][c0] * delta[a1][b1] * delta[d0][d1] * (PA_0)
                            + delta[b0][d0] * delta[a1][b1] * delta[c0][d1] * (PA_0)
                            + delta[b0][d1] * delta[a1][b1] * delta[c0][d0] * (PA_0)
                            + delta[a0][c0] * delta[b0][b1] * delta[d0][d1] * (PA_1)
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][d1] * (PA_1)
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][d0] * (PA_1)
                            + delta[a0][b0] * delta[b1][c0] * delta[d0][d1] * (PA_1)
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][d1] * (PA_1)
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][d0] * (PA_1)
                            + delta[b0][c0] * delta[a0][b1] * delta[d0][d1] * (PA_1)
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][d1] * (PA_1)
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][d0] * (PA_1)
                            + delta[a0][a1] * delta[b0][b1] * delta[d0][d1] * (PQ[c0] * (-1.0) + QC_0 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[d0][d1] * (PQ[c0] * (-1.0) + QC_0 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[d0][d1] * (PQ[c0] * (-1.0) + QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d1] * (PQ[d0] * (-1.0) + QD_0 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d1] * (PQ[d0] * (-1.0) + QD_0 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d1] * (PQ[d0] * (-1.0) + QD_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * (PQ[d1] * (-1.0) + QD_1 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * (PQ[d1] * (-1.0) + QD_1 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * (PQ[d1] * (-1.0) + QD_1 * (-1.0))
                            + delta[a0][c0] * delta[a1][b1] * delta[d0][d1] * (PB_0)
                            + delta[a0][d0] * delta[a1][b1] * delta[c0][d1] * (PB_0)
                            + delta[a0][d1] * delta[a1][b1] * delta[c0][d0] * (PB_0)
                            + delta[a0][a1] * delta[b1][c0] * delta[d0][d1] * (PB_0)
                            + delta[a0][a1] * delta[b1][d0] * delta[c0][d1] * (PB_0)
                            + delta[a0][a1] * delta[b1][d1] * delta[c0][d0] * (PB_0)
                            + delta[a1][c0] * delta[a0][b1] * delta[d0][d1] * (PB_0)
                            + delta[a1][d0] * delta[a0][b1] * delta[c0][d1] * (PB_0)
                            + delta[a1][d1] * delta[a0][b1] * delta[c0][d0] * (PB_0)
                            + delta[a0][c0] * delta[a1][b0] * delta[d0][d1] * (PB_1)
                            + delta[a0][d0] * delta[a1][b0] * delta[c0][d1] * (PB_1)
                            + delta[a0][d1] * delta[a1][b0] * delta[c0][d0] * (PB_1)
                            + delta[a0][a1] * delta[b0][c0] * delta[d0][d1] * (PB_1)
                            + delta[a0][a1] * delta[b0][d0] * delta[c0][d1] * (PB_1)
                            + delta[a0][a1] * delta[b0][d1] * delta[c0][d0] * (PB_1)
                            + delta[a1][c0] * delta[a0][b0] * delta[d0][d1] * (PB_1)
                            + delta[a1][d0] * delta[a0][b0] * delta[c0][d1] * (PB_1)
                            + delta[a1][d1] * delta[a0][b0] * delta[c0][d0] * (PB_1)
                        )

                    )

                    +

                    F7_t[1] * (

                        0.25 * S2 / ( S1 * S1 * S4 ) * (
                            delta[a0][a1] * delta[b0][b1] * (QD_0 * QD_1 * QC_0 * (-2.0))
                            + delta[a0][b0] * delta[a1][b1] * (QD_0 * QD_1 * QC_0 * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * (QD_0 * QD_1 * QC_0 * (-2.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDPD1(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[2];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 1, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[1] * (

                        0.25 / ( S1 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PA_0 * PA_1 * QC_0 * (-1.0) + PA_0 * PQ[a1] * QC_0 + PA_1 * PQ[a0] * QC_0)
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * PA_1 * QD_0 * (-1.0) + PA_0 * PQ[a1] * QD_0 + PA_1 * PQ[a0] * QD_0)
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * PA_1 * QD_1 * (-1.0) + PA_0 * PQ[a1] * QD_1 + PA_1 * PQ[a0] * QD_1)
                            + delta[a1][b1] * delta[d0][d1] * (PB_0 * PA_0 * QC_0 * (-1.0) + PB_0 * PQ[a0] * QC_0 + PA_0 * PQ[b0] * QC_0)
                            + delta[a1][b1] * delta[c0][d1] * (PB_0 * PA_0 * QD_0 * (-1.0) + PB_0 * PQ[a0] * QD_0 + PA_0 * PQ[b0] * QD_0)
                            + delta[a1][b1] * delta[c0][d0] * (PB_0 * PA_0 * QD_1 * (-1.0) + PB_0 * PQ[a0] * QD_1 + PA_0 * PQ[b0] * QD_1)
                            + delta[a1][b0] * delta[d0][d1] * (PB_1 * PA_0 * QC_0 * (-1.0) + PB_1 * PQ[a0] * QC_0 + PA_0 * PQ[b1] * QC_0)
                            + delta[a1][b0] * delta[c0][d1] * (PB_1 * PA_0 * QD_0 * (-1.0) + PB_1 * PQ[a0] * QD_0 + PA_0 * PQ[b1] * QD_0)
                            + delta[a1][b0] * delta[c0][d0] * (PB_1 * PA_0 * QD_1 * (-1.0) + PB_1 * PQ[a0] * QD_1 + PA_0 * PQ[b1] * QD_1)
                            + delta[a1][d1] * delta[b0][b1] * (PA_0 * QD_0 * QC_0)
                            + delta[a1][b0] * delta[b1][d1] * (PA_0 * QD_0 * QC_0)
                            + delta[b0][d1] * delta[a1][b1] * (PA_0 * QD_0 * QC_0)
                            + delta[a1][d0] * delta[b0][b1] * (PA_0 * QD_1 * QC_0)
                            + delta[a1][b0] * delta[b1][d0] * (PA_0 * QD_1 * QC_0)
                            + delta[b0][d0] * delta[a1][b1] * (PA_0 * QD_1 * QC_0)
                            + delta[a1][c0] * delta[b0][b1] * (PA_0 * QD_0 * QD_1)
                            + delta[a1][b0] * delta[b1][c0] * (PA_0 * QD_0 * QD_1)
                            + delta[b0][c0] * delta[a1][b1] * (PA_0 * QD_0 * QD_1)
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PA_1 * QC_0 * (-1.0) + PB_0 * PQ[a1] * QC_0 + PA_1 * PQ[b0] * QC_0)
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * PA_1 * QD_0 * (-1.0) + PB_0 * PQ[a1] * QD_0 + PA_1 * PQ[b0] * QD_0)
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PA_1 * QD_1 * (-1.0) + PB_0 * PQ[a1] * QD_1 + PA_1 * PQ[b0] * QD_1)
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PA_1 * QC_0 * (-1.0) + PB_1 * PQ[a1] * QC_0 + PA_1 * PQ[b1] * QC_0)
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * PA_1 * QD_0 * (-1.0) + PB_1 * PQ[a1] * QD_0 + PA_1 * PQ[b1] * QD_0)
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PA_1 * QD_1 * (-1.0) + PB_1 * PQ[a1] * QD_1 + PA_1 * PQ[b1] * QD_1)
                            + delta[a0][d1] * delta[b0][b1] * (PA_1 * QD_0 * QC_0)
                            + delta[a0][b0] * delta[b1][d1] * (PA_1 * QD_0 * QC_0)
                            + delta[b0][d1] * delta[a0][b1] * (PA_1 * QD_0 * QC_0)
                            + delta[a0][d0] * delta[b0][b1] * (PA_1 * QD_1 * QC_0)
                            + delta[a0][b0] * delta[b1][d0] * (PA_1 * QD_1 * QC_0)
                            + delta[b0][d0] * delta[a0][b1] * (PA_1 * QD_1 * QC_0)
                            + delta[a0][c0] * delta[b0][b1] * (PA_1 * QD_0 * QD_1)
                            + delta[a0][b0] * delta[b1][c0] * (PA_1 * QD_0 * QD_1)
                            + delta[b0][c0] * delta[a0][b1] * (PA_1 * QD_0 * QD_1)
                            + delta[a0][a1] * delta[d0][d1] * (PB_0 * PB_1 * QC_0 * (-1.0) + PB_0 * PQ[b1] * QC_0 + PB_1 * PQ[b0] * QC_0)
                            + delta[a0][a1] * delta[c0][d1] * (PB_0 * PB_1 * QD_0 * (-1.0) + PB_0 * PQ[b1] * QD_0 + PB_1 * PQ[b0] * QD_0)
                            + delta[a0][a1] * delta[c0][d0] * (PB_0 * PB_1 * QD_1 * (-1.0) + PB_0 * PQ[b1] * QD_1 + PB_1 * PQ[b0] * QD_1)
                            + delta[a0][d1] * delta[a1][b1] * (PB_0 * QD_0 * QC_0)
                            + delta[a0][a1] * delta[b1][d1] * (PB_0 * QD_0 * QC_0)
                            + delta[a1][d1] * delta[a0][b1] * (PB_0 * QD_0 * QC_0)
                            + delta[a0][d0] * delta[a1][b1] * (PB_0 * QD_1 * QC_0)
                            + delta[a0][a1] * delta[b1][d0] * (PB_0 * QD_1 * QC_0)
                            + delta[a1][d0] * delta[a0][b1] * (PB_0 * QD_1 * QC_0)
                            + delta[a0][d1] * delta[a1][b0] * (PB_1 * QD_0 * QC_0)
                            + delta[a0][a1] * delta[b0][d1] * (PB_1 * QD_0 * QC_0)
                            + delta[a1][d1] * delta[a0][b0] * (PB_1 * QD_0 * QC_0)
                            + delta[a0][d0] * delta[a1][b0] * (PB_1 * QD_1 * QC_0)
                            + delta[a0][a1] * delta[b0][d0] * (PB_1 * QD_1 * QC_0)
                            + delta[a1][d0] * delta[a0][b0] * (PB_1 * QD_1 * QC_0)
                            + delta[a0][a1] * delta[b0][b1] * (PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * (PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * (PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][b1] * (PB_0 * QD_0 * QD_1)
                            + delta[a0][a1] * delta[b1][c0] * (PB_0 * QD_0 * QD_1)
                            + delta[a1][c0] * delta[a0][b1] * (PB_0 * QD_0 * QD_1)
                            + delta[a0][c0] * delta[a1][b0] * (PB_1 * QD_0 * QD_1)
                            + delta[a0][a1] * delta[b0][c0] * (PB_1 * QD_0 * QD_1)
                            + delta[a1][c0] * delta[a0][b0] * (PB_1 * QD_0 * QD_1)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDPD2(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[2];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 1, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[1] * (

                        0.25 / ( S2 * S4 ) * (
                            delta[b1][c0] * delta[d0][d1] * (PB_0 * PA_0 * PA_1)
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * PA_0 * PA_1)
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * PA_0 * PA_1)
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * PA_0 * PA_1)
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * PA_0 * PA_1)
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * PA_0 * PA_1)
                            + delta[b0][b1] * delta[d0][d1] * (PA_0 * PA_1 * PQ[c0] * (-1.0) + PA_0 * PA_1 * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * PA_1 * PQ[d0] * (-1.0) + PA_0 * PA_1 * QD_0 * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * PA_1 * PQ[d1] * (-1.0) + PA_0 * PA_1 * QD_1 * (-1.0))
                            + delta[a1][c0] * delta[d0][d1] * (PB_0 * PB_1 * PA_0)
                            + delta[a1][d0] * delta[c0][d1] * (PB_0 * PB_1 * PA_0)
                            + delta[a1][d1] * delta[c0][d0] * (PB_0 * PB_1 * PA_0)
                            + delta[a1][b1] * delta[d0][d1] * (PB_0 * PA_0 * PQ[c0] * (-1.0) + PB_0 * PA_0 * QC_0 * (-1.0))
                            + delta[a1][b1] * delta[c0][d1] * (PB_0 * PA_0 * PQ[d0] * (-1.0) + PB_0 * PA_0 * QD_0 * (-1.0))
                            + delta[a1][b1] * delta[c0][d0] * (PB_0 * PA_0 * PQ[d1] * (-1.0) + PB_0 * PA_0 * QD_1 * (-1.0))
                            + delta[a1][b0] * delta[d0][d1] * (PB_1 * PA_0 * PQ[c0] * (-1.0) + PB_1 * PA_0 * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[c0][d1] * (PB_1 * PA_0 * PQ[d0] * (-1.0) + PB_1 * PA_0 * QD_0 * (-1.0))
                            + delta[a1][b0] * delta[c0][d0] * (PB_1 * PA_0 * PQ[d1] * (-1.0) + PB_1 * PA_0 * QD_1 * (-1.0))
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * PB_1 * PA_1)
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * PB_1 * PA_1)
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * PB_1 * PA_1)
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PA_1 * PQ[c0] * (-1.0) + PB_0 * PA_1 * QC_0 * (-1.0))
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * PA_1 * PQ[d0] * (-1.0) + PB_0 * PA_1 * QD_0 * (-1.0))
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PA_1 * PQ[d1] * (-1.0) + PB_0 * PA_1 * QD_1 * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PA_1 * PQ[c0] * (-1.0) + PB_1 * PA_1 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * PA_1 * PQ[d0] * (-1.0) + PB_1 * PA_1 * QD_0 * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PA_1 * PQ[d1] * (-1.0) + PB_1 * PA_1 * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[d0][d1] * (PB_0 * PB_1 * PQ[c0] * (-1.0) + PB_0 * PB_1 * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[c0][d1] * (PB_0 * PB_1 * PQ[d0] * (-1.0) + PB_0 * PB_1 * QD_0 * (-1.0))
                            + delta[a0][a1] * delta[c0][d0] * (PB_0 * PB_1 * PQ[d1] * (-1.0) + PB_0 * PB_1 * QD_1 * (-1.0))
                        )

                    )

                    +

                    F7_t[1] * (

                        0.5 * S1 / ( S2 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0] * (-1.0) + PB_0 * PB_1 * PA_0 * PA_1 * QC_0 * (-1.0))
                            + delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PA_1 * PQ[d0] * (-1.0) + PB_0 * PB_1 * PA_0 * PA_1 * QD_0 * (-1.0))
                            + delta[c0][d0] * (PB_0 * PB_1 * PA_0 * PA_1 * PQ[d1] * (-1.0) + PB_0 * PB_1 * PA_0 * PA_1 * QD_1 * (-1.0))
                        )

                    )

                    +

                    F7_t[1] * (

                        0.5 * S2 / ( S1 * S4 ) * (
                            delta[b0][b1] * (PA_0 * PA_1 * QD_0 * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[a1] * QD_0 * QD_1 * QC_0 + PA_1 * PQ[a0] * QD_0 * QD_1 * QC_0)
                            + delta[a1][b1] * (PB_0 * PA_0 * QD_0 * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[a0] * QD_0 * QD_1 * QC_0 + PA_0 * PQ[b0] * QD_0 * QD_1 * QC_0)
                            + delta[a1][b0] * (PB_1 * PA_0 * QD_0 * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[a0] * QD_0 * QD_1 * QC_0 + PA_0 * PQ[b1] * QD_0 * QD_1 * QC_0)
                            + delta[a0][b1] * (PB_0 * PA_1 * QD_0 * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[a1] * QD_0 * QD_1 * QC_0 + PA_1 * PQ[b0] * QD_0 * QD_1 * QC_0)
                            + delta[a0][b0] * (PB_1 * PA_1 * QD_0 * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[a1] * QD_0 * QD_1 * QC_0 + PA_1 * PQ[b1] * QD_0 * QD_1 * QC_0)
                            + delta[a0][a1] * (PB_0 * PB_1 * QD_0 * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[b1] * QD_0 * QD_1 * QC_0 + PB_1 * PQ[b0] * QD_0 * QD_1 * QC_0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDPD3(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[3];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[1] * (

                        0.5 / S4 * (
                            delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] * QC_0 + PB_0 * PB_1 * PA_1 * PQ[a0] * QC_0 + PB_0 * PA_0 * PA_1 * PQ[b1] * QC_0 + PB_1 * PA_0 * PA_1 * PQ[b0] * QC_0)
                            + delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] * QD_0 + PB_0 * PB_1 * PA_1 * PQ[a0] * QD_0 + PB_0 * PA_0 * PA_1 * PQ[b1] * QD_0 + PB_1 * PA_0 * PA_1 * PQ[b0] * QD_0)
                            + delta[c0][d0] * (PB_0 * PB_1 * PA_0 * PQ[a1] * QD_1 + PB_0 * PB_1 * PA_1 * PQ[a0] * QD_1 + PB_0 * PA_0 * PA_1 * PQ[b1] * QD_1 + PB_1 * PA_0 * PA_1 * PQ[b0] * QD_1)
                            + delta[b1][d1] * (PB_0 * PA_0 * PA_1 * QD_0 * QC_0)
                            + delta[b1][d0] * (PB_0 * PA_0 * PA_1 * QD_1 * QC_0)
                            + delta[b1][c0] * (PB_0 * PA_0 * PA_1 * QD_0 * QD_1)
                            + delta[b0][d1] * (PB_1 * PA_0 * PA_1 * QD_0 * QC_0)
                            + delta[b0][d0] * (PB_1 * PA_0 * PA_1 * QD_1 * QC_0)
                            + delta[b0][c0] * (PB_1 * PA_0 * PA_1 * QD_0 * QD_1)
                            + delta[b0][b1] * (PA_0 * PA_1 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a1][d1] * (PB_0 * PB_1 * PA_0 * QD_0 * QC_0)
                            + delta[a1][d0] * (PB_0 * PB_1 * PA_0 * QD_1 * QC_0)
                            + delta[a1][c0] * (PB_0 * PB_1 * PA_0 * QD_0 * QD_1)
                            + delta[a1][b1] * (PB_0 * PA_0 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a1][b0] * (PB_1 * PA_0 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][d1] * (PB_0 * PB_1 * PA_1 * QD_0 * QC_0)
                            + delta[a0][d0] * (PB_0 * PB_1 * PA_1 * QD_1 * QC_0)
                            + delta[a0][c0] * (PB_0 * PB_1 * PA_1 * QD_0 * QD_1)
                            + delta[a0][b1] * (PB_0 * PA_1 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][b0] * (PB_1 * PA_1 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][a1] * (PB_0 * PB_1 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PB_1 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                        )

                    )

                    +

                    F7_t[1] * (

                        S1 / S4 * (
                            
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[d1] * QD_0 * QC_0 * (-1.0)
                        )

                    )

                    +

                    F7_t[1] * (

                        S2 / S4 * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * QD_0 * QD_1 * QC_0
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * QD_0 * QD_1 * QC_0
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * QD_0 * QD_1 * QC_0
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * QD_0 * QD_1 * QC_0
                        )

                    )

                    +

                    F7_t[2] * (

                        ( S1 * S1 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[d0] * QD_1
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[d1] * QD_0
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[d0] * PQ[d1] * QC_0
                        )

                    )

                    +

                    F7_t[2] * (

                        ( S1 * S2 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                        )

                    )

                    +

                    F7_t[2] * (

                        ( S2 * S2 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * QD_0 * QD_1 * QC_0
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * QD_0 * QD_1 * QC_0
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * QD_0 * QD_1 * QC_0
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * QD_0 * QD_1 * QC_0
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * QD_0 * QD_1 * QC_0
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_0
                        )

                    )

                    +

                    F7_t[2] * (

                        0.125 * S2 / ( S1 * S1 * S4 * S4 ) * (
                            delta[a0][a1] * delta[b0][b1] * delta[d0][d1] * (QC_0)
                            + delta[a0][b0] * delta[a1][b1] * delta[d0][d1] * (QC_0)
                            + delta[a1][b0] * delta[a0][b1] * delta[d0][d1] * (QC_0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d1] * (QD_0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d1] * (QD_0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d1] * (QD_0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * (QD_1)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * (QD_1)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * (QD_1)
                        )

                    )

                    +

                    F7_t[2] * (

                        0.125 / ( S1 * S4 * S4 ) * (
                            delta[a1][c0] * delta[b0][b1] * delta[d0][d1] * (PA_0 * (-1.0) + PQ[a0])
                            + delta[a1][d0] * delta[b0][b1] * delta[c0][d1] * (PA_0 * (-1.0) + PQ[a0])
                            + delta[a1][d1] * delta[b0][b1] * delta[c0][d0] * (PA_0 * (-1.0) + PQ[a0])
                            + delta[a1][b0] * delta[b1][c0] * delta[d0][d1] * (PA_0 * (-1.0) + PQ[a0])
                            + delta[a1][b0] * delta[b1][d0] * delta[c0][d1] * (PA_0 * (-1.0) + PQ[a0])
                            + delta[a1][b0] * delta[b1][d1] * delta[c0][d0] * (PA_0 * (-1.0) + PQ[a0])
                            + delta[b0][c0] * delta[a1][b1] * delta[d0][d1] * (PA_0 * (-1.0) + PQ[a0])
                            + delta[b0][d0] * delta[a1][b1] * delta[c0][d1] * (PA_0 * (-1.0) + PQ[a0])
                            + delta[b0][d1] * delta[a1][b1] * delta[c0][d0] * (PA_0 * (-1.0) + PQ[a0])
                            + delta[a0][c0] * delta[b0][b1] * delta[d0][d1] * (PA_1 * (-1.0) + PQ[a1])
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][d1] * (PA_1 * (-1.0) + PQ[a1])
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][d0] * (PA_1 * (-1.0) + PQ[a1])
                            + delta[a0][b0] * delta[b1][c0] * delta[d0][d1] * (PA_1 * (-1.0) + PQ[a1])
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][d1] * (PA_1 * (-1.0) + PQ[a1])
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][d0] * (PA_1 * (-1.0) + PQ[a1])
                            + delta[b0][c0] * delta[a0][b1] * delta[d0][d1] * (PA_1 * (-1.0) + PQ[a1])
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][d1] * (PA_1 * (-1.0) + PQ[a1])
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][d0] * (PA_1 * (-1.0) + PQ[a1])
                            + delta[a0][c0] * delta[a1][b1] * delta[d0][d1] * (PB_0 * (-1.0) + PQ[b0])
                            + delta[a0][d0] * delta[a1][b1] * delta[c0][d1] * (PB_0 * (-1.0) + PQ[b0])
                            + delta[a0][d1] * delta[a1][b1] * delta[c0][d0] * (PB_0 * (-1.0) + PQ[b0])
                            + delta[a0][a1] * delta[b1][c0] * delta[d0][d1] * (PB_0 * (-1.0) + PQ[b0])
                            + delta[a0][a1] * delta[b1][d0] * delta[c0][d1] * (PB_0 * (-1.0) + PQ[b0])
                            + delta[a0][a1] * delta[b1][d1] * delta[c0][d0] * (PB_0 * (-1.0) + PQ[b0])
                            + delta[a1][c0] * delta[a0][b1] * delta[d0][d1] * (PB_0 * (-1.0) + PQ[b0])
                            + delta[a1][d0] * delta[a0][b1] * delta[c0][d1] * (PB_0 * (-1.0) + PQ[b0])
                            + delta[a1][d1] * delta[a0][b1] * delta[c0][d0] * (PB_0 * (-1.0) + PQ[b0])
                            + delta[a0][c0] * delta[a1][b0] * delta[d0][d1] * (PB_1 * (-1.0) + PQ[b1])
                            + delta[a0][d0] * delta[a1][b0] * delta[c0][d1] * (PB_1 * (-1.0) + PQ[b1])
                            + delta[a0][d1] * delta[a1][b0] * delta[c0][d0] * (PB_1 * (-1.0) + PQ[b1])
                            + delta[a0][a1] * delta[b0][c0] * delta[d0][d1] * (PB_1 * (-1.0) + PQ[b1])
                            + delta[a0][a1] * delta[b0][d0] * delta[c0][d1] * (PB_1 * (-1.0) + PQ[b1])
                            + delta[a0][a1] * delta[b0][d1] * delta[c0][d0] * (PB_1 * (-1.0) + PQ[b1])
                            + delta[a1][c0] * delta[a0][b0] * delta[d0][d1] * (PB_1 * (-1.0) + PQ[b1])
                            + delta[a1][d0] * delta[a0][b0] * delta[c0][d1] * (PB_1 * (-1.0) + PQ[b1])
                            + delta[a1][d1] * delta[a0][b0] * delta[c0][d0] * (PB_1 * (-1.0) + PQ[b1])
                            + delta[a0][d0] * delta[a1][d1] * delta[b0][b1] * (QC_0)
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][d1] * (QC_0)
                            + delta[a0][d0] * delta[b0][d1] * delta[a1][b1] * (QC_0)
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][b1] * (QC_0)
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][d0] * (QC_0)
                            + delta[a0][d1] * delta[b0][d0] * delta[a1][b1] * (QC_0)
                            + delta[a0][a1] * delta[b0][b1] * delta[d0][d1] * (PQ[c0] * 2.0 + QC_0 * 2.0)
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][d1] * (QC_0)
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][d0] * (QC_0)
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][d1] * (QC_0)
                            + delta[a1][d0] * delta[b0][d1] * delta[a0][b1] * (QC_0)
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][d0] * (QC_0)
                            + delta[a1][d1] * delta[b0][d0] * delta[a0][b1] * (QC_0)
                            + delta[a0][b0] * delta[a1][b1] * delta[d0][d1] * (PQ[c0] * 2.0 + QC_0 * 2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[d0][d1] * (PQ[c0] * 2.0 + QC_0 * 2.0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d1] * (PQ[d0] * 2.0 + QD_0 * 2.0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d1] * (PQ[d0] * 2.0 + QD_0 * 2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d1] * (PQ[d0] * 2.0 + QD_0 * 2.0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * (PQ[d1] * 2.0 + QD_1 * 2.0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * (PQ[d1] * 2.0 + QD_1 * 2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * (PQ[d1] * 2.0 + QD_1 * 2.0)
                            + delta[a0][c0] * delta[a1][d1] * delta[b0][b1] * (QD_0)
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d1] * (QD_0)
                            + delta[a0][c0] * delta[b0][d1] * delta[a1][b1] * (QD_0)
                            + delta[a0][d1] * delta[a1][c0] * delta[b0][b1] * (QD_0)
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][c0] * (QD_0)
                            + delta[a0][d1] * delta[b0][c0] * delta[a1][b1] * (QD_0)
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d1] * (QD_0)
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][c0] * (QD_0)
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d1] * (QD_0)
                            + delta[a1][c0] * delta[b0][d1] * delta[a0][b1] * (QD_0)
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][c0] * (QD_0)
                            + delta[a1][d1] * delta[b0][c0] * delta[a0][b1] * (QD_0)
                            + delta[a0][c0] * delta[a1][d0] * delta[b0][b1] * (QD_1)
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d0] * (QD_1)
                            + delta[a0][c0] * delta[b0][d0] * delta[a1][b1] * (QD_1)
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][b1] * (QD_1)
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][c0] * (QD_1)
                            + delta[a0][d0] * delta[b0][c0] * delta[a1][b1] * (QD_1)
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d0] * (QD_1)
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][c0] * (QD_1)
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d0] * (QD_1)
                            + delta[a1][c0] * delta[b0][d0] * delta[a0][b1] * (QD_1)
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][c0] * (QD_1)
                            + delta[a1][d0] * delta[b0][c0] * delta[a0][b1] * (QD_1)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDPD4(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[3];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[2] * (

                        0.125 / ( S2 * S4 * S4 ) * (
                            delta[a1][c0] * delta[b0][b1] * delta[d0][d1] * (PA_0 * (-1.0))
                            + delta[a1][d0] * delta[b0][b1] * delta[c0][d1] * (PA_0 * (-1.0))
                            + delta[a1][d1] * delta[b0][b1] * delta[c0][d0] * (PA_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][c0] * delta[d0][d1] * (PA_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][d0] * delta[c0][d1] * (PA_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][d1] * delta[c0][d0] * (PA_0 * (-1.0))
                            + delta[b0][c0] * delta[a1][b1] * delta[d0][d1] * (PA_0 * (-1.0))
                            + delta[b0][d0] * delta[a1][b1] * delta[c0][d1] * (PA_0 * (-1.0))
                            + delta[b0][d1] * delta[a1][b1] * delta[c0][d0] * (PA_0 * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * delta[d0][d1] * (PA_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][d1] * (PA_1 * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][d0] * (PA_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * delta[d0][d1] * (PA_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][d1] * (PA_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][d0] * (PA_1 * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * delta[d0][d1] * (PA_1 * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][d1] * (PA_1 * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][d0] * (PA_1 * (-1.0))
                            + delta[a0][c0] * delta[a1][b1] * delta[d0][d1] * (PB_0 * (-1.0))
                            + delta[a0][d0] * delta[a1][b1] * delta[c0][d1] * (PB_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][b1] * delta[c0][d0] * (PB_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][c0] * delta[d0][d1] * (PB_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][d0] * delta[c0][d1] * (PB_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][d1] * delta[c0][d0] * (PB_0 * (-1.0))
                            + delta[a1][c0] * delta[a0][b1] * delta[d0][d1] * (PB_0 * (-1.0))
                            + delta[a1][d0] * delta[a0][b1] * delta[c0][d1] * (PB_0 * (-1.0))
                            + delta[a1][d1] * delta[a0][b1] * delta[c0][d0] * (PB_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * delta[d0][d1] * (PB_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * delta[c0][d1] * (PB_1 * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * delta[c0][d0] * (PB_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * delta[d0][d1] * (PB_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * delta[c0][d1] * (PB_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * delta[c0][d0] * (PB_1 * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * delta[d0][d1] * (PB_1 * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * delta[c0][d1] * (PB_1 * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * delta[c0][d0] * (PB_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[d0][d1] * (PQ[c0])
                            + delta[a0][b0] * delta[a1][b1] * delta[d0][d1] * (PQ[c0])
                            + delta[a1][b0] * delta[a0][b1] * delta[d0][d1] * (PQ[c0])
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d1] * (PQ[d0])
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d1] * (PQ[d0])
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d1] * (PQ[d0])
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * (PQ[d1])
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * (PQ[d1])
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * (PQ[d1])
                        )

                    )

                    +

                    F7_t[2] * (

                        0.25 * ( S2 * S2 ) / ( S1 * S1 * S4 * S4 ) * (
                            delta[a0][a1] * delta[b0][b1] * (QD_0 * QD_1 * QC_0)
                            + delta[a0][b0] * delta[a1][b1] * (QD_0 * QD_1 * QC_0)
                            + delta[a1][b0] * delta[a0][b1] * (QD_0 * QD_1 * QC_0)
                        )

                    )

                    +

                    F7_t[2] * (

                        0.25 * S1 / ( S2 * S4 * S4 ) * (
                            delta[b1][c0] * delta[d0][d1] * (PB_0 * PA_0 * PA_1 * (-1.0))
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * PA_0 * PA_1 * (-1.0))
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * PA_0 * PA_1 * (-1.0))
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * PA_0 * PA_1 * (-1.0))
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * PA_0 * PA_1 * (-1.0))
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * PA_0 * PA_1 * (-1.0))
                            + delta[b0][b1] * delta[d0][d1] * (PA_0 * PA_1 * PQ[c0])
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * PA_1 * PQ[d0])
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * PA_1 * PQ[d1])
                            + delta[a1][c0] * delta[d0][d1] * (PB_0 * PB_1 * PA_0 * (-1.0))
                            + delta[a1][d0] * delta[c0][d1] * (PB_0 * PB_1 * PA_0 * (-1.0))
                            + delta[a1][d1] * delta[c0][d0] * (PB_0 * PB_1 * PA_0 * (-1.0))
                            + delta[a1][b1] * delta[d0][d1] * (PB_0 * PA_0 * PQ[c0])
                            + delta[a1][b1] * delta[c0][d1] * (PB_0 * PA_0 * PQ[d0])
                            + delta[a1][b1] * delta[c0][d0] * (PB_0 * PA_0 * PQ[d1])
                            + delta[a1][b0] * delta[d0][d1] * (PB_1 * PA_0 * PQ[c0])
                            + delta[a1][b0] * delta[c0][d1] * (PB_1 * PA_0 * PQ[d0])
                            + delta[a1][b0] * delta[c0][d0] * (PB_1 * PA_0 * PQ[d1])
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * PB_1 * PA_1 * (-1.0))
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * PB_1 * PA_1 * (-1.0))
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * PB_1 * PA_1 * (-1.0))
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PA_1 * PQ[c0])
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * PA_1 * PQ[d0])
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PA_1 * PQ[d1])
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PA_1 * PQ[c0])
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * PA_1 * PQ[d0])
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PA_1 * PQ[d1])
                            + delta[a0][a1] * delta[d0][d1] * (PB_0 * PB_1 * PQ[c0])
                            + delta[a0][a1] * delta[c0][d1] * (PB_0 * PB_1 * PQ[d0])
                            + delta[a0][a1] * delta[c0][d0] * (PB_0 * PB_1 * PQ[d1])
                        )

                    )

                    +

                    F7_t[2] * (

                        0.25 * S2 / ( S1 * S4 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PA_0 * PQ[a1] * QC_0 * (-1.0) + PA_1 * PQ[a0] * QC_0 * (-1.0) + PQ[a0] * PQ[a1] * QC_0)
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * PQ[a1] * QD_0 * (-1.0) + PA_1 * PQ[a0] * QD_0 * (-1.0) + PQ[a0] * PQ[a1] * QD_0)
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * PQ[a1] * QD_1 * (-1.0) + PA_1 * PQ[a0] * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * QD_1)
                            + delta[a1][b1] * delta[d0][d1] * (PB_0 * PQ[a0] * QC_0 * (-1.0) + PA_0 * PQ[b0] * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * QC_0)
                            + delta[a1][b1] * delta[c0][d1] * (PB_0 * PQ[a0] * QD_0 * (-1.0) + PA_0 * PQ[b0] * QD_0 * (-1.0) + PQ[a0] * PQ[b0] * QD_0)
                            + delta[a1][b1] * delta[c0][d0] * (PB_0 * PQ[a0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * QD_1)
                            + delta[a1][b0] * delta[d0][d1] * (PB_1 * PQ[a0] * QC_0 * (-1.0) + PA_0 * PQ[b1] * QC_0 * (-1.0) + PQ[a0] * PQ[b1] * QC_0)
                            + delta[a1][b0] * delta[c0][d1] * (PB_1 * PQ[a0] * QD_0 * (-1.0) + PA_0 * PQ[b1] * QD_0 * (-1.0) + PQ[a0] * PQ[b1] * QD_0)
                            + delta[a1][b0] * delta[c0][d0] * (PB_1 * PQ[a0] * QD_1 * (-1.0) + PA_0 * PQ[b1] * QD_1 * (-1.0) + PQ[a0] * PQ[b1] * QD_1)
                            + delta[a1][d1] * delta[b0][b1] * (PA_0 * QD_0 * QC_0 * (-1.0) + PQ[a0] * QD_0 * QC_0)
                            + delta[a1][b0] * delta[b1][d1] * (PA_0 * QD_0 * QC_0 * (-1.0) + PQ[a0] * QD_0 * QC_0)
                            + delta[b0][d1] * delta[a1][b1] * (PA_0 * QD_0 * QC_0 * (-1.0) + PQ[a0] * QD_0 * QC_0)
                            + delta[a1][d0] * delta[b0][b1] * (PA_0 * QD_1 * QC_0 * (-1.0) + PQ[a0] * QD_1 * QC_0)
                            + delta[a1][b0] * delta[b1][d0] * (PA_0 * QD_1 * QC_0 * (-1.0) + PQ[a0] * QD_1 * QC_0)
                            + delta[b0][d0] * delta[a1][b1] * (PA_0 * QD_1 * QC_0 * (-1.0) + PQ[a0] * QD_1 * QC_0)
                            + delta[a1][c0] * delta[b0][b1] * (PA_0 * QD_0 * QD_1 * (-1.0) + PQ[a0] * QD_0 * QD_1)
                            + delta[a1][b0] * delta[b1][c0] * (PA_0 * QD_0 * QD_1 * (-1.0) + PQ[a0] * QD_0 * QD_1)
                            + delta[b0][c0] * delta[a1][b1] * (PA_0 * QD_0 * QD_1 * (-1.0) + PQ[a0] * QD_0 * QD_1)
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PQ[a1] * QC_0 * (-1.0) + PA_1 * PQ[b0] * QC_0 * (-1.0) + PQ[a1] * PQ[b0] * QC_0)
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * PQ[a1] * QD_0 * (-1.0) + PA_1 * PQ[b0] * QD_0 * (-1.0) + PQ[a1] * PQ[b0] * QD_0)
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PQ[a1] * QD_1 * (-1.0) + PA_1 * PQ[b0] * QD_1 * (-1.0) + PQ[a1] * PQ[b0] * QD_1)
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PQ[a1] * QC_0 * (-1.0) + PA_1 * PQ[b1] * QC_0 * (-1.0) + PQ[a1] * PQ[b1] * QC_0)
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * PQ[a1] * QD_0 * (-1.0) + PA_1 * PQ[b1] * QD_0 * (-1.0) + PQ[a1] * PQ[b1] * QD_0)
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PQ[a1] * QD_1 * (-1.0) + PA_1 * PQ[b1] * QD_1 * (-1.0) + PQ[a1] * PQ[b1] * QD_1)
                            + delta[a0][d1] * delta[b0][b1] * (PA_1 * QD_0 * QC_0 * (-1.0) + PQ[a1] * QD_0 * QC_0)
                            + delta[a0][b0] * delta[b1][d1] * (PA_1 * QD_0 * QC_0 * (-1.0) + PQ[a1] * QD_0 * QC_0)
                            + delta[b0][d1] * delta[a0][b1] * (PA_1 * QD_0 * QC_0 * (-1.0) + PQ[a1] * QD_0 * QC_0)
                            + delta[a0][d0] * delta[b0][b1] * (PA_1 * QD_1 * QC_0 * (-1.0) + PQ[a1] * QD_1 * QC_0)
                            + delta[a0][b0] * delta[b1][d0] * (PA_1 * QD_1 * QC_0 * (-1.0) + PQ[a1] * QD_1 * QC_0)
                            + delta[b0][d0] * delta[a0][b1] * (PA_1 * QD_1 * QC_0 * (-1.0) + PQ[a1] * QD_1 * QC_0)
                            + delta[a0][c0] * delta[b0][b1] * (PA_1 * QD_0 * QD_1 * (-1.0) + PQ[a1] * QD_0 * QD_1)
                            + delta[a0][b0] * delta[b1][c0] * (PA_1 * QD_0 * QD_1 * (-1.0) + PQ[a1] * QD_0 * QD_1)
                            + delta[b0][c0] * delta[a0][b1] * (PA_1 * QD_0 * QD_1 * (-1.0) + PQ[a1] * QD_0 * QD_1)
                            + delta[a0][a1] * delta[d0][d1] * (PB_0 * PQ[b1] * QC_0 * (-1.0) + PB_1 * PQ[b0] * QC_0 * (-1.0) + PQ[b0] * PQ[b1] * QC_0)
                            + delta[a0][a1] * delta[c0][d1] * (PB_0 * PQ[b1] * QD_0 * (-1.0) + PB_1 * PQ[b0] * QD_0 * (-1.0) + PQ[b0] * PQ[b1] * QD_0)
                            + delta[a0][a1] * delta[c0][d0] * (PB_0 * PQ[b1] * QD_1 * (-1.0) + PB_1 * PQ[b0] * QD_1 * (-1.0) + PQ[b0] * PQ[b1] * QD_1)
                            + delta[a0][d1] * delta[a1][b1] * (PB_0 * QD_0 * QC_0 * (-1.0) + PQ[b0] * QD_0 * QC_0)
                            + delta[a0][a1] * delta[b1][d1] * (PB_0 * QD_0 * QC_0 * (-1.0) + PQ[b0] * QD_0 * QC_0)
                            + delta[a1][d1] * delta[a0][b1] * (PB_0 * QD_0 * QC_0 * (-1.0) + PQ[b0] * QD_0 * QC_0)
                            + delta[a0][d0] * delta[a1][b1] * (PB_0 * QD_1 * QC_0 * (-1.0) + PQ[b0] * QD_1 * QC_0)
                            + delta[a0][a1] * delta[b1][d0] * (PB_0 * QD_1 * QC_0 * (-1.0) + PQ[b0] * QD_1 * QC_0)
                            + delta[a1][d0] * delta[a0][b1] * (PB_0 * QD_1 * QC_0 * (-1.0) + PQ[b0] * QD_1 * QC_0)
                            + delta[a0][c0] * delta[a1][b1] * (PB_0 * QD_0 * QD_1 * (-1.0) + PQ[b0] * QD_0 * QD_1)
                            + delta[a0][a1] * delta[b1][c0] * (PB_0 * QD_0 * QD_1 * (-1.0) + PQ[b0] * QD_0 * QD_1)
                            + delta[a1][c0] * delta[a0][b1] * (PB_0 * QD_0 * QD_1 * (-1.0) + PQ[b0] * QD_0 * QD_1)
                            + delta[a0][d1] * delta[a1][b0] * (PB_1 * QD_0 * QC_0 * (-1.0) + PQ[b1] * QD_0 * QC_0)
                            + delta[a0][a1] * delta[b0][d1] * (PB_1 * QD_0 * QC_0 * (-1.0) + PQ[b1] * QD_0 * QC_0)
                            + delta[a1][d1] * delta[a0][b0] * (PB_1 * QD_0 * QC_0 * (-1.0) + PQ[b1] * QD_0 * QC_0)
                            + delta[a0][d0] * delta[a1][b0] * (PB_1 * QD_1 * QC_0 * (-1.0) + PQ[b1] * QD_1 * QC_0)
                            + delta[a0][a1] * delta[b0][d0] * (PB_1 * QD_1 * QC_0 * (-1.0) + PQ[b1] * QD_1 * QC_0)
                            + delta[a1][d0] * delta[a0][b0] * (PB_1 * QD_1 * QC_0 * (-1.0) + PQ[b1] * QD_1 * QC_0)
                            + delta[a0][c0] * delta[a1][b0] * (PB_1 * QD_0 * QD_1 * (-1.0) + PQ[b1] * QD_0 * QD_1)
                            + delta[a0][a1] * delta[b0][c0] * (PB_1 * QD_0 * QD_1 * (-1.0) + PQ[b1] * QD_0 * QD_1)
                            + delta[a1][c0] * delta[a0][b0] * (PB_1 * QD_0 * QD_1 * (-1.0) + PQ[b1] * QD_0 * QD_1)
                            + delta[a0][a1] * delta[b0][b1] * (PQ[c0] * QD_0 * QD_1 * 2.0 + PQ[d0] * QD_1 * QC_0 * 2.0 + PQ[d1] * QD_0 * QC_0 * 2.0)
                            + delta[a0][b0] * delta[a1][b1] * (PQ[c0] * QD_0 * QD_1 * 2.0 + PQ[d0] * QD_1 * QC_0 * 2.0 + PQ[d1] * QD_0 * QC_0 * 2.0)
                            + delta[a1][b0] * delta[a0][b1] * (PQ[c0] * QD_0 * QD_1 * 2.0 + PQ[d0] * QD_1 * QC_0 * 2.0 + PQ[d1] * QD_0 * QC_0 * 2.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDPD5(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[3];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[2] * (

                        0.25 / ( S4 * S4 ) * (
                            delta[b1][c0] * delta[d0][d1] * (PB_0 * PA_0 * PQ[a1] + PB_0 * PA_1 * PQ[a0] + PA_0 * PA_1 * PQ[b0])
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * PA_0 * PQ[a1] + PB_0 * PA_1 * PQ[a0] + PA_0 * PA_1 * PQ[b0])
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * PA_0 * PQ[a1] + PB_0 * PA_1 * PQ[a0] + PA_0 * PA_1 * PQ[b0])
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * PA_0 * PQ[a1] + PB_1 * PA_1 * PQ[a0] + PA_0 * PA_1 * PQ[b1])
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * PA_0 * PQ[a1] + PB_1 * PA_1 * PQ[a0] + PA_0 * PA_1 * PQ[b1])
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * PA_0 * PQ[a1] + PB_1 * PA_1 * PQ[a0] + PA_0 * PA_1 * PQ[b1])
                            + delta[b0][b1] * delta[d0][d1] * (PA_0 * PQ[a1] * PQ[c0] * (-1.0) + PA_0 * PQ[a1] * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * (-1.0) + PA_1 * PQ[a0] * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[c0] + PA_0 * PA_1 * QC_0)
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * PQ[a1] * PQ[d0] * (-1.0) + PA_0 * PQ[a1] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[d0] * (-1.0) + PA_1 * PQ[a0] * QD_0 * (-1.0) + PA_0 * PA_1 * PQ[d0] + PA_0 * PA_1 * QD_0)
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * PQ[a1] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[d1] + PA_0 * PA_1 * QD_1)
                            + delta[b0][d0] * delta[b1][d1] * (PA_0 * PA_1 * QC_0)
                            + delta[b0][d1] * delta[b1][d0] * (PA_0 * PA_1 * QC_0)
                            + delta[b0][c0] * delta[b1][d1] * (PA_0 * PA_1 * QD_0)
                            + delta[b0][d1] * delta[b1][c0] * (PA_0 * PA_1 * QD_0)
                            + delta[b0][c0] * delta[b1][d0] * (PA_0 * PA_1 * QD_1)
                            + delta[b0][d0] * delta[b1][c0] * (PA_0 * PA_1 * QD_1)
                            + delta[a1][c0] * delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] + PB_0 * PA_0 * PQ[b1] + PB_1 * PA_0 * PQ[b0])
                            + delta[a1][d0] * delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] + PB_0 * PA_0 * PQ[b1] + PB_1 * PA_0 * PQ[b0])
                            + delta[a1][d1] * delta[c0][d0] * (PB_0 * PB_1 * PQ[a0] + PB_0 * PA_0 * PQ[b1] + PB_1 * PA_0 * PQ[b0])
                            + delta[a1][b1] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[c0] * (-1.0) + PB_0 * PQ[a0] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * (-1.0) + PA_0 * PQ[b0] * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[c0] + PB_0 * PA_0 * QC_0)
                            + delta[a1][b1] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[d0] * (-1.0) + PB_0 * PQ[a0] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[d0] + PB_0 * PA_0 * QD_0)
                            + delta[a1][b1] * delta[c0][d0] * (PB_0 * PQ[a0] * PQ[d1] * (-1.0) + PB_0 * PQ[a0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[d1] + PB_0 * PA_0 * QD_1)
                            + delta[a1][d0] * delta[b1][d1] * (PB_0 * PA_0 * QC_0)
                            + delta[a1][d1] * delta[b1][d0] * (PB_0 * PA_0 * QC_0)
                            + delta[a1][c0] * delta[b1][d1] * (PB_0 * PA_0 * QD_0)
                            + delta[a1][d1] * delta[b1][c0] * (PB_0 * PA_0 * QD_0)
                            + delta[a1][c0] * delta[b1][d0] * (PB_0 * PA_0 * QD_1)
                            + delta[a1][d0] * delta[b1][c0] * (PB_0 * PA_0 * QD_1)
                            + delta[a1][b0] * delta[d0][d1] * (PB_1 * PQ[a0] * PQ[c0] * (-1.0) + PB_1 * PQ[a0] * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * (-1.0) + PA_0 * PQ[b1] * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[c0] + PB_1 * PA_0 * QC_0)
                            + delta[a1][b0] * delta[c0][d1] * (PB_1 * PQ[a0] * PQ[d0] * (-1.0) + PB_1 * PQ[a0] * QD_0 * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * (-1.0) + PA_0 * PQ[b1] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[d0] + PB_1 * PA_0 * QD_0)
                            + delta[a1][b0] * delta[c0][d0] * (PB_1 * PQ[a0] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * QD_1 * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * (-1.0) + PA_0 * PQ[b1] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[d1] + PB_1 * PA_0 * QD_1)
                            + delta[a1][d0] * delta[b0][d1] * (PB_1 * PA_0 * QC_0)
                            + delta[a1][d1] * delta[b0][d0] * (PB_1 * PA_0 * QC_0)
                            + delta[a1][c0] * delta[b0][d1] * (PB_1 * PA_0 * QD_0)
                            + delta[a1][d1] * delta[b0][c0] * (PB_1 * PA_0 * QD_0)
                            + delta[a1][c0] * delta[b0][d0] * (PB_1 * PA_0 * QD_1)
                            + delta[a1][d0] * delta[b0][c0] * (PB_1 * PA_0 * QD_1)
                            + delta[a1][d1] * delta[b0][b1] * (PA_0 * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][d1] * (PA_0 * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[a1][b1] * (PA_0 * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[b0][b1] * (PA_0 * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][d0] * (PA_0 * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[a1][b1] * (PA_0 * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][c0] * delta[b0][b1] * (PA_0 * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][c0] * (PA_0 * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][c0] * delta[a1][b1] * (PA_0 * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * PB_1 * PQ[a1] + PB_0 * PA_1 * PQ[b1] + PB_1 * PA_1 * PQ[b0])
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * PB_1 * PQ[a1] + PB_0 * PA_1 * PQ[b1] + PB_1 * PA_1 * PQ[b0])
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * PB_1 * PQ[a1] + PB_0 * PA_1 * PQ[b1] + PB_1 * PA_1 * PQ[b0])
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PQ[a1] * PQ[c0] * (-1.0) + PB_0 * PQ[a1] * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * (-1.0) + PA_1 * PQ[b0] * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[c0] + PB_0 * PA_1 * QC_0)
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * PQ[a1] * PQ[d0] * (-1.0) + PB_0 * PQ[a1] * QD_0 * (-1.0) + PA_1 * PQ[b0] * PQ[d0] * (-1.0) + PA_1 * PQ[b0] * QD_0 * (-1.0) + PB_0 * PA_1 * PQ[d0] + PB_0 * PA_1 * QD_0)
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PQ[a1] * PQ[d1] * (-1.0) + PB_0 * PQ[a1] * QD_1 * (-1.0) + PA_1 * PQ[b0] * PQ[d1] * (-1.0) + PA_1 * PQ[b0] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[d1] + PB_0 * PA_1 * QD_1)
                            + delta[a0][d0] * delta[b1][d1] * (PB_0 * PA_1 * QC_0)
                            + delta[a0][d1] * delta[b1][d0] * (PB_0 * PA_1 * QC_0)
                            + delta[a0][c0] * delta[b1][d1] * (PB_0 * PA_1 * QD_0)
                            + delta[a0][d1] * delta[b1][c0] * (PB_0 * PA_1 * QD_0)
                            + delta[a0][c0] * delta[b1][d0] * (PB_0 * PA_1 * QD_1)
                            + delta[a0][d0] * delta[b1][c0] * (PB_0 * PA_1 * QD_1)
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PQ[a1] * PQ[c0] * (-1.0) + PB_1 * PQ[a1] * QC_0 * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * (-1.0) + PA_1 * PQ[b1] * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[c0] + PB_1 * PA_1 * QC_0)
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * PQ[a1] * PQ[d0] * (-1.0) + PB_1 * PQ[a1] * QD_0 * (-1.0) + PA_1 * PQ[b1] * PQ[d0] * (-1.0) + PA_1 * PQ[b1] * QD_0 * (-1.0) + PB_1 * PA_1 * PQ[d0] + PB_1 * PA_1 * QD_0)
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PQ[a1] * PQ[d1] * (-1.0) + PB_1 * PQ[a1] * QD_1 * (-1.0) + PA_1 * PQ[b1] * PQ[d1] * (-1.0) + PA_1 * PQ[b1] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[d1] + PB_1 * PA_1 * QD_1)
                            + delta[a0][d0] * delta[b0][d1] * (PB_1 * PA_1 * QC_0)
                            + delta[a0][d1] * delta[b0][d0] * (PB_1 * PA_1 * QC_0)
                            + delta[a0][c0] * delta[b0][d1] * (PB_1 * PA_1 * QD_0)
                            + delta[a0][d1] * delta[b0][c0] * (PB_1 * PA_1 * QD_0)
                            + delta[a0][c0] * delta[b0][d0] * (PB_1 * PA_1 * QD_1)
                            + delta[a0][d0] * delta[b0][c0] * (PB_1 * PA_1 * QD_1)
                            + delta[a0][d1] * delta[b0][b1] * (PA_1 * PQ[c0] * QD_0 * (-1.0) + PA_1 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * (PA_1 * PQ[c0] * QD_0 * (-1.0) + PA_1 * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * (PA_1 * PQ[c0] * QD_0 * (-1.0) + PA_1 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * (PA_1 * PQ[c0] * QD_1 * (-1.0) + PA_1 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * (PA_1 * PQ[c0] * QD_1 * (-1.0) + PA_1 * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * (PA_1 * PQ[c0] * QD_1 * (-1.0) + PA_1 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * (PA_1 * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * (PA_1 * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * (PA_1 * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][d0] * delta[a1][d1] * (PB_0 * PB_1 * QC_0)
                            + delta[a0][d1] * delta[a1][d0] * (PB_0 * PB_1 * QC_0)
                            + delta[a0][a1] * delta[d0][d1] * (PB_0 * PQ[b1] * PQ[c0] * (-1.0) + PB_0 * PQ[b1] * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * (-1.0) + PB_1 * PQ[b0] * QC_0 * (-1.0) + PB_0 * PB_1 * PQ[c0] + PB_0 * PB_1 * QC_0)
                            + delta[a0][a1] * delta[c0][d1] * (PB_0 * PQ[b1] * PQ[d0] * (-1.0) + PB_0 * PQ[b1] * QD_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * (-1.0) + PB_1 * PQ[b0] * QD_0 * (-1.0) + PB_0 * PB_1 * PQ[d0] + PB_0 * PB_1 * QD_0)
                            + delta[a0][a1] * delta[c0][d0] * (PB_0 * PQ[b1] * PQ[d1] * (-1.0) + PB_0 * PQ[b1] * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * (-1.0) + PB_1 * PQ[b0] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[d1] + PB_0 * PB_1 * QD_1)
                            + delta[a0][d1] * delta[a1][b1] * (PB_0 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][d1] * (PB_0 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[a0][b1] * (PB_0 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[a1][b1] * (PB_0 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][d0] * (PB_0 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[a0][b1] * (PB_0 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][b1] * (PB_0 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][c0] * (PB_0 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][c0] * delta[a0][b1] * (PB_0 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * (PB_1 * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * (PB_1 * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * (PB_1 * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * (PB_1 * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * (PB_1 * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * (PB_1 * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * (PB_1 * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * (PB_1 * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * (PB_1 * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * (PQ[c0] * PQ[d0] * QD_1 + PQ[c0] * PQ[d1] * QD_0 + PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][b0] * delta[a1][b1] * (PQ[c0] * PQ[d0] * QD_1 + PQ[c0] * PQ[d1] * QD_0 + PQ[d0] * PQ[d1] * QC_0)
                            + delta[a1][b0] * delta[a0][b1] * (PQ[c0] * PQ[d0] * QD_1 + PQ[c0] * PQ[d1] * QD_0 + PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][c0] * delta[a1][d1] * (PB_0 * PB_1 * QD_0)
                            + delta[a0][d1] * delta[a1][c0] * (PB_0 * PB_1 * QD_0)
                            + delta[a0][c0] * delta[a1][d0] * (PB_0 * PB_1 * QD_1)
                            + delta[a0][d0] * delta[a1][c0] * (PB_0 * PB_1 * QD_1)
                        )

                    )

                    +

                    F7_t[2] * (

                        0.5 * ( S1 * S1 ) / ( S2 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0])
                            + delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PA_1 * PQ[d0])
                            + delta[c0][d0] * (PB_0 * PB_1 * PA_0 * PA_1 * PQ[d1])
                        )

                    )

                    +

                    F7_t[2] * (

                        0.5 * ( S2 * S2 ) / ( S1 * S4 * S4 ) * (
                            delta[b0][b1] * (PA_0 * PQ[a1] * QD_0 * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[a0] * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[a1] * QD_0 * QD_1 * QC_0)
                            + delta[a1][b1] * (PB_0 * PQ[a0] * QD_0 * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[b0] * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * QD_0 * QD_1 * QC_0)
                            + delta[a1][b0] * (PB_1 * PQ[a0] * QD_0 * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[b1] * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[b1] * QD_0 * QD_1 * QC_0)
                            + delta[a0][b1] * (PB_0 * PQ[a1] * QD_0 * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[b0] * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[a1] * PQ[b0] * QD_0 * QD_1 * QC_0)
                            + delta[a0][b0] * (PB_1 * PQ[a1] * QD_0 * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[b1] * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[a1] * PQ[b1] * QD_0 * QD_1 * QC_0)
                            + delta[a0][a1] * (PB_0 * PQ[b1] * QD_0 * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[b0] * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDPD6(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[3];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[2] * (

                        0.5 * S1 / ( S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[a1] * QC_0 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * QC_0 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * QC_0 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0] * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * QC_0 * (-1.0))
                            + delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d0] * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[a1] * QD_0 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d0] * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * QD_0 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d0] * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * QD_0 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d0] * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * QD_0 * (-1.0))
                            + delta[c0][d0] * (PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d1] * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[a1] * QD_1 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d1] * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * QD_1 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * QD_1 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * QD_1 * (-1.0))
                            + delta[b1][d1] * (PB_0 * PA_0 * PA_1 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[d0] * QC_0 * (-1.0))
                            + delta[b1][d0] * (PB_0 * PA_0 * PA_1 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[d1] * QC_0 * (-1.0))
                            + delta[b1][c0] * (PB_0 * PA_0 * PA_1 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][d1] * (PB_1 * PA_0 * PA_1 * PQ[c0] * QD_0 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][d0] * (PB_1 * PA_0 * PA_1 * PQ[c0] * QD_1 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][c0] * (PB_1 * PA_0 * PA_1 * PQ[d0] * QD_1 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][b1] * (PA_0 * PA_1 * PQ[c0] * PQ[d0] * QD_1 + PA_0 * PA_1 * PQ[c0] * PQ[d1] * QD_0 + PA_0 * PA_1 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a1][d1] * (PB_0 * PB_1 * PA_0 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][d0] * (PB_0 * PB_1 * PA_0 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][c0] * (PB_0 * PB_1 * PA_0 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][b1] * (PB_0 * PA_0 * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PA_0 * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PA_0 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a1][b0] * (PB_1 * PA_0 * PQ[c0] * PQ[d0] * QD_1 + PB_1 * PA_0 * PQ[c0] * PQ[d1] * QD_0 + PB_1 * PA_0 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][d1] * (PB_0 * PB_1 * PA_1 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d0] * (PB_0 * PB_1 * PA_1 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][c0] * (PB_0 * PB_1 * PA_1 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][b1] * (PB_0 * PA_1 * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PA_1 * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PA_1 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][b0] * (PB_1 * PA_1 * PQ[c0] * PQ[d0] * QD_1 + PB_1 * PA_1 * PQ[c0] * PQ[d1] * QD_0 + PB_1 * PA_1 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][a1] * (PB_0 * PB_1 * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PB_1 * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PB_1 * PQ[d0] * PQ[d1] * QC_0)
                        )

                    )

                    +

                    F7_t[2] * (

                        0.5 * S2 / ( S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * QC_0 + PB_0 * PA_0 * PQ[a1] * PQ[b1] * QC_0 + PB_0 * PA_1 * PQ[a0] * PQ[b1] * QC_0 + PB_1 * PA_0 * PQ[a1] * PQ[b0] * QC_0 + PB_1 * PA_1 * PQ[a0] * PQ[b0] * QC_0 + PA_0 * PA_1 * PQ[b0] * PQ[b1] * QC_0)
                            + delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * QD_0 + PB_0 * PA_0 * PQ[a1] * PQ[b1] * QD_0 + PB_0 * PA_1 * PQ[a0] * PQ[b1] * QD_0 + PB_1 * PA_0 * PQ[a1] * PQ[b0] * QD_0 + PB_1 * PA_1 * PQ[a0] * PQ[b0] * QD_0 + PA_0 * PA_1 * PQ[b0] * PQ[b1] * QD_0)
                            + delta[c0][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * QD_1 + PB_0 * PA_0 * PQ[a1] * PQ[b1] * QD_1 + PB_0 * PA_1 * PQ[a0] * PQ[b1] * QD_1 + PB_1 * PA_0 * PQ[a1] * PQ[b0] * QD_1 + PB_1 * PA_1 * PQ[a0] * PQ[b0] * QD_1 + PA_0 * PA_1 * PQ[b0] * PQ[b1] * QD_1)
                            + delta[b1][d1] * (PB_0 * PA_0 * PQ[a1] * QD_0 * QC_0 + PB_0 * PA_1 * PQ[a0] * QD_0 * QC_0 + PA_0 * PA_1 * PQ[b0] * QD_0 * QC_0)
                            + delta[b1][d0] * (PB_0 * PA_0 * PQ[a1] * QD_1 * QC_0 + PB_0 * PA_1 * PQ[a0] * QD_1 * QC_0 + PA_0 * PA_1 * PQ[b0] * QD_1 * QC_0)
                            + delta[b1][c0] * (PB_0 * PA_0 * PQ[a1] * QD_0 * QD_1 + PB_0 * PA_1 * PQ[a0] * QD_0 * QD_1 + PA_0 * PA_1 * PQ[b0] * QD_0 * QD_1)
                            + delta[b0][d1] * (PB_1 * PA_0 * PQ[a1] * QD_0 * QC_0 + PB_1 * PA_1 * PQ[a0] * QD_0 * QC_0 + PA_0 * PA_1 * PQ[b1] * QD_0 * QC_0)
                            + delta[b0][d0] * (PB_1 * PA_0 * PQ[a1] * QD_1 * QC_0 + PB_1 * PA_1 * PQ[a0] * QD_1 * QC_0 + PA_0 * PA_1 * PQ[b1] * QD_1 * QC_0)
                            + delta[b0][c0] * (PB_1 * PA_0 * PQ[a1] * QD_0 * QD_1 + PB_1 * PA_1 * PQ[a0] * QD_0 * QD_1 + PA_0 * PA_1 * PQ[b1] * QD_0 * QD_1)
                            + delta[b0][b1] * (PA_0 * PQ[a1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[c0] * QD_0 * QD_1 + PA_0 * PA_1 * PQ[d0] * QD_1 * QC_0 + PA_0 * PA_1 * PQ[d1] * QD_0 * QC_0)
                            + delta[a1][d1] * (PB_0 * PB_1 * PQ[a0] * QD_0 * QC_0 + PB_0 * PA_0 * PQ[b1] * QD_0 * QC_0 + PB_1 * PA_0 * PQ[b0] * QD_0 * QC_0)
                            + delta[a1][d0] * (PB_0 * PB_1 * PQ[a0] * QD_1 * QC_0 + PB_0 * PA_0 * PQ[b1] * QD_1 * QC_0 + PB_1 * PA_0 * PQ[b0] * QD_1 * QC_0)
                            + delta[a1][c0] * (PB_0 * PB_1 * PQ[a0] * QD_0 * QD_1 + PB_0 * PA_0 * PQ[b1] * QD_0 * QD_1 + PB_1 * PA_0 * PQ[b0] * QD_0 * QD_1)
                            + delta[a1][b1] * (PB_0 * PQ[a0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[c0] * QD_0 * QD_1 + PB_0 * PA_0 * PQ[d0] * QD_1 * QC_0 + PB_0 * PA_0 * PQ[d1] * QD_0 * QC_0)
                            + delta[a1][b0] * (PB_1 * PQ[a0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[c0] * QD_0 * QD_1 + PB_1 * PA_0 * PQ[d0] * QD_1 * QC_0 + PB_1 * PA_0 * PQ[d1] * QD_0 * QC_0)
                            + delta[a0][d1] * (PB_0 * PB_1 * PQ[a1] * QD_0 * QC_0 + PB_0 * PA_1 * PQ[b1] * QD_0 * QC_0 + PB_1 * PA_1 * PQ[b0] * QD_0 * QC_0)
                            + delta[a0][d0] * (PB_0 * PB_1 * PQ[a1] * QD_1 * QC_0 + PB_0 * PA_1 * PQ[b1] * QD_1 * QC_0 + PB_1 * PA_1 * PQ[b0] * QD_1 * QC_0)
                            + delta[a0][c0] * (PB_0 * PB_1 * PQ[a1] * QD_0 * QD_1 + PB_0 * PA_1 * PQ[b1] * QD_0 * QD_1 + PB_1 * PA_1 * PQ[b0] * QD_0 * QD_1)
                            + delta[a0][b1] * (PB_0 * PQ[a1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[a1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[a1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[c0] * QD_0 * QD_1 + PB_0 * PA_1 * PQ[d0] * QD_1 * QC_0 + PB_0 * PA_1 * PQ[d1] * QD_0 * QC_0)
                            + delta[a0][b0] * (PB_1 * PQ[a1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[a1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[a1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[c0] * QD_0 * QD_1 + PB_1 * PA_1 * PQ[d0] * QD_1 * QC_0 + PB_1 * PA_1 * PQ[d1] * QD_0 * QC_0)
                            + delta[a0][a1] * (PB_0 * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_0 * PB_1 * PQ[c0] * QD_0 * QD_1 + PB_0 * PB_1 * PQ[d0] * QD_1 * QC_0 + PB_0 * PB_1 * PQ[d1] * QD_0 * QC_0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDPD7(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[4];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[3] * (

                        ( S1 * S1 * S1 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                        )

                    )

                    +

                    F7_t[3] * (

                        ( S1 * S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[d0] * QD_1
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[d1] * QD_0
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d0] * PQ[d1] * QC_0
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[d0] * QD_1
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[d1] * QD_0
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d0] * PQ[d1] * QC_0
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[d0] * QD_1
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[d1] * QD_0
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d0] * PQ[d1] * QC_0
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[d0] * QD_1
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[d1] * QD_0
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d0] * PQ[d1] * QC_0
                        )

                    )

                    +

                    F7_t[3] * (

                        ( S1 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                        )

                    )

                    +

                    F7_t[3] * (

                        ( S2 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * QD_0 * QD_1 * QC_0
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * QD_0 * QD_1 * QC_0
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_0
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_0
                        )

                    )

                    +

                    F7_t[3] * (

                        0.125 * S2 / ( S1 * S4 * S4 * S4 ) * (
                            delta[a1][c0] * delta[b0][b1] * delta[d0][d1] * (PQ[a0] * (-1.0))
                            + delta[a1][d0] * delta[b0][b1] * delta[c0][d1] * (PQ[a0] * (-1.0))
                            + delta[a1][d1] * delta[b0][b1] * delta[c0][d0] * (PQ[a0] * (-1.0))
                            + delta[a1][b0] * delta[b1][c0] * delta[d0][d1] * (PQ[a0] * (-1.0))
                            + delta[a1][b0] * delta[b1][d0] * delta[c0][d1] * (PQ[a0] * (-1.0))
                            + delta[a1][b0] * delta[b1][d1] * delta[c0][d0] * (PQ[a0] * (-1.0))
                            + delta[b0][c0] * delta[a1][b1] * delta[d0][d1] * (PQ[a0] * (-1.0))
                            + delta[b0][d0] * delta[a1][b1] * delta[c0][d1] * (PQ[a0] * (-1.0))
                            + delta[b0][d1] * delta[a1][b1] * delta[c0][d0] * (PQ[a0] * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * delta[d0][d1] * (PQ[a1] * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][d1] * (PQ[a1] * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][d0] * (PQ[a1] * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * delta[d0][d1] * (PQ[a1] * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][d1] * (PQ[a1] * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][d0] * (PQ[a1] * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * delta[d0][d1] * (PQ[a1] * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][d1] * (PQ[a1] * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][d0] * (PQ[a1] * (-1.0))
                            + delta[a0][c0] * delta[a1][b1] * delta[d0][d1] * (PQ[b0] * (-1.0))
                            + delta[a0][d0] * delta[a1][b1] * delta[c0][d1] * (PQ[b0] * (-1.0))
                            + delta[a0][d1] * delta[a1][b1] * delta[c0][d0] * (PQ[b0] * (-1.0))
                            + delta[a0][a1] * delta[b1][c0] * delta[d0][d1] * (PQ[b0] * (-1.0))
                            + delta[a0][a1] * delta[b1][d0] * delta[c0][d1] * (PQ[b0] * (-1.0))
                            + delta[a0][a1] * delta[b1][d1] * delta[c0][d0] * (PQ[b0] * (-1.0))
                            + delta[a1][c0] * delta[a0][b1] * delta[d0][d1] * (PQ[b0] * (-1.0))
                            + delta[a1][d0] * delta[a0][b1] * delta[c0][d1] * (PQ[b0] * (-1.0))
                            + delta[a1][d1] * delta[a0][b1] * delta[c0][d0] * (PQ[b0] * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * delta[d0][d1] * (PQ[b1] * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * delta[c0][d1] * (PQ[b1] * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * delta[c0][d0] * (PQ[b1] * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * delta[d0][d1] * (PQ[b1] * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * delta[c0][d1] * (PQ[b1] * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * delta[c0][d0] * (PQ[b1] * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * delta[d0][d1] * (PQ[b1] * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * delta[c0][d1] * (PQ[b1] * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * delta[c0][d0] * (PQ[b1] * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[d0][d1] * (PQ[c0] * (-1.0) + QC_0 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[d0][d1] * (PQ[c0] * (-1.0) + QC_0 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[d0][d1] * (PQ[c0] * (-1.0) + QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d1] * (PQ[d0] * (-1.0) + QD_0 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d1] * (PQ[d0] * (-1.0) + QD_0 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d1] * (PQ[d0] * (-1.0) + QD_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * (PQ[d1] * (-1.0) + QD_1 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * (PQ[d1] * (-1.0) + QD_1 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * (PQ[d1] * (-1.0) + QD_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][d1] * delta[b0][b1] * (QC_0 * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][d1] * (QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b0][d1] * delta[a1][b1] * (QC_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][b1] * (QC_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][d0] * (QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * delta[a1][b1] * (QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][d1] * (QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][d0] * (QC_0 * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][d1] * (QC_0 * (-1.0))
                            + delta[a1][d0] * delta[b0][d1] * delta[a0][b1] * (QC_0 * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][d0] * (QC_0 * (-1.0))
                            + delta[a1][d1] * delta[b0][d0] * delta[a0][b1] * (QC_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][d1] * delta[b0][b1] * (QD_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d1] * (QD_0 * (-1.0))
                            + delta[a0][c0] * delta[b0][d1] * delta[a1][b1] * (QD_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][c0] * delta[b0][b1] * (QD_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][c0] * (QD_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][c0] * delta[a1][b1] * (QD_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d1] * (QD_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][c0] * (QD_0 * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d1] * (QD_0 * (-1.0))
                            + delta[a1][c0] * delta[b0][d1] * delta[a0][b1] * (QD_0 * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][c0] * (QD_0 * (-1.0))
                            + delta[a1][d1] * delta[b0][c0] * delta[a0][b1] * (QD_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][d0] * delta[b0][b1] * (QD_1 * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d0] * (QD_1 * (-1.0))
                            + delta[a0][c0] * delta[b0][d0] * delta[a1][b1] * (QD_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][b1] * (QD_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][c0] * (QD_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][c0] * delta[a1][b1] * (QD_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d0] * (QD_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][c0] * (QD_1 * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d0] * (QD_1 * (-1.0))
                            + delta[a1][c0] * delta[b0][d0] * delta[a0][b1] * (QD_1 * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][c0] * (QD_1 * (-1.0))
                            + delta[a1][d0] * delta[b0][c0] * delta[a0][b1] * (QD_1 * (-1.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDPD8(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[4];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[3] * (

                        0.125 / ( S4 * S4 * S4 ) * (
                            delta[a1][c0] * delta[b0][b1] * delta[d0][d1] * (PQ[a0] * (-1.0) + PA_0)
                            + delta[a1][c0] * delta[b0][d0] * delta[b1][d1] * (PA_0)
                            + delta[a1][c0] * delta[b0][d1] * delta[b1][d0] * (PA_0)
                            + delta[a1][d0] * delta[b0][b1] * delta[c0][d1] * (PQ[a0] * (-1.0) + PA_0)
                            + delta[a1][d0] * delta[b0][c0] * delta[b1][d1] * (PA_0)
                            + delta[a1][d0] * delta[b0][d1] * delta[b1][c0] * (PA_0)
                            + delta[a1][d1] * delta[b0][b1] * delta[c0][d0] * (PQ[a0] * (-1.0) + PA_0)
                            + delta[a1][d1] * delta[b0][c0] * delta[b1][d0] * (PA_0)
                            + delta[a1][d1] * delta[b0][d0] * delta[b1][c0] * (PA_0)
                            + delta[a1][b0] * delta[b1][c0] * delta[d0][d1] * (PQ[a0] * (-1.0) + PA_0)
                            + delta[a1][b0] * delta[b1][d0] * delta[c0][d1] * (PQ[a0] * (-1.0) + PA_0)
                            + delta[a1][b0] * delta[b1][d1] * delta[c0][d0] * (PQ[a0] * (-1.0) + PA_0)
                            + delta[b0][c0] * delta[a1][b1] * delta[d0][d1] * (PQ[a0] * (-1.0) + PA_0)
                            + delta[b0][d0] * delta[a1][b1] * delta[c0][d1] * (PQ[a0] * (-1.0) + PA_0)
                            + delta[b0][d1] * delta[a1][b1] * delta[c0][d0] * (PQ[a0] * (-1.0) + PA_0)
                            + delta[a0][c0] * delta[b0][b1] * delta[d0][d1] * (PQ[a1] * (-1.0) + PA_1)
                            + delta[a0][c0] * delta[b0][d0] * delta[b1][d1] * (PA_1)
                            + delta[a0][c0] * delta[b0][d1] * delta[b1][d0] * (PA_1)
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][d1] * (PQ[a1] * (-1.0) + PA_1)
                            + delta[a0][d0] * delta[b0][c0] * delta[b1][d1] * (PA_1)
                            + delta[a0][d0] * delta[b0][d1] * delta[b1][c0] * (PA_1)
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][d0] * (PQ[a1] * (-1.0) + PA_1)
                            + delta[a0][d1] * delta[b0][c0] * delta[b1][d0] * (PA_1)
                            + delta[a0][d1] * delta[b0][d0] * delta[b1][c0] * (PA_1)
                            + delta[a0][b0] * delta[b1][c0] * delta[d0][d1] * (PQ[a1] * (-1.0) + PA_1)
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][d1] * (PQ[a1] * (-1.0) + PA_1)
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][d0] * (PQ[a1] * (-1.0) + PA_1)
                            + delta[b0][c0] * delta[a0][b1] * delta[d0][d1] * (PQ[a1] * (-1.0) + PA_1)
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][d1] * (PQ[a1] * (-1.0) + PA_1)
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][d0] * (PQ[a1] * (-1.0) + PA_1)
                            + delta[a0][c0] * delta[a1][b1] * delta[d0][d1] * (PQ[b0] * (-1.0) + PB_0)
                            + delta[a0][d0] * delta[a1][b1] * delta[c0][d1] * (PQ[b0] * (-1.0) + PB_0)
                            + delta[a0][d1] * delta[a1][b1] * delta[c0][d0] * (PQ[b0] * (-1.0) + PB_0)
                            + delta[a0][a1] * delta[b1][c0] * delta[d0][d1] * (PQ[b0] * (-1.0) + PB_0)
                            + delta[a0][a1] * delta[b1][d0] * delta[c0][d1] * (PQ[b0] * (-1.0) + PB_0)
                            + delta[a0][a1] * delta[b1][d1] * delta[c0][d0] * (PQ[b0] * (-1.0) + PB_0)
                            + delta[a1][c0] * delta[a0][b1] * delta[d0][d1] * (PQ[b0] * (-1.0) + PB_0)
                            + delta[a1][d0] * delta[a0][b1] * delta[c0][d1] * (PQ[b0] * (-1.0) + PB_0)
                            + delta[a1][d1] * delta[a0][b1] * delta[c0][d0] * (PQ[b0] * (-1.0) + PB_0)
                            + delta[a0][c0] * delta[a1][b0] * delta[d0][d1] * (PQ[b1] * (-1.0) + PB_1)
                            + delta[a0][d0] * delta[a1][b0] * delta[c0][d1] * (PQ[b1] * (-1.0) + PB_1)
                            + delta[a0][d1] * delta[a1][b0] * delta[c0][d0] * (PQ[b1] * (-1.0) + PB_1)
                            + delta[a0][a1] * delta[b0][c0] * delta[d0][d1] * (PQ[b1] * (-1.0) + PB_1)
                            + delta[a0][a1] * delta[b0][d0] * delta[c0][d1] * (PQ[b1] * (-1.0) + PB_1)
                            + delta[a0][a1] * delta[b0][d1] * delta[c0][d0] * (PQ[b1] * (-1.0) + PB_1)
                            + delta[a1][c0] * delta[a0][b0] * delta[d0][d1] * (PQ[b1] * (-1.0) + PB_1)
                            + delta[a1][d0] * delta[a0][b0] * delta[c0][d1] * (PQ[b1] * (-1.0) + PB_1)
                            + delta[a1][d1] * delta[a0][b0] * delta[c0][d0] * (PQ[b1] * (-1.0) + PB_1)
                            + delta[a0][d0] * delta[a1][d1] * delta[b0][b1] * (PQ[c0] * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][d1] * (PQ[c0] * (-1.0))
                            + delta[a0][d0] * delta[b0][d1] * delta[a1][b1] * (PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][b1] * (PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][d0] * (PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * delta[a1][b1] * (PQ[c0] * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[d0][d1] * (PQ[c0] * (-2.0))
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][d1] * (PQ[c0] * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][d0] * (PQ[c0] * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][d1] * (PQ[c0] * (-1.0))
                            + delta[a1][d0] * delta[b0][d1] * delta[a0][b1] * (PQ[c0] * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][d0] * (PQ[c0] * (-1.0))
                            + delta[a1][d1] * delta[b0][d0] * delta[a0][b1] * (PQ[c0] * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[d0][d1] * (PQ[c0] * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[d0][d1] * (PQ[c0] * (-2.0))
                            + delta[a0][c0] * delta[a1][d1] * delta[b0][b1] * (PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d1] * (PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[b0][d1] * delta[a1][b1] * (PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[a1][c0] * delta[b0][b1] * (PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][c0] * (PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[b0][c0] * delta[a1][b1] * (PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d1] * (PQ[d0] * (-2.0))
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d1] * (PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][c0] * (PQ[d0] * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d1] * (PQ[d0] * (-1.0))
                            + delta[a1][c0] * delta[b0][d1] * delta[a0][b1] * (PQ[d0] * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][c0] * (PQ[d0] * (-1.0))
                            + delta[a1][d1] * delta[b0][c0] * delta[a0][b1] * (PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d1] * (PQ[d0] * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d1] * (PQ[d0] * (-2.0))
                            + delta[a0][c0] * delta[a1][d0] * delta[b0][b1] * (PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d0] * (PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[b0][d0] * delta[a1][b1] * (PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][b1] * (PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][c0] * (PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[b0][c0] * delta[a1][b1] * (PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * (PQ[d1] * (-2.0))
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d0] * (PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][c0] * (PQ[d1] * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d0] * (PQ[d1] * (-1.0))
                            + delta[a1][c0] * delta[b0][d0] * delta[a0][b1] * (PQ[d1] * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][c0] * (PQ[d1] * (-1.0))
                            + delta[a1][d0] * delta[b0][c0] * delta[a0][b1] * (PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * (PQ[d1] * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * (PQ[d1] * (-2.0))
                            + delta[a0][c0] * delta[a1][d0] * delta[b1][d1] * (PB_0)
                            + delta[a0][c0] * delta[a1][d1] * delta[b1][d0] * (PB_0)
                            + delta[a0][d0] * delta[a1][c0] * delta[b1][d1] * (PB_0)
                            + delta[a0][d0] * delta[a1][d1] * delta[b1][c0] * (PB_0)
                            + delta[a0][d1] * delta[a1][c0] * delta[b1][d0] * (PB_0)
                            + delta[a0][d1] * delta[a1][d0] * delta[b1][c0] * (PB_0)
                            + delta[a0][c0] * delta[a1][d0] * delta[b0][d1] * (PB_1)
                            + delta[a0][c0] * delta[a1][d1] * delta[b0][d0] * (PB_1)
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][d1] * (PB_1)
                            + delta[a0][d0] * delta[a1][d1] * delta[b0][c0] * (PB_1)
                            + delta[a0][d1] * delta[a1][c0] * delta[b0][d0] * (PB_1)
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][c0] * (PB_1)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDPD9(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[4];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[3] * (

                        0.25 * ( S2 * S2 ) / ( S1 * S4 * S4 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PQ[a0] * PQ[a1] * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c0][d1] * (PQ[a0] * PQ[a1] * QD_0 * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * QD_1 * (-1.0))
                            + delta[a1][b1] * delta[d0][d1] * (PQ[a0] * PQ[b0] * QC_0 * (-1.0))
                            + delta[a1][b1] * delta[c0][d1] * (PQ[a0] * PQ[b0] * QD_0 * (-1.0))
                            + delta[a1][b1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * QD_1 * (-1.0))
                            + delta[a1][b0] * delta[d0][d1] * (PQ[a0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[c0][d1] * (PQ[a0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[a1][b0] * delta[c0][d0] * (PQ[a0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[a1][d1] * delta[b0][b1] * (PQ[a0] * QD_0 * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][d1] * (PQ[a0] * QD_0 * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[a1][b1] * (PQ[a0] * QD_0 * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[b0][b1] * (PQ[a0] * QD_1 * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][d0] * (PQ[a0] * QD_1 * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[a1][b1] * (PQ[a0] * QD_1 * QC_0 * (-1.0))
                            + delta[a1][c0] * delta[b0][b1] * (PQ[a0] * QD_0 * QD_1 * (-1.0))
                            + delta[a1][b0] * delta[b1][c0] * (PQ[a0] * QD_0 * QD_1 * (-1.0))
                            + delta[b0][c0] * delta[a1][b1] * (PQ[a0] * QD_0 * QD_1 * (-1.0))
                            + delta[a0][b1] * delta[d0][d1] * (PQ[a1] * PQ[b0] * QC_0 * (-1.0))
                            + delta[a0][b1] * delta[c0][d1] * (PQ[a1] * PQ[b0] * QD_0 * (-1.0))
                            + delta[a0][b1] * delta[c0][d0] * (PQ[a1] * PQ[b0] * QD_1 * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PQ[a1] * PQ[b1] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c0][d1] * (PQ[a1] * PQ[b1] * QD_0 * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (PQ[a1] * PQ[b1] * QD_1 * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * (PQ[a1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * (PQ[a1] * QD_0 * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * (PQ[a1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * (PQ[a1] * QD_1 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * (PQ[a1] * QD_1 * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * (PQ[a1] * QD_1 * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * (PQ[a1] * QD_0 * QD_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * (PQ[a1] * QD_0 * QD_1 * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * (PQ[a1] * QD_0 * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[d0][d1] * (PQ[b0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[c0][d1] * (PQ[b0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[a0][a1] * delta[c0][d0] * (PQ[b0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[a0][d1] * delta[a1][b1] * (PQ[b0] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][d1] * (PQ[b0] * QD_0 * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[a0][b1] * (PQ[b0] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[a1][b1] * (PQ[b0] * QD_1 * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][d0] * (PQ[b0] * QD_1 * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[a0][b1] * (PQ[b0] * QD_1 * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][b1] * (PQ[b0] * QD_0 * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[b1][c0] * (PQ[b0] * QD_0 * QD_1 * (-1.0))
                            + delta[a1][c0] * delta[a0][b1] * (PQ[b0] * QD_0 * QD_1 * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * (PQ[b1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * (PQ[b1] * QD_0 * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * (PQ[b1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * (PQ[b1] * QD_1 * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * (PQ[b1] * QD_1 * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * (PQ[b1] * QD_1 * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * (PQ[b1] * QD_0 * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * (PQ[b1] * QD_0 * QD_1 * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * (PQ[b1] * QD_0 * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * (PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * (PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * (PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[d1] * QD_0 * QC_0 * (-1.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDPD10(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[4];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[3] * (

                        0.25 * S1 / ( S4 * S4 * S4 ) * (
                            delta[b1][c0] * delta[d0][d1] * (PB_0 * PA_0 * PQ[a1] * (-1.0) + PB_0 * PA_1 * PQ[a0] * (-1.0) + PA_0 * PA_1 * PQ[b0] * (-1.0))
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * PA_0 * PQ[a1] * (-1.0) + PB_0 * PA_1 * PQ[a0] * (-1.0) + PA_0 * PA_1 * PQ[b0] * (-1.0))
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * PA_0 * PQ[a1] * (-1.0) + PB_0 * PA_1 * PQ[a0] * (-1.0) + PA_0 * PA_1 * PQ[b0] * (-1.0))
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * PA_0 * PQ[a1] * (-1.0) + PB_1 * PA_1 * PQ[a0] * (-1.0) + PA_0 * PA_1 * PQ[b1] * (-1.0))
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * PA_0 * PQ[a1] * (-1.0) + PB_1 * PA_1 * PQ[a0] * (-1.0) + PA_0 * PA_1 * PQ[b1] * (-1.0))
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * PA_0 * PQ[a1] * (-1.0) + PB_1 * PA_1 * PQ[a0] * (-1.0) + PA_0 * PA_1 * PQ[b1] * (-1.0))
                            + delta[b0][b1] * delta[d0][d1] * (PA_0 * PA_1 * PQ[c0] * (-1.0) + PA_0 * PQ[a1] * PQ[c0] + PA_1 * PQ[a0] * PQ[c0])
                            + delta[b0][d0] * delta[b1][d1] * (PA_0 * PA_1 * PQ[c0] * (-1.0))
                            + delta[b0][d1] * delta[b1][d0] * (PA_0 * PA_1 * PQ[c0] * (-1.0))
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * PA_1 * PQ[d0] * (-1.0) + PA_0 * PQ[a1] * PQ[d0] + PA_1 * PQ[a0] * PQ[d0])
                            + delta[b0][c0] * delta[b1][d1] * (PA_0 * PA_1 * PQ[d0] * (-1.0))
                            + delta[b0][d1] * delta[b1][c0] * (PA_0 * PA_1 * PQ[d0] * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * PA_1 * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[d1] + PA_1 * PQ[a0] * PQ[d1])
                            + delta[b0][c0] * delta[b1][d0] * (PA_0 * PA_1 * PQ[d1] * (-1.0))
                            + delta[b0][d0] * delta[b1][c0] * (PA_0 * PA_1 * PQ[d1] * (-1.0))
                            + delta[a1][c0] * delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * (-1.0) + PB_0 * PA_0 * PQ[b1] * (-1.0) + PB_1 * PA_0 * PQ[b0] * (-1.0))
                            + delta[a1][d0] * delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] * (-1.0) + PB_0 * PA_0 * PQ[b1] * (-1.0) + PB_1 * PA_0 * PQ[b0] * (-1.0))
                            + delta[a1][d1] * delta[c0][d0] * (PB_0 * PB_1 * PQ[a0] * (-1.0) + PB_0 * PA_0 * PQ[b1] * (-1.0) + PB_1 * PA_0 * PQ[b0] * (-1.0))
                            + delta[a1][d0] * delta[b1][d1] * (PB_0 * PA_0 * PQ[c0] * (-1.0))
                            + delta[a1][d1] * delta[b1][d0] * (PB_0 * PA_0 * PQ[c0] * (-1.0))
                            + delta[a1][b1] * delta[d0][d1] * (PB_0 * PA_0 * PQ[c0] * (-1.0) + PB_0 * PQ[a0] * PQ[c0] + PA_0 * PQ[b0] * PQ[c0])
                            + delta[a1][c0] * delta[b1][d1] * (PB_0 * PA_0 * PQ[d0] * (-1.0))
                            + delta[a1][d1] * delta[b1][c0] * (PB_0 * PA_0 * PQ[d0] * (-1.0))
                            + delta[a1][b1] * delta[c0][d1] * (PB_0 * PA_0 * PQ[d0] * (-1.0) + PB_0 * PQ[a0] * PQ[d0] + PA_0 * PQ[b0] * PQ[d0])
                            + delta[a1][c0] * delta[b1][d0] * (PB_0 * PA_0 * PQ[d1] * (-1.0))
                            + delta[a1][d0] * delta[b1][c0] * (PB_0 * PA_0 * PQ[d1] * (-1.0))
                            + delta[a1][b1] * delta[c0][d0] * (PB_0 * PA_0 * PQ[d1] * (-1.0) + PB_0 * PQ[a0] * PQ[d1] + PA_0 * PQ[b0] * PQ[d1])
                            + delta[a1][d0] * delta[b0][d1] * (PB_1 * PA_0 * PQ[c0] * (-1.0))
                            + delta[a1][d1] * delta[b0][d0] * (PB_1 * PA_0 * PQ[c0] * (-1.0))
                            + delta[a1][b0] * delta[d0][d1] * (PB_1 * PA_0 * PQ[c0] * (-1.0) + PB_1 * PQ[a0] * PQ[c0] + PA_0 * PQ[b1] * PQ[c0])
                            + delta[a1][c0] * delta[b0][d1] * (PB_1 * PA_0 * PQ[d0] * (-1.0))
                            + delta[a1][d1] * delta[b0][c0] * (PB_1 * PA_0 * PQ[d0] * (-1.0))
                            + delta[a1][b0] * delta[c0][d1] * (PB_1 * PA_0 * PQ[d0] * (-1.0) + PB_1 * PQ[a0] * PQ[d0] + PA_0 * PQ[b1] * PQ[d0])
                            + delta[a1][c0] * delta[b0][d0] * (PB_1 * PA_0 * PQ[d1] * (-1.0))
                            + delta[a1][d0] * delta[b0][c0] * (PB_1 * PA_0 * PQ[d1] * (-1.0))
                            + delta[a1][b0] * delta[c0][d0] * (PB_1 * PA_0 * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[d1] + PA_0 * PQ[b1] * PQ[d1])
                            + delta[a1][d1] * delta[b0][b1] * (PA_0 * PQ[c0] * PQ[d0])
                            + delta[a1][b0] * delta[b1][d1] * (PA_0 * PQ[c0] * PQ[d0])
                            + delta[b0][d1] * delta[a1][b1] * (PA_0 * PQ[c0] * PQ[d0])
                            + delta[a1][d0] * delta[b0][b1] * (PA_0 * PQ[c0] * PQ[d1])
                            + delta[a1][b0] * delta[b1][d0] * (PA_0 * PQ[c0] * PQ[d1])
                            + delta[b0][d0] * delta[a1][b1] * (PA_0 * PQ[c0] * PQ[d1])
                            + delta[a1][c0] * delta[b0][b1] * (PA_0 * PQ[d0] * PQ[d1])
                            + delta[a1][b0] * delta[b1][c0] * (PA_0 * PQ[d0] * PQ[d1])
                            + delta[b0][c0] * delta[a1][b1] * (PA_0 * PQ[d0] * PQ[d1])
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * PB_1 * PQ[a1] * (-1.0) + PB_0 * PA_1 * PQ[b1] * (-1.0) + PB_1 * PA_1 * PQ[b0] * (-1.0))
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * PB_1 * PQ[a1] * (-1.0) + PB_0 * PA_1 * PQ[b1] * (-1.0) + PB_1 * PA_1 * PQ[b0] * (-1.0))
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * PB_1 * PQ[a1] * (-1.0) + PB_0 * PA_1 * PQ[b1] * (-1.0) + PB_1 * PA_1 * PQ[b0] * (-1.0))
                            + delta[a0][d0] * delta[b1][d1] * (PB_0 * PA_1 * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[b1][d0] * (PB_0 * PA_1 * PQ[c0] * (-1.0))
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PA_1 * PQ[c0] * (-1.0) + PB_0 * PQ[a1] * PQ[c0] + PA_1 * PQ[b0] * PQ[c0])
                            + delta[a0][c0] * delta[b1][d1] * (PB_0 * PA_1 * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[b1][c0] * (PB_0 * PA_1 * PQ[d0] * (-1.0))
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * PA_1 * PQ[d0] * (-1.0) + PB_0 * PQ[a1] * PQ[d0] + PA_1 * PQ[b0] * PQ[d0])
                            + delta[a0][c0] * delta[b1][d0] * (PB_0 * PA_1 * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[b1][c0] * (PB_0 * PA_1 * PQ[d1] * (-1.0))
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PA_1 * PQ[d1] * (-1.0) + PB_0 * PQ[a1] * PQ[d1] + PA_1 * PQ[b0] * PQ[d1])
                            + delta[a0][d0] * delta[b0][d1] * (PB_1 * PA_1 * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * (PB_1 * PA_1 * PQ[c0] * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PA_1 * PQ[c0] * (-1.0) + PB_1 * PQ[a1] * PQ[c0] + PA_1 * PQ[b1] * PQ[c0])
                            + delta[a0][c0] * delta[b0][d1] * (PB_1 * PA_1 * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[b0][c0] * (PB_1 * PA_1 * PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * PA_1 * PQ[d0] * (-1.0) + PB_1 * PQ[a1] * PQ[d0] + PA_1 * PQ[b1] * PQ[d0])
                            + delta[a0][c0] * delta[b0][d0] * (PB_1 * PA_1 * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[b0][c0] * (PB_1 * PA_1 * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PA_1 * PQ[d1] * (-1.0) + PB_1 * PQ[a1] * PQ[d1] + PA_1 * PQ[b1] * PQ[d1])
                            + delta[a0][d1] * delta[b0][b1] * (PA_1 * PQ[c0] * PQ[d0])
                            + delta[a0][b0] * delta[b1][d1] * (PA_1 * PQ[c0] * PQ[d0])
                            + delta[b0][d1] * delta[a0][b1] * (PA_1 * PQ[c0] * PQ[d0])
                            + delta[a0][d0] * delta[b0][b1] * (PA_1 * PQ[c0] * PQ[d1])
                            + delta[a0][b0] * delta[b1][d0] * (PA_1 * PQ[c0] * PQ[d1])
                            + delta[b0][d0] * delta[a0][b1] * (PA_1 * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * delta[b0][b1] * (PA_1 * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * delta[b1][c0] * (PA_1 * PQ[d0] * PQ[d1])
                            + delta[b0][c0] * delta[a0][b1] * (PA_1 * PQ[d0] * PQ[d1])
                            + delta[a0][d0] * delta[a1][d1] * (PB_0 * PB_1 * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[a1][d0] * (PB_0 * PB_1 * PQ[c0] * (-1.0))
                            + delta[a0][a1] * delta[d0][d1] * (PB_0 * PB_1 * PQ[c0] * (-1.0) + PB_0 * PQ[b1] * PQ[c0] + PB_1 * PQ[b0] * PQ[c0])
                            + delta[a0][c0] * delta[a1][d1] * (PB_0 * PB_1 * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[a1][c0] * (PB_0 * PB_1 * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[c0][d1] * (PB_0 * PB_1 * PQ[d0] * (-1.0) + PB_0 * PQ[b1] * PQ[d0] + PB_1 * PQ[b0] * PQ[d0])
                            + delta[a0][c0] * delta[a1][d0] * (PB_0 * PB_1 * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[a1][c0] * (PB_0 * PB_1 * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[c0][d0] * (PB_0 * PB_1 * PQ[d1] * (-1.0) + PB_0 * PQ[b1] * PQ[d1] + PB_1 * PQ[b0] * PQ[d1])
                            + delta[a0][a1] * delta[b0][b1] * (PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * (PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * (PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][d1] * delta[a1][b1] * (PB_0 * PQ[c0] * PQ[d0])
                            + delta[a0][a1] * delta[b1][d1] * (PB_0 * PQ[c0] * PQ[d0])
                            + delta[a1][d1] * delta[a0][b1] * (PB_0 * PQ[c0] * PQ[d0])
                            + delta[a0][d0] * delta[a1][b1] * (PB_0 * PQ[c0] * PQ[d1])
                            + delta[a0][a1] * delta[b1][d0] * (PB_0 * PQ[c0] * PQ[d1])
                            + delta[a1][d0] * delta[a0][b1] * (PB_0 * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * delta[a1][b1] * (PB_0 * PQ[d0] * PQ[d1])
                            + delta[a0][a1] * delta[b1][c0] * (PB_0 * PQ[d0] * PQ[d1])
                            + delta[a1][c0] * delta[a0][b1] * (PB_0 * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * delta[a1][b0] * (PB_1 * PQ[c0] * PQ[d0])
                            + delta[a0][a1] * delta[b0][d1] * (PB_1 * PQ[c0] * PQ[d0])
                            + delta[a1][d1] * delta[a0][b0] * (PB_1 * PQ[c0] * PQ[d0])
                            + delta[a0][d0] * delta[a1][b0] * (PB_1 * PQ[c0] * PQ[d1])
                            + delta[a0][a1] * delta[b0][d0] * (PB_1 * PQ[c0] * PQ[d1])
                            + delta[a1][d0] * delta[a0][b0] * (PB_1 * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * delta[a1][b0] * (PB_1 * PQ[d0] * PQ[d1])
                            + delta[a0][a1] * delta[b0][c0] * (PB_1 * PQ[d0] * PQ[d1])
                            + delta[a1][c0] * delta[a0][b0] * (PB_1 * PQ[d0] * PQ[d1])
                        )

                    )

                    +

                    F7_t[3] * (

                        0.25 * S2 / ( S4 * S4 * S4 ) * (
                            delta[b1][c0] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[a1] + PA_0 * PQ[a1] * PQ[b0] + PA_1 * PQ[a0] * PQ[b0])
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[a1] + PA_0 * PQ[a1] * PQ[b0] + PA_1 * PQ[a0] * PQ[b0])
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * PQ[a0] * PQ[a1] + PA_0 * PQ[a1] * PQ[b0] + PA_1 * PQ[a0] * PQ[b0])
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * PQ[a0] * PQ[a1] + PA_0 * PQ[a1] * PQ[b1] + PA_1 * PQ[a0] * PQ[b1])
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * PQ[a0] * PQ[a1] + PA_0 * PQ[a1] * PQ[b1] + PA_1 * PQ[a0] * PQ[b1])
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * PQ[a0] * PQ[a1] + PA_0 * PQ[a1] * PQ[b1] + PA_1 * PQ[a0] * PQ[b1])
                            + delta[b0][b1] * delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[c0] * (-1.0) + PQ[a0] * PQ[a1] * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[c0] + PA_0 * PQ[a1] * QC_0 + PA_1 * PQ[a0] * PQ[c0] + PA_1 * PQ[a0] * QC_0)
                            + delta[b0][b1] * delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[d0] * (-1.0) + PQ[a0] * PQ[a1] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[d0] + PA_0 * PQ[a1] * QD_0 + PA_1 * PQ[a0] * PQ[d0] + PA_1 * PQ[a0] * QD_0)
                            + delta[b0][b1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[d1] * (-1.0) + PQ[a0] * PQ[a1] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[d1] + PA_0 * PQ[a1] * QD_1 + PA_1 * PQ[a0] * PQ[d1] + PA_1 * PQ[a0] * QD_1)
                            + delta[b0][d0] * delta[b1][d1] * (PA_0 * PQ[a1] * QC_0 + PA_1 * PQ[a0] * QC_0)
                            + delta[b0][d1] * delta[b1][d0] * (PA_0 * PQ[a1] * QC_0 + PA_1 * PQ[a0] * QC_0)
                            + delta[b0][c0] * delta[b1][d1] * (PA_0 * PQ[a1] * QD_0 + PA_1 * PQ[a0] * QD_0)
                            + delta[b0][d1] * delta[b1][c0] * (PA_0 * PQ[a1] * QD_0 + PA_1 * PQ[a0] * QD_0)
                            + delta[b0][c0] * delta[b1][d0] * (PA_0 * PQ[a1] * QD_1 + PA_1 * PQ[a0] * QD_1)
                            + delta[b0][d0] * delta[b1][c0] * (PA_0 * PQ[a1] * QD_1 + PA_1 * PQ[a0] * QD_1)
                            + delta[a1][c0] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[b1] + PB_1 * PQ[a0] * PQ[b0] + PA_0 * PQ[b0] * PQ[b1])
                            + delta[a1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[b1] + PB_1 * PQ[a0] * PQ[b0] + PA_0 * PQ[b0] * PQ[b1])
                            + delta[a1][d1] * delta[c0][d0] * (PB_0 * PQ[a0] * PQ[b1] + PB_1 * PQ[a0] * PQ[b0] + PA_0 * PQ[b0] * PQ[b1])
                            + delta[a1][b1] * delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * (-1.0) + PQ[a0] * PQ[b0] * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[c0] + PB_0 * PQ[a0] * QC_0 + PA_0 * PQ[b0] * PQ[c0] + PA_0 * PQ[b0] * QC_0)
                            + delta[a1][b1] * delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[d0] * (-1.0) + PQ[a0] * PQ[b0] * QD_0 * (-1.0) + PB_0 * PQ[a0] * PQ[d0] + PB_0 * PQ[a0] * QD_0 + PA_0 * PQ[b0] * PQ[d0] + PA_0 * PQ[b0] * QD_0)
                            + delta[a1][b1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[b0] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[d1] + PB_0 * PQ[a0] * QD_1 + PA_0 * PQ[b0] * PQ[d1] + PA_0 * PQ[b0] * QD_1)
                            + delta[a1][d0] * delta[b1][d1] * (PB_0 * PQ[a0] * QC_0 + PA_0 * PQ[b0] * QC_0)
                            + delta[a1][d1] * delta[b1][d0] * (PB_0 * PQ[a0] * QC_0 + PA_0 * PQ[b0] * QC_0)
                            + delta[a1][c0] * delta[b1][d1] * (PB_0 * PQ[a0] * QD_0 + PA_0 * PQ[b0] * QD_0)
                            + delta[a1][d1] * delta[b1][c0] * (PB_0 * PQ[a0] * QD_0 + PA_0 * PQ[b0] * QD_0)
                            + delta[a1][c0] * delta[b1][d0] * (PB_0 * PQ[a0] * QD_1 + PA_0 * PQ[b0] * QD_1)
                            + delta[a1][d0] * delta[b1][c0] * (PB_0 * PQ[a0] * QD_1 + PA_0 * PQ[b0] * QD_1)
                            + delta[a1][b0] * delta[d0][d1] * (PQ[a0] * PQ[b1] * PQ[c0] * (-1.0) + PQ[a0] * PQ[b1] * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[c0] + PB_1 * PQ[a0] * QC_0 + PA_0 * PQ[b1] * PQ[c0] + PA_0 * PQ[b1] * QC_0)
                            + delta[a1][b0] * delta[c0][d1] * (PQ[a0] * PQ[b1] * PQ[d0] * (-1.0) + PQ[a0] * PQ[b1] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[d0] + PB_1 * PQ[a0] * QD_0 + PA_0 * PQ[b1] * PQ[d0] + PA_0 * PQ[b1] * QD_0)
                            + delta[a1][b0] * delta[c0][d0] * (PQ[a0] * PQ[b1] * PQ[d1] * (-1.0) + PQ[a0] * PQ[b1] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[d1] + PB_1 * PQ[a0] * QD_1 + PA_0 * PQ[b1] * PQ[d1] + PA_0 * PQ[b1] * QD_1)
                            + delta[a1][d0] * delta[b0][d1] * (PB_1 * PQ[a0] * QC_0 + PA_0 * PQ[b1] * QC_0)
                            + delta[a1][d1] * delta[b0][d0] * (PB_1 * PQ[a0] * QC_0 + PA_0 * PQ[b1] * QC_0)
                            + delta[a1][c0] * delta[b0][d1] * (PB_1 * PQ[a0] * QD_0 + PA_0 * PQ[b1] * QD_0)
                            + delta[a1][d1] * delta[b0][c0] * (PB_1 * PQ[a0] * QD_0 + PA_0 * PQ[b1] * QD_0)
                            + delta[a1][c0] * delta[b0][d0] * (PB_1 * PQ[a0] * QD_1 + PA_0 * PQ[b1] * QD_1)
                            + delta[a1][d0] * delta[b0][c0] * (PB_1 * PQ[a0] * QD_1 + PA_0 * PQ[b1] * QD_1)
                            + delta[a1][d1] * delta[b0][b1] * (PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PQ[c0] * QD_0 + PA_0 * PQ[d0] * QC_0)
                            + delta[a1][b0] * delta[b1][d1] * (PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PQ[c0] * QD_0 + PA_0 * PQ[d0] * QC_0)
                            + delta[b0][d1] * delta[a1][b1] * (PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PQ[c0] * QD_0 + PA_0 * PQ[d0] * QC_0)
                            + delta[a1][d0] * delta[b0][b1] * (PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[c0] * QD_1 + PA_0 * PQ[d1] * QC_0)
                            + delta[a1][b0] * delta[b1][d0] * (PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[c0] * QD_1 + PA_0 * PQ[d1] * QC_0)
                            + delta[b0][d0] * delta[a1][b1] * (PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[c0] * QD_1 + PA_0 * PQ[d1] * QC_0)
                            + delta[a1][c0] * delta[b0][b1] * (PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[d0] * QD_1 + PA_0 * PQ[d1] * QD_0)
                            + delta[a1][b0] * delta[b1][c0] * (PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[d0] * QD_1 + PA_0 * PQ[d1] * QD_0)
                            + delta[b0][c0] * delta[a1][b1] * (PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[d0] * QD_1 + PA_0 * PQ[d1] * QD_0)
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * PQ[a1] * PQ[b1] + PB_1 * PQ[a1] * PQ[b0] + PA_1 * PQ[b0] * PQ[b1])
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * PQ[a1] * PQ[b1] + PB_1 * PQ[a1] * PQ[b0] + PA_1 * PQ[b0] * PQ[b1])
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * PQ[a1] * PQ[b1] + PB_1 * PQ[a1] * PQ[b0] + PA_1 * PQ[b0] * PQ[b1])
                            + delta[a0][b1] * delta[d0][d1] * (PQ[a1] * PQ[b0] * PQ[c0] * (-1.0) + PQ[a1] * PQ[b0] * QC_0 * (-1.0) + PB_0 * PQ[a1] * PQ[c0] + PB_0 * PQ[a1] * QC_0 + PA_1 * PQ[b0] * PQ[c0] + PA_1 * PQ[b0] * QC_0)
                            + delta[a0][b1] * delta[c0][d1] * (PQ[a1] * PQ[b0] * PQ[d0] * (-1.0) + PQ[a1] * PQ[b0] * QD_0 * (-1.0) + PB_0 * PQ[a1] * PQ[d0] + PB_0 * PQ[a1] * QD_0 + PA_1 * PQ[b0] * PQ[d0] + PA_1 * PQ[b0] * QD_0)
                            + delta[a0][b1] * delta[c0][d0] * (PQ[a1] * PQ[b0] * PQ[d1] * (-1.0) + PQ[a1] * PQ[b0] * QD_1 * (-1.0) + PB_0 * PQ[a1] * PQ[d1] + PB_0 * PQ[a1] * QD_1 + PA_1 * PQ[b0] * PQ[d1] + PA_1 * PQ[b0] * QD_1)
                            + delta[a0][d0] * delta[b1][d1] * (PB_0 * PQ[a1] * QC_0 + PA_1 * PQ[b0] * QC_0)
                            + delta[a0][d1] * delta[b1][d0] * (PB_0 * PQ[a1] * QC_0 + PA_1 * PQ[b0] * QC_0)
                            + delta[a0][c0] * delta[b1][d1] * (PB_0 * PQ[a1] * QD_0 + PA_1 * PQ[b0] * QD_0)
                            + delta[a0][d1] * delta[b1][c0] * (PB_0 * PQ[a1] * QD_0 + PA_1 * PQ[b0] * QD_0)
                            + delta[a0][c0] * delta[b1][d0] * (PB_0 * PQ[a1] * QD_1 + PA_1 * PQ[b0] * QD_1)
                            + delta[a0][d0] * delta[b1][c0] * (PB_0 * PQ[a1] * QD_1 + PA_1 * PQ[b0] * QD_1)
                            + delta[a0][b0] * delta[d0][d1] * (PQ[a1] * PQ[b1] * PQ[c0] * (-1.0) + PQ[a1] * PQ[b1] * QC_0 * (-1.0) + PB_1 * PQ[a1] * PQ[c0] + PB_1 * PQ[a1] * QC_0 + PA_1 * PQ[b1] * PQ[c0] + PA_1 * PQ[b1] * QC_0)
                            + delta[a0][b0] * delta[c0][d1] * (PQ[a1] * PQ[b1] * PQ[d0] * (-1.0) + PQ[a1] * PQ[b1] * QD_0 * (-1.0) + PB_1 * PQ[a1] * PQ[d0] + PB_1 * PQ[a1] * QD_0 + PA_1 * PQ[b1] * PQ[d0] + PA_1 * PQ[b1] * QD_0)
                            + delta[a0][b0] * delta[c0][d0] * (PQ[a1] * PQ[b1] * PQ[d1] * (-1.0) + PQ[a1] * PQ[b1] * QD_1 * (-1.0) + PB_1 * PQ[a1] * PQ[d1] + PB_1 * PQ[a1] * QD_1 + PA_1 * PQ[b1] * PQ[d1] + PA_1 * PQ[b1] * QD_1)
                            + delta[a0][d0] * delta[b0][d1] * (PB_1 * PQ[a1] * QC_0 + PA_1 * PQ[b1] * QC_0)
                            + delta[a0][d1] * delta[b0][d0] * (PB_1 * PQ[a1] * QC_0 + PA_1 * PQ[b1] * QC_0)
                            + delta[a0][c0] * delta[b0][d1] * (PB_1 * PQ[a1] * QD_0 + PA_1 * PQ[b1] * QD_0)
                            + delta[a0][d1] * delta[b0][c0] * (PB_1 * PQ[a1] * QD_0 + PA_1 * PQ[b1] * QD_0)
                            + delta[a0][c0] * delta[b0][d0] * (PB_1 * PQ[a1] * QD_1 + PA_1 * PQ[b1] * QD_1)
                            + delta[a0][d0] * delta[b0][c0] * (PB_1 * PQ[a1] * QD_1 + PA_1 * PQ[b1] * QD_1)
                            + delta[a0][d1] * delta[b0][b1] * (PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PQ[a1] * PQ[d0] * QC_0 * (-1.0) + PA_1 * PQ[c0] * QD_0 + PA_1 * PQ[d0] * QC_0)
                            + delta[a0][b0] * delta[b1][d1] * (PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PQ[a1] * PQ[d0] * QC_0 * (-1.0) + PA_1 * PQ[c0] * QD_0 + PA_1 * PQ[d0] * QC_0)
                            + delta[b0][d1] * delta[a0][b1] * (PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PQ[a1] * PQ[d0] * QC_0 * (-1.0) + PA_1 * PQ[c0] * QD_0 + PA_1 * PQ[d0] * QC_0)
                            + delta[a0][d0] * delta[b0][b1] * (PQ[a1] * PQ[c0] * QD_1 * (-1.0) + PQ[a1] * PQ[d1] * QC_0 * (-1.0) + PA_1 * PQ[c0] * QD_1 + PA_1 * PQ[d1] * QC_0)
                            + delta[a0][b0] * delta[b1][d0] * (PQ[a1] * PQ[c0] * QD_1 * (-1.0) + PQ[a1] * PQ[d1] * QC_0 * (-1.0) + PA_1 * PQ[c0] * QD_1 + PA_1 * PQ[d1] * QC_0)
                            + delta[b0][d0] * delta[a0][b1] * (PQ[a1] * PQ[c0] * QD_1 * (-1.0) + PQ[a1] * PQ[d1] * QC_0 * (-1.0) + PA_1 * PQ[c0] * QD_1 + PA_1 * PQ[d1] * QC_0)
                            + delta[a0][c0] * delta[b0][b1] * (PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PQ[a1] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[d0] * QD_1 + PA_1 * PQ[d1] * QD_0)
                            + delta[a0][b0] * delta[b1][c0] * (PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PQ[a1] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[d0] * QD_1 + PA_1 * PQ[d1] * QD_0)
                            + delta[b0][c0] * delta[a0][b1] * (PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PQ[a1] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[d0] * QD_1 + PA_1 * PQ[d1] * QD_0)
                            + delta[a0][d0] * delta[a1][d1] * (PB_0 * PQ[b1] * QC_0 + PB_1 * PQ[b0] * QC_0)
                            + delta[a0][d1] * delta[a1][d0] * (PB_0 * PQ[b1] * QC_0 + PB_1 * PQ[b0] * QC_0)
                            + delta[a0][a1] * delta[d0][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * (-1.0) + PQ[b0] * PQ[b1] * QC_0 * (-1.0) + PB_0 * PQ[b1] * PQ[c0] + PB_0 * PQ[b1] * QC_0 + PB_1 * PQ[b0] * PQ[c0] + PB_1 * PQ[b0] * QC_0)
                            + delta[a0][d1] * delta[a1][b1] * (PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PQ[c0] * QD_0 + PB_0 * PQ[d0] * QC_0)
                            + delta[a0][a1] * delta[b1][d1] * (PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PQ[c0] * QD_0 + PB_0 * PQ[d0] * QC_0)
                            + delta[a1][d1] * delta[a0][b1] * (PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PQ[c0] * QD_0 + PB_0 * PQ[d0] * QC_0)
                            + delta[a0][d0] * delta[a1][b1] * (PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PQ[b0] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PQ[c0] * QD_1 + PB_0 * PQ[d1] * QC_0)
                            + delta[a0][a1] * delta[b1][d0] * (PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PQ[b0] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PQ[c0] * QD_1 + PB_0 * PQ[d1] * QC_0)
                            + delta[a1][d0] * delta[a0][b1] * (PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PQ[b0] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PQ[c0] * QD_1 + PB_0 * PQ[d1] * QC_0)
                            + delta[a0][d1] * delta[a1][b0] * (PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PQ[c0] * QD_0 + PB_1 * PQ[d0] * QC_0)
                            + delta[a0][a1] * delta[b0][d1] * (PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PQ[c0] * QD_0 + PB_1 * PQ[d0] * QC_0)
                            + delta[a1][d1] * delta[a0][b0] * (PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PQ[c0] * QD_0 + PB_1 * PQ[d0] * QC_0)
                            + delta[a0][d0] * delta[a1][b0] * (PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PQ[c0] * QD_1 + PB_1 * PQ[d1] * QC_0)
                            + delta[a0][a1] * delta[b0][d0] * (PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PQ[c0] * QD_1 + PB_1 * PQ[d1] * QC_0)
                            + delta[a1][d0] * delta[a0][b0] * (PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PQ[c0] * QD_1 + PB_1 * PQ[d1] * QC_0)
                            + delta[a0][a1] * delta[c0][d1] * (PQ[b0] * PQ[b1] * PQ[d0] * (-1.0) + PQ[b0] * PQ[b1] * QD_0 * (-1.0) + PB_0 * PQ[b1] * PQ[d0] + PB_0 * PQ[b1] * QD_0 + PB_1 * PQ[b0] * PQ[d0] + PB_1 * PQ[b0] * QD_0)
                            + delta[a0][a1] * delta[c0][d0] * (PQ[b0] * PQ[b1] * PQ[d1] * (-1.0) + PQ[b0] * PQ[b1] * QD_1 * (-1.0) + PB_0 * PQ[b1] * PQ[d1] + PB_0 * PQ[b1] * QD_1 + PB_1 * PQ[b0] * PQ[d1] + PB_1 * PQ[b0] * QD_1)
                            + delta[a0][c0] * delta[a1][b1] * (PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[d0] * QD_1 + PB_0 * PQ[d1] * QD_0)
                            + delta[a0][a1] * delta[b1][c0] * (PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[d0] * QD_1 + PB_0 * PQ[d1] * QD_0)
                            + delta[a1][c0] * delta[a0][b1] * (PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[d0] * QD_1 + PB_0 * PQ[d1] * QD_0)
                            + delta[a0][c0] * delta[a1][b0] * (PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[d0] * QD_1 + PB_1 * PQ[d1] * QD_0)
                            + delta[a0][a1] * delta[b0][c0] * (PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[d0] * QD_1 + PB_1 * PQ[d1] * QD_0)
                            + delta[a1][c0] * delta[a0][b0] * (PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[d0] * QD_1 + PB_1 * PQ[d1] * QD_0)
                            + delta[a0][a1] * delta[b0][b1] * (PQ[c0] * PQ[d0] * QD_1 * (-2.0) + PQ[c0] * PQ[d1] * QD_0 * (-2.0) + PQ[d0] * PQ[d1] * QC_0 * (-2.0))
                            + delta[a0][b0] * delta[a1][b1] * (PQ[c0] * PQ[d0] * QD_1 * (-2.0) + PQ[c0] * PQ[d1] * QD_0 * (-2.0) + PQ[d0] * PQ[d1] * QC_0 * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * (PQ[c0] * PQ[d0] * QD_1 * (-2.0) + PQ[c0] * PQ[d1] * QD_0 * (-2.0) + PQ[d0] * PQ[d1] * QC_0 * (-2.0))
                            + delta[a0][c0] * delta[a1][d1] * (PB_0 * PQ[b1] * QD_0 + PB_1 * PQ[b0] * QD_0)
                            + delta[a0][d1] * delta[a1][c0] * (PB_0 * PQ[b1] * QD_0 + PB_1 * PQ[b0] * QD_0)
                            + delta[a0][c0] * delta[a1][d0] * (PB_0 * PQ[b1] * QD_1 + PB_1 * PQ[b0] * QD_1)
                            + delta[a0][d0] * delta[a1][c0] * (PB_0 * PQ[b1] * QD_1 + PB_1 * PQ[b0] * QD_1)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDPD11(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[4];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[3] * (

                        0.5 * ( S1 * S1 ) / ( S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0])
                            + delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d0] + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d0] + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d0] + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d0])
                            + delta[c0][d0] * (PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d1] + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d1] + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d1] + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d1])
                            + delta[b1][d1] * (PB_0 * PA_0 * PA_1 * PQ[c0] * PQ[d0])
                            + delta[b1][d0] * (PB_0 * PA_0 * PA_1 * PQ[c0] * PQ[d1])
                            + delta[b1][c0] * (PB_0 * PA_0 * PA_1 * PQ[d0] * PQ[d1])
                            + delta[b0][d1] * (PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[d0])
                            + delta[b0][d0] * (PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[d1])
                            + delta[b0][c0] * (PB_1 * PA_0 * PA_1 * PQ[d0] * PQ[d1])
                            + delta[b0][b1] * (PA_0 * PA_1 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][d1] * (PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[d0])
                            + delta[a1][d0] * (PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[d1])
                            + delta[a1][c0] * (PB_0 * PB_1 * PA_0 * PQ[d0] * PQ[d1])
                            + delta[a1][b1] * (PB_0 * PA_0 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][b0] * (PB_1 * PA_0 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][d1] * (PB_0 * PB_1 * PA_1 * PQ[c0] * PQ[d0])
                            + delta[a0][d0] * (PB_0 * PB_1 * PA_1 * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * (PB_0 * PB_1 * PA_1 * PQ[d0] * PQ[d1])
                            + delta[a0][b1] * (PB_0 * PA_1 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * (PB_1 * PA_1 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * (PB_0 * PB_1 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDPD12(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[4];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[3] * (

                        0.5 * ( S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[a1] * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[a1] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * QD_0 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * QD_0 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * QD_0 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[c0][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d1] * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[a1] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d1] * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d1] * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d1] * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[b1][d1] * (PB_0 * PA_0 * PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[b1][d0] * (PB_0 * PA_0 * PQ[a1] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[b1][c0] * (PB_0 * PA_0 * PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][d1] * (PB_1 * PA_0 * PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][d0] * (PB_1 * PA_0 * PQ[a1] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][c0] * (PB_1 * PA_0 * PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][b1] * (PA_0 * PA_1 * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PA_1 * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[c0] * PQ[d0] * QD_1 + PA_0 * PQ[a1] * PQ[c0] * PQ[d1] * QD_0 + PA_0 * PQ[a1] * PQ[d0] * PQ[d1] * QC_0 + PA_1 * PQ[a0] * PQ[c0] * PQ[d0] * QD_1 + PA_1 * PQ[a0] * PQ[c0] * PQ[d1] * QD_0 + PA_1 * PQ[a0] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a1][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][c0] * (PB_0 * PB_1 * PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][b1] * (PB_0 * PA_0 * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PQ[a0] * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PQ[a0] * PQ[d0] * PQ[d1] * QC_0 + PA_0 * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 + PA_0 * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 + PA_0 * PQ[b0] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a1][b0] * (PB_1 * PA_0 * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[c0] * PQ[d0] * QD_1 + PB_1 * PQ[a0] * PQ[c0] * PQ[d1] * QD_0 + PB_1 * PQ[a0] * PQ[d0] * PQ[d1] * QC_0 + PA_0 * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 + PA_0 * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 + PA_0 * PQ[b1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][d1] * (PB_0 * PB_1 * PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PB_1 * PQ[a1] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d0] * (PB_0 * PB_1 * PQ[a1] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[a1] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][c0] * (PB_0 * PB_1 * PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[a1] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][b1] * (PB_0 * PA_1 * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PA_1 * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PQ[a1] * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PQ[a1] * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PQ[a1] * PQ[d0] * PQ[d1] * QC_0 + PA_1 * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 + PA_1 * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 + PA_1 * PQ[b0] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][b0] * (PB_1 * PA_1 * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PA_1 * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PQ[a1] * PQ[c0] * PQ[d0] * QD_1 + PB_1 * PQ[a1] * PQ[c0] * PQ[d1] * QD_0 + PB_1 * PQ[a1] * PQ[d0] * PQ[d1] * QC_0 + PA_1 * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 + PA_1 * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 + PA_1 * PQ[b1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][a1] * (PB_0 * PB_1 * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PB_1 * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 + PB_1 * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 + PB_1 * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 + PB_1 * PQ[b0] * PQ[d0] * PQ[d1] * QC_0)
                        )

                    )

                    +

                    F7_t[3] * (

                        0.5 * ( S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * QC_0 + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * QC_0 + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * QC_0 + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * QC_0)
                            + delta[c0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * QD_0 + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * QD_0 + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * QD_0 + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * QD_0)
                            + delta[c0][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * QD_1 + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * QD_1 + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * QD_1 + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * QD_1)
                            + delta[b1][d1] * (PB_0 * PQ[a0] * PQ[a1] * QD_0 * QC_0 + PA_0 * PQ[a1] * PQ[b0] * QD_0 * QC_0 + PA_1 * PQ[a0] * PQ[b0] * QD_0 * QC_0)
                            + delta[b1][d0] * (PB_0 * PQ[a0] * PQ[a1] * QD_1 * QC_0 + PA_0 * PQ[a1] * PQ[b0] * QD_1 * QC_0 + PA_1 * PQ[a0] * PQ[b0] * QD_1 * QC_0)
                            + delta[b1][c0] * (PB_0 * PQ[a0] * PQ[a1] * QD_0 * QD_1 + PA_0 * PQ[a1] * PQ[b0] * QD_0 * QD_1 + PA_1 * PQ[a0] * PQ[b0] * QD_0 * QD_1)
                            + delta[b0][d1] * (PB_1 * PQ[a0] * PQ[a1] * QD_0 * QC_0 + PA_0 * PQ[a1] * PQ[b1] * QD_0 * QC_0 + PA_1 * PQ[a0] * PQ[b1] * QD_0 * QC_0)
                            + delta[b0][d0] * (PB_1 * PQ[a0] * PQ[a1] * QD_1 * QC_0 + PA_0 * PQ[a1] * PQ[b1] * QD_1 * QC_0 + PA_1 * PQ[a0] * PQ[b1] * QD_1 * QC_0)
                            + delta[b0][c0] * (PB_1 * PQ[a0] * PQ[a1] * QD_0 * QD_1 + PA_0 * PQ[a1] * PQ[b1] * QD_0 * QD_1 + PA_1 * PQ[a0] * PQ[b1] * QD_0 * QD_1)
                            + delta[b0][b1] * (PQ[a0] * PQ[a1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[c0] * QD_0 * QD_1 + PA_0 * PQ[a1] * PQ[d0] * QD_1 * QC_0 + PA_0 * PQ[a1] * PQ[d1] * QD_0 * QC_0 + PA_1 * PQ[a0] * PQ[c0] * QD_0 * QD_1 + PA_1 * PQ[a0] * PQ[d0] * QD_1 * QC_0 + PA_1 * PQ[a0] * PQ[d1] * QD_0 * QC_0)
                            + delta[a1][d1] * (PB_0 * PQ[a0] * PQ[b1] * QD_0 * QC_0 + PB_1 * PQ[a0] * PQ[b0] * QD_0 * QC_0 + PA_0 * PQ[b0] * PQ[b1] * QD_0 * QC_0)
                            + delta[a1][d0] * (PB_0 * PQ[a0] * PQ[b1] * QD_1 * QC_0 + PB_1 * PQ[a0] * PQ[b0] * QD_1 * QC_0 + PA_0 * PQ[b0] * PQ[b1] * QD_1 * QC_0)
                            + delta[a1][c0] * (PB_0 * PQ[a0] * PQ[b1] * QD_0 * QD_1 + PB_1 * PQ[a0] * PQ[b0] * QD_0 * QD_1 + PA_0 * PQ[b0] * PQ[b1] * QD_0 * QD_1)
                            + delta[a1][b1] * (PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[c0] * QD_0 * QD_1 + PB_0 * PQ[a0] * PQ[d0] * QD_1 * QC_0 + PB_0 * PQ[a0] * PQ[d1] * QD_0 * QC_0 + PA_0 * PQ[b0] * PQ[c0] * QD_0 * QD_1 + PA_0 * PQ[b0] * PQ[d0] * QD_1 * QC_0 + PA_0 * PQ[b0] * PQ[d1] * QD_0 * QC_0)
                            + delta[a1][b0] * (PQ[a0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[c0] * QD_0 * QD_1 + PB_1 * PQ[a0] * PQ[d0] * QD_1 * QC_0 + PB_1 * PQ[a0] * PQ[d1] * QD_0 * QC_0 + PA_0 * PQ[b1] * PQ[c0] * QD_0 * QD_1 + PA_0 * PQ[b1] * PQ[d0] * QD_1 * QC_0 + PA_0 * PQ[b1] * PQ[d1] * QD_0 * QC_0)
                            + delta[a0][d1] * (PB_0 * PQ[a1] * PQ[b1] * QD_0 * QC_0 + PB_1 * PQ[a1] * PQ[b0] * QD_0 * QC_0 + PA_1 * PQ[b0] * PQ[b1] * QD_0 * QC_0)
                            + delta[a0][d0] * (PB_0 * PQ[a1] * PQ[b1] * QD_1 * QC_0 + PB_1 * PQ[a1] * PQ[b0] * QD_1 * QC_0 + PA_1 * PQ[b0] * PQ[b1] * QD_1 * QC_0)
                            + delta[a0][c0] * (PB_0 * PQ[a1] * PQ[b1] * QD_0 * QD_1 + PB_1 * PQ[a1] * PQ[b0] * QD_0 * QD_1 + PA_1 * PQ[b0] * PQ[b1] * QD_0 * QD_1)
                            + delta[a0][b1] * (PQ[a1] * PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[a1] * PQ[c0] * QD_0 * QD_1 + PB_0 * PQ[a1] * PQ[d0] * QD_1 * QC_0 + PB_0 * PQ[a1] * PQ[d1] * QD_0 * QC_0 + PA_1 * PQ[b0] * PQ[c0] * QD_0 * QD_1 + PA_1 * PQ[b0] * PQ[d0] * QD_1 * QC_0 + PA_1 * PQ[b0] * PQ[d1] * QD_0 * QC_0)
                            + delta[a0][b0] * (PQ[a1] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[a1] * PQ[c0] * QD_0 * QD_1 + PB_1 * PQ[a1] * PQ[d0] * QD_1 * QC_0 + PB_1 * PQ[a1] * PQ[d1] * QD_0 * QC_0 + PA_1 * PQ[b1] * PQ[c0] * QD_0 * QD_1 + PA_1 * PQ[b1] * PQ[d0] * QD_1 * QC_0 + PA_1 * PQ[b1] * PQ[d1] * QD_0 * QC_0)
                            + delta[a0][a1] * (PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[b1] * PQ[c0] * QD_0 * QD_1 + PB_0 * PQ[b1] * PQ[d0] * QD_1 * QC_0 + PB_0 * PQ[b1] * PQ[d1] * QD_0 * QC_0 + PB_1 * PQ[b0] * PQ[c0] * QD_0 * QD_1 + PB_1 * PQ[b0] * PQ[d0] * QD_1 * QC_0 + PB_1 * PQ[b0] * PQ[d1] * QD_0 * QC_0)
                        )

                    )

                    +

                    F7_t[3] * (

                        0.5 * ( S2 * S2 * S2 ) / ( S1 * S4 * S4 * S4 ) * (
                            delta[b0][b1] * (PQ[a0] * PQ[a1] * QD_0 * QD_1 * QC_0 * (-1.0))
                            + delta[a1][b1] * (PQ[a0] * PQ[b0] * QD_0 * QD_1 * QC_0 * (-1.0))
                            + delta[a1][b0] * (PQ[a0] * PQ[b1] * QD_0 * QD_1 * QC_0 * (-1.0))
                            + delta[a0][b1] * (PQ[a1] * PQ[b0] * QD_0 * QD_1 * QC_0 * (-1.0))
                            + delta[a0][b0] * (PQ[a1] * PQ[b1] * QD_0 * QD_1 * QC_0 * (-1.0))
                            + delta[a0][a1] * (PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_0 * (-1.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDPD13(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[5];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[4] * (

                        ( S1 * S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                        )

                    )

                    +

                    F7_t[4] * (

                        ( S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0] * QD_1
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[d1] * QD_0
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * PQ[d1] * QC_0
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * QD_1
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d1] * QD_0
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1] * QC_0
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * QD_1
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1] * QD_0
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1] * QC_0
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0
                        )

                    )

                    +

                    F7_t[4] * (

                        ( S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                        )

                    )

                    +

                    F7_t[4] * (

                        ( S2 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_0
                        )

                    )

                    +

                    F7_t[4] * (

                        0.25 * ( S1 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[b1][c0] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[a1] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * (-1.0))
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[a1] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * (-1.0))
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * PQ[a0] * PQ[a1] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * (-1.0))
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * PQ[a0] * PQ[a1] * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * (-1.0))
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * PQ[a0] * PQ[a1] * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * (-1.0))
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * PQ[a0] * PQ[a1] * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * (-1.0))
                            + delta[b0][b1] * delta[d0][d1] * (PA_0 * PQ[a1] * PQ[c0] * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * (-1.0) + PQ[a0] * PQ[a1] * PQ[c0])
                            + delta[b0][d0] * delta[b1][d1] * (PA_0 * PQ[a1] * PQ[c0] * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * (-1.0))
                            + delta[b0][d1] * delta[b1][d0] * (PA_0 * PQ[a1] * PQ[c0] * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * (-1.0))
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * PQ[a1] * PQ[d0] * (-1.0) + PA_1 * PQ[a0] * PQ[d0] * (-1.0) + PQ[a0] * PQ[a1] * PQ[d0])
                            + delta[b0][c0] * delta[b1][d1] * (PA_0 * PQ[a1] * PQ[d0] * (-1.0) + PA_1 * PQ[a0] * PQ[d0] * (-1.0))
                            + delta[b0][d1] * delta[b1][c0] * (PA_0 * PQ[a1] * PQ[d0] * (-1.0) + PA_1 * PQ[a0] * PQ[d0] * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * PQ[a1] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[a1] * PQ[d1])
                            + delta[b0][c0] * delta[b1][d0] * (PA_0 * PQ[a1] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[d1] * (-1.0))
                            + delta[b0][d0] * delta[b1][c0] * (PA_0 * PQ[a1] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[d1] * (-1.0))
                            + delta[a1][c0] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[b1] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[b1] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a1][d1] * delta[c0][d0] * (PB_0 * PQ[a0] * PQ[b1] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a1][d0] * delta[b1][d1] * (PB_0 * PQ[a0] * PQ[c0] * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a1][d1] * delta[b1][d0] * (PB_0 * PQ[a0] * PQ[c0] * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a1][b1] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[c0] * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * (-1.0) + PQ[a0] * PQ[b0] * PQ[c0])
                            + delta[a1][c0] * delta[b1][d1] * (PB_0 * PQ[a0] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a1][d1] * delta[b1][c0] * (PB_0 * PQ[a0] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a1][b1] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * (-1.0) + PQ[a0] * PQ[b0] * PQ[d0])
                            + delta[a1][c0] * delta[b1][d0] * (PB_0 * PQ[a0] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a1][d0] * delta[b1][c0] * (PB_0 * PQ[a0] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a1][b1] * delta[c0][d0] * (PB_0 * PQ[a0] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[b0] * PQ[d1])
                            + delta[a1][d0] * delta[b0][d1] * (PB_1 * PQ[a0] * PQ[c0] * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a1][d1] * delta[b0][d0] * (PB_1 * PQ[a0] * PQ[c0] * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a1][b0] * delta[d0][d1] * (PB_1 * PQ[a0] * PQ[c0] * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * (-1.0) + PQ[a0] * PQ[b1] * PQ[c0])
                            + delta[a1][c0] * delta[b0][d1] * (PB_1 * PQ[a0] * PQ[d0] * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a1][d1] * delta[b0][c0] * (PB_1 * PQ[a0] * PQ[d0] * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a1][b0] * delta[c0][d1] * (PB_1 * PQ[a0] * PQ[d0] * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * (-1.0) + PQ[a0] * PQ[b1] * PQ[d0])
                            + delta[a1][c0] * delta[b0][d0] * (PB_1 * PQ[a0] * PQ[d1] * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a1][d0] * delta[b0][c0] * (PB_1 * PQ[a0] * PQ[d1] * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a1][b0] * delta[c0][d0] * (PB_1 * PQ[a0] * PQ[d1] * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * (-1.0) + PQ[a0] * PQ[b1] * PQ[d1])
                            + delta[a1][d1] * delta[b0][b1] * (PA_0 * PQ[c0] * PQ[d0] * (-1.0) + PQ[a0] * PQ[c0] * PQ[d0])
                            + delta[a1][b0] * delta[b1][d1] * (PA_0 * PQ[c0] * PQ[d0] * (-1.0) + PQ[a0] * PQ[c0] * PQ[d0])
                            + delta[b0][d1] * delta[a1][b1] * (PA_0 * PQ[c0] * PQ[d0] * (-1.0) + PQ[a0] * PQ[c0] * PQ[d0])
                            + delta[a1][d0] * delta[b0][b1] * (PA_0 * PQ[c0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[c0] * PQ[d1])
                            + delta[a1][b0] * delta[b1][d0] * (PA_0 * PQ[c0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[c0] * PQ[d1])
                            + delta[b0][d0] * delta[a1][b1] * (PA_0 * PQ[c0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[c0] * PQ[d1])
                            + delta[a1][c0] * delta[b0][b1] * (PA_0 * PQ[d0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[d0] * PQ[d1])
                            + delta[a1][b0] * delta[b1][c0] * (PA_0 * PQ[d0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[d0] * PQ[d1])
                            + delta[b0][c0] * delta[a1][b1] * (PA_0 * PQ[d0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[d0] * PQ[d1])
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * PQ[a1] * PQ[b1] * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * PQ[a1] * PQ[b1] * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * PQ[a1] * PQ[b1] * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][d0] * delta[b1][d1] * (PB_0 * PQ[a1] * PQ[c0] * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[b1][d0] * (PB_0 * PQ[a1] * PQ[c0] * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PQ[a1] * PQ[c0] * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * (-1.0) + PQ[a1] * PQ[b0] * PQ[c0])
                            + delta[a0][c0] * delta[b1][d1] * (PB_0 * PQ[a1] * PQ[d0] * (-1.0) + PA_1 * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[b1][c0] * (PB_0 * PQ[a1] * PQ[d0] * (-1.0) + PA_1 * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * PQ[a1] * PQ[d0] * (-1.0) + PA_1 * PQ[b0] * PQ[d0] * (-1.0) + PQ[a1] * PQ[b0] * PQ[d0])
                            + delta[a0][c0] * delta[b1][d0] * (PB_0 * PQ[a1] * PQ[d1] * (-1.0) + PA_1 * PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[b1][c0] * (PB_0 * PQ[a1] * PQ[d1] * (-1.0) + PA_1 * PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PQ[a1] * PQ[d1] * (-1.0) + PA_1 * PQ[b0] * PQ[d1] * (-1.0) + PQ[a1] * PQ[b0] * PQ[d1])
                            + delta[a0][d0] * delta[b0][d1] * (PB_1 * PQ[a1] * PQ[c0] * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * (PB_1 * PQ[a1] * PQ[c0] * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PQ[a1] * PQ[c0] * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * (-1.0) + PQ[a1] * PQ[b1] * PQ[c0])
                            + delta[a0][c0] * delta[b0][d1] * (PB_1 * PQ[a1] * PQ[d0] * (-1.0) + PA_1 * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[b0][c0] * (PB_1 * PQ[a1] * PQ[d0] * (-1.0) + PA_1 * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * PQ[a1] * PQ[d0] * (-1.0) + PA_1 * PQ[b1] * PQ[d0] * (-1.0) + PQ[a1] * PQ[b1] * PQ[d0])
                            + delta[a0][c0] * delta[b0][d0] * (PB_1 * PQ[a1] * PQ[d1] * (-1.0) + PA_1 * PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[b0][c0] * (PB_1 * PQ[a1] * PQ[d1] * (-1.0) + PA_1 * PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PQ[a1] * PQ[d1] * (-1.0) + PA_1 * PQ[b1] * PQ[d1] * (-1.0) + PQ[a1] * PQ[b1] * PQ[d1])
                            + delta[a0][d1] * delta[b0][b1] * (PA_1 * PQ[c0] * PQ[d0] * (-1.0) + PQ[a1] * PQ[c0] * PQ[d0])
                            + delta[a0][b0] * delta[b1][d1] * (PA_1 * PQ[c0] * PQ[d0] * (-1.0) + PQ[a1] * PQ[c0] * PQ[d0])
                            + delta[b0][d1] * delta[a0][b1] * (PA_1 * PQ[c0] * PQ[d0] * (-1.0) + PQ[a1] * PQ[c0] * PQ[d0])
                            + delta[a0][d0] * delta[b0][b1] * (PA_1 * PQ[c0] * PQ[d1] * (-1.0) + PQ[a1] * PQ[c0] * PQ[d1])
                            + delta[a0][b0] * delta[b1][d0] * (PA_1 * PQ[c0] * PQ[d1] * (-1.0) + PQ[a1] * PQ[c0] * PQ[d1])
                            + delta[b0][d0] * delta[a0][b1] * (PA_1 * PQ[c0] * PQ[d1] * (-1.0) + PQ[a1] * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * delta[b0][b1] * (PA_1 * PQ[d0] * PQ[d1] * (-1.0) + PQ[a1] * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * delta[b1][c0] * (PA_1 * PQ[d0] * PQ[d1] * (-1.0) + PQ[a1] * PQ[d0] * PQ[d1])
                            + delta[b0][c0] * delta[a0][b1] * (PA_1 * PQ[d0] * PQ[d1] * (-1.0) + PQ[a1] * PQ[d0] * PQ[d1])
                            + delta[a0][d0] * delta[a1][d1] * (PB_0 * PQ[b1] * PQ[c0] * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[a1][d0] * (PB_0 * PQ[b1] * PQ[c0] * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a0][a1] * delta[d0][d1] * (PB_0 * PQ[b1] * PQ[c0] * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * (-1.0) + PQ[b0] * PQ[b1] * PQ[c0])
                            + delta[a0][c0] * delta[a1][d1] * (PB_0 * PQ[b1] * PQ[d0] * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[a1][c0] * (PB_0 * PQ[b1] * PQ[d0] * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[c0][d1] * (PB_0 * PQ[b1] * PQ[d0] * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * (-1.0) + PQ[b0] * PQ[b1] * PQ[d0])
                            + delta[a0][c0] * delta[a1][d0] * (PB_0 * PQ[b1] * PQ[d1] * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[a1][c0] * (PB_0 * PQ[b1] * PQ[d1] * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[c0][d0] * (PB_0 * PQ[b1] * PQ[d1] * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * (-1.0) + PQ[b0] * PQ[b1] * PQ[d1])
                            + delta[a0][d1] * delta[a1][b1] * (PB_0 * PQ[c0] * PQ[d0] * (-1.0) + PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a0][a1] * delta[b1][d1] * (PB_0 * PQ[c0] * PQ[d0] * (-1.0) + PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a1][d1] * delta[a0][b1] * (PB_0 * PQ[c0] * PQ[d0] * (-1.0) + PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a0][d0] * delta[a1][b1] * (PB_0 * PQ[c0] * PQ[d1] * (-1.0) + PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[a0][a1] * delta[b1][d0] * (PB_0 * PQ[c0] * PQ[d1] * (-1.0) + PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[a1][d0] * delta[a0][b1] * (PB_0 * PQ[c0] * PQ[d1] * (-1.0) + PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * delta[a1][b1] * (PB_0 * PQ[d0] * PQ[d1] * (-1.0) + PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a0][a1] * delta[b1][c0] * (PB_0 * PQ[d0] * PQ[d1] * (-1.0) + PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a1][c0] * delta[a0][b1] * (PB_0 * PQ[d0] * PQ[d1] * (-1.0) + PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * delta[a1][b0] * (PB_1 * PQ[c0] * PQ[d0] * (-1.0) + PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a0][a1] * delta[b0][d1] * (PB_1 * PQ[c0] * PQ[d0] * (-1.0) + PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a1][d1] * delta[a0][b0] * (PB_1 * PQ[c0] * PQ[d0] * (-1.0) + PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a0][d0] * delta[a1][b0] * (PB_1 * PQ[c0] * PQ[d1] * (-1.0) + PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[a0][a1] * delta[b0][d0] * (PB_1 * PQ[c0] * PQ[d1] * (-1.0) + PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[a1][d0] * delta[a0][b0] * (PB_1 * PQ[c0] * PQ[d1] * (-1.0) + PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * delta[a1][b0] * (PB_1 * PQ[d0] * PQ[d1] * (-1.0) + PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a0][a1] * delta[b0][c0] * (PB_1 * PQ[d0] * PQ[d1] * (-1.0) + PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a1][c0] * delta[a0][b0] * (PB_1 * PQ[d0] * PQ[d1] * (-1.0) + PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a0][a1] * delta[b0][b1] * (PQ[c0] * PQ[d0] * PQ[d1] * 2.0)
                            + delta[a0][b0] * delta[a1][b1] * (PQ[c0] * PQ[d0] * PQ[d1] * 2.0)
                            + delta[a1][b0] * delta[a0][b1] * (PQ[c0] * PQ[d0] * PQ[d1] * 2.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDPD14(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[5];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[4] * (

                        0.25 * ( S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[c0] + PQ[a0] * PQ[a1] * QC_0)
                            + delta[b0][d0] * delta[b1][d1] * (PQ[a0] * PQ[a1] * QC_0)
                            + delta[b0][d1] * delta[b1][d0] * (PQ[a0] * PQ[a1] * QC_0)
                            + delta[a1][d0] * delta[b1][d1] * (PQ[a0] * PQ[b0] * QC_0)
                            + delta[a1][d1] * delta[b1][d0] * (PQ[a0] * PQ[b0] * QC_0)
                            + delta[a1][b1] * delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[c0] + PQ[a0] * PQ[b0] * QC_0)
                            + delta[a1][d0] * delta[b0][d1] * (PQ[a0] * PQ[b1] * QC_0)
                            + delta[a1][d1] * delta[b0][d0] * (PQ[a0] * PQ[b1] * QC_0)
                            + delta[a1][b0] * delta[d0][d1] * (PQ[a0] * PQ[b1] * PQ[c0] + PQ[a0] * PQ[b1] * QC_0)
                            + delta[a1][d1] * delta[b0][b1] * (PQ[a0] * PQ[c0] * QD_0 + PQ[a0] * PQ[d0] * QC_0)
                            + delta[a1][b0] * delta[b1][d1] * (PQ[a0] * PQ[c0] * QD_0 + PQ[a0] * PQ[d0] * QC_0)
                            + delta[b0][d1] * delta[a1][b1] * (PQ[a0] * PQ[c0] * QD_0 + PQ[a0] * PQ[d0] * QC_0)
                            + delta[a1][d0] * delta[b0][b1] * (PQ[a0] * PQ[c0] * QD_1 + PQ[a0] * PQ[d1] * QC_0)
                            + delta[a1][b0] * delta[b1][d0] * (PQ[a0] * PQ[c0] * QD_1 + PQ[a0] * PQ[d1] * QC_0)
                            + delta[b0][d0] * delta[a1][b1] * (PQ[a0] * PQ[c0] * QD_1 + PQ[a0] * PQ[d1] * QC_0)
                            + delta[a0][d0] * delta[b1][d1] * (PQ[a1] * PQ[b0] * QC_0)
                            + delta[a0][d1] * delta[b1][d0] * (PQ[a1] * PQ[b0] * QC_0)
                            + delta[a0][b1] * delta[d0][d1] * (PQ[a1] * PQ[b0] * PQ[c0] + PQ[a1] * PQ[b0] * QC_0)
                            + delta[a0][d0] * delta[b0][d1] * (PQ[a1] * PQ[b1] * QC_0)
                            + delta[a0][d1] * delta[b0][d0] * (PQ[a1] * PQ[b1] * QC_0)
                            + delta[a0][b0] * delta[d0][d1] * (PQ[a1] * PQ[b1] * PQ[c0] + PQ[a1] * PQ[b1] * QC_0)
                            + delta[a0][d1] * delta[b0][b1] * (PQ[a1] * PQ[c0] * QD_0 + PQ[a1] * PQ[d0] * QC_0)
                            + delta[a0][b0] * delta[b1][d1] * (PQ[a1] * PQ[c0] * QD_0 + PQ[a1] * PQ[d0] * QC_0)
                            + delta[b0][d1] * delta[a0][b1] * (PQ[a1] * PQ[c0] * QD_0 + PQ[a1] * PQ[d0] * QC_0)
                            + delta[a0][d0] * delta[b0][b1] * (PQ[a1] * PQ[c0] * QD_1 + PQ[a1] * PQ[d1] * QC_0)
                            + delta[a0][b0] * delta[b1][d0] * (PQ[a1] * PQ[c0] * QD_1 + PQ[a1] * PQ[d1] * QC_0)
                            + delta[b0][d0] * delta[a0][b1] * (PQ[a1] * PQ[c0] * QD_1 + PQ[a1] * PQ[d1] * QC_0)
                            + delta[a0][d0] * delta[a1][d1] * (PQ[b0] * PQ[b1] * QC_0)
                            + delta[a0][d1] * delta[a1][d0] * (PQ[b0] * PQ[b1] * QC_0)
                            + delta[a0][a1] * delta[d0][d1] * (PQ[b0] * PQ[b1] * PQ[c0] + PQ[b0] * PQ[b1] * QC_0)
                            + delta[a0][d1] * delta[a1][b1] * (PQ[b0] * PQ[c0] * QD_0 + PQ[b0] * PQ[d0] * QC_0)
                            + delta[a0][a1] * delta[b1][d1] * (PQ[b0] * PQ[c0] * QD_0 + PQ[b0] * PQ[d0] * QC_0)
                            + delta[a1][d1] * delta[a0][b1] * (PQ[b0] * PQ[c0] * QD_0 + PQ[b0] * PQ[d0] * QC_0)
                            + delta[a0][d0] * delta[a1][b1] * (PQ[b0] * PQ[c0] * QD_1 + PQ[b0] * PQ[d1] * QC_0)
                            + delta[a0][a1] * delta[b1][d0] * (PQ[b0] * PQ[c0] * QD_1 + PQ[b0] * PQ[d1] * QC_0)
                            + delta[a1][d0] * delta[a0][b1] * (PQ[b0] * PQ[c0] * QD_1 + PQ[b0] * PQ[d1] * QC_0)
                            + delta[a0][d1] * delta[a1][b0] * (PQ[b1] * PQ[c0] * QD_0 + PQ[b1] * PQ[d0] * QC_0)
                            + delta[a0][a1] * delta[b0][d1] * (PQ[b1] * PQ[c0] * QD_0 + PQ[b1] * PQ[d0] * QC_0)
                            + delta[a1][d1] * delta[a0][b0] * (PQ[b1] * PQ[c0] * QD_0 + PQ[b1] * PQ[d0] * QC_0)
                            + delta[a0][d0] * delta[a1][b0] * (PQ[b1] * PQ[c0] * QD_1 + PQ[b1] * PQ[d1] * QC_0)
                            + delta[a0][a1] * delta[b0][d0] * (PQ[b1] * PQ[c0] * QD_1 + PQ[b1] * PQ[d1] * QC_0)
                            + delta[a1][d0] * delta[a0][b0] * (PQ[b1] * PQ[c0] * QD_1 + PQ[b1] * PQ[d1] * QC_0)
                            + delta[a0][a1] * delta[b0][b1] * (PQ[c0] * PQ[d0] * QD_1 + PQ[c0] * PQ[d1] * QD_0 + PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][b0] * delta[a1][b1] * (PQ[c0] * PQ[d0] * QD_1 + PQ[c0] * PQ[d1] * QD_0 + PQ[d0] * PQ[d1] * QC_0)
                            + delta[a1][b0] * delta[a0][b1] * (PQ[c0] * PQ[d0] * QD_1 + PQ[c0] * PQ[d1] * QD_0 + PQ[d0] * PQ[d1] * QC_0)
                            + delta[b1][c0] * delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b0])
                            + delta[b1][d0] * delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[b0])
                            + delta[b1][d1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[b0])
                            + delta[b0][c0] * delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b1])
                            + delta[b0][d0] * delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[b1])
                            + delta[b0][d1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[b1])
                            + delta[b0][b1] * delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[d0] + PQ[a0] * PQ[a1] * QD_0)
                            + delta[b0][b1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[d1] + PQ[a0] * PQ[a1] * QD_1)
                            + delta[b0][c0] * delta[b1][d1] * (PQ[a0] * PQ[a1] * QD_0)
                            + delta[b0][d1] * delta[b1][c0] * (PQ[a0] * PQ[a1] * QD_0)
                            + delta[b0][c0] * delta[b1][d0] * (PQ[a0] * PQ[a1] * QD_1)
                            + delta[b0][d0] * delta[b1][c0] * (PQ[a0] * PQ[a1] * QD_1)
                            + delta[a1][c0] * delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[b1])
                            + delta[a1][d0] * delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[b1])
                            + delta[a1][d1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[b1])
                            + delta[a1][b1] * delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[d0] + PQ[a0] * PQ[b0] * QD_0)
                            + delta[a1][b1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[d1] + PQ[a0] * PQ[b0] * QD_1)
                            + delta[a1][c0] * delta[b1][d1] * (PQ[a0] * PQ[b0] * QD_0)
                            + delta[a1][d1] * delta[b1][c0] * (PQ[a0] * PQ[b0] * QD_0)
                            + delta[a1][c0] * delta[b1][d0] * (PQ[a0] * PQ[b0] * QD_1)
                            + delta[a1][d0] * delta[b1][c0] * (PQ[a0] * PQ[b0] * QD_1)
                            + delta[a1][b0] * delta[c0][d1] * (PQ[a0] * PQ[b1] * PQ[d0] + PQ[a0] * PQ[b1] * QD_0)
                            + delta[a1][b0] * delta[c0][d0] * (PQ[a0] * PQ[b1] * PQ[d1] + PQ[a0] * PQ[b1] * QD_1)
                            + delta[a1][c0] * delta[b0][d1] * (PQ[a0] * PQ[b1] * QD_0)
                            + delta[a1][d1] * delta[b0][c0] * (PQ[a0] * PQ[b1] * QD_0)
                            + delta[a1][c0] * delta[b0][d0] * (PQ[a0] * PQ[b1] * QD_1)
                            + delta[a1][d0] * delta[b0][c0] * (PQ[a0] * PQ[b1] * QD_1)
                            + delta[a1][c0] * delta[b0][b1] * (PQ[a0] * PQ[d0] * QD_1 + PQ[a0] * PQ[d1] * QD_0)
                            + delta[a1][b0] * delta[b1][c0] * (PQ[a0] * PQ[d0] * QD_1 + PQ[a0] * PQ[d1] * QD_0)
                            + delta[b0][c0] * delta[a1][b1] * (PQ[a0] * PQ[d0] * QD_1 + PQ[a0] * PQ[d1] * QD_0)
                            + delta[a0][c0] * delta[d0][d1] * (PQ[a1] * PQ[b0] * PQ[b1])
                            + delta[a0][d0] * delta[c0][d1] * (PQ[a1] * PQ[b0] * PQ[b1])
                            + delta[a0][d1] * delta[c0][d0] * (PQ[a1] * PQ[b0] * PQ[b1])
                            + delta[a0][b1] * delta[c0][d1] * (PQ[a1] * PQ[b0] * PQ[d0] + PQ[a1] * PQ[b0] * QD_0)
                            + delta[a0][b1] * delta[c0][d0] * (PQ[a1] * PQ[b0] * PQ[d1] + PQ[a1] * PQ[b0] * QD_1)
                            + delta[a0][c0] * delta[b1][d1] * (PQ[a1] * PQ[b0] * QD_0)
                            + delta[a0][d1] * delta[b1][c0] * (PQ[a1] * PQ[b0] * QD_0)
                            + delta[a0][c0] * delta[b1][d0] * (PQ[a1] * PQ[b0] * QD_1)
                            + delta[a0][d0] * delta[b1][c0] * (PQ[a1] * PQ[b0] * QD_1)
                            + delta[a0][b0] * delta[c0][d1] * (PQ[a1] * PQ[b1] * PQ[d0] + PQ[a1] * PQ[b1] * QD_0)
                            + delta[a0][b0] * delta[c0][d0] * (PQ[a1] * PQ[b1] * PQ[d1] + PQ[a1] * PQ[b1] * QD_1)
                            + delta[a0][c0] * delta[b0][d1] * (PQ[a1] * PQ[b1] * QD_0)
                            + delta[a0][d1] * delta[b0][c0] * (PQ[a1] * PQ[b1] * QD_0)
                            + delta[a0][c0] * delta[b0][d0] * (PQ[a1] * PQ[b1] * QD_1)
                            + delta[a0][d0] * delta[b0][c0] * (PQ[a1] * PQ[b1] * QD_1)
                            + delta[a0][c0] * delta[b0][b1] * (PQ[a1] * PQ[d0] * QD_1 + PQ[a1] * PQ[d1] * QD_0)
                            + delta[a0][b0] * delta[b1][c0] * (PQ[a1] * PQ[d0] * QD_1 + PQ[a1] * PQ[d1] * QD_0)
                            + delta[b0][c0] * delta[a0][b1] * (PQ[a1] * PQ[d0] * QD_1 + PQ[a1] * PQ[d1] * QD_0)
                            + delta[a0][a1] * delta[c0][d1] * (PQ[b0] * PQ[b1] * PQ[d0] + PQ[b0] * PQ[b1] * QD_0)
                            + delta[a0][a1] * delta[c0][d0] * (PQ[b0] * PQ[b1] * PQ[d1] + PQ[b0] * PQ[b1] * QD_1)
                            + delta[a0][c0] * delta[a1][d1] * (PQ[b0] * PQ[b1] * QD_0)
                            + delta[a0][d1] * delta[a1][c0] * (PQ[b0] * PQ[b1] * QD_0)
                            + delta[a0][c0] * delta[a1][d0] * (PQ[b0] * PQ[b1] * QD_1)
                            + delta[a0][d0] * delta[a1][c0] * (PQ[b0] * PQ[b1] * QD_1)
                            + delta[a0][c0] * delta[a1][b1] * (PQ[b0] * PQ[d0] * QD_1 + PQ[b0] * PQ[d1] * QD_0)
                            + delta[a0][a1] * delta[b1][c0] * (PQ[b0] * PQ[d0] * QD_1 + PQ[b0] * PQ[d1] * QD_0)
                            + delta[a1][c0] * delta[a0][b1] * (PQ[b0] * PQ[d0] * QD_1 + PQ[b0] * PQ[d1] * QD_0)
                            + delta[a0][c0] * delta[a1][b0] * (PQ[b1] * PQ[d0] * QD_1 + PQ[b1] * PQ[d1] * QD_0)
                            + delta[a0][a1] * delta[b0][c0] * (PQ[b1] * PQ[d0] * QD_1 + PQ[b1] * PQ[d1] * QD_0)
                            + delta[a1][c0] * delta[a0][b0] * (PQ[b1] * PQ[d0] * QD_1 + PQ[b1] * PQ[d1] * QD_0)
                        )

                    )

                    +

                    F7_t[4] * (

                        0.5 * ( S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0])
                            + delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d0] + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d0] + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d0] + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d0] + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d0] + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d0])
                            + delta[c0][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d1] + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d1] + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d1] + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d1] + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d1] + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d1])
                            + delta[b1][d1] * (PB_0 * PA_0 * PQ[a1] * PQ[c0] * PQ[d0] + PB_0 * PA_1 * PQ[a0] * PQ[c0] * PQ[d0] + PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[b1][d0] * (PB_0 * PA_0 * PQ[a1] * PQ[c0] * PQ[d1] + PB_0 * PA_1 * PQ[a0] * PQ[c0] * PQ[d1] + PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[b1][c0] * (PB_0 * PA_0 * PQ[a1] * PQ[d0] * PQ[d1] + PB_0 * PA_1 * PQ[a0] * PQ[d0] * PQ[d1] + PA_0 * PA_1 * PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[b0][d1] * (PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[d0] + PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[d0] + PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[b0][d0] * (PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[d1] + PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[d1] + PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[b0][c0] * (PB_1 * PA_0 * PQ[a1] * PQ[d0] * PQ[d1] + PB_1 * PA_1 * PQ[a0] * PQ[d0] * PQ[d1] + PA_0 * PA_1 * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[b0][b1] * (PA_0 * PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PA_1 * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a1][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[d0] + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[d0] + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a1][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[d1] + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[d1] + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[a1][c0] * (PB_0 * PB_1 * PQ[a0] * PQ[d0] * PQ[d1] + PB_0 * PA_0 * PQ[b1] * PQ[d0] * PQ[d1] + PB_1 * PA_0 * PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a1][b1] * (PB_0 * PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a1][b0] * (PB_1 * PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * (PB_0 * PB_1 * PQ[a1] * PQ[c0] * PQ[d0] + PB_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[d0] + PB_1 * PA_1 * PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a0][d0] * (PB_0 * PB_1 * PQ[a1] * PQ[c0] * PQ[d1] + PB_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[d1] + PB_1 * PA_1 * PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * (PB_0 * PB_1 * PQ[a1] * PQ[d0] * PQ[d1] + PB_0 * PA_1 * PQ[b1] * PQ[d0] * PQ[d1] + PB_1 * PA_1 * PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a0][b1] * (PB_0 * PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PA_1 * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * (PB_1 * PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PA_1 * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][a1] * (PB_0 * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PB_1 * PQ[c0] * PQ[d0] * PQ[d1])
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDPD15(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[5];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[4] * (

                        0.5 * ( S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[c0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[c0][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d1] * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[b1][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[b1][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[d1] * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[b1][c0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][d1] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][d0] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][c0] * (PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][b1] * (PA_0 * PQ[a1] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0] * QD_1 + PQ[a0] * PQ[a1] * PQ[c0] * PQ[d1] * QD_0 + PQ[a0] * PQ[a1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a1][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][d0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][c0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][b1] * (PB_0 * PQ[a0] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[a0] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 + PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 + PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a1][b0] * (PB_1 * PQ[a0] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 + PQ[a0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 + PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][d1] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[a1] * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d0] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[a1] * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[d1] * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][c0] * (PB_0 * PQ[a1] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[a1] * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][b1] * (PB_0 * PQ[a1] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[a1] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[a1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 + PQ[a1] * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 + PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][b0] * (PB_1 * PQ[a1] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[a1] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[a1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 + PQ[a1] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 + PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][a1] * (PB_0 * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 + PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 + PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0)
                        )

                    )

                    +

                    F7_t[4] * (

                        0.5 * ( S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * QC_0)
                            + delta[b1][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * QD_0 * QC_0)
                            + delta[b1][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * QD_1 * QC_0)
                            + delta[b0][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * QD_0 * QC_0)
                            + delta[b0][d0] * (PQ[a0] * PQ[a1] * PQ[b1] * QD_1 * QC_0)
                            + delta[b0][b1] * (PQ[a0] * PQ[a1] * PQ[c0] * QD_0 * QD_1 + PQ[a0] * PQ[a1] * PQ[d0] * QD_1 * QC_0 + PQ[a0] * PQ[a1] * PQ[d1] * QD_0 * QC_0)
                            + delta[a1][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * QC_0)
                            + delta[a1][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * QD_1 * QC_0)
                            + delta[a1][b1] * (PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * QD_1 + PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * QC_0 + PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * QC_0)
                            + delta[a1][b0] * (PQ[a0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 + PQ[a0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 + PQ[a0] * PQ[b1] * PQ[d1] * QD_0 * QC_0)
                            + delta[a0][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * QC_0)
                            + delta[a0][d0] * (PQ[a1] * PQ[b0] * PQ[b1] * QD_1 * QC_0)
                            + delta[a0][b1] * (PQ[a1] * PQ[b0] * PQ[c0] * QD_0 * QD_1 + PQ[a1] * PQ[b0] * PQ[d0] * QD_1 * QC_0 + PQ[a1] * PQ[b0] * PQ[d1] * QD_0 * QC_0)
                            + delta[a0][b0] * (PQ[a1] * PQ[b1] * PQ[c0] * QD_0 * QD_1 + PQ[a1] * PQ[b1] * PQ[d0] * QD_1 * QC_0 + PQ[a1] * PQ[b1] * PQ[d1] * QD_0 * QC_0)
                            + delta[a0][a1] * (PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 + PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 + PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_0)
                            + delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * QD_0)
                            + delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * QD_1)
                            + delta[b1][c0] * (PQ[a0] * PQ[a1] * PQ[b0] * QD_0 * QD_1)
                            + delta[b0][c0] * (PQ[a0] * PQ[a1] * PQ[b1] * QD_0 * QD_1)
                            + delta[a1][c0] * (PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * QD_1)
                            + delta[a0][c0] * (PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * QD_1)
                        )

                    )

                    +

                    F7_t[4] * (

                        0.125 * S2 / ( S4 * S4 * S4 * S4 ) * (
                            delta[a1][c0] * delta[b0][b1] * delta[d0][d1] * (PQ[a0])
                            + delta[a1][c0] * delta[b0][d0] * delta[b1][d1] * (PQ[a0])
                            + delta[a1][c0] * delta[b0][d1] * delta[b1][d0] * (PQ[a0])
                            + delta[a1][d0] * delta[b0][b1] * delta[c0][d1] * (PQ[a0])
                            + delta[a1][d0] * delta[b0][c0] * delta[b1][d1] * (PQ[a0])
                            + delta[a1][d0] * delta[b0][d1] * delta[b1][c0] * (PQ[a0])
                            + delta[a1][d1] * delta[b0][b1] * delta[c0][d0] * (PQ[a0])
                            + delta[a1][d1] * delta[b0][c0] * delta[b1][d0] * (PQ[a0])
                            + delta[a1][d1] * delta[b0][d0] * delta[b1][c0] * (PQ[a0])
                            + delta[a1][b0] * delta[b1][c0] * delta[d0][d1] * (PQ[a0])
                            + delta[a1][b0] * delta[b1][d0] * delta[c0][d1] * (PQ[a0])
                            + delta[a1][b0] * delta[b1][d1] * delta[c0][d0] * (PQ[a0])
                            + delta[b0][c0] * delta[a1][b1] * delta[d0][d1] * (PQ[a0])
                            + delta[b0][d0] * delta[a1][b1] * delta[c0][d1] * (PQ[a0])
                            + delta[b0][d1] * delta[a1][b1] * delta[c0][d0] * (PQ[a0])
                            + delta[a0][c0] * delta[b0][b1] * delta[d0][d1] * (PQ[a1])
                            + delta[a0][c0] * delta[b0][d0] * delta[b1][d1] * (PQ[a1])
                            + delta[a0][c0] * delta[b0][d1] * delta[b1][d0] * (PQ[a1])
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][d1] * (PQ[a1])
                            + delta[a0][d0] * delta[b0][c0] * delta[b1][d1] * (PQ[a1])
                            + delta[a0][d0] * delta[b0][d1] * delta[b1][c0] * (PQ[a1])
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][d0] * (PQ[a1])
                            + delta[a0][d1] * delta[b0][c0] * delta[b1][d0] * (PQ[a1])
                            + delta[a0][d1] * delta[b0][d0] * delta[b1][c0] * (PQ[a1])
                            + delta[a0][b0] * delta[b1][c0] * delta[d0][d1] * (PQ[a1])
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][d1] * (PQ[a1])
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][d0] * (PQ[a1])
                            + delta[b0][c0] * delta[a0][b1] * delta[d0][d1] * (PQ[a1])
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][d1] * (PQ[a1])
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][d0] * (PQ[a1])
                            + delta[a0][c0] * delta[a1][d0] * delta[b1][d1] * (PQ[b0])
                            + delta[a0][c0] * delta[a1][d1] * delta[b1][d0] * (PQ[b0])
                            + delta[a0][c0] * delta[a1][b1] * delta[d0][d1] * (PQ[b0])
                            + delta[a0][d0] * delta[a1][c0] * delta[b1][d1] * (PQ[b0])
                            + delta[a0][d0] * delta[a1][d1] * delta[b1][c0] * (PQ[b0])
                            + delta[a0][d0] * delta[a1][b1] * delta[c0][d1] * (PQ[b0])
                            + delta[a0][d1] * delta[a1][c0] * delta[b1][d0] * (PQ[b0])
                            + delta[a0][d1] * delta[a1][d0] * delta[b1][c0] * (PQ[b0])
                            + delta[a0][d1] * delta[a1][b1] * delta[c0][d0] * (PQ[b0])
                            + delta[a0][a1] * delta[b1][c0] * delta[d0][d1] * (PQ[b0])
                            + delta[a0][a1] * delta[b1][d0] * delta[c0][d1] * (PQ[b0])
                            + delta[a0][a1] * delta[b1][d1] * delta[c0][d0] * (PQ[b0])
                            + delta[a1][c0] * delta[a0][b1] * delta[d0][d1] * (PQ[b0])
                            + delta[a1][d0] * delta[a0][b1] * delta[c0][d1] * (PQ[b0])
                            + delta[a1][d1] * delta[a0][b1] * delta[c0][d0] * (PQ[b0])
                            + delta[a0][c0] * delta[a1][d0] * delta[b0][d1] * (PQ[b1])
                            + delta[a0][c0] * delta[a1][d1] * delta[b0][d0] * (PQ[b1])
                            + delta[a0][c0] * delta[a1][b0] * delta[d0][d1] * (PQ[b1])
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][d1] * (PQ[b1])
                            + delta[a0][d0] * delta[a1][d1] * delta[b0][c0] * (PQ[b1])
                            + delta[a0][d0] * delta[a1][b0] * delta[c0][d1] * (PQ[b1])
                            + delta[a0][d1] * delta[a1][c0] * delta[b0][d0] * (PQ[b1])
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][c0] * (PQ[b1])
                            + delta[a0][d1] * delta[a1][b0] * delta[c0][d0] * (PQ[b1])
                            + delta[a0][a1] * delta[b0][c0] * delta[d0][d1] * (PQ[b1])
                            + delta[a0][a1] * delta[b0][d0] * delta[c0][d1] * (PQ[b1])
                            + delta[a0][a1] * delta[b0][d1] * delta[c0][d0] * (PQ[b1])
                            + delta[a1][c0] * delta[a0][b0] * delta[d0][d1] * (PQ[b1])
                            + delta[a1][d0] * delta[a0][b0] * delta[c0][d1] * (PQ[b1])
                            + delta[a1][d1] * delta[a0][b0] * delta[c0][d0] * (PQ[b1])
                            + delta[a0][d0] * delta[a1][d1] * delta[b0][b1] * (PQ[c0])
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][d1] * (PQ[c0])
                            + delta[a0][d0] * delta[b0][d1] * delta[a1][b1] * (PQ[c0])
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][b1] * (PQ[c0])
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][d0] * (PQ[c0])
                            + delta[a0][d1] * delta[b0][d0] * delta[a1][b1] * (PQ[c0])
                            + delta[a0][a1] * delta[b0][b1] * delta[d0][d1] * (PQ[c0])
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][d1] * (PQ[c0])
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][d0] * (PQ[c0])
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][d1] * (PQ[c0])
                            + delta[a1][d0] * delta[b0][d1] * delta[a0][b1] * (PQ[c0])
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][d0] * (PQ[c0])
                            + delta[a1][d1] * delta[b0][d0] * delta[a0][b1] * (PQ[c0])
                            + delta[a0][b0] * delta[a1][b1] * delta[d0][d1] * (PQ[c0])
                            + delta[a1][b0] * delta[a0][b1] * delta[d0][d1] * (PQ[c0])
                            + delta[a0][c0] * delta[a1][d1] * delta[b0][b1] * (PQ[d0])
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d1] * (PQ[d0])
                            + delta[a0][c0] * delta[b0][d1] * delta[a1][b1] * (PQ[d0])
                            + delta[a0][d1] * delta[a1][c0] * delta[b0][b1] * (PQ[d0])
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][c0] * (PQ[d0])
                            + delta[a0][d1] * delta[b0][c0] * delta[a1][b1] * (PQ[d0])
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d1] * (PQ[d0])
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d1] * (PQ[d0])
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][c0] * (PQ[d0])
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d1] * (PQ[d0])
                            + delta[a1][c0] * delta[b0][d1] * delta[a0][b1] * (PQ[d0])
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][c0] * (PQ[d0])
                            + delta[a1][d1] * delta[b0][c0] * delta[a0][b1] * (PQ[d0])
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d1] * (PQ[d0])
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d1] * (PQ[d0])
                            + delta[a0][c0] * delta[a1][d0] * delta[b0][b1] * (PQ[d1])
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d0] * (PQ[d1])
                            + delta[a0][c0] * delta[b0][d0] * delta[a1][b1] * (PQ[d1])
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][b1] * (PQ[d1])
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][c0] * (PQ[d1])
                            + delta[a0][d0] * delta[b0][c0] * delta[a1][b1] * (PQ[d1])
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * (PQ[d1])
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d0] * (PQ[d1])
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][c0] * (PQ[d1])
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d0] * (PQ[d1])
                            + delta[a1][c0] * delta[b0][d0] * delta[a0][b1] * (PQ[d1])
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][c0] * (PQ[d1])
                            + delta[a1][d0] * delta[b0][c0] * delta[a0][b1] * (PQ[d1])
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * (PQ[d1])
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * (PQ[d1])
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDPD16(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[6];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 5, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[5] * (

                        ( S1 * S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                        )

                    )

                    +

                    F7_t[5] * (

                        ( S1 * S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * QD_1
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d1] * QD_0
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1] * QC_0
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0
                        )

                    )

                    +

                    F7_t[5] * (

                        ( S1 * S2 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            
                            + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                        )

                    )

                    +

                    F7_t[5] * (

                        0.25 * ( S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            delta[b1][c0] * delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * (-1.0))
                            + delta[b1][d0] * delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * (-1.0))
                            + delta[b1][d1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * (-1.0))
                            + delta[b0][c0] * delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * (-1.0))
                            + delta[b0][d0] * delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * (-1.0))
                            + delta[b0][d1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[b1] * (-1.0))
                            + delta[b0][b1] * delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[c0] * (-1.0))
                            + delta[b0][d0] * delta[b1][d1] * (PQ[a0] * PQ[a1] * PQ[c0] * (-1.0))
                            + delta[b0][d1] * delta[b1][d0] * (PQ[a0] * PQ[a1] * PQ[c0] * (-1.0))
                            + delta[b0][b1] * delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[d0] * (-1.0))
                            + delta[b0][c0] * delta[b1][d1] * (PQ[a0] * PQ[a1] * PQ[d0] * (-1.0))
                            + delta[b0][d1] * delta[b1][c0] * (PQ[a0] * PQ[a1] * PQ[d0] * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[d1] * (-1.0))
                            + delta[b0][c0] * delta[b1][d0] * (PQ[a0] * PQ[a1] * PQ[d1] * (-1.0))
                            + delta[b0][d0] * delta[b1][c0] * (PQ[a0] * PQ[a1] * PQ[d1] * (-1.0))
                            + delta[a1][c0] * delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a1][d0] * delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a1][d1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a1][d0] * delta[b1][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a1][d1] * delta[b1][d0] * (PQ[a0] * PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a1][b1] * delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a1][c0] * delta[b1][d1] * (PQ[a0] * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a1][d1] * delta[b1][c0] * (PQ[a0] * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a1][b1] * delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a1][c0] * delta[b1][d0] * (PQ[a0] * PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a1][d0] * delta[b1][c0] * (PQ[a0] * PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a1][b1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a1][d0] * delta[b0][d1] * (PQ[a0] * PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a1][d1] * delta[b0][d0] * (PQ[a0] * PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a1][b0] * delta[d0][d1] * (PQ[a0] * PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a1][c0] * delta[b0][d1] * (PQ[a0] * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a1][d1] * delta[b0][c0] * (PQ[a0] * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a1][b0] * delta[c0][d1] * (PQ[a0] * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a1][c0] * delta[b0][d0] * (PQ[a0] * PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a1][d0] * delta[b0][c0] * (PQ[a0] * PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a1][b0] * delta[c0][d0] * (PQ[a0] * PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a1][d1] * delta[b0][b1] * (PQ[a0] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a1][b0] * delta[b1][d1] * (PQ[a0] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[b0][d1] * delta[a1][b1] * (PQ[a0] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a1][d0] * delta[b0][b1] * (PQ[a0] * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a1][b0] * delta[b1][d0] * (PQ[a0] * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[b0][d0] * delta[a1][b1] * (PQ[a0] * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a1][c0] * delta[b0][b1] * (PQ[a0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][b0] * delta[b1][c0] * (PQ[a0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][c0] * delta[a1][b1] * (PQ[a0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[d0][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][d0] * delta[c0][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][d1] * delta[c0][d0] * (PQ[a1] * PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][d0] * delta[b1][d1] * (PQ[a1] * PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[b1][d0] * (PQ[a1] * PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a0][b1] * delta[d0][d1] * (PQ[a1] * PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a0][c0] * delta[b1][d1] * (PQ[a1] * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[b1][c0] * (PQ[a1] * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][b1] * delta[c0][d1] * (PQ[a1] * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[b1][d0] * (PQ[a1] * PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[b1][c0] * (PQ[a1] * PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a0][b1] * delta[c0][d0] * (PQ[a1] * PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[b0][d1] * (PQ[a1] * PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * (PQ[a1] * PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PQ[a1] * PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a0][c0] * delta[b0][d1] * (PQ[a1] * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[b0][c0] * (PQ[a1] * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[c0][d1] * (PQ[a1] * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[b0][d0] * (PQ[a1] * PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[b0][c0] * (PQ[a1] * PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (PQ[a1] * PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * (PQ[a1] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * (PQ[a1] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * (PQ[a1] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * (PQ[a1] * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * (PQ[a1] * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * (PQ[a1] * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * (PQ[a1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * (PQ[a1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * (PQ[a1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[a1][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[a1][d0] * (PQ[b0] * PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a0][a1] * delta[d0][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a0][c0] * delta[a1][d1] * (PQ[b0] * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[a1][c0] * (PQ[b0] * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[c0][d1] * (PQ[b0] * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[a1][d0] * (PQ[b0] * PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[a1][c0] * (PQ[b0] * PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[c0][d0] * (PQ[b0] * PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a0][d1] * delta[a1][b1] * (PQ[b0] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[b1][d1] * (PQ[b0] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a1][d1] * delta[a0][b1] * (PQ[b0] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][d0] * delta[a1][b1] * (PQ[b0] * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b1][d0] * (PQ[b0] * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a1][d0] * delta[a0][b1] * (PQ[b0] * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[a1][b1] * (PQ[b0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b1][c0] * (PQ[b0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][c0] * delta[a0][b1] * (PQ[b0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * (PQ[b1] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * (PQ[b1] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * (PQ[b1] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * (PQ[b1] * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * (PQ[b1] * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * (PQ[b1] * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * (PQ[b1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * (PQ[b1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * (PQ[b1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * (PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * (PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * (PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                        )

                    )

                    +

                    F7_t[5] * (

                        0.5 * ( S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0])
                            + delta[c0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0])
                            + delta[c0][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d1] + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d1] + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1])
                            + delta[b1][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0] + PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] + PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[b1][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[d1] + PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d1] + PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[b1][c0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[d0] * PQ[d1] + PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1] + PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[b0][d1] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0] + PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] + PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[b0][d0] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[d1] + PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d1] + PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[b0][c0] * (PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * PQ[d1] + PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1] + PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[b0][b1] * (PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1] + PA_1 * PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a1][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a1][d0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d1] + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1] + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[a1][c0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1] + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1] + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a1][b1] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] + PA_0 * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a1][b0] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] + PA_0 * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] + PB_1 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] + PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a0][d0] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d1] + PB_1 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d1] + PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * (PB_0 * PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1] + PB_1 * PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1] + PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a0][b1] * (PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1] + PA_1 * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * (PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1] + PA_1 * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][a1] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] + PB_1 * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1])
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDPD17(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[7];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 6, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[5] * (

                        0.5 * ( S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[b1][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[b1][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[b1][c0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][d0] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][c0] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][b1] * (PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][c0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][b1] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][b0] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d0] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][c0] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][b1] * (PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][b0] * (PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][a1] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                        )

                    )

                    +

                    F7_t[6] * (

                        ( S1 * S1 * S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                        )

                    )

                    +

                    F7_t[6] * (

                        ( S1 * S1 * S2 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1
                            + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0
                            + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDPD18(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[8];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 7, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[6] * (

                        0.5 * ( S1 * S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0])
                            + delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0])
                            + delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1])
                            + delta[b1][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[b1][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[b1][c0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[b0][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[b0][d0] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[b0][c0] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[b0][b1] * (PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a1][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a1][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[a1][c0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a1][b1] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a1][b0] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a0][d0] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a0][b1] * (PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * (PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][a1] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1])
                        )

                    )

                    +

                    F7_t[7] * (

                        ( S1 * S1 * S1 * S2 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD0(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[1];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 0, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[0] * (

                        0.125 / ( S1 * S1 * S2 ) * (
                            delta[a0][a1] * delta[b0][b1] * delta[d0][d1] * (QC_0 * QC_1)
                            + delta[a0][b0] * delta[a1][b1] * delta[d0][d1] * (QC_0 * QC_1)
                            + delta[a1][b0] * delta[a0][b1] * delta[d0][d1] * (QC_0 * QC_1)
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d1] * (QD_0 * QC_0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d1] * (QD_0 * QC_0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d1] * (QD_0 * QC_0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d0] * (QD_1 * QC_0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d0] * (QD_1 * QC_0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d0] * (QD_1 * QC_0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d1] * (QD_0 * QC_1)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d1] * (QD_0 * QC_1)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d1] * (QD_0 * QC_1)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * (QD_1 * QC_1)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * (QD_1 * QC_1)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * (QD_1 * QC_1)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][c1] * (QD_0 * QD_1)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][c1] * (QD_0 * QD_1)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][c1] * (QD_0 * QD_1)
                        )

                    )

                    +

                    F8_t[0] * (

                        0.125 / ( S1 * S2 * S2 ) * (
                            delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (PA_0 * PA_1)
                            + delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (PA_0 * PA_1)
                            + delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (PA_0 * PA_1)
                            + delta[a1][b1] * delta[c0][c1] * delta[d0][d1] * (PB_0 * PA_0)
                            + delta[a1][b1] * delta[c0][d0] * delta[c1][d1] * (PB_0 * PA_0)
                            + delta[a1][b1] * delta[c1][d0] * delta[c0][d1] * (PB_0 * PA_0)
                            + delta[a1][b0] * delta[c0][c1] * delta[d0][d1] * (PB_1 * PA_0)
                            + delta[a1][b0] * delta[c0][d0] * delta[c1][d1] * (PB_1 * PA_0)
                            + delta[a1][b0] * delta[c1][d0] * delta[c0][d1] * (PB_1 * PA_0)
                            + delta[a0][b1] * delta[c0][c1] * delta[d0][d1] * (PB_0 * PA_1)
                            + delta[a0][b1] * delta[c0][d0] * delta[c1][d1] * (PB_0 * PA_1)
                            + delta[a0][b1] * delta[c1][d0] * delta[c0][d1] * (PB_0 * PA_1)
                            + delta[a0][b0] * delta[c0][c1] * delta[d0][d1] * (PB_1 * PA_1)
                            + delta[a0][b0] * delta[c0][d0] * delta[c1][d1] * (PB_1 * PA_1)
                            + delta[a0][b0] * delta[c1][d0] * delta[c0][d1] * (PB_1 * PA_1)
                            + delta[a0][a1] * delta[c0][c1] * delta[d0][d1] * (PB_0 * PB_1)
                            + delta[a0][a1] * delta[c0][d0] * delta[c1][d1] * (PB_0 * PB_1)
                            + delta[a0][a1] * delta[c1][d0] * delta[c0][d1] * (PB_0 * PB_1)
                        )

                    )

                    +

                    F8_t[0] * (

                        0.25 / ( S1 * S1 ) * (
                            delta[a0][a1] * delta[b0][b1] * (QD_0 * QD_1 * QC_0 * QC_1)
                            + delta[a0][b0] * delta[a1][b1] * (QD_0 * QD_1 * QC_0 * QC_1)
                            + delta[a1][b0] * delta[a0][b1] * (QD_0 * QD_1 * QC_0 * QC_1)
                        )

                    )

                    +

                    F8_t[0] * (

                        0.25 / ( S1 * S2 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PA_0 * PA_1 * QC_0 * QC_1)
                            + delta[b0][b1] * delta[c1][d1] * (PA_0 * PA_1 * QD_0 * QC_0)
                            + delta[b0][b1] * delta[c1][d0] * (PA_0 * PA_1 * QD_1 * QC_0)
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * PA_1 * QD_0 * QC_1)
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * PA_1 * QD_1 * QC_1)
                            + delta[b0][b1] * delta[c0][c1] * (PA_0 * PA_1 * QD_0 * QD_1)
                            + delta[a1][b1] * delta[d0][d1] * (PB_0 * PA_0 * QC_0 * QC_1)
                            + delta[a1][b1] * delta[c1][d1] * (PB_0 * PA_0 * QD_0 * QC_0)
                            + delta[a1][b1] * delta[c1][d0] * (PB_0 * PA_0 * QD_1 * QC_0)
                            + delta[a1][b1] * delta[c0][d1] * (PB_0 * PA_0 * QD_0 * QC_1)
                            + delta[a1][b1] * delta[c0][d0] * (PB_0 * PA_0 * QD_1 * QC_1)
                            + delta[a1][b1] * delta[c0][c1] * (PB_0 * PA_0 * QD_0 * QD_1)
                            + delta[a1][b0] * delta[d0][d1] * (PB_1 * PA_0 * QC_0 * QC_1)
                            + delta[a1][b0] * delta[c1][d1] * (PB_1 * PA_0 * QD_0 * QC_0)
                            + delta[a1][b0] * delta[c1][d0] * (PB_1 * PA_0 * QD_1 * QC_0)
                            + delta[a1][b0] * delta[c0][d1] * (PB_1 * PA_0 * QD_0 * QC_1)
                            + delta[a1][b0] * delta[c0][d0] * (PB_1 * PA_0 * QD_1 * QC_1)
                            + delta[a1][b0] * delta[c0][c1] * (PB_1 * PA_0 * QD_0 * QD_1)
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PA_1 * QC_0 * QC_1)
                            + delta[a0][b1] * delta[c1][d1] * (PB_0 * PA_1 * QD_0 * QC_0)
                            + delta[a0][b1] * delta[c1][d0] * (PB_0 * PA_1 * QD_1 * QC_0)
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * PA_1 * QD_0 * QC_1)
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PA_1 * QD_1 * QC_1)
                            + delta[a0][b1] * delta[c0][c1] * (PB_0 * PA_1 * QD_0 * QD_1)
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PA_1 * QC_0 * QC_1)
                            + delta[a0][b0] * delta[c1][d1] * (PB_1 * PA_1 * QD_0 * QC_0)
                            + delta[a0][b0] * delta[c1][d0] * (PB_1 * PA_1 * QD_1 * QC_0)
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * PA_1 * QD_0 * QC_1)
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PA_1 * QD_1 * QC_1)
                            + delta[a0][b0] * delta[c0][c1] * (PB_1 * PA_1 * QD_0 * QD_1)
                            + delta[a0][a1] * delta[d0][d1] * (PB_0 * PB_1 * QC_0 * QC_1)
                            + delta[a0][a1] * delta[c1][d1] * (PB_0 * PB_1 * QD_0 * QC_0)
                            + delta[a0][a1] * delta[c1][d0] * (PB_0 * PB_1 * QD_1 * QC_0)
                            + delta[a0][a1] * delta[c0][d1] * (PB_0 * PB_1 * QD_0 * QC_1)
                            + delta[a0][a1] * delta[c0][d0] * (PB_0 * PB_1 * QD_1 * QC_1)
                            + delta[a0][a1] * delta[c0][c1] * (PB_0 * PB_1 * QD_0 * QD_1)
                        )

                    )

                    +

                    F8_t[0] * (

                        0.25 / ( S2 * S2 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PA_1)
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PB_1 * PA_0 * PA_1)
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PA_1)
                        )

                    )

                    +

                    F8_t[0] * (

                        0.5 / S1 * (
                            delta[b0][b1] * (PA_0 * PA_1 * QD_0 * QD_1 * QC_0 * QC_1)
                            + delta[a1][b1] * (PB_0 * PA_0 * QD_0 * QD_1 * QC_0 * QC_1)
                            + delta[a1][b0] * (PB_1 * PA_0 * QD_0 * QD_1 * QC_0 * QC_1)
                            + delta[a0][b1] * (PB_0 * PA_1 * QD_0 * QD_1 * QC_0 * QC_1)
                            + delta[a0][b0] * (PB_1 * PA_1 * QD_0 * QD_1 * QC_0 * QC_1)
                            + delta[a0][a1] * (PB_0 * PB_1 * QD_0 * QD_1 * QC_0 * QC_1)
                        )

                    )

                    +

                    F8_t[0] * (

                        0.5 / S2 * (
                            delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PA_1 * QC_0 * QC_1)
                            + delta[c1][d1] * (PB_0 * PB_1 * PA_0 * PA_1 * QD_0 * QC_0)
                            + delta[c1][d0] * (PB_0 * PB_1 * PA_0 * PA_1 * QD_1 * QC_0)
                            + delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PA_1 * QD_0 * QC_1)
                            + delta[c0][d0] * (PB_0 * PB_1 * PA_0 * PA_1 * QD_1 * QC_1)
                            + delta[c0][c1] * (PB_0 * PB_1 * PA_0 * PA_1 * QD_0 * QD_1)
                        )

                    )

                    +

                    F8_t[0] * (

                        (
                            
                            + PB_0 * PB_1 * PA_0 * PA_1 * QD_0 * QD_1 * QC_0 * QC_1
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD1(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[2];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 1, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[0] * (

                        0.0625 / ( S1 * S1 * S2 * S2 ) * (
                            delta[a0][a1] * delta[b0][b1] * delta[c0][c1] * delta[d0][d1]
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * delta[c1][d1]
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d0] * delta[c0][d1]
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][c1] * delta[d0][d1]
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * delta[c1][d1]
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d0] * delta[c0][d1]
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][c1] * delta[d0][d1]
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * delta[c1][d1]
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d0] * delta[c0][d1]
                        )

                    )

                    +

                    F8_t[1] * (

                        0.0625 / ( S1 * S1 * S2 * S4 ) * (
                            delta[a0][a1] * delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (-2.0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (-2.0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (-2.0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][c1] * delta[d0][d1] * (-2.0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * delta[c1][d1] * (-2.0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d0] * delta[c0][d1] * (-2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][c1] * delta[d0][d1] * (-2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * delta[c1][d1] * (-2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d0] * delta[c0][d1] * (-2.0)
                        )

                    )

                    +

                    F8_t[1] * (

                        0.0625 / ( S1 * S2 * S2 * S4 ) * (
                            delta[a0][a1] * delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (-2.0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (-2.0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (-2.0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][c1] * delta[d0][d1] * (-2.0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * delta[c1][d1] * (-2.0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d0] * delta[c0][d1] * (-2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][c1] * delta[d0][d1] * (-2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * delta[c1][d1] * (-2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d0] * delta[c0][d1] * (-2.0)
                        )

                    )

                    +

                    F8_t[1] * (

                        0.125 / ( S1 * S1 * S4 ) * (
                            delta[a0][a1] * delta[b0][b1] * delta[d0][d1] * (QC_0 * QC_1 * (-2.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[d0][d1] * (QC_0 * QC_1 * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[d0][d1] * (QC_0 * QC_1 * (-2.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d1] * (QD_0 * QC_0 * (-2.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d1] * (QD_0 * QC_0 * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d1] * (QD_0 * QC_0 * (-2.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d0] * (QD_1 * QC_0 * (-2.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d0] * (QD_1 * QC_0 * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d0] * (QD_1 * QC_0 * (-2.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d1] * (QD_0 * QC_1 * (-2.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d1] * (QD_0 * QC_1 * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d1] * (QD_0 * QC_1 * (-2.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * (QD_1 * QC_1 * (-2.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * (QD_1 * QC_1 * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * (QD_1 * QC_1 * (-2.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][c1] * (QD_0 * QD_1 * (-2.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][c1] * (QD_0 * QD_1 * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][c1] * (QD_0 * QD_1 * (-2.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD2(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[2];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 1, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[1] * (

                        0.125 / ( S1 * S2 * S4 ) * (
                            delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (PA_0 * PA_1 * (-1.0) + PA_0 * PQ[a1] + PA_1 * PQ[a0])
                            + delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (PA_0 * PA_1 * (-1.0) + PA_0 * PQ[a1] + PA_1 * PQ[a0])
                            + delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (PA_0 * PA_1 * (-1.0) + PA_0 * PQ[a1] + PA_1 * PQ[a0])
                            + delta[a1][b1] * delta[c0][c1] * delta[d0][d1] * (PB_0 * PA_0 * (-1.0) + PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[a1][b1] * delta[c0][d0] * delta[c1][d1] * (PB_0 * PA_0 * (-1.0) + PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[a1][b1] * delta[c1][d0] * delta[c0][d1] * (PB_0 * PA_0 * (-1.0) + PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[a1][b0] * delta[c0][c1] * delta[d0][d1] * (PB_1 * PA_0 * (-1.0) + PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[a1][b0] * delta[c0][d0] * delta[c1][d1] * (PB_1 * PA_0 * (-1.0) + PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[a1][b0] * delta[c1][d0] * delta[c0][d1] * (PB_1 * PA_0 * (-1.0) + PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[a1][c1] * delta[b0][b1] * delta[d0][d1] * (PA_0 * QC_0)
                            + delta[a1][d0] * delta[b0][b1] * delta[c1][d1] * (PA_0 * QC_0)
                            + delta[a1][d1] * delta[b0][b1] * delta[c1][d0] * (PA_0 * QC_0)
                            + delta[a1][b0] * delta[b1][c1] * delta[d0][d1] * (PA_0 * QC_0)
                            + delta[a1][b0] * delta[b1][d0] * delta[c1][d1] * (PA_0 * QC_0)
                            + delta[a1][b0] * delta[b1][d1] * delta[c1][d0] * (PA_0 * QC_0)
                            + delta[b0][c1] * delta[a1][b1] * delta[d0][d1] * (PA_0 * QC_0)
                            + delta[b0][d0] * delta[a1][b1] * delta[c1][d1] * (PA_0 * QC_0)
                            + delta[b0][d1] * delta[a1][b1] * delta[c1][d0] * (PA_0 * QC_0)
                            + delta[a1][c0] * delta[b0][b1] * delta[d0][d1] * (PA_0 * QC_1)
                            + delta[a1][d0] * delta[b0][b1] * delta[c0][d1] * (PA_0 * QC_1)
                            + delta[a1][d1] * delta[b0][b1] * delta[c0][d0] * (PA_0 * QC_1)
                            + delta[a1][b0] * delta[b1][c0] * delta[d0][d1] * (PA_0 * QC_1)
                            + delta[a1][b0] * delta[b1][d0] * delta[c0][d1] * (PA_0 * QC_1)
                            + delta[a1][b0] * delta[b1][d1] * delta[c0][d0] * (PA_0 * QC_1)
                            + delta[b0][c0] * delta[a1][b1] * delta[d0][d1] * (PA_0 * QC_1)
                            + delta[b0][d0] * delta[a1][b1] * delta[c0][d1] * (PA_0 * QC_1)
                            + delta[b0][d1] * delta[a1][b1] * delta[c0][d0] * (PA_0 * QC_1)
                            + delta[a1][c0] * delta[b0][b1] * delta[c1][d1] * (PA_0 * QD_0)
                            + delta[a1][c1] * delta[b0][b1] * delta[c0][d1] * (PA_0 * QD_0)
                            + delta[a1][d1] * delta[b0][b1] * delta[c0][c1] * (PA_0 * QD_0)
                            + delta[a1][b0] * delta[b1][c0] * delta[c1][d1] * (PA_0 * QD_0)
                            + delta[a1][b0] * delta[b1][c1] * delta[c0][d1] * (PA_0 * QD_0)
                            + delta[a1][b0] * delta[b1][d1] * delta[c0][c1] * (PA_0 * QD_0)
                            + delta[b0][c0] * delta[a1][b1] * delta[c1][d1] * (PA_0 * QD_0)
                            + delta[b0][c1] * delta[a1][b1] * delta[c0][d1] * (PA_0 * QD_0)
                            + delta[b0][d1] * delta[a1][b1] * delta[c0][c1] * (PA_0 * QD_0)
                            + delta[a1][c0] * delta[b0][b1] * delta[c1][d0] * (PA_0 * QD_1)
                            + delta[a1][c1] * delta[b0][b1] * delta[c0][d0] * (PA_0 * QD_1)
                            + delta[a1][d0] * delta[b0][b1] * delta[c0][c1] * (PA_0 * QD_1)
                            + delta[a1][b0] * delta[b1][c0] * delta[c1][d0] * (PA_0 * QD_1)
                            + delta[a1][b0] * delta[b1][c1] * delta[c0][d0] * (PA_0 * QD_1)
                            + delta[a1][b0] * delta[b1][d0] * delta[c0][c1] * (PA_0 * QD_1)
                            + delta[b0][c0] * delta[a1][b1] * delta[c1][d0] * (PA_0 * QD_1)
                            + delta[b0][c1] * delta[a1][b1] * delta[c0][d0] * (PA_0 * QD_1)
                            + delta[b0][d0] * delta[a1][b1] * delta[c0][c1] * (PA_0 * QD_1)
                            + delta[a0][b1] * delta[c0][c1] * delta[d0][d1] * (PB_0 * PA_1 * (-1.0) + PB_0 * PQ[a1] + PA_1 * PQ[b0])
                            + delta[a0][b1] * delta[c0][d0] * delta[c1][d1] * (PB_0 * PA_1 * (-1.0) + PB_0 * PQ[a1] + PA_1 * PQ[b0])
                            + delta[a0][b1] * delta[c1][d0] * delta[c0][d1] * (PB_0 * PA_1 * (-1.0) + PB_0 * PQ[a1] + PA_1 * PQ[b0])
                            + delta[a0][b0] * delta[c0][c1] * delta[d0][d1] * (PB_1 * PA_1 * (-1.0) + PB_1 * PQ[a1] + PA_1 * PQ[b1])
                            + delta[a0][b0] * delta[c0][d0] * delta[c1][d1] * (PB_1 * PA_1 * (-1.0) + PB_1 * PQ[a1] + PA_1 * PQ[b1])
                            + delta[a0][b0] * delta[c1][d0] * delta[c0][d1] * (PB_1 * PA_1 * (-1.0) + PB_1 * PQ[a1] + PA_1 * PQ[b1])
                            + delta[a0][c1] * delta[b0][b1] * delta[d0][d1] * (PA_1 * QC_0)
                            + delta[a0][d0] * delta[b0][b1] * delta[c1][d1] * (PA_1 * QC_0)
                            + delta[a0][d1] * delta[b0][b1] * delta[c1][d0] * (PA_1 * QC_0)
                            + delta[a0][b0] * delta[b1][c1] * delta[d0][d1] * (PA_1 * QC_0)
                            + delta[a0][b0] * delta[b1][d0] * delta[c1][d1] * (PA_1 * QC_0)
                            + delta[a0][b0] * delta[b1][d1] * delta[c1][d0] * (PA_1 * QC_0)
                            + delta[b0][c1] * delta[a0][b1] * delta[d0][d1] * (PA_1 * QC_0)
                            + delta[b0][d0] * delta[a0][b1] * delta[c1][d1] * (PA_1 * QC_0)
                            + delta[b0][d1] * delta[a0][b1] * delta[c1][d0] * (PA_1 * QC_0)
                            + delta[a0][c0] * delta[b0][b1] * delta[d0][d1] * (PA_1 * QC_1)
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][d1] * (PA_1 * QC_1)
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][d0] * (PA_1 * QC_1)
                            + delta[a0][b0] * delta[b1][c0] * delta[d0][d1] * (PA_1 * QC_1)
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][d1] * (PA_1 * QC_1)
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][d0] * (PA_1 * QC_1)
                            + delta[b0][c0] * delta[a0][b1] * delta[d0][d1] * (PA_1 * QC_1)
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][d1] * (PA_1 * QC_1)
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][d0] * (PA_1 * QC_1)
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d1] * (PA_1 * QD_0)
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d1] * (PA_1 * QD_0)
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][c1] * (PA_1 * QD_0)
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d1] * (PA_1 * QD_0)
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d1] * (PA_1 * QD_0)
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][c1] * (PA_1 * QD_0)
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d1] * (PA_1 * QD_0)
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d1] * (PA_1 * QD_0)
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][c1] * (PA_1 * QD_0)
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d0] * (PA_1 * QD_1)
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d0] * (PA_1 * QD_1)
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][c1] * (PA_1 * QD_1)
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d0] * (PA_1 * QD_1)
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d0] * (PA_1 * QD_1)
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][c1] * (PA_1 * QD_1)
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d0] * (PA_1 * QD_1)
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d0] * (PA_1 * QD_1)
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][c1] * (PA_1 * QD_1)
                            + delta[a0][a1] * delta[c0][c1] * delta[d0][d1] * (PB_0 * PB_1 * (-1.0) + PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[a0][a1] * delta[c0][d0] * delta[c1][d1] * (PB_0 * PB_1 * (-1.0) + PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[a0][a1] * delta[c1][d0] * delta[c0][d1] * (PB_0 * PB_1 * (-1.0) + PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[a0][c1] * delta[a1][b1] * delta[d0][d1] * (PB_0 * QC_0)
                            + delta[a0][d0] * delta[a1][b1] * delta[c1][d1] * (PB_0 * QC_0)
                            + delta[a0][d1] * delta[a1][b1] * delta[c1][d0] * (PB_0 * QC_0)
                            + delta[a0][a1] * delta[b1][c1] * delta[d0][d1] * (PB_0 * QC_0)
                            + delta[a0][a1] * delta[b1][d0] * delta[c1][d1] * (PB_0 * QC_0)
                            + delta[a0][a1] * delta[b1][d1] * delta[c1][d0] * (PB_0 * QC_0)
                            + delta[a1][c1] * delta[a0][b1] * delta[d0][d1] * (PB_0 * QC_0)
                            + delta[a1][d0] * delta[a0][b1] * delta[c1][d1] * (PB_0 * QC_0)
                            + delta[a1][d1] * delta[a0][b1] * delta[c1][d0] * (PB_0 * QC_0)
                            + delta[a0][c0] * delta[a1][b1] * delta[d0][d1] * (PB_0 * QC_1)
                            + delta[a0][d0] * delta[a1][b1] * delta[c0][d1] * (PB_0 * QC_1)
                            + delta[a0][d1] * delta[a1][b1] * delta[c0][d0] * (PB_0 * QC_1)
                            + delta[a0][a1] * delta[b1][c0] * delta[d0][d1] * (PB_0 * QC_1)
                            + delta[a0][a1] * delta[b1][d0] * delta[c0][d1] * (PB_0 * QC_1)
                            + delta[a0][a1] * delta[b1][d1] * delta[c0][d0] * (PB_0 * QC_1)
                            + delta[a1][c0] * delta[a0][b1] * delta[d0][d1] * (PB_0 * QC_1)
                            + delta[a1][d0] * delta[a0][b1] * delta[c0][d1] * (PB_0 * QC_1)
                            + delta[a1][d1] * delta[a0][b1] * delta[c0][d0] * (PB_0 * QC_1)
                            + delta[a0][c1] * delta[a1][b0] * delta[d0][d1] * (PB_1 * QC_0)
                            + delta[a0][d0] * delta[a1][b0] * delta[c1][d1] * (PB_1 * QC_0)
                            + delta[a0][d1] * delta[a1][b0] * delta[c1][d0] * (PB_1 * QC_0)
                            + delta[a0][a1] * delta[b0][c1] * delta[d0][d1] * (PB_1 * QC_0)
                            + delta[a0][a1] * delta[b0][d0] * delta[c1][d1] * (PB_1 * QC_0)
                            + delta[a0][a1] * delta[b0][d1] * delta[c1][d0] * (PB_1 * QC_0)
                            + delta[a1][c1] * delta[a0][b0] * delta[d0][d1] * (PB_1 * QC_0)
                            + delta[a1][d0] * delta[a0][b0] * delta[c1][d1] * (PB_1 * QC_0)
                            + delta[a1][d1] * delta[a0][b0] * delta[c1][d0] * (PB_1 * QC_0)
                            + delta[a0][c0] * delta[a1][b0] * delta[d0][d1] * (PB_1 * QC_1)
                            + delta[a0][d0] * delta[a1][b0] * delta[c0][d1] * (PB_1 * QC_1)
                            + delta[a0][d1] * delta[a1][b0] * delta[c0][d0] * (PB_1 * QC_1)
                            + delta[a0][a1] * delta[b0][c0] * delta[d0][d1] * (PB_1 * QC_1)
                            + delta[a0][a1] * delta[b0][d0] * delta[c0][d1] * (PB_1 * QC_1)
                            + delta[a0][a1] * delta[b0][d1] * delta[c0][d0] * (PB_1 * QC_1)
                            + delta[a1][c0] * delta[a0][b0] * delta[d0][d1] * (PB_1 * QC_1)
                            + delta[a1][d0] * delta[a0][b0] * delta[c0][d1] * (PB_1 * QC_1)
                            + delta[a1][d1] * delta[a0][b0] * delta[c0][d0] * (PB_1 * QC_1)
                            + delta[a0][a1] * delta[b0][b1] * delta[d0][d1] * (PQ[c0] * QC_1 * (-1.0) + PQ[c1] * QC_0 * (-1.0) + QC_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[d0][d1] * (PQ[c0] * QC_1 * (-1.0) + PQ[c1] * QC_0 * (-1.0) + QC_0 * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[d0][d1] * (PQ[c0] * QC_1 * (-1.0) + PQ[c1] * QC_0 * (-1.0) + QC_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0) + QD_0 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0) + QD_0 * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0) + QD_0 * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d0] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0) + QD_1 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d0] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0) + QD_1 * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d0] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0) + QD_1 * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d1] * (PQ[c1] * QD_0 * (-1.0) + PQ[d0] * QC_1 * (-1.0) + QD_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d1] * (PQ[c1] * QD_0 * (-1.0) + PQ[d0] * QC_1 * (-1.0) + QD_0 * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d1] * (PQ[c1] * QD_0 * (-1.0) + PQ[d0] * QC_1 * (-1.0) + QD_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * (PQ[c1] * QD_1 * (-1.0) + PQ[d1] * QC_1 * (-1.0) + QD_1 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * (PQ[c1] * QD_1 * (-1.0) + PQ[d1] * QC_1 * (-1.0) + QD_1 * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * (PQ[c1] * QD_1 * (-1.0) + PQ[d1] * QC_1 * (-1.0) + QD_1 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][c1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0) + QD_0 * QD_1 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][c1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0) + QD_0 * QD_1 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][c1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0) + QD_0 * QD_1 * (-1.0))
                            + delta[a0][c0] * delta[a1][b1] * delta[c1][d1] * (PB_0 * QD_0)
                            + delta[a0][c1] * delta[a1][b1] * delta[c0][d1] * (PB_0 * QD_0)
                            + delta[a0][d1] * delta[a1][b1] * delta[c0][c1] * (PB_0 * QD_0)
                            + delta[a0][a1] * delta[b1][c0] * delta[c1][d1] * (PB_0 * QD_0)
                            + delta[a0][a1] * delta[b1][c1] * delta[c0][d1] * (PB_0 * QD_0)
                            + delta[a0][a1] * delta[b1][d1] * delta[c0][c1] * (PB_0 * QD_0)
                            + delta[a1][c0] * delta[a0][b1] * delta[c1][d1] * (PB_0 * QD_0)
                            + delta[a1][c1] * delta[a0][b1] * delta[c0][d1] * (PB_0 * QD_0)
                            + delta[a1][d1] * delta[a0][b1] * delta[c0][c1] * (PB_0 * QD_0)
                            + delta[a0][c0] * delta[a1][b1] * delta[c1][d0] * (PB_0 * QD_1)
                            + delta[a0][c1] * delta[a1][b1] * delta[c0][d0] * (PB_0 * QD_1)
                            + delta[a0][d0] * delta[a1][b1] * delta[c0][c1] * (PB_0 * QD_1)
                            + delta[a0][a1] * delta[b1][c0] * delta[c1][d0] * (PB_0 * QD_1)
                            + delta[a0][a1] * delta[b1][c1] * delta[c0][d0] * (PB_0 * QD_1)
                            + delta[a0][a1] * delta[b1][d0] * delta[c0][c1] * (PB_0 * QD_1)
                            + delta[a1][c0] * delta[a0][b1] * delta[c1][d0] * (PB_0 * QD_1)
                            + delta[a1][c1] * delta[a0][b1] * delta[c0][d0] * (PB_0 * QD_1)
                            + delta[a1][d0] * delta[a0][b1] * delta[c0][c1] * (PB_0 * QD_1)
                            + delta[a0][c0] * delta[a1][b0] * delta[c1][d1] * (PB_1 * QD_0)
                            + delta[a0][c1] * delta[a1][b0] * delta[c0][d1] * (PB_1 * QD_0)
                            + delta[a0][d1] * delta[a1][b0] * delta[c0][c1] * (PB_1 * QD_0)
                            + delta[a0][a1] * delta[b0][c0] * delta[c1][d1] * (PB_1 * QD_0)
                            + delta[a0][a1] * delta[b0][c1] * delta[c0][d1] * (PB_1 * QD_0)
                            + delta[a0][a1] * delta[b0][d1] * delta[c0][c1] * (PB_1 * QD_0)
                            + delta[a1][c0] * delta[a0][b0] * delta[c1][d1] * (PB_1 * QD_0)
                            + delta[a1][c1] * delta[a0][b0] * delta[c0][d1] * (PB_1 * QD_0)
                            + delta[a1][d1] * delta[a0][b0] * delta[c0][c1] * (PB_1 * QD_0)
                            + delta[a0][c0] * delta[a1][b0] * delta[c1][d0] * (PB_1 * QD_1)
                            + delta[a0][c1] * delta[a1][b0] * delta[c0][d0] * (PB_1 * QD_1)
                            + delta[a0][d0] * delta[a1][b0] * delta[c0][c1] * (PB_1 * QD_1)
                            + delta[a0][a1] * delta[b0][c0] * delta[c1][d0] * (PB_1 * QD_1)
                            + delta[a0][a1] * delta[b0][c1] * delta[c0][d0] * (PB_1 * QD_1)
                            + delta[a0][a1] * delta[b0][d0] * delta[c0][c1] * (PB_1 * QD_1)
                            + delta[a1][c0] * delta[a0][b0] * delta[c1][d0] * (PB_1 * QD_1)
                            + delta[a1][c1] * delta[a0][b0] * delta[c0][d0] * (PB_1 * QD_1)
                            + delta[a1][d0] * delta[a0][b0] * delta[c0][c1] * (PB_1 * QD_1)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD3(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[2];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 1, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[1] * (

                        0.125 / ( S2 * S2 * S4 ) * (
                            delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (PA_0 * PA_1 * (-2.0))
                            + delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (PA_0 * PA_1 * (-2.0))
                            + delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (PA_0 * PA_1 * (-2.0))
                            + delta[a1][b1] * delta[c0][c1] * delta[d0][d1] * (PB_0 * PA_0 * (-2.0))
                            + delta[a1][b1] * delta[c0][d0] * delta[c1][d1] * (PB_0 * PA_0 * (-2.0))
                            + delta[a1][b1] * delta[c1][d0] * delta[c0][d1] * (PB_0 * PA_0 * (-2.0))
                            + delta[a1][b0] * delta[c0][c1] * delta[d0][d1] * (PB_1 * PA_0 * (-2.0))
                            + delta[a1][b0] * delta[c0][d0] * delta[c1][d1] * (PB_1 * PA_0 * (-2.0))
                            + delta[a1][b0] * delta[c1][d0] * delta[c0][d1] * (PB_1 * PA_0 * (-2.0))
                            + delta[a0][b1] * delta[c0][c1] * delta[d0][d1] * (PB_0 * PA_1 * (-2.0))
                            + delta[a0][b1] * delta[c0][d0] * delta[c1][d1] * (PB_0 * PA_1 * (-2.0))
                            + delta[a0][b1] * delta[c1][d0] * delta[c0][d1] * (PB_0 * PA_1 * (-2.0))
                            + delta[a0][b0] * delta[c0][c1] * delta[d0][d1] * (PB_1 * PA_1 * (-2.0))
                            + delta[a0][b0] * delta[c0][d0] * delta[c1][d1] * (PB_1 * PA_1 * (-2.0))
                            + delta[a0][b0] * delta[c1][d0] * delta[c0][d1] * (PB_1 * PA_1 * (-2.0))
                            + delta[a0][a1] * delta[c0][c1] * delta[d0][d1] * (PB_0 * PB_1 * (-2.0))
                            + delta[a0][a1] * delta[c0][d0] * delta[c1][d1] * (PB_0 * PB_1 * (-2.0))
                            + delta[a0][a1] * delta[c1][d0] * delta[c0][d1] * (PB_0 * PB_1 * (-2.0))
                        )

                    )

                    +

                    F8_t[1] * (

                        0.25 * S1 / ( S2 * S2 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PA_1 * (-2.0))
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PB_1 * PA_0 * PA_1 * (-2.0))
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PA_1 * (-2.0))
                        )

                    )

                    +

                    F8_t[1] * (

                        0.25 * S2 / ( S1 * S1 * S4 ) * (
                            delta[a0][a1] * delta[b0][b1] * (QD_0 * QD_1 * QC_0 * QC_1 * (-2.0))
                            + delta[a0][b0] * delta[a1][b1] * (QD_0 * QD_1 * QC_0 * QC_1 * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * (QD_0 * QD_1 * QC_0 * QC_1 * (-2.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD4(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[2];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 1, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[1] * (

                        0.25 / ( S1 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PA_0 * PA_1 * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[a1] * QC_0 * QC_1 + PA_1 * PQ[a0] * QC_0 * QC_1)
                            + delta[b0][b1] * delta[c1][d1] * (PA_0 * PA_1 * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[a1] * QD_0 * QC_0 + PA_1 * PQ[a0] * QD_0 * QC_0)
                            + delta[b0][b1] * delta[c1][d0] * (PA_0 * PA_1 * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[a1] * QD_1 * QC_0 + PA_1 * PQ[a0] * QD_1 * QC_0)
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * PA_1 * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[a1] * QD_0 * QC_1 + PA_1 * PQ[a0] * QD_0 * QC_1)
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * PA_1 * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[a1] * QD_1 * QC_1 + PA_1 * PQ[a0] * QD_1 * QC_1)
                            + delta[b0][b1] * delta[c0][c1] * (PA_0 * PA_1 * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[a1] * QD_0 * QD_1 + PA_1 * PQ[a0] * QD_0 * QD_1)
                            + delta[a1][b1] * delta[d0][d1] * (PB_0 * PA_0 * QC_0 * QC_1 * (-1.0) + PB_0 * PQ[a0] * QC_0 * QC_1 + PA_0 * PQ[b0] * QC_0 * QC_1)
                            + delta[a1][b1] * delta[c1][d1] * (PB_0 * PA_0 * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[a0] * QD_0 * QC_0 + PA_0 * PQ[b0] * QD_0 * QC_0)
                            + delta[a1][b1] * delta[c1][d0] * (PB_0 * PA_0 * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[a0] * QD_1 * QC_0 + PA_0 * PQ[b0] * QD_1 * QC_0)
                            + delta[a1][b1] * delta[c0][d1] * (PB_0 * PA_0 * QD_0 * QC_1 * (-1.0) + PB_0 * PQ[a0] * QD_0 * QC_1 + PA_0 * PQ[b0] * QD_0 * QC_1)
                            + delta[a1][b1] * delta[c0][d0] * (PB_0 * PA_0 * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[a0] * QD_1 * QC_1 + PA_0 * PQ[b0] * QD_1 * QC_1)
                            + delta[a1][b1] * delta[c0][c1] * (PB_0 * PA_0 * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[a0] * QD_0 * QD_1 + PA_0 * PQ[b0] * QD_0 * QD_1)
                            + delta[a1][b0] * delta[d0][d1] * (PB_1 * PA_0 * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[a0] * QC_0 * QC_1 + PA_0 * PQ[b1] * QC_0 * QC_1)
                            + delta[a1][b0] * delta[c1][d1] * (PB_1 * PA_0 * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[a0] * QD_0 * QC_0 + PA_0 * PQ[b1] * QD_0 * QC_0)
                            + delta[a1][b0] * delta[c1][d0] * (PB_1 * PA_0 * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[a0] * QD_1 * QC_0 + PA_0 * PQ[b1] * QD_1 * QC_0)
                            + delta[a1][b0] * delta[c0][d1] * (PB_1 * PA_0 * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[a0] * QD_0 * QC_1 + PA_0 * PQ[b1] * QD_0 * QC_1)
                            + delta[a1][b0] * delta[c0][d0] * (PB_1 * PA_0 * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[a0] * QD_1 * QC_1 + PA_0 * PQ[b1] * QD_1 * QC_1)
                            + delta[a1][b0] * delta[c0][c1] * (PB_1 * PA_0 * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[a0] * QD_0 * QD_1 + PA_0 * PQ[b1] * QD_0 * QD_1)
                            + delta[a1][d1] * delta[b0][b1] * (PA_0 * QD_0 * QC_0 * QC_1)
                            + delta[a1][b0] * delta[b1][d1] * (PA_0 * QD_0 * QC_0 * QC_1)
                            + delta[b0][d1] * delta[a1][b1] * (PA_0 * QD_0 * QC_0 * QC_1)
                            + delta[a1][d0] * delta[b0][b1] * (PA_0 * QD_1 * QC_0 * QC_1)
                            + delta[a1][b0] * delta[b1][d0] * (PA_0 * QD_1 * QC_0 * QC_1)
                            + delta[b0][d0] * delta[a1][b1] * (PA_0 * QD_1 * QC_0 * QC_1)
                            + delta[a1][c1] * delta[b0][b1] * (PA_0 * QD_0 * QD_1 * QC_0)
                            + delta[a1][b0] * delta[b1][c1] * (PA_0 * QD_0 * QD_1 * QC_0)
                            + delta[b0][c1] * delta[a1][b1] * (PA_0 * QD_0 * QD_1 * QC_0)
                            + delta[a1][c0] * delta[b0][b1] * (PA_0 * QD_0 * QD_1 * QC_1)
                            + delta[a1][b0] * delta[b1][c0] * (PA_0 * QD_0 * QD_1 * QC_1)
                            + delta[b0][c0] * delta[a1][b1] * (PA_0 * QD_0 * QD_1 * QC_1)
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PA_1 * QC_0 * QC_1 * (-1.0) + PB_0 * PQ[a1] * QC_0 * QC_1 + PA_1 * PQ[b0] * QC_0 * QC_1)
                            + delta[a0][b1] * delta[c1][d1] * (PB_0 * PA_1 * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[a1] * QD_0 * QC_0 + PA_1 * PQ[b0] * QD_0 * QC_0)
                            + delta[a0][b1] * delta[c1][d0] * (PB_0 * PA_1 * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[a1] * QD_1 * QC_0 + PA_1 * PQ[b0] * QD_1 * QC_0)
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * PA_1 * QD_0 * QC_1 * (-1.0) + PB_0 * PQ[a1] * QD_0 * QC_1 + PA_1 * PQ[b0] * QD_0 * QC_1)
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PA_1 * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[a1] * QD_1 * QC_1 + PA_1 * PQ[b0] * QD_1 * QC_1)
                            + delta[a0][b1] * delta[c0][c1] * (PB_0 * PA_1 * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[a1] * QD_0 * QD_1 + PA_1 * PQ[b0] * QD_0 * QD_1)
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PA_1 * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[a1] * QC_0 * QC_1 + PA_1 * PQ[b1] * QC_0 * QC_1)
                            + delta[a0][b0] * delta[c1][d1] * (PB_1 * PA_1 * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[a1] * QD_0 * QC_0 + PA_1 * PQ[b1] * QD_0 * QC_0)
                            + delta[a0][b0] * delta[c1][d0] * (PB_1 * PA_1 * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[a1] * QD_1 * QC_0 + PA_1 * PQ[b1] * QD_1 * QC_0)
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * PA_1 * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[a1] * QD_0 * QC_1 + PA_1 * PQ[b1] * QD_0 * QC_1)
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PA_1 * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[a1] * QD_1 * QC_1 + PA_1 * PQ[b1] * QD_1 * QC_1)
                            + delta[a0][b0] * delta[c0][c1] * (PB_1 * PA_1 * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[a1] * QD_0 * QD_1 + PA_1 * PQ[b1] * QD_0 * QD_1)
                            + delta[a0][d1] * delta[b0][b1] * (PA_1 * QD_0 * QC_0 * QC_1)
                            + delta[a0][b0] * delta[b1][d1] * (PA_1 * QD_0 * QC_0 * QC_1)
                            + delta[b0][d1] * delta[a0][b1] * (PA_1 * QD_0 * QC_0 * QC_1)
                            + delta[a0][d0] * delta[b0][b1] * (PA_1 * QD_1 * QC_0 * QC_1)
                            + delta[a0][b0] * delta[b1][d0] * (PA_1 * QD_1 * QC_0 * QC_1)
                            + delta[b0][d0] * delta[a0][b1] * (PA_1 * QD_1 * QC_0 * QC_1)
                            + delta[a0][c1] * delta[b0][b1] * (PA_1 * QD_0 * QD_1 * QC_0)
                            + delta[a0][b0] * delta[b1][c1] * (PA_1 * QD_0 * QD_1 * QC_0)
                            + delta[b0][c1] * delta[a0][b1] * (PA_1 * QD_0 * QD_1 * QC_0)
                            + delta[a0][c0] * delta[b0][b1] * (PA_1 * QD_0 * QD_1 * QC_1)
                            + delta[a0][b0] * delta[b1][c0] * (PA_1 * QD_0 * QD_1 * QC_1)
                            + delta[b0][c0] * delta[a0][b1] * (PA_1 * QD_0 * QD_1 * QC_1)
                            + delta[a0][a1] * delta[d0][d1] * (PB_0 * PB_1 * QC_0 * QC_1 * (-1.0) + PB_0 * PQ[b1] * QC_0 * QC_1 + PB_1 * PQ[b0] * QC_0 * QC_1)
                            + delta[a0][a1] * delta[c1][d1] * (PB_0 * PB_1 * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[b1] * QD_0 * QC_0 + PB_1 * PQ[b0] * QD_0 * QC_0)
                            + delta[a0][a1] * delta[c1][d0] * (PB_0 * PB_1 * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[b1] * QD_1 * QC_0 + PB_1 * PQ[b0] * QD_1 * QC_0)
                            + delta[a0][a1] * delta[c0][d1] * (PB_0 * PB_1 * QD_0 * QC_1 * (-1.0) + PB_0 * PQ[b1] * QD_0 * QC_1 + PB_1 * PQ[b0] * QD_0 * QC_1)
                            + delta[a0][a1] * delta[c0][d0] * (PB_0 * PB_1 * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[b1] * QD_1 * QC_1 + PB_1 * PQ[b0] * QD_1 * QC_1)
                            + delta[a0][a1] * delta[c0][c1] * (PB_0 * PB_1 * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[b1] * QD_0 * QD_1 + PB_1 * PQ[b0] * QD_0 * QD_1)
                            + delta[a0][d1] * delta[a1][b1] * (PB_0 * QD_0 * QC_0 * QC_1)
                            + delta[a0][a1] * delta[b1][d1] * (PB_0 * QD_0 * QC_0 * QC_1)
                            + delta[a1][d1] * delta[a0][b1] * (PB_0 * QD_0 * QC_0 * QC_1)
                            + delta[a0][d0] * delta[a1][b1] * (PB_0 * QD_1 * QC_0 * QC_1)
                            + delta[a0][a1] * delta[b1][d0] * (PB_0 * QD_1 * QC_0 * QC_1)
                            + delta[a1][d0] * delta[a0][b1] * (PB_0 * QD_1 * QC_0 * QC_1)
                            + delta[a0][c1] * delta[a1][b1] * (PB_0 * QD_0 * QD_1 * QC_0)
                            + delta[a0][a1] * delta[b1][c1] * (PB_0 * QD_0 * QD_1 * QC_0)
                            + delta[a1][c1] * delta[a0][b1] * (PB_0 * QD_0 * QD_1 * QC_0)
                            + delta[a0][c0] * delta[a1][b1] * (PB_0 * QD_0 * QD_1 * QC_1)
                            + delta[a0][a1] * delta[b1][c0] * (PB_0 * QD_0 * QD_1 * QC_1)
                            + delta[a1][c0] * delta[a0][b1] * (PB_0 * QD_0 * QD_1 * QC_1)
                            + delta[a0][d1] * delta[a1][b0] * (PB_1 * QD_0 * QC_0 * QC_1)
                            + delta[a0][a1] * delta[b0][d1] * (PB_1 * QD_0 * QC_0 * QC_1)
                            + delta[a1][d1] * delta[a0][b0] * (PB_1 * QD_0 * QC_0 * QC_1)
                            + delta[a0][d0] * delta[a1][b0] * (PB_1 * QD_1 * QC_0 * QC_1)
                            + delta[a0][a1] * delta[b0][d0] * (PB_1 * QD_1 * QC_0 * QC_1)
                            + delta[a1][d0] * delta[a0][b0] * (PB_1 * QD_1 * QC_0 * QC_1)
                            + delta[a0][c1] * delta[a1][b0] * (PB_1 * QD_0 * QD_1 * QC_0)
                            + delta[a0][a1] * delta[b0][c1] * (PB_1 * QD_0 * QD_1 * QC_0)
                            + delta[a1][c1] * delta[a0][b0] * (PB_1 * QD_0 * QD_1 * QC_0)
                            + delta[a0][c0] * delta[a1][b0] * (PB_1 * QD_0 * QD_1 * QC_1)
                            + delta[a0][a1] * delta[b0][c0] * (PB_1 * QD_0 * QD_1 * QC_1)
                            + delta[a1][c0] * delta[a0][b0] * (PB_1 * QD_0 * QD_1 * QC_1)
                            + delta[a0][a1] * delta[b0][b1] * (PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * (PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * (PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD5(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[2];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 1, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[1] * (

                        0.25 / ( S2 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] + PB_0 * PB_1 * PA_1 * PQ[a0] + PB_0 * PA_0 * PA_1 * PQ[b1] + PB_1 * PA_0 * PA_1 * PQ[b0])
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] + PB_0 * PB_1 * PA_1 * PQ[a0] + PB_0 * PA_0 * PA_1 * PQ[b1] + PB_1 * PA_0 * PA_1 * PQ[b0])
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] + PB_0 * PB_1 * PA_1 * PQ[a0] + PB_0 * PA_0 * PA_1 * PQ[b1] + PB_1 * PA_0 * PA_1 * PQ[b0])
                            + delta[b1][c1] * delta[d0][d1] * (PB_0 * PA_0 * PA_1 * QC_0)
                            + delta[b1][d0] * delta[c1][d1] * (PB_0 * PA_0 * PA_1 * QC_0)
                            + delta[b1][d1] * delta[c1][d0] * (PB_0 * PA_0 * PA_1 * QC_0)
                            + delta[b1][c0] * delta[d0][d1] * (PB_0 * PA_0 * PA_1 * QC_1)
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * PA_0 * PA_1 * QC_1)
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * PA_0 * PA_1 * QC_1)
                            + delta[b1][c0] * delta[c1][d1] * (PB_0 * PA_0 * PA_1 * QD_0)
                            + delta[b1][c1] * delta[c0][d1] * (PB_0 * PA_0 * PA_1 * QD_0)
                            + delta[b1][d1] * delta[c0][c1] * (PB_0 * PA_0 * PA_1 * QD_0)
                            + delta[b1][c0] * delta[c1][d0] * (PB_0 * PA_0 * PA_1 * QD_1)
                            + delta[b1][c1] * delta[c0][d0] * (PB_0 * PA_0 * PA_1 * QD_1)
                            + delta[b1][d0] * delta[c0][c1] * (PB_0 * PA_0 * PA_1 * QD_1)
                            + delta[b0][c1] * delta[d0][d1] * (PB_1 * PA_0 * PA_1 * QC_0)
                            + delta[b0][d0] * delta[c1][d1] * (PB_1 * PA_0 * PA_1 * QC_0)
                            + delta[b0][d1] * delta[c1][d0] * (PB_1 * PA_0 * PA_1 * QC_0)
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * PA_0 * PA_1 * QC_1)
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * PA_0 * PA_1 * QC_1)
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * PA_0 * PA_1 * QC_1)
                            + delta[b0][c0] * delta[c1][d1] * (PB_1 * PA_0 * PA_1 * QD_0)
                            + delta[b0][c1] * delta[c0][d1] * (PB_1 * PA_0 * PA_1 * QD_0)
                            + delta[b0][d1] * delta[c0][c1] * (PB_1 * PA_0 * PA_1 * QD_0)
                            + delta[b0][c0] * delta[c1][d0] * (PB_1 * PA_0 * PA_1 * QD_1)
                            + delta[b0][c1] * delta[c0][d0] * (PB_1 * PA_0 * PA_1 * QD_1)
                            + delta[b0][d0] * delta[c0][c1] * (PB_1 * PA_0 * PA_1 * QD_1)
                            + delta[b0][b1] * delta[d0][d1] * (PA_0 * PA_1 * PQ[c0] * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[c1] * QC_0 * (-1.0) + PA_0 * PA_1 * QC_0 * QC_1 * (-1.0))
                            + delta[b0][b1] * delta[c1][d1] * (PA_0 * PA_1 * PQ[c0] * QD_0 * (-1.0) + PA_0 * PA_1 * PQ[d0] * QC_0 * (-1.0) + PA_0 * PA_1 * QD_0 * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c1][d0] * (PA_0 * PA_1 * PQ[c0] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[d1] * QC_0 * (-1.0) + PA_0 * PA_1 * QD_1 * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * PA_1 * PQ[c1] * QD_0 * (-1.0) + PA_0 * PA_1 * PQ[d0] * QC_1 * (-1.0) + PA_0 * PA_1 * QD_0 * QC_1 * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * PA_1 * PQ[c1] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[d1] * QC_1 * (-1.0) + PA_0 * PA_1 * QD_1 * QC_1 * (-1.0))
                            + delta[b0][b1] * delta[c0][c1] * (PA_0 * PA_1 * PQ[d0] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[d1] * QD_0 * (-1.0) + PA_0 * PA_1 * QD_0 * QD_1 * (-1.0))
                            + delta[a1][c1] * delta[d0][d1] * (PB_0 * PB_1 * PA_0 * QC_0)
                            + delta[a1][d0] * delta[c1][d1] * (PB_0 * PB_1 * PA_0 * QC_0)
                            + delta[a1][d1] * delta[c1][d0] * (PB_0 * PB_1 * PA_0 * QC_0)
                            + delta[a1][c0] * delta[d0][d1] * (PB_0 * PB_1 * PA_0 * QC_1)
                            + delta[a1][d0] * delta[c0][d1] * (PB_0 * PB_1 * PA_0 * QC_1)
                            + delta[a1][d1] * delta[c0][d0] * (PB_0 * PB_1 * PA_0 * QC_1)
                            + delta[a1][c0] * delta[c1][d1] * (PB_0 * PB_1 * PA_0 * QD_0)
                            + delta[a1][c1] * delta[c0][d1] * (PB_0 * PB_1 * PA_0 * QD_0)
                            + delta[a1][d1] * delta[c0][c1] * (PB_0 * PB_1 * PA_0 * QD_0)
                            + delta[a1][c0] * delta[c1][d0] * (PB_0 * PB_1 * PA_0 * QD_1)
                            + delta[a1][c1] * delta[c0][d0] * (PB_0 * PB_1 * PA_0 * QD_1)
                            + delta[a1][d0] * delta[c0][c1] * (PB_0 * PB_1 * PA_0 * QD_1)
                            + delta[a1][b1] * delta[d0][d1] * (PB_0 * PA_0 * PQ[c0] * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[c1] * QC_0 * (-1.0) + PB_0 * PA_0 * QC_0 * QC_1 * (-1.0))
                            + delta[a1][b1] * delta[c1][d1] * (PB_0 * PA_0 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[d0] * QC_0 * (-1.0) + PB_0 * PA_0 * QD_0 * QC_0 * (-1.0))
                            + delta[a1][b1] * delta[c1][d0] * (PB_0 * PA_0 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[d1] * QC_0 * (-1.0) + PB_0 * PA_0 * QD_1 * QC_0 * (-1.0))
                            + delta[a1][b1] * delta[c0][d1] * (PB_0 * PA_0 * PQ[c1] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[d0] * QC_1 * (-1.0) + PB_0 * PA_0 * QD_0 * QC_1 * (-1.0))
                            + delta[a1][b1] * delta[c0][d0] * (PB_0 * PA_0 * PQ[c1] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[d1] * QC_1 * (-1.0) + PB_0 * PA_0 * QD_1 * QC_1 * (-1.0))
                            + delta[a1][b1] * delta[c0][c1] * (PB_0 * PA_0 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[d1] * QD_0 * (-1.0) + PB_0 * PA_0 * QD_0 * QD_1 * (-1.0))
                            + delta[a1][b0] * delta[d0][d1] * (PB_1 * PA_0 * PQ[c0] * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[c1] * QC_0 * (-1.0) + PB_1 * PA_0 * QC_0 * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[c1][d1] * (PB_1 * PA_0 * PQ[c0] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[d0] * QC_0 * (-1.0) + PB_1 * PA_0 * QD_0 * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[c1][d0] * (PB_1 * PA_0 * PQ[c0] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[d1] * QC_0 * (-1.0) + PB_1 * PA_0 * QD_1 * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[c0][d1] * (PB_1 * PA_0 * PQ[c1] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[d0] * QC_1 * (-1.0) + PB_1 * PA_0 * QD_0 * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[c0][d0] * (PB_1 * PA_0 * PQ[c1] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[d1] * QC_1 * (-1.0) + PB_1 * PA_0 * QD_1 * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[c0][c1] * (PB_1 * PA_0 * PQ[d0] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[d1] * QD_0 * (-1.0) + PB_1 * PA_0 * QD_0 * QD_1 * (-1.0))
                            + delta[a0][c1] * delta[d0][d1] * (PB_0 * PB_1 * PA_1 * QC_0)
                            + delta[a0][d0] * delta[c1][d1] * (PB_0 * PB_1 * PA_1 * QC_0)
                            + delta[a0][d1] * delta[c1][d0] * (PB_0 * PB_1 * PA_1 * QC_0)
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * PB_1 * PA_1 * QC_1)
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * PB_1 * PA_1 * QC_1)
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * PB_1 * PA_1 * QC_1)
                            + delta[a0][c0] * delta[c1][d1] * (PB_0 * PB_1 * PA_1 * QD_0)
                            + delta[a0][c1] * delta[c0][d1] * (PB_0 * PB_1 * PA_1 * QD_0)
                            + delta[a0][d1] * delta[c0][c1] * (PB_0 * PB_1 * PA_1 * QD_0)
                            + delta[a0][c0] * delta[c1][d0] * (PB_0 * PB_1 * PA_1 * QD_1)
                            + delta[a0][c1] * delta[c0][d0] * (PB_0 * PB_1 * PA_1 * QD_1)
                            + delta[a0][d0] * delta[c0][c1] * (PB_0 * PB_1 * PA_1 * QD_1)
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PA_1 * PQ[c0] * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[c1] * QC_0 * (-1.0) + PB_0 * PA_1 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][b1] * delta[c1][d1] * (PB_0 * PA_1 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PA_1 * PQ[d0] * QC_0 * (-1.0) + PB_0 * PA_1 * QD_0 * QC_0 * (-1.0))
                            + delta[a0][b1] * delta[c1][d0] * (PB_0 * PA_1 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[d1] * QC_0 * (-1.0) + PB_0 * PA_1 * QD_1 * QC_0 * (-1.0))
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * PA_1 * PQ[c1] * QD_0 * (-1.0) + PB_0 * PA_1 * PQ[d0] * QC_1 * (-1.0) + PB_0 * PA_1 * QD_0 * QC_1 * (-1.0))
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PA_1 * PQ[c1] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[d1] * QC_1 * (-1.0) + PB_0 * PA_1 * QD_1 * QC_1 * (-1.0))
                            + delta[a0][b1] * delta[c0][c1] * (PB_0 * PA_1 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[d1] * QD_0 * (-1.0) + PB_0 * PA_1 * QD_0 * QD_1 * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PA_1 * PQ[c0] * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[c1] * QC_0 * (-1.0) + PB_1 * PA_1 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[c1][d1] * (PB_1 * PA_1 * PQ[c0] * QD_0 * (-1.0) + PB_1 * PA_1 * PQ[d0] * QC_0 * (-1.0) + PB_1 * PA_1 * QD_0 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c1][d0] * (PB_1 * PA_1 * PQ[c0] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[d1] * QC_0 * (-1.0) + PB_1 * PA_1 * QD_1 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * PA_1 * PQ[c1] * QD_0 * (-1.0) + PB_1 * PA_1 * PQ[d0] * QC_1 * (-1.0) + PB_1 * PA_1 * QD_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PA_1 * PQ[c1] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[d1] * QC_1 * (-1.0) + PB_1 * PA_1 * QD_1 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[c0][c1] * (PB_1 * PA_1 * PQ[d0] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[d1] * QD_0 * (-1.0) + PB_1 * PA_1 * QD_0 * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[d0][d1] * (PB_0 * PB_1 * PQ[c0] * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[c1] * QC_0 * (-1.0) + PB_0 * PB_1 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[c1][d1] * (PB_0 * PB_1 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PB_1 * PQ[d0] * QC_0 * (-1.0) + PB_0 * PB_1 * QD_0 * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[c1][d0] * (PB_0 * PB_1 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[d1] * QC_0 * (-1.0) + PB_0 * PB_1 * QD_1 * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[c0][d1] * (PB_0 * PB_1 * PQ[c1] * QD_0 * (-1.0) + PB_0 * PB_1 * PQ[d0] * QC_1 * (-1.0) + PB_0 * PB_1 * QD_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[c0][d0] * (PB_0 * PB_1 * PQ[c1] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[d1] * QC_1 * (-1.0) + PB_0 * PB_1 * QD_1 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[c0][c1] * (PB_0 * PB_1 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[d1] * QD_0 * (-1.0) + PB_0 * PB_1 * QD_0 * QD_1 * (-1.0))
                        )

                    )

                    +

                    F8_t[1] * (

                        0.5 * S1 / ( S2 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0] * QC_1 * (-1.0) + PB_0 * PB_1 * PA_0 * PA_1 * PQ[c1] * QC_0 * (-1.0) + PB_0 * PB_1 * PA_0 * PA_1 * QC_0 * QC_1 * (-1.0))
                            + delta[c1][d1] * (PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PB_1 * PA_0 * PA_1 * PQ[d0] * QC_0 * (-1.0) + PB_0 * PB_1 * PA_0 * PA_1 * QD_0 * QC_0 * (-1.0))
                            + delta[c1][d0] * (PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PB_1 * PA_0 * PA_1 * PQ[d1] * QC_0 * (-1.0) + PB_0 * PB_1 * PA_0 * PA_1 * QD_1 * QC_0 * (-1.0))
                            + delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PA_1 * PQ[c1] * QD_0 * (-1.0) + PB_0 * PB_1 * PA_0 * PA_1 * PQ[d0] * QC_1 * (-1.0) + PB_0 * PB_1 * PA_0 * PA_1 * QD_0 * QC_1 * (-1.0))
                            + delta[c0][d0] * (PB_0 * PB_1 * PA_0 * PA_1 * PQ[c1] * QD_1 * (-1.0) + PB_0 * PB_1 * PA_0 * PA_1 * PQ[d1] * QC_1 * (-1.0) + PB_0 * PB_1 * PA_0 * PA_1 * QD_1 * QC_1 * (-1.0))
                            + delta[c0][c1] * (PB_0 * PB_1 * PA_0 * PA_1 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PB_1 * PA_0 * PA_1 * PQ[d1] * QD_0 * (-1.0) + PB_0 * PB_1 * PA_0 * PA_1 * QD_0 * QD_1 * (-1.0))
                        )

                    )

                    +

                    F8_t[1] * (

                        0.5 * S2 / ( S1 * S4 ) * (
                            delta[b0][b1] * (PA_0 * PA_1 * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[a1] * QD_0 * QD_1 * QC_0 * QC_1 + PA_1 * PQ[a0] * QD_0 * QD_1 * QC_0 * QC_1)
                            + delta[a1][b1] * (PB_0 * PA_0 * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0) + PB_0 * PQ[a0] * QD_0 * QD_1 * QC_0 * QC_1 + PA_0 * PQ[b0] * QD_0 * QD_1 * QC_0 * QC_1)
                            + delta[a1][b0] * (PB_1 * PA_0 * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[a0] * QD_0 * QD_1 * QC_0 * QC_1 + PA_0 * PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1)
                            + delta[a0][b1] * (PB_0 * PA_1 * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0) + PB_0 * PQ[a1] * QD_0 * QD_1 * QC_0 * QC_1 + PA_1 * PQ[b0] * QD_0 * QD_1 * QC_0 * QC_1)
                            + delta[a0][b0] * (PB_1 * PA_1 * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[a1] * QD_0 * QD_1 * QC_0 * QC_1 + PA_1 * PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1)
                            + delta[a0][a1] * (PB_0 * PB_1 * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0) + PB_0 * PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1 + PB_1 * PQ[b0] * QD_0 * QD_1 * QC_0 * QC_1)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD6(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[3];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[1] * (

                        0.5 / S4 * (
                            delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] * QC_0 * QC_1 + PB_0 * PB_1 * PA_1 * PQ[a0] * QC_0 * QC_1 + PB_0 * PA_0 * PA_1 * PQ[b1] * QC_0 * QC_1 + PB_1 * PA_0 * PA_1 * PQ[b0] * QC_0 * QC_1)
                            + delta[c1][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] * QD_0 * QC_0 + PB_0 * PB_1 * PA_1 * PQ[a0] * QD_0 * QC_0 + PB_0 * PA_0 * PA_1 * PQ[b1] * QD_0 * QC_0 + PB_1 * PA_0 * PA_1 * PQ[b0] * QD_0 * QC_0)
                            + delta[c1][d0] * (PB_0 * PB_1 * PA_0 * PQ[a1] * QD_1 * QC_0 + PB_0 * PB_1 * PA_1 * PQ[a0] * QD_1 * QC_0 + PB_0 * PA_0 * PA_1 * PQ[b1] * QD_1 * QC_0 + PB_1 * PA_0 * PA_1 * PQ[b0] * QD_1 * QC_0)
                            + delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] * QD_0 * QC_1 + PB_0 * PB_1 * PA_1 * PQ[a0] * QD_0 * QC_1 + PB_0 * PA_0 * PA_1 * PQ[b1] * QD_0 * QC_1 + PB_1 * PA_0 * PA_1 * PQ[b0] * QD_0 * QC_1)
                            + delta[c0][d0] * (PB_0 * PB_1 * PA_0 * PQ[a1] * QD_1 * QC_1 + PB_0 * PB_1 * PA_1 * PQ[a0] * QD_1 * QC_1 + PB_0 * PA_0 * PA_1 * PQ[b1] * QD_1 * QC_1 + PB_1 * PA_0 * PA_1 * PQ[b0] * QD_1 * QC_1)
                            + delta[c0][c1] * (PB_0 * PB_1 * PA_0 * PQ[a1] * QD_0 * QD_1 + PB_0 * PB_1 * PA_1 * PQ[a0] * QD_0 * QD_1 + PB_0 * PA_0 * PA_1 * PQ[b1] * QD_0 * QD_1 + PB_1 * PA_0 * PA_1 * PQ[b0] * QD_0 * QD_1)
                            + delta[b1][d1] * (PB_0 * PA_0 * PA_1 * QD_0 * QC_0 * QC_1)
                            + delta[b1][d0] * (PB_0 * PA_0 * PA_1 * QD_1 * QC_0 * QC_1)
                            + delta[b1][c1] * (PB_0 * PA_0 * PA_1 * QD_0 * QD_1 * QC_0)
                            + delta[b1][c0] * (PB_0 * PA_0 * PA_1 * QD_0 * QD_1 * QC_1)
                            + delta[b0][d1] * (PB_1 * PA_0 * PA_1 * QD_0 * QC_0 * QC_1)
                            + delta[b0][d0] * (PB_1 * PA_0 * PA_1 * QD_1 * QC_0 * QC_1)
                            + delta[b0][c1] * (PB_1 * PA_0 * PA_1 * QD_0 * QD_1 * QC_0)
                            + delta[b0][c0] * (PB_1 * PA_0 * PA_1 * QD_0 * QD_1 * QC_1)
                            + delta[b0][b1] * (PA_0 * PA_1 * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0))
                            + delta[a1][d1] * (PB_0 * PB_1 * PA_0 * QD_0 * QC_0 * QC_1)
                            + delta[a1][d0] * (PB_0 * PB_1 * PA_0 * QD_1 * QC_0 * QC_1)
                            + delta[a1][c1] * (PB_0 * PB_1 * PA_0 * QD_0 * QD_1 * QC_0)
                            + delta[a1][c0] * (PB_0 * PB_1 * PA_0 * QD_0 * QD_1 * QC_1)
                            + delta[a1][b1] * (PB_0 * PA_0 * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0))
                            + delta[a1][b0] * (PB_1 * PA_0 * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][d1] * (PB_0 * PB_1 * PA_1 * QD_0 * QC_0 * QC_1)
                            + delta[a0][d0] * (PB_0 * PB_1 * PA_1 * QD_1 * QC_0 * QC_1)
                            + delta[a0][c1] * (PB_0 * PB_1 * PA_1 * QD_0 * QD_1 * QC_0)
                            + delta[a0][c0] * (PB_0 * PB_1 * PA_1 * QD_0 * QD_1 * QC_1)
                            + delta[a0][b1] * (PB_0 * PA_1 * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * (PB_1 * PA_1 * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * (PB_0 * PB_1 * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PB_0 * PB_1 * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0))
                        )

                    )

                    +

                    F8_t[1] * (

                        S1 / S4 * (
                            
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                        )

                    )

                    +

                    F8_t[1] * (

                        S2 / S4 * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * QD_0 * QD_1 * QC_0 * QC_1
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * QD_0 * QD_1 * QC_0 * QC_1
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * QD_0 * QD_1 * QC_0 * QC_1
                        )

                    )

                    +

                    F8_t[2] * (

                        ( S1 * S1 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[d0] * PQ[d1] * QC_0 * QC_1
                        )

                    )

                    +

                    F8_t[2] * (

                        ( S1 * S2 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                        )

                    )

                    +

                    F8_t[2] * (

                        ( S2 * S2 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * QD_0 * QD_1 * QC_0 * QC_1
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * QD_0 * QD_1 * QC_0 * QC_1
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * QD_0 * QD_1 * QC_0 * QC_1
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1
                        )

                    )

                    +

                    F8_t[2] * (

                        0.125 * S1 / ( S2 * S2 * S4 * S4 ) * (
                            delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (PA_0 * PA_1)
                            + delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (PA_0 * PA_1)
                            + delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (PA_0 * PA_1)
                            + delta[a1][b1] * delta[c0][c1] * delta[d0][d1] * (PB_0 * PA_0)
                            + delta[a1][b1] * delta[c0][d0] * delta[c1][d1] * (PB_0 * PA_0)
                            + delta[a1][b1] * delta[c1][d0] * delta[c0][d1] * (PB_0 * PA_0)
                            + delta[a1][b0] * delta[c0][c1] * delta[d0][d1] * (PB_1 * PA_0)
                            + delta[a1][b0] * delta[c0][d0] * delta[c1][d1] * (PB_1 * PA_0)
                            + delta[a1][b0] * delta[c1][d0] * delta[c0][d1] * (PB_1 * PA_0)
                            + delta[a0][b1] * delta[c0][c1] * delta[d0][d1] * (PB_0 * PA_1)
                            + delta[a0][b1] * delta[c0][d0] * delta[c1][d1] * (PB_0 * PA_1)
                            + delta[a0][b1] * delta[c1][d0] * delta[c0][d1] * (PB_0 * PA_1)
                            + delta[a0][b0] * delta[c0][c1] * delta[d0][d1] * (PB_1 * PA_1)
                            + delta[a0][b0] * delta[c0][d0] * delta[c1][d1] * (PB_1 * PA_1)
                            + delta[a0][b0] * delta[c1][d0] * delta[c0][d1] * (PB_1 * PA_1)
                            + delta[a0][a1] * delta[c0][c1] * delta[d0][d1] * (PB_0 * PB_1)
                            + delta[a0][a1] * delta[c0][d0] * delta[c1][d1] * (PB_0 * PB_1)
                            + delta[a0][a1] * delta[c1][d0] * delta[c0][d1] * (PB_0 * PB_1)
                        )

                    )

                    +

                    F8_t[2] * (

                        0.125 * S2 / ( S1 * S1 * S4 * S4 ) * (
                            delta[a0][a1] * delta[b0][b1] * delta[d0][d1] * (QC_0 * QC_1)
                            + delta[a0][b0] * delta[a1][b1] * delta[d0][d1] * (QC_0 * QC_1)
                            + delta[a1][b0] * delta[a0][b1] * delta[d0][d1] * (QC_0 * QC_1)
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d1] * (QD_0 * QC_0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d1] * (QD_0 * QC_0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d1] * (QD_0 * QC_0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d0] * (QD_1 * QC_0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d0] * (QD_1 * QC_0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d0] * (QD_1 * QC_0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d1] * (QD_0 * QC_1)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d1] * (QD_0 * QC_1)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d1] * (QD_0 * QC_1)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * (QD_1 * QC_1)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * (QD_1 * QC_1)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * (QD_1 * QC_1)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][c1] * (QD_0 * QD_1)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][c1] * (QD_0 * QD_1)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][c1] * (QD_0 * QD_1)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD7(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[3];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[2] * (

                        0.125 / ( S1 * S4 * S4 ) * (
                            delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (PA_0 * PQ[a1] * (-1.0) + PA_1 * PQ[a0] * (-1.0) + PQ[a0] * PQ[a1])
                            + delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (PA_0 * PQ[a1] * (-1.0) + PA_1 * PQ[a0] * (-1.0) + PQ[a0] * PQ[a1])
                            + delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (PA_0 * PQ[a1] * (-1.0) + PA_1 * PQ[a0] * (-1.0) + PQ[a0] * PQ[a1])
                            + delta[a1][b1] * delta[c0][c1] * delta[d0][d1] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0) + PQ[a0] * PQ[b0])
                            + delta[a1][b1] * delta[c0][d0] * delta[c1][d1] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0) + PQ[a0] * PQ[b0])
                            + delta[a1][b1] * delta[c1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0) + PQ[a0] * PQ[b0])
                            + delta[a1][b0] * delta[c0][c1] * delta[d0][d1] * (PB_1 * PQ[a0] * (-1.0) + PA_0 * PQ[b1] * (-1.0) + PQ[a0] * PQ[b1])
                            + delta[a1][b0] * delta[c0][d0] * delta[c1][d1] * (PB_1 * PQ[a0] * (-1.0) + PA_0 * PQ[b1] * (-1.0) + PQ[a0] * PQ[b1])
                            + delta[a1][b0] * delta[c1][d0] * delta[c0][d1] * (PB_1 * PQ[a0] * (-1.0) + PA_0 * PQ[b1] * (-1.0) + PQ[a0] * PQ[b1])
                            + delta[a1][c1] * delta[b0][b1] * delta[d0][d1] * (PA_0 * QC_0 * (-1.0) + PQ[a0] * QC_0)
                            + delta[a1][d0] * delta[b0][b1] * delta[c1][d1] * (PA_0 * QC_0 * (-1.0) + PQ[a0] * QC_0)
                            + delta[a1][d1] * delta[b0][b1] * delta[c1][d0] * (PA_0 * QC_0 * (-1.0) + PQ[a0] * QC_0)
                            + delta[a1][b0] * delta[b1][c1] * delta[d0][d1] * (PA_0 * QC_0 * (-1.0) + PQ[a0] * QC_0)
                            + delta[a1][b0] * delta[b1][d0] * delta[c1][d1] * (PA_0 * QC_0 * (-1.0) + PQ[a0] * QC_0)
                            + delta[a1][b0] * delta[b1][d1] * delta[c1][d0] * (PA_0 * QC_0 * (-1.0) + PQ[a0] * QC_0)
                            + delta[b0][c1] * delta[a1][b1] * delta[d0][d1] * (PA_0 * QC_0 * (-1.0) + PQ[a0] * QC_0)
                            + delta[b0][d0] * delta[a1][b1] * delta[c1][d1] * (PA_0 * QC_0 * (-1.0) + PQ[a0] * QC_0)
                            + delta[b0][d1] * delta[a1][b1] * delta[c1][d0] * (PA_0 * QC_0 * (-1.0) + PQ[a0] * QC_0)
                            + delta[a1][c0] * delta[b0][b1] * delta[d0][d1] * (PA_0 * QC_1 * (-1.0) + PQ[a0] * QC_1)
                            + delta[a1][d0] * delta[b0][b1] * delta[c0][d1] * (PA_0 * QC_1 * (-1.0) + PQ[a0] * QC_1)
                            + delta[a1][d1] * delta[b0][b1] * delta[c0][d0] * (PA_0 * QC_1 * (-1.0) + PQ[a0] * QC_1)
                            + delta[a1][b0] * delta[b1][c0] * delta[d0][d1] * (PA_0 * QC_1 * (-1.0) + PQ[a0] * QC_1)
                            + delta[a1][b0] * delta[b1][d0] * delta[c0][d1] * (PA_0 * QC_1 * (-1.0) + PQ[a0] * QC_1)
                            + delta[a1][b0] * delta[b1][d1] * delta[c0][d0] * (PA_0 * QC_1 * (-1.0) + PQ[a0] * QC_1)
                            + delta[b0][c0] * delta[a1][b1] * delta[d0][d1] * (PA_0 * QC_1 * (-1.0) + PQ[a0] * QC_1)
                            + delta[b0][d0] * delta[a1][b1] * delta[c0][d1] * (PA_0 * QC_1 * (-1.0) + PQ[a0] * QC_1)
                            + delta[b0][d1] * delta[a1][b1] * delta[c0][d0] * (PA_0 * QC_1 * (-1.0) + PQ[a0] * QC_1)
                            + delta[a1][c0] * delta[b0][b1] * delta[c1][d1] * (PA_0 * QD_0 * (-1.0) + PQ[a0] * QD_0)
                            + delta[a1][c1] * delta[b0][b1] * delta[c0][d1] * (PA_0 * QD_0 * (-1.0) + PQ[a0] * QD_0)
                            + delta[a1][d1] * delta[b0][b1] * delta[c0][c1] * (PA_0 * QD_0 * (-1.0) + PQ[a0] * QD_0)
                            + delta[a1][b0] * delta[b1][c0] * delta[c1][d1] * (PA_0 * QD_0 * (-1.0) + PQ[a0] * QD_0)
                            + delta[a1][b0] * delta[b1][c1] * delta[c0][d1] * (PA_0 * QD_0 * (-1.0) + PQ[a0] * QD_0)
                            + delta[a1][b0] * delta[b1][d1] * delta[c0][c1] * (PA_0 * QD_0 * (-1.0) + PQ[a0] * QD_0)
                            + delta[b0][c0] * delta[a1][b1] * delta[c1][d1] * (PA_0 * QD_0 * (-1.0) + PQ[a0] * QD_0)
                            + delta[b0][c1] * delta[a1][b1] * delta[c0][d1] * (PA_0 * QD_0 * (-1.0) + PQ[a0] * QD_0)
                            + delta[b0][d1] * delta[a1][b1] * delta[c0][c1] * (PA_0 * QD_0 * (-1.0) + PQ[a0] * QD_0)
                            + delta[a1][c0] * delta[b0][b1] * delta[c1][d0] * (PA_0 * QD_1 * (-1.0) + PQ[a0] * QD_1)
                            + delta[a1][c1] * delta[b0][b1] * delta[c0][d0] * (PA_0 * QD_1 * (-1.0) + PQ[a0] * QD_1)
                            + delta[a1][d0] * delta[b0][b1] * delta[c0][c1] * (PA_0 * QD_1 * (-1.0) + PQ[a0] * QD_1)
                            + delta[a1][b0] * delta[b1][c0] * delta[c1][d0] * (PA_0 * QD_1 * (-1.0) + PQ[a0] * QD_1)
                            + delta[a1][b0] * delta[b1][c1] * delta[c0][d0] * (PA_0 * QD_1 * (-1.0) + PQ[a0] * QD_1)
                            + delta[a1][b0] * delta[b1][d0] * delta[c0][c1] * (PA_0 * QD_1 * (-1.0) + PQ[a0] * QD_1)
                            + delta[b0][c0] * delta[a1][b1] * delta[c1][d0] * (PA_0 * QD_1 * (-1.0) + PQ[a0] * QD_1)
                            + delta[b0][c1] * delta[a1][b1] * delta[c0][d0] * (PA_0 * QD_1 * (-1.0) + PQ[a0] * QD_1)
                            + delta[b0][d0] * delta[a1][b1] * delta[c0][c1] * (PA_0 * QD_1 * (-1.0) + PQ[a0] * QD_1)
                            + delta[a0][b1] * delta[c0][c1] * delta[d0][d1] * (PB_0 * PQ[a1] * (-1.0) + PA_1 * PQ[b0] * (-1.0) + PQ[a1] * PQ[b0])
                            + delta[a0][b1] * delta[c0][d0] * delta[c1][d1] * (PB_0 * PQ[a1] * (-1.0) + PA_1 * PQ[b0] * (-1.0) + PQ[a1] * PQ[b0])
                            + delta[a0][b1] * delta[c1][d0] * delta[c0][d1] * (PB_0 * PQ[a1] * (-1.0) + PA_1 * PQ[b0] * (-1.0) + PQ[a1] * PQ[b0])
                            + delta[a0][b0] * delta[c0][c1] * delta[d0][d1] * (PB_1 * PQ[a1] * (-1.0) + PA_1 * PQ[b1] * (-1.0) + PQ[a1] * PQ[b1])
                            + delta[a0][b0] * delta[c0][d0] * delta[c1][d1] * (PB_1 * PQ[a1] * (-1.0) + PA_1 * PQ[b1] * (-1.0) + PQ[a1] * PQ[b1])
                            + delta[a0][b0] * delta[c1][d0] * delta[c0][d1] * (PB_1 * PQ[a1] * (-1.0) + PA_1 * PQ[b1] * (-1.0) + PQ[a1] * PQ[b1])
                            + delta[a0][c1] * delta[b0][b1] * delta[d0][d1] * (PA_1 * QC_0 * (-1.0) + PQ[a1] * QC_0)
                            + delta[a0][d0] * delta[b0][b1] * delta[c1][d1] * (PA_1 * QC_0 * (-1.0) + PQ[a1] * QC_0)
                            + delta[a0][d1] * delta[b0][b1] * delta[c1][d0] * (PA_1 * QC_0 * (-1.0) + PQ[a1] * QC_0)
                            + delta[a0][b0] * delta[b1][c1] * delta[d0][d1] * (PA_1 * QC_0 * (-1.0) + PQ[a1] * QC_0)
                            + delta[a0][b0] * delta[b1][d0] * delta[c1][d1] * (PA_1 * QC_0 * (-1.0) + PQ[a1] * QC_0)
                            + delta[a0][b0] * delta[b1][d1] * delta[c1][d0] * (PA_1 * QC_0 * (-1.0) + PQ[a1] * QC_0)
                            + delta[b0][c1] * delta[a0][b1] * delta[d0][d1] * (PA_1 * QC_0 * (-1.0) + PQ[a1] * QC_0)
                            + delta[b0][d0] * delta[a0][b1] * delta[c1][d1] * (PA_1 * QC_0 * (-1.0) + PQ[a1] * QC_0)
                            + delta[b0][d1] * delta[a0][b1] * delta[c1][d0] * (PA_1 * QC_0 * (-1.0) + PQ[a1] * QC_0)
                            + delta[a0][c0] * delta[b0][b1] * delta[d0][d1] * (PA_1 * QC_1 * (-1.0) + PQ[a1] * QC_1)
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][d1] * (PA_1 * QC_1 * (-1.0) + PQ[a1] * QC_1)
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][d0] * (PA_1 * QC_1 * (-1.0) + PQ[a1] * QC_1)
                            + delta[a0][b0] * delta[b1][c0] * delta[d0][d1] * (PA_1 * QC_1 * (-1.0) + PQ[a1] * QC_1)
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][d1] * (PA_1 * QC_1 * (-1.0) + PQ[a1] * QC_1)
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][d0] * (PA_1 * QC_1 * (-1.0) + PQ[a1] * QC_1)
                            + delta[b0][c0] * delta[a0][b1] * delta[d0][d1] * (PA_1 * QC_1 * (-1.0) + PQ[a1] * QC_1)
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][d1] * (PA_1 * QC_1 * (-1.0) + PQ[a1] * QC_1)
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][d0] * (PA_1 * QC_1 * (-1.0) + PQ[a1] * QC_1)
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d1] * (PA_1 * QD_0 * (-1.0) + PQ[a1] * QD_0)
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d1] * (PA_1 * QD_0 * (-1.0) + PQ[a1] * QD_0)
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][c1] * (PA_1 * QD_0 * (-1.0) + PQ[a1] * QD_0)
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d1] * (PA_1 * QD_0 * (-1.0) + PQ[a1] * QD_0)
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d1] * (PA_1 * QD_0 * (-1.0) + PQ[a1] * QD_0)
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][c1] * (PA_1 * QD_0 * (-1.0) + PQ[a1] * QD_0)
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d1] * (PA_1 * QD_0 * (-1.0) + PQ[a1] * QD_0)
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d1] * (PA_1 * QD_0 * (-1.0) + PQ[a1] * QD_0)
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][c1] * (PA_1 * QD_0 * (-1.0) + PQ[a1] * QD_0)
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d0] * (PA_1 * QD_1 * (-1.0) + PQ[a1] * QD_1)
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d0] * (PA_1 * QD_1 * (-1.0) + PQ[a1] * QD_1)
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][c1] * (PA_1 * QD_1 * (-1.0) + PQ[a1] * QD_1)
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d0] * (PA_1 * QD_1 * (-1.0) + PQ[a1] * QD_1)
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d0] * (PA_1 * QD_1 * (-1.0) + PQ[a1] * QD_1)
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][c1] * (PA_1 * QD_1 * (-1.0) + PQ[a1] * QD_1)
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d0] * (PA_1 * QD_1 * (-1.0) + PQ[a1] * QD_1)
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d0] * (PA_1 * QD_1 * (-1.0) + PQ[a1] * QD_1)
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][c1] * (PA_1 * QD_1 * (-1.0) + PQ[a1] * QD_1)
                            + delta[a0][a1] * delta[c0][c1] * delta[d0][d1] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0) + PQ[b0] * PQ[b1])
                            + delta[a0][a1] * delta[c0][d0] * delta[c1][d1] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0) + PQ[b0] * PQ[b1])
                            + delta[a0][a1] * delta[c1][d0] * delta[c0][d1] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0) + PQ[b0] * PQ[b1])
                            + delta[a0][c1] * delta[a1][b1] * delta[d0][d1] * (PB_0 * QC_0 * (-1.0) + PQ[b0] * QC_0)
                            + delta[a0][d0] * delta[a1][b1] * delta[c1][d1] * (PB_0 * QC_0 * (-1.0) + PQ[b0] * QC_0)
                            + delta[a0][d1] * delta[a1][b1] * delta[c1][d0] * (PB_0 * QC_0 * (-1.0) + PQ[b0] * QC_0)
                            + delta[a0][a1] * delta[b1][c1] * delta[d0][d1] * (PB_0 * QC_0 * (-1.0) + PQ[b0] * QC_0)
                            + delta[a0][a1] * delta[b1][d0] * delta[c1][d1] * (PB_0 * QC_0 * (-1.0) + PQ[b0] * QC_0)
                            + delta[a0][a1] * delta[b1][d1] * delta[c1][d0] * (PB_0 * QC_0 * (-1.0) + PQ[b0] * QC_0)
                            + delta[a1][c1] * delta[a0][b1] * delta[d0][d1] * (PB_0 * QC_0 * (-1.0) + PQ[b0] * QC_0)
                            + delta[a1][d0] * delta[a0][b1] * delta[c1][d1] * (PB_0 * QC_0 * (-1.0) + PQ[b0] * QC_0)
                            + delta[a1][d1] * delta[a0][b1] * delta[c1][d0] * (PB_0 * QC_0 * (-1.0) + PQ[b0] * QC_0)
                            + delta[a0][c0] * delta[a1][b1] * delta[d0][d1] * (PB_0 * QC_1 * (-1.0) + PQ[b0] * QC_1)
                            + delta[a0][d0] * delta[a1][b1] * delta[c0][d1] * (PB_0 * QC_1 * (-1.0) + PQ[b0] * QC_1)
                            + delta[a0][d1] * delta[a1][b1] * delta[c0][d0] * (PB_0 * QC_1 * (-1.0) + PQ[b0] * QC_1)
                            + delta[a0][a1] * delta[b1][c0] * delta[d0][d1] * (PB_0 * QC_1 * (-1.0) + PQ[b0] * QC_1)
                            + delta[a0][a1] * delta[b1][d0] * delta[c0][d1] * (PB_0 * QC_1 * (-1.0) + PQ[b0] * QC_1)
                            + delta[a0][a1] * delta[b1][d1] * delta[c0][d0] * (PB_0 * QC_1 * (-1.0) + PQ[b0] * QC_1)
                            + delta[a1][c0] * delta[a0][b1] * delta[d0][d1] * (PB_0 * QC_1 * (-1.0) + PQ[b0] * QC_1)
                            + delta[a1][d0] * delta[a0][b1] * delta[c0][d1] * (PB_0 * QC_1 * (-1.0) + PQ[b0] * QC_1)
                            + delta[a1][d1] * delta[a0][b1] * delta[c0][d0] * (PB_0 * QC_1 * (-1.0) + PQ[b0] * QC_1)
                            + delta[a0][c0] * delta[a1][b1] * delta[c1][d1] * (PB_0 * QD_0 * (-1.0) + PQ[b0] * QD_0)
                            + delta[a0][c1] * delta[a1][b1] * delta[c0][d1] * (PB_0 * QD_0 * (-1.0) + PQ[b0] * QD_0)
                            + delta[a0][d1] * delta[a1][b1] * delta[c0][c1] * (PB_0 * QD_0 * (-1.0) + PQ[b0] * QD_0)
                            + delta[a0][a1] * delta[b1][c0] * delta[c1][d1] * (PB_0 * QD_0 * (-1.0) + PQ[b0] * QD_0)
                            + delta[a0][a1] * delta[b1][c1] * delta[c0][d1] * (PB_0 * QD_0 * (-1.0) + PQ[b0] * QD_0)
                            + delta[a0][a1] * delta[b1][d1] * delta[c0][c1] * (PB_0 * QD_0 * (-1.0) + PQ[b0] * QD_0)
                            + delta[a1][c0] * delta[a0][b1] * delta[c1][d1] * (PB_0 * QD_0 * (-1.0) + PQ[b0] * QD_0)
                            + delta[a1][c1] * delta[a0][b1] * delta[c0][d1] * (PB_0 * QD_0 * (-1.0) + PQ[b0] * QD_0)
                            + delta[a1][d1] * delta[a0][b1] * delta[c0][c1] * (PB_0 * QD_0 * (-1.0) + PQ[b0] * QD_0)
                            + delta[a0][c0] * delta[a1][b1] * delta[c1][d0] * (PB_0 * QD_1 * (-1.0) + PQ[b0] * QD_1)
                            + delta[a0][c1] * delta[a1][b1] * delta[c0][d0] * (PB_0 * QD_1 * (-1.0) + PQ[b0] * QD_1)
                            + delta[a0][d0] * delta[a1][b1] * delta[c0][c1] * (PB_0 * QD_1 * (-1.0) + PQ[b0] * QD_1)
                            + delta[a0][a1] * delta[b1][c0] * delta[c1][d0] * (PB_0 * QD_1 * (-1.0) + PQ[b0] * QD_1)
                            + delta[a0][a1] * delta[b1][c1] * delta[c0][d0] * (PB_0 * QD_1 * (-1.0) + PQ[b0] * QD_1)
                            + delta[a0][a1] * delta[b1][d0] * delta[c0][c1] * (PB_0 * QD_1 * (-1.0) + PQ[b0] * QD_1)
                            + delta[a1][c0] * delta[a0][b1] * delta[c1][d0] * (PB_0 * QD_1 * (-1.0) + PQ[b0] * QD_1)
                            + delta[a1][c1] * delta[a0][b1] * delta[c0][d0] * (PB_0 * QD_1 * (-1.0) + PQ[b0] * QD_1)
                            + delta[a1][d0] * delta[a0][b1] * delta[c0][c1] * (PB_0 * QD_1 * (-1.0) + PQ[b0] * QD_1)
                            + delta[a0][c1] * delta[a1][b0] * delta[d0][d1] * (PB_1 * QC_0 * (-1.0) + PQ[b1] * QC_0)
                            + delta[a0][d0] * delta[a1][b0] * delta[c1][d1] * (PB_1 * QC_0 * (-1.0) + PQ[b1] * QC_0)
                            + delta[a0][d1] * delta[a1][b0] * delta[c1][d0] * (PB_1 * QC_0 * (-1.0) + PQ[b1] * QC_0)
                            + delta[a0][a1] * delta[b0][c1] * delta[d0][d1] * (PB_1 * QC_0 * (-1.0) + PQ[b1] * QC_0)
                            + delta[a0][a1] * delta[b0][d0] * delta[c1][d1] * (PB_1 * QC_0 * (-1.0) + PQ[b1] * QC_0)
                            + delta[a0][a1] * delta[b0][d1] * delta[c1][d0] * (PB_1 * QC_0 * (-1.0) + PQ[b1] * QC_0)
                            + delta[a1][c1] * delta[a0][b0] * delta[d0][d1] * (PB_1 * QC_0 * (-1.0) + PQ[b1] * QC_0)
                            + delta[a1][d0] * delta[a0][b0] * delta[c1][d1] * (PB_1 * QC_0 * (-1.0) + PQ[b1] * QC_0)
                            + delta[a1][d1] * delta[a0][b0] * delta[c1][d0] * (PB_1 * QC_0 * (-1.0) + PQ[b1] * QC_0)
                            + delta[a0][c0] * delta[a1][b0] * delta[d0][d1] * (PB_1 * QC_1 * (-1.0) + PQ[b1] * QC_1)
                            + delta[a0][d0] * delta[a1][b0] * delta[c0][d1] * (PB_1 * QC_1 * (-1.0) + PQ[b1] * QC_1)
                            + delta[a0][d1] * delta[a1][b0] * delta[c0][d0] * (PB_1 * QC_1 * (-1.0) + PQ[b1] * QC_1)
                            + delta[a0][a1] * delta[b0][c0] * delta[d0][d1] * (PB_1 * QC_1 * (-1.0) + PQ[b1] * QC_1)
                            + delta[a0][a1] * delta[b0][d0] * delta[c0][d1] * (PB_1 * QC_1 * (-1.0) + PQ[b1] * QC_1)
                            + delta[a0][a1] * delta[b0][d1] * delta[c0][d0] * (PB_1 * QC_1 * (-1.0) + PQ[b1] * QC_1)
                            + delta[a1][c0] * delta[a0][b0] * delta[d0][d1] * (PB_1 * QC_1 * (-1.0) + PQ[b1] * QC_1)
                            + delta[a1][d0] * delta[a0][b0] * delta[c0][d1] * (PB_1 * QC_1 * (-1.0) + PQ[b1] * QC_1)
                            + delta[a1][d1] * delta[a0][b0] * delta[c0][d0] * (PB_1 * QC_1 * (-1.0) + PQ[b1] * QC_1)
                            + delta[a0][c0] * delta[a1][b0] * delta[c1][d1] * (PB_1 * QD_0 * (-1.0) + PQ[b1] * QD_0)
                            + delta[a0][c1] * delta[a1][b0] * delta[c0][d1] * (PB_1 * QD_0 * (-1.0) + PQ[b1] * QD_0)
                            + delta[a0][d1] * delta[a1][b0] * delta[c0][c1] * (PB_1 * QD_0 * (-1.0) + PQ[b1] * QD_0)
                            + delta[a0][a1] * delta[b0][c0] * delta[c1][d1] * (PB_1 * QD_0 * (-1.0) + PQ[b1] * QD_0)
                            + delta[a0][a1] * delta[b0][c1] * delta[c0][d1] * (PB_1 * QD_0 * (-1.0) + PQ[b1] * QD_0)
                            + delta[a0][a1] * delta[b0][d1] * delta[c0][c1] * (PB_1 * QD_0 * (-1.0) + PQ[b1] * QD_0)
                            + delta[a1][c0] * delta[a0][b0] * delta[c1][d1] * (PB_1 * QD_0 * (-1.0) + PQ[b1] * QD_0)
                            + delta[a1][c1] * delta[a0][b0] * delta[c0][d1] * (PB_1 * QD_0 * (-1.0) + PQ[b1] * QD_0)
                            + delta[a1][d1] * delta[a0][b0] * delta[c0][c1] * (PB_1 * QD_0 * (-1.0) + PQ[b1] * QD_0)
                            + delta[a0][c0] * delta[a1][b0] * delta[c1][d0] * (PB_1 * QD_1 * (-1.0) + PQ[b1] * QD_1)
                            + delta[a0][c1] * delta[a1][b0] * delta[c0][d0] * (PB_1 * QD_1 * (-1.0) + PQ[b1] * QD_1)
                            + delta[a0][d0] * delta[a1][b0] * delta[c0][c1] * (PB_1 * QD_1 * (-1.0) + PQ[b1] * QD_1)
                            + delta[a0][a1] * delta[b0][c0] * delta[c1][d0] * (PB_1 * QD_1 * (-1.0) + PQ[b1] * QD_1)
                            + delta[a0][a1] * delta[b0][c1] * delta[c0][d0] * (PB_1 * QD_1 * (-1.0) + PQ[b1] * QD_1)
                            + delta[a0][a1] * delta[b0][d0] * delta[c0][c1] * (PB_1 * QD_1 * (-1.0) + PQ[b1] * QD_1)
                            + delta[a1][c0] * delta[a0][b0] * delta[c1][d0] * (PB_1 * QD_1 * (-1.0) + PQ[b1] * QD_1)
                            + delta[a1][c1] * delta[a0][b0] * delta[c0][d0] * (PB_1 * QD_1 * (-1.0) + PQ[b1] * QD_1)
                            + delta[a1][d0] * delta[a0][b0] * delta[c0][c1] * (PB_1 * QD_1 * (-1.0) + PQ[b1] * QD_1)
                            + delta[a0][a1] * delta[b0][b1] * delta[d0][d1] * (PQ[c0] * QC_1 * 2.0 + PQ[c1] * QC_0 * 2.0 + QC_0 * QC_1 * 2.0)
                            + delta[a0][b0] * delta[a1][b1] * delta[d0][d1] * (PQ[c0] * QC_1 * 2.0 + PQ[c1] * QC_0 * 2.0 + QC_0 * QC_1 * 2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[d0][d1] * (PQ[c0] * QC_1 * 2.0 + PQ[c1] * QC_0 * 2.0 + QC_0 * QC_1 * 2.0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d1] * (PQ[c0] * QD_0 * 2.0 + PQ[d0] * QC_0 * 2.0 + QD_0 * QC_0 * 2.0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d1] * (PQ[c0] * QD_0 * 2.0 + PQ[d0] * QC_0 * 2.0 + QD_0 * QC_0 * 2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d1] * (PQ[c0] * QD_0 * 2.0 + PQ[d0] * QC_0 * 2.0 + QD_0 * QC_0 * 2.0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d1] * (PQ[c1] * QD_0 * 2.0 + PQ[d0] * QC_1 * 2.0 + QD_0 * QC_1 * 2.0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d1] * (PQ[c1] * QD_0 * 2.0 + PQ[d0] * QC_1 * 2.0 + QD_0 * QC_1 * 2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d1] * (PQ[c1] * QD_0 * 2.0 + PQ[d0] * QC_1 * 2.0 + QD_0 * QC_1 * 2.0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d0] * (PQ[c0] * QD_1 * 2.0 + PQ[d1] * QC_0 * 2.0 + QD_1 * QC_0 * 2.0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d0] * (PQ[c0] * QD_1 * 2.0 + PQ[d1] * QC_0 * 2.0 + QD_1 * QC_0 * 2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d0] * (PQ[c0] * QD_1 * 2.0 + PQ[d1] * QC_0 * 2.0 + QD_1 * QC_0 * 2.0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * (PQ[c1] * QD_1 * 2.0 + PQ[d1] * QC_1 * 2.0 + QD_1 * QC_1 * 2.0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * (PQ[c1] * QD_1 * 2.0 + PQ[d1] * QC_1 * 2.0 + QD_1 * QC_1 * 2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * (PQ[c1] * QD_1 * 2.0 + PQ[d1] * QC_1 * 2.0 + QD_1 * QC_1 * 2.0)
                            + delta[a0][d0] * delta[a1][d1] * delta[b0][b1] * (QC_0 * QC_1)
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][d1] * (QC_0 * QC_1)
                            + delta[a0][d0] * delta[b0][d1] * delta[a1][b1] * (QC_0 * QC_1)
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][b1] * (QC_0 * QC_1)
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][d0] * (QC_0 * QC_1)
                            + delta[a0][d1] * delta[b0][d0] * delta[a1][b1] * (QC_0 * QC_1)
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][d1] * (QC_0 * QC_1)
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][d0] * (QC_0 * QC_1)
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][d1] * (QC_0 * QC_1)
                            + delta[a1][d0] * delta[b0][d1] * delta[a0][b1] * (QC_0 * QC_1)
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][d0] * (QC_0 * QC_1)
                            + delta[a1][d1] * delta[b0][d0] * delta[a0][b1] * (QC_0 * QC_1)
                            + delta[a0][c1] * delta[a1][d1] * delta[b0][b1] * (QD_0 * QC_0)
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][d1] * (QD_0 * QC_0)
                            + delta[a0][c1] * delta[b0][d1] * delta[a1][b1] * (QD_0 * QC_0)
                            + delta[a0][d1] * delta[a1][c1] * delta[b0][b1] * (QD_0 * QC_0)
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][c1] * (QD_0 * QC_0)
                            + delta[a0][d1] * delta[b0][c1] * delta[a1][b1] * (QD_0 * QC_0)
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][d1] * (QD_0 * QC_0)
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][c1] * (QD_0 * QC_0)
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][d1] * (QD_0 * QC_0)
                            + delta[a1][c1] * delta[b0][d1] * delta[a0][b1] * (QD_0 * QC_0)
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][c1] * (QD_0 * QC_0)
                            + delta[a1][d1] * delta[b0][c1] * delta[a0][b1] * (QD_0 * QC_0)
                            + delta[a0][c1] * delta[a1][d0] * delta[b0][b1] * (QD_1 * QC_0)
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][d0] * (QD_1 * QC_0)
                            + delta[a0][c1] * delta[b0][d0] * delta[a1][b1] * (QD_1 * QC_0)
                            + delta[a0][d0] * delta[a1][c1] * delta[b0][b1] * (QD_1 * QC_0)
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][c1] * (QD_1 * QC_0)
                            + delta[a0][d0] * delta[b0][c1] * delta[a1][b1] * (QD_1 * QC_0)
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][d0] * (QD_1 * QC_0)
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][c1] * (QD_1 * QC_0)
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][d0] * (QD_1 * QC_0)
                            + delta[a1][c1] * delta[b0][d0] * delta[a0][b1] * (QD_1 * QC_0)
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][c1] * (QD_1 * QC_0)
                            + delta[a1][d0] * delta[b0][c1] * delta[a0][b1] * (QD_1 * QC_0)
                            + delta[a0][c0] * delta[a1][d1] * delta[b0][b1] * (QD_0 * QC_1)
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d1] * (QD_0 * QC_1)
                            + delta[a0][c0] * delta[b0][d1] * delta[a1][b1] * (QD_0 * QC_1)
                            + delta[a0][d1] * delta[a1][c0] * delta[b0][b1] * (QD_0 * QC_1)
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][c0] * (QD_0 * QC_1)
                            + delta[a0][d1] * delta[b0][c0] * delta[a1][b1] * (QD_0 * QC_1)
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d1] * (QD_0 * QC_1)
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][c0] * (QD_0 * QC_1)
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d1] * (QD_0 * QC_1)
                            + delta[a1][c0] * delta[b0][d1] * delta[a0][b1] * (QD_0 * QC_1)
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][c0] * (QD_0 * QC_1)
                            + delta[a1][d1] * delta[b0][c0] * delta[a0][b1] * (QD_0 * QC_1)
                            + delta[a0][c0] * delta[a1][d0] * delta[b0][b1] * (QD_1 * QC_1)
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d0] * (QD_1 * QC_1)
                            + delta[a0][c0] * delta[b0][d0] * delta[a1][b1] * (QD_1 * QC_1)
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][b1] * (QD_1 * QC_1)
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][c0] * (QD_1 * QC_1)
                            + delta[a0][d0] * delta[b0][c0] * delta[a1][b1] * (QD_1 * QC_1)
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d0] * (QD_1 * QC_1)
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][c0] * (QD_1 * QC_1)
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d0] * (QD_1 * QC_1)
                            + delta[a1][c0] * delta[b0][d0] * delta[a0][b1] * (QD_1 * QC_1)
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][c0] * (QD_1 * QC_1)
                            + delta[a1][d0] * delta[b0][c0] * delta[a0][b1] * (QD_1 * QC_1)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][c1] * (PQ[d0] * QD_1 * 2.0 + PQ[d1] * QD_0 * 2.0 + QD_0 * QD_1 * 2.0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][c1] * (PQ[d0] * QD_1 * 2.0 + PQ[d1] * QD_0 * 2.0 + QD_0 * QD_1 * 2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][c1] * (PQ[d0] * QD_1 * 2.0 + PQ[d1] * QD_0 * 2.0 + QD_0 * QD_1 * 2.0)
                            + delta[a0][c0] * delta[a1][c1] * delta[b0][b1] * (QD_0 * QD_1)
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][c1] * (QD_0 * QD_1)
                            + delta[a0][c0] * delta[b0][c1] * delta[a1][b1] * (QD_0 * QD_1)
                            + delta[a0][c1] * delta[a1][c0] * delta[b0][b1] * (QD_0 * QD_1)
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][c0] * (QD_0 * QD_1)
                            + delta[a0][c1] * delta[b0][c0] * delta[a1][b1] * (QD_0 * QD_1)
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][c1] * (QD_0 * QD_1)
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][c0] * (QD_0 * QD_1)
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][c1] * (QD_0 * QD_1)
                            + delta[a1][c0] * delta[b0][c1] * delta[a0][b1] * (QD_0 * QD_1)
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][c0] * (QD_0 * QD_1)
                            + delta[a1][c1] * delta[b0][c0] * delta[a0][b1] * (QD_0 * QD_1)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD8(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[3];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[2] * (

                        0.125 / ( S2 * S4 * S4 ) * (
                            delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (PA_0 * PQ[a1] * (-2.0) + PA_1 * PQ[a0] * (-2.0) + PA_0 * PA_1 * 2.0)
                            + delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (PA_0 * PQ[a1] * (-2.0) + PA_1 * PQ[a0] * (-2.0) + PA_0 * PA_1 * 2.0)
                            + delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (PA_0 * PQ[a1] * (-2.0) + PA_1 * PQ[a0] * (-2.0) + PA_0 * PA_1 * 2.0)
                            + delta[b0][c0] * delta[b1][c1] * delta[d0][d1] * (PA_0 * PA_1)
                            + delta[b0][c0] * delta[b1][d0] * delta[c1][d1] * (PA_0 * PA_1)
                            + delta[b0][c0] * delta[b1][d1] * delta[c1][d0] * (PA_0 * PA_1)
                            + delta[b0][c1] * delta[b1][c0] * delta[d0][d1] * (PA_0 * PA_1)
                            + delta[b0][c1] * delta[b1][d0] * delta[c0][d1] * (PA_0 * PA_1)
                            + delta[b0][c1] * delta[b1][d1] * delta[c0][d0] * (PA_0 * PA_1)
                            + delta[b0][d0] * delta[b1][c0] * delta[c1][d1] * (PA_0 * PA_1)
                            + delta[b0][d0] * delta[b1][c1] * delta[c0][d1] * (PA_0 * PA_1)
                            + delta[b0][d0] * delta[b1][d1] * delta[c0][c1] * (PA_0 * PA_1)
                            + delta[b0][d1] * delta[b1][c0] * delta[c1][d0] * (PA_0 * PA_1)
                            + delta[b0][d1] * delta[b1][c1] * delta[c0][d0] * (PA_0 * PA_1)
                            + delta[b0][d1] * delta[b1][d0] * delta[c0][c1] * (PA_0 * PA_1)
                            + delta[a1][c0] * delta[b1][c1] * delta[d0][d1] * (PB_0 * PA_0)
                            + delta[a1][c0] * delta[b1][d0] * delta[c1][d1] * (PB_0 * PA_0)
                            + delta[a1][c0] * delta[b1][d1] * delta[c1][d0] * (PB_0 * PA_0)
                            + delta[a1][c1] * delta[b1][c0] * delta[d0][d1] * (PB_0 * PA_0)
                            + delta[a1][c1] * delta[b1][d0] * delta[c0][d1] * (PB_0 * PA_0)
                            + delta[a1][c1] * delta[b1][d1] * delta[c0][d0] * (PB_0 * PA_0)
                            + delta[a1][d0] * delta[b1][c0] * delta[c1][d1] * (PB_0 * PA_0)
                            + delta[a1][d0] * delta[b1][c1] * delta[c0][d1] * (PB_0 * PA_0)
                            + delta[a1][d0] * delta[b1][d1] * delta[c0][c1] * (PB_0 * PA_0)
                            + delta[a1][d1] * delta[b1][c0] * delta[c1][d0] * (PB_0 * PA_0)
                            + delta[a1][d1] * delta[b1][c1] * delta[c0][d0] * (PB_0 * PA_0)
                            + delta[a1][d1] * delta[b1][d0] * delta[c0][c1] * (PB_0 * PA_0)
                            + delta[a1][b1] * delta[c0][c1] * delta[d0][d1] * (PB_0 * PQ[a0] * (-2.0) + PA_0 * PQ[b0] * (-2.0) + PB_0 * PA_0 * 2.0)
                            + delta[a1][b1] * delta[c0][d0] * delta[c1][d1] * (PB_0 * PQ[a0] * (-2.0) + PA_0 * PQ[b0] * (-2.0) + PB_0 * PA_0 * 2.0)
                            + delta[a1][b1] * delta[c1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] * (-2.0) + PA_0 * PQ[b0] * (-2.0) + PB_0 * PA_0 * 2.0)
                            + delta[a1][c0] * delta[b0][c1] * delta[d0][d1] * (PB_1 * PA_0)
                            + delta[a1][c0] * delta[b0][d0] * delta[c1][d1] * (PB_1 * PA_0)
                            + delta[a1][c0] * delta[b0][d1] * delta[c1][d0] * (PB_1 * PA_0)
                            + delta[a1][c1] * delta[b0][c0] * delta[d0][d1] * (PB_1 * PA_0)
                            + delta[a1][c1] * delta[b0][d0] * delta[c0][d1] * (PB_1 * PA_0)
                            + delta[a1][c1] * delta[b0][d1] * delta[c0][d0] * (PB_1 * PA_0)
                            + delta[a1][d0] * delta[b0][c0] * delta[c1][d1] * (PB_1 * PA_0)
                            + delta[a1][d0] * delta[b0][c1] * delta[c0][d1] * (PB_1 * PA_0)
                            + delta[a1][d0] * delta[b0][d1] * delta[c0][c1] * (PB_1 * PA_0)
                            + delta[a1][d1] * delta[b0][c0] * delta[c1][d0] * (PB_1 * PA_0)
                            + delta[a1][d1] * delta[b0][c1] * delta[c0][d0] * (PB_1 * PA_0)
                            + delta[a1][d1] * delta[b0][d0] * delta[c0][c1] * (PB_1 * PA_0)
                            + delta[a1][b0] * delta[c0][c1] * delta[d0][d1] * (PB_1 * PQ[a0] * (-2.0) + PA_0 * PQ[b1] * (-2.0) + PB_1 * PA_0 * 2.0)
                            + delta[a1][b0] * delta[c0][d0] * delta[c1][d1] * (PB_1 * PQ[a0] * (-2.0) + PA_0 * PQ[b1] * (-2.0) + PB_1 * PA_0 * 2.0)
                            + delta[a1][b0] * delta[c1][d0] * delta[c0][d1] * (PB_1 * PQ[a0] * (-2.0) + PA_0 * PQ[b1] * (-2.0) + PB_1 * PA_0 * 2.0)
                            + delta[a1][c1] * delta[b0][b1] * delta[d0][d1] * (PA_0 * PQ[c0] * (-1.0) + PA_0 * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[b0][b1] * delta[c1][d1] * (PA_0 * PQ[c0] * (-1.0) + PA_0 * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[b0][b1] * delta[c1][d0] * (PA_0 * PQ[c0] * (-1.0) + PA_0 * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][c1] * delta[d0][d1] * (PA_0 * PQ[c0] * (-1.0) + PA_0 * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][d0] * delta[c1][d1] * (PA_0 * PQ[c0] * (-1.0) + PA_0 * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][d1] * delta[c1][d0] * (PA_0 * PQ[c0] * (-1.0) + PA_0 * QC_0 * (-1.0))
                            + delta[b0][c1] * delta[a1][b1] * delta[d0][d1] * (PA_0 * PQ[c0] * (-1.0) + PA_0 * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[a1][b1] * delta[c1][d1] * (PA_0 * PQ[c0] * (-1.0) + PA_0 * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[a1][b1] * delta[c1][d0] * (PA_0 * PQ[c0] * (-1.0) + PA_0 * QC_0 * (-1.0))
                            + delta[a1][c0] * delta[b0][b1] * delta[d0][d1] * (PA_0 * PQ[c1] * (-1.0) + PA_0 * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[b0][b1] * delta[c0][d1] * (PA_0 * PQ[c1] * (-1.0) + PA_0 * QC_1 * (-1.0))
                            + delta[a1][d1] * delta[b0][b1] * delta[c0][d0] * (PA_0 * PQ[c1] * (-1.0) + PA_0 * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[b1][c0] * delta[d0][d1] * (PA_0 * PQ[c1] * (-1.0) + PA_0 * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[b1][d0] * delta[c0][d1] * (PA_0 * PQ[c1] * (-1.0) + PA_0 * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[b1][d1] * delta[c0][d0] * (PA_0 * PQ[c1] * (-1.0) + PA_0 * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[a1][b1] * delta[d0][d1] * (PA_0 * PQ[c1] * (-1.0) + PA_0 * QC_1 * (-1.0))
                            + delta[b0][d0] * delta[a1][b1] * delta[c0][d1] * (PA_0 * PQ[c1] * (-1.0) + PA_0 * QC_1 * (-1.0))
                            + delta[b0][d1] * delta[a1][b1] * delta[c0][d0] * (PA_0 * PQ[c1] * (-1.0) + PA_0 * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[b0][b1] * delta[c1][d1] * (PA_0 * PQ[d0] * (-1.0) + PA_0 * QD_0 * (-1.0))
                            + delta[a1][c1] * delta[b0][b1] * delta[c0][d1] * (PA_0 * PQ[d0] * (-1.0) + PA_0 * QD_0 * (-1.0))
                            + delta[a1][d1] * delta[b0][b1] * delta[c0][c1] * (PA_0 * PQ[d0] * (-1.0) + PA_0 * QD_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][c0] * delta[c1][d1] * (PA_0 * PQ[d0] * (-1.0) + PA_0 * QD_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][c1] * delta[c0][d1] * (PA_0 * PQ[d0] * (-1.0) + PA_0 * QD_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][d1] * delta[c0][c1] * (PA_0 * PQ[d0] * (-1.0) + PA_0 * QD_0 * (-1.0))
                            + delta[b0][c0] * delta[a1][b1] * delta[c1][d1] * (PA_0 * PQ[d0] * (-1.0) + PA_0 * QD_0 * (-1.0))
                            + delta[b0][c1] * delta[a1][b1] * delta[c0][d1] * (PA_0 * PQ[d0] * (-1.0) + PA_0 * QD_0 * (-1.0))
                            + delta[b0][d1] * delta[a1][b1] * delta[c0][c1] * (PA_0 * PQ[d0] * (-1.0) + PA_0 * QD_0 * (-1.0))
                            + delta[a1][c0] * delta[b0][b1] * delta[c1][d0] * (PA_0 * PQ[d1] * (-1.0) + PA_0 * QD_1 * (-1.0))
                            + delta[a1][c1] * delta[b0][b1] * delta[c0][d0] * (PA_0 * PQ[d1] * (-1.0) + PA_0 * QD_1 * (-1.0))
                            + delta[a1][d0] * delta[b0][b1] * delta[c0][c1] * (PA_0 * PQ[d1] * (-1.0) + PA_0 * QD_1 * (-1.0))
                            + delta[a1][b0] * delta[b1][c0] * delta[c1][d0] * (PA_0 * PQ[d1] * (-1.0) + PA_0 * QD_1 * (-1.0))
                            + delta[a1][b0] * delta[b1][c1] * delta[c0][d0] * (PA_0 * PQ[d1] * (-1.0) + PA_0 * QD_1 * (-1.0))
                            + delta[a1][b0] * delta[b1][d0] * delta[c0][c1] * (PA_0 * PQ[d1] * (-1.0) + PA_0 * QD_1 * (-1.0))
                            + delta[b0][c0] * delta[a1][b1] * delta[c1][d0] * (PA_0 * PQ[d1] * (-1.0) + PA_0 * QD_1 * (-1.0))
                            + delta[b0][c1] * delta[a1][b1] * delta[c0][d0] * (PA_0 * PQ[d1] * (-1.0) + PA_0 * QD_1 * (-1.0))
                            + delta[b0][d0] * delta[a1][b1] * delta[c0][c1] * (PA_0 * PQ[d1] * (-1.0) + PA_0 * QD_1 * (-1.0))
                            + delta[a0][c0] * delta[b1][c1] * delta[d0][d1] * (PB_0 * PA_1)
                            + delta[a0][c0] * delta[b1][d0] * delta[c1][d1] * (PB_0 * PA_1)
                            + delta[a0][c0] * delta[b1][d1] * delta[c1][d0] * (PB_0 * PA_1)
                            + delta[a0][c1] * delta[b1][c0] * delta[d0][d1] * (PB_0 * PA_1)
                            + delta[a0][c1] * delta[b1][d0] * delta[c0][d1] * (PB_0 * PA_1)
                            + delta[a0][c1] * delta[b1][d1] * delta[c0][d0] * (PB_0 * PA_1)
                            + delta[a0][d0] * delta[b1][c0] * delta[c1][d1] * (PB_0 * PA_1)
                            + delta[a0][d0] * delta[b1][c1] * delta[c0][d1] * (PB_0 * PA_1)
                            + delta[a0][d0] * delta[b1][d1] * delta[c0][c1] * (PB_0 * PA_1)
                            + delta[a0][d1] * delta[b1][c0] * delta[c1][d0] * (PB_0 * PA_1)
                            + delta[a0][d1] * delta[b1][c1] * delta[c0][d0] * (PB_0 * PA_1)
                            + delta[a0][d1] * delta[b1][d0] * delta[c0][c1] * (PB_0 * PA_1)
                            + delta[a0][b1] * delta[c0][c1] * delta[d0][d1] * (PB_0 * PQ[a1] * (-2.0) + PA_1 * PQ[b0] * (-2.0) + PB_0 * PA_1 * 2.0)
                            + delta[a0][b1] * delta[c0][d0] * delta[c1][d1] * (PB_0 * PQ[a1] * (-2.0) + PA_1 * PQ[b0] * (-2.0) + PB_0 * PA_1 * 2.0)
                            + delta[a0][b1] * delta[c1][d0] * delta[c0][d1] * (PB_0 * PQ[a1] * (-2.0) + PA_1 * PQ[b0] * (-2.0) + PB_0 * PA_1 * 2.0)
                            + delta[a0][c0] * delta[b0][c1] * delta[d0][d1] * (PB_1 * PA_1)
                            + delta[a0][c0] * delta[b0][d0] * delta[c1][d1] * (PB_1 * PA_1)
                            + delta[a0][c0] * delta[b0][d1] * delta[c1][d0] * (PB_1 * PA_1)
                            + delta[a0][c1] * delta[b0][c0] * delta[d0][d1] * (PB_1 * PA_1)
                            + delta[a0][c1] * delta[b0][d0] * delta[c0][d1] * (PB_1 * PA_1)
                            + delta[a0][c1] * delta[b0][d1] * delta[c0][d0] * (PB_1 * PA_1)
                            + delta[a0][d0] * delta[b0][c0] * delta[c1][d1] * (PB_1 * PA_1)
                            + delta[a0][d0] * delta[b0][c1] * delta[c0][d1] * (PB_1 * PA_1)
                            + delta[a0][d0] * delta[b0][d1] * delta[c0][c1] * (PB_1 * PA_1)
                            + delta[a0][d1] * delta[b0][c0] * delta[c1][d0] * (PB_1 * PA_1)
                            + delta[a0][d1] * delta[b0][c1] * delta[c0][d0] * (PB_1 * PA_1)
                            + delta[a0][d1] * delta[b0][d0] * delta[c0][c1] * (PB_1 * PA_1)
                            + delta[a0][b0] * delta[c0][c1] * delta[d0][d1] * (PB_1 * PQ[a1] * (-2.0) + PA_1 * PQ[b1] * (-2.0) + PB_1 * PA_1 * 2.0)
                            + delta[a0][b0] * delta[c0][d0] * delta[c1][d1] * (PB_1 * PQ[a1] * (-2.0) + PA_1 * PQ[b1] * (-2.0) + PB_1 * PA_1 * 2.0)
                            + delta[a0][b0] * delta[c1][d0] * delta[c0][d1] * (PB_1 * PQ[a1] * (-2.0) + PA_1 * PQ[b1] * (-2.0) + PB_1 * PA_1 * 2.0)
                            + delta[a0][c1] * delta[b0][b1] * delta[d0][d1] * (PA_1 * PQ[c0] * (-1.0) + PA_1 * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * delta[c1][d1] * (PA_1 * PQ[c0] * (-1.0) + PA_1 * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * delta[c1][d0] * (PA_1 * PQ[c0] * (-1.0) + PA_1 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][c1] * delta[d0][d1] * (PA_1 * PQ[c0] * (-1.0) + PA_1 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * delta[c1][d1] * (PA_1 * PQ[c0] * (-1.0) + PA_1 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * delta[c1][d0] * (PA_1 * PQ[c0] * (-1.0) + PA_1 * QC_0 * (-1.0))
                            + delta[b0][c1] * delta[a0][b1] * delta[d0][d1] * (PA_1 * PQ[c0] * (-1.0) + PA_1 * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * delta[c1][d1] * (PA_1 * PQ[c0] * (-1.0) + PA_1 * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * delta[c1][d0] * (PA_1 * PQ[c0] * (-1.0) + PA_1 * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * delta[d0][d1] * (PA_1 * PQ[c1] * (-1.0) + PA_1 * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][d1] * (PA_1 * PQ[c1] * (-1.0) + PA_1 * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][d0] * (PA_1 * PQ[c1] * (-1.0) + PA_1 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * delta[d0][d1] * (PA_1 * PQ[c1] * (-1.0) + PA_1 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][d1] * (PA_1 * PQ[c1] * (-1.0) + PA_1 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][d0] * (PA_1 * PQ[c1] * (-1.0) + PA_1 * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * delta[d0][d1] * (PA_1 * PQ[c1] * (-1.0) + PA_1 * QC_1 * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][d1] * (PA_1 * PQ[c1] * (-1.0) + PA_1 * QC_1 * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][d0] * (PA_1 * PQ[c1] * (-1.0) + PA_1 * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d1] * (PA_1 * PQ[d0] * (-1.0) + PA_1 * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d1] * (PA_1 * PQ[d0] * (-1.0) + PA_1 * QD_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][c1] * (PA_1 * PQ[d0] * (-1.0) + PA_1 * QD_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d1] * (PA_1 * PQ[d0] * (-1.0) + PA_1 * QD_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d1] * (PA_1 * PQ[d0] * (-1.0) + PA_1 * QD_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][c1] * (PA_1 * PQ[d0] * (-1.0) + PA_1 * QD_0 * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d1] * (PA_1 * PQ[d0] * (-1.0) + PA_1 * QD_0 * (-1.0))
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d1] * (PA_1 * PQ[d0] * (-1.0) + PA_1 * QD_0 * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][c1] * (PA_1 * PQ[d0] * (-1.0) + PA_1 * QD_0 * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d0] * (PA_1 * PQ[d1] * (-1.0) + PA_1 * QD_1 * (-1.0))
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d0] * (PA_1 * PQ[d1] * (-1.0) + PA_1 * QD_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][c1] * (PA_1 * PQ[d1] * (-1.0) + PA_1 * QD_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d0] * (PA_1 * PQ[d1] * (-1.0) + PA_1 * QD_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d0] * (PA_1 * PQ[d1] * (-1.0) + PA_1 * QD_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][c1] * (PA_1 * PQ[d1] * (-1.0) + PA_1 * QD_1 * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d0] * (PA_1 * PQ[d1] * (-1.0) + PA_1 * QD_1 * (-1.0))
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d0] * (PA_1 * PQ[d1] * (-1.0) + PA_1 * QD_1 * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][c1] * (PA_1 * PQ[d1] * (-1.0) + PA_1 * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[c0][c1] * delta[d0][d1] * (PB_0 * PQ[b1] * (-2.0) + PB_1 * PQ[b0] * (-2.0) + PB_0 * PB_1 * 2.0)
                            + delta[a0][a1] * delta[c0][d0] * delta[c1][d1] * (PB_0 * PQ[b1] * (-2.0) + PB_1 * PQ[b0] * (-2.0) + PB_0 * PB_1 * 2.0)
                            + delta[a0][a1] * delta[c1][d0] * delta[c0][d1] * (PB_0 * PQ[b1] * (-2.0) + PB_1 * PQ[b0] * (-2.0) + PB_0 * PB_1 * 2.0)
                            + delta[a0][c1] * delta[a1][b1] * delta[d0][d1] * (PB_0 * PQ[c0] * (-1.0) + PB_0 * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[a1][b1] * delta[c1][d1] * (PB_0 * PQ[c0] * (-1.0) + PB_0 * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][b1] * delta[c1][d0] * (PB_0 * PQ[c0] * (-1.0) + PB_0 * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][c1] * delta[d0][d1] * (PB_0 * PQ[c0] * (-1.0) + PB_0 * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][d0] * delta[c1][d1] * (PB_0 * PQ[c0] * (-1.0) + PB_0 * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][d1] * delta[c1][d0] * (PB_0 * PQ[c0] * (-1.0) + PB_0 * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[a0][b1] * delta[d0][d1] * (PB_0 * PQ[c0] * (-1.0) + PB_0 * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[a0][b1] * delta[c1][d1] * (PB_0 * PQ[c0] * (-1.0) + PB_0 * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[a0][b1] * delta[c1][d0] * (PB_0 * PQ[c0] * (-1.0) + PB_0 * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][b1] * delta[d0][d1] * (PB_0 * PQ[c1] * (-1.0) + PB_0 * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][b1] * delta[c0][d1] * (PB_0 * PQ[c1] * (-1.0) + PB_0 * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[a1][b1] * delta[c0][d0] * (PB_0 * PQ[c1] * (-1.0) + PB_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b1][c0] * delta[d0][d1] * (PB_0 * PQ[c1] * (-1.0) + PB_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b1][d0] * delta[c0][d1] * (PB_0 * PQ[c1] * (-1.0) + PB_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b1][d1] * delta[c0][d0] * (PB_0 * PQ[c1] * (-1.0) + PB_0 * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[a0][b1] * delta[d0][d1] * (PB_0 * PQ[c1] * (-1.0) + PB_0 * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[a0][b1] * delta[c0][d1] * (PB_0 * PQ[c1] * (-1.0) + PB_0 * QC_1 * (-1.0))
                            + delta[a1][d1] * delta[a0][b1] * delta[c0][d0] * (PB_0 * PQ[c1] * (-1.0) + PB_0 * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[a1][b1] * delta[c1][d1] * (PB_0 * PQ[d0] * (-1.0) + PB_0 * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[a1][b1] * delta[c0][d1] * (PB_0 * PQ[d0] * (-1.0) + PB_0 * QD_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][b1] * delta[c0][c1] * (PB_0 * PQ[d0] * (-1.0) + PB_0 * QD_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][c0] * delta[c1][d1] * (PB_0 * PQ[d0] * (-1.0) + PB_0 * QD_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][c1] * delta[c0][d1] * (PB_0 * PQ[d0] * (-1.0) + PB_0 * QD_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][d1] * delta[c0][c1] * (PB_0 * PQ[d0] * (-1.0) + PB_0 * QD_0 * (-1.0))
                            + delta[a1][c0] * delta[a0][b1] * delta[c1][d1] * (PB_0 * PQ[d0] * (-1.0) + PB_0 * QD_0 * (-1.0))
                            + delta[a1][c1] * delta[a0][b1] * delta[c0][d1] * (PB_0 * PQ[d0] * (-1.0) + PB_0 * QD_0 * (-1.0))
                            + delta[a1][d1] * delta[a0][b1] * delta[c0][c1] * (PB_0 * PQ[d0] * (-1.0) + PB_0 * QD_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][b1] * delta[c1][d0] * (PB_0 * PQ[d1] * (-1.0) + PB_0 * QD_1 * (-1.0))
                            + delta[a0][c1] * delta[a1][b1] * delta[c0][d0] * (PB_0 * PQ[d1] * (-1.0) + PB_0 * QD_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][b1] * delta[c0][c1] * (PB_0 * PQ[d1] * (-1.0) + PB_0 * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[b1][c0] * delta[c1][d0] * (PB_0 * PQ[d1] * (-1.0) + PB_0 * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[b1][c1] * delta[c0][d0] * (PB_0 * PQ[d1] * (-1.0) + PB_0 * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[b1][d0] * delta[c0][c1] * (PB_0 * PQ[d1] * (-1.0) + PB_0 * QD_1 * (-1.0))
                            + delta[a1][c0] * delta[a0][b1] * delta[c1][d0] * (PB_0 * PQ[d1] * (-1.0) + PB_0 * QD_1 * (-1.0))
                            + delta[a1][c1] * delta[a0][b1] * delta[c0][d0] * (PB_0 * PQ[d1] * (-1.0) + PB_0 * QD_1 * (-1.0))
                            + delta[a1][d0] * delta[a0][b1] * delta[c0][c1] * (PB_0 * PQ[d1] * (-1.0) + PB_0 * QD_1 * (-1.0))
                            + delta[a0][c1] * delta[a1][b0] * delta[d0][d1] * (PB_1 * PQ[c0] * (-1.0) + PB_1 * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * delta[c1][d1] * (PB_1 * PQ[c0] * (-1.0) + PB_1 * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * delta[c1][d0] * (PB_1 * PQ[c0] * (-1.0) + PB_1 * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][c1] * delta[d0][d1] * (PB_1 * PQ[c0] * (-1.0) + PB_1 * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * delta[c1][d1] * (PB_1 * PQ[c0] * (-1.0) + PB_1 * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * delta[c1][d0] * (PB_1 * PQ[c0] * (-1.0) + PB_1 * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[a0][b0] * delta[d0][d1] * (PB_1 * PQ[c0] * (-1.0) + PB_1 * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * delta[c1][d1] * (PB_1 * PQ[c0] * (-1.0) + PB_1 * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * delta[c1][d0] * (PB_1 * PQ[c0] * (-1.0) + PB_1 * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * delta[d0][d1] * (PB_1 * PQ[c1] * (-1.0) + PB_1 * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * delta[c0][d1] * (PB_1 * PQ[c1] * (-1.0) + PB_1 * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * delta[c0][d0] * (PB_1 * PQ[c1] * (-1.0) + PB_1 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * delta[d0][d1] * (PB_1 * PQ[c1] * (-1.0) + PB_1 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * delta[c0][d1] * (PB_1 * PQ[c1] * (-1.0) + PB_1 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * delta[c0][d0] * (PB_1 * PQ[c1] * (-1.0) + PB_1 * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * delta[d0][d1] * (PB_1 * PQ[c1] * (-1.0) + PB_1 * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * delta[c0][d1] * (PB_1 * PQ[c1] * (-1.0) + PB_1 * QC_1 * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * delta[c0][d0] * (PB_1 * PQ[c1] * (-1.0) + PB_1 * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * delta[c1][d1] * (PB_1 * PQ[d0] * (-1.0) + PB_1 * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[a1][b0] * delta[c0][d1] * (PB_1 * PQ[d0] * (-1.0) + PB_1 * QD_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * delta[c0][c1] * (PB_1 * PQ[d0] * (-1.0) + PB_1 * QD_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * delta[c1][d1] * (PB_1 * PQ[d0] * (-1.0) + PB_1 * QD_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][c1] * delta[c0][d1] * (PB_1 * PQ[d0] * (-1.0) + PB_1 * QD_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * delta[c0][c1] * (PB_1 * PQ[d0] * (-1.0) + PB_1 * QD_0 * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * delta[c1][d1] * (PB_1 * PQ[d0] * (-1.0) + PB_1 * QD_0 * (-1.0))
                            + delta[a1][c1] * delta[a0][b0] * delta[c0][d1] * (PB_1 * PQ[d0] * (-1.0) + PB_1 * QD_0 * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * delta[c0][c1] * (PB_1 * PQ[d0] * (-1.0) + PB_1 * QD_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * delta[c1][d0] * (PB_1 * PQ[d1] * (-1.0) + PB_1 * QD_1 * (-1.0))
                            + delta[a0][c1] * delta[a1][b0] * delta[c0][d0] * (PB_1 * PQ[d1] * (-1.0) + PB_1 * QD_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * delta[c0][c1] * (PB_1 * PQ[d1] * (-1.0) + PB_1 * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * delta[c1][d0] * (PB_1 * PQ[d1] * (-1.0) + PB_1 * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][c1] * delta[c0][d0] * (PB_1 * PQ[d1] * (-1.0) + PB_1 * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * delta[c0][c1] * (PB_1 * PQ[d1] * (-1.0) + PB_1 * QD_1 * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * delta[c1][d0] * (PB_1 * PQ[d1] * (-1.0) + PB_1 * QD_1 * (-1.0))
                            + delta[a1][c1] * delta[a0][b0] * delta[c0][d0] * (PB_1 * PQ[d1] * (-1.0) + PB_1 * QD_1 * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * delta[c0][c1] * (PB_1 * PQ[d1] * (-1.0) + PB_1 * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[d0][d1] * (PQ[c0] * PQ[c1] + PQ[c0] * QC_1 + PQ[c1] * QC_0)
                            + delta[a0][b0] * delta[a1][b1] * delta[d0][d1] * (PQ[c0] * PQ[c1] + PQ[c0] * QC_1 + PQ[c1] * QC_0)
                            + delta[a1][b0] * delta[a0][b1] * delta[d0][d1] * (PQ[c0] * PQ[c1] + PQ[c0] * QC_1 + PQ[c1] * QC_0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d1] * (PQ[c0] * PQ[d0] + PQ[c0] * QD_0 + PQ[d0] * QC_0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d1] * (PQ[c0] * PQ[d0] + PQ[c0] * QD_0 + PQ[d0] * QC_0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d1] * (PQ[c0] * PQ[d0] + PQ[c0] * QD_0 + PQ[d0] * QC_0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d1] * (PQ[c1] * PQ[d0] + PQ[c1] * QD_0 + PQ[d0] * QC_1)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d1] * (PQ[c1] * PQ[d0] + PQ[c1] * QD_0 + PQ[d0] * QC_1)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d1] * (PQ[c1] * PQ[d0] + PQ[c1] * QD_0 + PQ[d0] * QC_1)
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d0] * (PQ[c0] * PQ[d1] + PQ[c0] * QD_1 + PQ[d1] * QC_0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d0] * (PQ[c0] * PQ[d1] + PQ[c0] * QD_1 + PQ[d1] * QC_0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d0] * (PQ[c0] * PQ[d1] + PQ[c0] * QD_1 + PQ[d1] * QC_0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * (PQ[c1] * PQ[d1] + PQ[c1] * QD_1 + PQ[d1] * QC_1)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * (PQ[c1] * PQ[d1] + PQ[c1] * QD_1 + PQ[d1] * QC_1)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * (PQ[c1] * PQ[d1] + PQ[c1] * QD_1 + PQ[d1] * QC_1)
                            + delta[a0][c0] * delta[a1][c1] * delta[d0][d1] * (PB_0 * PB_1)
                            + delta[a0][c0] * delta[a1][d0] * delta[c1][d1] * (PB_0 * PB_1)
                            + delta[a0][c0] * delta[a1][d1] * delta[c1][d0] * (PB_0 * PB_1)
                            + delta[a0][c1] * delta[a1][c0] * delta[d0][d1] * (PB_0 * PB_1)
                            + delta[a0][c1] * delta[a1][d0] * delta[c0][d1] * (PB_0 * PB_1)
                            + delta[a0][c1] * delta[a1][d1] * delta[c0][d0] * (PB_0 * PB_1)
                            + delta[a0][d0] * delta[a1][c0] * delta[c1][d1] * (PB_0 * PB_1)
                            + delta[a0][d0] * delta[a1][c1] * delta[c0][d1] * (PB_0 * PB_1)
                            + delta[a0][d0] * delta[a1][d1] * delta[c0][c1] * (PB_0 * PB_1)
                            + delta[a0][d1] * delta[a1][c0] * delta[c1][d0] * (PB_0 * PB_1)
                            + delta[a0][d1] * delta[a1][c1] * delta[c0][d0] * (PB_0 * PB_1)
                            + delta[a0][d1] * delta[a1][d0] * delta[c0][c1] * (PB_0 * PB_1)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][c1] * (PQ[d0] * PQ[d1] + PQ[d0] * QD_1 + PQ[d1] * QD_0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][c1] * (PQ[d0] * PQ[d1] + PQ[d0] * QD_1 + PQ[d1] * QD_0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][c1] * (PQ[d0] * PQ[d1] + PQ[d0] * QD_1 + PQ[d1] * QD_0)
                        )

                    )

                    +

                    F8_t[2] * (

                        0.25 * ( S1 * S1 ) / ( S2 * S2 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PA_1)
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PB_1 * PA_0 * PA_1)
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PA_1)
                        )

                    )

                    +

                    F8_t[2] * (

                        0.25 * ( S2 * S2 ) / ( S1 * S1 * S4 * S4 ) * (
                            delta[a0][a1] * delta[b0][b1] * (QD_0 * QD_1 * QC_0 * QC_1)
                            + delta[a0][b0] * delta[a1][b1] * (QD_0 * QD_1 * QC_0 * QC_1)
                            + delta[a1][b0] * delta[a0][b1] * (QD_0 * QD_1 * QC_0 * QC_1)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD9(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[3];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[2] * (

                        0.25 * S1 / ( S2 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] * (-2.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * (-2.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * (-2.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * (-2.0))
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] * (-2.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * (-2.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * (-2.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * (-2.0))
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] * (-2.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * (-2.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * (-2.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * (-2.0))
                            + delta[b1][c1] * delta[d0][d1] * (PB_0 * PA_0 * PA_1 * PQ[c0] * (-1.0) + PB_0 * PA_0 * PA_1 * QC_0 * (-1.0))
                            + delta[b1][d0] * delta[c1][d1] * (PB_0 * PA_0 * PA_1 * PQ[c0] * (-1.0) + PB_0 * PA_0 * PA_1 * QC_0 * (-1.0))
                            + delta[b1][d1] * delta[c1][d0] * (PB_0 * PA_0 * PA_1 * PQ[c0] * (-1.0) + PB_0 * PA_0 * PA_1 * QC_0 * (-1.0))
                            + delta[b1][c0] * delta[d0][d1] * (PB_0 * PA_0 * PA_1 * PQ[c1] * (-1.0) + PB_0 * PA_0 * PA_1 * QC_1 * (-1.0))
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * PA_0 * PA_1 * PQ[c1] * (-1.0) + PB_0 * PA_0 * PA_1 * QC_1 * (-1.0))
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * PA_0 * PA_1 * PQ[c1] * (-1.0) + PB_0 * PA_0 * PA_1 * QC_1 * (-1.0))
                            + delta[b1][c0] * delta[c1][d1] * (PB_0 * PA_0 * PA_1 * PQ[d0] * (-1.0) + PB_0 * PA_0 * PA_1 * QD_0 * (-1.0))
                            + delta[b1][c1] * delta[c0][d1] * (PB_0 * PA_0 * PA_1 * PQ[d0] * (-1.0) + PB_0 * PA_0 * PA_1 * QD_0 * (-1.0))
                            + delta[b1][d1] * delta[c0][c1] * (PB_0 * PA_0 * PA_1 * PQ[d0] * (-1.0) + PB_0 * PA_0 * PA_1 * QD_0 * (-1.0))
                            + delta[b1][c0] * delta[c1][d0] * (PB_0 * PA_0 * PA_1 * PQ[d1] * (-1.0) + PB_0 * PA_0 * PA_1 * QD_1 * (-1.0))
                            + delta[b1][c1] * delta[c0][d0] * (PB_0 * PA_0 * PA_1 * PQ[d1] * (-1.0) + PB_0 * PA_0 * PA_1 * QD_1 * (-1.0))
                            + delta[b1][d0] * delta[c0][c1] * (PB_0 * PA_0 * PA_1 * PQ[d1] * (-1.0) + PB_0 * PA_0 * PA_1 * QD_1 * (-1.0))
                            + delta[b0][c1] * delta[d0][d1] * (PB_1 * PA_0 * PA_1 * PQ[c0] * (-1.0) + PB_1 * PA_0 * PA_1 * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[c1][d1] * (PB_1 * PA_0 * PA_1 * PQ[c0] * (-1.0) + PB_1 * PA_0 * PA_1 * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[c1][d0] * (PB_1 * PA_0 * PA_1 * PQ[c0] * (-1.0) + PB_1 * PA_0 * PA_1 * QC_0 * (-1.0))
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * PA_0 * PA_1 * PQ[c1] * (-1.0) + PB_1 * PA_0 * PA_1 * QC_1 * (-1.0))
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * PA_0 * PA_1 * PQ[c1] * (-1.0) + PB_1 * PA_0 * PA_1 * QC_1 * (-1.0))
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * PA_0 * PA_1 * PQ[c1] * (-1.0) + PB_1 * PA_0 * PA_1 * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[c1][d1] * (PB_1 * PA_0 * PA_1 * PQ[d0] * (-1.0) + PB_1 * PA_0 * PA_1 * QD_0 * (-1.0))
                            + delta[b0][c1] * delta[c0][d1] * (PB_1 * PA_0 * PA_1 * PQ[d0] * (-1.0) + PB_1 * PA_0 * PA_1 * QD_0 * (-1.0))
                            + delta[b0][d1] * delta[c0][c1] * (PB_1 * PA_0 * PA_1 * PQ[d0] * (-1.0) + PB_1 * PA_0 * PA_1 * QD_0 * (-1.0))
                            + delta[b0][c0] * delta[c1][d0] * (PB_1 * PA_0 * PA_1 * PQ[d1] * (-1.0) + PB_1 * PA_0 * PA_1 * QD_1 * (-1.0))
                            + delta[b0][c1] * delta[c0][d0] * (PB_1 * PA_0 * PA_1 * PQ[d1] * (-1.0) + PB_1 * PA_0 * PA_1 * QD_1 * (-1.0))
                            + delta[b0][d0] * delta[c0][c1] * (PB_1 * PA_0 * PA_1 * PQ[d1] * (-1.0) + PB_1 * PA_0 * PA_1 * QD_1 * (-1.0))
                            + delta[b0][b1] * delta[d0][d1] * (PA_0 * PA_1 * PQ[c0] * PQ[c1] + PA_0 * PA_1 * PQ[c0] * QC_1 + PA_0 * PA_1 * PQ[c1] * QC_0)
                            + delta[b0][b1] * delta[c1][d1] * (PA_0 * PA_1 * PQ[c0] * PQ[d0] + PA_0 * PA_1 * PQ[c0] * QD_0 + PA_0 * PA_1 * PQ[d0] * QC_0)
                            + delta[b0][b1] * delta[c1][d0] * (PA_0 * PA_1 * PQ[c0] * PQ[d1] + PA_0 * PA_1 * PQ[c0] * QD_1 + PA_0 * PA_1 * PQ[d1] * QC_0)
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * PA_1 * PQ[c1] * PQ[d0] + PA_0 * PA_1 * PQ[c1] * QD_0 + PA_0 * PA_1 * PQ[d0] * QC_1)
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * PA_1 * PQ[c1] * PQ[d1] + PA_0 * PA_1 * PQ[c1] * QD_1 + PA_0 * PA_1 * PQ[d1] * QC_1)
                            + delta[b0][b1] * delta[c0][c1] * (PA_0 * PA_1 * PQ[d0] * PQ[d1] + PA_0 * PA_1 * PQ[d0] * QD_1 + PA_0 * PA_1 * PQ[d1] * QD_0)
                            + delta[a1][c1] * delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PQ[c0] * (-1.0) + PB_0 * PB_1 * PA_0 * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[c1][d1] * (PB_0 * PB_1 * PA_0 * PQ[c0] * (-1.0) + PB_0 * PB_1 * PA_0 * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[c1][d0] * (PB_0 * PB_1 * PA_0 * PQ[c0] * (-1.0) + PB_0 * PB_1 * PA_0 * QC_0 * (-1.0))
                            + delta[a1][c0] * delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PQ[c1] * (-1.0) + PB_0 * PB_1 * PA_0 * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PQ[c1] * (-1.0) + PB_0 * PB_1 * PA_0 * QC_1 * (-1.0))
                            + delta[a1][d1] * delta[c0][d0] * (PB_0 * PB_1 * PA_0 * PQ[c1] * (-1.0) + PB_0 * PB_1 * PA_0 * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[c1][d1] * (PB_0 * PB_1 * PA_0 * PQ[d0] * (-1.0) + PB_0 * PB_1 * PA_0 * QD_0 * (-1.0))
                            + delta[a1][c1] * delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PQ[d0] * (-1.0) + PB_0 * PB_1 * PA_0 * QD_0 * (-1.0))
                            + delta[a1][d1] * delta[c0][c1] * (PB_0 * PB_1 * PA_0 * PQ[d0] * (-1.0) + PB_0 * PB_1 * PA_0 * QD_0 * (-1.0))
                            + delta[a1][c0] * delta[c1][d0] * (PB_0 * PB_1 * PA_0 * PQ[d1] * (-1.0) + PB_0 * PB_1 * PA_0 * QD_1 * (-1.0))
                            + delta[a1][c1] * delta[c0][d0] * (PB_0 * PB_1 * PA_0 * PQ[d1] * (-1.0) + PB_0 * PB_1 * PA_0 * QD_1 * (-1.0))
                            + delta[a1][d0] * delta[c0][c1] * (PB_0 * PB_1 * PA_0 * PQ[d1] * (-1.0) + PB_0 * PB_1 * PA_0 * QD_1 * (-1.0))
                            + delta[a1][b1] * delta[d0][d1] * (PB_0 * PA_0 * PQ[c0] * PQ[c1] + PB_0 * PA_0 * PQ[c0] * QC_1 + PB_0 * PA_0 * PQ[c1] * QC_0)
                            + delta[a1][b1] * delta[c1][d1] * (PB_0 * PA_0 * PQ[c0] * PQ[d0] + PB_0 * PA_0 * PQ[c0] * QD_0 + PB_0 * PA_0 * PQ[d0] * QC_0)
                            + delta[a1][b1] * delta[c1][d0] * (PB_0 * PA_0 * PQ[c0] * PQ[d1] + PB_0 * PA_0 * PQ[c0] * QD_1 + PB_0 * PA_0 * PQ[d1] * QC_0)
                            + delta[a1][b1] * delta[c0][d1] * (PB_0 * PA_0 * PQ[c1] * PQ[d0] + PB_0 * PA_0 * PQ[c1] * QD_0 + PB_0 * PA_0 * PQ[d0] * QC_1)
                            + delta[a1][b1] * delta[c0][d0] * (PB_0 * PA_0 * PQ[c1] * PQ[d1] + PB_0 * PA_0 * PQ[c1] * QD_1 + PB_0 * PA_0 * PQ[d1] * QC_1)
                            + delta[a1][b1] * delta[c0][c1] * (PB_0 * PA_0 * PQ[d0] * PQ[d1] + PB_0 * PA_0 * PQ[d0] * QD_1 + PB_0 * PA_0 * PQ[d1] * QD_0)
                            + delta[a1][b0] * delta[d0][d1] * (PB_1 * PA_0 * PQ[c0] * PQ[c1] + PB_1 * PA_0 * PQ[c0] * QC_1 + PB_1 * PA_0 * PQ[c1] * QC_0)
                            + delta[a1][b0] * delta[c1][d1] * (PB_1 * PA_0 * PQ[c0] * PQ[d0] + PB_1 * PA_0 * PQ[c0] * QD_0 + PB_1 * PA_0 * PQ[d0] * QC_0)
                            + delta[a1][b0] * delta[c1][d0] * (PB_1 * PA_0 * PQ[c0] * PQ[d1] + PB_1 * PA_0 * PQ[c0] * QD_1 + PB_1 * PA_0 * PQ[d1] * QC_0)
                            + delta[a1][b0] * delta[c0][d1] * (PB_1 * PA_0 * PQ[c1] * PQ[d0] + PB_1 * PA_0 * PQ[c1] * QD_0 + PB_1 * PA_0 * PQ[d0] * QC_1)
                            + delta[a1][b0] * delta[c0][d0] * (PB_1 * PA_0 * PQ[c1] * PQ[d1] + PB_1 * PA_0 * PQ[c1] * QD_1 + PB_1 * PA_0 * PQ[d1] * QC_1)
                            + delta[a1][b0] * delta[c0][c1] * (PB_1 * PA_0 * PQ[d0] * PQ[d1] + PB_1 * PA_0 * PQ[d0] * QD_1 + PB_1 * PA_0 * PQ[d1] * QD_0)
                            + delta[a0][c1] * delta[d0][d1] * (PB_0 * PB_1 * PA_1 * PQ[c0] * (-1.0) + PB_0 * PB_1 * PA_1 * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[c1][d1] * (PB_0 * PB_1 * PA_1 * PQ[c0] * (-1.0) + PB_0 * PB_1 * PA_1 * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[c1][d0] * (PB_0 * PB_1 * PA_1 * PQ[c0] * (-1.0) + PB_0 * PB_1 * PA_1 * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * PB_1 * PA_1 * PQ[c1] * (-1.0) + PB_0 * PB_1 * PA_1 * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * PB_1 * PA_1 * PQ[c1] * (-1.0) + PB_0 * PB_1 * PA_1 * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * PB_1 * PA_1 * PQ[c1] * (-1.0) + PB_0 * PB_1 * PA_1 * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[c1][d1] * (PB_0 * PB_1 * PA_1 * PQ[d0] * (-1.0) + PB_0 * PB_1 * PA_1 * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[c0][d1] * (PB_0 * PB_1 * PA_1 * PQ[d0] * (-1.0) + PB_0 * PB_1 * PA_1 * QD_0 * (-1.0))
                            + delta[a0][d1] * delta[c0][c1] * (PB_0 * PB_1 * PA_1 * PQ[d0] * (-1.0) + PB_0 * PB_1 * PA_1 * QD_0 * (-1.0))
                            + delta[a0][c0] * delta[c1][d0] * (PB_0 * PB_1 * PA_1 * PQ[d1] * (-1.0) + PB_0 * PB_1 * PA_1 * QD_1 * (-1.0))
                            + delta[a0][c1] * delta[c0][d0] * (PB_0 * PB_1 * PA_1 * PQ[d1] * (-1.0) + PB_0 * PB_1 * PA_1 * QD_1 * (-1.0))
                            + delta[a0][d0] * delta[c0][c1] * (PB_0 * PB_1 * PA_1 * PQ[d1] * (-1.0) + PB_0 * PB_1 * PA_1 * QD_1 * (-1.0))
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PA_1 * PQ[c0] * PQ[c1] + PB_0 * PA_1 * PQ[c0] * QC_1 + PB_0 * PA_1 * PQ[c1] * QC_0)
                            + delta[a0][b1] * delta[c1][d1] * (PB_0 * PA_1 * PQ[c0] * PQ[d0] + PB_0 * PA_1 * PQ[c0] * QD_0 + PB_0 * PA_1 * PQ[d0] * QC_0)
                            + delta[a0][b1] * delta[c1][d0] * (PB_0 * PA_1 * PQ[c0] * PQ[d1] + PB_0 * PA_1 * PQ[c0] * QD_1 + PB_0 * PA_1 * PQ[d1] * QC_0)
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * PA_1 * PQ[c1] * PQ[d0] + PB_0 * PA_1 * PQ[c1] * QD_0 + PB_0 * PA_1 * PQ[d0] * QC_1)
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PA_1 * PQ[c1] * PQ[d1] + PB_0 * PA_1 * PQ[c1] * QD_1 + PB_0 * PA_1 * PQ[d1] * QC_1)
                            + delta[a0][b1] * delta[c0][c1] * (PB_0 * PA_1 * PQ[d0] * PQ[d1] + PB_0 * PA_1 * PQ[d0] * QD_1 + PB_0 * PA_1 * PQ[d1] * QD_0)
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PA_1 * PQ[c0] * PQ[c1] + PB_1 * PA_1 * PQ[c0] * QC_1 + PB_1 * PA_1 * PQ[c1] * QC_0)
                            + delta[a0][b0] * delta[c1][d1] * (PB_1 * PA_1 * PQ[c0] * PQ[d0] + PB_1 * PA_1 * PQ[c0] * QD_0 + PB_1 * PA_1 * PQ[d0] * QC_0)
                            + delta[a0][b0] * delta[c1][d0] * (PB_1 * PA_1 * PQ[c0] * PQ[d1] + PB_1 * PA_1 * PQ[c0] * QD_1 + PB_1 * PA_1 * PQ[d1] * QC_0)
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * PA_1 * PQ[c1] * PQ[d0] + PB_1 * PA_1 * PQ[c1] * QD_0 + PB_1 * PA_1 * PQ[d0] * QC_1)
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PA_1 * PQ[c1] * PQ[d1] + PB_1 * PA_1 * PQ[c1] * QD_1 + PB_1 * PA_1 * PQ[d1] * QC_1)
                            + delta[a0][b0] * delta[c0][c1] * (PB_1 * PA_1 * PQ[d0] * PQ[d1] + PB_1 * PA_1 * PQ[d0] * QD_1 + PB_1 * PA_1 * PQ[d1] * QD_0)
                            + delta[a0][a1] * delta[d0][d1] * (PB_0 * PB_1 * PQ[c0] * PQ[c1] + PB_0 * PB_1 * PQ[c0] * QC_1 + PB_0 * PB_1 * PQ[c1] * QC_0)
                            + delta[a0][a1] * delta[c1][d1] * (PB_0 * PB_1 * PQ[c0] * PQ[d0] + PB_0 * PB_1 * PQ[c0] * QD_0 + PB_0 * PB_1 * PQ[d0] * QC_0)
                            + delta[a0][a1] * delta[c0][d1] * (PB_0 * PB_1 * PQ[c1] * PQ[d0] + PB_0 * PB_1 * PQ[c1] * QD_0 + PB_0 * PB_1 * PQ[d0] * QC_1)
                            + delta[a0][a1] * delta[c1][d0] * (PB_0 * PB_1 * PQ[c0] * PQ[d1] + PB_0 * PB_1 * PQ[c0] * QD_1 + PB_0 * PB_1 * PQ[d1] * QC_0)
                            + delta[a0][a1] * delta[c0][d0] * (PB_0 * PB_1 * PQ[c1] * PQ[d1] + PB_0 * PB_1 * PQ[c1] * QD_1 + PB_0 * PB_1 * PQ[d1] * QC_1)
                            + delta[a0][a1] * delta[c0][c1] * (PB_0 * PB_1 * PQ[d0] * PQ[d1] + PB_0 * PB_1 * PQ[d0] * QD_1 + PB_0 * PB_1 * PQ[d1] * QD_0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD10(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[3];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[2] * (

                        0.25 * S2 / ( S1 * S4 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PA_0 * PQ[a1] * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[a0] * QC_0 * QC_1 * (-1.0) + PQ[a0] * PQ[a1] * QC_0 * QC_1)
                            + delta[b0][b1] * delta[c1][d1] * (PA_0 * PQ[a1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[a0] * QD_0 * QC_0 * (-1.0) + PQ[a0] * PQ[a1] * QD_0 * QC_0)
                            + delta[b0][b1] * delta[c1][d0] * (PA_0 * PQ[a1] * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[a0] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[a1] * QD_1 * QC_0)
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * PQ[a1] * QD_0 * QC_1 * (-1.0) + PA_1 * PQ[a0] * QD_0 * QC_1 * (-1.0) + PQ[a0] * PQ[a1] * QD_0 * QC_1)
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * PQ[a1] * QD_1 * QC_1 * (-1.0) + PA_1 * PQ[a0] * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[a1] * QD_1 * QC_1)
                            + delta[b0][b1] * delta[c0][c1] * (PA_0 * PQ[a1] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[a0] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * QD_0 * QD_1)
                            + delta[a1][b1] * delta[d0][d1] * (PB_0 * PQ[a0] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[b0] * QC_0 * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * QC_0 * QC_1)
                            + delta[a1][b1] * delta[c1][d1] * (PB_0 * PQ[a0] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[b0] * QD_0 * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * QD_0 * QC_0)
                            + delta[a1][b1] * delta[c1][d0] * (PB_0 * PQ[a0] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[b0] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * QD_1 * QC_0)
                            + delta[a1][b1] * delta[c0][d1] * (PB_0 * PQ[a0] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[b0] * QD_0 * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * QD_0 * QC_1)
                            + delta[a1][b1] * delta[c0][d0] * (PB_0 * PQ[a0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[b0] * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * QD_1 * QC_1)
                            + delta[a1][b1] * delta[c0][c1] * (PB_0 * PQ[a0] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[b0] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * QD_0 * QD_1)
                            + delta[a1][b0] * delta[d0][d1] * (PB_1 * PQ[a0] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[b1] * QC_0 * QC_1 * (-1.0) + PQ[a0] * PQ[b1] * QC_0 * QC_1)
                            + delta[a1][b0] * delta[c1][d1] * (PB_1 * PQ[a0] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[b1] * QD_0 * QC_0 * (-1.0) + PQ[a0] * PQ[b1] * QD_0 * QC_0)
                            + delta[a1][b0] * delta[c1][d0] * (PB_1 * PQ[a0] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[b1] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[b1] * QD_1 * QC_0)
                            + delta[a1][b0] * delta[c0][d1] * (PB_1 * PQ[a0] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[b1] * QD_0 * QC_1 * (-1.0) + PQ[a0] * PQ[b1] * QD_0 * QC_1)
                            + delta[a1][b0] * delta[c0][d0] * (PB_1 * PQ[a0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[b1] * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[b1] * QD_1 * QC_1)
                            + delta[a1][b0] * delta[c0][c1] * (PB_1 * PQ[a0] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[b1] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[b1] * QD_0 * QD_1)
                            + delta[a1][d1] * delta[b0][b1] * (PA_0 * QD_0 * QC_0 * QC_1 * (-1.0) + PQ[a0] * QD_0 * QC_0 * QC_1)
                            + delta[a1][b0] * delta[b1][d1] * (PA_0 * QD_0 * QC_0 * QC_1 * (-1.0) + PQ[a0] * QD_0 * QC_0 * QC_1)
                            + delta[b0][d1] * delta[a1][b1] * (PA_0 * QD_0 * QC_0 * QC_1 * (-1.0) + PQ[a0] * QD_0 * QC_0 * QC_1)
                            + delta[a1][d0] * delta[b0][b1] * (PA_0 * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[a0] * QD_1 * QC_0 * QC_1)
                            + delta[a1][b0] * delta[b1][d0] * (PA_0 * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[a0] * QD_1 * QC_0 * QC_1)
                            + delta[b0][d0] * delta[a1][b1] * (PA_0 * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[a0] * QD_1 * QC_0 * QC_1)
                            + delta[a1][c1] * delta[b0][b1] * (PA_0 * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[a0] * QD_0 * QD_1 * QC_0)
                            + delta[a1][b0] * delta[b1][c1] * (PA_0 * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[a0] * QD_0 * QD_1 * QC_0)
                            + delta[b0][c1] * delta[a1][b1] * (PA_0 * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[a0] * QD_0 * QD_1 * QC_0)
                            + delta[a1][c0] * delta[b0][b1] * (PA_0 * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[a0] * QD_0 * QD_1 * QC_1)
                            + delta[a1][b0] * delta[b1][c0] * (PA_0 * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[a0] * QD_0 * QD_1 * QC_1)
                            + delta[b0][c0] * delta[a1][b1] * (PA_0 * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[a0] * QD_0 * QD_1 * QC_1)
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PQ[a1] * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[b0] * QC_0 * QC_1 * (-1.0) + PQ[a1] * PQ[b0] * QC_0 * QC_1)
                            + delta[a0][b1] * delta[c1][d1] * (PB_0 * PQ[a1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[b0] * QD_0 * QC_0 * (-1.0) + PQ[a1] * PQ[b0] * QD_0 * QC_0)
                            + delta[a0][b1] * delta[c1][d0] * (PB_0 * PQ[a1] * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[b0] * QD_1 * QC_0 * (-1.0) + PQ[a1] * PQ[b0] * QD_1 * QC_0)
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * PQ[a1] * QD_0 * QC_1 * (-1.0) + PA_1 * PQ[b0] * QD_0 * QC_1 * (-1.0) + PQ[a1] * PQ[b0] * QD_0 * QC_1)
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PQ[a1] * QD_1 * QC_1 * (-1.0) + PA_1 * PQ[b0] * QD_1 * QC_1 * (-1.0) + PQ[a1] * PQ[b0] * QD_1 * QC_1)
                            + delta[a0][b1] * delta[c0][c1] * (PB_0 * PQ[a1] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[b0] * QD_0 * QD_1 * (-1.0) + PQ[a1] * PQ[b0] * QD_0 * QD_1)
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PQ[a1] * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[b1] * QC_0 * QC_1 * (-1.0) + PQ[a1] * PQ[b1] * QC_0 * QC_1)
                            + delta[a0][b0] * delta[c1][d1] * (PB_1 * PQ[a1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[b1] * QD_0 * QC_0 * (-1.0) + PQ[a1] * PQ[b1] * QD_0 * QC_0)
                            + delta[a0][b0] * delta[c1][d0] * (PB_1 * PQ[a1] * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[b1] * QD_1 * QC_0 * (-1.0) + PQ[a1] * PQ[b1] * QD_1 * QC_0)
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * PQ[a1] * QD_0 * QC_1 * (-1.0) + PA_1 * PQ[b1] * QD_0 * QC_1 * (-1.0) + PQ[a1] * PQ[b1] * QD_0 * QC_1)
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PQ[a1] * QD_1 * QC_1 * (-1.0) + PA_1 * PQ[b1] * QD_1 * QC_1 * (-1.0) + PQ[a1] * PQ[b1] * QD_1 * QC_1)
                            + delta[a0][b0] * delta[c0][c1] * (PB_1 * PQ[a1] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[b1] * QD_0 * QD_1 * (-1.0) + PQ[a1] * PQ[b1] * QD_0 * QD_1)
                            + delta[a0][d1] * delta[b0][b1] * (PA_1 * QD_0 * QC_0 * QC_1 * (-1.0) + PQ[a1] * QD_0 * QC_0 * QC_1)
                            + delta[a0][b0] * delta[b1][d1] * (PA_1 * QD_0 * QC_0 * QC_1 * (-1.0) + PQ[a1] * QD_0 * QC_0 * QC_1)
                            + delta[b0][d1] * delta[a0][b1] * (PA_1 * QD_0 * QC_0 * QC_1 * (-1.0) + PQ[a1] * QD_0 * QC_0 * QC_1)
                            + delta[a0][d0] * delta[b0][b1] * (PA_1 * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[a1] * QD_1 * QC_0 * QC_1)
                            + delta[a0][b0] * delta[b1][d0] * (PA_1 * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[a1] * QD_1 * QC_0 * QC_1)
                            + delta[b0][d0] * delta[a0][b1] * (PA_1 * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[a1] * QD_1 * QC_0 * QC_1)
                            + delta[a0][c1] * delta[b0][b1] * (PA_1 * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[a1] * QD_0 * QD_1 * QC_0)
                            + delta[a0][b0] * delta[b1][c1] * (PA_1 * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[a1] * QD_0 * QD_1 * QC_0)
                            + delta[b0][c1] * delta[a0][b1] * (PA_1 * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[a1] * QD_0 * QD_1 * QC_0)
                            + delta[a0][c0] * delta[b0][b1] * (PA_1 * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[a1] * QD_0 * QD_1 * QC_1)
                            + delta[a0][b0] * delta[b1][c0] * (PA_1 * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[a1] * QD_0 * QD_1 * QC_1)
                            + delta[b0][c0] * delta[a0][b1] * (PA_1 * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[a1] * QD_0 * QD_1 * QC_1)
                            + delta[a0][a1] * delta[d0][d1] * (PB_0 * PQ[b1] * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[b0] * QC_0 * QC_1 * (-1.0) + PQ[b0] * PQ[b1] * QC_0 * QC_1)
                            + delta[a0][a1] * delta[c1][d1] * (PB_0 * PQ[b1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[b0] * QD_0 * QC_0 * (-1.0) + PQ[b0] * PQ[b1] * QD_0 * QC_0)
                            + delta[a0][a1] * delta[c1][d0] * (PB_0 * PQ[b1] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[b0] * QD_1 * QC_0 * (-1.0) + PQ[b0] * PQ[b1] * QD_1 * QC_0)
                            + delta[a0][a1] * delta[c0][d1] * (PB_0 * PQ[b1] * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[b0] * QD_0 * QC_1 * (-1.0) + PQ[b0] * PQ[b1] * QD_0 * QC_1)
                            + delta[a0][a1] * delta[c0][d0] * (PB_0 * PQ[b1] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[b0] * QD_1 * QC_1 * (-1.0) + PQ[b0] * PQ[b1] * QD_1 * QC_1)
                            + delta[a0][a1] * delta[c0][c1] * (PB_0 * PQ[b1] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[b0] * QD_0 * QD_1 * (-1.0) + PQ[b0] * PQ[b1] * QD_0 * QD_1)
                            + delta[a0][d1] * delta[a1][b1] * (PB_0 * QD_0 * QC_0 * QC_1 * (-1.0) + PQ[b0] * QD_0 * QC_0 * QC_1)
                            + delta[a0][a1] * delta[b1][d1] * (PB_0 * QD_0 * QC_0 * QC_1 * (-1.0) + PQ[b0] * QD_0 * QC_0 * QC_1)
                            + delta[a1][d1] * delta[a0][b1] * (PB_0 * QD_0 * QC_0 * QC_1 * (-1.0) + PQ[b0] * QD_0 * QC_0 * QC_1)
                            + delta[a0][d0] * delta[a1][b1] * (PB_0 * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[b0] * QD_1 * QC_0 * QC_1)
                            + delta[a0][a1] * delta[b1][d0] * (PB_0 * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[b0] * QD_1 * QC_0 * QC_1)
                            + delta[a1][d0] * delta[a0][b1] * (PB_0 * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[b0] * QD_1 * QC_0 * QC_1)
                            + delta[a0][c1] * delta[a1][b1] * (PB_0 * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[b0] * QD_0 * QD_1 * QC_0)
                            + delta[a0][a1] * delta[b1][c1] * (PB_0 * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[b0] * QD_0 * QD_1 * QC_0)
                            + delta[a1][c1] * delta[a0][b1] * (PB_0 * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[b0] * QD_0 * QD_1 * QC_0)
                            + delta[a0][c0] * delta[a1][b1] * (PB_0 * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[b0] * QD_0 * QD_1 * QC_1)
                            + delta[a0][a1] * delta[b1][c0] * (PB_0 * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[b0] * QD_0 * QD_1 * QC_1)
                            + delta[a1][c0] * delta[a0][b1] * (PB_0 * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[b0] * QD_0 * QD_1 * QC_1)
                            + delta[a0][d1] * delta[a1][b0] * (PB_1 * QD_0 * QC_0 * QC_1 * (-1.0) + PQ[b1] * QD_0 * QC_0 * QC_1)
                            + delta[a0][a1] * delta[b0][d1] * (PB_1 * QD_0 * QC_0 * QC_1 * (-1.0) + PQ[b1] * QD_0 * QC_0 * QC_1)
                            + delta[a1][d1] * delta[a0][b0] * (PB_1 * QD_0 * QC_0 * QC_1 * (-1.0) + PQ[b1] * QD_0 * QC_0 * QC_1)
                            + delta[a0][d0] * delta[a1][b0] * (PB_1 * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[b1] * QD_1 * QC_0 * QC_1)
                            + delta[a0][a1] * delta[b0][d0] * (PB_1 * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[b1] * QD_1 * QC_0 * QC_1)
                            + delta[a1][d0] * delta[a0][b0] * (PB_1 * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[b1] * QD_1 * QC_0 * QC_1)
                            + delta[a0][c1] * delta[a1][b0] * (PB_1 * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[b1] * QD_0 * QD_1 * QC_0)
                            + delta[a0][a1] * delta[b0][c1] * (PB_1 * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[b1] * QD_0 * QD_1 * QC_0)
                            + delta[a1][c1] * delta[a0][b0] * (PB_1 * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[b1] * QD_0 * QD_1 * QC_0)
                            + delta[a0][c0] * delta[a1][b0] * (PB_1 * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[b1] * QD_0 * QD_1 * QC_1)
                            + delta[a0][a1] * delta[b0][c0] * (PB_1 * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[b1] * QD_0 * QD_1 * QC_1)
                            + delta[a1][c0] * delta[a0][b0] * (PB_1 * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[b1] * QD_0 * QD_1 * QC_1)
                            + delta[a0][a1] * delta[b0][b1] * (PQ[c0] * QD_0 * QD_1 * QC_1 * 2.0 + PQ[c1] * QD_0 * QD_1 * QC_0 * 2.0 + PQ[d0] * QD_1 * QC_0 * QC_1 * 2.0 + PQ[d1] * QD_0 * QC_0 * QC_1 * 2.0)
                            + delta[a0][b0] * delta[a1][b1] * (PQ[c0] * QD_0 * QD_1 * QC_1 * 2.0 + PQ[c1] * QD_0 * QD_1 * QC_0 * 2.0 + PQ[d0] * QD_1 * QC_0 * QC_1 * 2.0 + PQ[d1] * QD_0 * QC_0 * QC_1 * 2.0)
                            + delta[a1][b0] * delta[a0][b1] * (PQ[c0] * QD_0 * QD_1 * QC_1 * 2.0 + PQ[c1] * QD_0 * QD_1 * QC_0 * 2.0 + PQ[d0] * QD_1 * QC_0 * QC_1 * 2.0 + PQ[d1] * QD_0 * QC_0 * QC_1 * 2.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD11(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[3];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[2] * (

                        0.25 / ( S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] + PB_0 * PA_0 * PQ[a1] * PQ[b1] + PB_0 * PA_1 * PQ[a0] * PQ[b1] + PB_1 * PA_0 * PQ[a1] * PQ[b0] + PB_1 * PA_1 * PQ[a0] * PQ[b0] + PA_0 * PA_1 * PQ[b0] * PQ[b1])
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] + PB_0 * PA_0 * PQ[a1] * PQ[b1] + PB_0 * PA_1 * PQ[a0] * PQ[b1] + PB_1 * PA_0 * PQ[a1] * PQ[b0] + PB_1 * PA_1 * PQ[a0] * PQ[b0] + PA_0 * PA_1 * PQ[b0] * PQ[b1])
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] + PB_0 * PA_0 * PQ[a1] * PQ[b1] + PB_0 * PA_1 * PQ[a0] * PQ[b1] + PB_1 * PA_0 * PQ[a1] * PQ[b0] + PB_1 * PA_1 * PQ[a0] * PQ[b0] + PA_0 * PA_1 * PQ[b0] * PQ[b1])
                            + delta[b1][c1] * delta[d0][d1] * (PB_0 * PA_0 * PQ[a1] * QC_0 + PB_0 * PA_1 * PQ[a0] * QC_0 + PA_0 * PA_1 * PQ[b0] * QC_0)
                            + delta[b1][d0] * delta[c1][d1] * (PB_0 * PA_0 * PQ[a1] * QC_0 + PB_0 * PA_1 * PQ[a0] * QC_0 + PA_0 * PA_1 * PQ[b0] * QC_0)
                            + delta[b1][d1] * delta[c1][d0] * (PB_0 * PA_0 * PQ[a1] * QC_0 + PB_0 * PA_1 * PQ[a0] * QC_0 + PA_0 * PA_1 * PQ[b0] * QC_0)
                            + delta[b1][c0] * delta[d0][d1] * (PB_0 * PA_0 * PQ[a1] * QC_1 + PB_0 * PA_1 * PQ[a0] * QC_1 + PA_0 * PA_1 * PQ[b0] * QC_1)
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * PA_0 * PQ[a1] * QC_1 + PB_0 * PA_1 * PQ[a0] * QC_1 + PA_0 * PA_1 * PQ[b0] * QC_1)
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * PA_0 * PQ[a1] * QC_1 + PB_0 * PA_1 * PQ[a0] * QC_1 + PA_0 * PA_1 * PQ[b0] * QC_1)
                            + delta[b1][c0] * delta[c1][d1] * (PB_0 * PA_0 * PQ[a1] * QD_0 + PB_0 * PA_1 * PQ[a0] * QD_0 + PA_0 * PA_1 * PQ[b0] * QD_0)
                            + delta[b1][c1] * delta[c0][d1] * (PB_0 * PA_0 * PQ[a1] * QD_0 + PB_0 * PA_1 * PQ[a0] * QD_0 + PA_0 * PA_1 * PQ[b0] * QD_0)
                            + delta[b1][d1] * delta[c0][c1] * (PB_0 * PA_0 * PQ[a1] * QD_0 + PB_0 * PA_1 * PQ[a0] * QD_0 + PA_0 * PA_1 * PQ[b0] * QD_0)
                            + delta[b1][c0] * delta[c1][d0] * (PB_0 * PA_0 * PQ[a1] * QD_1 + PB_0 * PA_1 * PQ[a0] * QD_1 + PA_0 * PA_1 * PQ[b0] * QD_1)
                            + delta[b1][c1] * delta[c0][d0] * (PB_0 * PA_0 * PQ[a1] * QD_1 + PB_0 * PA_1 * PQ[a0] * QD_1 + PA_0 * PA_1 * PQ[b0] * QD_1)
                            + delta[b1][d0] * delta[c0][c1] * (PB_0 * PA_0 * PQ[a1] * QD_1 + PB_0 * PA_1 * PQ[a0] * QD_1 + PA_0 * PA_1 * PQ[b0] * QD_1)
                            + delta[b0][c1] * delta[d0][d1] * (PB_1 * PA_0 * PQ[a1] * QC_0 + PB_1 * PA_1 * PQ[a0] * QC_0 + PA_0 * PA_1 * PQ[b1] * QC_0)
                            + delta[b0][d0] * delta[c1][d1] * (PB_1 * PA_0 * PQ[a1] * QC_0 + PB_1 * PA_1 * PQ[a0] * QC_0 + PA_0 * PA_1 * PQ[b1] * QC_0)
                            + delta[b0][d1] * delta[c1][d0] * (PB_1 * PA_0 * PQ[a1] * QC_0 + PB_1 * PA_1 * PQ[a0] * QC_0 + PA_0 * PA_1 * PQ[b1] * QC_0)
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * PA_0 * PQ[a1] * QC_1 + PB_1 * PA_1 * PQ[a0] * QC_1 + PA_0 * PA_1 * PQ[b1] * QC_1)
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * PA_0 * PQ[a1] * QC_1 + PB_1 * PA_1 * PQ[a0] * QC_1 + PA_0 * PA_1 * PQ[b1] * QC_1)
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * PA_0 * PQ[a1] * QC_1 + PB_1 * PA_1 * PQ[a0] * QC_1 + PA_0 * PA_1 * PQ[b1] * QC_1)
                            + delta[b0][c0] * delta[c1][d1] * (PB_1 * PA_0 * PQ[a1] * QD_0 + PB_1 * PA_1 * PQ[a0] * QD_0 + PA_0 * PA_1 * PQ[b1] * QD_0)
                            + delta[b0][c1] * delta[c0][d1] * (PB_1 * PA_0 * PQ[a1] * QD_0 + PB_1 * PA_1 * PQ[a0] * QD_0 + PA_0 * PA_1 * PQ[b1] * QD_0)
                            + delta[b0][d1] * delta[c0][c1] * (PB_1 * PA_0 * PQ[a1] * QD_0 + PB_1 * PA_1 * PQ[a0] * QD_0 + PA_0 * PA_1 * PQ[b1] * QD_0)
                            + delta[b0][c0] * delta[c1][d0] * (PB_1 * PA_0 * PQ[a1] * QD_1 + PB_1 * PA_1 * PQ[a0] * QD_1 + PA_0 * PA_1 * PQ[b1] * QD_1)
                            + delta[b0][c1] * delta[c0][d0] * (PB_1 * PA_0 * PQ[a1] * QD_1 + PB_1 * PA_1 * PQ[a0] * QD_1 + PA_0 * PA_1 * PQ[b1] * QD_1)
                            + delta[b0][d0] * delta[c0][c1] * (PB_1 * PA_0 * PQ[a1] * QD_1 + PB_1 * PA_1 * PQ[a0] * QD_1 + PA_0 * PA_1 * PQ[b1] * QD_1)
                            + delta[b0][b1] * delta[d0][d1] * (PA_0 * PQ[a1] * PQ[c0] * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[c1] * QC_0 * (-1.0) + PA_0 * PQ[a1] * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[c1] * QC_0 * (-1.0) + PA_1 * PQ[a0] * QC_0 * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[c0] * QC_1 + PA_0 * PA_1 * PQ[c1] * QC_0 + PA_0 * PA_1 * QC_0 * QC_1)
                            + delta[b0][b1] * delta[c1][d1] * (PA_0 * PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PQ[a1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[d0] * QC_0 * (-1.0) + PA_1 * PQ[a0] * QD_0 * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[c0] * QD_0 + PA_0 * PA_1 * PQ[d0] * QC_0 + PA_0 * PA_1 * QD_0 * QC_0)
                            + delta[b0][b1] * delta[c1][d0] * (PA_0 * PQ[a1] * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[a1] * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[d1] * QC_0 * (-1.0) + PA_1 * PQ[a0] * QD_1 * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[c0] * QD_1 + PA_0 * PA_1 * PQ[d1] * QC_0 + PA_0 * PA_1 * QD_1 * QC_0)
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * PQ[a1] * PQ[c1] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[d0] * QC_1 * (-1.0) + PA_0 * PQ[a1] * QD_0 * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[c1] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[d0] * QC_1 * (-1.0) + PA_1 * PQ[a0] * QD_0 * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[c1] * QD_0 + PA_0 * PA_1 * PQ[d0] * QC_1 + PA_0 * PA_1 * QD_0 * QC_1)
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * PQ[a1] * PQ[c1] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[d1] * QC_1 * (-1.0) + PA_0 * PQ[a1] * QD_1 * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[c1] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[d1] * QC_1 * (-1.0) + PA_1 * PQ[a0] * QD_1 * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[c1] * QD_1 + PA_0 * PA_1 * PQ[d1] * QC_1 + PA_0 * PA_1 * QD_1 * QC_1)
                            + delta[b0][b1] * delta[c0][c1] * (PA_0 * PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[a1] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[a0] * QD_0 * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[d0] * QD_1 + PA_0 * PA_1 * PQ[d1] * QD_0 + PA_0 * PA_1 * QD_0 * QD_1)
                            + delta[b0][d0] * delta[b1][d1] * (PA_0 * PA_1 * QC_0 * QC_1)
                            + delta[b0][d1] * delta[b1][d0] * (PA_0 * PA_1 * QC_0 * QC_1)
                            + delta[b0][c1] * delta[b1][d1] * (PA_0 * PA_1 * QD_0 * QC_0)
                            + delta[b0][d1] * delta[b1][c1] * (PA_0 * PA_1 * QD_0 * QC_0)
                            + delta[b0][c1] * delta[b1][d0] * (PA_0 * PA_1 * QD_1 * QC_0)
                            + delta[b0][d0] * delta[b1][c1] * (PA_0 * PA_1 * QD_1 * QC_0)
                            + delta[b0][c0] * delta[b1][d1] * (PA_0 * PA_1 * QD_0 * QC_1)
                            + delta[b0][d1] * delta[b1][c0] * (PA_0 * PA_1 * QD_0 * QC_1)
                            + delta[b0][c0] * delta[b1][d0] * (PA_0 * PA_1 * QD_1 * QC_1)
                            + delta[b0][d0] * delta[b1][c0] * (PA_0 * PA_1 * QD_1 * QC_1)
                            + delta[b0][c0] * delta[b1][c1] * (PA_0 * PA_1 * QD_0 * QD_1)
                            + delta[b0][c1] * delta[b1][c0] * (PA_0 * PA_1 * QD_0 * QD_1)
                            + delta[a1][c1] * delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * QC_0 + PB_0 * PA_0 * PQ[b1] * QC_0 + PB_1 * PA_0 * PQ[b0] * QC_0)
                            + delta[a1][d0] * delta[c1][d1] * (PB_0 * PB_1 * PQ[a0] * QC_0 + PB_0 * PA_0 * PQ[b1] * QC_0 + PB_1 * PA_0 * PQ[b0] * QC_0)
                            + delta[a1][d1] * delta[c1][d0] * (PB_0 * PB_1 * PQ[a0] * QC_0 + PB_0 * PA_0 * PQ[b1] * QC_0 + PB_1 * PA_0 * PQ[b0] * QC_0)
                            + delta[a1][c0] * delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * QC_1 + PB_0 * PA_0 * PQ[b1] * QC_1 + PB_1 * PA_0 * PQ[b0] * QC_1)
                            + delta[a1][d0] * delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] * QC_1 + PB_0 * PA_0 * PQ[b1] * QC_1 + PB_1 * PA_0 * PQ[b0] * QC_1)
                            + delta[a1][d1] * delta[c0][d0] * (PB_0 * PB_1 * PQ[a0] * QC_1 + PB_0 * PA_0 * PQ[b1] * QC_1 + PB_1 * PA_0 * PQ[b0] * QC_1)
                            + delta[a1][c0] * delta[c1][d1] * (PB_0 * PB_1 * PQ[a0] * QD_0 + PB_0 * PA_0 * PQ[b1] * QD_0 + PB_1 * PA_0 * PQ[b0] * QD_0)
                            + delta[a1][c1] * delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] * QD_0 + PB_0 * PA_0 * PQ[b1] * QD_0 + PB_1 * PA_0 * PQ[b0] * QD_0)
                            + delta[a1][d1] * delta[c0][c1] * (PB_0 * PB_1 * PQ[a0] * QD_0 + PB_0 * PA_0 * PQ[b1] * QD_0 + PB_1 * PA_0 * PQ[b0] * QD_0)
                            + delta[a1][c0] * delta[c1][d0] * (PB_0 * PB_1 * PQ[a0] * QD_1 + PB_0 * PA_0 * PQ[b1] * QD_1 + PB_1 * PA_0 * PQ[b0] * QD_1)
                            + delta[a1][c1] * delta[c0][d0] * (PB_0 * PB_1 * PQ[a0] * QD_1 + PB_0 * PA_0 * PQ[b1] * QD_1 + PB_1 * PA_0 * PQ[b0] * QD_1)
                            + delta[a1][d0] * delta[c0][c1] * (PB_0 * PB_1 * PQ[a0] * QD_1 + PB_0 * PA_0 * PQ[b1] * QD_1 + PB_1 * PA_0 * PQ[b0] * QD_1)
                            + delta[a1][b1] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[c0] * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[c1] * QC_0 * (-1.0) + PB_0 * PQ[a0] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * QC_0 * (-1.0) + PA_0 * PQ[b0] * QC_0 * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[c0] * QC_1 + PB_0 * PA_0 * PQ[c1] * QC_0 + PB_0 * PA_0 * QC_0 * QC_1)
                            + delta[a1][b1] * delta[c1][d1] * (PB_0 * PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[a0] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PQ[a0] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PQ[b0] * QD_0 * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[c0] * QD_0 + PB_0 * PA_0 * PQ[d0] * QC_0 + PB_0 * PA_0 * QD_0 * QC_0)
                            + delta[a1][b1] * delta[c1][d0] * (PB_0 * PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PQ[a0] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[b0] * QD_1 * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[c0] * QD_1 + PB_0 * PA_0 * PQ[d1] * QC_0 + PB_0 * PA_0 * QD_1 * QC_0)
                            + delta[a1][b1] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[c1] * QD_0 * (-1.0) + PB_0 * PQ[a0] * PQ[d0] * QC_1 * (-1.0) + PB_0 * PQ[a0] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * QC_1 * (-1.0) + PA_0 * PQ[b0] * QD_0 * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[c1] * QD_0 + PB_0 * PA_0 * PQ[d0] * QC_1 + PB_0 * PA_0 * QD_0 * QC_1)
                            + delta[a1][b1] * delta[c0][d0] * (PB_0 * PQ[a0] * PQ[c1] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[d1] * QC_1 * (-1.0) + PB_0 * PQ[a0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * QC_1 * (-1.0) + PA_0 * PQ[b0] * QD_1 * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[c1] * QD_1 + PB_0 * PA_0 * PQ[d1] * QC_1 + PB_0 * PA_0 * QD_1 * QC_1)
                            + delta[a1][b1] * delta[c0][c1] * (PB_0 * PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[a0] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[b0] * QD_0 * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[d0] * QD_1 + PB_0 * PA_0 * PQ[d1] * QD_0 + PB_0 * PA_0 * QD_0 * QD_1)
                            + delta[a1][d0] * delta[b1][d1] * (PB_0 * PA_0 * QC_0 * QC_1)
                            + delta[a1][d1] * delta[b1][d0] * (PB_0 * PA_0 * QC_0 * QC_1)
                            + delta[a1][c1] * delta[b1][d1] * (PB_0 * PA_0 * QD_0 * QC_0)
                            + delta[a1][d1] * delta[b1][c1] * (PB_0 * PA_0 * QD_0 * QC_0)
                            + delta[a1][c1] * delta[b1][d0] * (PB_0 * PA_0 * QD_1 * QC_0)
                            + delta[a1][d0] * delta[b1][c1] * (PB_0 * PA_0 * QD_1 * QC_0)
                            + delta[a1][c0] * delta[b1][d1] * (PB_0 * PA_0 * QD_0 * QC_1)
                            + delta[a1][d1] * delta[b1][c0] * (PB_0 * PA_0 * QD_0 * QC_1)
                            + delta[a1][c0] * delta[b1][d0] * (PB_0 * PA_0 * QD_1 * QC_1)
                            + delta[a1][d0] * delta[b1][c0] * (PB_0 * PA_0 * QD_1 * QC_1)
                            + delta[a1][c0] * delta[b1][c1] * (PB_0 * PA_0 * QD_0 * QD_1)
                            + delta[a1][c1] * delta[b1][c0] * (PB_0 * PA_0 * QD_0 * QD_1)
                            + delta[a1][b0] * delta[d0][d1] * (PB_1 * PQ[a0] * PQ[c0] * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[c1] * QC_0 * (-1.0) + PB_1 * PQ[a0] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c1] * QC_0 * (-1.0) + PA_0 * PQ[b1] * QC_0 * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[c0] * QC_1 + PB_1 * PA_0 * PQ[c1] * QC_0 + PB_1 * PA_0 * QC_0 * QC_1)
                            + delta[a1][b0] * delta[c1][d1] * (PB_1 * PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PQ[a0] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PQ[b1] * QD_0 * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[c0] * QD_0 + PB_1 * PA_0 * PQ[d0] * QC_0 + PB_1 * PA_0 * QD_0 * QC_0)
                            + delta[a1][b0] * delta[c1][d0] * (PB_1 * PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PQ[a0] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[b1] * QD_1 * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[c0] * QD_1 + PB_1 * PA_0 * PQ[d1] * QC_0 + PB_1 * PA_0 * QD_1 * QC_0)
                            + delta[a1][b0] * delta[c0][d1] * (PB_1 * PQ[a0] * PQ[c1] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[d0] * QC_1 * (-1.0) + PB_1 * PQ[a0] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * QC_1 * (-1.0) + PA_0 * PQ[b1] * QD_0 * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[c1] * QD_0 + PB_1 * PA_0 * PQ[d0] * QC_1 + PB_1 * PA_0 * QD_0 * QC_1)
                            + delta[a1][b0] * delta[c0][d0] * (PB_1 * PQ[a0] * PQ[c1] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[d1] * QC_1 * (-1.0) + PB_1 * PQ[a0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * QC_1 * (-1.0) + PA_0 * PQ[b1] * QD_1 * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[c1] * QD_1 + PB_1 * PA_0 * PQ[d1] * QC_1 + PB_1 * PA_0 * QD_1 * QC_1)
                            + delta[a1][b0] * delta[c0][c1] * (PB_1 * PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[a0] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[b1] * QD_0 * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[d0] * QD_1 + PB_1 * PA_0 * PQ[d1] * QD_0 + PB_1 * PA_0 * QD_0 * QD_1)
                            + delta[a1][d0] * delta[b0][d1] * (PB_1 * PA_0 * QC_0 * QC_1)
                            + delta[a1][d1] * delta[b0][d0] * (PB_1 * PA_0 * QC_0 * QC_1)
                            + delta[a1][c1] * delta[b0][d1] * (PB_1 * PA_0 * QD_0 * QC_0)
                            + delta[a1][d1] * delta[b0][c1] * (PB_1 * PA_0 * QD_0 * QC_0)
                            + delta[a1][c1] * delta[b0][d0] * (PB_1 * PA_0 * QD_1 * QC_0)
                            + delta[a1][d0] * delta[b0][c1] * (PB_1 * PA_0 * QD_1 * QC_0)
                            + delta[a1][c0] * delta[b0][d1] * (PB_1 * PA_0 * QD_0 * QC_1)
                            + delta[a1][d1] * delta[b0][c0] * (PB_1 * PA_0 * QD_0 * QC_1)
                            + delta[a1][c0] * delta[b0][d0] * (PB_1 * PA_0 * QD_1 * QC_1)
                            + delta[a1][d0] * delta[b0][c0] * (PB_1 * PA_0 * QD_1 * QC_1)
                            + delta[a1][c0] * delta[b0][c1] * (PB_1 * PA_0 * QD_0 * QD_1)
                            + delta[a1][c1] * delta[b0][c0] * (PB_1 * PA_0 * QD_0 * QD_1)
                            + delta[a1][d1] * delta[b0][b1] * (PA_0 * PQ[c0] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[c1] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[b1][d1] * (PA_0 * PQ[c0] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[c1] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][d1] * delta[a1][b1] * (PA_0 * PQ[c0] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[c1] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[b0][b1] * (PA_0 * PQ[c0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[c1] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[b1][d0] * (PA_0 * PQ[c0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[c1] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][d0] * delta[a1][b1] * (PA_0 * PQ[c0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[c1] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a1][c1] * delta[b0][b1] * (PA_0 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][c1] * (PA_0 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[b0][c1] * delta[a1][b1] * (PA_0 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a1][c0] * delta[b0][b1] * (PA_0 * PQ[c1] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[d0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[b1][c0] * (PA_0 * PQ[c1] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[d0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[a1][b1] * (PA_0 * PQ[c1] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[d0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[a0][c1] * delta[d0][d1] * (PB_0 * PB_1 * PQ[a1] * QC_0 + PB_0 * PA_1 * PQ[b1] * QC_0 + PB_1 * PA_1 * PQ[b0] * QC_0)
                            + delta[a0][d0] * delta[c1][d1] * (PB_0 * PB_1 * PQ[a1] * QC_0 + PB_0 * PA_1 * PQ[b1] * QC_0 + PB_1 * PA_1 * PQ[b0] * QC_0)
                            + delta[a0][d1] * delta[c1][d0] * (PB_0 * PB_1 * PQ[a1] * QC_0 + PB_0 * PA_1 * PQ[b1] * QC_0 + PB_1 * PA_1 * PQ[b0] * QC_0)
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * PB_1 * PQ[a1] * QC_1 + PB_0 * PA_1 * PQ[b1] * QC_1 + PB_1 * PA_1 * PQ[b0] * QC_1)
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * PB_1 * PQ[a1] * QC_1 + PB_0 * PA_1 * PQ[b1] * QC_1 + PB_1 * PA_1 * PQ[b0] * QC_1)
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * PB_1 * PQ[a1] * QC_1 + PB_0 * PA_1 * PQ[b1] * QC_1 + PB_1 * PA_1 * PQ[b0] * QC_1)
                            + delta[a0][c0] * delta[c1][d1] * (PB_0 * PB_1 * PQ[a1] * QD_0 + PB_0 * PA_1 * PQ[b1] * QD_0 + PB_1 * PA_1 * PQ[b0] * QD_0)
                            + delta[a0][c1] * delta[c0][d1] * (PB_0 * PB_1 * PQ[a1] * QD_0 + PB_0 * PA_1 * PQ[b1] * QD_0 + PB_1 * PA_1 * PQ[b0] * QD_0)
                            + delta[a0][d1] * delta[c0][c1] * (PB_0 * PB_1 * PQ[a1] * QD_0 + PB_0 * PA_1 * PQ[b1] * QD_0 + PB_1 * PA_1 * PQ[b0] * QD_0)
                            + delta[a0][c0] * delta[c1][d0] * (PB_0 * PB_1 * PQ[a1] * QD_1 + PB_0 * PA_1 * PQ[b1] * QD_1 + PB_1 * PA_1 * PQ[b0] * QD_1)
                            + delta[a0][c1] * delta[c0][d0] * (PB_0 * PB_1 * PQ[a1] * QD_1 + PB_0 * PA_1 * PQ[b1] * QD_1 + PB_1 * PA_1 * PQ[b0] * QD_1)
                            + delta[a0][d0] * delta[c0][c1] * (PB_0 * PB_1 * PQ[a1] * QD_1 + PB_0 * PA_1 * PQ[b1] * QD_1 + PB_1 * PA_1 * PQ[b0] * QD_1)
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PQ[a1] * PQ[c0] * QC_1 * (-1.0) + PB_0 * PQ[a1] * PQ[c1] * QC_0 * (-1.0) + PB_0 * PQ[a1] * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[c1] * QC_0 * (-1.0) + PA_1 * PQ[b0] * QC_0 * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[c0] * QC_1 + PB_0 * PA_1 * PQ[c1] * QC_0 + PB_0 * PA_1 * QC_0 * QC_1)
                            + delta[a0][b1] * delta[c1][d1] * (PB_0 * PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[a1] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PQ[a1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PA_1 * PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PA_1 * PQ[b0] * QD_0 * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[c0] * QD_0 + PB_0 * PA_1 * PQ[d0] * QC_0 + PB_0 * PA_1 * QD_0 * QC_0)
                            + delta[a0][b1] * delta[c1][d0] * (PB_0 * PQ[a1] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[a1] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PQ[a1] * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PA_1 * PQ[b0] * PQ[d1] * QC_0 * (-1.0) + PA_1 * PQ[b0] * QD_1 * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[c0] * QD_1 + PB_0 * PA_1 * PQ[d1] * QC_0 + PB_0 * PA_1 * QD_1 * QC_0)
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * PQ[a1] * PQ[c1] * QD_0 * (-1.0) + PB_0 * PQ[a1] * PQ[d0] * QC_1 * (-1.0) + PB_0 * PQ[a1] * QD_0 * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PA_1 * PQ[b0] * PQ[d0] * QC_1 * (-1.0) + PA_1 * PQ[b0] * QD_0 * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[c1] * QD_0 + PB_0 * PA_1 * PQ[d0] * QC_1 + PB_0 * PA_1 * QD_0 * QC_1)
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PQ[a1] * PQ[c1] * QD_1 * (-1.0) + PB_0 * PQ[a1] * PQ[d1] * QC_1 * (-1.0) + PB_0 * PQ[a1] * QD_1 * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PA_1 * PQ[b0] * PQ[d1] * QC_1 * (-1.0) + PA_1 * PQ[b0] * QD_1 * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[c1] * QD_1 + PB_0 * PA_1 * PQ[d1] * QC_1 + PB_0 * PA_1 * QD_1 * QC_1)
                            + delta[a0][b1] * delta[c0][c1] * (PB_0 * PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[a1] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[a1] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[b0] * QD_0 * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[d0] * QD_1 + PB_0 * PA_1 * PQ[d1] * QD_0 + PB_0 * PA_1 * QD_0 * QD_1)
                            + delta[a0][d0] * delta[b1][d1] * (PB_0 * PA_1 * QC_0 * QC_1)
                            + delta[a0][d1] * delta[b1][d0] * (PB_0 * PA_1 * QC_0 * QC_1)
                            + delta[a0][c1] * delta[b1][d1] * (PB_0 * PA_1 * QD_0 * QC_0)
                            + delta[a0][d1] * delta[b1][c1] * (PB_0 * PA_1 * QD_0 * QC_0)
                            + delta[a0][c1] * delta[b1][d0] * (PB_0 * PA_1 * QD_1 * QC_0)
                            + delta[a0][d0] * delta[b1][c1] * (PB_0 * PA_1 * QD_1 * QC_0)
                            + delta[a0][c0] * delta[b1][d1] * (PB_0 * PA_1 * QD_0 * QC_1)
                            + delta[a0][d1] * delta[b1][c0] * (PB_0 * PA_1 * QD_0 * QC_1)
                            + delta[a0][c0] * delta[b1][d0] * (PB_0 * PA_1 * QD_1 * QC_1)
                            + delta[a0][d0] * delta[b1][c0] * (PB_0 * PA_1 * QD_1 * QC_1)
                            + delta[a0][c0] * delta[b1][c1] * (PB_0 * PA_1 * QD_0 * QD_1)
                            + delta[a0][c1] * delta[b1][c0] * (PB_0 * PA_1 * QD_0 * QD_1)
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PQ[a1] * PQ[c0] * QC_1 * (-1.0) + PB_1 * PQ[a1] * PQ[c1] * QC_0 * (-1.0) + PB_1 * PQ[a1] * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PA_1 * PQ[b1] * PQ[c1] * QC_0 * (-1.0) + PA_1 * PQ[b1] * QC_0 * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[c0] * QC_1 + PB_1 * PA_1 * PQ[c1] * QC_0 + PB_1 * PA_1 * QC_0 * QC_1)
                            + delta[a0][b0] * delta[c1][d1] * (PB_1 * PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[a1] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PQ[a1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PA_1 * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PA_1 * PQ[b1] * QD_0 * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[c0] * QD_0 + PB_1 * PA_1 * PQ[d0] * QC_0 + PB_1 * PA_1 * QD_0 * QC_0)
                            + delta[a0][b0] * delta[c1][d0] * (PB_1 * PQ[a1] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[a1] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PQ[a1] * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PA_1 * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PA_1 * PQ[b1] * QD_1 * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[c0] * QD_1 + PB_1 * PA_1 * PQ[d1] * QC_0 + PB_1 * PA_1 * QD_1 * QC_0)
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * PQ[a1] * PQ[c1] * QD_0 * (-1.0) + PB_1 * PQ[a1] * PQ[d0] * QC_1 * (-1.0) + PB_1 * PQ[a1] * QD_0 * QC_1 * (-1.0) + PA_1 * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PA_1 * PQ[b1] * PQ[d0] * QC_1 * (-1.0) + PA_1 * PQ[b1] * QD_0 * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[c1] * QD_0 + PB_1 * PA_1 * PQ[d0] * QC_1 + PB_1 * PA_1 * QD_0 * QC_1)
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PQ[a1] * PQ[c1] * QD_1 * (-1.0) + PB_1 * PQ[a1] * PQ[d1] * QC_1 * (-1.0) + PB_1 * PQ[a1] * QD_1 * QC_1 * (-1.0) + PA_1 * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PA_1 * PQ[b1] * PQ[d1] * QC_1 * (-1.0) + PA_1 * PQ[b1] * QD_1 * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[c1] * QD_1 + PB_1 * PA_1 * PQ[d1] * QC_1 + PB_1 * PA_1 * QD_1 * QC_1)
                            + delta[a0][b0] * delta[c0][c1] * (PB_1 * PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[a1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[a1] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[b1] * QD_0 * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[d0] * QD_1 + PB_1 * PA_1 * PQ[d1] * QD_0 + PB_1 * PA_1 * QD_0 * QD_1)
                            + delta[a0][d0] * delta[b0][d1] * (PB_1 * PA_1 * QC_0 * QC_1)
                            + delta[a0][d1] * delta[b0][d0] * (PB_1 * PA_1 * QC_0 * QC_1)
                            + delta[a0][c1] * delta[b0][d1] * (PB_1 * PA_1 * QD_0 * QC_0)
                            + delta[a0][d1] * delta[b0][c1] * (PB_1 * PA_1 * QD_0 * QC_0)
                            + delta[a0][c1] * delta[b0][d0] * (PB_1 * PA_1 * QD_1 * QC_0)
                            + delta[a0][d0] * delta[b0][c1] * (PB_1 * PA_1 * QD_1 * QC_0)
                            + delta[a0][c0] * delta[b0][d1] * (PB_1 * PA_1 * QD_0 * QC_1)
                            + delta[a0][d1] * delta[b0][c0] * (PB_1 * PA_1 * QD_0 * QC_1)
                            + delta[a0][c0] * delta[b0][d0] * (PB_1 * PA_1 * QD_1 * QC_1)
                            + delta[a0][d0] * delta[b0][c0] * (PB_1 * PA_1 * QD_1 * QC_1)
                            + delta[a0][c0] * delta[b0][c1] * (PB_1 * PA_1 * QD_0 * QD_1)
                            + delta[a0][c1] * delta[b0][c0] * (PB_1 * PA_1 * QD_0 * QD_1)
                            + delta[a0][d1] * delta[b0][b1] * (PA_1 * PQ[c0] * QD_0 * QC_1 * (-1.0) + PA_1 * PQ[c1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * (PA_1 * PQ[c0] * QD_0 * QC_1 * (-1.0) + PA_1 * PQ[c1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * (PA_1 * PQ[c0] * QD_0 * QC_1 * (-1.0) + PA_1 * PQ[c1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * (PA_1 * PQ[c0] * QD_1 * QC_1 * (-1.0) + PA_1 * PQ[c1] * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * (PA_1 * PQ[c0] * QD_1 * QC_1 * (-1.0) + PA_1 * PQ[c1] * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * (PA_1 * PQ[c0] * QD_1 * QC_1 * (-1.0) + PA_1 * PQ[c1] * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][c1] * delta[b0][b1] * (PA_1 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][c1] * (PA_1 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[b0][c1] * delta[a0][b1] * (PA_1 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * (PA_1 * PQ[c1] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[d0] * QD_1 * QC_1 * (-1.0) + PA_1 * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * (PA_1 * PQ[c1] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[d0] * QD_1 * QC_1 * (-1.0) + PA_1 * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * (PA_1 * PQ[c1] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[d0] * QD_1 * QC_1 * (-1.0) + PA_1 * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[d0][d1] * (PB_0 * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PB_0 * PQ[b1] * PQ[c1] * QC_0 * (-1.0) + PB_0 * PQ[b1] * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * QC_0 * (-1.0) + PB_1 * PQ[b0] * QC_0 * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[c0] * QC_1 + PB_0 * PB_1 * PQ[c1] * QC_0 + PB_0 * PB_1 * QC_0 * QC_1)
                            + delta[a0][a1] * delta[c1][d1] * (PB_0 * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PQ[b1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PQ[b0] * QD_0 * QC_0 * (-1.0) + PB_0 * PB_1 * PQ[c0] * QD_0 + PB_0 * PB_1 * PQ[d0] * QC_0 + PB_0 * PB_1 * QD_0 * QC_0)
                            + delta[a0][a1] * delta[c0][d1] * (PB_0 * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PB_0 * PQ[b1] * PQ[d0] * QC_1 * (-1.0) + PB_0 * PQ[b1] * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * QC_1 * (-1.0) + PB_1 * PQ[b0] * QD_0 * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[c1] * QD_0 + PB_0 * PB_1 * PQ[d0] * QC_1 + PB_0 * PB_1 * QD_0 * QC_1)
                            + delta[a0][a1] * delta[c1][d0] * (PB_0 * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PQ[b1] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PQ[b0] * QD_1 * QC_0 * (-1.0) + PB_0 * PB_1 * PQ[c0] * QD_1 + PB_0 * PB_1 * PQ[d1] * QC_0 + PB_0 * PB_1 * QD_1 * QC_0)
                            + delta[a0][a1] * delta[c0][d0] * (PB_0 * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PB_0 * PQ[b1] * PQ[d1] * QC_1 * (-1.0) + PB_0 * PQ[b1] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * QC_1 * (-1.0) + PB_1 * PQ[b0] * QD_1 * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[c1] * QD_1 + PB_0 * PB_1 * PQ[d1] * QC_1 + PB_0 * PB_1 * QD_1 * QC_1)
                            + delta[a0][d0] * delta[a1][d1] * (PB_0 * PB_1 * QC_0 * QC_1)
                            + delta[a0][d1] * delta[a1][d0] * (PB_0 * PB_1 * QC_0 * QC_1)
                            + delta[a0][c1] * delta[a1][d1] * (PB_0 * PB_1 * QD_0 * QC_0)
                            + delta[a0][d1] * delta[a1][c1] * (PB_0 * PB_1 * QD_0 * QC_0)
                            + delta[a0][c1] * delta[a1][d0] * (PB_0 * PB_1 * QD_1 * QC_0)
                            + delta[a0][d0] * delta[a1][c1] * (PB_0 * PB_1 * QD_1 * QC_0)
                            + delta[a0][c0] * delta[a1][d1] * (PB_0 * PB_1 * QD_0 * QC_1)
                            + delta[a0][d1] * delta[a1][c0] * (PB_0 * PB_1 * QD_0 * QC_1)
                            + delta[a0][c0] * delta[a1][d0] * (PB_0 * PB_1 * QD_1 * QC_1)
                            + delta[a0][d0] * delta[a1][c0] * (PB_0 * PB_1 * QD_1 * QC_1)
                            + delta[a0][a1] * delta[c0][c1] * (PB_0 * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[b1] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[b0] * QD_0 * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[d0] * QD_1 + PB_0 * PB_1 * PQ[d1] * QD_0 + PB_0 * PB_1 * QD_0 * QD_1)
                            + delta[a0][d1] * delta[a1][b1] * (PB_0 * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_0 * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b1][d1] * (PB_0 * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_0 * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[a1][d1] * delta[a0][b1] * (PB_0 * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_0 * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][b1] * (PB_0 * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b1][d0] * (PB_0 * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[a0][b1] * (PB_0 * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][c1] * delta[a1][b1] * (PB_0 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][c1] * (PB_0 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[a0][b1] * (PB_0 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][b1] * (PB_0 * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b1][c0] * (PB_0 * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[a0][b1] * (PB_0 * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * (PB_1 * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * (PB_1 * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * (PB_1 * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * (PB_1 * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * (PB_1 * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * (PB_1 * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][c1] * delta[a1][b0] * (PB_1 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][c1] * (PB_1 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[a0][b0] * (PB_1 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * (PB_1 * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * (PB_1 * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * (PB_1 * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * (PQ[c0] * PQ[c1] * QD_0 * QD_1 + PQ[c0] * PQ[d0] * QD_1 * QC_1 + PQ[c0] * PQ[d1] * QD_0 * QC_1 + PQ[c1] * PQ[d0] * QD_1 * QC_0 + PQ[c1] * PQ[d1] * QD_0 * QC_0 + PQ[d0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][b0] * delta[a1][b1] * (PQ[c0] * PQ[c1] * QD_0 * QD_1 + PQ[c0] * PQ[d0] * QD_1 * QC_1 + PQ[c0] * PQ[d1] * QD_0 * QC_1 + PQ[c1] * PQ[d0] * QD_1 * QC_0 + PQ[c1] * PQ[d1] * QD_0 * QC_0 + PQ[d0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a1][b0] * delta[a0][b1] * (PQ[c0] * PQ[c1] * QD_0 * QD_1 + PQ[c0] * PQ[d0] * QD_1 * QC_1 + PQ[c0] * PQ[d1] * QD_0 * QC_1 + PQ[c1] * PQ[d0] * QD_1 * QC_0 + PQ[c1] * PQ[d1] * QD_0 * QC_0 + PQ[d0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][c0] * delta[a1][c1] * (PB_0 * PB_1 * QD_0 * QD_1)
                            + delta[a0][c1] * delta[a1][c0] * (PB_0 * PB_1 * QD_0 * QD_1)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD12(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[3];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[2] * (

                        0.5 * ( S1 * S1 ) / ( S2 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[c1] + PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0] * QC_1 + PB_0 * PB_1 * PA_0 * PA_1 * PQ[c1] * QC_0)
                            + delta[c1][d1] * (PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[d0] + PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0] * QD_0 + PB_0 * PB_1 * PA_0 * PA_1 * PQ[d0] * QC_0)
                            + delta[c1][d0] * (PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[d1] + PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0] * QD_1 + PB_0 * PB_1 * PA_0 * PA_1 * PQ[d1] * QC_0)
                            + delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PA_1 * PQ[c1] * PQ[d0] + PB_0 * PB_1 * PA_0 * PA_1 * PQ[c1] * QD_0 + PB_0 * PB_1 * PA_0 * PA_1 * PQ[d0] * QC_1)
                            + delta[c0][d0] * (PB_0 * PB_1 * PA_0 * PA_1 * PQ[c1] * PQ[d1] + PB_0 * PB_1 * PA_0 * PA_1 * PQ[c1] * QD_1 + PB_0 * PB_1 * PA_0 * PA_1 * PQ[d1] * QC_1)
                            + delta[c0][c1] * (PB_0 * PB_1 * PA_0 * PA_1 * PQ[d0] * PQ[d1] + PB_0 * PB_1 * PA_0 * PA_1 * PQ[d0] * QD_1 + PB_0 * PB_1 * PA_0 * PA_1 * PQ[d1] * QD_0)
                        )

                    )

                    +

                    F8_t[2] * (

                        0.5 * ( S2 * S2 ) / ( S1 * S4 * S4 ) * (
                            delta[b0][b1] * (PA_0 * PQ[a1] * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[a0] * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[a0] * PQ[a1] * QD_0 * QD_1 * QC_0 * QC_1)
                            + delta[a1][b1] * (PB_0 * PQ[a0] * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[b0] * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * QD_0 * QD_1 * QC_0 * QC_1)
                            + delta[a1][b0] * (PB_1 * PQ[a0] * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[a0] * PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1)
                            + delta[a0][b1] * (PB_0 * PQ[a1] * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[b0] * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[a1] * PQ[b0] * QD_0 * QD_1 * QC_0 * QC_1)
                            + delta[a0][b0] * (PB_1 * PQ[a1] * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[a1] * PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1)
                            + delta[a0][a1] * (PB_0 * PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[b0] * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1)
                        )

                    )

                    +

                    F8_t[2] * (

                        0.5 * S1 / ( S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] * QC_1 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c1] * QC_0 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[a1] * QC_0 * QC_1 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] * QC_1 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c1] * QC_0 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * QC_0 * QC_1 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c1] * QC_0 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * QC_0 * QC_1 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c1] * QC_0 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * QC_0 * QC_1 * (-1.0))
                            + delta[c1][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[a1] * QD_0 * QC_0 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * QD_0 * QC_0 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * QD_0 * QC_0 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * QD_0 * QC_0 * (-1.0))
                            + delta[c1][d0] * (PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[a1] * QD_1 * QC_0 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * QD_1 * QC_0 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * QD_1 * QC_0 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * QD_1 * QC_0 * (-1.0))
                            + delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c1] * QD_0 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d0] * QC_1 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[a1] * QD_0 * QC_1 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c1] * QD_0 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d0] * QC_1 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * QD_0 * QC_1 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d0] * QC_1 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * QD_0 * QC_1 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d0] * QC_1 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * QD_0 * QC_1 * (-1.0))
                            + delta[c0][d0] * (PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c1] * QD_1 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d1] * QC_1 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[a1] * QD_1 * QC_1 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c1] * QD_1 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d1] * QC_1 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * QD_1 * QC_1 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d1] * QC_1 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * QD_1 * QC_1 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d1] * QC_1 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * QD_1 * QC_1 * (-1.0))
                            + delta[c0][c1] * (PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[a1] * QD_0 * QD_1 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * QD_0 * QD_1 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * QD_0 * QD_1 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * QD_0 * QD_1 * (-1.0))
                            + delta[b1][d1] * (PB_0 * PA_0 * PA_1 * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[b1][d0] * (PB_0 * PA_0 * PA_1 * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[b1][c1] * (PB_0 * PA_0 * PA_1 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[b1][c0] * (PB_0 * PA_0 * PA_1 * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[b0][d1] * (PB_1 * PA_0 * PA_1 * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][d0] * (PB_1 * PA_0 * PA_1 * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][c1] * (PB_1 * PA_0 * PA_1 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[b0][c0] * (PB_1 * PA_0 * PA_1 * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[b0][b1] * (PA_0 * PA_1 * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PA_0 * PA_1 * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PA_0 * PA_1 * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PA_0 * PA_1 * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PA_0 * PA_1 * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PA_0 * PA_1 * PQ[d0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a1][d1] * (PB_0 * PB_1 * PA_0 * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[a1][d0] * (PB_0 * PB_1 * PA_0 * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a1][c1] * (PB_0 * PB_1 * PA_0 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a1][c0] * (PB_0 * PB_1 * PA_0 * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[a1][b1] * (PB_0 * PA_0 * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PB_0 * PA_0 * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PB_0 * PA_0 * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PB_0 * PA_0 * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PB_0 * PA_0 * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PB_0 * PA_0 * PQ[d0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a1][b0] * (PB_1 * PA_0 * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PB_1 * PA_0 * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PB_1 * PA_0 * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PB_1 * PA_0 * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PB_1 * PA_0 * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PB_1 * PA_0 * PQ[d0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][d1] * (PB_0 * PB_1 * PA_1 * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][d0] * (PB_0 * PB_1 * PA_1 * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][c1] * (PB_0 * PB_1 * PA_1 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][c0] * (PB_0 * PB_1 * PA_1 * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[a0][b1] * (PB_0 * PA_1 * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PB_0 * PA_1 * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PB_0 * PA_1 * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PB_0 * PA_1 * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PB_0 * PA_1 * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PB_0 * PA_1 * PQ[d0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][b0] * (PB_1 * PA_1 * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PB_1 * PA_1 * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PB_1 * PA_1 * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PB_1 * PA_1 * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PB_1 * PA_1 * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PB_1 * PA_1 * PQ[d0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][a1] * (PB_0 * PB_1 * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PB_0 * PB_1 * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PB_0 * PB_1 * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PB_0 * PB_1 * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PB_0 * PB_1 * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PB_0 * PB_1 * PQ[d0] * PQ[d1] * QC_0 * QC_1)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD13(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[4];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[2] * (

                        0.5 * S2 / ( S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * QC_0 * QC_1 + PB_0 * PA_0 * PQ[a1] * PQ[b1] * QC_0 * QC_1 + PB_0 * PA_1 * PQ[a0] * PQ[b1] * QC_0 * QC_1 + PB_1 * PA_0 * PQ[a1] * PQ[b0] * QC_0 * QC_1 + PB_1 * PA_1 * PQ[a0] * PQ[b0] * QC_0 * QC_1 + PA_0 * PA_1 * PQ[b0] * PQ[b1] * QC_0 * QC_1)
                            + delta[c1][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * QD_0 * QC_0 + PB_0 * PA_0 * PQ[a1] * PQ[b1] * QD_0 * QC_0 + PB_0 * PA_1 * PQ[a0] * PQ[b1] * QD_0 * QC_0 + PB_1 * PA_0 * PQ[a1] * PQ[b0] * QD_0 * QC_0 + PB_1 * PA_1 * PQ[a0] * PQ[b0] * QD_0 * QC_0 + PA_0 * PA_1 * PQ[b0] * PQ[b1] * QD_0 * QC_0)
                            + delta[c1][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * QD_1 * QC_0 + PB_0 * PA_0 * PQ[a1] * PQ[b1] * QD_1 * QC_0 + PB_0 * PA_1 * PQ[a0] * PQ[b1] * QD_1 * QC_0 + PB_1 * PA_0 * PQ[a1] * PQ[b0] * QD_1 * QC_0 + PB_1 * PA_1 * PQ[a0] * PQ[b0] * QD_1 * QC_0 + PA_0 * PA_1 * PQ[b0] * PQ[b1] * QD_1 * QC_0)
                            + delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * QD_0 * QC_1 + PB_0 * PA_0 * PQ[a1] * PQ[b1] * QD_0 * QC_1 + PB_0 * PA_1 * PQ[a0] * PQ[b1] * QD_0 * QC_1 + PB_1 * PA_0 * PQ[a1] * PQ[b0] * QD_0 * QC_1 + PB_1 * PA_1 * PQ[a0] * PQ[b0] * QD_0 * QC_1 + PA_0 * PA_1 * PQ[b0] * PQ[b1] * QD_0 * QC_1)
                            + delta[c0][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * QD_1 * QC_1 + PB_0 * PA_0 * PQ[a1] * PQ[b1] * QD_1 * QC_1 + PB_0 * PA_1 * PQ[a0] * PQ[b1] * QD_1 * QC_1 + PB_1 * PA_0 * PQ[a1] * PQ[b0] * QD_1 * QC_1 + PB_1 * PA_1 * PQ[a0] * PQ[b0] * QD_1 * QC_1 + PA_0 * PA_1 * PQ[b0] * PQ[b1] * QD_1 * QC_1)
                            + delta[c0][c1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * QD_0 * QD_1 + PB_0 * PA_0 * PQ[a1] * PQ[b1] * QD_0 * QD_1 + PB_0 * PA_1 * PQ[a0] * PQ[b1] * QD_0 * QD_1 + PB_1 * PA_0 * PQ[a1] * PQ[b0] * QD_0 * QD_1 + PB_1 * PA_1 * PQ[a0] * PQ[b0] * QD_0 * QD_1 + PA_0 * PA_1 * PQ[b0] * PQ[b1] * QD_0 * QD_1)
                            + delta[b1][d1] * (PB_0 * PA_0 * PQ[a1] * QD_0 * QC_0 * QC_1 + PB_0 * PA_1 * PQ[a0] * QD_0 * QC_0 * QC_1 + PA_0 * PA_1 * PQ[b0] * QD_0 * QC_0 * QC_1)
                            + delta[b1][d0] * (PB_0 * PA_0 * PQ[a1] * QD_1 * QC_0 * QC_1 + PB_0 * PA_1 * PQ[a0] * QD_1 * QC_0 * QC_1 + PA_0 * PA_1 * PQ[b0] * QD_1 * QC_0 * QC_1)
                            + delta[b1][c1] * (PB_0 * PA_0 * PQ[a1] * QD_0 * QD_1 * QC_0 + PB_0 * PA_1 * PQ[a0] * QD_0 * QD_1 * QC_0 + PA_0 * PA_1 * PQ[b0] * QD_0 * QD_1 * QC_0)
                            + delta[b1][c0] * (PB_0 * PA_0 * PQ[a1] * QD_0 * QD_1 * QC_1 + PB_0 * PA_1 * PQ[a0] * QD_0 * QD_1 * QC_1 + PA_0 * PA_1 * PQ[b0] * QD_0 * QD_1 * QC_1)
                            + delta[b0][d1] * (PB_1 * PA_0 * PQ[a1] * QD_0 * QC_0 * QC_1 + PB_1 * PA_1 * PQ[a0] * QD_0 * QC_0 * QC_1 + PA_0 * PA_1 * PQ[b1] * QD_0 * QC_0 * QC_1)
                            + delta[b0][d0] * (PB_1 * PA_0 * PQ[a1] * QD_1 * QC_0 * QC_1 + PB_1 * PA_1 * PQ[a0] * QD_1 * QC_0 * QC_1 + PA_0 * PA_1 * PQ[b1] * QD_1 * QC_0 * QC_1)
                            + delta[b0][c1] * (PB_1 * PA_0 * PQ[a1] * QD_0 * QD_1 * QC_0 + PB_1 * PA_1 * PQ[a0] * QD_0 * QD_1 * QC_0 + PA_0 * PA_1 * PQ[b1] * QD_0 * QD_1 * QC_0)
                            + delta[b0][c0] * (PB_1 * PA_0 * PQ[a1] * QD_0 * QD_1 * QC_1 + PB_1 * PA_1 * PQ[a0] * QD_0 * QD_1 * QC_1 + PA_0 * PA_1 * PQ[b1] * QD_0 * QD_1 * QC_1)
                            + delta[b0][b1] * (PA_0 * PQ[a1] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[c0] * QD_0 * QD_1 * QC_1 + PA_0 * PA_1 * PQ[c1] * QD_0 * QD_1 * QC_0 + PA_0 * PA_1 * PQ[d0] * QD_1 * QC_0 * QC_1 + PA_0 * PA_1 * PQ[d1] * QD_0 * QC_0 * QC_1)
                            + delta[a1][d1] * (PB_0 * PB_1 * PQ[a0] * QD_0 * QC_0 * QC_1 + PB_0 * PA_0 * PQ[b1] * QD_0 * QC_0 * QC_1 + PB_1 * PA_0 * PQ[b0] * QD_0 * QC_0 * QC_1)
                            + delta[a1][d0] * (PB_0 * PB_1 * PQ[a0] * QD_1 * QC_0 * QC_1 + PB_0 * PA_0 * PQ[b1] * QD_1 * QC_0 * QC_1 + PB_1 * PA_0 * PQ[b0] * QD_1 * QC_0 * QC_1)
                            + delta[a1][c1] * (PB_0 * PB_1 * PQ[a0] * QD_0 * QD_1 * QC_0 + PB_0 * PA_0 * PQ[b1] * QD_0 * QD_1 * QC_0 + PB_1 * PA_0 * PQ[b0] * QD_0 * QD_1 * QC_0)
                            + delta[a1][c0] * (PB_0 * PB_1 * PQ[a0] * QD_0 * QD_1 * QC_1 + PB_0 * PA_0 * PQ[b1] * QD_0 * QD_1 * QC_1 + PB_1 * PA_0 * PQ[b0] * QD_0 * QD_1 * QC_1)
                            + delta[a1][b1] * (PB_0 * PQ[a0] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[c0] * QD_0 * QD_1 * QC_1 + PB_0 * PA_0 * PQ[c1] * QD_0 * QD_1 * QC_0 + PB_0 * PA_0 * PQ[d0] * QD_1 * QC_0 * QC_1 + PB_0 * PA_0 * PQ[d1] * QD_0 * QC_0 * QC_1)
                            + delta[a1][b0] * (PB_1 * PQ[a0] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[c0] * QD_0 * QD_1 * QC_1 + PB_1 * PA_0 * PQ[c1] * QD_0 * QD_1 * QC_0 + PB_1 * PA_0 * PQ[d0] * QD_1 * QC_0 * QC_1 + PB_1 * PA_0 * PQ[d1] * QD_0 * QC_0 * QC_1)
                            + delta[a0][d1] * (PB_0 * PB_1 * PQ[a1] * QD_0 * QC_0 * QC_1 + PB_0 * PA_1 * PQ[b1] * QD_0 * QC_0 * QC_1 + PB_1 * PA_1 * PQ[b0] * QD_0 * QC_0 * QC_1)
                            + delta[a0][d0] * (PB_0 * PB_1 * PQ[a1] * QD_1 * QC_0 * QC_1 + PB_0 * PA_1 * PQ[b1] * QD_1 * QC_0 * QC_1 + PB_1 * PA_1 * PQ[b0] * QD_1 * QC_0 * QC_1)
                            + delta[a0][c1] * (PB_0 * PB_1 * PQ[a1] * QD_0 * QD_1 * QC_0 + PB_0 * PA_1 * PQ[b1] * QD_0 * QD_1 * QC_0 + PB_1 * PA_1 * PQ[b0] * QD_0 * QD_1 * QC_0)
                            + delta[a0][c0] * (PB_0 * PB_1 * PQ[a1] * QD_0 * QD_1 * QC_1 + PB_0 * PA_1 * PQ[b1] * QD_0 * QD_1 * QC_1 + PB_1 * PA_1 * PQ[b0] * QD_0 * QD_1 * QC_1)
                            + delta[a0][b1] * (PB_0 * PQ[a1] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[a1] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[a1] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PB_0 * PQ[a1] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[c0] * QD_0 * QD_1 * QC_1 + PB_0 * PA_1 * PQ[c1] * QD_0 * QD_1 * QC_0 + PB_0 * PA_1 * PQ[d0] * QD_1 * QC_0 * QC_1 + PB_0 * PA_1 * PQ[d1] * QD_0 * QC_0 * QC_1)
                            + delta[a0][b0] * (PB_1 * PQ[a1] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[a1] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[a1] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[a1] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PA_1 * PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[c0] * QD_0 * QD_1 * QC_1 + PB_1 * PA_1 * PQ[c1] * QD_0 * QD_1 * QC_0 + PB_1 * PA_1 * PQ[d0] * QD_1 * QC_0 * QC_1 + PB_1 * PA_1 * PQ[d1] * QD_0 * QC_0 * QC_1)
                            + delta[a0][a1] * (PB_0 * PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PB_0 * PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[c0] * QD_0 * QD_1 * QC_1 + PB_0 * PB_1 * PQ[c1] * QD_0 * QD_1 * QC_0 + PB_0 * PB_1 * PQ[d0] * QD_1 * QC_0 * QC_1 + PB_0 * PB_1 * PQ[d1] * QD_0 * QC_0 * QC_1)
                        )

                    )

                    +

                    F8_t[2] * (

                        0.0625 / ( S1 * S1 * S4 * S4 ) * (
                            delta[a0][a1] * delta[b0][b1] * delta[c0][c1] * delta[d0][d1]
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * delta[c1][d1]
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d0] * delta[c0][d1]
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][c1] * delta[d0][d1]
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * delta[c1][d1]
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d0] * delta[c0][d1]
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][c1] * delta[d0][d1]
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * delta[c1][d1]
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d0] * delta[c0][d1]
                        )

                    )

                    +

                    F8_t[2] * (

                        0.0625 / ( S1 * S2 * S4 * S4 ) * (
                            delta[a0][c0] * delta[a1][c1] * delta[b0][b1] * delta[d0][d1]
                            + delta[a0][c0] * delta[a1][d0] * delta[b0][b1] * delta[c1][d1]
                            + delta[a0][c0] * delta[a1][d1] * delta[b0][b1] * delta[c1][d0]
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][c1] * delta[d0][d1]
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d0] * delta[c1][d1]
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d1] * delta[c1][d0]
                            + delta[a0][c0] * delta[b0][c1] * delta[a1][b1] * delta[d0][d1]
                            + delta[a0][c0] * delta[b0][d0] * delta[a1][b1] * delta[c1][d1]
                            + delta[a0][c0] * delta[b0][d1] * delta[a1][b1] * delta[c1][d0]
                            + delta[a0][c1] * delta[a1][c0] * delta[b0][b1] * delta[d0][d1]
                            + delta[a0][c1] * delta[a1][d0] * delta[b0][b1] * delta[c0][d1]
                            + delta[a0][c1] * delta[a1][d1] * delta[b0][b1] * delta[c0][d0]
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][c0] * delta[d0][d1]
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][d0] * delta[c0][d1]
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][d1] * delta[c0][d0]
                            + delta[a0][c1] * delta[b0][c0] * delta[a1][b1] * delta[d0][d1]
                            + delta[a0][c1] * delta[b0][d0] * delta[a1][b1] * delta[c0][d1]
                            + delta[a0][c1] * delta[b0][d1] * delta[a1][b1] * delta[c0][d0]
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][b1] * delta[c1][d1]
                            + delta[a0][d0] * delta[a1][c1] * delta[b0][b1] * delta[c0][d1]
                            + delta[a0][d0] * delta[a1][d1] * delta[b0][b1] * delta[c0][c1]
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][c0] * delta[c1][d1]
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][c1] * delta[c0][d1]
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][d1] * delta[c0][c1]
                            + delta[a0][d0] * delta[b0][c0] * delta[a1][b1] * delta[c1][d1]
                            + delta[a0][d0] * delta[b0][c1] * delta[a1][b1] * delta[c0][d1]
                            + delta[a0][d0] * delta[b0][d1] * delta[a1][b1] * delta[c0][c1]
                            + delta[a0][d1] * delta[a1][c0] * delta[b0][b1] * delta[c1][d0]
                            + delta[a0][d1] * delta[a1][c1] * delta[b0][b1] * delta[c0][d0]
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][b1] * delta[c0][c1]
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][c0] * delta[c1][d0]
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][c1] * delta[c0][d0]
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][d0] * delta[c0][c1]
                            + delta[a0][d1] * delta[b0][c0] * delta[a1][b1] * delta[c1][d0]
                            + delta[a0][d1] * delta[b0][c1] * delta[a1][b1] * delta[c0][d0]
                            + delta[a0][d1] * delta[b0][d0] * delta[a1][b1] * delta[c0][c1]
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * 4.0
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * 4.0
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * 4.0
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][c1] * delta[d0][d1]
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d0] * delta[c1][d1]
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d1] * delta[c1][d0]
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][c0] * delta[d0][d1]
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][d0] * delta[c0][d1]
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][d1] * delta[c0][d0]
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][c0] * delta[c1][d1]
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][c1] * delta[c0][d1]
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][d1] * delta[c0][c1]
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][c0] * delta[c1][d0]
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][c1] * delta[c0][d0]
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][d0] * delta[c0][c1]
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][c1] * delta[d0][d1]
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d0] * delta[c1][d1]
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d1] * delta[c1][d0]
                            + delta[a1][c0] * delta[b0][c1] * delta[a0][b1] * delta[d0][d1]
                            + delta[a1][c0] * delta[b0][d0] * delta[a0][b1] * delta[c1][d1]
                            + delta[a1][c0] * delta[b0][d1] * delta[a0][b1] * delta[c1][d0]
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][c0] * delta[d0][d1]
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][d0] * delta[c0][d1]
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][d1] * delta[c0][d0]
                            + delta[a1][c1] * delta[b0][c0] * delta[a0][b1] * delta[d0][d1]
                            + delta[a1][c1] * delta[b0][d0] * delta[a0][b1] * delta[c0][d1]
                            + delta[a1][c1] * delta[b0][d1] * delta[a0][b1] * delta[c0][d0]
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][c0] * delta[c1][d1]
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][c1] * delta[c0][d1]
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][d1] * delta[c0][c1]
                            + delta[a1][d0] * delta[b0][c0] * delta[a0][b1] * delta[c1][d1]
                            + delta[a1][d0] * delta[b0][c1] * delta[a0][b1] * delta[c0][d1]
                            + delta[a1][d0] * delta[b0][d1] * delta[a0][b1] * delta[c0][c1]
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][c0] * delta[c1][d0]
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][c1] * delta[c0][d0]
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][d0] * delta[c0][c1]
                            + delta[a1][d1] * delta[b0][c0] * delta[a0][b1] * delta[c1][d0]
                            + delta[a1][d1] * delta[b0][c1] * delta[a0][b1] * delta[c0][d0]
                            + delta[a1][d1] * delta[b0][d0] * delta[a0][b1] * delta[c0][c1]
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][c1] * delta[d0][d1] * 4.0
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * delta[c1][d1] * 4.0
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d0] * delta[c0][d1] * 4.0
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][c1] * delta[d0][d1] * 4.0
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * delta[c1][d1] * 4.0
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d0] * delta[c0][d1] * 4.0
                        )

                    )

                    +

                    F8_t[2] * (

                        0.0625 / ( S2 * S2 * S4 * S4 ) * (
                            delta[a0][a1] * delta[b0][b1] * delta[c0][c1] * delta[d0][d1]
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * delta[c1][d1]
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d0] * delta[c0][d1]
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][c1] * delta[d0][d1]
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * delta[c1][d1]
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d0] * delta[c0][d1]
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][c1] * delta[d0][d1]
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * delta[c1][d1]
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d0] * delta[c0][d1]
                        )

                    )

                    +

                    F8_t[3] * (

                        ( S1 * S1 * S1 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD14(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[4];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[3] * (

                        ( S1 * S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                        )

                    )

                    +

                    F8_t[3] * (

                        ( S1 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                        )

                    )

                    +

                    F8_t[3] * (

                        ( S2 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * QD_0 * QD_1 * QC_0 * QC_1
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1
                        )

                    )

                    +

                    F8_t[3] * (

                        0.0625 / ( S1 * S4 * S4 * S4 ) * (
                            delta[a0][c0] * delta[a1][c1] * delta[b0][b1] * delta[d0][d1] * (-1.0)
                            + delta[a0][c0] * delta[a1][d0] * delta[b0][b1] * delta[c1][d1] * (-1.0)
                            + delta[a0][c0] * delta[a1][d1] * delta[b0][b1] * delta[c1][d0] * (-1.0)
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][c1] * delta[d0][d1] * (-1.0)
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d0] * delta[c1][d1] * (-1.0)
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d1] * delta[c1][d0] * (-1.0)
                            + delta[a0][c0] * delta[b0][c1] * delta[a1][b1] * delta[d0][d1] * (-1.0)
                            + delta[a0][c0] * delta[b0][d0] * delta[a1][b1] * delta[c1][d1] * (-1.0)
                            + delta[a0][c0] * delta[b0][d1] * delta[a1][b1] * delta[c1][d0] * (-1.0)
                            + delta[a0][c1] * delta[a1][c0] * delta[b0][b1] * delta[d0][d1] * (-1.0)
                            + delta[a0][c1] * delta[a1][d0] * delta[b0][b1] * delta[c0][d1] * (-1.0)
                            + delta[a0][c1] * delta[a1][d1] * delta[b0][b1] * delta[c0][d0] * (-1.0)
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][c0] * delta[d0][d1] * (-1.0)
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][d0] * delta[c0][d1] * (-1.0)
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][d1] * delta[c0][d0] * (-1.0)
                            + delta[a0][c1] * delta[b0][c0] * delta[a1][b1] * delta[d0][d1] * (-1.0)
                            + delta[a0][c1] * delta[b0][d0] * delta[a1][b1] * delta[c0][d1] * (-1.0)
                            + delta[a0][c1] * delta[b0][d1] * delta[a1][b1] * delta[c0][d0] * (-1.0)
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][b1] * delta[c1][d1] * (-1.0)
                            + delta[a0][d0] * delta[a1][c1] * delta[b0][b1] * delta[c0][d1] * (-1.0)
                            + delta[a0][d0] * delta[a1][d1] * delta[b0][b1] * delta[c0][c1] * (-1.0)
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][c0] * delta[c1][d1] * (-1.0)
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][c1] * delta[c0][d1] * (-1.0)
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][d1] * delta[c0][c1] * (-1.0)
                            + delta[a0][d0] * delta[b0][c0] * delta[a1][b1] * delta[c1][d1] * (-1.0)
                            + delta[a0][d0] * delta[b0][c1] * delta[a1][b1] * delta[c0][d1] * (-1.0)
                            + delta[a0][d0] * delta[b0][d1] * delta[a1][b1] * delta[c0][c1] * (-1.0)
                            + delta[a0][d1] * delta[a1][c0] * delta[b0][b1] * delta[c1][d0] * (-1.0)
                            + delta[a0][d1] * delta[a1][c1] * delta[b0][b1] * delta[c0][d0] * (-1.0)
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][b1] * delta[c0][c1] * (-1.0)
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][c0] * delta[c1][d0] * (-1.0)
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][c1] * delta[c0][d0] * (-1.0)
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][d0] * delta[c0][c1] * (-1.0)
                            + delta[a0][d1] * delta[b0][c0] * delta[a1][b1] * delta[c1][d0] * (-1.0)
                            + delta[a0][d1] * delta[b0][c1] * delta[a1][b1] * delta[c0][d0] * (-1.0)
                            + delta[a0][d1] * delta[b0][d0] * delta[a1][b1] * delta[c0][c1] * (-1.0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (-2.0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (-2.0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (-2.0)
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][c1] * delta[d0][d1] * (-1.0)
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d0] * delta[c1][d1] * (-1.0)
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d1] * delta[c1][d0] * (-1.0)
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][c0] * delta[d0][d1] * (-1.0)
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][d0] * delta[c0][d1] * (-1.0)
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][d1] * delta[c0][d0] * (-1.0)
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][c0] * delta[c1][d1] * (-1.0)
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][c1] * delta[c0][d1] * (-1.0)
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][d1] * delta[c0][c1] * (-1.0)
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][c0] * delta[c1][d0] * (-1.0)
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][c1] * delta[c0][d0] * (-1.0)
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][d0] * delta[c0][c1] * (-1.0)
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][c1] * delta[d0][d1] * (-1.0)
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d0] * delta[c1][d1] * (-1.0)
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d1] * delta[c1][d0] * (-1.0)
                            + delta[a1][c0] * delta[b0][c1] * delta[a0][b1] * delta[d0][d1] * (-1.0)
                            + delta[a1][c0] * delta[b0][d0] * delta[a0][b1] * delta[c1][d1] * (-1.0)
                            + delta[a1][c0] * delta[b0][d1] * delta[a0][b1] * delta[c1][d0] * (-1.0)
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][c0] * delta[d0][d1] * (-1.0)
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][d0] * delta[c0][d1] * (-1.0)
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][d1] * delta[c0][d0] * (-1.0)
                            + delta[a1][c1] * delta[b0][c0] * delta[a0][b1] * delta[d0][d1] * (-1.0)
                            + delta[a1][c1] * delta[b0][d0] * delta[a0][b1] * delta[c0][d1] * (-1.0)
                            + delta[a1][c1] * delta[b0][d1] * delta[a0][b1] * delta[c0][d0] * (-1.0)
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][c0] * delta[c1][d1] * (-1.0)
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][c1] * delta[c0][d1] * (-1.0)
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][d1] * delta[c0][c1] * (-1.0)
                            + delta[a1][d0] * delta[b0][c0] * delta[a0][b1] * delta[c1][d1] * (-1.0)
                            + delta[a1][d0] * delta[b0][c1] * delta[a0][b1] * delta[c0][d1] * (-1.0)
                            + delta[a1][d0] * delta[b0][d1] * delta[a0][b1] * delta[c0][c1] * (-1.0)
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][c0] * delta[c1][d0] * (-1.0)
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][c1] * delta[c0][d0] * (-1.0)
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][d0] * delta[c0][c1] * (-1.0)
                            + delta[a1][d1] * delta[b0][c0] * delta[a0][b1] * delta[c1][d0] * (-1.0)
                            + delta[a1][d1] * delta[b0][c1] * delta[a0][b1] * delta[c0][d0] * (-1.0)
                            + delta[a1][d1] * delta[b0][d0] * delta[a0][b1] * delta[c0][c1] * (-1.0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][c1] * delta[d0][d1] * (-2.0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * delta[c1][d1] * (-2.0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d0] * delta[c0][d1] * (-2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][c1] * delta[d0][d1] * (-2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * delta[c1][d1] * (-2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d0] * delta[c0][d1] * (-2.0)
                        )

                    )

                    +

                    F8_t[3] * (

                        0.0625 / ( S2 * S4 * S4 * S4 ) * (
                            delta[a0][c0] * delta[a1][c1] * delta[b0][b1] * delta[d0][d1] * (-1.0)
                            + delta[a0][c0] * delta[a1][d0] * delta[b0][b1] * delta[c1][d1] * (-1.0)
                            + delta[a0][c0] * delta[a1][d1] * delta[b0][b1] * delta[c1][d0] * (-1.0)
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][c1] * delta[d0][d1] * (-1.0)
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d0] * delta[c1][d1] * (-1.0)
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d1] * delta[c1][d0] * (-1.0)
                            + delta[a0][c0] * delta[b0][c1] * delta[a1][b1] * delta[d0][d1] * (-1.0)
                            + delta[a0][c0] * delta[b0][d0] * delta[a1][b1] * delta[c1][d1] * (-1.0)
                            + delta[a0][c0] * delta[b0][d1] * delta[a1][b1] * delta[c1][d0] * (-1.0)
                            + delta[a0][c1] * delta[a1][c0] * delta[b0][b1] * delta[d0][d1] * (-1.0)
                            + delta[a0][c1] * delta[a1][d0] * delta[b0][b1] * delta[c0][d1] * (-1.0)
                            + delta[a0][c1] * delta[a1][d1] * delta[b0][b1] * delta[c0][d0] * (-1.0)
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][c0] * delta[d0][d1] * (-1.0)
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][d0] * delta[c0][d1] * (-1.0)
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][d1] * delta[c0][d0] * (-1.0)
                            + delta[a0][c1] * delta[b0][c0] * delta[a1][b1] * delta[d0][d1] * (-1.0)
                            + delta[a0][c1] * delta[b0][d0] * delta[a1][b1] * delta[c0][d1] * (-1.0)
                            + delta[a0][c1] * delta[b0][d1] * delta[a1][b1] * delta[c0][d0] * (-1.0)
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][b1] * delta[c1][d1] * (-1.0)
                            + delta[a0][d0] * delta[a1][c1] * delta[b0][b1] * delta[c0][d1] * (-1.0)
                            + delta[a0][d0] * delta[a1][d1] * delta[b0][b1] * delta[c0][c1] * (-1.0)
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][c0] * delta[c1][d1] * (-1.0)
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][c1] * delta[c0][d1] * (-1.0)
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][d1] * delta[c0][c1] * (-1.0)
                            + delta[a0][d0] * delta[b0][c0] * delta[a1][b1] * delta[c1][d1] * (-1.0)
                            + delta[a0][d0] * delta[b0][c1] * delta[a1][b1] * delta[c0][d1] * (-1.0)
                            + delta[a0][d0] * delta[b0][d1] * delta[a1][b1] * delta[c0][c1] * (-1.0)
                            + delta[a0][d1] * delta[a1][c0] * delta[b0][b1] * delta[c1][d0] * (-1.0)
                            + delta[a0][d1] * delta[a1][c1] * delta[b0][b1] * delta[c0][d0] * (-1.0)
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][b1] * delta[c0][c1] * (-1.0)
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][c0] * delta[c1][d0] * (-1.0)
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][c1] * delta[c0][d0] * (-1.0)
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][d0] * delta[c0][c1] * (-1.0)
                            + delta[a0][d1] * delta[b0][c0] * delta[a1][b1] * delta[c1][d0] * (-1.0)
                            + delta[a0][d1] * delta[b0][c1] * delta[a1][b1] * delta[c0][d0] * (-1.0)
                            + delta[a0][d1] * delta[b0][d0] * delta[a1][b1] * delta[c0][c1] * (-1.0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (-2.0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (-2.0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (-2.0)
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][c1] * delta[d0][d1] * (-1.0)
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d0] * delta[c1][d1] * (-1.0)
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d1] * delta[c1][d0] * (-1.0)
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][c0] * delta[d0][d1] * (-1.0)
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][d0] * delta[c0][d1] * (-1.0)
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][d1] * delta[c0][d0] * (-1.0)
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][c0] * delta[c1][d1] * (-1.0)
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][c1] * delta[c0][d1] * (-1.0)
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][d1] * delta[c0][c1] * (-1.0)
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][c0] * delta[c1][d0] * (-1.0)
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][c1] * delta[c0][d0] * (-1.0)
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][d0] * delta[c0][c1] * (-1.0)
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][c1] * delta[d0][d1] * (-1.0)
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d0] * delta[c1][d1] * (-1.0)
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d1] * delta[c1][d0] * (-1.0)
                            + delta[a1][c0] * delta[b0][c1] * delta[a0][b1] * delta[d0][d1] * (-1.0)
                            + delta[a1][c0] * delta[b0][d0] * delta[a0][b1] * delta[c1][d1] * (-1.0)
                            + delta[a1][c0] * delta[b0][d1] * delta[a0][b1] * delta[c1][d0] * (-1.0)
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][c0] * delta[d0][d1] * (-1.0)
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][d0] * delta[c0][d1] * (-1.0)
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][d1] * delta[c0][d0] * (-1.0)
                            + delta[a1][c1] * delta[b0][c0] * delta[a0][b1] * delta[d0][d1] * (-1.0)
                            + delta[a1][c1] * delta[b0][d0] * delta[a0][b1] * delta[c0][d1] * (-1.0)
                            + delta[a1][c1] * delta[b0][d1] * delta[a0][b1] * delta[c0][d0] * (-1.0)
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][c0] * delta[c1][d1] * (-1.0)
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][c1] * delta[c0][d1] * (-1.0)
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][d1] * delta[c0][c1] * (-1.0)
                            + delta[a1][d0] * delta[b0][c0] * delta[a0][b1] * delta[c1][d1] * (-1.0)
                            + delta[a1][d0] * delta[b0][c1] * delta[a0][b1] * delta[c0][d1] * (-1.0)
                            + delta[a1][d0] * delta[b0][d1] * delta[a0][b1] * delta[c0][c1] * (-1.0)
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][c0] * delta[c1][d0] * (-1.0)
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][c1] * delta[c0][d0] * (-1.0)
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][d0] * delta[c0][c1] * (-1.0)
                            + delta[a1][d1] * delta[b0][c0] * delta[a0][b1] * delta[c1][d0] * (-1.0)
                            + delta[a1][d1] * delta[b0][c1] * delta[a0][b1] * delta[c0][d0] * (-1.0)
                            + delta[a1][d1] * delta[b0][d0] * delta[a0][b1] * delta[c0][c1] * (-1.0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][c1] * delta[d0][d1] * (-2.0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * delta[c1][d1] * (-2.0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d0] * delta[c0][d1] * (-2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][c1] * delta[d0][d1] * (-2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * delta[c1][d1] * (-2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d0] * delta[c0][d1] * (-2.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD15(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[4];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[3] * (

                        0.125 * S1 / ( S2 * S4 * S4 * S4 ) * (
                            delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (PA_0 * PA_1 * (-1.0) + PA_0 * PQ[a1] + PA_1 * PQ[a0])
                            + delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (PA_0 * PA_1 * (-1.0) + PA_0 * PQ[a1] + PA_1 * PQ[a0])
                            + delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (PA_0 * PA_1 * (-1.0) + PA_0 * PQ[a1] + PA_1 * PQ[a0])
                            + delta[b0][c0] * delta[b1][c1] * delta[d0][d1] * (PA_0 * PA_1 * (-1.0))
                            + delta[b0][c0] * delta[b1][d0] * delta[c1][d1] * (PA_0 * PA_1 * (-1.0))
                            + delta[b0][c0] * delta[b1][d1] * delta[c1][d0] * (PA_0 * PA_1 * (-1.0))
                            + delta[b0][c1] * delta[b1][c0] * delta[d0][d1] * (PA_0 * PA_1 * (-1.0))
                            + delta[b0][c1] * delta[b1][d0] * delta[c0][d1] * (PA_0 * PA_1 * (-1.0))
                            + delta[b0][c1] * delta[b1][d1] * delta[c0][d0] * (PA_0 * PA_1 * (-1.0))
                            + delta[b0][d0] * delta[b1][c0] * delta[c1][d1] * (PA_0 * PA_1 * (-1.0))
                            + delta[b0][d0] * delta[b1][c1] * delta[c0][d1] * (PA_0 * PA_1 * (-1.0))
                            + delta[b0][d0] * delta[b1][d1] * delta[c0][c1] * (PA_0 * PA_1 * (-1.0))
                            + delta[b0][d1] * delta[b1][c0] * delta[c1][d0] * (PA_0 * PA_1 * (-1.0))
                            + delta[b0][d1] * delta[b1][c1] * delta[c0][d0] * (PA_0 * PA_1 * (-1.0))
                            + delta[b0][d1] * delta[b1][d0] * delta[c0][c1] * (PA_0 * PA_1 * (-1.0))
                            + delta[a1][c0] * delta[b1][c1] * delta[d0][d1] * (PB_0 * PA_0 * (-1.0))
                            + delta[a1][c0] * delta[b1][d0] * delta[c1][d1] * (PB_0 * PA_0 * (-1.0))
                            + delta[a1][c0] * delta[b1][d1] * delta[c1][d0] * (PB_0 * PA_0 * (-1.0))
                            + delta[a1][c1] * delta[b1][c0] * delta[d0][d1] * (PB_0 * PA_0 * (-1.0))
                            + delta[a1][c1] * delta[b1][d0] * delta[c0][d1] * (PB_0 * PA_0 * (-1.0))
                            + delta[a1][c1] * delta[b1][d1] * delta[c0][d0] * (PB_0 * PA_0 * (-1.0))
                            + delta[a1][d0] * delta[b1][c0] * delta[c1][d1] * (PB_0 * PA_0 * (-1.0))
                            + delta[a1][d0] * delta[b1][c1] * delta[c0][d1] * (PB_0 * PA_0 * (-1.0))
                            + delta[a1][d0] * delta[b1][d1] * delta[c0][c1] * (PB_0 * PA_0 * (-1.0))
                            + delta[a1][d1] * delta[b1][c0] * delta[c1][d0] * (PB_0 * PA_0 * (-1.0))
                            + delta[a1][d1] * delta[b1][c1] * delta[c0][d0] * (PB_0 * PA_0 * (-1.0))
                            + delta[a1][d1] * delta[b1][d0] * delta[c0][c1] * (PB_0 * PA_0 * (-1.0))
                            + delta[a1][b1] * delta[c0][c1] * delta[d0][d1] * (PB_0 * PA_0 * (-1.0) + PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[a1][b1] * delta[c0][d0] * delta[c1][d1] * (PB_0 * PA_0 * (-1.0) + PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[a1][b1] * delta[c1][d0] * delta[c0][d1] * (PB_0 * PA_0 * (-1.0) + PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[a1][c0] * delta[b0][c1] * delta[d0][d1] * (PB_1 * PA_0 * (-1.0))
                            + delta[a1][c0] * delta[b0][d0] * delta[c1][d1] * (PB_1 * PA_0 * (-1.0))
                            + delta[a1][c0] * delta[b0][d1] * delta[c1][d0] * (PB_1 * PA_0 * (-1.0))
                            + delta[a1][c1] * delta[b0][c0] * delta[d0][d1] * (PB_1 * PA_0 * (-1.0))
                            + delta[a1][c1] * delta[b0][d0] * delta[c0][d1] * (PB_1 * PA_0 * (-1.0))
                            + delta[a1][c1] * delta[b0][d1] * delta[c0][d0] * (PB_1 * PA_0 * (-1.0))
                            + delta[a1][d0] * delta[b0][c0] * delta[c1][d1] * (PB_1 * PA_0 * (-1.0))
                            + delta[a1][d0] * delta[b0][c1] * delta[c0][d1] * (PB_1 * PA_0 * (-1.0))
                            + delta[a1][d0] * delta[b0][d1] * delta[c0][c1] * (PB_1 * PA_0 * (-1.0))
                            + delta[a1][d1] * delta[b0][c0] * delta[c1][d0] * (PB_1 * PA_0 * (-1.0))
                            + delta[a1][d1] * delta[b0][c1] * delta[c0][d0] * (PB_1 * PA_0 * (-1.0))
                            + delta[a1][d1] * delta[b0][d0] * delta[c0][c1] * (PB_1 * PA_0 * (-1.0))
                            + delta[a1][b0] * delta[c0][c1] * delta[d0][d1] * (PB_1 * PA_0 * (-1.0) + PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[a1][b0] * delta[c0][d0] * delta[c1][d1] * (PB_1 * PA_0 * (-1.0) + PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[a1][b0] * delta[c1][d0] * delta[c0][d1] * (PB_1 * PA_0 * (-1.0) + PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[a1][c1] * delta[b0][b1] * delta[d0][d1] * (PA_0 * PQ[c0])
                            + delta[a1][d0] * delta[b0][b1] * delta[c1][d1] * (PA_0 * PQ[c0])
                            + delta[a1][d1] * delta[b0][b1] * delta[c1][d0] * (PA_0 * PQ[c0])
                            + delta[a1][b0] * delta[b1][c1] * delta[d0][d1] * (PA_0 * PQ[c0])
                            + delta[a1][b0] * delta[b1][d0] * delta[c1][d1] * (PA_0 * PQ[c0])
                            + delta[a1][b0] * delta[b1][d1] * delta[c1][d0] * (PA_0 * PQ[c0])
                            + delta[b0][c1] * delta[a1][b1] * delta[d0][d1] * (PA_0 * PQ[c0])
                            + delta[b0][d0] * delta[a1][b1] * delta[c1][d1] * (PA_0 * PQ[c0])
                            + delta[b0][d1] * delta[a1][b1] * delta[c1][d0] * (PA_0 * PQ[c0])
                            + delta[a1][c0] * delta[b0][b1] * delta[d0][d1] * (PA_0 * PQ[c1])
                            + delta[a1][d0] * delta[b0][b1] * delta[c0][d1] * (PA_0 * PQ[c1])
                            + delta[a1][d1] * delta[b0][b1] * delta[c0][d0] * (PA_0 * PQ[c1])
                            + delta[a1][b0] * delta[b1][c0] * delta[d0][d1] * (PA_0 * PQ[c1])
                            + delta[a1][b0] * delta[b1][d0] * delta[c0][d1] * (PA_0 * PQ[c1])
                            + delta[a1][b0] * delta[b1][d1] * delta[c0][d0] * (PA_0 * PQ[c1])
                            + delta[b0][c0] * delta[a1][b1] * delta[d0][d1] * (PA_0 * PQ[c1])
                            + delta[b0][d0] * delta[a1][b1] * delta[c0][d1] * (PA_0 * PQ[c1])
                            + delta[b0][d1] * delta[a1][b1] * delta[c0][d0] * (PA_0 * PQ[c1])
                            + delta[a1][c0] * delta[b0][b1] * delta[c1][d1] * (PA_0 * PQ[d0])
                            + delta[a1][c1] * delta[b0][b1] * delta[c0][d1] * (PA_0 * PQ[d0])
                            + delta[a1][d1] * delta[b0][b1] * delta[c0][c1] * (PA_0 * PQ[d0])
                            + delta[a1][b0] * delta[b1][c0] * delta[c1][d1] * (PA_0 * PQ[d0])
                            + delta[a1][b0] * delta[b1][c1] * delta[c0][d1] * (PA_0 * PQ[d0])
                            + delta[a1][b0] * delta[b1][d1] * delta[c0][c1] * (PA_0 * PQ[d0])
                            + delta[b0][c0] * delta[a1][b1] * delta[c1][d1] * (PA_0 * PQ[d0])
                            + delta[b0][c1] * delta[a1][b1] * delta[c0][d1] * (PA_0 * PQ[d0])
                            + delta[b0][d1] * delta[a1][b1] * delta[c0][c1] * (PA_0 * PQ[d0])
                            + delta[a1][c0] * delta[b0][b1] * delta[c1][d0] * (PA_0 * PQ[d1])
                            + delta[a1][c1] * delta[b0][b1] * delta[c0][d0] * (PA_0 * PQ[d1])
                            + delta[a1][d0] * delta[b0][b1] * delta[c0][c1] * (PA_0 * PQ[d1])
                            + delta[a1][b0] * delta[b1][c0] * delta[c1][d0] * (PA_0 * PQ[d1])
                            + delta[a1][b0] * delta[b1][c1] * delta[c0][d0] * (PA_0 * PQ[d1])
                            + delta[a1][b0] * delta[b1][d0] * delta[c0][c1] * (PA_0 * PQ[d1])
                            + delta[b0][c0] * delta[a1][b1] * delta[c1][d0] * (PA_0 * PQ[d1])
                            + delta[b0][c1] * delta[a1][b1] * delta[c0][d0] * (PA_0 * PQ[d1])
                            + delta[b0][d0] * delta[a1][b1] * delta[c0][c1] * (PA_0 * PQ[d1])
                            + delta[a0][c0] * delta[b1][c1] * delta[d0][d1] * (PB_0 * PA_1 * (-1.0))
                            + delta[a0][c0] * delta[b1][d0] * delta[c1][d1] * (PB_0 * PA_1 * (-1.0))
                            + delta[a0][c0] * delta[b1][d1] * delta[c1][d0] * (PB_0 * PA_1 * (-1.0))
                            + delta[a0][c1] * delta[b1][c0] * delta[d0][d1] * (PB_0 * PA_1 * (-1.0))
                            + delta[a0][c1] * delta[b1][d0] * delta[c0][d1] * (PB_0 * PA_1 * (-1.0))
                            + delta[a0][c1] * delta[b1][d1] * delta[c0][d0] * (PB_0 * PA_1 * (-1.0))
                            + delta[a0][d0] * delta[b1][c0] * delta[c1][d1] * (PB_0 * PA_1 * (-1.0))
                            + delta[a0][d0] * delta[b1][c1] * delta[c0][d1] * (PB_0 * PA_1 * (-1.0))
                            + delta[a0][d0] * delta[b1][d1] * delta[c0][c1] * (PB_0 * PA_1 * (-1.0))
                            + delta[a0][d1] * delta[b1][c0] * delta[c1][d0] * (PB_0 * PA_1 * (-1.0))
                            + delta[a0][d1] * delta[b1][c1] * delta[c0][d0] * (PB_0 * PA_1 * (-1.0))
                            + delta[a0][d1] * delta[b1][d0] * delta[c0][c1] * (PB_0 * PA_1 * (-1.0))
                            + delta[a0][b1] * delta[c0][c1] * delta[d0][d1] * (PB_0 * PA_1 * (-1.0) + PB_0 * PQ[a1] + PA_1 * PQ[b0])
                            + delta[a0][b1] * delta[c0][d0] * delta[c1][d1] * (PB_0 * PA_1 * (-1.0) + PB_0 * PQ[a1] + PA_1 * PQ[b0])
                            + delta[a0][b1] * delta[c1][d0] * delta[c0][d1] * (PB_0 * PA_1 * (-1.0) + PB_0 * PQ[a1] + PA_1 * PQ[b0])
                            + delta[a0][c0] * delta[b0][c1] * delta[d0][d1] * (PB_1 * PA_1 * (-1.0))
                            + delta[a0][c0] * delta[b0][d0] * delta[c1][d1] * (PB_1 * PA_1 * (-1.0))
                            + delta[a0][c0] * delta[b0][d1] * delta[c1][d0] * (PB_1 * PA_1 * (-1.0))
                            + delta[a0][c1] * delta[b0][c0] * delta[d0][d1] * (PB_1 * PA_1 * (-1.0))
                            + delta[a0][c1] * delta[b0][d0] * delta[c0][d1] * (PB_1 * PA_1 * (-1.0))
                            + delta[a0][c1] * delta[b0][d1] * delta[c0][d0] * (PB_1 * PA_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][c0] * delta[c1][d1] * (PB_1 * PA_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][c1] * delta[c0][d1] * (PB_1 * PA_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][d1] * delta[c0][c1] * (PB_1 * PA_1 * (-1.0))
                            + delta[a0][d1] * delta[b0][c0] * delta[c1][d0] * (PB_1 * PA_1 * (-1.0))
                            + delta[a0][d1] * delta[b0][c1] * delta[c0][d0] * (PB_1 * PA_1 * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * delta[c0][c1] * (PB_1 * PA_1 * (-1.0))
                            + delta[a0][b0] * delta[c0][c1] * delta[d0][d1] * (PB_1 * PA_1 * (-1.0) + PB_1 * PQ[a1] + PA_1 * PQ[b1])
                            + delta[a0][b0] * delta[c0][d0] * delta[c1][d1] * (PB_1 * PA_1 * (-1.0) + PB_1 * PQ[a1] + PA_1 * PQ[b1])
                            + delta[a0][b0] * delta[c1][d0] * delta[c0][d1] * (PB_1 * PA_1 * (-1.0) + PB_1 * PQ[a1] + PA_1 * PQ[b1])
                            + delta[a0][c1] * delta[b0][b1] * delta[d0][d1] * (PA_1 * PQ[c0])
                            + delta[a0][d0] * delta[b0][b1] * delta[c1][d1] * (PA_1 * PQ[c0])
                            + delta[a0][d1] * delta[b0][b1] * delta[c1][d0] * (PA_1 * PQ[c0])
                            + delta[a0][b0] * delta[b1][c1] * delta[d0][d1] * (PA_1 * PQ[c0])
                            + delta[a0][b0] * delta[b1][d0] * delta[c1][d1] * (PA_1 * PQ[c0])
                            + delta[a0][b0] * delta[b1][d1] * delta[c1][d0] * (PA_1 * PQ[c0])
                            + delta[b0][c1] * delta[a0][b1] * delta[d0][d1] * (PA_1 * PQ[c0])
                            + delta[b0][d0] * delta[a0][b1] * delta[c1][d1] * (PA_1 * PQ[c0])
                            + delta[b0][d1] * delta[a0][b1] * delta[c1][d0] * (PA_1 * PQ[c0])
                            + delta[a0][c0] * delta[b0][b1] * delta[d0][d1] * (PA_1 * PQ[c1])
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][d1] * (PA_1 * PQ[c1])
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][d0] * (PA_1 * PQ[c1])
                            + delta[a0][b0] * delta[b1][c0] * delta[d0][d1] * (PA_1 * PQ[c1])
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][d1] * (PA_1 * PQ[c1])
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][d0] * (PA_1 * PQ[c1])
                            + delta[b0][c0] * delta[a0][b1] * delta[d0][d1] * (PA_1 * PQ[c1])
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][d1] * (PA_1 * PQ[c1])
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][d0] * (PA_1 * PQ[c1])
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d1] * (PA_1 * PQ[d0])
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d1] * (PA_1 * PQ[d0])
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][c1] * (PA_1 * PQ[d0])
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d1] * (PA_1 * PQ[d0])
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d1] * (PA_1 * PQ[d0])
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][c1] * (PA_1 * PQ[d0])
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d1] * (PA_1 * PQ[d0])
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d1] * (PA_1 * PQ[d0])
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][c1] * (PA_1 * PQ[d0])
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d0] * (PA_1 * PQ[d1])
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d0] * (PA_1 * PQ[d1])
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][c1] * (PA_1 * PQ[d1])
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d0] * (PA_1 * PQ[d1])
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d0] * (PA_1 * PQ[d1])
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][c1] * (PA_1 * PQ[d1])
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d0] * (PA_1 * PQ[d1])
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d0] * (PA_1 * PQ[d1])
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][c1] * (PA_1 * PQ[d1])
                            + delta[a0][c0] * delta[a1][c1] * delta[d0][d1] * (PB_0 * PB_1 * (-1.0))
                            + delta[a0][c0] * delta[a1][d0] * delta[c1][d1] * (PB_0 * PB_1 * (-1.0))
                            + delta[a0][c0] * delta[a1][d1] * delta[c1][d0] * (PB_0 * PB_1 * (-1.0))
                            + delta[a0][c1] * delta[a1][c0] * delta[d0][d1] * (PB_0 * PB_1 * (-1.0))
                            + delta[a0][c1] * delta[a1][d0] * delta[c0][d1] * (PB_0 * PB_1 * (-1.0))
                            + delta[a0][c1] * delta[a1][d1] * delta[c0][d0] * (PB_0 * PB_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][c0] * delta[c1][d1] * (PB_0 * PB_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][c1] * delta[c0][d1] * (PB_0 * PB_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][d1] * delta[c0][c1] * (PB_0 * PB_1 * (-1.0))
                            + delta[a0][d1] * delta[a1][c0] * delta[c1][d0] * (PB_0 * PB_1 * (-1.0))
                            + delta[a0][d1] * delta[a1][c1] * delta[c0][d0] * (PB_0 * PB_1 * (-1.0))
                            + delta[a0][d1] * delta[a1][d0] * delta[c0][c1] * (PB_0 * PB_1 * (-1.0))
                            + delta[a0][a1] * delta[c0][c1] * delta[d0][d1] * (PB_0 * PB_1 * (-1.0) + PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[a0][a1] * delta[c0][d0] * delta[c1][d1] * (PB_0 * PB_1 * (-1.0) + PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[a0][a1] * delta[c1][d0] * delta[c0][d1] * (PB_0 * PB_1 * (-1.0) + PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[a0][a1] * delta[b0][b1] * delta[d0][d1] * (PQ[c0] * PQ[c1] * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[d0][d1] * (PQ[c0] * PQ[c1] * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[d0][d1] * (PQ[c0] * PQ[c1] * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d1] * (PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d1] * (PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d1] * (PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d0] * (PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d0] * (PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d0] * (PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d1] * (PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d1] * (PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d1] * (PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * (PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * (PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * (PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][c1] * (PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][c1] * (PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][c1] * (PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[a1][b1] * delta[d0][d1] * (PB_0 * PQ[c0])
                            + delta[a0][d0] * delta[a1][b1] * delta[c1][d1] * (PB_0 * PQ[c0])
                            + delta[a0][d1] * delta[a1][b1] * delta[c1][d0] * (PB_0 * PQ[c0])
                            + delta[a0][a1] * delta[b1][c1] * delta[d0][d1] * (PB_0 * PQ[c0])
                            + delta[a0][a1] * delta[b1][d0] * delta[c1][d1] * (PB_0 * PQ[c0])
                            + delta[a0][a1] * delta[b1][d1] * delta[c1][d0] * (PB_0 * PQ[c0])
                            + delta[a1][c1] * delta[a0][b1] * delta[d0][d1] * (PB_0 * PQ[c0])
                            + delta[a1][d0] * delta[a0][b1] * delta[c1][d1] * (PB_0 * PQ[c0])
                            + delta[a1][d1] * delta[a0][b1] * delta[c1][d0] * (PB_0 * PQ[c0])
                            + delta[a0][c0] * delta[a1][b1] * delta[d0][d1] * (PB_0 * PQ[c1])
                            + delta[a0][d0] * delta[a1][b1] * delta[c0][d1] * (PB_0 * PQ[c1])
                            + delta[a0][d1] * delta[a1][b1] * delta[c0][d0] * (PB_0 * PQ[c1])
                            + delta[a0][a1] * delta[b1][c0] * delta[d0][d1] * (PB_0 * PQ[c1])
                            + delta[a0][a1] * delta[b1][d0] * delta[c0][d1] * (PB_0 * PQ[c1])
                            + delta[a0][a1] * delta[b1][d1] * delta[c0][d0] * (PB_0 * PQ[c1])
                            + delta[a1][c0] * delta[a0][b1] * delta[d0][d1] * (PB_0 * PQ[c1])
                            + delta[a1][d0] * delta[a0][b1] * delta[c0][d1] * (PB_0 * PQ[c1])
                            + delta[a1][d1] * delta[a0][b1] * delta[c0][d0] * (PB_0 * PQ[c1])
                            + delta[a0][c0] * delta[a1][b1] * delta[c1][d1] * (PB_0 * PQ[d0])
                            + delta[a0][c1] * delta[a1][b1] * delta[c0][d1] * (PB_0 * PQ[d0])
                            + delta[a0][d1] * delta[a1][b1] * delta[c0][c1] * (PB_0 * PQ[d0])
                            + delta[a0][a1] * delta[b1][c0] * delta[c1][d1] * (PB_0 * PQ[d0])
                            + delta[a0][a1] * delta[b1][c1] * delta[c0][d1] * (PB_0 * PQ[d0])
                            + delta[a0][a1] * delta[b1][d1] * delta[c0][c1] * (PB_0 * PQ[d0])
                            + delta[a1][c0] * delta[a0][b1] * delta[c1][d1] * (PB_0 * PQ[d0])
                            + delta[a1][c1] * delta[a0][b1] * delta[c0][d1] * (PB_0 * PQ[d0])
                            + delta[a1][d1] * delta[a0][b1] * delta[c0][c1] * (PB_0 * PQ[d0])
                            + delta[a0][c0] * delta[a1][b1] * delta[c1][d0] * (PB_0 * PQ[d1])
                            + delta[a0][c1] * delta[a1][b1] * delta[c0][d0] * (PB_0 * PQ[d1])
                            + delta[a0][d0] * delta[a1][b1] * delta[c0][c1] * (PB_0 * PQ[d1])
                            + delta[a0][a1] * delta[b1][c0] * delta[c1][d0] * (PB_0 * PQ[d1])
                            + delta[a0][a1] * delta[b1][c1] * delta[c0][d0] * (PB_0 * PQ[d1])
                            + delta[a0][a1] * delta[b1][d0] * delta[c0][c1] * (PB_0 * PQ[d1])
                            + delta[a1][c0] * delta[a0][b1] * delta[c1][d0] * (PB_0 * PQ[d1])
                            + delta[a1][c1] * delta[a0][b1] * delta[c0][d0] * (PB_0 * PQ[d1])
                            + delta[a1][d0] * delta[a0][b1] * delta[c0][c1] * (PB_0 * PQ[d1])
                            + delta[a0][c1] * delta[a1][b0] * delta[d0][d1] * (PB_1 * PQ[c0])
                            + delta[a0][d0] * delta[a1][b0] * delta[c1][d1] * (PB_1 * PQ[c0])
                            + delta[a0][d1] * delta[a1][b0] * delta[c1][d0] * (PB_1 * PQ[c0])
                            + delta[a0][a1] * delta[b0][c1] * delta[d0][d1] * (PB_1 * PQ[c0])
                            + delta[a0][a1] * delta[b0][d0] * delta[c1][d1] * (PB_1 * PQ[c0])
                            + delta[a0][a1] * delta[b0][d1] * delta[c1][d0] * (PB_1 * PQ[c0])
                            + delta[a1][c1] * delta[a0][b0] * delta[d0][d1] * (PB_1 * PQ[c0])
                            + delta[a1][d0] * delta[a0][b0] * delta[c1][d1] * (PB_1 * PQ[c0])
                            + delta[a1][d1] * delta[a0][b0] * delta[c1][d0] * (PB_1 * PQ[c0])
                            + delta[a0][c0] * delta[a1][b0] * delta[d0][d1] * (PB_1 * PQ[c1])
                            + delta[a0][d0] * delta[a1][b0] * delta[c0][d1] * (PB_1 * PQ[c1])
                            + delta[a0][d1] * delta[a1][b0] * delta[c0][d0] * (PB_1 * PQ[c1])
                            + delta[a0][a1] * delta[b0][c0] * delta[d0][d1] * (PB_1 * PQ[c1])
                            + delta[a0][a1] * delta[b0][d0] * delta[c0][d1] * (PB_1 * PQ[c1])
                            + delta[a0][a1] * delta[b0][d1] * delta[c0][d0] * (PB_1 * PQ[c1])
                            + delta[a1][c0] * delta[a0][b0] * delta[d0][d1] * (PB_1 * PQ[c1])
                            + delta[a1][d0] * delta[a0][b0] * delta[c0][d1] * (PB_1 * PQ[c1])
                            + delta[a1][d1] * delta[a0][b0] * delta[c0][d0] * (PB_1 * PQ[c1])
                            + delta[a0][c0] * delta[a1][b0] * delta[c1][d1] * (PB_1 * PQ[d0])
                            + delta[a0][c1] * delta[a1][b0] * delta[c0][d1] * (PB_1 * PQ[d0])
                            + delta[a0][d1] * delta[a1][b0] * delta[c0][c1] * (PB_1 * PQ[d0])
                            + delta[a0][a1] * delta[b0][c0] * delta[c1][d1] * (PB_1 * PQ[d0])
                            + delta[a0][a1] * delta[b0][c1] * delta[c0][d1] * (PB_1 * PQ[d0])
                            + delta[a0][a1] * delta[b0][d1] * delta[c0][c1] * (PB_1 * PQ[d0])
                            + delta[a1][c0] * delta[a0][b0] * delta[c1][d1] * (PB_1 * PQ[d0])
                            + delta[a1][c1] * delta[a0][b0] * delta[c0][d1] * (PB_1 * PQ[d0])
                            + delta[a1][d1] * delta[a0][b0] * delta[c0][c1] * (PB_1 * PQ[d0])
                            + delta[a0][c0] * delta[a1][b0] * delta[c1][d0] * (PB_1 * PQ[d1])
                            + delta[a0][c1] * delta[a1][b0] * delta[c0][d0] * (PB_1 * PQ[d1])
                            + delta[a0][d0] * delta[a1][b0] * delta[c0][c1] * (PB_1 * PQ[d1])
                            + delta[a0][a1] * delta[b0][c0] * delta[c1][d0] * (PB_1 * PQ[d1])
                            + delta[a0][a1] * delta[b0][c1] * delta[c0][d0] * (PB_1 * PQ[d1])
                            + delta[a0][a1] * delta[b0][d0] * delta[c0][c1] * (PB_1 * PQ[d1])
                            + delta[a1][c0] * delta[a0][b0] * delta[c1][d0] * (PB_1 * PQ[d1])
                            + delta[a1][c1] * delta[a0][b0] * delta[c0][d0] * (PB_1 * PQ[d1])
                            + delta[a1][d0] * delta[a0][b0] * delta[c0][c1] * (PB_1 * PQ[d1])
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD16(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[4];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[3] * (

                        0.125 * S2 / ( S1 * S4 * S4 * S4 ) * (
                            delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (PQ[a0] * PQ[a1] * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (PQ[a0] * PQ[a1] * (-1.0))
                            + delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (PQ[a0] * PQ[a1] * (-1.0))
                            + delta[a1][b1] * delta[c0][c1] * delta[d0][d1] * (PQ[a0] * PQ[b0] * (-1.0))
                            + delta[a1][b1] * delta[c0][d0] * delta[c1][d1] * (PQ[a0] * PQ[b0] * (-1.0))
                            + delta[a1][b1] * delta[c1][d0] * delta[c0][d1] * (PQ[a0] * PQ[b0] * (-1.0))
                            + delta[a1][b0] * delta[c0][c1] * delta[d0][d1] * (PQ[a0] * PQ[b1] * (-1.0))
                            + delta[a1][b0] * delta[c0][d0] * delta[c1][d1] * (PQ[a0] * PQ[b1] * (-1.0))
                            + delta[a1][b0] * delta[c1][d0] * delta[c0][d1] * (PQ[a0] * PQ[b1] * (-1.0))
                            + delta[a1][c1] * delta[b0][b1] * delta[d0][d1] * (PQ[a0] * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[b0][b1] * delta[c1][d1] * (PQ[a0] * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[b0][b1] * delta[c1][d0] * (PQ[a0] * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][c1] * delta[d0][d1] * (PQ[a0] * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][d0] * delta[c1][d1] * (PQ[a0] * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][d1] * delta[c1][d0] * (PQ[a0] * QC_0 * (-1.0))
                            + delta[b0][c1] * delta[a1][b1] * delta[d0][d1] * (PQ[a0] * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[a1][b1] * delta[c1][d1] * (PQ[a0] * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[a1][b1] * delta[c1][d0] * (PQ[a0] * QC_0 * (-1.0))
                            + delta[a1][c0] * delta[b0][b1] * delta[d0][d1] * (PQ[a0] * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[b0][b1] * delta[c0][d1] * (PQ[a0] * QC_1 * (-1.0))
                            + delta[a1][d1] * delta[b0][b1] * delta[c0][d0] * (PQ[a0] * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[b1][c0] * delta[d0][d1] * (PQ[a0] * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[b1][d0] * delta[c0][d1] * (PQ[a0] * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[b1][d1] * delta[c0][d0] * (PQ[a0] * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[a1][b1] * delta[d0][d1] * (PQ[a0] * QC_1 * (-1.0))
                            + delta[b0][d0] * delta[a1][b1] * delta[c0][d1] * (PQ[a0] * QC_1 * (-1.0))
                            + delta[b0][d1] * delta[a1][b1] * delta[c0][d0] * (PQ[a0] * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[b0][b1] * delta[c1][d1] * (PQ[a0] * QD_0 * (-1.0))
                            + delta[a1][c1] * delta[b0][b1] * delta[c0][d1] * (PQ[a0] * QD_0 * (-1.0))
                            + delta[a1][d1] * delta[b0][b1] * delta[c0][c1] * (PQ[a0] * QD_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][c0] * delta[c1][d1] * (PQ[a0] * QD_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][c1] * delta[c0][d1] * (PQ[a0] * QD_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][d1] * delta[c0][c1] * (PQ[a0] * QD_0 * (-1.0))
                            + delta[b0][c0] * delta[a1][b1] * delta[c1][d1] * (PQ[a0] * QD_0 * (-1.0))
                            + delta[b0][c1] * delta[a1][b1] * delta[c0][d1] * (PQ[a0] * QD_0 * (-1.0))
                            + delta[b0][d1] * delta[a1][b1] * delta[c0][c1] * (PQ[a0] * QD_0 * (-1.0))
                            + delta[a1][c0] * delta[b0][b1] * delta[c1][d0] * (PQ[a0] * QD_1 * (-1.0))
                            + delta[a1][c1] * delta[b0][b1] * delta[c0][d0] * (PQ[a0] * QD_1 * (-1.0))
                            + delta[a1][d0] * delta[b0][b1] * delta[c0][c1] * (PQ[a0] * QD_1 * (-1.0))
                            + delta[a1][b0] * delta[b1][c0] * delta[c1][d0] * (PQ[a0] * QD_1 * (-1.0))
                            + delta[a1][b0] * delta[b1][c1] * delta[c0][d0] * (PQ[a0] * QD_1 * (-1.0))
                            + delta[a1][b0] * delta[b1][d0] * delta[c0][c1] * (PQ[a0] * QD_1 * (-1.0))
                            + delta[b0][c0] * delta[a1][b1] * delta[c1][d0] * (PQ[a0] * QD_1 * (-1.0))
                            + delta[b0][c1] * delta[a1][b1] * delta[c0][d0] * (PQ[a0] * QD_1 * (-1.0))
                            + delta[b0][d0] * delta[a1][b1] * delta[c0][c1] * (PQ[a0] * QD_1 * (-1.0))
                            + delta[a0][b1] * delta[c0][c1] * delta[d0][d1] * (PQ[a1] * PQ[b0] * (-1.0))
                            + delta[a0][b1] * delta[c0][d0] * delta[c1][d1] * (PQ[a1] * PQ[b0] * (-1.0))
                            + delta[a0][b1] * delta[c1][d0] * delta[c0][d1] * (PQ[a1] * PQ[b0] * (-1.0))
                            + delta[a0][b0] * delta[c0][c1] * delta[d0][d1] * (PQ[a1] * PQ[b1] * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * delta[c1][d1] * (PQ[a1] * PQ[b1] * (-1.0))
                            + delta[a0][b0] * delta[c1][d0] * delta[c0][d1] * (PQ[a1] * PQ[b1] * (-1.0))
                            + delta[a0][c1] * delta[b0][b1] * delta[d0][d1] * (PQ[a1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * delta[c1][d1] * (PQ[a1] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * delta[c1][d0] * (PQ[a1] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][c1] * delta[d0][d1] * (PQ[a1] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * delta[c1][d1] * (PQ[a1] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * delta[c1][d0] * (PQ[a1] * QC_0 * (-1.0))
                            + delta[b0][c1] * delta[a0][b1] * delta[d0][d1] * (PQ[a1] * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * delta[c1][d1] * (PQ[a1] * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * delta[c1][d0] * (PQ[a1] * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * delta[d0][d1] * (PQ[a1] * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][d1] * (PQ[a1] * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][d0] * (PQ[a1] * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * delta[d0][d1] * (PQ[a1] * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][d1] * (PQ[a1] * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][d0] * (PQ[a1] * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * delta[d0][d1] * (PQ[a1] * QC_1 * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][d1] * (PQ[a1] * QC_1 * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][d0] * (PQ[a1] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d1] * (PQ[a1] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d1] * (PQ[a1] * QD_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][c1] * (PQ[a1] * QD_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d1] * (PQ[a1] * QD_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d1] * (PQ[a1] * QD_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][c1] * (PQ[a1] * QD_0 * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d1] * (PQ[a1] * QD_0 * (-1.0))
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d1] * (PQ[a1] * QD_0 * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][c1] * (PQ[a1] * QD_0 * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d0] * (PQ[a1] * QD_1 * (-1.0))
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d0] * (PQ[a1] * QD_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][c1] * (PQ[a1] * QD_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d0] * (PQ[a1] * QD_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d0] * (PQ[a1] * QD_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][c1] * (PQ[a1] * QD_1 * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d0] * (PQ[a1] * QD_1 * (-1.0))
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d0] * (PQ[a1] * QD_1 * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][c1] * (PQ[a1] * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[c0][c1] * delta[d0][d1] * (PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][a1] * delta[c0][d0] * delta[c1][d1] * (PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][a1] * delta[c1][d0] * delta[c0][d1] * (PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][c1] * delta[a1][b1] * delta[d0][d1] * (PQ[b0] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[a1][b1] * delta[c1][d1] * (PQ[b0] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][b1] * delta[c1][d0] * (PQ[b0] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][c1] * delta[d0][d1] * (PQ[b0] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][d0] * delta[c1][d1] * (PQ[b0] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][d1] * delta[c1][d0] * (PQ[b0] * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[a0][b1] * delta[d0][d1] * (PQ[b0] * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[a0][b1] * delta[c1][d1] * (PQ[b0] * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[a0][b1] * delta[c1][d0] * (PQ[b0] * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][b1] * delta[d0][d1] * (PQ[b0] * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][b1] * delta[c0][d1] * (PQ[b0] * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[a1][b1] * delta[c0][d0] * (PQ[b0] * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b1][c0] * delta[d0][d1] * (PQ[b0] * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b1][d0] * delta[c0][d1] * (PQ[b0] * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b1][d1] * delta[c0][d0] * (PQ[b0] * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[a0][b1] * delta[d0][d1] * (PQ[b0] * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[a0][b1] * delta[c0][d1] * (PQ[b0] * QC_1 * (-1.0))
                            + delta[a1][d1] * delta[a0][b1] * delta[c0][d0] * (PQ[b0] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[a1][b1] * delta[c1][d1] * (PQ[b0] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[a1][b1] * delta[c0][d1] * (PQ[b0] * QD_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][b1] * delta[c0][c1] * (PQ[b0] * QD_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][c0] * delta[c1][d1] * (PQ[b0] * QD_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][c1] * delta[c0][d1] * (PQ[b0] * QD_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][d1] * delta[c0][c1] * (PQ[b0] * QD_0 * (-1.0))
                            + delta[a1][c0] * delta[a0][b1] * delta[c1][d1] * (PQ[b0] * QD_0 * (-1.0))
                            + delta[a1][c1] * delta[a0][b1] * delta[c0][d1] * (PQ[b0] * QD_0 * (-1.0))
                            + delta[a1][d1] * delta[a0][b1] * delta[c0][c1] * (PQ[b0] * QD_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][b1] * delta[c1][d0] * (PQ[b0] * QD_1 * (-1.0))
                            + delta[a0][c1] * delta[a1][b1] * delta[c0][d0] * (PQ[b0] * QD_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][b1] * delta[c0][c1] * (PQ[b0] * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[b1][c0] * delta[c1][d0] * (PQ[b0] * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[b1][c1] * delta[c0][d0] * (PQ[b0] * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[b1][d0] * delta[c0][c1] * (PQ[b0] * QD_1 * (-1.0))
                            + delta[a1][c0] * delta[a0][b1] * delta[c1][d0] * (PQ[b0] * QD_1 * (-1.0))
                            + delta[a1][c1] * delta[a0][b1] * delta[c0][d0] * (PQ[b0] * QD_1 * (-1.0))
                            + delta[a1][d0] * delta[a0][b1] * delta[c0][c1] * (PQ[b0] * QD_1 * (-1.0))
                            + delta[a0][c1] * delta[a1][b0] * delta[d0][d1] * (PQ[b1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * delta[c1][d1] * (PQ[b1] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * delta[c1][d0] * (PQ[b1] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][c1] * delta[d0][d1] * (PQ[b1] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * delta[c1][d1] * (PQ[b1] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * delta[c1][d0] * (PQ[b1] * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[a0][b0] * delta[d0][d1] * (PQ[b1] * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * delta[c1][d1] * (PQ[b1] * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * delta[c1][d0] * (PQ[b1] * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * delta[d0][d1] * (PQ[b1] * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * delta[c0][d1] * (PQ[b1] * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * delta[c0][d0] * (PQ[b1] * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * delta[d0][d1] * (PQ[b1] * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * delta[c0][d1] * (PQ[b1] * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * delta[c0][d0] * (PQ[b1] * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * delta[d0][d1] * (PQ[b1] * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * delta[c0][d1] * (PQ[b1] * QC_1 * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * delta[c0][d0] * (PQ[b1] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * delta[c1][d1] * (PQ[b1] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[a1][b0] * delta[c0][d1] * (PQ[b1] * QD_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * delta[c0][c1] * (PQ[b1] * QD_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * delta[c1][d1] * (PQ[b1] * QD_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][c1] * delta[c0][d1] * (PQ[b1] * QD_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * delta[c0][c1] * (PQ[b1] * QD_0 * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * delta[c1][d1] * (PQ[b1] * QD_0 * (-1.0))
                            + delta[a1][c1] * delta[a0][b0] * delta[c0][d1] * (PQ[b1] * QD_0 * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * delta[c0][c1] * (PQ[b1] * QD_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * delta[c1][d0] * (PQ[b1] * QD_1 * (-1.0))
                            + delta[a0][c1] * delta[a1][b0] * delta[c0][d0] * (PQ[b1] * QD_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * delta[c0][c1] * (PQ[b1] * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * delta[c1][d0] * (PQ[b1] * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][c1] * delta[c0][d0] * (PQ[b1] * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * delta[c0][c1] * (PQ[b1] * QD_1 * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * delta[c1][d0] * (PQ[b1] * QD_1 * (-1.0))
                            + delta[a1][c1] * delta[a0][b0] * delta[c0][d0] * (PQ[b1] * QD_1 * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * delta[c0][c1] * (PQ[b1] * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[d0][d1] * (PQ[c0] * QC_1 * (-1.0) + PQ[c1] * QC_0 * (-1.0) + QC_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[d0][d1] * (PQ[c0] * QC_1 * (-1.0) + PQ[c1] * QC_0 * (-1.0) + QC_0 * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[d0][d1] * (PQ[c0] * QC_1 * (-1.0) + PQ[c1] * QC_0 * (-1.0) + QC_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0) + QD_0 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0) + QD_0 * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0) + QD_0 * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d0] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0) + QD_1 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d0] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0) + QD_1 * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d0] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0) + QD_1 * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d1] * (PQ[c1] * QD_0 * (-1.0) + PQ[d0] * QC_1 * (-1.0) + QD_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d1] * (PQ[c1] * QD_0 * (-1.0) + PQ[d0] * QC_1 * (-1.0) + QD_0 * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d1] * (PQ[c1] * QD_0 * (-1.0) + PQ[d0] * QC_1 * (-1.0) + QD_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * (PQ[c1] * QD_1 * (-1.0) + PQ[d1] * QC_1 * (-1.0) + QD_1 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * (PQ[c1] * QD_1 * (-1.0) + PQ[d1] * QC_1 * (-1.0) + QD_1 * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * (PQ[c1] * QD_1 * (-1.0) + PQ[d1] * QC_1 * (-1.0) + QD_1 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][c1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0) + QD_0 * QD_1 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][c1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0) + QD_0 * QD_1 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][c1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0) + QD_0 * QD_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][d1] * delta[b0][b1] * (QC_0 * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][d1] * (QC_0 * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][d1] * delta[a1][b1] * (QC_0 * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][b1] * (QC_0 * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][d0] * (QC_0 * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * delta[a1][b1] * (QC_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][d1] * (QC_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][d0] * (QC_0 * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][d1] * (QC_0 * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[b0][d1] * delta[a0][b1] * (QC_0 * QC_1 * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][d0] * (QC_0 * QC_1 * (-1.0))
                            + delta[a1][d1] * delta[b0][d0] * delta[a0][b1] * (QC_0 * QC_1 * (-1.0))
                            + delta[a0][c1] * delta[a1][d1] * delta[b0][b1] * (QD_0 * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][d1] * (QD_0 * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][d1] * delta[a1][b1] * (QD_0 * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][c1] * delta[b0][b1] * (QD_0 * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][c1] * (QD_0 * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][c1] * delta[a1][b1] * (QD_0 * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][d1] * (QD_0 * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][c1] * (QD_0 * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][d1] * (QD_0 * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[b0][d1] * delta[a0][b1] * (QD_0 * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][c1] * (QD_0 * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[b0][c1] * delta[a0][b1] * (QD_0 * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[a1][d0] * delta[b0][b1] * (QD_1 * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][d0] * (QD_1 * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][d0] * delta[a1][b1] * (QD_1 * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[a1][c1] * delta[b0][b1] * (QD_1 * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][c1] * (QD_1 * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b0][c1] * delta[a1][b1] * (QD_1 * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][d0] * (QD_1 * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][c1] * (QD_1 * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][d0] * (QD_1 * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[b0][d0] * delta[a0][b1] * (QD_1 * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][c1] * (QD_1 * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[b0][c1] * delta[a0][b1] * (QD_1 * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][d1] * delta[b0][b1] * (QD_0 * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d1] * (QD_0 * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[b0][d1] * delta[a1][b1] * (QD_0 * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[a1][c0] * delta[b0][b1] * (QD_0 * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][c0] * (QD_0 * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[b0][c0] * delta[a1][b1] * (QD_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d1] * (QD_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][c0] * (QD_0 * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d1] * (QD_0 * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[b0][d1] * delta[a0][b1] * (QD_0 * QC_1 * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][c0] * (QD_0 * QC_1 * (-1.0))
                            + delta[a1][d1] * delta[b0][c0] * delta[a0][b1] * (QD_0 * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[a1][d0] * delta[b0][b1] * (QD_1 * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d0] * (QD_1 * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[b0][d0] * delta[a1][b1] * (QD_1 * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][b1] * (QD_1 * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][c0] * (QD_1 * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][c0] * delta[a1][b1] * (QD_1 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d0] * (QD_1 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][c0] * (QD_1 * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d0] * (QD_1 * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[b0][d0] * delta[a0][b1] * (QD_1 * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][c0] * (QD_1 * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[b0][c0] * delta[a0][b1] * (QD_1 * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[a1][c1] * delta[b0][b1] * (QD_0 * QD_1 * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][c1] * (QD_0 * QD_1 * (-1.0))
                            + delta[a0][c0] * delta[b0][c1] * delta[a1][b1] * (QD_0 * QD_1 * (-1.0))
                            + delta[a0][c1] * delta[a1][c0] * delta[b0][b1] * (QD_0 * QD_1 * (-1.0))
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][c0] * (QD_0 * QD_1 * (-1.0))
                            + delta[a0][c1] * delta[b0][c0] * delta[a1][b1] * (QD_0 * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][c1] * (QD_0 * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][c0] * (QD_0 * QD_1 * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][c1] * (QD_0 * QD_1 * (-1.0))
                            + delta[a1][c0] * delta[b0][c1] * delta[a0][b1] * (QD_0 * QD_1 * (-1.0))
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][c0] * (QD_0 * QD_1 * (-1.0))
                            + delta[a1][c1] * delta[b0][c0] * delta[a0][b1] * (QD_0 * QD_1 * (-1.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD17(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[4];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[3] * (

                        0.125 / ( S4 * S4 * S4 ) * (
                            delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (PQ[a0] * PQ[a1] * (-2.0) + PA_0 * PQ[a1] * 2.0 + PA_1 * PQ[a0] * 2.0)
                            + delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (PQ[a0] * PQ[a1] * (-2.0) + PA_0 * PQ[a1] * 2.0 + PA_1 * PQ[a0] * 2.0)
                            + delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (PQ[a0] * PQ[a1] * (-2.0) + PA_0 * PQ[a1] * 2.0 + PA_1 * PQ[a0] * 2.0)
                            + delta[b0][c0] * delta[b1][c1] * delta[d0][d1] * (PA_0 * PQ[a1] + PA_1 * PQ[a0])
                            + delta[b0][c0] * delta[b1][d0] * delta[c1][d1] * (PA_0 * PQ[a1] + PA_1 * PQ[a0])
                            + delta[b0][c0] * delta[b1][d1] * delta[c1][d0] * (PA_0 * PQ[a1] + PA_1 * PQ[a0])
                            + delta[b0][c1] * delta[b1][c0] * delta[d0][d1] * (PA_0 * PQ[a1] + PA_1 * PQ[a0])
                            + delta[b0][c1] * delta[b1][d0] * delta[c0][d1] * (PA_0 * PQ[a1] + PA_1 * PQ[a0])
                            + delta[b0][c1] * delta[b1][d1] * delta[c0][d0] * (PA_0 * PQ[a1] + PA_1 * PQ[a0])
                            + delta[b0][d0] * delta[b1][c0] * delta[c1][d1] * (PA_0 * PQ[a1] + PA_1 * PQ[a0])
                            + delta[b0][d0] * delta[b1][c1] * delta[c0][d1] * (PA_0 * PQ[a1] + PA_1 * PQ[a0])
                            + delta[b0][d0] * delta[b1][d1] * delta[c0][c1] * (PA_0 * PQ[a1] + PA_1 * PQ[a0])
                            + delta[b0][d1] * delta[b1][c0] * delta[c1][d0] * (PA_0 * PQ[a1] + PA_1 * PQ[a0])
                            + delta[b0][d1] * delta[b1][c1] * delta[c0][d0] * (PA_0 * PQ[a1] + PA_1 * PQ[a0])
                            + delta[b0][d1] * delta[b1][d0] * delta[c0][c1] * (PA_0 * PQ[a1] + PA_1 * PQ[a0])
                            + delta[a1][c0] * delta[b1][c1] * delta[d0][d1] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[a1][c0] * delta[b1][d0] * delta[c1][d1] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[a1][c0] * delta[b1][d1] * delta[c1][d0] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[a1][c1] * delta[b1][c0] * delta[d0][d1] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[a1][c1] * delta[b1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[a1][c1] * delta[b1][d1] * delta[c0][d0] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[a1][d0] * delta[b1][c0] * delta[c1][d1] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[a1][d0] * delta[b1][c1] * delta[c0][d1] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[a1][d0] * delta[b1][d1] * delta[c0][c1] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[a1][d1] * delta[b1][c0] * delta[c1][d0] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[a1][d1] * delta[b1][c1] * delta[c0][d0] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[a1][d1] * delta[b1][d0] * delta[c0][c1] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[a1][b1] * delta[c0][c1] * delta[d0][d1] * (PQ[a0] * PQ[b0] * (-2.0) + PB_0 * PQ[a0] * 2.0 + PA_0 * PQ[b0] * 2.0)
                            + delta[a1][b1] * delta[c0][d0] * delta[c1][d1] * (PQ[a0] * PQ[b0] * (-2.0) + PB_0 * PQ[a0] * 2.0 + PA_0 * PQ[b0] * 2.0)
                            + delta[a1][b1] * delta[c1][d0] * delta[c0][d1] * (PQ[a0] * PQ[b0] * (-2.0) + PB_0 * PQ[a0] * 2.0 + PA_0 * PQ[b0] * 2.0)
                            + delta[a1][c0] * delta[b0][c1] * delta[d0][d1] * (PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[a1][c0] * delta[b0][d0] * delta[c1][d1] * (PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[a1][c0] * delta[b0][d1] * delta[c1][d0] * (PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[a1][c1] * delta[b0][c0] * delta[d0][d1] * (PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[a1][c1] * delta[b0][d0] * delta[c0][d1] * (PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[a1][c1] * delta[b0][d1] * delta[c0][d0] * (PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[a1][d0] * delta[b0][c0] * delta[c1][d1] * (PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[a1][d0] * delta[b0][c1] * delta[c0][d1] * (PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[a1][d0] * delta[b0][d1] * delta[c0][c1] * (PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[a1][d1] * delta[b0][c0] * delta[c1][d0] * (PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[a1][d1] * delta[b0][c1] * delta[c0][d0] * (PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[a1][d1] * delta[b0][d0] * delta[c0][c1] * (PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[a1][b0] * delta[c0][c1] * delta[d0][d1] * (PQ[a0] * PQ[b1] * (-2.0) + PB_1 * PQ[a0] * 2.0 + PA_0 * PQ[b1] * 2.0)
                            + delta[a1][b0] * delta[c0][d0] * delta[c1][d1] * (PQ[a0] * PQ[b1] * (-2.0) + PB_1 * PQ[a0] * 2.0 + PA_0 * PQ[b1] * 2.0)
                            + delta[a1][b0] * delta[c1][d0] * delta[c0][d1] * (PQ[a0] * PQ[b1] * (-2.0) + PB_1 * PQ[a0] * 2.0 + PA_0 * PQ[b1] * 2.0)
                            + delta[a1][c1] * delta[b0][b1] * delta[d0][d1] * (PQ[a0] * PQ[c0] * (-1.0) + PQ[a0] * QC_0 * (-1.0) + PA_0 * PQ[c0] + PA_0 * QC_0)
                            + delta[a1][d0] * delta[b0][b1] * delta[c1][d1] * (PQ[a0] * PQ[c0] * (-1.0) + PQ[a0] * QC_0 * (-1.0) + PA_0 * PQ[c0] + PA_0 * QC_0)
                            + delta[a1][d1] * delta[b0][b1] * delta[c1][d0] * (PQ[a0] * PQ[c0] * (-1.0) + PQ[a0] * QC_0 * (-1.0) + PA_0 * PQ[c0] + PA_0 * QC_0)
                            + delta[a1][b0] * delta[b1][c1] * delta[d0][d1] * (PQ[a0] * PQ[c0] * (-1.0) + PQ[a0] * QC_0 * (-1.0) + PA_0 * PQ[c0] + PA_0 * QC_0)
                            + delta[a1][b0] * delta[b1][d0] * delta[c1][d1] * (PQ[a0] * PQ[c0] * (-1.0) + PQ[a0] * QC_0 * (-1.0) + PA_0 * PQ[c0] + PA_0 * QC_0)
                            + delta[a1][b0] * delta[b1][d1] * delta[c1][d0] * (PQ[a0] * PQ[c0] * (-1.0) + PQ[a0] * QC_0 * (-1.0) + PA_0 * PQ[c0] + PA_0 * QC_0)
                            + delta[b0][c1] * delta[a1][b1] * delta[d0][d1] * (PQ[a0] * PQ[c0] * (-1.0) + PQ[a0] * QC_0 * (-1.0) + PA_0 * PQ[c0] + PA_0 * QC_0)
                            + delta[b0][d0] * delta[a1][b1] * delta[c1][d1] * (PQ[a0] * PQ[c0] * (-1.0) + PQ[a0] * QC_0 * (-1.0) + PA_0 * PQ[c0] + PA_0 * QC_0)
                            + delta[b0][d1] * delta[a1][b1] * delta[c1][d0] * (PQ[a0] * PQ[c0] * (-1.0) + PQ[a0] * QC_0 * (-1.0) + PA_0 * PQ[c0] + PA_0 * QC_0)
                            + delta[a1][c0] * delta[b0][b1] * delta[d0][d1] * (PQ[a0] * PQ[c1] * (-1.0) + PQ[a0] * QC_1 * (-1.0) + PA_0 * PQ[c1] + PA_0 * QC_1)
                            + delta[a1][d0] * delta[b0][b1] * delta[c0][d1] * (PQ[a0] * PQ[c1] * (-1.0) + PQ[a0] * QC_1 * (-1.0) + PA_0 * PQ[c1] + PA_0 * QC_1)
                            + delta[a1][d1] * delta[b0][b1] * delta[c0][d0] * (PQ[a0] * PQ[c1] * (-1.0) + PQ[a0] * QC_1 * (-1.0) + PA_0 * PQ[c1] + PA_0 * QC_1)
                            + delta[a1][b0] * delta[b1][c0] * delta[d0][d1] * (PQ[a0] * PQ[c1] * (-1.0) + PQ[a0] * QC_1 * (-1.0) + PA_0 * PQ[c1] + PA_0 * QC_1)
                            + delta[a1][b0] * delta[b1][d0] * delta[c0][d1] * (PQ[a0] * PQ[c1] * (-1.0) + PQ[a0] * QC_1 * (-1.0) + PA_0 * PQ[c1] + PA_0 * QC_1)
                            + delta[a1][b0] * delta[b1][d1] * delta[c0][d0] * (PQ[a0] * PQ[c1] * (-1.0) + PQ[a0] * QC_1 * (-1.0) + PA_0 * PQ[c1] + PA_0 * QC_1)
                            + delta[b0][c0] * delta[a1][b1] * delta[d0][d1] * (PQ[a0] * PQ[c1] * (-1.0) + PQ[a0] * QC_1 * (-1.0) + PA_0 * PQ[c1] + PA_0 * QC_1)
                            + delta[b0][d0] * delta[a1][b1] * delta[c0][d1] * (PQ[a0] * PQ[c1] * (-1.0) + PQ[a0] * QC_1 * (-1.0) + PA_0 * PQ[c1] + PA_0 * QC_1)
                            + delta[b0][d1] * delta[a1][b1] * delta[c0][d0] * (PQ[a0] * PQ[c1] * (-1.0) + PQ[a0] * QC_1 * (-1.0) + PA_0 * PQ[c1] + PA_0 * QC_1)
                            + delta[a1][c0] * delta[b0][b1] * delta[c1][d1] * (PQ[a0] * PQ[d0] * (-1.0) + PQ[a0] * QD_0 * (-1.0) + PA_0 * PQ[d0] + PA_0 * QD_0)
                            + delta[a1][c1] * delta[b0][b1] * delta[c0][d1] * (PQ[a0] * PQ[d0] * (-1.0) + PQ[a0] * QD_0 * (-1.0) + PA_0 * PQ[d0] + PA_0 * QD_0)
                            + delta[a1][d1] * delta[b0][b1] * delta[c0][c1] * (PQ[a0] * PQ[d0] * (-1.0) + PQ[a0] * QD_0 * (-1.0) + PA_0 * PQ[d0] + PA_0 * QD_0)
                            + delta[a1][b0] * delta[b1][c0] * delta[c1][d1] * (PQ[a0] * PQ[d0] * (-1.0) + PQ[a0] * QD_0 * (-1.0) + PA_0 * PQ[d0] + PA_0 * QD_0)
                            + delta[a1][b0] * delta[b1][c1] * delta[c0][d1] * (PQ[a0] * PQ[d0] * (-1.0) + PQ[a0] * QD_0 * (-1.0) + PA_0 * PQ[d0] + PA_0 * QD_0)
                            + delta[a1][b0] * delta[b1][d1] * delta[c0][c1] * (PQ[a0] * PQ[d0] * (-1.0) + PQ[a0] * QD_0 * (-1.0) + PA_0 * PQ[d0] + PA_0 * QD_0)
                            + delta[b0][c0] * delta[a1][b1] * delta[c1][d1] * (PQ[a0] * PQ[d0] * (-1.0) + PQ[a0] * QD_0 * (-1.0) + PA_0 * PQ[d0] + PA_0 * QD_0)
                            + delta[b0][c1] * delta[a1][b1] * delta[c0][d1] * (PQ[a0] * PQ[d0] * (-1.0) + PQ[a0] * QD_0 * (-1.0) + PA_0 * PQ[d0] + PA_0 * QD_0)
                            + delta[b0][d1] * delta[a1][b1] * delta[c0][c1] * (PQ[a0] * PQ[d0] * (-1.0) + PQ[a0] * QD_0 * (-1.0) + PA_0 * PQ[d0] + PA_0 * QD_0)
                            + delta[a1][c0] * delta[b0][b1] * delta[c1][d0] * (PQ[a0] * PQ[d1] * (-1.0) + PQ[a0] * QD_1 * (-1.0) + PA_0 * PQ[d1] + PA_0 * QD_1)
                            + delta[a1][c1] * delta[b0][b1] * delta[c0][d0] * (PQ[a0] * PQ[d1] * (-1.0) + PQ[a0] * QD_1 * (-1.0) + PA_0 * PQ[d1] + PA_0 * QD_1)
                            + delta[a1][d0] * delta[b0][b1] * delta[c0][c1] * (PQ[a0] * PQ[d1] * (-1.0) + PQ[a0] * QD_1 * (-1.0) + PA_0 * PQ[d1] + PA_0 * QD_1)
                            + delta[a1][b0] * delta[b1][c0] * delta[c1][d0] * (PQ[a0] * PQ[d1] * (-1.0) + PQ[a0] * QD_1 * (-1.0) + PA_0 * PQ[d1] + PA_0 * QD_1)
                            + delta[a1][b0] * delta[b1][c1] * delta[c0][d0] * (PQ[a0] * PQ[d1] * (-1.0) + PQ[a0] * QD_1 * (-1.0) + PA_0 * PQ[d1] + PA_0 * QD_1)
                            + delta[a1][b0] * delta[b1][d0] * delta[c0][c1] * (PQ[a0] * PQ[d1] * (-1.0) + PQ[a0] * QD_1 * (-1.0) + PA_0 * PQ[d1] + PA_0 * QD_1)
                            + delta[b0][c0] * delta[a1][b1] * delta[c1][d0] * (PQ[a0] * PQ[d1] * (-1.0) + PQ[a0] * QD_1 * (-1.0) + PA_0 * PQ[d1] + PA_0 * QD_1)
                            + delta[b0][c1] * delta[a1][b1] * delta[c0][d0] * (PQ[a0] * PQ[d1] * (-1.0) + PQ[a0] * QD_1 * (-1.0) + PA_0 * PQ[d1] + PA_0 * QD_1)
                            + delta[b0][d0] * delta[a1][b1] * delta[c0][c1] * (PQ[a0] * PQ[d1] * (-1.0) + PQ[a0] * QD_1 * (-1.0) + PA_0 * PQ[d1] + PA_0 * QD_1)
                            + delta[a1][c1] * delta[b0][d0] * delta[b1][d1] * (PA_0 * QC_0)
                            + delta[a1][c1] * delta[b0][d1] * delta[b1][d0] * (PA_0 * QC_0)
                            + delta[a1][d0] * delta[b0][c1] * delta[b1][d1] * (PA_0 * QC_0)
                            + delta[a1][d0] * delta[b0][d1] * delta[b1][c1] * (PA_0 * QC_0)
                            + delta[a1][d1] * delta[b0][c1] * delta[b1][d0] * (PA_0 * QC_0)
                            + delta[a1][d1] * delta[b0][d0] * delta[b1][c1] * (PA_0 * QC_0)
                            + delta[a1][c0] * delta[b0][d0] * delta[b1][d1] * (PA_0 * QC_1)
                            + delta[a1][c0] * delta[b0][d1] * delta[b1][d0] * (PA_0 * QC_1)
                            + delta[a1][d0] * delta[b0][c0] * delta[b1][d1] * (PA_0 * QC_1)
                            + delta[a1][d0] * delta[b0][d1] * delta[b1][c0] * (PA_0 * QC_1)
                            + delta[a1][d1] * delta[b0][c0] * delta[b1][d0] * (PA_0 * QC_1)
                            + delta[a1][d1] * delta[b0][d0] * delta[b1][c0] * (PA_0 * QC_1)
                            + delta[a1][c0] * delta[b0][c1] * delta[b1][d1] * (PA_0 * QD_0)
                            + delta[a1][c0] * delta[b0][d1] * delta[b1][c1] * (PA_0 * QD_0)
                            + delta[a1][c1] * delta[b0][c0] * delta[b1][d1] * (PA_0 * QD_0)
                            + delta[a1][c1] * delta[b0][d1] * delta[b1][c0] * (PA_0 * QD_0)
                            + delta[a1][d1] * delta[b0][c0] * delta[b1][c1] * (PA_0 * QD_0)
                            + delta[a1][d1] * delta[b0][c1] * delta[b1][c0] * (PA_0 * QD_0)
                            + delta[a1][c0] * delta[b0][c1] * delta[b1][d0] * (PA_0 * QD_1)
                            + delta[a1][c0] * delta[b0][d0] * delta[b1][c1] * (PA_0 * QD_1)
                            + delta[a1][c1] * delta[b0][c0] * delta[b1][d0] * (PA_0 * QD_1)
                            + delta[a1][c1] * delta[b0][d0] * delta[b1][c0] * (PA_0 * QD_1)
                            + delta[a1][d0] * delta[b0][c0] * delta[b1][c1] * (PA_0 * QD_1)
                            + delta[a1][d0] * delta[b0][c1] * delta[b1][c0] * (PA_0 * QD_1)
                            + delta[a0][c0] * delta[b1][c1] * delta[d0][d1] * (PB_0 * PQ[a1] + PA_1 * PQ[b0])
                            + delta[a0][c0] * delta[b1][d0] * delta[c1][d1] * (PB_0 * PQ[a1] + PA_1 * PQ[b0])
                            + delta[a0][c0] * delta[b1][d1] * delta[c1][d0] * (PB_0 * PQ[a1] + PA_1 * PQ[b0])
                            + delta[a0][c1] * delta[b1][c0] * delta[d0][d1] * (PB_0 * PQ[a1] + PA_1 * PQ[b0])
                            + delta[a0][c1] * delta[b1][d0] * delta[c0][d1] * (PB_0 * PQ[a1] + PA_1 * PQ[b0])
                            + delta[a0][c1] * delta[b1][d1] * delta[c0][d0] * (PB_0 * PQ[a1] + PA_1 * PQ[b0])
                            + delta[a0][d0] * delta[b1][c0] * delta[c1][d1] * (PB_0 * PQ[a1] + PA_1 * PQ[b0])
                            + delta[a0][d0] * delta[b1][c1] * delta[c0][d1] * (PB_0 * PQ[a1] + PA_1 * PQ[b0])
                            + delta[a0][d0] * delta[b1][d1] * delta[c0][c1] * (PB_0 * PQ[a1] + PA_1 * PQ[b0])
                            + delta[a0][d1] * delta[b1][c0] * delta[c1][d0] * (PB_0 * PQ[a1] + PA_1 * PQ[b0])
                            + delta[a0][d1] * delta[b1][c1] * delta[c0][d0] * (PB_0 * PQ[a1] + PA_1 * PQ[b0])
                            + delta[a0][d1] * delta[b1][d0] * delta[c0][c1] * (PB_0 * PQ[a1] + PA_1 * PQ[b0])
                            + delta[a0][b1] * delta[c0][c1] * delta[d0][d1] * (PQ[a1] * PQ[b0] * (-2.0) + PB_0 * PQ[a1] * 2.0 + PA_1 * PQ[b0] * 2.0)
                            + delta[a0][b1] * delta[c0][d0] * delta[c1][d1] * (PQ[a1] * PQ[b0] * (-2.0) + PB_0 * PQ[a1] * 2.0 + PA_1 * PQ[b0] * 2.0)
                            + delta[a0][b1] * delta[c1][d0] * delta[c0][d1] * (PQ[a1] * PQ[b0] * (-2.0) + PB_0 * PQ[a1] * 2.0 + PA_1 * PQ[b0] * 2.0)
                            + delta[a0][c0] * delta[b0][c1] * delta[d0][d1] * (PB_1 * PQ[a1] + PA_1 * PQ[b1])
                            + delta[a0][c0] * delta[b0][d0] * delta[c1][d1] * (PB_1 * PQ[a1] + PA_1 * PQ[b1])
                            + delta[a0][c0] * delta[b0][d1] * delta[c1][d0] * (PB_1 * PQ[a1] + PA_1 * PQ[b1])
                            + delta[a0][c1] * delta[b0][c0] * delta[d0][d1] * (PB_1 * PQ[a1] + PA_1 * PQ[b1])
                            + delta[a0][c1] * delta[b0][d0] * delta[c0][d1] * (PB_1 * PQ[a1] + PA_1 * PQ[b1])
                            + delta[a0][c1] * delta[b0][d1] * delta[c0][d0] * (PB_1 * PQ[a1] + PA_1 * PQ[b1])
                            + delta[a0][d0] * delta[b0][c0] * delta[c1][d1] * (PB_1 * PQ[a1] + PA_1 * PQ[b1])
                            + delta[a0][d0] * delta[b0][c1] * delta[c0][d1] * (PB_1 * PQ[a1] + PA_1 * PQ[b1])
                            + delta[a0][d0] * delta[b0][d1] * delta[c0][c1] * (PB_1 * PQ[a1] + PA_1 * PQ[b1])
                            + delta[a0][d1] * delta[b0][c0] * delta[c1][d0] * (PB_1 * PQ[a1] + PA_1 * PQ[b1])
                            + delta[a0][d1] * delta[b0][c1] * delta[c0][d0] * (PB_1 * PQ[a1] + PA_1 * PQ[b1])
                            + delta[a0][d1] * delta[b0][d0] * delta[c0][c1] * (PB_1 * PQ[a1] + PA_1 * PQ[b1])
                            + delta[a0][b0] * delta[c0][c1] * delta[d0][d1] * (PQ[a1] * PQ[b1] * (-2.0) + PB_1 * PQ[a1] * 2.0 + PA_1 * PQ[b1] * 2.0)
                            + delta[a0][b0] * delta[c0][d0] * delta[c1][d1] * (PQ[a1] * PQ[b1] * (-2.0) + PB_1 * PQ[a1] * 2.0 + PA_1 * PQ[b1] * 2.0)
                            + delta[a0][b0] * delta[c1][d0] * delta[c0][d1] * (PQ[a1] * PQ[b1] * (-2.0) + PB_1 * PQ[a1] * 2.0 + PA_1 * PQ[b1] * 2.0)
                            + delta[a0][c1] * delta[b0][b1] * delta[d0][d1] * (PQ[a1] * PQ[c0] * (-1.0) + PQ[a1] * QC_0 * (-1.0) + PA_1 * PQ[c0] + PA_1 * QC_0)
                            + delta[a0][d0] * delta[b0][b1] * delta[c1][d1] * (PQ[a1] * PQ[c0] * (-1.0) + PQ[a1] * QC_0 * (-1.0) + PA_1 * PQ[c0] + PA_1 * QC_0)
                            + delta[a0][d1] * delta[b0][b1] * delta[c1][d0] * (PQ[a1] * PQ[c0] * (-1.0) + PQ[a1] * QC_0 * (-1.0) + PA_1 * PQ[c0] + PA_1 * QC_0)
                            + delta[a0][b0] * delta[b1][c1] * delta[d0][d1] * (PQ[a1] * PQ[c0] * (-1.0) + PQ[a1] * QC_0 * (-1.0) + PA_1 * PQ[c0] + PA_1 * QC_0)
                            + delta[a0][b0] * delta[b1][d0] * delta[c1][d1] * (PQ[a1] * PQ[c0] * (-1.0) + PQ[a1] * QC_0 * (-1.0) + PA_1 * PQ[c0] + PA_1 * QC_0)
                            + delta[a0][b0] * delta[b1][d1] * delta[c1][d0] * (PQ[a1] * PQ[c0] * (-1.0) + PQ[a1] * QC_0 * (-1.0) + PA_1 * PQ[c0] + PA_1 * QC_0)
                            + delta[b0][c1] * delta[a0][b1] * delta[d0][d1] * (PQ[a1] * PQ[c0] * (-1.0) + PQ[a1] * QC_0 * (-1.0) + PA_1 * PQ[c0] + PA_1 * QC_0)
                            + delta[b0][d0] * delta[a0][b1] * delta[c1][d1] * (PQ[a1] * PQ[c0] * (-1.0) + PQ[a1] * QC_0 * (-1.0) + PA_1 * PQ[c0] + PA_1 * QC_0)
                            + delta[b0][d1] * delta[a0][b1] * delta[c1][d0] * (PQ[a1] * PQ[c0] * (-1.0) + PQ[a1] * QC_0 * (-1.0) + PA_1 * PQ[c0] + PA_1 * QC_0)
                            + delta[a0][c0] * delta[b0][b1] * delta[d0][d1] * (PQ[a1] * PQ[c1] * (-1.0) + PQ[a1] * QC_1 * (-1.0) + PA_1 * PQ[c1] + PA_1 * QC_1)
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][d1] * (PQ[a1] * PQ[c1] * (-1.0) + PQ[a1] * QC_1 * (-1.0) + PA_1 * PQ[c1] + PA_1 * QC_1)
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][d0] * (PQ[a1] * PQ[c1] * (-1.0) + PQ[a1] * QC_1 * (-1.0) + PA_1 * PQ[c1] + PA_1 * QC_1)
                            + delta[a0][b0] * delta[b1][c0] * delta[d0][d1] * (PQ[a1] * PQ[c1] * (-1.0) + PQ[a1] * QC_1 * (-1.0) + PA_1 * PQ[c1] + PA_1 * QC_1)
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][d1] * (PQ[a1] * PQ[c1] * (-1.0) + PQ[a1] * QC_1 * (-1.0) + PA_1 * PQ[c1] + PA_1 * QC_1)
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][d0] * (PQ[a1] * PQ[c1] * (-1.0) + PQ[a1] * QC_1 * (-1.0) + PA_1 * PQ[c1] + PA_1 * QC_1)
                            + delta[b0][c0] * delta[a0][b1] * delta[d0][d1] * (PQ[a1] * PQ[c1] * (-1.0) + PQ[a1] * QC_1 * (-1.0) + PA_1 * PQ[c1] + PA_1 * QC_1)
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][d1] * (PQ[a1] * PQ[c1] * (-1.0) + PQ[a1] * QC_1 * (-1.0) + PA_1 * PQ[c1] + PA_1 * QC_1)
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][d0] * (PQ[a1] * PQ[c1] * (-1.0) + PQ[a1] * QC_1 * (-1.0) + PA_1 * PQ[c1] + PA_1 * QC_1)
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d1] * (PQ[a1] * PQ[d0] * (-1.0) + PQ[a1] * QD_0 * (-1.0) + PA_1 * PQ[d0] + PA_1 * QD_0)
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d1] * (PQ[a1] * PQ[d0] * (-1.0) + PQ[a1] * QD_0 * (-1.0) + PA_1 * PQ[d0] + PA_1 * QD_0)
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][c1] * (PQ[a1] * PQ[d0] * (-1.0) + PQ[a1] * QD_0 * (-1.0) + PA_1 * PQ[d0] + PA_1 * QD_0)
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d1] * (PQ[a1] * PQ[d0] * (-1.0) + PQ[a1] * QD_0 * (-1.0) + PA_1 * PQ[d0] + PA_1 * QD_0)
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d1] * (PQ[a1] * PQ[d0] * (-1.0) + PQ[a1] * QD_0 * (-1.0) + PA_1 * PQ[d0] + PA_1 * QD_0)
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][c1] * (PQ[a1] * PQ[d0] * (-1.0) + PQ[a1] * QD_0 * (-1.0) + PA_1 * PQ[d0] + PA_1 * QD_0)
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d1] * (PQ[a1] * PQ[d0] * (-1.0) + PQ[a1] * QD_0 * (-1.0) + PA_1 * PQ[d0] + PA_1 * QD_0)
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d1] * (PQ[a1] * PQ[d0] * (-1.0) + PQ[a1] * QD_0 * (-1.0) + PA_1 * PQ[d0] + PA_1 * QD_0)
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][c1] * (PQ[a1] * PQ[d0] * (-1.0) + PQ[a1] * QD_0 * (-1.0) + PA_1 * PQ[d0] + PA_1 * QD_0)
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d0] * (PQ[a1] * PQ[d1] * (-1.0) + PQ[a1] * QD_1 * (-1.0) + PA_1 * PQ[d1] + PA_1 * QD_1)
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d0] * (PQ[a1] * PQ[d1] * (-1.0) + PQ[a1] * QD_1 * (-1.0) + PA_1 * PQ[d1] + PA_1 * QD_1)
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][c1] * (PQ[a1] * PQ[d1] * (-1.0) + PQ[a1] * QD_1 * (-1.0) + PA_1 * PQ[d1] + PA_1 * QD_1)
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d0] * (PQ[a1] * PQ[d1] * (-1.0) + PQ[a1] * QD_1 * (-1.0) + PA_1 * PQ[d1] + PA_1 * QD_1)
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d0] * (PQ[a1] * PQ[d1] * (-1.0) + PQ[a1] * QD_1 * (-1.0) + PA_1 * PQ[d1] + PA_1 * QD_1)
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][c1] * (PQ[a1] * PQ[d1] * (-1.0) + PQ[a1] * QD_1 * (-1.0) + PA_1 * PQ[d1] + PA_1 * QD_1)
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d0] * (PQ[a1] * PQ[d1] * (-1.0) + PQ[a1] * QD_1 * (-1.0) + PA_1 * PQ[d1] + PA_1 * QD_1)
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d0] * (PQ[a1] * PQ[d1] * (-1.0) + PQ[a1] * QD_1 * (-1.0) + PA_1 * PQ[d1] + PA_1 * QD_1)
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][c1] * (PQ[a1] * PQ[d1] * (-1.0) + PQ[a1] * QD_1 * (-1.0) + PA_1 * PQ[d1] + PA_1 * QD_1)
                            + delta[a0][c1] * delta[b0][d0] * delta[b1][d1] * (PA_1 * QC_0)
                            + delta[a0][c1] * delta[b0][d1] * delta[b1][d0] * (PA_1 * QC_0)
                            + delta[a0][d0] * delta[b0][c1] * delta[b1][d1] * (PA_1 * QC_0)
                            + delta[a0][d0] * delta[b0][d1] * delta[b1][c1] * (PA_1 * QC_0)
                            + delta[a0][d1] * delta[b0][c1] * delta[b1][d0] * (PA_1 * QC_0)
                            + delta[a0][d1] * delta[b0][d0] * delta[b1][c1] * (PA_1 * QC_0)
                            + delta[a0][c0] * delta[b0][d0] * delta[b1][d1] * (PA_1 * QC_1)
                            + delta[a0][c0] * delta[b0][d1] * delta[b1][d0] * (PA_1 * QC_1)
                            + delta[a0][d0] * delta[b0][c0] * delta[b1][d1] * (PA_1 * QC_1)
                            + delta[a0][d0] * delta[b0][d1] * delta[b1][c0] * (PA_1 * QC_1)
                            + delta[a0][d1] * delta[b0][c0] * delta[b1][d0] * (PA_1 * QC_1)
                            + delta[a0][d1] * delta[b0][d0] * delta[b1][c0] * (PA_1 * QC_1)
                            + delta[a0][c0] * delta[b0][c1] * delta[b1][d1] * (PA_1 * QD_0)
                            + delta[a0][c0] * delta[b0][d1] * delta[b1][c1] * (PA_1 * QD_0)
                            + delta[a0][c1] * delta[b0][c0] * delta[b1][d1] * (PA_1 * QD_0)
                            + delta[a0][c1] * delta[b0][d1] * delta[b1][c0] * (PA_1 * QD_0)
                            + delta[a0][d1] * delta[b0][c0] * delta[b1][c1] * (PA_1 * QD_0)
                            + delta[a0][d1] * delta[b0][c1] * delta[b1][c0] * (PA_1 * QD_0)
                            + delta[a0][c0] * delta[b0][c1] * delta[b1][d0] * (PA_1 * QD_1)
                            + delta[a0][c0] * delta[b0][d0] * delta[b1][c1] * (PA_1 * QD_1)
                            + delta[a0][c1] * delta[b0][c0] * delta[b1][d0] * (PA_1 * QD_1)
                            + delta[a0][c1] * delta[b0][d0] * delta[b1][c0] * (PA_1 * QD_1)
                            + delta[a0][d0] * delta[b0][c0] * delta[b1][c1] * (PA_1 * QD_1)
                            + delta[a0][d0] * delta[b0][c1] * delta[b1][c0] * (PA_1 * QD_1)
                            + delta[a0][c1] * delta[a1][d0] * delta[b1][d1] * (PB_0 * QC_0)
                            + delta[a0][c1] * delta[a1][d1] * delta[b1][d0] * (PB_0 * QC_0)
                            + delta[a0][c1] * delta[a1][b1] * delta[d0][d1] * (PQ[b0] * PQ[c0] * (-1.0) + PQ[b0] * QC_0 * (-1.0) + PB_0 * PQ[c0] + PB_0 * QC_0)
                            + delta[a0][d0] * delta[a1][c1] * delta[b1][d1] * (PB_0 * QC_0)
                            + delta[a0][d0] * delta[a1][d1] * delta[b1][c1] * (PB_0 * QC_0)
                            + delta[a0][d0] * delta[a1][b1] * delta[c1][d1] * (PQ[b0] * PQ[c0] * (-1.0) + PQ[b0] * QC_0 * (-1.0) + PB_0 * PQ[c0] + PB_0 * QC_0)
                            + delta[a0][d1] * delta[a1][c1] * delta[b1][d0] * (PB_0 * QC_0)
                            + delta[a0][d1] * delta[a1][d0] * delta[b1][c1] * (PB_0 * QC_0)
                            + delta[a0][d1] * delta[a1][b1] * delta[c1][d0] * (PQ[b0] * PQ[c0] * (-1.0) + PQ[b0] * QC_0 * (-1.0) + PB_0 * PQ[c0] + PB_0 * QC_0)
                            + delta[a0][a1] * delta[b1][c1] * delta[d0][d1] * (PQ[b0] * PQ[c0] * (-1.0) + PQ[b0] * QC_0 * (-1.0) + PB_0 * PQ[c0] + PB_0 * QC_0)
                            + delta[a0][a1] * delta[b1][d0] * delta[c1][d1] * (PQ[b0] * PQ[c0] * (-1.0) + PQ[b0] * QC_0 * (-1.0) + PB_0 * PQ[c0] + PB_0 * QC_0)
                            + delta[a0][a1] * delta[b1][d1] * delta[c1][d0] * (PQ[b0] * PQ[c0] * (-1.0) + PQ[b0] * QC_0 * (-1.0) + PB_0 * PQ[c0] + PB_0 * QC_0)
                            + delta[a1][c1] * delta[a0][b1] * delta[d0][d1] * (PQ[b0] * PQ[c0] * (-1.0) + PQ[b0] * QC_0 * (-1.0) + PB_0 * PQ[c0] + PB_0 * QC_0)
                            + delta[a1][d0] * delta[a0][b1] * delta[c1][d1] * (PQ[b0] * PQ[c0] * (-1.0) + PQ[b0] * QC_0 * (-1.0) + PB_0 * PQ[c0] + PB_0 * QC_0)
                            + delta[a1][d1] * delta[a0][b1] * delta[c1][d0] * (PQ[b0] * PQ[c0] * (-1.0) + PQ[b0] * QC_0 * (-1.0) + PB_0 * PQ[c0] + PB_0 * QC_0)
                            + delta[a0][c0] * delta[a1][d0] * delta[b1][d1] * (PB_0 * QC_1)
                            + delta[a0][c0] * delta[a1][d1] * delta[b1][d0] * (PB_0 * QC_1)
                            + delta[a0][c0] * delta[a1][b1] * delta[d0][d1] * (PQ[b0] * PQ[c1] * (-1.0) + PQ[b0] * QC_1 * (-1.0) + PB_0 * PQ[c1] + PB_0 * QC_1)
                            + delta[a0][d0] * delta[a1][c0] * delta[b1][d1] * (PB_0 * QC_1)
                            + delta[a0][d0] * delta[a1][d1] * delta[b1][c0] * (PB_0 * QC_1)
                            + delta[a0][d0] * delta[a1][b1] * delta[c0][d1] * (PQ[b0] * PQ[c1] * (-1.0) + PQ[b0] * QC_1 * (-1.0) + PB_0 * PQ[c1] + PB_0 * QC_1)
                            + delta[a0][d1] * delta[a1][c0] * delta[b1][d0] * (PB_0 * QC_1)
                            + delta[a0][d1] * delta[a1][d0] * delta[b1][c0] * (PB_0 * QC_1)
                            + delta[a0][d1] * delta[a1][b1] * delta[c0][d0] * (PQ[b0] * PQ[c1] * (-1.0) + PQ[b0] * QC_1 * (-1.0) + PB_0 * PQ[c1] + PB_0 * QC_1)
                            + delta[a0][a1] * delta[b1][c0] * delta[d0][d1] * (PQ[b0] * PQ[c1] * (-1.0) + PQ[b0] * QC_1 * (-1.0) + PB_0 * PQ[c1] + PB_0 * QC_1)
                            + delta[a0][a1] * delta[b1][d0] * delta[c0][d1] * (PQ[b0] * PQ[c1] * (-1.0) + PQ[b0] * QC_1 * (-1.0) + PB_0 * PQ[c1] + PB_0 * QC_1)
                            + delta[a0][a1] * delta[b1][d1] * delta[c0][d0] * (PQ[b0] * PQ[c1] * (-1.0) + PQ[b0] * QC_1 * (-1.0) + PB_0 * PQ[c1] + PB_0 * QC_1)
                            + delta[a1][c0] * delta[a0][b1] * delta[d0][d1] * (PQ[b0] * PQ[c1] * (-1.0) + PQ[b0] * QC_1 * (-1.0) + PB_0 * PQ[c1] + PB_0 * QC_1)
                            + delta[a1][d0] * delta[a0][b1] * delta[c0][d1] * (PQ[b0] * PQ[c1] * (-1.0) + PQ[b0] * QC_1 * (-1.0) + PB_0 * PQ[c1] + PB_0 * QC_1)
                            + delta[a1][d1] * delta[a0][b1] * delta[c0][d0] * (PQ[b0] * PQ[c1] * (-1.0) + PQ[b0] * QC_1 * (-1.0) + PB_0 * PQ[c1] + PB_0 * QC_1)
                            + delta[a0][c1] * delta[a1][d0] * delta[b0][d1] * (PB_1 * QC_0)
                            + delta[a0][c1] * delta[a1][d1] * delta[b0][d0] * (PB_1 * QC_0)
                            + delta[a0][c1] * delta[a1][b0] * delta[d0][d1] * (PQ[b1] * PQ[c0] * (-1.0) + PQ[b1] * QC_0 * (-1.0) + PB_1 * PQ[c0] + PB_1 * QC_0)
                            + delta[a0][d0] * delta[a1][c1] * delta[b0][d1] * (PB_1 * QC_0)
                            + delta[a0][d0] * delta[a1][d1] * delta[b0][c1] * (PB_1 * QC_0)
                            + delta[a0][d0] * delta[a1][b0] * delta[c1][d1] * (PQ[b1] * PQ[c0] * (-1.0) + PQ[b1] * QC_0 * (-1.0) + PB_1 * PQ[c0] + PB_1 * QC_0)
                            + delta[a0][d1] * delta[a1][c1] * delta[b0][d0] * (PB_1 * QC_0)
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][c1] * (PB_1 * QC_0)
                            + delta[a0][d1] * delta[a1][b0] * delta[c1][d0] * (PQ[b1] * PQ[c0] * (-1.0) + PQ[b1] * QC_0 * (-1.0) + PB_1 * PQ[c0] + PB_1 * QC_0)
                            + delta[a0][a1] * delta[b0][c1] * delta[d0][d1] * (PQ[b1] * PQ[c0] * (-1.0) + PQ[b1] * QC_0 * (-1.0) + PB_1 * PQ[c0] + PB_1 * QC_0)
                            + delta[a0][a1] * delta[b0][d0] * delta[c1][d1] * (PQ[b1] * PQ[c0] * (-1.0) + PQ[b1] * QC_0 * (-1.0) + PB_1 * PQ[c0] + PB_1 * QC_0)
                            + delta[a0][a1] * delta[b0][d1] * delta[c1][d0] * (PQ[b1] * PQ[c0] * (-1.0) + PQ[b1] * QC_0 * (-1.0) + PB_1 * PQ[c0] + PB_1 * QC_0)
                            + delta[a1][c1] * delta[a0][b0] * delta[d0][d1] * (PQ[b1] * PQ[c0] * (-1.0) + PQ[b1] * QC_0 * (-1.0) + PB_1 * PQ[c0] + PB_1 * QC_0)
                            + delta[a1][d0] * delta[a0][b0] * delta[c1][d1] * (PQ[b1] * PQ[c0] * (-1.0) + PQ[b1] * QC_0 * (-1.0) + PB_1 * PQ[c0] + PB_1 * QC_0)
                            + delta[a1][d1] * delta[a0][b0] * delta[c1][d0] * (PQ[b1] * PQ[c0] * (-1.0) + PQ[b1] * QC_0 * (-1.0) + PB_1 * PQ[c0] + PB_1 * QC_0)
                            + delta[a0][c0] * delta[a1][d0] * delta[b0][d1] * (PB_1 * QC_1)
                            + delta[a0][c0] * delta[a1][d1] * delta[b0][d0] * (PB_1 * QC_1)
                            + delta[a0][c0] * delta[a1][b0] * delta[d0][d1] * (PQ[b1] * PQ[c1] * (-1.0) + PQ[b1] * QC_1 * (-1.0) + PB_1 * PQ[c1] + PB_1 * QC_1)
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][d1] * (PB_1 * QC_1)
                            + delta[a0][d0] * delta[a1][d1] * delta[b0][c0] * (PB_1 * QC_1)
                            + delta[a0][d0] * delta[a1][b0] * delta[c0][d1] * (PQ[b1] * PQ[c1] * (-1.0) + PQ[b1] * QC_1 * (-1.0) + PB_1 * PQ[c1] + PB_1 * QC_1)
                            + delta[a0][d1] * delta[a1][c0] * delta[b0][d0] * (PB_1 * QC_1)
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][c0] * (PB_1 * QC_1)
                            + delta[a0][d1] * delta[a1][b0] * delta[c0][d0] * (PQ[b1] * PQ[c1] * (-1.0) + PQ[b1] * QC_1 * (-1.0) + PB_1 * PQ[c1] + PB_1 * QC_1)
                            + delta[a0][a1] * delta[b0][c0] * delta[d0][d1] * (PQ[b1] * PQ[c1] * (-1.0) + PQ[b1] * QC_1 * (-1.0) + PB_1 * PQ[c1] + PB_1 * QC_1)
                            + delta[a0][a1] * delta[b0][d0] * delta[c0][d1] * (PQ[b1] * PQ[c1] * (-1.0) + PQ[b1] * QC_1 * (-1.0) + PB_1 * PQ[c1] + PB_1 * QC_1)
                            + delta[a0][a1] * delta[b0][d1] * delta[c0][d0] * (PQ[b1] * PQ[c1] * (-1.0) + PQ[b1] * QC_1 * (-1.0) + PB_1 * PQ[c1] + PB_1 * QC_1)
                            + delta[a1][c0] * delta[a0][b0] * delta[d0][d1] * (PQ[b1] * PQ[c1] * (-1.0) + PQ[b1] * QC_1 * (-1.0) + PB_1 * PQ[c1] + PB_1 * QC_1)
                            + delta[a1][d0] * delta[a0][b0] * delta[c0][d1] * (PQ[b1] * PQ[c1] * (-1.0) + PQ[b1] * QC_1 * (-1.0) + PB_1 * PQ[c1] + PB_1 * QC_1)
                            + delta[a1][d1] * delta[a0][b0] * delta[c0][d0] * (PQ[b1] * PQ[c1] * (-1.0) + PQ[b1] * QC_1 * (-1.0) + PB_1 * PQ[c1] + PB_1 * QC_1)
                            + delta[a0][a1] * delta[c0][c1] * delta[d0][d1] * (PQ[b0] * PQ[b1] * (-2.0) + PB_0 * PQ[b1] * 2.0 + PB_1 * PQ[b0] * 2.0)
                            + delta[a0][a1] * delta[c0][d0] * delta[c1][d1] * (PQ[b0] * PQ[b1] * (-2.0) + PB_0 * PQ[b1] * 2.0 + PB_1 * PQ[b0] * 2.0)
                            + delta[a0][a1] * delta[c1][d0] * delta[c0][d1] * (PQ[b0] * PQ[b1] * (-2.0) + PB_0 * PQ[b1] * 2.0 + PB_1 * PQ[b0] * 2.0)
                            + delta[a0][c0] * delta[a1][b1] * delta[c1][d1] * (PQ[b0] * PQ[d0] * (-1.0) + PQ[b0] * QD_0 * (-1.0) + PB_0 * PQ[d0] + PB_0 * QD_0)
                            + delta[a0][c1] * delta[a1][b1] * delta[c0][d1] * (PQ[b0] * PQ[d0] * (-1.0) + PQ[b0] * QD_0 * (-1.0) + PB_0 * PQ[d0] + PB_0 * QD_0)
                            + delta[a0][d1] * delta[a1][b1] * delta[c0][c1] * (PQ[b0] * PQ[d0] * (-1.0) + PQ[b0] * QD_0 * (-1.0) + PB_0 * PQ[d0] + PB_0 * QD_0)
                            + delta[a0][a1] * delta[b1][c0] * delta[c1][d1] * (PQ[b0] * PQ[d0] * (-1.0) + PQ[b0] * QD_0 * (-1.0) + PB_0 * PQ[d0] + PB_0 * QD_0)
                            + delta[a0][a1] * delta[b1][c1] * delta[c0][d1] * (PQ[b0] * PQ[d0] * (-1.0) + PQ[b0] * QD_0 * (-1.0) + PB_0 * PQ[d0] + PB_0 * QD_0)
                            + delta[a0][a1] * delta[b1][d1] * delta[c0][c1] * (PQ[b0] * PQ[d0] * (-1.0) + PQ[b0] * QD_0 * (-1.0) + PB_0 * PQ[d0] + PB_0 * QD_0)
                            + delta[a1][c0] * delta[a0][b1] * delta[c1][d1] * (PQ[b0] * PQ[d0] * (-1.0) + PQ[b0] * QD_0 * (-1.0) + PB_0 * PQ[d0] + PB_0 * QD_0)
                            + delta[a1][c1] * delta[a0][b1] * delta[c0][d1] * (PQ[b0] * PQ[d0] * (-1.0) + PQ[b0] * QD_0 * (-1.0) + PB_0 * PQ[d0] + PB_0 * QD_0)
                            + delta[a1][d1] * delta[a0][b1] * delta[c0][c1] * (PQ[b0] * PQ[d0] * (-1.0) + PQ[b0] * QD_0 * (-1.0) + PB_0 * PQ[d0] + PB_0 * QD_0)
                            + delta[a0][c0] * delta[a1][b1] * delta[c1][d0] * (PQ[b0] * PQ[d1] * (-1.0) + PQ[b0] * QD_1 * (-1.0) + PB_0 * PQ[d1] + PB_0 * QD_1)
                            + delta[a0][c1] * delta[a1][b1] * delta[c0][d0] * (PQ[b0] * PQ[d1] * (-1.0) + PQ[b0] * QD_1 * (-1.0) + PB_0 * PQ[d1] + PB_0 * QD_1)
                            + delta[a0][d0] * delta[a1][b1] * delta[c0][c1] * (PQ[b0] * PQ[d1] * (-1.0) + PQ[b0] * QD_1 * (-1.0) + PB_0 * PQ[d1] + PB_0 * QD_1)
                            + delta[a0][a1] * delta[b1][c0] * delta[c1][d0] * (PQ[b0] * PQ[d1] * (-1.0) + PQ[b0] * QD_1 * (-1.0) + PB_0 * PQ[d1] + PB_0 * QD_1)
                            + delta[a0][a1] * delta[b1][c1] * delta[c0][d0] * (PQ[b0] * PQ[d1] * (-1.0) + PQ[b0] * QD_1 * (-1.0) + PB_0 * PQ[d1] + PB_0 * QD_1)
                            + delta[a0][a1] * delta[b1][d0] * delta[c0][c1] * (PQ[b0] * PQ[d1] * (-1.0) + PQ[b0] * QD_1 * (-1.0) + PB_0 * PQ[d1] + PB_0 * QD_1)
                            + delta[a1][c0] * delta[a0][b1] * delta[c1][d0] * (PQ[b0] * PQ[d1] * (-1.0) + PQ[b0] * QD_1 * (-1.0) + PB_0 * PQ[d1] + PB_0 * QD_1)
                            + delta[a1][c1] * delta[a0][b1] * delta[c0][d0] * (PQ[b0] * PQ[d1] * (-1.0) + PQ[b0] * QD_1 * (-1.0) + PB_0 * PQ[d1] + PB_0 * QD_1)
                            + delta[a1][d0] * delta[a0][b1] * delta[c0][c1] * (PQ[b0] * PQ[d1] * (-1.0) + PQ[b0] * QD_1 * (-1.0) + PB_0 * PQ[d1] + PB_0 * QD_1)
                            + delta[a0][c0] * delta[a1][b0] * delta[c1][d1] * (PQ[b1] * PQ[d0] * (-1.0) + PQ[b1] * QD_0 * (-1.0) + PB_1 * PQ[d0] + PB_1 * QD_0)
                            + delta[a0][c1] * delta[a1][b0] * delta[c0][d1] * (PQ[b1] * PQ[d0] * (-1.0) + PQ[b1] * QD_0 * (-1.0) + PB_1 * PQ[d0] + PB_1 * QD_0)
                            + delta[a0][d1] * delta[a1][b0] * delta[c0][c1] * (PQ[b1] * PQ[d0] * (-1.0) + PQ[b1] * QD_0 * (-1.0) + PB_1 * PQ[d0] + PB_1 * QD_0)
                            + delta[a0][a1] * delta[b0][c0] * delta[c1][d1] * (PQ[b1] * PQ[d0] * (-1.0) + PQ[b1] * QD_0 * (-1.0) + PB_1 * PQ[d0] + PB_1 * QD_0)
                            + delta[a0][a1] * delta[b0][c1] * delta[c0][d1] * (PQ[b1] * PQ[d0] * (-1.0) + PQ[b1] * QD_0 * (-1.0) + PB_1 * PQ[d0] + PB_1 * QD_0)
                            + delta[a0][a1] * delta[b0][d1] * delta[c0][c1] * (PQ[b1] * PQ[d0] * (-1.0) + PQ[b1] * QD_0 * (-1.0) + PB_1 * PQ[d0] + PB_1 * QD_0)
                            + delta[a1][c0] * delta[a0][b0] * delta[c1][d1] * (PQ[b1] * PQ[d0] * (-1.0) + PQ[b1] * QD_0 * (-1.0) + PB_1 * PQ[d0] + PB_1 * QD_0)
                            + delta[a1][c1] * delta[a0][b0] * delta[c0][d1] * (PQ[b1] * PQ[d0] * (-1.0) + PQ[b1] * QD_0 * (-1.0) + PB_1 * PQ[d0] + PB_1 * QD_0)
                            + delta[a1][d1] * delta[a0][b0] * delta[c0][c1] * (PQ[b1] * PQ[d0] * (-1.0) + PQ[b1] * QD_0 * (-1.0) + PB_1 * PQ[d0] + PB_1 * QD_0)
                            + delta[a0][c0] * delta[a1][b0] * delta[c1][d0] * (PQ[b1] * PQ[d1] * (-1.0) + PQ[b1] * QD_1 * (-1.0) + PB_1 * PQ[d1] + PB_1 * QD_1)
                            + delta[a0][c1] * delta[a1][b0] * delta[c0][d0] * (PQ[b1] * PQ[d1] * (-1.0) + PQ[b1] * QD_1 * (-1.0) + PB_1 * PQ[d1] + PB_1 * QD_1)
                            + delta[a0][d0] * delta[a1][b0] * delta[c0][c1] * (PQ[b1] * PQ[d1] * (-1.0) + PQ[b1] * QD_1 * (-1.0) + PB_1 * PQ[d1] + PB_1 * QD_1)
                            + delta[a0][a1] * delta[b0][c0] * delta[c1][d0] * (PQ[b1] * PQ[d1] * (-1.0) + PQ[b1] * QD_1 * (-1.0) + PB_1 * PQ[d1] + PB_1 * QD_1)
                            + delta[a0][a1] * delta[b0][c1] * delta[c0][d0] * (PQ[b1] * PQ[d1] * (-1.0) + PQ[b1] * QD_1 * (-1.0) + PB_1 * PQ[d1] + PB_1 * QD_1)
                            + delta[a0][a1] * delta[b0][d0] * delta[c0][c1] * (PQ[b1] * PQ[d1] * (-1.0) + PQ[b1] * QD_1 * (-1.0) + PB_1 * PQ[d1] + PB_1 * QD_1)
                            + delta[a1][c0] * delta[a0][b0] * delta[c1][d0] * (PQ[b1] * PQ[d1] * (-1.0) + PQ[b1] * QD_1 * (-1.0) + PB_1 * PQ[d1] + PB_1 * QD_1)
                            + delta[a1][c1] * delta[a0][b0] * delta[c0][d0] * (PQ[b1] * PQ[d1] * (-1.0) + PQ[b1] * QD_1 * (-1.0) + PB_1 * PQ[d1] + PB_1 * QD_1)
                            + delta[a1][d0] * delta[a0][b0] * delta[c0][c1] * (PQ[b1] * PQ[d1] * (-1.0) + PQ[b1] * QD_1 * (-1.0) + PB_1 * PQ[d1] + PB_1 * QD_1)
                            + delta[a0][a1] * delta[b0][b1] * delta[d0][d1] * (PQ[c0] * PQ[c1] * (-2.0) + PQ[c0] * QC_1 * (-2.0) + PQ[c1] * QC_0 * (-2.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[d0][d1] * (PQ[c0] * PQ[c1] * (-2.0) + PQ[c0] * QC_1 * (-2.0) + PQ[c1] * QC_0 * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[d0][d1] * (PQ[c0] * PQ[c1] * (-2.0) + PQ[c0] * QC_1 * (-2.0) + PQ[c1] * QC_0 * (-2.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d1] * (PQ[c0] * PQ[d0] * (-2.0) + PQ[c0] * QD_0 * (-2.0) + PQ[d0] * QC_0 * (-2.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d1] * (PQ[c0] * PQ[d0] * (-2.0) + PQ[c0] * QD_0 * (-2.0) + PQ[d0] * QC_0 * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d1] * (PQ[c0] * PQ[d0] * (-2.0) + PQ[c0] * QD_0 * (-2.0) + PQ[d0] * QC_0 * (-2.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d0] * (PQ[c0] * PQ[d1] * (-2.0) + PQ[c0] * QD_1 * (-2.0) + PQ[d1] * QC_0 * (-2.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d0] * (PQ[c0] * PQ[d1] * (-2.0) + PQ[c0] * QD_1 * (-2.0) + PQ[d1] * QC_0 * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d0] * (PQ[c0] * PQ[d1] * (-2.0) + PQ[c0] * QD_1 * (-2.0) + PQ[d1] * QC_0 * (-2.0))
                            + delta[a0][d0] * delta[a1][d1] * delta[b0][b1] * (PQ[c0] * QC_1 * (-1.0) + PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][d1] * (PQ[c0] * QC_1 * (-1.0) + PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b0][d1] * delta[a1][b1] * (PQ[c0] * QC_1 * (-1.0) + PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][b1] * (PQ[c0] * QC_1 * (-1.0) + PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][d0] * (PQ[c0] * QC_1 * (-1.0) + PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * delta[a1][b1] * (PQ[c0] * QC_1 * (-1.0) + PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][d1] * (PQ[c0] * QC_1 * (-1.0) + PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][d0] * (PQ[c0] * QC_1 * (-1.0) + PQ[c1] * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][d1] * (PQ[c0] * QC_1 * (-1.0) + PQ[c1] * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[b0][d1] * delta[a0][b1] * (PQ[c0] * QC_1 * (-1.0) + PQ[c1] * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][d0] * (PQ[c0] * QC_1 * (-1.0) + PQ[c1] * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[b0][d0] * delta[a0][b1] * (PQ[c0] * QC_1 * (-1.0) + PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[a1][d1] * delta[b0][b1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][d1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][d1] * delta[a1][b1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][c1] * delta[b0][b1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][c1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][c1] * delta[a1][b1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][d1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][c1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][d1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[b0][d1] * delta[a0][b1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][c1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[b0][c1] * delta[a0][b1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[a1][d0] * delta[b0][b1] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][d0] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][d0] * delta[a1][b1] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[a1][c1] * delta[b0][b1] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][c1] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b0][c1] * delta[a1][b1] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][d0] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][c1] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][d0] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[b0][d0] * delta[a0][b1] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][c1] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[b0][c1] * delta[a0][b1] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d1] * (PQ[c1] * PQ[d0] * (-2.0) + PQ[c1] * QD_0 * (-2.0) + PQ[d0] * QC_1 * (-2.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d1] * (PQ[c1] * PQ[d0] * (-2.0) + PQ[c1] * QD_0 * (-2.0) + PQ[d0] * QC_1 * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d1] * (PQ[c1] * PQ[d0] * (-2.0) + PQ[c1] * QD_0 * (-2.0) + PQ[d0] * QC_1 * (-2.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * (PQ[c1] * PQ[d1] * (-2.0) + PQ[c1] * QD_1 * (-2.0) + PQ[d1] * QC_1 * (-2.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * (PQ[c1] * PQ[d1] * (-2.0) + PQ[c1] * QD_1 * (-2.0) + PQ[d1] * QC_1 * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * (PQ[c1] * PQ[d1] * (-2.0) + PQ[c1] * QD_1 * (-2.0) + PQ[d1] * QC_1 * (-2.0))
                            + delta[a0][c0] * delta[a1][d1] * delta[b0][b1] * (PQ[c1] * QD_0 * (-1.0) + PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d1] * (PQ[c1] * QD_0 * (-1.0) + PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[b0][d1] * delta[a1][b1] * (PQ[c1] * QD_0 * (-1.0) + PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[a1][c0] * delta[b0][b1] * (PQ[c1] * QD_0 * (-1.0) + PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][c0] * (PQ[c1] * QD_0 * (-1.0) + PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[b0][c0] * delta[a1][b1] * (PQ[c1] * QD_0 * (-1.0) + PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d1] * (PQ[c1] * QD_0 * (-1.0) + PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][c0] * (PQ[c1] * QD_0 * (-1.0) + PQ[d0] * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d1] * (PQ[c1] * QD_0 * (-1.0) + PQ[d0] * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[b0][d1] * delta[a0][b1] * (PQ[c1] * QD_0 * (-1.0) + PQ[d0] * QC_1 * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][c0] * (PQ[c1] * QD_0 * (-1.0) + PQ[d0] * QC_1 * (-1.0))
                            + delta[a1][d1] * delta[b0][c0] * delta[a0][b1] * (PQ[c1] * QD_0 * (-1.0) + PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[a1][d0] * delta[b0][b1] * (PQ[c1] * QD_1 * (-1.0) + PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d0] * (PQ[c1] * QD_1 * (-1.0) + PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[b0][d0] * delta[a1][b1] * (PQ[c1] * QD_1 * (-1.0) + PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][b1] * (PQ[c1] * QD_1 * (-1.0) + PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][c0] * (PQ[c1] * QD_1 * (-1.0) + PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][c0] * delta[a1][b1] * (PQ[c1] * QD_1 * (-1.0) + PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d0] * (PQ[c1] * QD_1 * (-1.0) + PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][c0] * (PQ[c1] * QD_1 * (-1.0) + PQ[d1] * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d0] * (PQ[c1] * QD_1 * (-1.0) + PQ[d1] * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[b0][d0] * delta[a0][b1] * (PQ[c1] * QD_1 * (-1.0) + PQ[d1] * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][c0] * (PQ[c1] * QD_1 * (-1.0) + PQ[d1] * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[b0][c0] * delta[a0][b1] * (PQ[c1] * QD_1 * (-1.0) + PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][c1] * (PQ[d0] * PQ[d1] * (-2.0) + PQ[d0] * QD_1 * (-2.0) + PQ[d1] * QD_0 * (-2.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][c1] * (PQ[d0] * PQ[d1] * (-2.0) + PQ[d0] * QD_1 * (-2.0) + PQ[d1] * QD_0 * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][c1] * (PQ[d0] * PQ[d1] * (-2.0) + PQ[d0] * QD_1 * (-2.0) + PQ[d1] * QD_0 * (-2.0))
                            + delta[a0][c0] * delta[a1][c1] * delta[b0][b1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][c1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c0] * delta[b0][c1] * delta[a1][b1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[a1][c0] * delta[b0][b1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][c0] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][c0] * delta[a1][b1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][c1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][c0] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][c1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][c0] * delta[b0][c1] * delta[a0][b1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][c0] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][c1] * delta[b0][c0] * delta[a0][b1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][c1] * delta[d0][d1] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[a0][c0] * delta[a1][d0] * delta[c1][d1] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[a0][c0] * delta[a1][d1] * delta[c1][d0] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[a0][c1] * delta[a1][c0] * delta[d0][d1] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[a0][c1] * delta[a1][d0] * delta[c0][d1] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[a0][c1] * delta[a1][d1] * delta[c0][d0] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[a0][d0] * delta[a1][c0] * delta[c1][d1] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[a0][d0] * delta[a1][c1] * delta[c0][d1] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[a0][d0] * delta[a1][d1] * delta[c0][c1] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[a0][d1] * delta[a1][c0] * delta[c1][d0] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[a0][d1] * delta[a1][c1] * delta[c0][d0] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[a0][d1] * delta[a1][d0] * delta[c0][c1] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[a0][c0] * delta[a1][c1] * delta[b1][d1] * (PB_0 * QD_0)
                            + delta[a0][c0] * delta[a1][d1] * delta[b1][c1] * (PB_0 * QD_0)
                            + delta[a0][c1] * delta[a1][c0] * delta[b1][d1] * (PB_0 * QD_0)
                            + delta[a0][c1] * delta[a1][d1] * delta[b1][c0] * (PB_0 * QD_0)
                            + delta[a0][d1] * delta[a1][c0] * delta[b1][c1] * (PB_0 * QD_0)
                            + delta[a0][d1] * delta[a1][c1] * delta[b1][c0] * (PB_0 * QD_0)
                            + delta[a0][c0] * delta[a1][c1] * delta[b1][d0] * (PB_0 * QD_1)
                            + delta[a0][c0] * delta[a1][d0] * delta[b1][c1] * (PB_0 * QD_1)
                            + delta[a0][c1] * delta[a1][c0] * delta[b1][d0] * (PB_0 * QD_1)
                            + delta[a0][c1] * delta[a1][d0] * delta[b1][c0] * (PB_0 * QD_1)
                            + delta[a0][d0] * delta[a1][c0] * delta[b1][c1] * (PB_0 * QD_1)
                            + delta[a0][d0] * delta[a1][c1] * delta[b1][c0] * (PB_0 * QD_1)
                            + delta[a0][c0] * delta[a1][c1] * delta[b0][d1] * (PB_1 * QD_0)
                            + delta[a0][c0] * delta[a1][d1] * delta[b0][c1] * (PB_1 * QD_0)
                            + delta[a0][c1] * delta[a1][c0] * delta[b0][d1] * (PB_1 * QD_0)
                            + delta[a0][c1] * delta[a1][d1] * delta[b0][c0] * (PB_1 * QD_0)
                            + delta[a0][d1] * delta[a1][c0] * delta[b0][c1] * (PB_1 * QD_0)
                            + delta[a0][d1] * delta[a1][c1] * delta[b0][c0] * (PB_1 * QD_0)
                            + delta[a0][c0] * delta[a1][c1] * delta[b0][d0] * (PB_1 * QD_1)
                            + delta[a0][c0] * delta[a1][d0] * delta[b0][c1] * (PB_1 * QD_1)
                            + delta[a0][c1] * delta[a1][c0] * delta[b0][d0] * (PB_1 * QD_1)
                            + delta[a0][c1] * delta[a1][d0] * delta[b0][c0] * (PB_1 * QD_1)
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][c1] * (PB_1 * QD_1)
                            + delta[a0][d0] * delta[a1][c1] * delta[b0][c0] * (PB_1 * QD_1)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD18(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[4];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[3] * (

                        0.25 * ( S1 * S1 ) / ( S2 * S4 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] + PB_0 * PB_1 * PA_1 * PQ[a0] + PB_0 * PA_0 * PA_1 * PQ[b1] + PB_1 * PA_0 * PA_1 * PQ[b0])
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] + PB_0 * PB_1 * PA_1 * PQ[a0] + PB_0 * PA_0 * PA_1 * PQ[b1] + PB_1 * PA_0 * PA_1 * PQ[b0])
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] + PB_0 * PB_1 * PA_1 * PQ[a0] + PB_0 * PA_0 * PA_1 * PQ[b1] + PB_1 * PA_0 * PA_1 * PQ[b0])
                            + delta[b1][c1] * delta[d0][d1] * (PB_0 * PA_0 * PA_1 * PQ[c0])
                            + delta[b1][d0] * delta[c1][d1] * (PB_0 * PA_0 * PA_1 * PQ[c0])
                            + delta[b1][d1] * delta[c1][d0] * (PB_0 * PA_0 * PA_1 * PQ[c0])
                            + delta[b1][c0] * delta[d0][d1] * (PB_0 * PA_0 * PA_1 * PQ[c1])
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * PA_0 * PA_1 * PQ[c1])
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * PA_0 * PA_1 * PQ[c1])
                            + delta[b1][c0] * delta[c1][d1] * (PB_0 * PA_0 * PA_1 * PQ[d0])
                            + delta[b1][c1] * delta[c0][d1] * (PB_0 * PA_0 * PA_1 * PQ[d0])
                            + delta[b1][d1] * delta[c0][c1] * (PB_0 * PA_0 * PA_1 * PQ[d0])
                            + delta[b1][c0] * delta[c1][d0] * (PB_0 * PA_0 * PA_1 * PQ[d1])
                            + delta[b1][c1] * delta[c0][d0] * (PB_0 * PA_0 * PA_1 * PQ[d1])
                            + delta[b1][d0] * delta[c0][c1] * (PB_0 * PA_0 * PA_1 * PQ[d1])
                            + delta[b0][c1] * delta[d0][d1] * (PB_1 * PA_0 * PA_1 * PQ[c0])
                            + delta[b0][d0] * delta[c1][d1] * (PB_1 * PA_0 * PA_1 * PQ[c0])
                            + delta[b0][d1] * delta[c1][d0] * (PB_1 * PA_0 * PA_1 * PQ[c0])
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * PA_0 * PA_1 * PQ[c1])
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * PA_0 * PA_1 * PQ[c1])
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * PA_0 * PA_1 * PQ[c1])
                            + delta[b0][c0] * delta[c1][d1] * (PB_1 * PA_0 * PA_1 * PQ[d0])
                            + delta[b0][c1] * delta[c0][d1] * (PB_1 * PA_0 * PA_1 * PQ[d0])
                            + delta[b0][d1] * delta[c0][c1] * (PB_1 * PA_0 * PA_1 * PQ[d0])
                            + delta[b0][c0] * delta[c1][d0] * (PB_1 * PA_0 * PA_1 * PQ[d1])
                            + delta[b0][c1] * delta[c0][d0] * (PB_1 * PA_0 * PA_1 * PQ[d1])
                            + delta[b0][d0] * delta[c0][c1] * (PB_1 * PA_0 * PA_1 * PQ[d1])
                            + delta[b0][b1] * delta[d0][d1] * (PA_0 * PA_1 * PQ[c0] * PQ[c1] * (-1.0))
                            + delta[b0][b1] * delta[c1][d1] * (PA_0 * PA_1 * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[b0][b1] * delta[c1][d0] * (PA_0 * PA_1 * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * PA_1 * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * PA_1 * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[b0][b1] * delta[c0][c1] * (PA_0 * PA_1 * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][c1] * delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PQ[c0])
                            + delta[a1][d0] * delta[c1][d1] * (PB_0 * PB_1 * PA_0 * PQ[c0])
                            + delta[a1][d1] * delta[c1][d0] * (PB_0 * PB_1 * PA_0 * PQ[c0])
                            + delta[a1][c0] * delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PQ[c1])
                            + delta[a1][d0] * delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PQ[c1])
                            + delta[a1][d1] * delta[c0][d0] * (PB_0 * PB_1 * PA_0 * PQ[c1])
                            + delta[a1][c0] * delta[c1][d1] * (PB_0 * PB_1 * PA_0 * PQ[d0])
                            + delta[a1][c1] * delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PQ[d0])
                            + delta[a1][d1] * delta[c0][c1] * (PB_0 * PB_1 * PA_0 * PQ[d0])
                            + delta[a1][c0] * delta[c1][d0] * (PB_0 * PB_1 * PA_0 * PQ[d1])
                            + delta[a1][c1] * delta[c0][d0] * (PB_0 * PB_1 * PA_0 * PQ[d1])
                            + delta[a1][d0] * delta[c0][c1] * (PB_0 * PB_1 * PA_0 * PQ[d1])
                            + delta[a1][b1] * delta[d0][d1] * (PB_0 * PA_0 * PQ[c0] * PQ[c1] * (-1.0))
                            + delta[a1][b1] * delta[c1][d1] * (PB_0 * PA_0 * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a1][b1] * delta[c1][d0] * (PB_0 * PA_0 * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a1][b1] * delta[c0][d1] * (PB_0 * PA_0 * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a1][b1] * delta[c0][d0] * (PB_0 * PA_0 * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a1][b1] * delta[c0][c1] * (PB_0 * PA_0 * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][b0] * delta[d0][d1] * (PB_1 * PA_0 * PQ[c0] * PQ[c1] * (-1.0))
                            + delta[a1][b0] * delta[c1][d1] * (PB_1 * PA_0 * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a1][b0] * delta[c1][d0] * (PB_1 * PA_0 * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a1][b0] * delta[c0][d1] * (PB_1 * PA_0 * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a1][b0] * delta[c0][d0] * (PB_1 * PA_0 * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a1][b0] * delta[c0][c1] * (PB_1 * PA_0 * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[d0][d1] * (PB_0 * PB_1 * PA_1 * PQ[c0])
                            + delta[a0][d0] * delta[c1][d1] * (PB_0 * PB_1 * PA_1 * PQ[c0])
                            + delta[a0][d1] * delta[c1][d0] * (PB_0 * PB_1 * PA_1 * PQ[c0])
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * PB_1 * PA_1 * PQ[c1])
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * PB_1 * PA_1 * PQ[c1])
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * PB_1 * PA_1 * PQ[c1])
                            + delta[a0][c0] * delta[c1][d1] * (PB_0 * PB_1 * PA_1 * PQ[d0])
                            + delta[a0][c1] * delta[c0][d1] * (PB_0 * PB_1 * PA_1 * PQ[d0])
                            + delta[a0][d1] * delta[c0][c1] * (PB_0 * PB_1 * PA_1 * PQ[d0])
                            + delta[a0][c0] * delta[c1][d0] * (PB_0 * PB_1 * PA_1 * PQ[d1])
                            + delta[a0][c1] * delta[c0][d0] * (PB_0 * PB_1 * PA_1 * PQ[d1])
                            + delta[a0][d0] * delta[c0][c1] * (PB_0 * PB_1 * PA_1 * PQ[d1])
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PA_1 * PQ[c0] * PQ[c1] * (-1.0))
                            + delta[a0][b1] * delta[c1][d1] * (PB_0 * PA_1 * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][b1] * delta[c1][d0] * (PB_0 * PA_1 * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * PA_1 * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PA_1 * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][b1] * delta[c0][c1] * (PB_0 * PA_1 * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PA_1 * PQ[c0] * PQ[c1] * (-1.0))
                            + delta[a0][b0] * delta[c1][d1] * (PB_1 * PA_1 * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[c1][d0] * (PB_1 * PA_1 * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * PA_1 * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PA_1 * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[c0][c1] * (PB_1 * PA_1 * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[d0][d1] * (PB_0 * PB_1 * PQ[c0] * PQ[c1] * (-1.0))
                            + delta[a0][a1] * delta[c1][d1] * (PB_0 * PB_1 * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[c1][d0] * (PB_0 * PB_1 * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[c0][d1] * (PB_0 * PB_1 * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[c0][d0] * (PB_0 * PB_1 * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[c0][c1] * (PB_0 * PB_1 * PQ[d0] * PQ[d1] * (-1.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD19(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[4];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[3] * (

                        0.25 * ( S2 * S2 ) / ( S1 * S4 * S4 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PQ[a0] * PQ[a1] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][b1] * delta[c1][d1] * (PQ[a0] * PQ[a1] * QD_0 * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c1][d0] * (PQ[a0] * PQ[a1] * QD_1 * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c0][d1] * (PQ[a0] * PQ[a1] * QD_0 * QC_1 * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * QD_1 * QC_1 * (-1.0))
                            + delta[b0][b1] * delta[c0][c1] * (PQ[a0] * PQ[a1] * QD_0 * QD_1 * (-1.0))
                            + delta[a1][b1] * delta[d0][d1] * (PQ[a0] * PQ[b0] * QC_0 * QC_1 * (-1.0))
                            + delta[a1][b1] * delta[c1][d1] * (PQ[a0] * PQ[b0] * QD_0 * QC_0 * (-1.0))
                            + delta[a1][b1] * delta[c1][d0] * (PQ[a0] * PQ[b0] * QD_1 * QC_0 * (-1.0))
                            + delta[a1][b1] * delta[c0][d1] * (PQ[a0] * PQ[b0] * QD_0 * QC_1 * (-1.0))
                            + delta[a1][b1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * QD_1 * QC_1 * (-1.0))
                            + delta[a1][b1] * delta[c0][c1] * (PQ[a0] * PQ[b0] * QD_0 * QD_1 * (-1.0))
                            + delta[a1][b0] * delta[d0][d1] * (PQ[a0] * PQ[b1] * QC_0 * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[c1][d1] * (PQ[a0] * PQ[b1] * QD_0 * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[c1][d0] * (PQ[a0] * PQ[b1] * QD_1 * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[c0][d1] * (PQ[a0] * PQ[b1] * QD_0 * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[c0][d0] * (PQ[a0] * PQ[b1] * QD_1 * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[c0][c1] * (PQ[a0] * PQ[b1] * QD_0 * QD_1 * (-1.0))
                            + delta[a1][d1] * delta[b0][b1] * (PQ[a0] * QD_0 * QC_0 * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[b1][d1] * (PQ[a0] * QD_0 * QC_0 * QC_1 * (-1.0))
                            + delta[b0][d1] * delta[a1][b1] * (PQ[a0] * QD_0 * QC_0 * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[b0][b1] * (PQ[a0] * QD_1 * QC_0 * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[b1][d0] * (PQ[a0] * QD_1 * QC_0 * QC_1 * (-1.0))
                            + delta[b0][d0] * delta[a1][b1] * (PQ[a0] * QD_1 * QC_0 * QC_1 * (-1.0))
                            + delta[a1][c1] * delta[b0][b1] * (PQ[a0] * QD_0 * QD_1 * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][c1] * (PQ[a0] * QD_0 * QD_1 * QC_0 * (-1.0))
                            + delta[b0][c1] * delta[a1][b1] * (PQ[a0] * QD_0 * QD_1 * QC_0 * (-1.0))
                            + delta[a1][c0] * delta[b0][b1] * (PQ[a0] * QD_0 * QD_1 * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[b1][c0] * (PQ[a0] * QD_0 * QD_1 * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[a1][b1] * (PQ[a0] * QD_0 * QD_1 * QC_1 * (-1.0))
                            + delta[a0][b1] * delta[d0][d1] * (PQ[a1] * PQ[b0] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][b1] * delta[c1][d1] * (PQ[a1] * PQ[b0] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][b1] * delta[c1][d0] * (PQ[a1] * PQ[b0] * QD_1 * QC_0 * (-1.0))
                            + delta[a0][b1] * delta[c0][d1] * (PQ[a1] * PQ[b0] * QD_0 * QC_1 * (-1.0))
                            + delta[a0][b1] * delta[c0][d0] * (PQ[a1] * PQ[b0] * QD_1 * QC_1 * (-1.0))
                            + delta[a0][b1] * delta[c0][c1] * (PQ[a1] * PQ[b0] * QD_0 * QD_1 * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PQ[a1] * PQ[b1] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[c1][d1] * (PQ[a1] * PQ[b1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c1][d0] * (PQ[a1] * PQ[b1] * QD_1 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c0][d1] * (PQ[a1] * PQ[b1] * QD_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (PQ[a1] * PQ[b1] * QD_1 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[c0][c1] * (PQ[a1] * PQ[b1] * QD_0 * QD_1 * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * (PQ[a1] * QD_0 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * (PQ[a1] * QD_0 * QC_0 * QC_1 * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * (PQ[a1] * QD_0 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * (PQ[a1] * QD_1 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * (PQ[a1] * QD_1 * QC_0 * QC_1 * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * (PQ[a1] * QD_1 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][c1] * delta[b0][b1] * (PQ[a1] * QD_0 * QD_1 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][c1] * (PQ[a1] * QD_0 * QD_1 * QC_0 * (-1.0))
                            + delta[b0][c1] * delta[a0][b1] * (PQ[a1] * QD_0 * QD_1 * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * (PQ[a1] * QD_0 * QD_1 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * (PQ[a1] * QD_0 * QD_1 * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * (PQ[a1] * QD_0 * QD_1 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[d0][d1] * (PQ[b0] * PQ[b1] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[c1][d1] * (PQ[b0] * PQ[b1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[c1][d0] * (PQ[b0] * PQ[b1] * QD_1 * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[c0][d1] * (PQ[b0] * PQ[b1] * QD_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[c0][d0] * (PQ[b0] * PQ[b1] * QD_1 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[c0][c1] * (PQ[b0] * PQ[b1] * QD_0 * QD_1 * (-1.0))
                            + delta[a0][d1] * delta[a1][b1] * (PQ[b0] * QD_0 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b1][d1] * (PQ[b0] * QD_0 * QC_0 * QC_1 * (-1.0))
                            + delta[a1][d1] * delta[a0][b1] * (PQ[b0] * QD_0 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][b1] * (PQ[b0] * QD_1 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b1][d0] * (PQ[b0] * QD_1 * QC_0 * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[a0][b1] * (PQ[b0] * QD_1 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][c1] * delta[a1][b1] * (PQ[b0] * QD_0 * QD_1 * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][c1] * (PQ[b0] * QD_0 * QD_1 * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[a0][b1] * (PQ[b0] * QD_0 * QD_1 * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][b1] * (PQ[b0] * QD_0 * QD_1 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b1][c0] * (PQ[b0] * QD_0 * QD_1 * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[a0][b1] * (PQ[b0] * QD_0 * QD_1 * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * (PQ[b1] * QD_0 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * (PQ[b1] * QD_0 * QC_0 * QC_1 * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * (PQ[b1] * QD_0 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * (PQ[b1] * QD_1 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * (PQ[b1] * QD_1 * QC_0 * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * (PQ[b1] * QD_1 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][c1] * delta[a1][b0] * (PQ[b1] * QD_0 * QD_1 * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][c1] * (PQ[b1] * QD_0 * QD_1 * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[a0][b0] * (PQ[b1] * QD_0 * QD_1 * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * (PQ[b1] * QD_0 * QD_1 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * (PQ[b1] * QD_0 * QD_1 * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * (PQ[b1] * QD_0 * QD_1 * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * (PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * (PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * (PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD20(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[4];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[3] * (

                        0.25 * S1 / ( S4 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * (-2.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * (-2.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * (-2.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * (-2.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * (-2.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * (-2.0))
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * (-2.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * (-2.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * (-2.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * (-2.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * (-2.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * (-2.0))
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * (-2.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * (-2.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * (-2.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * (-2.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * (-2.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * (-2.0))
                            + delta[b1][c1] * delta[d0][d1] * (PB_0 * PA_0 * PQ[a1] * PQ[c0] * (-1.0) + PB_0 * PA_0 * PQ[a1] * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[c0] * (-1.0) + PB_0 * PA_1 * PQ[a0] * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[c0] * (-1.0) + PA_0 * PA_1 * PQ[b0] * QC_0 * (-1.0))
                            + delta[b1][d0] * delta[c1][d1] * (PB_0 * PA_0 * PQ[a1] * PQ[c0] * (-1.0) + PB_0 * PA_0 * PQ[a1] * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[c0] * (-1.0) + PB_0 * PA_1 * PQ[a0] * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[c0] * (-1.0) + PA_0 * PA_1 * PQ[b0] * QC_0 * (-1.0))
                            + delta[b1][d1] * delta[c1][d0] * (PB_0 * PA_0 * PQ[a1] * PQ[c0] * (-1.0) + PB_0 * PA_0 * PQ[a1] * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[c0] * (-1.0) + PB_0 * PA_1 * PQ[a0] * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[c0] * (-1.0) + PA_0 * PA_1 * PQ[b0] * QC_0 * (-1.0))
                            + delta[b1][c0] * delta[d0][d1] * (PB_0 * PA_0 * PQ[a1] * PQ[c1] * (-1.0) + PB_0 * PA_0 * PQ[a1] * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[c1] * (-1.0) + PB_0 * PA_1 * PQ[a0] * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[c1] * (-1.0) + PA_0 * PA_1 * PQ[b0] * QC_1 * (-1.0))
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * PA_0 * PQ[a1] * PQ[c1] * (-1.0) + PB_0 * PA_0 * PQ[a1] * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[c1] * (-1.0) + PB_0 * PA_1 * PQ[a0] * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[c1] * (-1.0) + PA_0 * PA_1 * PQ[b0] * QC_1 * (-1.0))
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * PA_0 * PQ[a1] * PQ[c1] * (-1.0) + PB_0 * PA_0 * PQ[a1] * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[c1] * (-1.0) + PB_0 * PA_1 * PQ[a0] * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[c1] * (-1.0) + PA_0 * PA_1 * PQ[b0] * QC_1 * (-1.0))
                            + delta[b1][c0] * delta[c1][d1] * (PB_0 * PA_0 * PQ[a1] * PQ[d0] * (-1.0) + PB_0 * PA_0 * PQ[a1] * QD_0 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[d0] * (-1.0) + PB_0 * PA_1 * PQ[a0] * QD_0 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[d0] * (-1.0) + PA_0 * PA_1 * PQ[b0] * QD_0 * (-1.0))
                            + delta[b1][c1] * delta[c0][d1] * (PB_0 * PA_0 * PQ[a1] * PQ[d0] * (-1.0) + PB_0 * PA_0 * PQ[a1] * QD_0 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[d0] * (-1.0) + PB_0 * PA_1 * PQ[a0] * QD_0 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[d0] * (-1.0) + PA_0 * PA_1 * PQ[b0] * QD_0 * (-1.0))
                            + delta[b1][d1] * delta[c0][c1] * (PB_0 * PA_0 * PQ[a1] * PQ[d0] * (-1.0) + PB_0 * PA_0 * PQ[a1] * QD_0 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[d0] * (-1.0) + PB_0 * PA_1 * PQ[a0] * QD_0 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[d0] * (-1.0) + PA_0 * PA_1 * PQ[b0] * QD_0 * (-1.0))
                            + delta[b1][c0] * delta[c1][d0] * (PB_0 * PA_0 * PQ[a1] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PQ[a1] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[d1] * (-1.0) + PB_0 * PA_1 * PQ[a0] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[d1] * (-1.0) + PA_0 * PA_1 * PQ[b0] * QD_1 * (-1.0))
                            + delta[b1][c1] * delta[c0][d0] * (PB_0 * PA_0 * PQ[a1] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PQ[a1] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[d1] * (-1.0) + PB_0 * PA_1 * PQ[a0] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[d1] * (-1.0) + PA_0 * PA_1 * PQ[b0] * QD_1 * (-1.0))
                            + delta[b1][d0] * delta[c0][c1] * (PB_0 * PA_0 * PQ[a1] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PQ[a1] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[d1] * (-1.0) + PB_0 * PA_1 * PQ[a0] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[d1] * (-1.0) + PA_0 * PA_1 * PQ[b0] * QD_1 * (-1.0))
                            + delta[b0][c1] * delta[d0][d1] * (PB_1 * PA_0 * PQ[a1] * PQ[c0] * (-1.0) + PB_1 * PA_0 * PQ[a1] * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[c0] * (-1.0) + PB_1 * PA_1 * PQ[a0] * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[c0] * (-1.0) + PA_0 * PA_1 * PQ[b1] * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[c1][d1] * (PB_1 * PA_0 * PQ[a1] * PQ[c0] * (-1.0) + PB_1 * PA_0 * PQ[a1] * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[c0] * (-1.0) + PB_1 * PA_1 * PQ[a0] * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[c0] * (-1.0) + PA_0 * PA_1 * PQ[b1] * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[c1][d0] * (PB_1 * PA_0 * PQ[a1] * PQ[c0] * (-1.0) + PB_1 * PA_0 * PQ[a1] * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[c0] * (-1.0) + PB_1 * PA_1 * PQ[a0] * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[c0] * (-1.0) + PA_0 * PA_1 * PQ[b1] * QC_0 * (-1.0))
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * PA_0 * PQ[a1] * PQ[c1] * (-1.0) + PB_1 * PA_0 * PQ[a1] * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[c1] * (-1.0) + PB_1 * PA_1 * PQ[a0] * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[c1] * (-1.0) + PA_0 * PA_1 * PQ[b1] * QC_1 * (-1.0))
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * PA_0 * PQ[a1] * PQ[c1] * (-1.0) + PB_1 * PA_0 * PQ[a1] * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[c1] * (-1.0) + PB_1 * PA_1 * PQ[a0] * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[c1] * (-1.0) + PA_0 * PA_1 * PQ[b1] * QC_1 * (-1.0))
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * PA_0 * PQ[a1] * PQ[c1] * (-1.0) + PB_1 * PA_0 * PQ[a1] * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[c1] * (-1.0) + PB_1 * PA_1 * PQ[a0] * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[c1] * (-1.0) + PA_0 * PA_1 * PQ[b1] * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[c1][d1] * (PB_1 * PA_0 * PQ[a1] * PQ[d0] * (-1.0) + PB_1 * PA_0 * PQ[a1] * QD_0 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[d0] * (-1.0) + PB_1 * PA_1 * PQ[a0] * QD_0 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[d0] * (-1.0) + PA_0 * PA_1 * PQ[b1] * QD_0 * (-1.0))
                            + delta[b0][c1] * delta[c0][d1] * (PB_1 * PA_0 * PQ[a1] * PQ[d0] * (-1.0) + PB_1 * PA_0 * PQ[a1] * QD_0 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[d0] * (-1.0) + PB_1 * PA_1 * PQ[a0] * QD_0 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[d0] * (-1.0) + PA_0 * PA_1 * PQ[b1] * QD_0 * (-1.0))
                            + delta[b0][d1] * delta[c0][c1] * (PB_1 * PA_0 * PQ[a1] * PQ[d0] * (-1.0) + PB_1 * PA_0 * PQ[a1] * QD_0 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[d0] * (-1.0) + PB_1 * PA_1 * PQ[a0] * QD_0 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[d0] * (-1.0) + PA_0 * PA_1 * PQ[b1] * QD_0 * (-1.0))
                            + delta[b0][c0] * delta[c1][d0] * (PB_1 * PA_0 * PQ[a1] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PQ[a1] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[d1] * (-1.0) + PB_1 * PA_1 * PQ[a0] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[d1] * (-1.0) + PA_0 * PA_1 * PQ[b1] * QD_1 * (-1.0))
                            + delta[b0][c1] * delta[c0][d0] * (PB_1 * PA_0 * PQ[a1] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PQ[a1] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[d1] * (-1.0) + PB_1 * PA_1 * PQ[a0] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[d1] * (-1.0) + PA_0 * PA_1 * PQ[b1] * QD_1 * (-1.0))
                            + delta[b0][d0] * delta[c0][c1] * (PB_1 * PA_0 * PQ[a1] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PQ[a1] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[d1] * (-1.0) + PB_1 * PA_1 * PQ[a0] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[d1] * (-1.0) + PA_0 * PA_1 * PQ[b1] * QD_1 * (-1.0))
                            + delta[b0][b1] * delta[d0][d1] * (PA_0 * PA_1 * PQ[c0] * PQ[c1] * (-1.0) + PA_0 * PA_1 * PQ[c0] * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[c1] * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[c0] * PQ[c1] + PA_0 * PQ[a1] * PQ[c0] * QC_1 + PA_0 * PQ[a1] * PQ[c1] * QC_0 + PA_1 * PQ[a0] * PQ[c0] * PQ[c1] + PA_1 * PQ[a0] * PQ[c0] * QC_1 + PA_1 * PQ[a0] * PQ[c1] * QC_0)
                            + delta[b0][b1] * delta[c1][d1] * (PA_0 * PA_1 * PQ[c0] * PQ[d0] * (-1.0) + PA_0 * PA_1 * PQ[c0] * QD_0 * (-1.0) + PA_0 * PA_1 * PQ[d0] * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[c0] * PQ[d0] + PA_0 * PQ[a1] * PQ[c0] * QD_0 + PA_0 * PQ[a1] * PQ[d0] * QC_0 + PA_1 * PQ[a0] * PQ[c0] * PQ[d0] + PA_1 * PQ[a0] * PQ[c0] * QD_0 + PA_1 * PQ[a0] * PQ[d0] * QC_0)
                            + delta[b0][b1] * delta[c1][d0] * (PA_0 * PA_1 * PQ[c0] * PQ[d1] * (-1.0) + PA_0 * PA_1 * PQ[c0] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[c0] * PQ[d1] + PA_0 * PQ[a1] * PQ[c0] * QD_1 + PA_0 * PQ[a1] * PQ[d1] * QC_0 + PA_1 * PQ[a0] * PQ[c0] * PQ[d1] + PA_1 * PQ[a0] * PQ[c0] * QD_1 + PA_1 * PQ[a0] * PQ[d1] * QC_0)
                            + delta[b0][d0] * delta[b1][d1] * (PA_0 * PA_1 * PQ[c0] * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[c1] * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[b1][d0] * (PA_0 * PA_1 * PQ[c0] * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[c1] * QC_0 * (-1.0))
                            + delta[b0][c1] * delta[b1][d1] * (PA_0 * PA_1 * PQ[c0] * QD_0 * (-1.0) + PA_0 * PA_1 * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[b1][c1] * (PA_0 * PA_1 * PQ[c0] * QD_0 * (-1.0) + PA_0 * PA_1 * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][c1] * delta[b1][d0] * (PA_0 * PA_1 * PQ[c0] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[b1][c1] * (PA_0 * PA_1 * PQ[c0] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * PA_1 * PQ[c1] * PQ[d0] * (-1.0) + PA_0 * PA_1 * PQ[c1] * QD_0 * (-1.0) + PA_0 * PA_1 * PQ[d0] * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[c1] * PQ[d0] + PA_0 * PQ[a1] * PQ[c1] * QD_0 + PA_0 * PQ[a1] * PQ[d0] * QC_1 + PA_1 * PQ[a0] * PQ[c1] * PQ[d0] + PA_1 * PQ[a0] * PQ[c1] * QD_0 + PA_1 * PQ[a0] * PQ[d0] * QC_1)
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * PA_1 * PQ[c1] * PQ[d1] * (-1.0) + PA_0 * PA_1 * PQ[c1] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[d1] * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[c1] * PQ[d1] + PA_0 * PQ[a1] * PQ[c1] * QD_1 + PA_0 * PQ[a1] * PQ[d1] * QC_1 + PA_1 * PQ[a0] * PQ[c1] * PQ[d1] + PA_1 * PQ[a0] * PQ[c1] * QD_1 + PA_1 * PQ[a0] * PQ[d1] * QC_1)
                            + delta[b0][c0] * delta[b1][d1] * (PA_0 * PA_1 * PQ[c1] * QD_0 * (-1.0) + PA_0 * PA_1 * PQ[d0] * QC_1 * (-1.0))
                            + delta[b0][d1] * delta[b1][c0] * (PA_0 * PA_1 * PQ[c1] * QD_0 * (-1.0) + PA_0 * PA_1 * PQ[d0] * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[b1][d0] * (PA_0 * PA_1 * PQ[c1] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[d1] * QC_1 * (-1.0))
                            + delta[b0][d0] * delta[b1][c0] * (PA_0 * PA_1 * PQ[c1] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[d1] * QC_1 * (-1.0))
                            + delta[b0][b1] * delta[c0][c1] * (PA_0 * PA_1 * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PA_1 * PQ[d0] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[d0] * PQ[d1] + PA_0 * PQ[a1] * PQ[d0] * QD_1 + PA_0 * PQ[a1] * PQ[d1] * QD_0 + PA_1 * PQ[a0] * PQ[d0] * PQ[d1] + PA_1 * PQ[a0] * PQ[d0] * QD_1 + PA_1 * PQ[a0] * PQ[d1] * QD_0)
                            + delta[b0][c0] * delta[b1][c1] * (PA_0 * PA_1 * PQ[d0] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][c1] * delta[b1][c0] * (PA_0 * PA_1 * PQ[d0] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][c1] * delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] * (-1.0) + PB_0 * PB_1 * PQ[a0] * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c0] * (-1.0) + PB_0 * PA_0 * PQ[b1] * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c0] * (-1.0) + PB_1 * PA_0 * PQ[b0] * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[c1][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] * (-1.0) + PB_0 * PB_1 * PQ[a0] * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c0] * (-1.0) + PB_0 * PA_0 * PQ[b1] * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c0] * (-1.0) + PB_1 * PA_0 * PQ[b0] * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[c1][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] * (-1.0) + PB_0 * PB_1 * PQ[a0] * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c0] * (-1.0) + PB_0 * PA_0 * PQ[b1] * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c0] * (-1.0) + PB_1 * PA_0 * PQ[b0] * QC_0 * (-1.0))
                            + delta[a1][c0] * delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[c1] * (-1.0) + PB_0 * PB_1 * PQ[a0] * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c1] * (-1.0) + PB_0 * PA_0 * PQ[b1] * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c1] * (-1.0) + PB_1 * PA_0 * PQ[b0] * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[c1] * (-1.0) + PB_0 * PB_1 * PQ[a0] * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c1] * (-1.0) + PB_0 * PA_0 * PQ[b1] * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c1] * (-1.0) + PB_1 * PA_0 * PQ[b0] * QC_1 * (-1.0))
                            + delta[a1][d1] * delta[c0][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[c1] * (-1.0) + PB_0 * PB_1 * PQ[a0] * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c1] * (-1.0) + PB_0 * PA_0 * PQ[b1] * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c1] * (-1.0) + PB_1 * PA_0 * PQ[b0] * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[c1][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[d0] * (-1.0) + PB_0 * PB_1 * PQ[a0] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d0] * (-1.0) + PB_0 * PA_0 * PQ[b1] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d0] * (-1.0) + PB_1 * PA_0 * PQ[b0] * QD_0 * (-1.0))
                            + delta[a1][c1] * delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[d0] * (-1.0) + PB_0 * PB_1 * PQ[a0] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d0] * (-1.0) + PB_0 * PA_0 * PQ[b1] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d0] * (-1.0) + PB_1 * PA_0 * PQ[b0] * QD_0 * (-1.0))
                            + delta[a1][d1] * delta[c0][c1] * (PB_0 * PB_1 * PQ[a0] * PQ[d0] * (-1.0) + PB_0 * PB_1 * PQ[a0] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d0] * (-1.0) + PB_0 * PA_0 * PQ[b1] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d0] * (-1.0) + PB_1 * PA_0 * PQ[b0] * QD_0 * (-1.0))
                            + delta[a1][c0] * delta[c1][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[d1] * (-1.0) + PB_0 * PB_1 * PQ[a0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PQ[b1] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PQ[b0] * QD_1 * (-1.0))
                            + delta[a1][c1] * delta[c0][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[d1] * (-1.0) + PB_0 * PB_1 * PQ[a0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PQ[b1] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PQ[b0] * QD_1 * (-1.0))
                            + delta[a1][d0] * delta[c0][c1] * (PB_0 * PB_1 * PQ[a0] * PQ[d1] * (-1.0) + PB_0 * PB_1 * PQ[a0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PQ[b1] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PQ[b0] * QD_1 * (-1.0))
                            + delta[a1][b1] * delta[d0][d1] * (PB_0 * PA_0 * PQ[c0] * PQ[c1] * (-1.0) + PB_0 * PA_0 * PQ[c0] * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[c1] * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[c0] * PQ[c1] + PB_0 * PQ[a0] * PQ[c0] * QC_1 + PB_0 * PQ[a0] * PQ[c1] * QC_0 + PA_0 * PQ[b0] * PQ[c0] * PQ[c1] + PA_0 * PQ[b0] * PQ[c0] * QC_1 + PA_0 * PQ[b0] * PQ[c1] * QC_0)
                            + delta[a1][b1] * delta[c1][d1] * (PB_0 * PA_0 * PQ[c0] * PQ[d0] * (-1.0) + PB_0 * PA_0 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[d0] * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[c0] * PQ[d0] + PB_0 * PQ[a0] * PQ[c0] * QD_0 + PB_0 * PQ[a0] * PQ[d0] * QC_0 + PA_0 * PQ[b0] * PQ[c0] * PQ[d0] + PA_0 * PQ[b0] * PQ[c0] * QD_0 + PA_0 * PQ[b0] * PQ[d0] * QC_0)
                            + delta[a1][b1] * delta[c1][d0] * (PB_0 * PA_0 * PQ[c0] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[d1] * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[c0] * PQ[d1] + PB_0 * PQ[a0] * PQ[c0] * QD_1 + PB_0 * PQ[a0] * PQ[d1] * QC_0 + PA_0 * PQ[b0] * PQ[c0] * PQ[d1] + PA_0 * PQ[b0] * PQ[c0] * QD_1 + PA_0 * PQ[b0] * PQ[d1] * QC_0)
                            + delta[a1][d0] * delta[b1][d1] * (PB_0 * PA_0 * PQ[c0] * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[c1] * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[b1][d0] * (PB_0 * PA_0 * PQ[c0] * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[c1] * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[b1][d1] * (PB_0 * PA_0 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[b1][c1] * (PB_0 * PA_0 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[b1][d0] * (PB_0 * PA_0 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[b1][c1] * (PB_0 * PA_0 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][b1] * delta[c0][d1] * (PB_0 * PA_0 * PQ[c1] * PQ[d0] * (-1.0) + PB_0 * PA_0 * PQ[c1] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[d0] * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[c1] * PQ[d0] + PB_0 * PQ[a0] * PQ[c1] * QD_0 + PB_0 * PQ[a0] * PQ[d0] * QC_1 + PA_0 * PQ[b0] * PQ[c1] * PQ[d0] + PA_0 * PQ[b0] * PQ[c1] * QD_0 + PA_0 * PQ[b0] * PQ[d0] * QC_1)
                            + delta[a1][b1] * delta[c0][d0] * (PB_0 * PA_0 * PQ[c1] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PQ[c1] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[d1] * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[c1] * PQ[d1] + PB_0 * PQ[a0] * PQ[c1] * QD_1 + PB_0 * PQ[a0] * PQ[d1] * QC_1 + PA_0 * PQ[b0] * PQ[c1] * PQ[d1] + PA_0 * PQ[b0] * PQ[c1] * QD_1 + PA_0 * PQ[b0] * PQ[d1] * QC_1)
                            + delta[a1][c0] * delta[b1][d1] * (PB_0 * PA_0 * PQ[c1] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[d0] * QC_1 * (-1.0))
                            + delta[a1][d1] * delta[b1][c0] * (PB_0 * PA_0 * PQ[c1] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[d0] * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[b1][d0] * (PB_0 * PA_0 * PQ[c1] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[d1] * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[b1][c0] * (PB_0 * PA_0 * PQ[c1] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[d1] * QC_1 * (-1.0))
                            + delta[a1][b1] * delta[c0][c1] * (PB_0 * PA_0 * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[a0] * PQ[d0] * PQ[d1] + PB_0 * PQ[a0] * PQ[d0] * QD_1 + PB_0 * PQ[a0] * PQ[d1] * QD_0 + PA_0 * PQ[b0] * PQ[d0] * PQ[d1] + PA_0 * PQ[b0] * PQ[d0] * QD_1 + PA_0 * PQ[b0] * PQ[d1] * QD_0)
                            + delta[a1][c0] * delta[b1][c1] * (PB_0 * PA_0 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][c1] * delta[b1][c0] * (PB_0 * PA_0 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][b0] * delta[d0][d1] * (PB_1 * PA_0 * PQ[c0] * PQ[c1] * (-1.0) + PB_1 * PA_0 * PQ[c0] * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[c1] * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[c0] * PQ[c1] + PB_1 * PQ[a0] * PQ[c0] * QC_1 + PB_1 * PQ[a0] * PQ[c1] * QC_0 + PA_0 * PQ[b1] * PQ[c0] * PQ[c1] + PA_0 * PQ[b1] * PQ[c0] * QC_1 + PA_0 * PQ[b1] * PQ[c1] * QC_0)
                            + delta[a1][b0] * delta[c1][d1] * (PB_1 * PA_0 * PQ[c0] * PQ[d0] * (-1.0) + PB_1 * PA_0 * PQ[c0] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[d0] * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[c0] * PQ[d0] + PB_1 * PQ[a0] * PQ[c0] * QD_0 + PB_1 * PQ[a0] * PQ[d0] * QC_0 + PA_0 * PQ[b1] * PQ[c0] * PQ[d0] + PA_0 * PQ[b1] * PQ[c0] * QD_0 + PA_0 * PQ[b1] * PQ[d0] * QC_0)
                            + delta[a1][b0] * delta[c1][d0] * (PB_1 * PA_0 * PQ[c0] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PQ[c0] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[d1] * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[c0] * PQ[d1] + PB_1 * PQ[a0] * PQ[c0] * QD_1 + PB_1 * PQ[a0] * PQ[d1] * QC_0 + PA_0 * PQ[b1] * PQ[c0] * PQ[d1] + PA_0 * PQ[b1] * PQ[c0] * QD_1 + PA_0 * PQ[b1] * PQ[d1] * QC_0)
                            + delta[a1][d0] * delta[b0][d1] * (PB_1 * PA_0 * PQ[c0] * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[c1] * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[b0][d0] * (PB_1 * PA_0 * PQ[c0] * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[c1] * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[b0][d1] * (PB_1 * PA_0 * PQ[c0] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[b0][c1] * (PB_1 * PA_0 * PQ[c0] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[b0][d0] * (PB_1 * PA_0 * PQ[c0] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[b0][c1] * (PB_1 * PA_0 * PQ[c0] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[c0][d1] * (PB_1 * PA_0 * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PA_0 * PQ[c1] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[d0] * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[c1] * PQ[d0] + PB_1 * PQ[a0] * PQ[c1] * QD_0 + PB_1 * PQ[a0] * PQ[d0] * QC_1 + PA_0 * PQ[b1] * PQ[c1] * PQ[d0] + PA_0 * PQ[b1] * PQ[c1] * QD_0 + PA_0 * PQ[b1] * PQ[d0] * QC_1)
                            + delta[a1][b0] * delta[c0][d0] * (PB_1 * PA_0 * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PQ[c1] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[d1] * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[c1] * PQ[d1] + PB_1 * PQ[a0] * PQ[c1] * QD_1 + PB_1 * PQ[a0] * PQ[d1] * QC_1 + PA_0 * PQ[b1] * PQ[c1] * PQ[d1] + PA_0 * PQ[b1] * PQ[c1] * QD_1 + PA_0 * PQ[b1] * PQ[d1] * QC_1)
                            + delta[a1][c0] * delta[b0][d1] * (PB_1 * PA_0 * PQ[c1] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[d0] * QC_1 * (-1.0))
                            + delta[a1][d1] * delta[b0][c0] * (PB_1 * PA_0 * PQ[c1] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[d0] * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[b0][d0] * (PB_1 * PA_0 * PQ[c1] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[d1] * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[b0][c0] * (PB_1 * PA_0 * PQ[c1] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[d1] * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[c0][c1] * (PB_1 * PA_0 * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PQ[d0] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[d0] * PQ[d1] + PB_1 * PQ[a0] * PQ[d0] * QD_1 + PB_1 * PQ[a0] * PQ[d1] * QD_0 + PA_0 * PQ[b1] * PQ[d0] * PQ[d1] + PA_0 * PQ[b1] * PQ[d0] * QD_1 + PA_0 * PQ[b1] * PQ[d1] * QD_0)
                            + delta[a1][c0] * delta[b0][c1] * (PB_1 * PA_0 * PQ[d0] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][c1] * delta[b0][c0] * (PB_1 * PA_0 * PQ[d0] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][d1] * delta[b0][b1] * (PA_0 * PQ[c0] * PQ[c1] * QD_0 + PA_0 * PQ[c0] * PQ[d0] * QC_1 + PA_0 * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a1][b0] * delta[b1][d1] * (PA_0 * PQ[c0] * PQ[c1] * QD_0 + PA_0 * PQ[c0] * PQ[d0] * QC_1 + PA_0 * PQ[c1] * PQ[d0] * QC_0)
                            + delta[b0][d1] * delta[a1][b1] * (PA_0 * PQ[c0] * PQ[c1] * QD_0 + PA_0 * PQ[c0] * PQ[d0] * QC_1 + PA_0 * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a1][d0] * delta[b0][b1] * (PA_0 * PQ[c0] * PQ[c1] * QD_1 + PA_0 * PQ[c0] * PQ[d1] * QC_1 + PA_0 * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a1][b0] * delta[b1][d0] * (PA_0 * PQ[c0] * PQ[c1] * QD_1 + PA_0 * PQ[c0] * PQ[d1] * QC_1 + PA_0 * PQ[c1] * PQ[d1] * QC_0)
                            + delta[b0][d0] * delta[a1][b1] * (PA_0 * PQ[c0] * PQ[c1] * QD_1 + PA_0 * PQ[c0] * PQ[d1] * QC_1 + PA_0 * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a1][c1] * delta[b0][b1] * (PA_0 * PQ[c0] * PQ[d0] * QD_1 + PA_0 * PQ[c0] * PQ[d1] * QD_0 + PA_0 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a1][b0] * delta[b1][c1] * (PA_0 * PQ[c0] * PQ[d0] * QD_1 + PA_0 * PQ[c0] * PQ[d1] * QD_0 + PA_0 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[b0][c1] * delta[a1][b1] * (PA_0 * PQ[c0] * PQ[d0] * QD_1 + PA_0 * PQ[c0] * PQ[d1] * QD_0 + PA_0 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a1][c0] * delta[b0][b1] * (PA_0 * PQ[c1] * PQ[d0] * QD_1 + PA_0 * PQ[c1] * PQ[d1] * QD_0 + PA_0 * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a1][b0] * delta[b1][c0] * (PA_0 * PQ[c1] * PQ[d0] * QD_1 + PA_0 * PQ[c1] * PQ[d1] * QD_0 + PA_0 * PQ[d0] * PQ[d1] * QC_1)
                            + delta[b0][c0] * delta[a1][b1] * (PA_0 * PQ[c1] * PQ[d0] * QD_1 + PA_0 * PQ[c1] * PQ[d1] * QD_0 + PA_0 * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a0][c1] * delta[d0][d1] * (PB_0 * PB_1 * PQ[a1] * PQ[c0] * (-1.0) + PB_0 * PB_1 * PQ[a1] * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[c0] * (-1.0) + PB_0 * PA_1 * PQ[b1] * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[c0] * (-1.0) + PB_1 * PA_1 * PQ[b0] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[c1][d1] * (PB_0 * PB_1 * PQ[a1] * PQ[c0] * (-1.0) + PB_0 * PB_1 * PQ[a1] * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[c0] * (-1.0) + PB_0 * PA_1 * PQ[b1] * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[c0] * (-1.0) + PB_1 * PA_1 * PQ[b0] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[c1][d0] * (PB_0 * PB_1 * PQ[a1] * PQ[c0] * (-1.0) + PB_0 * PB_1 * PQ[a1] * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[c0] * (-1.0) + PB_0 * PA_1 * PQ[b1] * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[c0] * (-1.0) + PB_1 * PA_1 * PQ[b0] * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * PB_1 * PQ[a1] * PQ[c1] * (-1.0) + PB_0 * PB_1 * PQ[a1] * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[c1] * (-1.0) + PB_0 * PA_1 * PQ[b1] * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[c1] * (-1.0) + PB_1 * PA_1 * PQ[b0] * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * PB_1 * PQ[a1] * PQ[c1] * (-1.0) + PB_0 * PB_1 * PQ[a1] * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[c1] * (-1.0) + PB_0 * PA_1 * PQ[b1] * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[c1] * (-1.0) + PB_1 * PA_1 * PQ[b0] * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * PB_1 * PQ[a1] * PQ[c1] * (-1.0) + PB_0 * PB_1 * PQ[a1] * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[c1] * (-1.0) + PB_0 * PA_1 * PQ[b1] * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[c1] * (-1.0) + PB_1 * PA_1 * PQ[b0] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[c1][d1] * (PB_0 * PB_1 * PQ[a1] * PQ[d0] * (-1.0) + PB_0 * PB_1 * PQ[a1] * QD_0 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[d0] * (-1.0) + PB_0 * PA_1 * PQ[b1] * QD_0 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[d0] * (-1.0) + PB_1 * PA_1 * PQ[b0] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[c0][d1] * (PB_0 * PB_1 * PQ[a1] * PQ[d0] * (-1.0) + PB_0 * PB_1 * PQ[a1] * QD_0 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[d0] * (-1.0) + PB_0 * PA_1 * PQ[b1] * QD_0 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[d0] * (-1.0) + PB_1 * PA_1 * PQ[b0] * QD_0 * (-1.0))
                            + delta[a0][d1] * delta[c0][c1] * (PB_0 * PB_1 * PQ[a1] * PQ[d0] * (-1.0) + PB_0 * PB_1 * PQ[a1] * QD_0 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[d0] * (-1.0) + PB_0 * PA_1 * PQ[b1] * QD_0 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[d0] * (-1.0) + PB_1 * PA_1 * PQ[b0] * QD_0 * (-1.0))
                            + delta[a0][c0] * delta[c1][d0] * (PB_0 * PB_1 * PQ[a1] * PQ[d1] * (-1.0) + PB_0 * PB_1 * PQ[a1] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[d1] * (-1.0) + PB_0 * PA_1 * PQ[b1] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[d1] * (-1.0) + PB_1 * PA_1 * PQ[b0] * QD_1 * (-1.0))
                            + delta[a0][c1] * delta[c0][d0] * (PB_0 * PB_1 * PQ[a1] * PQ[d1] * (-1.0) + PB_0 * PB_1 * PQ[a1] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[d1] * (-1.0) + PB_0 * PA_1 * PQ[b1] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[d1] * (-1.0) + PB_1 * PA_1 * PQ[b0] * QD_1 * (-1.0))
                            + delta[a0][d0] * delta[c0][c1] * (PB_0 * PB_1 * PQ[a1] * PQ[d1] * (-1.0) + PB_0 * PB_1 * PQ[a1] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[d1] * (-1.0) + PB_0 * PA_1 * PQ[b1] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[d1] * (-1.0) + PB_1 * PA_1 * PQ[b0] * QD_1 * (-1.0))
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PA_1 * PQ[c0] * PQ[c1] * (-1.0) + PB_0 * PA_1 * PQ[c0] * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[c1] * QC_0 * (-1.0) + PB_0 * PQ[a1] * PQ[c0] * PQ[c1] + PB_0 * PQ[a1] * PQ[c0] * QC_1 + PB_0 * PQ[a1] * PQ[c1] * QC_0 + PA_1 * PQ[b0] * PQ[c0] * PQ[c1] + PA_1 * PQ[b0] * PQ[c0] * QC_1 + PA_1 * PQ[b0] * PQ[c1] * QC_0)
                            + delta[a0][b1] * delta[c1][d1] * (PB_0 * PA_1 * PQ[c0] * PQ[d0] * (-1.0) + PB_0 * PA_1 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PA_1 * PQ[d0] * QC_0 * (-1.0) + PB_0 * PQ[a1] * PQ[c0] * PQ[d0] + PB_0 * PQ[a1] * PQ[c0] * QD_0 + PB_0 * PQ[a1] * PQ[d0] * QC_0 + PA_1 * PQ[b0] * PQ[c0] * PQ[d0] + PA_1 * PQ[b0] * PQ[c0] * QD_0 + PA_1 * PQ[b0] * PQ[d0] * QC_0)
                            + delta[a0][b1] * delta[c1][d0] * (PB_0 * PA_1 * PQ[c0] * PQ[d1] * (-1.0) + PB_0 * PA_1 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[d1] * QC_0 * (-1.0) + PB_0 * PQ[a1] * PQ[c0] * PQ[d1] + PB_0 * PQ[a1] * PQ[c0] * QD_1 + PB_0 * PQ[a1] * PQ[d1] * QC_0 + PA_1 * PQ[b0] * PQ[c0] * PQ[d1] + PA_1 * PQ[b0] * PQ[c0] * QD_1 + PA_1 * PQ[b0] * PQ[d1] * QC_0)
                            + delta[a0][d0] * delta[b1][d1] * (PB_0 * PA_1 * PQ[c0] * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b1][d0] * (PB_0 * PA_1 * PQ[c0] * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b1][d1] * (PB_0 * PA_1 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PA_1 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b1][c1] * (PB_0 * PA_1 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PA_1 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b1][d0] * (PB_0 * PA_1 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b1][c1] * (PB_0 * PA_1 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * PA_1 * PQ[c1] * PQ[d0] * (-1.0) + PB_0 * PA_1 * PQ[c1] * QD_0 * (-1.0) + PB_0 * PA_1 * PQ[d0] * QC_1 * (-1.0) + PB_0 * PQ[a1] * PQ[c1] * PQ[d0] + PB_0 * PQ[a1] * PQ[c1] * QD_0 + PB_0 * PQ[a1] * PQ[d0] * QC_1 + PA_1 * PQ[b0] * PQ[c1] * PQ[d0] + PA_1 * PQ[b0] * PQ[c1] * QD_0 + PA_1 * PQ[b0] * PQ[d0] * QC_1)
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PA_1 * PQ[c1] * PQ[d1] * (-1.0) + PB_0 * PA_1 * PQ[c1] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[d1] * QC_1 * (-1.0) + PB_0 * PQ[a1] * PQ[c1] * PQ[d1] + PB_0 * PQ[a1] * PQ[c1] * QD_1 + PB_0 * PQ[a1] * PQ[d1] * QC_1 + PA_1 * PQ[b0] * PQ[c1] * PQ[d1] + PA_1 * PQ[b0] * PQ[c1] * QD_1 + PA_1 * PQ[b0] * PQ[d1] * QC_1)
                            + delta[a0][c0] * delta[b1][d1] * (PB_0 * PA_1 * PQ[c1] * QD_0 * (-1.0) + PB_0 * PA_1 * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[b1][c0] * (PB_0 * PA_1 * PQ[c1] * QD_0 * (-1.0) + PB_0 * PA_1 * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[b1][d0] * (PB_0 * PA_1 * PQ[c1] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[b1][c0] * (PB_0 * PA_1 * PQ[c1] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][b1] * delta[c0][c1] * (PB_0 * PA_1 * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PA_1 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[a1] * PQ[d0] * PQ[d1] + PB_0 * PQ[a1] * PQ[d0] * QD_1 + PB_0 * PQ[a1] * PQ[d1] * QD_0 + PA_1 * PQ[b0] * PQ[d0] * PQ[d1] + PA_1 * PQ[b0] * PQ[d0] * QD_1 + PA_1 * PQ[b0] * PQ[d1] * QD_0)
                            + delta[a0][c0] * delta[b1][c1] * (PB_0 * PA_1 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[b1][c0] * (PB_0 * PA_1 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PA_1 * PQ[c0] * PQ[c1] * (-1.0) + PB_1 * PA_1 * PQ[c0] * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[c1] * QC_0 * (-1.0) + PB_1 * PQ[a1] * PQ[c0] * PQ[c1] + PB_1 * PQ[a1] * PQ[c0] * QC_1 + PB_1 * PQ[a1] * PQ[c1] * QC_0 + PA_1 * PQ[b1] * PQ[c0] * PQ[c1] + PA_1 * PQ[b1] * PQ[c0] * QC_1 + PA_1 * PQ[b1] * PQ[c1] * QC_0)
                            + delta[a0][b0] * delta[c1][d1] * (PB_1 * PA_1 * PQ[c0] * PQ[d0] * (-1.0) + PB_1 * PA_1 * PQ[c0] * QD_0 * (-1.0) + PB_1 * PA_1 * PQ[d0] * QC_0 * (-1.0) + PB_1 * PQ[a1] * PQ[c0] * PQ[d0] + PB_1 * PQ[a1] * PQ[c0] * QD_0 + PB_1 * PQ[a1] * PQ[d0] * QC_0 + PA_1 * PQ[b1] * PQ[c0] * PQ[d0] + PA_1 * PQ[b1] * PQ[c0] * QD_0 + PA_1 * PQ[b1] * PQ[d0] * QC_0)
                            + delta[a0][b0] * delta[c1][d0] * (PB_1 * PA_1 * PQ[c0] * PQ[d1] * (-1.0) + PB_1 * PA_1 * PQ[c0] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[d1] * QC_0 * (-1.0) + PB_1 * PQ[a1] * PQ[c0] * PQ[d1] + PB_1 * PQ[a1] * PQ[c0] * QD_1 + PB_1 * PQ[a1] * PQ[d1] * QC_0 + PA_1 * PQ[b1] * PQ[c0] * PQ[d1] + PA_1 * PQ[b1] * PQ[c0] * QD_1 + PA_1 * PQ[b1] * PQ[d1] * QC_0)
                            + delta[a0][d0] * delta[b0][d1] * (PB_1 * PA_1 * PQ[c0] * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * (PB_1 * PA_1 * PQ[c0] * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][d1] * (PB_1 * PA_1 * PQ[c0] * QD_0 * (-1.0) + PB_1 * PA_1 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][c1] * (PB_1 * PA_1 * PQ[c0] * QD_0 * (-1.0) + PB_1 * PA_1 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][d0] * (PB_1 * PA_1 * PQ[c0] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b0][c1] * (PB_1 * PA_1 * PQ[c0] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * PA_1 * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PA_1 * PQ[c1] * QD_0 * (-1.0) + PB_1 * PA_1 * PQ[d0] * QC_1 * (-1.0) + PB_1 * PQ[a1] * PQ[c1] * PQ[d0] + PB_1 * PQ[a1] * PQ[c1] * QD_0 + PB_1 * PQ[a1] * PQ[d0] * QC_1 + PA_1 * PQ[b1] * PQ[c1] * PQ[d0] + PA_1 * PQ[b1] * PQ[c1] * QD_0 + PA_1 * PQ[b1] * PQ[d0] * QC_1)
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PA_1 * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PA_1 * PQ[c1] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[d1] * QC_1 * (-1.0) + PB_1 * PQ[a1] * PQ[c1] * PQ[d1] + PB_1 * PQ[a1] * PQ[c1] * QD_1 + PB_1 * PQ[a1] * PQ[d1] * QC_1 + PA_1 * PQ[b1] * PQ[c1] * PQ[d1] + PA_1 * PQ[b1] * PQ[c1] * QD_1 + PA_1 * PQ[b1] * PQ[d1] * QC_1)
                            + delta[a0][c0] * delta[b0][d1] * (PB_1 * PA_1 * PQ[c1] * QD_0 * (-1.0) + PB_1 * PA_1 * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[b0][c0] * (PB_1 * PA_1 * PQ[c1] * QD_0 * (-1.0) + PB_1 * PA_1 * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[b0][d0] * (PB_1 * PA_1 * PQ[c1] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][c0] * (PB_1 * PA_1 * PQ[c1] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[c0][c1] * (PB_1 * PA_1 * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PA_1 * PQ[d0] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[a1] * PQ[d0] * PQ[d1] + PB_1 * PQ[a1] * PQ[d0] * QD_1 + PB_1 * PQ[a1] * PQ[d1] * QD_0 + PA_1 * PQ[b1] * PQ[d0] * PQ[d1] + PA_1 * PQ[b1] * PQ[d0] * QD_1 + PA_1 * PQ[b1] * PQ[d1] * QD_0)
                            + delta[a0][c0] * delta[b0][c1] * (PB_1 * PA_1 * PQ[d0] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][c0] * (PB_1 * PA_1 * PQ[d0] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * (PA_1 * PQ[c0] * PQ[c1] * QD_0 + PA_1 * PQ[c0] * PQ[d0] * QC_1 + PA_1 * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a0][b0] * delta[b1][d1] * (PA_1 * PQ[c0] * PQ[c1] * QD_0 + PA_1 * PQ[c0] * PQ[d0] * QC_1 + PA_1 * PQ[c1] * PQ[d0] * QC_0)
                            + delta[b0][d1] * delta[a0][b1] * (PA_1 * PQ[c0] * PQ[c1] * QD_0 + PA_1 * PQ[c0] * PQ[d0] * QC_1 + PA_1 * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a0][d0] * delta[b0][b1] * (PA_1 * PQ[c0] * PQ[c1] * QD_1 + PA_1 * PQ[c0] * PQ[d1] * QC_1 + PA_1 * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a0][b0] * delta[b1][d0] * (PA_1 * PQ[c0] * PQ[c1] * QD_1 + PA_1 * PQ[c0] * PQ[d1] * QC_1 + PA_1 * PQ[c1] * PQ[d1] * QC_0)
                            + delta[b0][d0] * delta[a0][b1] * (PA_1 * PQ[c0] * PQ[c1] * QD_1 + PA_1 * PQ[c0] * PQ[d1] * QC_1 + PA_1 * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a0][c1] * delta[b0][b1] * (PA_1 * PQ[c0] * PQ[d0] * QD_1 + PA_1 * PQ[c0] * PQ[d1] * QD_0 + PA_1 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][b0] * delta[b1][c1] * (PA_1 * PQ[c0] * PQ[d0] * QD_1 + PA_1 * PQ[c0] * PQ[d1] * QD_0 + PA_1 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[b0][c1] * delta[a0][b1] * (PA_1 * PQ[c0] * PQ[d0] * QD_1 + PA_1 * PQ[c0] * PQ[d1] * QD_0 + PA_1 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][c0] * delta[b0][b1] * (PA_1 * PQ[c1] * PQ[d0] * QD_1 + PA_1 * PQ[c1] * PQ[d1] * QD_0 + PA_1 * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a0][b0] * delta[b1][c0] * (PA_1 * PQ[c1] * PQ[d0] * QD_1 + PA_1 * PQ[c1] * PQ[d1] * QD_0 + PA_1 * PQ[d0] * PQ[d1] * QC_1)
                            + delta[b0][c0] * delta[a0][b1] * (PA_1 * PQ[c1] * PQ[d0] * QD_1 + PA_1 * PQ[c1] * PQ[d1] * QD_0 + PA_1 * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a0][a1] * delta[d0][d1] * (PB_0 * PB_1 * PQ[c0] * PQ[c1] * (-1.0) + PB_0 * PB_1 * PQ[c0] * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[c1] * QC_0 * (-1.0) + PB_0 * PQ[b1] * PQ[c0] * PQ[c1] + PB_0 * PQ[b1] * PQ[c0] * QC_1 + PB_0 * PQ[b1] * PQ[c1] * QC_0 + PB_1 * PQ[b0] * PQ[c0] * PQ[c1] + PB_1 * PQ[b0] * PQ[c0] * QC_1 + PB_1 * PQ[b0] * PQ[c1] * QC_0)
                            + delta[a0][a1] * delta[c1][d1] * (PB_0 * PB_1 * PQ[c0] * PQ[d0] * (-1.0) + PB_0 * PB_1 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PB_1 * PQ[d0] * QC_0 * (-1.0) + PB_0 * PQ[b1] * PQ[c0] * PQ[d0] + PB_0 * PQ[b1] * PQ[c0] * QD_0 + PB_0 * PQ[b1] * PQ[d0] * QC_0 + PB_1 * PQ[b0] * PQ[c0] * PQ[d0] + PB_1 * PQ[b0] * PQ[c0] * QD_0 + PB_1 * PQ[b0] * PQ[d0] * QC_0)
                            + delta[a0][a1] * delta[c1][d0] * (PB_0 * PB_1 * PQ[c0] * PQ[d1] * (-1.0) + PB_0 * PB_1 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[d1] * QC_0 * (-1.0) + PB_0 * PQ[b1] * PQ[c0] * PQ[d1] + PB_0 * PQ[b1] * PQ[c0] * QD_1 + PB_0 * PQ[b1] * PQ[d1] * QC_0 + PB_1 * PQ[b0] * PQ[c0] * PQ[d1] + PB_1 * PQ[b0] * PQ[c0] * QD_1 + PB_1 * PQ[b0] * PQ[d1] * QC_0)
                            + delta[a0][d0] * delta[a1][d1] * (PB_0 * PB_1 * PQ[c0] * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][d0] * (PB_0 * PB_1 * PQ[c0] * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[a1][d1] * (PB_0 * PB_1 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PB_1 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][c1] * (PB_0 * PB_1 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PB_1 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[a1][d0] * (PB_0 * PB_1 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[a1][c1] * (PB_0 * PB_1 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[c0][d1] * (PB_0 * PB_1 * PQ[c1] * PQ[d0] * (-1.0) + PB_0 * PB_1 * PQ[c1] * QD_0 * (-1.0) + PB_0 * PB_1 * PQ[d0] * QC_1 * (-1.0) + PB_0 * PQ[b1] * PQ[c1] * PQ[d0] + PB_0 * PQ[b1] * PQ[c1] * QD_0 + PB_0 * PQ[b1] * PQ[d0] * QC_1 + PB_1 * PQ[b0] * PQ[c1] * PQ[d0] + PB_1 * PQ[b0] * PQ[c1] * QD_0 + PB_1 * PQ[b0] * PQ[d0] * QC_1)
                            + delta[a0][a1] * delta[c0][d0] * (PB_0 * PB_1 * PQ[c1] * PQ[d1] * (-1.0) + PB_0 * PB_1 * PQ[c1] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[d1] * QC_1 * (-1.0) + PB_0 * PQ[b1] * PQ[c1] * PQ[d1] + PB_0 * PQ[b1] * PQ[c1] * QD_1 + PB_0 * PQ[b1] * PQ[d1] * QC_1 + PB_1 * PQ[b0] * PQ[c1] * PQ[d1] + PB_1 * PQ[b0] * PQ[c1] * QD_1 + PB_1 * PQ[b0] * PQ[d1] * QC_1)
                            + delta[a0][c0] * delta[a1][d1] * (PB_0 * PB_1 * PQ[c1] * QD_0 * (-1.0) + PB_0 * PB_1 * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[a1][c0] * (PB_0 * PB_1 * PQ[c1] * QD_0 * (-1.0) + PB_0 * PB_1 * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[a1][d0] * (PB_0 * PB_1 * PQ[c1] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][c0] * (PB_0 * PB_1 * PQ[c1] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[c0][c1] * (PB_0 * PB_1 * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PB_1 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[b1] * PQ[d0] * PQ[d1] + PB_0 * PQ[b1] * PQ[d0] * QD_1 + PB_0 * PQ[b1] * PQ[d1] * QD_0 + PB_1 * PQ[b0] * PQ[d0] * PQ[d1] + PB_1 * PQ[b0] * PQ[d0] * QD_1 + PB_1 * PQ[b0] * PQ[d1] * QD_0)
                            + delta[a0][c0] * delta[a1][c1] * (PB_0 * PB_1 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[a1][c0] * (PB_0 * PB_1 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][b1] * (PB_0 * PQ[c0] * PQ[c1] * QD_0 + PB_0 * PQ[c0] * PQ[d0] * QC_1 + PB_0 * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a0][a1] * delta[b1][d1] * (PB_0 * PQ[c0] * PQ[c1] * QD_0 + PB_0 * PQ[c0] * PQ[d0] * QC_1 + PB_0 * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a1][d1] * delta[a0][b1] * (PB_0 * PQ[c0] * PQ[c1] * QD_0 + PB_0 * PQ[c0] * PQ[d0] * QC_1 + PB_0 * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a0][d0] * delta[a1][b1] * (PB_0 * PQ[c0] * PQ[c1] * QD_1 + PB_0 * PQ[c0] * PQ[d1] * QC_1 + PB_0 * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a0][a1] * delta[b1][d0] * (PB_0 * PQ[c0] * PQ[c1] * QD_1 + PB_0 * PQ[c0] * PQ[d1] * QC_1 + PB_0 * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a1][d0] * delta[a0][b1] * (PB_0 * PQ[c0] * PQ[c1] * QD_1 + PB_0 * PQ[c0] * PQ[d1] * QC_1 + PB_0 * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a0][c1] * delta[a1][b1] * (PB_0 * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][a1] * delta[b1][c1] * (PB_0 * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a1][c1] * delta[a0][b1] * (PB_0 * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][c0] * delta[a1][b1] * (PB_0 * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a0][a1] * delta[b1][c0] * (PB_0 * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a1][c0] * delta[a0][b1] * (PB_0 * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a0][d1] * delta[a1][b0] * (PB_1 * PQ[c0] * PQ[c1] * QD_0 + PB_1 * PQ[c0] * PQ[d0] * QC_1 + PB_1 * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a0][a1] * delta[b0][d1] * (PB_1 * PQ[c0] * PQ[c1] * QD_0 + PB_1 * PQ[c0] * PQ[d0] * QC_1 + PB_1 * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a1][d1] * delta[a0][b0] * (PB_1 * PQ[c0] * PQ[c1] * QD_0 + PB_1 * PQ[c0] * PQ[d0] * QC_1 + PB_1 * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a0][d0] * delta[a1][b0] * (PB_1 * PQ[c0] * PQ[c1] * QD_1 + PB_1 * PQ[c0] * PQ[d1] * QC_1 + PB_1 * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a0][a1] * delta[b0][d0] * (PB_1 * PQ[c0] * PQ[c1] * QD_1 + PB_1 * PQ[c0] * PQ[d1] * QC_1 + PB_1 * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a1][d0] * delta[a0][b0] * (PB_1 * PQ[c0] * PQ[c1] * QD_1 + PB_1 * PQ[c0] * PQ[d1] * QC_1 + PB_1 * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a0][c1] * delta[a1][b0] * (PB_1 * PQ[c0] * PQ[d0] * QD_1 + PB_1 * PQ[c0] * PQ[d1] * QD_0 + PB_1 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][a1] * delta[b0][c1] * (PB_1 * PQ[c0] * PQ[d0] * QD_1 + PB_1 * PQ[c0] * PQ[d1] * QD_0 + PB_1 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a1][c1] * delta[a0][b0] * (PB_1 * PQ[c0] * PQ[d0] * QD_1 + PB_1 * PQ[c0] * PQ[d1] * QD_0 + PB_1 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][c0] * delta[a1][b0] * (PB_1 * PQ[c1] * PQ[d0] * QD_1 + PB_1 * PQ[c1] * PQ[d1] * QD_0 + PB_1 * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a0][a1] * delta[b0][c0] * (PB_1 * PQ[c1] * PQ[d0] * QD_1 + PB_1 * PQ[c1] * PQ[d1] * QD_0 + PB_1 * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a1][c0] * delta[a0][b0] * (PB_1 * PQ[c1] * PQ[d0] * QD_1 + PB_1 * PQ[c1] * PQ[d1] * QD_0 + PB_1 * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a0][a1] * delta[b0][b1] * (PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * (PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * (PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD21(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[4];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[3] * (

                        0.25 * S2 / ( S4 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] + PA_1 * PQ[a0] * PQ[b0] * PQ[b1])
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] + PA_1 * PQ[a0] * PQ[b0] * PQ[b1])
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] + PA_1 * PQ[a0] * PQ[b0] * PQ[b1])
                            + delta[b1][c1] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[a1] * QC_0 + PA_0 * PQ[a1] * PQ[b0] * QC_0 + PA_1 * PQ[a0] * PQ[b0] * QC_0)
                            + delta[b1][d0] * delta[c1][d1] * (PB_0 * PQ[a0] * PQ[a1] * QC_0 + PA_0 * PQ[a1] * PQ[b0] * QC_0 + PA_1 * PQ[a0] * PQ[b0] * QC_0)
                            + delta[b1][d1] * delta[c1][d0] * (PB_0 * PQ[a0] * PQ[a1] * QC_0 + PA_0 * PQ[a1] * PQ[b0] * QC_0 + PA_1 * PQ[a0] * PQ[b0] * QC_0)
                            + delta[b1][c0] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[a1] * QC_1 + PA_0 * PQ[a1] * PQ[b0] * QC_1 + PA_1 * PQ[a0] * PQ[b0] * QC_1)
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[a1] * QC_1 + PA_0 * PQ[a1] * PQ[b0] * QC_1 + PA_1 * PQ[a0] * PQ[b0] * QC_1)
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * PQ[a0] * PQ[a1] * QC_1 + PA_0 * PQ[a1] * PQ[b0] * QC_1 + PA_1 * PQ[a0] * PQ[b0] * QC_1)
                            + delta[b1][c0] * delta[c1][d1] * (PB_0 * PQ[a0] * PQ[a1] * QD_0 + PA_0 * PQ[a1] * PQ[b0] * QD_0 + PA_1 * PQ[a0] * PQ[b0] * QD_0)
                            + delta[b1][c1] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[a1] * QD_0 + PA_0 * PQ[a1] * PQ[b0] * QD_0 + PA_1 * PQ[a0] * PQ[b0] * QD_0)
                            + delta[b1][d1] * delta[c0][c1] * (PB_0 * PQ[a0] * PQ[a1] * QD_0 + PA_0 * PQ[a1] * PQ[b0] * QD_0 + PA_1 * PQ[a0] * PQ[b0] * QD_0)
                            + delta[b1][c0] * delta[c1][d0] * (PB_0 * PQ[a0] * PQ[a1] * QD_1 + PA_0 * PQ[a1] * PQ[b0] * QD_1 + PA_1 * PQ[a0] * PQ[b0] * QD_1)
                            + delta[b1][c1] * delta[c0][d0] * (PB_0 * PQ[a0] * PQ[a1] * QD_1 + PA_0 * PQ[a1] * PQ[b0] * QD_1 + PA_1 * PQ[a0] * PQ[b0] * QD_1)
                            + delta[b1][d0] * delta[c0][c1] * (PB_0 * PQ[a0] * PQ[a1] * QD_1 + PA_0 * PQ[a1] * PQ[b0] * QD_1 + PA_1 * PQ[a0] * PQ[b0] * QD_1)
                            + delta[b0][c1] * delta[d0][d1] * (PB_1 * PQ[a0] * PQ[a1] * QC_0 + PA_0 * PQ[a1] * PQ[b1] * QC_0 + PA_1 * PQ[a0] * PQ[b1] * QC_0)
                            + delta[b0][d0] * delta[c1][d1] * (PB_1 * PQ[a0] * PQ[a1] * QC_0 + PA_0 * PQ[a1] * PQ[b1] * QC_0 + PA_1 * PQ[a0] * PQ[b1] * QC_0)
                            + delta[b0][d1] * delta[c1][d0] * (PB_1 * PQ[a0] * PQ[a1] * QC_0 + PA_0 * PQ[a1] * PQ[b1] * QC_0 + PA_1 * PQ[a0] * PQ[b1] * QC_0)
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * PQ[a0] * PQ[a1] * QC_1 + PA_0 * PQ[a1] * PQ[b1] * QC_1 + PA_1 * PQ[a0] * PQ[b1] * QC_1)
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * PQ[a0] * PQ[a1] * QC_1 + PA_0 * PQ[a1] * PQ[b1] * QC_1 + PA_1 * PQ[a0] * PQ[b1] * QC_1)
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * PQ[a0] * PQ[a1] * QC_1 + PA_0 * PQ[a1] * PQ[b1] * QC_1 + PA_1 * PQ[a0] * PQ[b1] * QC_1)
                            + delta[b0][c0] * delta[c1][d1] * (PB_1 * PQ[a0] * PQ[a1] * QD_0 + PA_0 * PQ[a1] * PQ[b1] * QD_0 + PA_1 * PQ[a0] * PQ[b1] * QD_0)
                            + delta[b0][c1] * delta[c0][d1] * (PB_1 * PQ[a0] * PQ[a1] * QD_0 + PA_0 * PQ[a1] * PQ[b1] * QD_0 + PA_1 * PQ[a0] * PQ[b1] * QD_0)
                            + delta[b0][d1] * delta[c0][c1] * (PB_1 * PQ[a0] * PQ[a1] * QD_0 + PA_0 * PQ[a1] * PQ[b1] * QD_0 + PA_1 * PQ[a0] * PQ[b1] * QD_0)
                            + delta[b0][c0] * delta[c1][d0] * (PB_1 * PQ[a0] * PQ[a1] * QD_1 + PA_0 * PQ[a1] * PQ[b1] * QD_1 + PA_1 * PQ[a0] * PQ[b1] * QD_1)
                            + delta[b0][c1] * delta[c0][d0] * (PB_1 * PQ[a0] * PQ[a1] * QD_1 + PA_0 * PQ[a1] * PQ[b1] * QD_1 + PA_1 * PQ[a0] * PQ[b1] * QD_1)
                            + delta[b0][d0] * delta[c0][c1] * (PB_1 * PQ[a0] * PQ[a1] * QD_1 + PA_0 * PQ[a1] * PQ[b1] * QD_1 + PA_1 * PQ[a0] * PQ[b1] * QD_1)
                            + delta[b0][b1] * delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[c0] * QC_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[c1] * QC_0 * (-1.0) + PQ[a0] * PQ[a1] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[c0] * QC_1 + PA_0 * PQ[a1] * PQ[c1] * QC_0 + PA_0 * PQ[a1] * QC_0 * QC_1 + PA_1 * PQ[a0] * PQ[c0] * QC_1 + PA_1 * PQ[a0] * PQ[c1] * QC_0 + PA_1 * PQ[a0] * QC_0 * QC_1)
                            + delta[b0][b1] * delta[c1][d1] * (PQ[a0] * PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d0] * QC_0 * (-1.0) + PQ[a0] * PQ[a1] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[c0] * QD_0 + PA_0 * PQ[a1] * PQ[d0] * QC_0 + PA_0 * PQ[a1] * QD_0 * QC_0 + PA_1 * PQ[a0] * PQ[c0] * QD_0 + PA_1 * PQ[a0] * PQ[d0] * QC_0 + PA_1 * PQ[a0] * QD_0 * QC_0)
                            + delta[b0][b1] * delta[c1][d0] * (PQ[a0] * PQ[a1] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d1] * QC_0 * (-1.0) + PQ[a0] * PQ[a1] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[c0] * QD_1 + PA_0 * PQ[a1] * PQ[d1] * QC_0 + PA_0 * PQ[a1] * QD_1 * QC_0 + PA_1 * PQ[a0] * PQ[c0] * QD_1 + PA_1 * PQ[a0] * PQ[d1] * QC_0 + PA_1 * PQ[a0] * QD_1 * QC_0)
                            + delta[b0][b1] * delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[c1] * QD_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d0] * QC_1 * (-1.0) + PQ[a0] * PQ[a1] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[c1] * QD_0 + PA_0 * PQ[a1] * PQ[d0] * QC_1 + PA_0 * PQ[a1] * QD_0 * QC_1 + PA_1 * PQ[a0] * PQ[c1] * QD_0 + PA_1 * PQ[a0] * PQ[d0] * QC_1 + PA_1 * PQ[a0] * QD_0 * QC_1)
                            + delta[b0][b1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[c1] * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d1] * QC_1 * (-1.0) + PQ[a0] * PQ[a1] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[c1] * QD_1 + PA_0 * PQ[a1] * PQ[d1] * QC_1 + PA_0 * PQ[a1] * QD_1 * QC_1 + PA_1 * PQ[a0] * PQ[c1] * QD_1 + PA_1 * PQ[a0] * PQ[d1] * QC_1 + PA_1 * PQ[a0] * QD_1 * QC_1)
                            + delta[b0][b1] * delta[c0][c1] * (PQ[a0] * PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d1] * QD_0 * (-1.0) + PQ[a0] * PQ[a1] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[d0] * QD_1 + PA_0 * PQ[a1] * PQ[d1] * QD_0 + PA_0 * PQ[a1] * QD_0 * QD_1 + PA_1 * PQ[a0] * PQ[d0] * QD_1 + PA_1 * PQ[a0] * PQ[d1] * QD_0 + PA_1 * PQ[a0] * QD_0 * QD_1)
                            + delta[b0][d0] * delta[b1][d1] * (PA_0 * PQ[a1] * QC_0 * QC_1 + PA_1 * PQ[a0] * QC_0 * QC_1)
                            + delta[b0][d1] * delta[b1][d0] * (PA_0 * PQ[a1] * QC_0 * QC_1 + PA_1 * PQ[a0] * QC_0 * QC_1)
                            + delta[b0][c1] * delta[b1][d1] * (PA_0 * PQ[a1] * QD_0 * QC_0 + PA_1 * PQ[a0] * QD_0 * QC_0)
                            + delta[b0][d1] * delta[b1][c1] * (PA_0 * PQ[a1] * QD_0 * QC_0 + PA_1 * PQ[a0] * QD_0 * QC_0)
                            + delta[b0][c1] * delta[b1][d0] * (PA_0 * PQ[a1] * QD_1 * QC_0 + PA_1 * PQ[a0] * QD_1 * QC_0)
                            + delta[b0][d0] * delta[b1][c1] * (PA_0 * PQ[a1] * QD_1 * QC_0 + PA_1 * PQ[a0] * QD_1 * QC_0)
                            + delta[b0][c0] * delta[b1][d1] * (PA_0 * PQ[a1] * QD_0 * QC_1 + PA_1 * PQ[a0] * QD_0 * QC_1)
                            + delta[b0][d1] * delta[b1][c0] * (PA_0 * PQ[a1] * QD_0 * QC_1 + PA_1 * PQ[a0] * QD_0 * QC_1)
                            + delta[b0][c0] * delta[b1][d0] * (PA_0 * PQ[a1] * QD_1 * QC_1 + PA_1 * PQ[a0] * QD_1 * QC_1)
                            + delta[b0][d0] * delta[b1][c0] * (PA_0 * PQ[a1] * QD_1 * QC_1 + PA_1 * PQ[a0] * QD_1 * QC_1)
                            + delta[b0][c0] * delta[b1][c1] * (PA_0 * PQ[a1] * QD_0 * QD_1 + PA_1 * PQ[a0] * QD_0 * QD_1)
                            + delta[b0][c1] * delta[b1][c0] * (PA_0 * PQ[a1] * QD_0 * QD_1 + PA_1 * PQ[a0] * QD_0 * QD_1)
                            + delta[a1][c1] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[b1] * QC_0 + PB_1 * PQ[a0] * PQ[b0] * QC_0 + PA_0 * PQ[b0] * PQ[b1] * QC_0)
                            + delta[a1][d0] * delta[c1][d1] * (PB_0 * PQ[a0] * PQ[b1] * QC_0 + PB_1 * PQ[a0] * PQ[b0] * QC_0 + PA_0 * PQ[b0] * PQ[b1] * QC_0)
                            + delta[a1][d1] * delta[c1][d0] * (PB_0 * PQ[a0] * PQ[b1] * QC_0 + PB_1 * PQ[a0] * PQ[b0] * QC_0 + PA_0 * PQ[b0] * PQ[b1] * QC_0)
                            + delta[a1][c0] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[b1] * QC_1 + PB_1 * PQ[a0] * PQ[b0] * QC_1 + PA_0 * PQ[b0] * PQ[b1] * QC_1)
                            + delta[a1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[b1] * QC_1 + PB_1 * PQ[a0] * PQ[b0] * QC_1 + PA_0 * PQ[b0] * PQ[b1] * QC_1)
                            + delta[a1][d1] * delta[c0][d0] * (PB_0 * PQ[a0] * PQ[b1] * QC_1 + PB_1 * PQ[a0] * PQ[b0] * QC_1 + PA_0 * PQ[b0] * PQ[b1] * QC_1)
                            + delta[a1][c0] * delta[c1][d1] * (PB_0 * PQ[a0] * PQ[b1] * QD_0 + PB_1 * PQ[a0] * PQ[b0] * QD_0 + PA_0 * PQ[b0] * PQ[b1] * QD_0)
                            + delta[a1][c1] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[b1] * QD_0 + PB_1 * PQ[a0] * PQ[b0] * QD_0 + PA_0 * PQ[b0] * PQ[b1] * QD_0)
                            + delta[a1][d1] * delta[c0][c1] * (PB_0 * PQ[a0] * PQ[b1] * QD_0 + PB_1 * PQ[a0] * PQ[b0] * QD_0 + PA_0 * PQ[b0] * PQ[b1] * QD_0)
                            + delta[a1][c0] * delta[c1][d0] * (PB_0 * PQ[a0] * PQ[b1] * QD_1 + PB_1 * PQ[a0] * PQ[b0] * QD_1 + PA_0 * PQ[b0] * PQ[b1] * QD_1)
                            + delta[a1][c1] * delta[c0][d0] * (PB_0 * PQ[a0] * PQ[b1] * QD_1 + PB_1 * PQ[a0] * PQ[b0] * QD_1 + PA_0 * PQ[b0] * PQ[b1] * QD_1)
                            + delta[a1][d0] * delta[c0][c1] * (PB_0 * PQ[a0] * PQ[b1] * QD_1 + PB_1 * PQ[a0] * PQ[b0] * QD_1 + PA_0 * PQ[b0] * PQ[b1] * QD_1)
                            + delta[a1][b1] * delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[c1] * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * QC_0 * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[c0] * QC_1 + PB_0 * PQ[a0] * PQ[c1] * QC_0 + PB_0 * PQ[a0] * QC_0 * QC_1 + PA_0 * PQ[b0] * PQ[c0] * QC_1 + PA_0 * PQ[b0] * PQ[c1] * QC_0 + PA_0 * PQ[b0] * QC_0 * QC_1)
                            + delta[a1][b1] * delta[c1][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[c0] * QD_0 + PB_0 * PQ[a0] * PQ[d0] * QC_0 + PB_0 * PQ[a0] * QD_0 * QC_0 + PA_0 * PQ[b0] * PQ[c0] * QD_0 + PA_0 * PQ[b0] * PQ[d0] * QC_0 + PA_0 * PQ[b0] * QD_0 * QC_0)
                            + delta[a1][b1] * delta[c1][d0] * (PQ[a0] * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d1] * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[c0] * QD_1 + PB_0 * PQ[a0] * PQ[d1] * QC_0 + PB_0 * PQ[a0] * QD_1 * QC_0 + PA_0 * PQ[b0] * PQ[c0] * QD_1 + PA_0 * PQ[b0] * PQ[d1] * QC_0 + PA_0 * PQ[b0] * QD_1 * QC_0)
                            + delta[a1][b1] * delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d0] * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * QD_0 * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[c1] * QD_0 + PB_0 * PQ[a0] * PQ[d0] * QC_1 + PB_0 * PQ[a0] * QD_0 * QC_1 + PA_0 * PQ[b0] * PQ[c1] * QD_0 + PA_0 * PQ[b0] * PQ[d0] * QC_1 + PA_0 * PQ[b0] * QD_0 * QC_1)
                            + delta[a1][b1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d1] * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[c1] * QD_1 + PB_0 * PQ[a0] * PQ[d1] * QC_1 + PB_0 * PQ[a0] * QD_1 * QC_1 + PA_0 * PQ[b0] * PQ[c1] * QD_1 + PA_0 * PQ[b0] * PQ[d1] * QC_1 + PA_0 * PQ[b0] * QD_1 * QC_1)
                            + delta[a1][b1] * delta[c0][c1] * (PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PQ[a0] * PQ[b0] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[d0] * QD_1 + PB_0 * PQ[a0] * PQ[d1] * QD_0 + PB_0 * PQ[a0] * QD_0 * QD_1 + PA_0 * PQ[b0] * PQ[d0] * QD_1 + PA_0 * PQ[b0] * PQ[d1] * QD_0 + PA_0 * PQ[b0] * QD_0 * QD_1)
                            + delta[a1][d0] * delta[b1][d1] * (PB_0 * PQ[a0] * QC_0 * QC_1 + PA_0 * PQ[b0] * QC_0 * QC_1)
                            + delta[a1][d1] * delta[b1][d0] * (PB_0 * PQ[a0] * QC_0 * QC_1 + PA_0 * PQ[b0] * QC_0 * QC_1)
                            + delta[a1][c1] * delta[b1][d1] * (PB_0 * PQ[a0] * QD_0 * QC_0 + PA_0 * PQ[b0] * QD_0 * QC_0)
                            + delta[a1][d1] * delta[b1][c1] * (PB_0 * PQ[a0] * QD_0 * QC_0 + PA_0 * PQ[b0] * QD_0 * QC_0)
                            + delta[a1][c1] * delta[b1][d0] * (PB_0 * PQ[a0] * QD_1 * QC_0 + PA_0 * PQ[b0] * QD_1 * QC_0)
                            + delta[a1][d0] * delta[b1][c1] * (PB_0 * PQ[a0] * QD_1 * QC_0 + PA_0 * PQ[b0] * QD_1 * QC_0)
                            + delta[a1][c0] * delta[b1][d1] * (PB_0 * PQ[a0] * QD_0 * QC_1 + PA_0 * PQ[b0] * QD_0 * QC_1)
                            + delta[a1][d1] * delta[b1][c0] * (PB_0 * PQ[a0] * QD_0 * QC_1 + PA_0 * PQ[b0] * QD_0 * QC_1)
                            + delta[a1][c0] * delta[b1][d0] * (PB_0 * PQ[a0] * QD_1 * QC_1 + PA_0 * PQ[b0] * QD_1 * QC_1)
                            + delta[a1][d0] * delta[b1][c0] * (PB_0 * PQ[a0] * QD_1 * QC_1 + PA_0 * PQ[b0] * QD_1 * QC_1)
                            + delta[a1][c0] * delta[b1][c1] * (PB_0 * PQ[a0] * QD_0 * QD_1 + PA_0 * PQ[b0] * QD_0 * QD_1)
                            + delta[a1][c1] * delta[b1][c0] * (PB_0 * PQ[a0] * QD_0 * QD_1 + PA_0 * PQ[b0] * QD_0 * QD_1)
                            + delta[a1][b0] * delta[d0][d1] * (PQ[a0] * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[c1] * QC_0 * (-1.0) + PQ[a0] * PQ[b1] * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[c0] * QC_1 + PB_1 * PQ[a0] * PQ[c1] * QC_0 + PB_1 * PQ[a0] * QC_0 * QC_1 + PA_0 * PQ[b1] * PQ[c0] * QC_1 + PA_0 * PQ[b1] * PQ[c1] * QC_0 + PA_0 * PQ[b1] * QC_0 * QC_1)
                            + delta[a1][b0] * delta[c1][d1] * (PQ[a0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PQ[a0] * PQ[b1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[c0] * QD_0 + PB_1 * PQ[a0] * PQ[d0] * QC_0 + PB_1 * PQ[a0] * QD_0 * QC_0 + PA_0 * PQ[b1] * PQ[c0] * QD_0 + PA_0 * PQ[b1] * PQ[d0] * QC_0 + PA_0 * PQ[b1] * QD_0 * QC_0)
                            + delta[a1][b0] * delta[c1][d0] * (PQ[a0] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PQ[a0] * PQ[b1] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[c0] * QD_1 + PB_1 * PQ[a0] * PQ[d1] * QC_0 + PB_1 * PQ[a0] * QD_1 * QC_0 + PA_0 * PQ[b1] * PQ[c0] * QD_1 + PA_0 * PQ[b1] * PQ[d1] * QC_0 + PA_0 * PQ[b1] * QD_1 * QC_0)
                            + delta[a1][b0] * delta[c0][d1] * (PQ[a0] * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d0] * QC_1 * (-1.0) + PQ[a0] * PQ[b1] * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[c1] * QD_0 + PB_1 * PQ[a0] * PQ[d0] * QC_1 + PB_1 * PQ[a0] * QD_0 * QC_1 + PA_0 * PQ[b1] * PQ[c1] * QD_0 + PA_0 * PQ[b1] * PQ[d0] * QC_1 + PA_0 * PQ[b1] * QD_0 * QC_1)
                            + delta[a1][b0] * delta[c0][d0] * (PQ[a0] * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d1] * QC_1 * (-1.0) + PQ[a0] * PQ[b1] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[c1] * QD_1 + PB_1 * PQ[a0] * PQ[d1] * QC_1 + PB_1 * PQ[a0] * QD_1 * QC_1 + PA_0 * PQ[b1] * PQ[c1] * QD_1 + PA_0 * PQ[b1] * PQ[d1] * QC_1 + PA_0 * PQ[b1] * QD_1 * QC_1)
                            + delta[a1][b0] * delta[c0][c1] * (PQ[a0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PQ[a0] * PQ[b1] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[d0] * QD_1 + PB_1 * PQ[a0] * PQ[d1] * QD_0 + PB_1 * PQ[a0] * QD_0 * QD_1 + PA_0 * PQ[b1] * PQ[d0] * QD_1 + PA_0 * PQ[b1] * PQ[d1] * QD_0 + PA_0 * PQ[b1] * QD_0 * QD_1)
                            + delta[a1][d0] * delta[b0][d1] * (PB_1 * PQ[a0] * QC_0 * QC_1 + PA_0 * PQ[b1] * QC_0 * QC_1)
                            + delta[a1][d1] * delta[b0][d0] * (PB_1 * PQ[a0] * QC_0 * QC_1 + PA_0 * PQ[b1] * QC_0 * QC_1)
                            + delta[a1][c1] * delta[b0][d1] * (PB_1 * PQ[a0] * QD_0 * QC_0 + PA_0 * PQ[b1] * QD_0 * QC_0)
                            + delta[a1][d1] * delta[b0][c1] * (PB_1 * PQ[a0] * QD_0 * QC_0 + PA_0 * PQ[b1] * QD_0 * QC_0)
                            + delta[a1][c1] * delta[b0][d0] * (PB_1 * PQ[a0] * QD_1 * QC_0 + PA_0 * PQ[b1] * QD_1 * QC_0)
                            + delta[a1][d0] * delta[b0][c1] * (PB_1 * PQ[a0] * QD_1 * QC_0 + PA_0 * PQ[b1] * QD_1 * QC_0)
                            + delta[a1][c0] * delta[b0][d1] * (PB_1 * PQ[a0] * QD_0 * QC_1 + PA_0 * PQ[b1] * QD_0 * QC_1)
                            + delta[a1][d1] * delta[b0][c0] * (PB_1 * PQ[a0] * QD_0 * QC_1 + PA_0 * PQ[b1] * QD_0 * QC_1)
                            + delta[a1][c0] * delta[b0][d0] * (PB_1 * PQ[a0] * QD_1 * QC_1 + PA_0 * PQ[b1] * QD_1 * QC_1)
                            + delta[a1][d0] * delta[b0][c0] * (PB_1 * PQ[a0] * QD_1 * QC_1 + PA_0 * PQ[b1] * QD_1 * QC_1)
                            + delta[a1][c0] * delta[b0][c1] * (PB_1 * PQ[a0] * QD_0 * QD_1 + PA_0 * PQ[b1] * QD_0 * QD_1)
                            + delta[a1][c1] * delta[b0][c0] * (PB_1 * PQ[a0] * QD_0 * QD_1 + PA_0 * PQ[b1] * QD_0 * QD_1)
                            + delta[a1][d1] * delta[b0][b1] * (PQ[a0] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PQ[a0] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PQ[a0] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[c0] * QD_0 * QC_1 + PA_0 * PQ[c1] * QD_0 * QC_0 + PA_0 * PQ[d0] * QC_0 * QC_1)
                            + delta[a1][b0] * delta[b1][d1] * (PQ[a0] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PQ[a0] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PQ[a0] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[c0] * QD_0 * QC_1 + PA_0 * PQ[c1] * QD_0 * QC_0 + PA_0 * PQ[d0] * QC_0 * QC_1)
                            + delta[b0][d1] * delta[a1][b1] * (PQ[a0] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PQ[a0] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PQ[a0] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[c0] * QD_0 * QC_1 + PA_0 * PQ[c1] * QD_0 * QC_0 + PA_0 * PQ[d0] * QC_0 * QC_1)
                            + delta[a1][d0] * delta[b0][b1] * (PQ[a0] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[c0] * QD_1 * QC_1 + PA_0 * PQ[c1] * QD_1 * QC_0 + PA_0 * PQ[d1] * QC_0 * QC_1)
                            + delta[a1][b0] * delta[b1][d0] * (PQ[a0] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[c0] * QD_1 * QC_1 + PA_0 * PQ[c1] * QD_1 * QC_0 + PA_0 * PQ[d1] * QC_0 * QC_1)
                            + delta[b0][d0] * delta[a1][b1] * (PQ[a0] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[c0] * QD_1 * QC_1 + PA_0 * PQ[c1] * QD_1 * QC_0 + PA_0 * PQ[d1] * QC_0 * QC_1)
                            + delta[a1][c1] * delta[b0][b1] * (PQ[a0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[c0] * QD_0 * QD_1 + PA_0 * PQ[d0] * QD_1 * QC_0 + PA_0 * PQ[d1] * QD_0 * QC_0)
                            + delta[a1][b0] * delta[b1][c1] * (PQ[a0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[c0] * QD_0 * QD_1 + PA_0 * PQ[d0] * QD_1 * QC_0 + PA_0 * PQ[d1] * QD_0 * QC_0)
                            + delta[b0][c1] * delta[a1][b1] * (PQ[a0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[c0] * QD_0 * QD_1 + PA_0 * PQ[d0] * QD_1 * QC_0 + PA_0 * PQ[d1] * QD_0 * QC_0)
                            + delta[a1][c0] * delta[b0][b1] * (PQ[a0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[c1] * QD_0 * QD_1 + PA_0 * PQ[d0] * QD_1 * QC_1 + PA_0 * PQ[d1] * QD_0 * QC_1)
                            + delta[a1][b0] * delta[b1][c0] * (PQ[a0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[c1] * QD_0 * QD_1 + PA_0 * PQ[d0] * QD_1 * QC_1 + PA_0 * PQ[d1] * QD_0 * QC_1)
                            + delta[b0][c0] * delta[a1][b1] * (PQ[a0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[c1] * QD_0 * QD_1 + PA_0 * PQ[d0] * QD_1 * QC_1 + PA_0 * PQ[d1] * QD_0 * QC_1)
                            + delta[a0][c1] * delta[d0][d1] * (PB_0 * PQ[a1] * PQ[b1] * QC_0 + PB_1 * PQ[a1] * PQ[b0] * QC_0 + PA_1 * PQ[b0] * PQ[b1] * QC_0)
                            + delta[a0][d0] * delta[c1][d1] * (PB_0 * PQ[a1] * PQ[b1] * QC_0 + PB_1 * PQ[a1] * PQ[b0] * QC_0 + PA_1 * PQ[b0] * PQ[b1] * QC_0)
                            + delta[a0][d1] * delta[c1][d0] * (PB_0 * PQ[a1] * PQ[b1] * QC_0 + PB_1 * PQ[a1] * PQ[b0] * QC_0 + PA_1 * PQ[b0] * PQ[b1] * QC_0)
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * PQ[a1] * PQ[b1] * QC_1 + PB_1 * PQ[a1] * PQ[b0] * QC_1 + PA_1 * PQ[b0] * PQ[b1] * QC_1)
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * PQ[a1] * PQ[b1] * QC_1 + PB_1 * PQ[a1] * PQ[b0] * QC_1 + PA_1 * PQ[b0] * PQ[b1] * QC_1)
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * PQ[a1] * PQ[b1] * QC_1 + PB_1 * PQ[a1] * PQ[b0] * QC_1 + PA_1 * PQ[b0] * PQ[b1] * QC_1)
                            + delta[a0][c0] * delta[c1][d1] * (PB_0 * PQ[a1] * PQ[b1] * QD_0 + PB_1 * PQ[a1] * PQ[b0] * QD_0 + PA_1 * PQ[b0] * PQ[b1] * QD_0)
                            + delta[a0][c1] * delta[c0][d1] * (PB_0 * PQ[a1] * PQ[b1] * QD_0 + PB_1 * PQ[a1] * PQ[b0] * QD_0 + PA_1 * PQ[b0] * PQ[b1] * QD_0)
                            + delta[a0][d1] * delta[c0][c1] * (PB_0 * PQ[a1] * PQ[b1] * QD_0 + PB_1 * PQ[a1] * PQ[b0] * QD_0 + PA_1 * PQ[b0] * PQ[b1] * QD_0)
                            + delta[a0][c0] * delta[c1][d0] * (PB_0 * PQ[a1] * PQ[b1] * QD_1 + PB_1 * PQ[a1] * PQ[b0] * QD_1 + PA_1 * PQ[b0] * PQ[b1] * QD_1)
                            + delta[a0][c1] * delta[c0][d0] * (PB_0 * PQ[a1] * PQ[b1] * QD_1 + PB_1 * PQ[a1] * PQ[b0] * QD_1 + PA_1 * PQ[b0] * PQ[b1] * QD_1)
                            + delta[a0][d0] * delta[c0][c1] * (PB_0 * PQ[a1] * PQ[b1] * QD_1 + PB_1 * PQ[a1] * PQ[b0] * QD_1 + PA_1 * PQ[b0] * PQ[b1] * QD_1)
                            + delta[a0][b1] * delta[d0][d1] * (PQ[a1] * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[c1] * QC_0 * (-1.0) + PQ[a1] * PQ[b0] * QC_0 * QC_1 * (-1.0) + PB_0 * PQ[a1] * PQ[c0] * QC_1 + PB_0 * PQ[a1] * PQ[c1] * QC_0 + PB_0 * PQ[a1] * QC_0 * QC_1 + PA_1 * PQ[b0] * PQ[c0] * QC_1 + PA_1 * PQ[b0] * PQ[c1] * QC_0 + PA_1 * PQ[b0] * QC_0 * QC_1)
                            + delta[a0][b1] * delta[c1][d1] * (PQ[a1] * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PQ[a1] * PQ[b0] * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[a1] * PQ[c0] * QD_0 + PB_0 * PQ[a1] * PQ[d0] * QC_0 + PB_0 * PQ[a1] * QD_0 * QC_0 + PA_1 * PQ[b0] * PQ[c0] * QD_0 + PA_1 * PQ[b0] * PQ[d0] * QC_0 + PA_1 * PQ[b0] * QD_0 * QC_0)
                            + delta[a0][b1] * delta[c1][d0] * (PQ[a1] * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d1] * QC_0 * (-1.0) + PQ[a1] * PQ[b0] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[a1] * PQ[c0] * QD_1 + PB_0 * PQ[a1] * PQ[d1] * QC_0 + PB_0 * PQ[a1] * QD_1 * QC_0 + PA_1 * PQ[b0] * PQ[c0] * QD_1 + PA_1 * PQ[b0] * PQ[d1] * QC_0 + PA_1 * PQ[b0] * QD_1 * QC_0)
                            + delta[a0][b1] * delta[c0][d1] * (PQ[a1] * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d0] * QC_1 * (-1.0) + PQ[a1] * PQ[b0] * QD_0 * QC_1 * (-1.0) + PB_0 * PQ[a1] * PQ[c1] * QD_0 + PB_0 * PQ[a1] * PQ[d0] * QC_1 + PB_0 * PQ[a1] * QD_0 * QC_1 + PA_1 * PQ[b0] * PQ[c1] * QD_0 + PA_1 * PQ[b0] * PQ[d0] * QC_1 + PA_1 * PQ[b0] * QD_0 * QC_1)
                            + delta[a0][b1] * delta[c0][d0] * (PQ[a1] * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d1] * QC_1 * (-1.0) + PQ[a1] * PQ[b0] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[a1] * PQ[c1] * QD_1 + PB_0 * PQ[a1] * PQ[d1] * QC_1 + PB_0 * PQ[a1] * QD_1 * QC_1 + PA_1 * PQ[b0] * PQ[c1] * QD_1 + PA_1 * PQ[b0] * PQ[d1] * QC_1 + PA_1 * PQ[b0] * QD_1 * QC_1)
                            + delta[a0][b1] * delta[c0][c1] * (PQ[a1] * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PQ[a1] * PQ[b0] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[a1] * PQ[d0] * QD_1 + PB_0 * PQ[a1] * PQ[d1] * QD_0 + PB_0 * PQ[a1] * QD_0 * QD_1 + PA_1 * PQ[b0] * PQ[d0] * QD_1 + PA_1 * PQ[b0] * PQ[d1] * QD_0 + PA_1 * PQ[b0] * QD_0 * QD_1)
                            + delta[a0][d0] * delta[b1][d1] * (PB_0 * PQ[a1] * QC_0 * QC_1 + PA_1 * PQ[b0] * QC_0 * QC_1)
                            + delta[a0][d1] * delta[b1][d0] * (PB_0 * PQ[a1] * QC_0 * QC_1 + PA_1 * PQ[b0] * QC_0 * QC_1)
                            + delta[a0][c1] * delta[b1][d1] * (PB_0 * PQ[a1] * QD_0 * QC_0 + PA_1 * PQ[b0] * QD_0 * QC_0)
                            + delta[a0][d1] * delta[b1][c1] * (PB_0 * PQ[a1] * QD_0 * QC_0 + PA_1 * PQ[b0] * QD_0 * QC_0)
                            + delta[a0][c1] * delta[b1][d0] * (PB_0 * PQ[a1] * QD_1 * QC_0 + PA_1 * PQ[b0] * QD_1 * QC_0)
                            + delta[a0][d0] * delta[b1][c1] * (PB_0 * PQ[a1] * QD_1 * QC_0 + PA_1 * PQ[b0] * QD_1 * QC_0)
                            + delta[a0][c0] * delta[b1][d1] * (PB_0 * PQ[a1] * QD_0 * QC_1 + PA_1 * PQ[b0] * QD_0 * QC_1)
                            + delta[a0][d1] * delta[b1][c0] * (PB_0 * PQ[a1] * QD_0 * QC_1 + PA_1 * PQ[b0] * QD_0 * QC_1)
                            + delta[a0][c0] * delta[b1][d0] * (PB_0 * PQ[a1] * QD_1 * QC_1 + PA_1 * PQ[b0] * QD_1 * QC_1)
                            + delta[a0][d0] * delta[b1][c0] * (PB_0 * PQ[a1] * QD_1 * QC_1 + PA_1 * PQ[b0] * QD_1 * QC_1)
                            + delta[a0][c0] * delta[b1][c1] * (PB_0 * PQ[a1] * QD_0 * QD_1 + PA_1 * PQ[b0] * QD_0 * QD_1)
                            + delta[a0][c1] * delta[b1][c0] * (PB_0 * PQ[a1] * QD_0 * QD_1 + PA_1 * PQ[b0] * QD_0 * QD_1)
                            + delta[a0][b0] * delta[d0][d1] * (PQ[a1] * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[c1] * QC_0 * (-1.0) + PQ[a1] * PQ[b1] * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[a1] * PQ[c0] * QC_1 + PB_1 * PQ[a1] * PQ[c1] * QC_0 + PB_1 * PQ[a1] * QC_0 * QC_1 + PA_1 * PQ[b1] * PQ[c0] * QC_1 + PA_1 * PQ[b1] * PQ[c1] * QC_0 + PA_1 * PQ[b1] * QC_0 * QC_1)
                            + delta[a0][b0] * delta[c1][d1] * (PQ[a1] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PQ[a1] * PQ[b1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[a1] * PQ[c0] * QD_0 + PB_1 * PQ[a1] * PQ[d0] * QC_0 + PB_1 * PQ[a1] * QD_0 * QC_0 + PA_1 * PQ[b1] * PQ[c0] * QD_0 + PA_1 * PQ[b1] * PQ[d0] * QC_0 + PA_1 * PQ[b1] * QD_0 * QC_0)
                            + delta[a0][b0] * delta[c1][d0] * (PQ[a1] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PQ[a1] * PQ[b1] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[a1] * PQ[c0] * QD_1 + PB_1 * PQ[a1] * PQ[d1] * QC_0 + PB_1 * PQ[a1] * QD_1 * QC_0 + PA_1 * PQ[b1] * PQ[c0] * QD_1 + PA_1 * PQ[b1] * PQ[d1] * QC_0 + PA_1 * PQ[b1] * QD_1 * QC_0)
                            + delta[a0][b0] * delta[c0][d1] * (PQ[a1] * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d0] * QC_1 * (-1.0) + PQ[a1] * PQ[b1] * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[a1] * PQ[c1] * QD_0 + PB_1 * PQ[a1] * PQ[d0] * QC_1 + PB_1 * PQ[a1] * QD_0 * QC_1 + PA_1 * PQ[b1] * PQ[c1] * QD_0 + PA_1 * PQ[b1] * PQ[d0] * QC_1 + PA_1 * PQ[b1] * QD_0 * QC_1)
                            + delta[a0][b0] * delta[c0][d0] * (PQ[a1] * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d1] * QC_1 * (-1.0) + PQ[a1] * PQ[b1] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[a1] * PQ[c1] * QD_1 + PB_1 * PQ[a1] * PQ[d1] * QC_1 + PB_1 * PQ[a1] * QD_1 * QC_1 + PA_1 * PQ[b1] * PQ[c1] * QD_1 + PA_1 * PQ[b1] * PQ[d1] * QC_1 + PA_1 * PQ[b1] * QD_1 * QC_1)
                            + delta[a0][b0] * delta[c0][c1] * (PQ[a1] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PQ[a1] * PQ[b1] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[a1] * PQ[d0] * QD_1 + PB_1 * PQ[a1] * PQ[d1] * QD_0 + PB_1 * PQ[a1] * QD_0 * QD_1 + PA_1 * PQ[b1] * PQ[d0] * QD_1 + PA_1 * PQ[b1] * PQ[d1] * QD_0 + PA_1 * PQ[b1] * QD_0 * QD_1)
                            + delta[a0][d0] * delta[b0][d1] * (PB_1 * PQ[a1] * QC_0 * QC_1 + PA_1 * PQ[b1] * QC_0 * QC_1)
                            + delta[a0][d1] * delta[b0][d0] * (PB_1 * PQ[a1] * QC_0 * QC_1 + PA_1 * PQ[b1] * QC_0 * QC_1)
                            + delta[a0][c1] * delta[b0][d1] * (PB_1 * PQ[a1] * QD_0 * QC_0 + PA_1 * PQ[b1] * QD_0 * QC_0)
                            + delta[a0][d1] * delta[b0][c1] * (PB_1 * PQ[a1] * QD_0 * QC_0 + PA_1 * PQ[b1] * QD_0 * QC_0)
                            + delta[a0][c1] * delta[b0][d0] * (PB_1 * PQ[a1] * QD_1 * QC_0 + PA_1 * PQ[b1] * QD_1 * QC_0)
                            + delta[a0][d0] * delta[b0][c1] * (PB_1 * PQ[a1] * QD_1 * QC_0 + PA_1 * PQ[b1] * QD_1 * QC_0)
                            + delta[a0][c0] * delta[b0][d1] * (PB_1 * PQ[a1] * QD_0 * QC_1 + PA_1 * PQ[b1] * QD_0 * QC_1)
                            + delta[a0][d1] * delta[b0][c0] * (PB_1 * PQ[a1] * QD_0 * QC_1 + PA_1 * PQ[b1] * QD_0 * QC_1)
                            + delta[a0][c0] * delta[b0][d0] * (PB_1 * PQ[a1] * QD_1 * QC_1 + PA_1 * PQ[b1] * QD_1 * QC_1)
                            + delta[a0][d0] * delta[b0][c0] * (PB_1 * PQ[a1] * QD_1 * QC_1 + PA_1 * PQ[b1] * QD_1 * QC_1)
                            + delta[a0][c0] * delta[b0][c1] * (PB_1 * PQ[a1] * QD_0 * QD_1 + PA_1 * PQ[b1] * QD_0 * QD_1)
                            + delta[a0][c1] * delta[b0][c0] * (PB_1 * PQ[a1] * QD_0 * QD_1 + PA_1 * PQ[b1] * QD_0 * QD_1)
                            + delta[a0][d1] * delta[b0][b1] * (PQ[a1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PQ[a1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PQ[a1] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[c0] * QD_0 * QC_1 + PA_1 * PQ[c1] * QD_0 * QC_0 + PA_1 * PQ[d0] * QC_0 * QC_1)
                            + delta[a0][b0] * delta[b1][d1] * (PQ[a1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PQ[a1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PQ[a1] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[c0] * QD_0 * QC_1 + PA_1 * PQ[c1] * QD_0 * QC_0 + PA_1 * PQ[d0] * QC_0 * QC_1)
                            + delta[b0][d1] * delta[a0][b1] * (PQ[a1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PQ[a1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PQ[a1] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[c0] * QD_0 * QC_1 + PA_1 * PQ[c1] * QD_0 * QC_0 + PA_1 * PQ[d0] * QC_0 * QC_1)
                            + delta[a0][d0] * delta[b0][b1] * (PQ[a1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PQ[a1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PQ[a1] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[c0] * QD_1 * QC_1 + PA_1 * PQ[c1] * QD_1 * QC_0 + PA_1 * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][b0] * delta[b1][d0] * (PQ[a1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PQ[a1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PQ[a1] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[c0] * QD_1 * QC_1 + PA_1 * PQ[c1] * QD_1 * QC_0 + PA_1 * PQ[d1] * QC_0 * QC_1)
                            + delta[b0][d0] * delta[a0][b1] * (PQ[a1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PQ[a1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PQ[a1] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[c0] * QD_1 * QC_1 + PA_1 * PQ[c1] * QD_1 * QC_0 + PA_1 * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][c1] * delta[b0][b1] * (PQ[a1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[a1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[a1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[c0] * QD_0 * QD_1 + PA_1 * PQ[d0] * QD_1 * QC_0 + PA_1 * PQ[d1] * QD_0 * QC_0)
                            + delta[a0][b0] * delta[b1][c1] * (PQ[a1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[a1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[a1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[c0] * QD_0 * QD_1 + PA_1 * PQ[d0] * QD_1 * QC_0 + PA_1 * PQ[d1] * QD_0 * QC_0)
                            + delta[b0][c1] * delta[a0][b1] * (PQ[a1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[a1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[a1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[c0] * QD_0 * QD_1 + PA_1 * PQ[d0] * QD_1 * QC_0 + PA_1 * PQ[d1] * QD_0 * QC_0)
                            + delta[a0][c0] * delta[b0][b1] * (PQ[a1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[a1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[a1] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PA_1 * PQ[c1] * QD_0 * QD_1 + PA_1 * PQ[d0] * QD_1 * QC_1 + PA_1 * PQ[d1] * QD_0 * QC_1)
                            + delta[a0][b0] * delta[b1][c0] * (PQ[a1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[a1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[a1] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PA_1 * PQ[c1] * QD_0 * QD_1 + PA_1 * PQ[d0] * QD_1 * QC_1 + PA_1 * PQ[d1] * QD_0 * QC_1)
                            + delta[b0][c0] * delta[a0][b1] * (PQ[a1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[a1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[a1] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PA_1 * PQ[c1] * QD_0 * QD_1 + PA_1 * PQ[d0] * QD_1 * QC_1 + PA_1 * PQ[d1] * QD_0 * QC_1)
                            + delta[a0][a1] * delta[d0][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[c1] * QC_0 * (-1.0) + PQ[b0] * PQ[b1] * QC_0 * QC_1 * (-1.0) + PB_0 * PQ[b1] * PQ[c0] * QC_1 + PB_0 * PQ[b1] * PQ[c1] * QC_0 + PB_0 * PQ[b1] * QC_0 * QC_1 + PB_1 * PQ[b0] * PQ[c0] * QC_1 + PB_1 * PQ[b0] * PQ[c1] * QC_0 + PB_1 * PQ[b0] * QC_0 * QC_1)
                            + delta[a0][a1] * delta[c1][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PQ[b0] * PQ[b1] * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[b1] * PQ[c0] * QD_0 + PB_0 * PQ[b1] * PQ[d0] * QC_0 + PB_0 * PQ[b1] * QD_0 * QC_0 + PB_1 * PQ[b0] * PQ[c0] * QD_0 + PB_1 * PQ[b0] * PQ[d0] * QC_0 + PB_1 * PQ[b0] * QD_0 * QC_0)
                            + delta[a0][a1] * delta[c0][d1] * (PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d0] * QC_1 * (-1.0) + PQ[b0] * PQ[b1] * QD_0 * QC_1 * (-1.0) + PB_0 * PQ[b1] * PQ[c1] * QD_0 + PB_0 * PQ[b1] * PQ[d0] * QC_1 + PB_0 * PQ[b1] * QD_0 * QC_1 + PB_1 * PQ[b0] * PQ[c1] * QD_0 + PB_1 * PQ[b0] * PQ[d0] * QC_1 + PB_1 * PQ[b0] * QD_0 * QC_1)
                            + delta[a0][a1] * delta[c1][d0] * (PQ[b0] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PQ[b0] * PQ[b1] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[b1] * PQ[c0] * QD_1 + PB_0 * PQ[b1] * PQ[d1] * QC_0 + PB_0 * PQ[b1] * QD_1 * QC_0 + PB_1 * PQ[b0] * PQ[c0] * QD_1 + PB_1 * PQ[b0] * PQ[d1] * QC_0 + PB_1 * PQ[b0] * QD_1 * QC_0)
                            + delta[a0][a1] * delta[c0][d0] * (PQ[b0] * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d1] * QC_1 * (-1.0) + PQ[b0] * PQ[b1] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[b1] * PQ[c1] * QD_1 + PB_0 * PQ[b1] * PQ[d1] * QC_1 + PB_0 * PQ[b1] * QD_1 * QC_1 + PB_1 * PQ[b0] * PQ[c1] * QD_1 + PB_1 * PQ[b0] * PQ[d1] * QC_1 + PB_1 * PQ[b0] * QD_1 * QC_1)
                            + delta[a0][d0] * delta[a1][d1] * (PB_0 * PQ[b1] * QC_0 * QC_1 + PB_1 * PQ[b0] * QC_0 * QC_1)
                            + delta[a0][d1] * delta[a1][d0] * (PB_0 * PQ[b1] * QC_0 * QC_1 + PB_1 * PQ[b0] * QC_0 * QC_1)
                            + delta[a0][c1] * delta[a1][d1] * (PB_0 * PQ[b1] * QD_0 * QC_0 + PB_1 * PQ[b0] * QD_0 * QC_0)
                            + delta[a0][d1] * delta[a1][c1] * (PB_0 * PQ[b1] * QD_0 * QC_0 + PB_1 * PQ[b0] * QD_0 * QC_0)
                            + delta[a0][c1] * delta[a1][d0] * (PB_0 * PQ[b1] * QD_1 * QC_0 + PB_1 * PQ[b0] * QD_1 * QC_0)
                            + delta[a0][d0] * delta[a1][c1] * (PB_0 * PQ[b1] * QD_1 * QC_0 + PB_1 * PQ[b0] * QD_1 * QC_0)
                            + delta[a0][c0] * delta[a1][d1] * (PB_0 * PQ[b1] * QD_0 * QC_1 + PB_1 * PQ[b0] * QD_0 * QC_1)
                            + delta[a0][d1] * delta[a1][c0] * (PB_0 * PQ[b1] * QD_0 * QC_1 + PB_1 * PQ[b0] * QD_0 * QC_1)
                            + delta[a0][c0] * delta[a1][d0] * (PB_0 * PQ[b1] * QD_1 * QC_1 + PB_1 * PQ[b0] * QD_1 * QC_1)
                            + delta[a0][d0] * delta[a1][c0] * (PB_0 * PQ[b1] * QD_1 * QC_1 + PB_1 * PQ[b0] * QD_1 * QC_1)
                            + delta[a0][d1] * delta[a1][b1] * (PQ[b0] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PQ[b0] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PB_0 * PQ[c0] * QD_0 * QC_1 + PB_0 * PQ[c1] * QD_0 * QC_0 + PB_0 * PQ[d0] * QC_0 * QC_1)
                            + delta[a0][a1] * delta[b1][d1] * (PQ[b0] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PQ[b0] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PB_0 * PQ[c0] * QD_0 * QC_1 + PB_0 * PQ[c1] * QD_0 * QC_0 + PB_0 * PQ[d0] * QC_0 * QC_1)
                            + delta[a1][d1] * delta[a0][b1] * (PQ[b0] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PQ[b0] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PB_0 * PQ[c0] * QD_0 * QC_1 + PB_0 * PQ[c1] * QD_0 * QC_0 + PB_0 * PQ[d0] * QC_0 * QC_1)
                            + delta[a0][d0] * delta[a1][b1] * (PQ[b0] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PQ[b0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PB_0 * PQ[c0] * QD_1 * QC_1 + PB_0 * PQ[c1] * QD_1 * QC_0 + PB_0 * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][a1] * delta[b1][d0] * (PQ[b0] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PQ[b0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PB_0 * PQ[c0] * QD_1 * QC_1 + PB_0 * PQ[c1] * QD_1 * QC_0 + PB_0 * PQ[d1] * QC_0 * QC_1)
                            + delta[a1][d0] * delta[a0][b1] * (PQ[b0] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PQ[b0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PB_0 * PQ[c0] * QD_1 * QC_1 + PB_0 * PQ[c1] * QD_1 * QC_0 + PB_0 * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][c1] * delta[a1][b1] * (PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[c0] * QD_0 * QD_1 + PB_0 * PQ[d0] * QD_1 * QC_0 + PB_0 * PQ[d1] * QD_0 * QC_0)
                            + delta[a0][a1] * delta[b1][c1] * (PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[c0] * QD_0 * QD_1 + PB_0 * PQ[d0] * QD_1 * QC_0 + PB_0 * PQ[d1] * QD_0 * QC_0)
                            + delta[a1][c1] * delta[a0][b1] * (PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[c0] * QD_0 * QD_1 + PB_0 * PQ[d0] * QD_1 * QC_0 + PB_0 * PQ[d1] * QD_0 * QC_0)
                            + delta[a0][c0] * delta[a1][b1] * (PQ[b0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[b0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[b0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_0 * PQ[c1] * QD_0 * QD_1 + PB_0 * PQ[d0] * QD_1 * QC_1 + PB_0 * PQ[d1] * QD_0 * QC_1)
                            + delta[a0][a1] * delta[b1][c0] * (PQ[b0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[b0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[b0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_0 * PQ[c1] * QD_0 * QD_1 + PB_0 * PQ[d0] * QD_1 * QC_1 + PB_0 * PQ[d1] * QD_0 * QC_1)
                            + delta[a1][c0] * delta[a0][b1] * (PQ[b0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[b0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[b0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_0 * PQ[c1] * QD_0 * QD_1 + PB_0 * PQ[d0] * QD_1 * QC_1 + PB_0 * PQ[d1] * QD_0 * QC_1)
                            + delta[a0][d1] * delta[a1][b0] * (PQ[b1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PQ[b1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PQ[b1] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[c0] * QD_0 * QC_1 + PB_1 * PQ[c1] * QD_0 * QC_0 + PB_1 * PQ[d0] * QC_0 * QC_1)
                            + delta[a0][a1] * delta[b0][d1] * (PQ[b1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PQ[b1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PQ[b1] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[c0] * QD_0 * QC_1 + PB_1 * PQ[c1] * QD_0 * QC_0 + PB_1 * PQ[d0] * QC_0 * QC_1)
                            + delta[a1][d1] * delta[a0][b0] * (PQ[b1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PQ[b1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PQ[b1] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[c0] * QD_0 * QC_1 + PB_1 * PQ[c1] * QD_0 * QC_0 + PB_1 * PQ[d0] * QC_0 * QC_1)
                            + delta[a0][d0] * delta[a1][b0] * (PQ[b1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PQ[b1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PQ[b1] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[c0] * QD_1 * QC_1 + PB_1 * PQ[c1] * QD_1 * QC_0 + PB_1 * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][a1] * delta[b0][d0] * (PQ[b1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PQ[b1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PQ[b1] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[c0] * QD_1 * QC_1 + PB_1 * PQ[c1] * QD_1 * QC_0 + PB_1 * PQ[d1] * QC_0 * QC_1)
                            + delta[a1][d0] * delta[a0][b0] * (PQ[b1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PQ[b1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PQ[b1] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[c0] * QD_1 * QC_1 + PB_1 * PQ[c1] * QD_1 * QC_0 + PB_1 * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][c1] * delta[a1][b0] * (PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[c0] * QD_0 * QD_1 + PB_1 * PQ[d0] * QD_1 * QC_0 + PB_1 * PQ[d1] * QD_0 * QC_0)
                            + delta[a0][a1] * delta[b0][c1] * (PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[c0] * QD_0 * QD_1 + PB_1 * PQ[d0] * QD_1 * QC_0 + PB_1 * PQ[d1] * QD_0 * QC_0)
                            + delta[a1][c1] * delta[a0][b0] * (PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[c0] * QD_0 * QD_1 + PB_1 * PQ[d0] * QD_1 * QC_0 + PB_1 * PQ[d1] * QD_0 * QC_0)
                            + delta[a0][c0] * delta[a1][b0] * (PQ[b1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[b1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[b1] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[c1] * QD_0 * QD_1 + PB_1 * PQ[d0] * QD_1 * QC_1 + PB_1 * PQ[d1] * QD_0 * QC_1)
                            + delta[a0][a1] * delta[b0][c0] * (PQ[b1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[b1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[b1] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[c1] * QD_0 * QD_1 + PB_1 * PQ[d0] * QD_1 * QC_1 + PB_1 * PQ[d1] * QD_0 * QC_1)
                            + delta[a1][c0] * delta[a0][b0] * (PQ[b1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[b1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[b1] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[c1] * QD_0 * QD_1 + PB_1 * PQ[d0] * QD_1 * QC_1 + PB_1 * PQ[d1] * QD_0 * QC_1)
                            + delta[a0][a1] * delta[c0][c1] * (PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PQ[b0] * PQ[b1] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[b1] * PQ[d0] * QD_1 + PB_0 * PQ[b1] * PQ[d1] * QD_0 + PB_0 * PQ[b1] * QD_0 * QD_1 + PB_1 * PQ[b0] * PQ[d0] * QD_1 + PB_1 * PQ[b0] * PQ[d1] * QD_0 + PB_1 * PQ[b0] * QD_0 * QD_1)
                            + delta[a0][a1] * delta[b0][b1] * (PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-2.0) + PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-2.0) + PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-2.0) + PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-2.0) + PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-2.0) + PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-2.0))
                            + delta[a0][b0] * delta[a1][b1] * (PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-2.0) + PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-2.0) + PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-2.0) + PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-2.0) + PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-2.0) + PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * (PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-2.0) + PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-2.0) + PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-2.0) + PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-2.0) + PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-2.0) + PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-2.0))
                            + delta[a0][c0] * delta[a1][c1] * (PB_0 * PQ[b1] * QD_0 * QD_1 + PB_1 * PQ[b0] * QD_0 * QD_1)
                            + delta[a0][c1] * delta[a1][c0] * (PB_0 * PQ[b1] * QD_0 * QD_1 + PB_1 * PQ[b0] * QD_0 * QD_1)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD22(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[4];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[3] * (

                        0.5 * ( S1 * S1 ) / ( S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[c1] + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] * QC_1 + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c1] * QC_0 + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[c1] + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] * QC_1 + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c1] * QC_0 + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[c1] + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] * QC_1 + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c1] * QC_0 + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[c1] + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0] * QC_1 + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c1] * QC_0)
                            + delta[c1][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[d0] + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] * QD_0 + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d0] * QC_0 + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[d0] + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] * QD_0 + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d0] * QC_0 + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[d0] + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] * QD_0 + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d0] * QC_0 + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[d0] + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0] * QD_0 + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d0] * QC_0)
                            + delta[c1][d0] * (PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[d1] + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] * QD_1 + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d1] * QC_0 + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[d1] + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] * QD_1 + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d1] * QC_0 + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[d1] + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] * QD_1 + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d1] * QC_0 + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[d1] + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0] * QD_1 + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d1] * QC_0)
                            + delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c1] * PQ[d0] + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c1] * QD_0 + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d0] * QC_1 + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c1] * PQ[d0] + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c1] * QD_0 + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d0] * QC_1 + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c1] * PQ[d0] + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c1] * QD_0 + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d0] * QC_1 + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c1] * PQ[d0] + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c1] * QD_0 + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d0] * QC_1)
                            + delta[c0][d0] * (PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c1] * PQ[d1] + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c1] * QD_1 + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d1] * QC_1 + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c1] * PQ[d1] + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c1] * QD_1 + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d1] * QC_1 + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c1] * PQ[d1] + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c1] * QD_1 + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d1] * QC_1 + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c1] * PQ[d1] + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c1] * QD_1 + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d1] * QC_1)
                            + delta[c0][c1] * (PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d0] * PQ[d1] + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d0] * QD_1 + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d1] * QD_0 + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d0] * PQ[d1] + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d0] * QD_1 + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d1] * QD_0 + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d0] * PQ[d1] + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d0] * QD_1 + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d1] * QD_0 + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d0] * PQ[d1] + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d0] * QD_1 + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d1] * QD_0)
                            + delta[b1][d1] * (PB_0 * PA_0 * PA_1 * PQ[c0] * PQ[c1] * QD_0 + PB_0 * PA_0 * PA_1 * PQ[c0] * PQ[d0] * QC_1 + PB_0 * PA_0 * PA_1 * PQ[c1] * PQ[d0] * QC_0)
                            + delta[b1][d0] * (PB_0 * PA_0 * PA_1 * PQ[c0] * PQ[c1] * QD_1 + PB_0 * PA_0 * PA_1 * PQ[c0] * PQ[d1] * QC_1 + PB_0 * PA_0 * PA_1 * PQ[c1] * PQ[d1] * QC_0)
                            + delta[b1][c1] * (PB_0 * PA_0 * PA_1 * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PA_0 * PA_1 * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PA_0 * PA_1 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[b1][c0] * (PB_0 * PA_0 * PA_1 * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PA_0 * PA_1 * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PA_0 * PA_1 * PQ[d0] * PQ[d1] * QC_1)
                            + delta[b0][d1] * (PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[c1] * QD_0 + PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[d0] * QC_1 + PB_1 * PA_0 * PA_1 * PQ[c1] * PQ[d0] * QC_0)
                            + delta[b0][d0] * (PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[c1] * QD_1 + PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[d1] * QC_1 + PB_1 * PA_0 * PA_1 * PQ[c1] * PQ[d1] * QC_0)
                            + delta[b0][c1] * (PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[d0] * QD_1 + PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[d1] * QD_0 + PB_1 * PA_0 * PA_1 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[b0][c0] * (PB_1 * PA_0 * PA_1 * PQ[c1] * PQ[d0] * QD_1 + PB_1 * PA_0 * PA_1 * PQ[c1] * PQ[d1] * QD_0 + PB_1 * PA_0 * PA_1 * PQ[d0] * PQ[d1] * QC_1)
                            + delta[b0][b1] * (PA_0 * PA_1 * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PA_1 * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][d1] * (PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[c1] * QD_0 + PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[d0] * QC_1 + PB_0 * PB_1 * PA_0 * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a1][d0] * (PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[c1] * QD_1 + PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[d1] * QC_1 + PB_0 * PB_1 * PA_0 * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a1][c1] * (PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PB_1 * PA_0 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a1][c0] * (PB_0 * PB_1 * PA_0 * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PB_1 * PA_0 * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PB_1 * PA_0 * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a1][b1] * (PB_0 * PA_0 * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][b0] * (PB_1 * PA_0 * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][d1] * (PB_0 * PB_1 * PA_1 * PQ[c0] * PQ[c1] * QD_0 + PB_0 * PB_1 * PA_1 * PQ[c0] * PQ[d0] * QC_1 + PB_0 * PB_1 * PA_1 * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a0][d0] * (PB_0 * PB_1 * PA_1 * PQ[c0] * PQ[c1] * QD_1 + PB_0 * PB_1 * PA_1 * PQ[c0] * PQ[d1] * QC_1 + PB_0 * PB_1 * PA_1 * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a0][c1] * (PB_0 * PB_1 * PA_1 * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PB_1 * PA_1 * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PB_1 * PA_1 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][c0] * (PB_0 * PB_1 * PA_1 * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PB_1 * PA_1 * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PB_1 * PA_1 * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a0][b1] * (PB_0 * PA_1 * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PA_1 * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][b0] * (PB_1 * PA_1 * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PA_1 * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][a1] * (PB_0 * PB_1 * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PB_1 * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                        )

                    )

                    +

                    F8_t[3] * (

                        0.5 * ( S1 * S1 * S1 ) / ( S2 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[c1] * (-1.0))
                            + delta[c1][d1] * (PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[c1][d0] * (PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PA_1 * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[c0][d0] * (PB_0 * PB_1 * PA_0 * PA_1 * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[c0][c1] * (PB_0 * PB_1 * PA_0 * PA_1 * PQ[d0] * PQ[d1] * (-1.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD23(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[4];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[3] * (

                        0.5 * ( S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c1] * QC_0 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[a1] * QC_0 * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c1] * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * QC_0 * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c1] * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * QC_0 * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c1] * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * QC_0 * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c1] * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * QC_0 * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c1] * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * QC_0 * QC_1 * (-1.0))
                            + delta[c1][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[a1] * QD_0 * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * QD_0 * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * QD_0 * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * QD_0 * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * QD_0 * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * QD_0 * QC_0 * (-1.0))
                            + delta[c1][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[a1] * QD_1 * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * QD_1 * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * QD_1 * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * QD_1 * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * QD_1 * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * QD_1 * QC_0 * (-1.0))
                            + delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c1] * QD_0 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[a1] * QD_0 * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * QD_0 * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * QD_0 * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * QD_0 * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * QD_0 * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * QD_0 * QC_1 * (-1.0))
                            + delta[c0][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c1] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d1] * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[a1] * QD_1 * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d1] * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * QD_1 * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d1] * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * QD_1 * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d1] * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * QD_1 * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d1] * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * QD_1 * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d1] * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * QD_1 * QC_1 * (-1.0))
                            + delta[c0][c1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[a1] * QD_0 * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * QD_0 * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * QD_0 * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * QD_0 * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * QD_0 * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * QD_0 * QD_1 * (-1.0))
                            + delta[b1][d1] * (PB_0 * PA_0 * PQ[a1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[b1][d0] * (PB_0 * PA_0 * PQ[a1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[b1][c1] * (PB_0 * PA_0 * PQ[a1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[b1][c0] * (PB_0 * PA_0 * PQ[a1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[b0][d1] * (PB_1 * PA_0 * PQ[a1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][d0] * (PB_1 * PA_0 * PQ[a1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][c1] * (PB_1 * PA_0 * PQ[a1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[b0][c0] * (PB_1 * PA_0 * PQ[a1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[b0][b1] * (PA_0 * PA_1 * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PA_0 * PA_1 * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PA_0 * PQ[a1] * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PA_0 * PQ[a1] * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PA_0 * PQ[a1] * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PA_0 * PQ[a1] * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PA_0 * PQ[a1] * PQ[d0] * PQ[d1] * QC_0 * QC_1 + PA_1 * PQ[a0] * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PA_1 * PQ[a0] * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PA_1 * PQ[a0] * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PA_1 * PQ[a0] * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PA_1 * PQ[a0] * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PA_1 * PQ[a0] * PQ[d0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a1][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[a1][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a1][c1] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a1][c0] * (PB_0 * PB_1 * PQ[a0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[a1][b1] * (PB_0 * PA_0 * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PB_0 * PQ[a0] * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PB_0 * PQ[a0] * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PB_0 * PQ[a0] * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PB_0 * PQ[a0] * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PB_0 * PQ[a0] * PQ[d0] * PQ[d1] * QC_0 * QC_1 + PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PA_0 * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PA_0 * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PA_0 * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PA_0 * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PA_0 * PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a1][b0] * (PB_1 * PA_0 * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PB_1 * PQ[a0] * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PB_1 * PQ[a0] * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PB_1 * PQ[a0] * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PB_1 * PQ[a0] * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PB_1 * PQ[a0] * PQ[d0] * PQ[d1] * QC_0 * QC_1 + PA_0 * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PA_0 * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PA_0 * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PA_0 * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PA_0 * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PA_0 * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][d1] * (PB_0 * PB_1 * PQ[a1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[a1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_0 * PB_1 * PQ[a1] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][d0] * (PB_0 * PB_1 * PQ[a1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[a1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_0 * PB_1 * PQ[a1] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][c1] * (PB_0 * PB_1 * PQ[a1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[a1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PB_1 * PQ[a1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][c0] * (PB_0 * PB_1 * PQ[a1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[a1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[a1] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[a0][b1] * (PB_0 * PA_1 * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_0 * PA_1 * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PB_0 * PQ[a1] * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PB_0 * PQ[a1] * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PB_0 * PQ[a1] * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PB_0 * PQ[a1] * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PB_0 * PQ[a1] * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PB_0 * PQ[a1] * PQ[d0] * PQ[d1] * QC_0 * QC_1 + PA_1 * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PA_1 * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PA_1 * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PA_1 * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PA_1 * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PA_1 * PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][b0] * (PB_1 * PA_1 * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_1 * PA_1 * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[a1] * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PB_1 * PQ[a1] * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PB_1 * PQ[a1] * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PB_1 * PQ[a1] * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PB_1 * PQ[a1] * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PB_1 * PQ[a1] * PQ[d0] * PQ[d1] * QC_0 * QC_1 + PA_1 * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PA_1 * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PA_1 * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PA_1 * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PA_1 * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PA_1 * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][a1] * (PB_0 * PB_1 * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PB_1 * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_0 * PB_1 * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PB_0 * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PB_0 * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PB_0 * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PB_0 * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PB_0 * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PB_0 * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1 + PB_1 * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PB_1 * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PB_1 * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PB_1 * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PB_1 * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PB_1 * PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * QC_1)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD24(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[5];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[3] * (

                        0.5 * ( S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * QC_0 * QC_1 + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * QC_0 * QC_1 + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * QC_0 * QC_1 + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * QC_0 * QC_1)
                            + delta[c1][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * QD_0 * QC_0 + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * QD_0 * QC_0 + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * QC_0 + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * QC_0)
                            + delta[c1][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * QD_1 * QC_0 + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * QD_1 * QC_0 + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * QD_1 * QC_0 + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * QD_1 * QC_0)
                            + delta[c0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * QD_0 * QC_1 + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * QD_0 * QC_1 + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * QC_1 + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * QC_1)
                            + delta[c0][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * QD_1 * QC_1 + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * QD_1 * QC_1 + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * QD_1 * QC_1 + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * QD_1 * QC_1)
                            + delta[c0][c1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * QD_0 * QD_1 + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * QD_0 * QD_1 + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * QD_1 + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * QD_1)
                            + delta[b1][d1] * (PB_0 * PQ[a0] * PQ[a1] * QD_0 * QC_0 * QC_1 + PA_0 * PQ[a1] * PQ[b0] * QD_0 * QC_0 * QC_1 + PA_1 * PQ[a0] * PQ[b0] * QD_0 * QC_0 * QC_1)
                            + delta[b1][d0] * (PB_0 * PQ[a0] * PQ[a1] * QD_1 * QC_0 * QC_1 + PA_0 * PQ[a1] * PQ[b0] * QD_1 * QC_0 * QC_1 + PA_1 * PQ[a0] * PQ[b0] * QD_1 * QC_0 * QC_1)
                            + delta[b1][c1] * (PB_0 * PQ[a0] * PQ[a1] * QD_0 * QD_1 * QC_0 + PA_0 * PQ[a1] * PQ[b0] * QD_0 * QD_1 * QC_0 + PA_1 * PQ[a0] * PQ[b0] * QD_0 * QD_1 * QC_0)
                            + delta[b1][c0] * (PB_0 * PQ[a0] * PQ[a1] * QD_0 * QD_1 * QC_1 + PA_0 * PQ[a1] * PQ[b0] * QD_0 * QD_1 * QC_1 + PA_1 * PQ[a0] * PQ[b0] * QD_0 * QD_1 * QC_1)
                            + delta[b0][d1] * (PB_1 * PQ[a0] * PQ[a1] * QD_0 * QC_0 * QC_1 + PA_0 * PQ[a1] * PQ[b1] * QD_0 * QC_0 * QC_1 + PA_1 * PQ[a0] * PQ[b1] * QD_0 * QC_0 * QC_1)
                            + delta[b0][d0] * (PB_1 * PQ[a0] * PQ[a1] * QD_1 * QC_0 * QC_1 + PA_0 * PQ[a1] * PQ[b1] * QD_1 * QC_0 * QC_1 + PA_1 * PQ[a0] * PQ[b1] * QD_1 * QC_0 * QC_1)
                            + delta[b0][c1] * (PB_1 * PQ[a0] * PQ[a1] * QD_0 * QD_1 * QC_0 + PA_0 * PQ[a1] * PQ[b1] * QD_0 * QD_1 * QC_0 + PA_1 * PQ[a0] * PQ[b1] * QD_0 * QD_1 * QC_0)
                            + delta[b0][c0] * (PB_1 * PQ[a0] * PQ[a1] * QD_0 * QD_1 * QC_1 + PA_0 * PQ[a1] * PQ[b1] * QD_0 * QD_1 * QC_1 + PA_1 * PQ[a0] * PQ[b1] * QD_0 * QD_1 * QC_1)
                            + delta[b0][b1] * (PQ[a0] * PQ[a1] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[c0] * QD_0 * QD_1 * QC_1 + PA_0 * PQ[a1] * PQ[c1] * QD_0 * QD_1 * QC_0 + PA_0 * PQ[a1] * PQ[d0] * QD_1 * QC_0 * QC_1 + PA_0 * PQ[a1] * PQ[d1] * QD_0 * QC_0 * QC_1 + PA_1 * PQ[a0] * PQ[c0] * QD_0 * QD_1 * QC_1 + PA_1 * PQ[a0] * PQ[c1] * QD_0 * QD_1 * QC_0 + PA_1 * PQ[a0] * PQ[d0] * QD_1 * QC_0 * QC_1 + PA_1 * PQ[a0] * PQ[d1] * QD_0 * QC_0 * QC_1)
                            + delta[a1][d1] * (PB_0 * PQ[a0] * PQ[b1] * QD_0 * QC_0 * QC_1 + PB_1 * PQ[a0] * PQ[b0] * QD_0 * QC_0 * QC_1 + PA_0 * PQ[b0] * PQ[b1] * QD_0 * QC_0 * QC_1)
                            + delta[a1][d0] * (PB_0 * PQ[a0] * PQ[b1] * QD_1 * QC_0 * QC_1 + PB_1 * PQ[a0] * PQ[b0] * QD_1 * QC_0 * QC_1 + PA_0 * PQ[b0] * PQ[b1] * QD_1 * QC_0 * QC_1)
                            + delta[a1][c1] * (PB_0 * PQ[a0] * PQ[b1] * QD_0 * QD_1 * QC_0 + PB_1 * PQ[a0] * PQ[b0] * QD_0 * QD_1 * QC_0 + PA_0 * PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_0)
                            + delta[a1][c0] * (PB_0 * PQ[a0] * PQ[b1] * QD_0 * QD_1 * QC_1 + PB_1 * PQ[a0] * PQ[b0] * QD_0 * QD_1 * QC_1 + PA_0 * PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_1)
                            + delta[a1][b1] * (PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[c0] * QD_0 * QD_1 * QC_1 + PB_0 * PQ[a0] * PQ[c1] * QD_0 * QD_1 * QC_0 + PB_0 * PQ[a0] * PQ[d0] * QD_1 * QC_0 * QC_1 + PB_0 * PQ[a0] * PQ[d1] * QD_0 * QC_0 * QC_1 + PA_0 * PQ[b0] * PQ[c0] * QD_0 * QD_1 * QC_1 + PA_0 * PQ[b0] * PQ[c1] * QD_0 * QD_1 * QC_0 + PA_0 * PQ[b0] * PQ[d0] * QD_1 * QC_0 * QC_1 + PA_0 * PQ[b0] * PQ[d1] * QD_0 * QC_0 * QC_1)
                            + delta[a1][b0] * (PQ[a0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[c0] * QD_0 * QD_1 * QC_1 + PB_1 * PQ[a0] * PQ[c1] * QD_0 * QD_1 * QC_0 + PB_1 * PQ[a0] * PQ[d0] * QD_1 * QC_0 * QC_1 + PB_1 * PQ[a0] * PQ[d1] * QD_0 * QC_0 * QC_1 + PA_0 * PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 + PA_0 * PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 + PA_0 * PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 + PA_0 * PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1)
                            + delta[a0][d1] * (PB_0 * PQ[a1] * PQ[b1] * QD_0 * QC_0 * QC_1 + PB_1 * PQ[a1] * PQ[b0] * QD_0 * QC_0 * QC_1 + PA_1 * PQ[b0] * PQ[b1] * QD_0 * QC_0 * QC_1)
                            + delta[a0][d0] * (PB_0 * PQ[a1] * PQ[b1] * QD_1 * QC_0 * QC_1 + PB_1 * PQ[a1] * PQ[b0] * QD_1 * QC_0 * QC_1 + PA_1 * PQ[b0] * PQ[b1] * QD_1 * QC_0 * QC_1)
                            + delta[a0][c1] * (PB_0 * PQ[a1] * PQ[b1] * QD_0 * QD_1 * QC_0 + PB_1 * PQ[a1] * PQ[b0] * QD_0 * QD_1 * QC_0 + PA_1 * PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_0)
                            + delta[a0][c0] * (PB_0 * PQ[a1] * PQ[b1] * QD_0 * QD_1 * QC_1 + PB_1 * PQ[a1] * PQ[b0] * QD_0 * QD_1 * QC_1 + PA_1 * PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_1)
                            + delta[a0][b1] * (PQ[a1] * PQ[b0] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0) + PB_0 * PQ[a1] * PQ[c0] * QD_0 * QD_1 * QC_1 + PB_0 * PQ[a1] * PQ[c1] * QD_0 * QD_1 * QC_0 + PB_0 * PQ[a1] * PQ[d0] * QD_1 * QC_0 * QC_1 + PB_0 * PQ[a1] * PQ[d1] * QD_0 * QC_0 * QC_1 + PA_1 * PQ[b0] * PQ[c0] * QD_0 * QD_1 * QC_1 + PA_1 * PQ[b0] * PQ[c1] * QD_0 * QD_1 * QC_0 + PA_1 * PQ[b0] * PQ[d0] * QD_1 * QC_0 * QC_1 + PA_1 * PQ[b0] * PQ[d1] * QD_0 * QC_0 * QC_1)
                            + delta[a0][b0] * (PQ[a1] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[a1] * PQ[c0] * QD_0 * QD_1 * QC_1 + PB_1 * PQ[a1] * PQ[c1] * QD_0 * QD_1 * QC_0 + PB_1 * PQ[a1] * PQ[d0] * QD_1 * QC_0 * QC_1 + PB_1 * PQ[a1] * PQ[d1] * QD_0 * QC_0 * QC_1 + PA_1 * PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 + PA_1 * PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 + PA_1 * PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 + PA_1 * PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1)
                            + delta[a0][a1] * (PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0) + PB_0 * PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 + PB_0 * PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 + PB_0 * PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 + PB_0 * PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1 + PB_1 * PQ[b0] * PQ[c0] * QD_0 * QD_1 * QC_1 + PB_1 * PQ[b0] * PQ[c1] * QD_0 * QD_1 * QC_0 + PB_1 * PQ[b0] * PQ[d0] * QD_1 * QC_0 * QC_1 + PB_1 * PQ[b0] * PQ[d1] * QD_0 * QC_0 * QC_1)
                        )

                    )

                    +

                    F8_t[3] * (

                        0.5 * ( S2 * S2 * S2 ) / ( S1 * S4 * S4 * S4 ) * (
                            delta[b0][b1] * (PQ[a0] * PQ[a1] * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0))
                            + delta[a1][b1] * (PQ[a0] * PQ[b0] * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0))
                            + delta[a1][b0] * (PQ[a0] * PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][b1] * (PQ[a1] * PQ[b0] * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * (PQ[a1] * PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * (PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0))
                        )

                    )

                    +

                    F8_t[4] * (

                        ( S1 * S1 * S1 * S1 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                        )

                    )

                    +

                    F8_t[4] * (

                        ( S1 * S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                        )

                    )

                    +

                    F8_t[4] * (

                        ( S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                        )

                    )

                    +

                    F8_t[4] * (

                        ( S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                        )

                    )

                    +

                    F8_t[4] * (

                        ( S2 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD25(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[5];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[4] * (

                        0.125 * S1 / ( S4 * S4 * S4 * S4 ) * (
                            delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (PA_0 * PQ[a1] * (-1.0) + PA_1 * PQ[a0] * (-1.0) + PQ[a0] * PQ[a1])
                            + delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (PA_0 * PQ[a1] * (-1.0) + PA_1 * PQ[a0] * (-1.0) + PQ[a0] * PQ[a1])
                            + delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (PA_0 * PQ[a1] * (-1.0) + PA_1 * PQ[a0] * (-1.0) + PQ[a0] * PQ[a1])
                            + delta[b0][c0] * delta[b1][c1] * delta[d0][d1] * (PA_0 * PQ[a1] * (-1.0) + PA_1 * PQ[a0] * (-1.0))
                            + delta[b0][c0] * delta[b1][d0] * delta[c1][d1] * (PA_0 * PQ[a1] * (-1.0) + PA_1 * PQ[a0] * (-1.0))
                            + delta[b0][c0] * delta[b1][d1] * delta[c1][d0] * (PA_0 * PQ[a1] * (-1.0) + PA_1 * PQ[a0] * (-1.0))
                            + delta[b0][c1] * delta[b1][c0] * delta[d0][d1] * (PA_0 * PQ[a1] * (-1.0) + PA_1 * PQ[a0] * (-1.0))
                            + delta[b0][c1] * delta[b1][d0] * delta[c0][d1] * (PA_0 * PQ[a1] * (-1.0) + PA_1 * PQ[a0] * (-1.0))
                            + delta[b0][c1] * delta[b1][d1] * delta[c0][d0] * (PA_0 * PQ[a1] * (-1.0) + PA_1 * PQ[a0] * (-1.0))
                            + delta[b0][d0] * delta[b1][c0] * delta[c1][d1] * (PA_0 * PQ[a1] * (-1.0) + PA_1 * PQ[a0] * (-1.0))
                            + delta[b0][d0] * delta[b1][c1] * delta[c0][d1] * (PA_0 * PQ[a1] * (-1.0) + PA_1 * PQ[a0] * (-1.0))
                            + delta[b0][d0] * delta[b1][d1] * delta[c0][c1] * (PA_0 * PQ[a1] * (-1.0) + PA_1 * PQ[a0] * (-1.0))
                            + delta[b0][d1] * delta[b1][c0] * delta[c1][d0] * (PA_0 * PQ[a1] * (-1.0) + PA_1 * PQ[a0] * (-1.0))
                            + delta[b0][d1] * delta[b1][c1] * delta[c0][d0] * (PA_0 * PQ[a1] * (-1.0) + PA_1 * PQ[a0] * (-1.0))
                            + delta[b0][d1] * delta[b1][d0] * delta[c0][c1] * (PA_0 * PQ[a1] * (-1.0) + PA_1 * PQ[a0] * (-1.0))
                            + delta[a1][c0] * delta[b1][c1] * delta[d0][d1] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0))
                            + delta[a1][c0] * delta[b1][d0] * delta[c1][d1] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0))
                            + delta[a1][c0] * delta[b1][d1] * delta[c1][d0] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0))
                            + delta[a1][c1] * delta[b1][c0] * delta[d0][d1] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0))
                            + delta[a1][c1] * delta[b1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0))
                            + delta[a1][c1] * delta[b1][d1] * delta[c0][d0] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0))
                            + delta[a1][d0] * delta[b1][c0] * delta[c1][d1] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0))
                            + delta[a1][d0] * delta[b1][c1] * delta[c0][d1] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0))
                            + delta[a1][d0] * delta[b1][d1] * delta[c0][c1] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0))
                            + delta[a1][d1] * delta[b1][c0] * delta[c1][d0] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0))
                            + delta[a1][d1] * delta[b1][c1] * delta[c0][d0] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0))
                            + delta[a1][d1] * delta[b1][d0] * delta[c0][c1] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0))
                            + delta[a1][b1] * delta[c0][c1] * delta[d0][d1] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0) + PQ[a0] * PQ[b0])
                            + delta[a1][b1] * delta[c0][d0] * delta[c1][d1] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0) + PQ[a0] * PQ[b0])
                            + delta[a1][b1] * delta[c1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0) + PQ[a0] * PQ[b0])
                            + delta[a1][c0] * delta[b0][c1] * delta[d0][d1] * (PB_1 * PQ[a0] * (-1.0) + PA_0 * PQ[b1] * (-1.0))
                            + delta[a1][c0] * delta[b0][d0] * delta[c1][d1] * (PB_1 * PQ[a0] * (-1.0) + PA_0 * PQ[b1] * (-1.0))
                            + delta[a1][c0] * delta[b0][d1] * delta[c1][d0] * (PB_1 * PQ[a0] * (-1.0) + PA_0 * PQ[b1] * (-1.0))
                            + delta[a1][c1] * delta[b0][c0] * delta[d0][d1] * (PB_1 * PQ[a0] * (-1.0) + PA_0 * PQ[b1] * (-1.0))
                            + delta[a1][c1] * delta[b0][d0] * delta[c0][d1] * (PB_1 * PQ[a0] * (-1.0) + PA_0 * PQ[b1] * (-1.0))
                            + delta[a1][c1] * delta[b0][d1] * delta[c0][d0] * (PB_1 * PQ[a0] * (-1.0) + PA_0 * PQ[b1] * (-1.0))
                            + delta[a1][d0] * delta[b0][c0] * delta[c1][d1] * (PB_1 * PQ[a0] * (-1.0) + PA_0 * PQ[b1] * (-1.0))
                            + delta[a1][d0] * delta[b0][c1] * delta[c0][d1] * (PB_1 * PQ[a0] * (-1.0) + PA_0 * PQ[b1] * (-1.0))
                            + delta[a1][d0] * delta[b0][d1] * delta[c0][c1] * (PB_1 * PQ[a0] * (-1.0) + PA_0 * PQ[b1] * (-1.0))
                            + delta[a1][d1] * delta[b0][c0] * delta[c1][d0] * (PB_1 * PQ[a0] * (-1.0) + PA_0 * PQ[b1] * (-1.0))
                            + delta[a1][d1] * delta[b0][c1] * delta[c0][d0] * (PB_1 * PQ[a0] * (-1.0) + PA_0 * PQ[b1] * (-1.0))
                            + delta[a1][d1] * delta[b0][d0] * delta[c0][c1] * (PB_1 * PQ[a0] * (-1.0) + PA_0 * PQ[b1] * (-1.0))
                            + delta[a1][b0] * delta[c0][c1] * delta[d0][d1] * (PB_1 * PQ[a0] * (-1.0) + PA_0 * PQ[b1] * (-1.0) + PQ[a0] * PQ[b1])
                            + delta[a1][b0] * delta[c0][d0] * delta[c1][d1] * (PB_1 * PQ[a0] * (-1.0) + PA_0 * PQ[b1] * (-1.0) + PQ[a0] * PQ[b1])
                            + delta[a1][b0] * delta[c1][d0] * delta[c0][d1] * (PB_1 * PQ[a0] * (-1.0) + PA_0 * PQ[b1] * (-1.0) + PQ[a0] * PQ[b1])
                            + delta[a1][c1] * delta[b0][b1] * delta[d0][d1] * (PA_0 * PQ[c0] * (-1.0) + PQ[a0] * PQ[c0])
                            + delta[a1][c1] * delta[b0][d0] * delta[b1][d1] * (PA_0 * PQ[c0] * (-1.0))
                            + delta[a1][c1] * delta[b0][d1] * delta[b1][d0] * (PA_0 * PQ[c0] * (-1.0))
                            + delta[a1][d0] * delta[b0][b1] * delta[c1][d1] * (PA_0 * PQ[c0] * (-1.0) + PQ[a0] * PQ[c0])
                            + delta[a1][d0] * delta[b0][c1] * delta[b1][d1] * (PA_0 * PQ[c0] * (-1.0))
                            + delta[a1][d0] * delta[b0][d1] * delta[b1][c1] * (PA_0 * PQ[c0] * (-1.0))
                            + delta[a1][d1] * delta[b0][b1] * delta[c1][d0] * (PA_0 * PQ[c0] * (-1.0) + PQ[a0] * PQ[c0])
                            + delta[a1][d1] * delta[b0][c1] * delta[b1][d0] * (PA_0 * PQ[c0] * (-1.0))
                            + delta[a1][d1] * delta[b0][d0] * delta[b1][c1] * (PA_0 * PQ[c0] * (-1.0))
                            + delta[a1][b0] * delta[b1][c1] * delta[d0][d1] * (PA_0 * PQ[c0] * (-1.0) + PQ[a0] * PQ[c0])
                            + delta[a1][b0] * delta[b1][d0] * delta[c1][d1] * (PA_0 * PQ[c0] * (-1.0) + PQ[a0] * PQ[c0])
                            + delta[a1][b0] * delta[b1][d1] * delta[c1][d0] * (PA_0 * PQ[c0] * (-1.0) + PQ[a0] * PQ[c0])
                            + delta[b0][c1] * delta[a1][b1] * delta[d0][d1] * (PA_0 * PQ[c0] * (-1.0) + PQ[a0] * PQ[c0])
                            + delta[b0][d0] * delta[a1][b1] * delta[c1][d1] * (PA_0 * PQ[c0] * (-1.0) + PQ[a0] * PQ[c0])
                            + delta[b0][d1] * delta[a1][b1] * delta[c1][d0] * (PA_0 * PQ[c0] * (-1.0) + PQ[a0] * PQ[c0])
                            + delta[a1][c0] * delta[b0][b1] * delta[d0][d1] * (PA_0 * PQ[c1] * (-1.0) + PQ[a0] * PQ[c1])
                            + delta[a1][c0] * delta[b0][d0] * delta[b1][d1] * (PA_0 * PQ[c1] * (-1.0))
                            + delta[a1][c0] * delta[b0][d1] * delta[b1][d0] * (PA_0 * PQ[c1] * (-1.0))
                            + delta[a1][d0] * delta[b0][b1] * delta[c0][d1] * (PA_0 * PQ[c1] * (-1.0) + PQ[a0] * PQ[c1])
                            + delta[a1][d0] * delta[b0][c0] * delta[b1][d1] * (PA_0 * PQ[c1] * (-1.0))
                            + delta[a1][d0] * delta[b0][d1] * delta[b1][c0] * (PA_0 * PQ[c1] * (-1.0))
                            + delta[a1][d1] * delta[b0][b1] * delta[c0][d0] * (PA_0 * PQ[c1] * (-1.0) + PQ[a0] * PQ[c1])
                            + delta[a1][d1] * delta[b0][c0] * delta[b1][d0] * (PA_0 * PQ[c1] * (-1.0))
                            + delta[a1][d1] * delta[b0][d0] * delta[b1][c0] * (PA_0 * PQ[c1] * (-1.0))
                            + delta[a1][b0] * delta[b1][c0] * delta[d0][d1] * (PA_0 * PQ[c1] * (-1.0) + PQ[a0] * PQ[c1])
                            + delta[a1][b0] * delta[b1][d0] * delta[c0][d1] * (PA_0 * PQ[c1] * (-1.0) + PQ[a0] * PQ[c1])
                            + delta[a1][b0] * delta[b1][d1] * delta[c0][d0] * (PA_0 * PQ[c1] * (-1.0) + PQ[a0] * PQ[c1])
                            + delta[b0][c0] * delta[a1][b1] * delta[d0][d1] * (PA_0 * PQ[c1] * (-1.0) + PQ[a0] * PQ[c1])
                            + delta[b0][d0] * delta[a1][b1] * delta[c0][d1] * (PA_0 * PQ[c1] * (-1.0) + PQ[a0] * PQ[c1])
                            + delta[b0][d1] * delta[a1][b1] * delta[c0][d0] * (PA_0 * PQ[c1] * (-1.0) + PQ[a0] * PQ[c1])
                            + delta[a1][c0] * delta[b0][b1] * delta[c1][d1] * (PA_0 * PQ[d0] * (-1.0) + PQ[a0] * PQ[d0])
                            + delta[a1][c0] * delta[b0][c1] * delta[b1][d1] * (PA_0 * PQ[d0] * (-1.0))
                            + delta[a1][c0] * delta[b0][d1] * delta[b1][c1] * (PA_0 * PQ[d0] * (-1.0))
                            + delta[a1][c1] * delta[b0][b1] * delta[c0][d1] * (PA_0 * PQ[d0] * (-1.0) + PQ[a0] * PQ[d0])
                            + delta[a1][c1] * delta[b0][c0] * delta[b1][d1] * (PA_0 * PQ[d0] * (-1.0))
                            + delta[a1][c1] * delta[b0][d1] * delta[b1][c0] * (PA_0 * PQ[d0] * (-1.0))
                            + delta[a1][d1] * delta[b0][b1] * delta[c0][c1] * (PA_0 * PQ[d0] * (-1.0) + PQ[a0] * PQ[d0])
                            + delta[a1][d1] * delta[b0][c0] * delta[b1][c1] * (PA_0 * PQ[d0] * (-1.0))
                            + delta[a1][d1] * delta[b0][c1] * delta[b1][c0] * (PA_0 * PQ[d0] * (-1.0))
                            + delta[a1][b0] * delta[b1][c0] * delta[c1][d1] * (PA_0 * PQ[d0] * (-1.0) + PQ[a0] * PQ[d0])
                            + delta[a1][b0] * delta[b1][c1] * delta[c0][d1] * (PA_0 * PQ[d0] * (-1.0) + PQ[a0] * PQ[d0])
                            + delta[a1][b0] * delta[b1][d1] * delta[c0][c1] * (PA_0 * PQ[d0] * (-1.0) + PQ[a0] * PQ[d0])
                            + delta[b0][c0] * delta[a1][b1] * delta[c1][d1] * (PA_0 * PQ[d0] * (-1.0) + PQ[a0] * PQ[d0])
                            + delta[b0][c1] * delta[a1][b1] * delta[c0][d1] * (PA_0 * PQ[d0] * (-1.0) + PQ[a0] * PQ[d0])
                            + delta[b0][d1] * delta[a1][b1] * delta[c0][c1] * (PA_0 * PQ[d0] * (-1.0) + PQ[a0] * PQ[d0])
                            + delta[a1][c0] * delta[b0][b1] * delta[c1][d0] * (PA_0 * PQ[d1] * (-1.0) + PQ[a0] * PQ[d1])
                            + delta[a1][c0] * delta[b0][c1] * delta[b1][d0] * (PA_0 * PQ[d1] * (-1.0))
                            + delta[a1][c0] * delta[b0][d0] * delta[b1][c1] * (PA_0 * PQ[d1] * (-1.0))
                            + delta[a1][c1] * delta[b0][b1] * delta[c0][d0] * (PA_0 * PQ[d1] * (-1.0) + PQ[a0] * PQ[d1])
                            + delta[a1][c1] * delta[b0][c0] * delta[b1][d0] * (PA_0 * PQ[d1] * (-1.0))
                            + delta[a1][c1] * delta[b0][d0] * delta[b1][c0] * (PA_0 * PQ[d1] * (-1.0))
                            + delta[a1][d0] * delta[b0][b1] * delta[c0][c1] * (PA_0 * PQ[d1] * (-1.0) + PQ[a0] * PQ[d1])
                            + delta[a1][d0] * delta[b0][c0] * delta[b1][c1] * (PA_0 * PQ[d1] * (-1.0))
                            + delta[a1][d0] * delta[b0][c1] * delta[b1][c0] * (PA_0 * PQ[d1] * (-1.0))
                            + delta[a1][b0] * delta[b1][c0] * delta[c1][d0] * (PA_0 * PQ[d1] * (-1.0) + PQ[a0] * PQ[d1])
                            + delta[a1][b0] * delta[b1][c1] * delta[c0][d0] * (PA_0 * PQ[d1] * (-1.0) + PQ[a0] * PQ[d1])
                            + delta[a1][b0] * delta[b1][d0] * delta[c0][c1] * (PA_0 * PQ[d1] * (-1.0) + PQ[a0] * PQ[d1])
                            + delta[b0][c0] * delta[a1][b1] * delta[c1][d0] * (PA_0 * PQ[d1] * (-1.0) + PQ[a0] * PQ[d1])
                            + delta[b0][c1] * delta[a1][b1] * delta[c0][d0] * (PA_0 * PQ[d1] * (-1.0) + PQ[a0] * PQ[d1])
                            + delta[b0][d0] * delta[a1][b1] * delta[c0][c1] * (PA_0 * PQ[d1] * (-1.0) + PQ[a0] * PQ[d1])
                            + delta[a0][c0] * delta[b1][c1] * delta[d0][d1] * (PB_0 * PQ[a1] * (-1.0) + PA_1 * PQ[b0] * (-1.0))
                            + delta[a0][c0] * delta[b1][d0] * delta[c1][d1] * (PB_0 * PQ[a1] * (-1.0) + PA_1 * PQ[b0] * (-1.0))
                            + delta[a0][c0] * delta[b1][d1] * delta[c1][d0] * (PB_0 * PQ[a1] * (-1.0) + PA_1 * PQ[b0] * (-1.0))
                            + delta[a0][c1] * delta[b1][c0] * delta[d0][d1] * (PB_0 * PQ[a1] * (-1.0) + PA_1 * PQ[b0] * (-1.0))
                            + delta[a0][c1] * delta[b1][d0] * delta[c0][d1] * (PB_0 * PQ[a1] * (-1.0) + PA_1 * PQ[b0] * (-1.0))
                            + delta[a0][c1] * delta[b1][d1] * delta[c0][d0] * (PB_0 * PQ[a1] * (-1.0) + PA_1 * PQ[b0] * (-1.0))
                            + delta[a0][d0] * delta[b1][c0] * delta[c1][d1] * (PB_0 * PQ[a1] * (-1.0) + PA_1 * PQ[b0] * (-1.0))
                            + delta[a0][d0] * delta[b1][c1] * delta[c0][d1] * (PB_0 * PQ[a1] * (-1.0) + PA_1 * PQ[b0] * (-1.0))
                            + delta[a0][d0] * delta[b1][d1] * delta[c0][c1] * (PB_0 * PQ[a1] * (-1.0) + PA_1 * PQ[b0] * (-1.0))
                            + delta[a0][d1] * delta[b1][c0] * delta[c1][d0] * (PB_0 * PQ[a1] * (-1.0) + PA_1 * PQ[b0] * (-1.0))
                            + delta[a0][d1] * delta[b1][c1] * delta[c0][d0] * (PB_0 * PQ[a1] * (-1.0) + PA_1 * PQ[b0] * (-1.0))
                            + delta[a0][d1] * delta[b1][d0] * delta[c0][c1] * (PB_0 * PQ[a1] * (-1.0) + PA_1 * PQ[b0] * (-1.0))
                            + delta[a0][b1] * delta[c0][c1] * delta[d0][d1] * (PB_0 * PQ[a1] * (-1.0) + PA_1 * PQ[b0] * (-1.0) + PQ[a1] * PQ[b0])
                            + delta[a0][b1] * delta[c0][d0] * delta[c1][d1] * (PB_0 * PQ[a1] * (-1.0) + PA_1 * PQ[b0] * (-1.0) + PQ[a1] * PQ[b0])
                            + delta[a0][b1] * delta[c1][d0] * delta[c0][d1] * (PB_0 * PQ[a1] * (-1.0) + PA_1 * PQ[b0] * (-1.0) + PQ[a1] * PQ[b0])
                            + delta[a0][c0] * delta[b0][c1] * delta[d0][d1] * (PB_1 * PQ[a1] * (-1.0) + PA_1 * PQ[b1] * (-1.0))
                            + delta[a0][c0] * delta[b0][d0] * delta[c1][d1] * (PB_1 * PQ[a1] * (-1.0) + PA_1 * PQ[b1] * (-1.0))
                            + delta[a0][c0] * delta[b0][d1] * delta[c1][d0] * (PB_1 * PQ[a1] * (-1.0) + PA_1 * PQ[b1] * (-1.0))
                            + delta[a0][c1] * delta[b0][c0] * delta[d0][d1] * (PB_1 * PQ[a1] * (-1.0) + PA_1 * PQ[b1] * (-1.0))
                            + delta[a0][c1] * delta[b0][d0] * delta[c0][d1] * (PB_1 * PQ[a1] * (-1.0) + PA_1 * PQ[b1] * (-1.0))
                            + delta[a0][c1] * delta[b0][d1] * delta[c0][d0] * (PB_1 * PQ[a1] * (-1.0) + PA_1 * PQ[b1] * (-1.0))
                            + delta[a0][d0] * delta[b0][c0] * delta[c1][d1] * (PB_1 * PQ[a1] * (-1.0) + PA_1 * PQ[b1] * (-1.0))
                            + delta[a0][d0] * delta[b0][c1] * delta[c0][d1] * (PB_1 * PQ[a1] * (-1.0) + PA_1 * PQ[b1] * (-1.0))
                            + delta[a0][d0] * delta[b0][d1] * delta[c0][c1] * (PB_1 * PQ[a1] * (-1.0) + PA_1 * PQ[b1] * (-1.0))
                            + delta[a0][d1] * delta[b0][c0] * delta[c1][d0] * (PB_1 * PQ[a1] * (-1.0) + PA_1 * PQ[b1] * (-1.0))
                            + delta[a0][d1] * delta[b0][c1] * delta[c0][d0] * (PB_1 * PQ[a1] * (-1.0) + PA_1 * PQ[b1] * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * delta[c0][c1] * (PB_1 * PQ[a1] * (-1.0) + PA_1 * PQ[b1] * (-1.0))
                            + delta[a0][b0] * delta[c0][c1] * delta[d0][d1] * (PB_1 * PQ[a1] * (-1.0) + PA_1 * PQ[b1] * (-1.0) + PQ[a1] * PQ[b1])
                            + delta[a0][b0] * delta[c0][d0] * delta[c1][d1] * (PB_1 * PQ[a1] * (-1.0) + PA_1 * PQ[b1] * (-1.0) + PQ[a1] * PQ[b1])
                            + delta[a0][b0] * delta[c1][d0] * delta[c0][d1] * (PB_1 * PQ[a1] * (-1.0) + PA_1 * PQ[b1] * (-1.0) + PQ[a1] * PQ[b1])
                            + delta[a0][c1] * delta[b0][b1] * delta[d0][d1] * (PA_1 * PQ[c0] * (-1.0) + PQ[a1] * PQ[c0])
                            + delta[a0][c1] * delta[b0][d0] * delta[b1][d1] * (PA_1 * PQ[c0] * (-1.0))
                            + delta[a0][c1] * delta[b0][d1] * delta[b1][d0] * (PA_1 * PQ[c0] * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * delta[c1][d1] * (PA_1 * PQ[c0] * (-1.0) + PQ[a1] * PQ[c0])
                            + delta[a0][d0] * delta[b0][c1] * delta[b1][d1] * (PA_1 * PQ[c0] * (-1.0))
                            + delta[a0][d0] * delta[b0][d1] * delta[b1][c1] * (PA_1 * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * delta[c1][d0] * (PA_1 * PQ[c0] * (-1.0) + PQ[a1] * PQ[c0])
                            + delta[a0][d1] * delta[b0][c1] * delta[b1][d0] * (PA_1 * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * delta[b1][c1] * (PA_1 * PQ[c0] * (-1.0))
                            + delta[a0][b0] * delta[b1][c1] * delta[d0][d1] * (PA_1 * PQ[c0] * (-1.0) + PQ[a1] * PQ[c0])
                            + delta[a0][b0] * delta[b1][d0] * delta[c1][d1] * (PA_1 * PQ[c0] * (-1.0) + PQ[a1] * PQ[c0])
                            + delta[a0][b0] * delta[b1][d1] * delta[c1][d0] * (PA_1 * PQ[c0] * (-1.0) + PQ[a1] * PQ[c0])
                            + delta[b0][c1] * delta[a0][b1] * delta[d0][d1] * (PA_1 * PQ[c0] * (-1.0) + PQ[a1] * PQ[c0])
                            + delta[b0][d0] * delta[a0][b1] * delta[c1][d1] * (PA_1 * PQ[c0] * (-1.0) + PQ[a1] * PQ[c0])
                            + delta[b0][d1] * delta[a0][b1] * delta[c1][d0] * (PA_1 * PQ[c0] * (-1.0) + PQ[a1] * PQ[c0])
                            + delta[a0][c0] * delta[b0][b1] * delta[d0][d1] * (PA_1 * PQ[c1] * (-1.0) + PQ[a1] * PQ[c1])
                            + delta[a0][c0] * delta[b0][d0] * delta[b1][d1] * (PA_1 * PQ[c1] * (-1.0))
                            + delta[a0][c0] * delta[b0][d1] * delta[b1][d0] * (PA_1 * PQ[c1] * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][d1] * (PA_1 * PQ[c1] * (-1.0) + PQ[a1] * PQ[c1])
                            + delta[a0][d0] * delta[b0][c0] * delta[b1][d1] * (PA_1 * PQ[c1] * (-1.0))
                            + delta[a0][d0] * delta[b0][d1] * delta[b1][c0] * (PA_1 * PQ[c1] * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][d0] * (PA_1 * PQ[c1] * (-1.0) + PQ[a1] * PQ[c1])
                            + delta[a0][d1] * delta[b0][c0] * delta[b1][d0] * (PA_1 * PQ[c1] * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * delta[b1][c0] * (PA_1 * PQ[c1] * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * delta[d0][d1] * (PA_1 * PQ[c1] * (-1.0) + PQ[a1] * PQ[c1])
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][d1] * (PA_1 * PQ[c1] * (-1.0) + PQ[a1] * PQ[c1])
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][d0] * (PA_1 * PQ[c1] * (-1.0) + PQ[a1] * PQ[c1])
                            + delta[b0][c0] * delta[a0][b1] * delta[d0][d1] * (PA_1 * PQ[c1] * (-1.0) + PQ[a1] * PQ[c1])
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][d1] * (PA_1 * PQ[c1] * (-1.0) + PQ[a1] * PQ[c1])
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][d0] * (PA_1 * PQ[c1] * (-1.0) + PQ[a1] * PQ[c1])
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d1] * (PA_1 * PQ[d0] * (-1.0) + PQ[a1] * PQ[d0])
                            + delta[a0][c0] * delta[b0][c1] * delta[b1][d1] * (PA_1 * PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[b0][d1] * delta[b1][c1] * (PA_1 * PQ[d0] * (-1.0))
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d1] * (PA_1 * PQ[d0] * (-1.0) + PQ[a1] * PQ[d0])
                            + delta[a0][c1] * delta[b0][c0] * delta[b1][d1] * (PA_1 * PQ[d0] * (-1.0))
                            + delta[a0][c1] * delta[b0][d1] * delta[b1][c0] * (PA_1 * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][c1] * (PA_1 * PQ[d0] * (-1.0) + PQ[a1] * PQ[d0])
                            + delta[a0][d1] * delta[b0][c0] * delta[b1][c1] * (PA_1 * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[b0][c1] * delta[b1][c0] * (PA_1 * PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d1] * (PA_1 * PQ[d0] * (-1.0) + PQ[a1] * PQ[d0])
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d1] * (PA_1 * PQ[d0] * (-1.0) + PQ[a1] * PQ[d0])
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][c1] * (PA_1 * PQ[d0] * (-1.0) + PQ[a1] * PQ[d0])
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d1] * (PA_1 * PQ[d0] * (-1.0) + PQ[a1] * PQ[d0])
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d1] * (PA_1 * PQ[d0] * (-1.0) + PQ[a1] * PQ[d0])
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][c1] * (PA_1 * PQ[d0] * (-1.0) + PQ[a1] * PQ[d0])
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d0] * (PA_1 * PQ[d1] * (-1.0) + PQ[a1] * PQ[d1])
                            + delta[a0][c0] * delta[b0][c1] * delta[b1][d0] * (PA_1 * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[b0][d0] * delta[b1][c1] * (PA_1 * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d0] * (PA_1 * PQ[d1] * (-1.0) + PQ[a1] * PQ[d1])
                            + delta[a0][c1] * delta[b0][c0] * delta[b1][d0] * (PA_1 * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[b0][d0] * delta[b1][c0] * (PA_1 * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][c1] * (PA_1 * PQ[d1] * (-1.0) + PQ[a1] * PQ[d1])
                            + delta[a0][d0] * delta[b0][c0] * delta[b1][c1] * (PA_1 * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[b0][c1] * delta[b1][c0] * (PA_1 * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d0] * (PA_1 * PQ[d1] * (-1.0) + PQ[a1] * PQ[d1])
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d0] * (PA_1 * PQ[d1] * (-1.0) + PQ[a1] * PQ[d1])
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][c1] * (PA_1 * PQ[d1] * (-1.0) + PQ[a1] * PQ[d1])
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d0] * (PA_1 * PQ[d1] * (-1.0) + PQ[a1] * PQ[d1])
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d0] * (PA_1 * PQ[d1] * (-1.0) + PQ[a1] * PQ[d1])
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][c1] * (PA_1 * PQ[d1] * (-1.0) + PQ[a1] * PQ[d1])
                            + delta[a0][c0] * delta[a1][c1] * delta[d0][d1] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0))
                            + delta[a0][c0] * delta[a1][d0] * delta[c1][d1] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0))
                            + delta[a0][c0] * delta[a1][d1] * delta[c1][d0] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0))
                            + delta[a0][c1] * delta[a1][c0] * delta[d0][d1] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0))
                            + delta[a0][c1] * delta[a1][d0] * delta[c0][d1] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0))
                            + delta[a0][c1] * delta[a1][d1] * delta[c0][d0] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0))
                            + delta[a0][d0] * delta[a1][c0] * delta[c1][d1] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0))
                            + delta[a0][d0] * delta[a1][c1] * delta[c0][d1] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0))
                            + delta[a0][d0] * delta[a1][d1] * delta[c0][c1] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0))
                            + delta[a0][d1] * delta[a1][c0] * delta[c1][d0] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0))
                            + delta[a0][d1] * delta[a1][c1] * delta[c0][d0] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0))
                            + delta[a0][d1] * delta[a1][d0] * delta[c0][c1] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0))
                            + delta[a0][a1] * delta[c0][c1] * delta[d0][d1] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0) + PQ[b0] * PQ[b1])
                            + delta[a0][a1] * delta[c0][d0] * delta[c1][d1] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0) + PQ[b0] * PQ[b1])
                            + delta[a0][a1] * delta[c1][d0] * delta[c0][d1] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0) + PQ[b0] * PQ[b1])
                            + delta[a0][c1] * delta[a1][d0] * delta[b1][d1] * (PB_0 * PQ[c0] * (-1.0))
                            + delta[a0][c1] * delta[a1][d1] * delta[b1][d0] * (PB_0 * PQ[c0] * (-1.0))
                            + delta[a0][c1] * delta[a1][b1] * delta[d0][d1] * (PB_0 * PQ[c0] * (-1.0) + PQ[b0] * PQ[c0])
                            + delta[a0][d0] * delta[a1][c1] * delta[b1][d1] * (PB_0 * PQ[c0] * (-1.0))
                            + delta[a0][d0] * delta[a1][d1] * delta[b1][c1] * (PB_0 * PQ[c0] * (-1.0))
                            + delta[a0][d0] * delta[a1][b1] * delta[c1][d1] * (PB_0 * PQ[c0] * (-1.0) + PQ[b0] * PQ[c0])
                            + delta[a0][d1] * delta[a1][c1] * delta[b1][d0] * (PB_0 * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[a1][d0] * delta[b1][c1] * (PB_0 * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[a1][b1] * delta[c1][d0] * (PB_0 * PQ[c0] * (-1.0) + PQ[b0] * PQ[c0])
                            + delta[a0][a1] * delta[b1][c1] * delta[d0][d1] * (PB_0 * PQ[c0] * (-1.0) + PQ[b0] * PQ[c0])
                            + delta[a0][a1] * delta[b1][d0] * delta[c1][d1] * (PB_0 * PQ[c0] * (-1.0) + PQ[b0] * PQ[c0])
                            + delta[a0][a1] * delta[b1][d1] * delta[c1][d0] * (PB_0 * PQ[c0] * (-1.0) + PQ[b0] * PQ[c0])
                            + delta[a1][c1] * delta[a0][b1] * delta[d0][d1] * (PB_0 * PQ[c0] * (-1.0) + PQ[b0] * PQ[c0])
                            + delta[a1][d0] * delta[a0][b1] * delta[c1][d1] * (PB_0 * PQ[c0] * (-1.0) + PQ[b0] * PQ[c0])
                            + delta[a1][d1] * delta[a0][b1] * delta[c1][d0] * (PB_0 * PQ[c0] * (-1.0) + PQ[b0] * PQ[c0])
                            + delta[a0][c0] * delta[a1][d0] * delta[b1][d1] * (PB_0 * PQ[c1] * (-1.0))
                            + delta[a0][c0] * delta[a1][d1] * delta[b1][d0] * (PB_0 * PQ[c1] * (-1.0))
                            + delta[a0][c0] * delta[a1][b1] * delta[d0][d1] * (PB_0 * PQ[c1] * (-1.0) + PQ[b0] * PQ[c1])
                            + delta[a0][d0] * delta[a1][c0] * delta[b1][d1] * (PB_0 * PQ[c1] * (-1.0))
                            + delta[a0][d0] * delta[a1][d1] * delta[b1][c0] * (PB_0 * PQ[c1] * (-1.0))
                            + delta[a0][d0] * delta[a1][b1] * delta[c0][d1] * (PB_0 * PQ[c1] * (-1.0) + PQ[b0] * PQ[c1])
                            + delta[a0][d1] * delta[a1][c0] * delta[b1][d0] * (PB_0 * PQ[c1] * (-1.0))
                            + delta[a0][d1] * delta[a1][d0] * delta[b1][c0] * (PB_0 * PQ[c1] * (-1.0))
                            + delta[a0][d1] * delta[a1][b1] * delta[c0][d0] * (PB_0 * PQ[c1] * (-1.0) + PQ[b0] * PQ[c1])
                            + delta[a0][a1] * delta[b1][c0] * delta[d0][d1] * (PB_0 * PQ[c1] * (-1.0) + PQ[b0] * PQ[c1])
                            + delta[a0][a1] * delta[b1][d0] * delta[c0][d1] * (PB_0 * PQ[c1] * (-1.0) + PQ[b0] * PQ[c1])
                            + delta[a0][a1] * delta[b1][d1] * delta[c0][d0] * (PB_0 * PQ[c1] * (-1.0) + PQ[b0] * PQ[c1])
                            + delta[a1][c0] * delta[a0][b1] * delta[d0][d1] * (PB_0 * PQ[c1] * (-1.0) + PQ[b0] * PQ[c1])
                            + delta[a1][d0] * delta[a0][b1] * delta[c0][d1] * (PB_0 * PQ[c1] * (-1.0) + PQ[b0] * PQ[c1])
                            + delta[a1][d1] * delta[a0][b1] * delta[c0][d0] * (PB_0 * PQ[c1] * (-1.0) + PQ[b0] * PQ[c1])
                            + delta[a0][c0] * delta[a1][c1] * delta[b1][d1] * (PB_0 * PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[a1][d1] * delta[b1][c1] * (PB_0 * PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[a1][b1] * delta[c1][d1] * (PB_0 * PQ[d0] * (-1.0) + PQ[b0] * PQ[d0])
                            + delta[a0][c1] * delta[a1][c0] * delta[b1][d1] * (PB_0 * PQ[d0] * (-1.0))
                            + delta[a0][c1] * delta[a1][d1] * delta[b1][c0] * (PB_0 * PQ[d0] * (-1.0))
                            + delta[a0][c1] * delta[a1][b1] * delta[c0][d1] * (PB_0 * PQ[d0] * (-1.0) + PQ[b0] * PQ[d0])
                            + delta[a0][d1] * delta[a1][c0] * delta[b1][c1] * (PB_0 * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[a1][c1] * delta[b1][c0] * (PB_0 * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[a1][b1] * delta[c0][c1] * (PB_0 * PQ[d0] * (-1.0) + PQ[b0] * PQ[d0])
                            + delta[a0][a1] * delta[b1][c0] * delta[c1][d1] * (PB_0 * PQ[d0] * (-1.0) + PQ[b0] * PQ[d0])
                            + delta[a0][a1] * delta[b1][c1] * delta[c0][d1] * (PB_0 * PQ[d0] * (-1.0) + PQ[b0] * PQ[d0])
                            + delta[a0][a1] * delta[b1][d1] * delta[c0][c1] * (PB_0 * PQ[d0] * (-1.0) + PQ[b0] * PQ[d0])
                            + delta[a1][c0] * delta[a0][b1] * delta[c1][d1] * (PB_0 * PQ[d0] * (-1.0) + PQ[b0] * PQ[d0])
                            + delta[a1][c1] * delta[a0][b1] * delta[c0][d1] * (PB_0 * PQ[d0] * (-1.0) + PQ[b0] * PQ[d0])
                            + delta[a1][d1] * delta[a0][b1] * delta[c0][c1] * (PB_0 * PQ[d0] * (-1.0) + PQ[b0] * PQ[d0])
                            + delta[a0][c0] * delta[a1][c1] * delta[b1][d0] * (PB_0 * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[a1][d0] * delta[b1][c1] * (PB_0 * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[a1][b1] * delta[c1][d0] * (PB_0 * PQ[d1] * (-1.0) + PQ[b0] * PQ[d1])
                            + delta[a0][c1] * delta[a1][c0] * delta[b1][d0] * (PB_0 * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[a1][d0] * delta[b1][c0] * (PB_0 * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[a1][b1] * delta[c0][d0] * (PB_0 * PQ[d1] * (-1.0) + PQ[b0] * PQ[d1])
                            + delta[a0][d0] * delta[a1][c0] * delta[b1][c1] * (PB_0 * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[a1][c1] * delta[b1][c0] * (PB_0 * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[a1][b1] * delta[c0][c1] * (PB_0 * PQ[d1] * (-1.0) + PQ[b0] * PQ[d1])
                            + delta[a0][a1] * delta[b1][c0] * delta[c1][d0] * (PB_0 * PQ[d1] * (-1.0) + PQ[b0] * PQ[d1])
                            + delta[a0][a1] * delta[b1][c1] * delta[c0][d0] * (PB_0 * PQ[d1] * (-1.0) + PQ[b0] * PQ[d1])
                            + delta[a0][a1] * delta[b1][d0] * delta[c0][c1] * (PB_0 * PQ[d1] * (-1.0) + PQ[b0] * PQ[d1])
                            + delta[a1][c0] * delta[a0][b1] * delta[c1][d0] * (PB_0 * PQ[d1] * (-1.0) + PQ[b0] * PQ[d1])
                            + delta[a1][c1] * delta[a0][b1] * delta[c0][d0] * (PB_0 * PQ[d1] * (-1.0) + PQ[b0] * PQ[d1])
                            + delta[a1][d0] * delta[a0][b1] * delta[c0][c1] * (PB_0 * PQ[d1] * (-1.0) + PQ[b0] * PQ[d1])
                            + delta[a0][c1] * delta[a1][d0] * delta[b0][d1] * (PB_1 * PQ[c0] * (-1.0))
                            + delta[a0][c1] * delta[a1][d1] * delta[b0][d0] * (PB_1 * PQ[c0] * (-1.0))
                            + delta[a0][c1] * delta[a1][b0] * delta[d0][d1] * (PB_1 * PQ[c0] * (-1.0) + PQ[b1] * PQ[c0])
                            + delta[a0][d0] * delta[a1][c1] * delta[b0][d1] * (PB_1 * PQ[c0] * (-1.0))
                            + delta[a0][d0] * delta[a1][d1] * delta[b0][c1] * (PB_1 * PQ[c0] * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * delta[c1][d1] * (PB_1 * PQ[c0] * (-1.0) + PQ[b1] * PQ[c0])
                            + delta[a0][d1] * delta[a1][c1] * delta[b0][d0] * (PB_1 * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][c1] * (PB_1 * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * delta[c1][d0] * (PB_1 * PQ[c0] * (-1.0) + PQ[b1] * PQ[c0])
                            + delta[a0][a1] * delta[b0][c1] * delta[d0][d1] * (PB_1 * PQ[c0] * (-1.0) + PQ[b1] * PQ[c0])
                            + delta[a0][a1] * delta[b0][d0] * delta[c1][d1] * (PB_1 * PQ[c0] * (-1.0) + PQ[b1] * PQ[c0])
                            + delta[a0][a1] * delta[b0][d1] * delta[c1][d0] * (PB_1 * PQ[c0] * (-1.0) + PQ[b1] * PQ[c0])
                            + delta[a1][c1] * delta[a0][b0] * delta[d0][d1] * (PB_1 * PQ[c0] * (-1.0) + PQ[b1] * PQ[c0])
                            + delta[a1][d0] * delta[a0][b0] * delta[c1][d1] * (PB_1 * PQ[c0] * (-1.0) + PQ[b1] * PQ[c0])
                            + delta[a1][d1] * delta[a0][b0] * delta[c1][d0] * (PB_1 * PQ[c0] * (-1.0) + PQ[b1] * PQ[c0])
                            + delta[a0][c0] * delta[a1][d0] * delta[b0][d1] * (PB_1 * PQ[c1] * (-1.0))
                            + delta[a0][c0] * delta[a1][d1] * delta[b0][d0] * (PB_1 * PQ[c1] * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * delta[d0][d1] * (PB_1 * PQ[c1] * (-1.0) + PQ[b1] * PQ[c1])
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][d1] * (PB_1 * PQ[c1] * (-1.0))
                            + delta[a0][d0] * delta[a1][d1] * delta[b0][c0] * (PB_1 * PQ[c1] * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * delta[c0][d1] * (PB_1 * PQ[c1] * (-1.0) + PQ[b1] * PQ[c1])
                            + delta[a0][d1] * delta[a1][c0] * delta[b0][d0] * (PB_1 * PQ[c1] * (-1.0))
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][c0] * (PB_1 * PQ[c1] * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * delta[c0][d0] * (PB_1 * PQ[c1] * (-1.0) + PQ[b1] * PQ[c1])
                            + delta[a0][a1] * delta[b0][c0] * delta[d0][d1] * (PB_1 * PQ[c1] * (-1.0) + PQ[b1] * PQ[c1])
                            + delta[a0][a1] * delta[b0][d0] * delta[c0][d1] * (PB_1 * PQ[c1] * (-1.0) + PQ[b1] * PQ[c1])
                            + delta[a0][a1] * delta[b0][d1] * delta[c0][d0] * (PB_1 * PQ[c1] * (-1.0) + PQ[b1] * PQ[c1])
                            + delta[a1][c0] * delta[a0][b0] * delta[d0][d1] * (PB_1 * PQ[c1] * (-1.0) + PQ[b1] * PQ[c1])
                            + delta[a1][d0] * delta[a0][b0] * delta[c0][d1] * (PB_1 * PQ[c1] * (-1.0) + PQ[b1] * PQ[c1])
                            + delta[a1][d1] * delta[a0][b0] * delta[c0][d0] * (PB_1 * PQ[c1] * (-1.0) + PQ[b1] * PQ[c1])
                            + delta[a0][c0] * delta[a1][c1] * delta[b0][d1] * (PB_1 * PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[a1][d1] * delta[b0][c1] * (PB_1 * PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * delta[c1][d1] * (PB_1 * PQ[d0] * (-1.0) + PQ[b1] * PQ[d0])
                            + delta[a0][c1] * delta[a1][c0] * delta[b0][d1] * (PB_1 * PQ[d0] * (-1.0))
                            + delta[a0][c1] * delta[a1][d1] * delta[b0][c0] * (PB_1 * PQ[d0] * (-1.0))
                            + delta[a0][c1] * delta[a1][b0] * delta[c0][d1] * (PB_1 * PQ[d0] * (-1.0) + PQ[b1] * PQ[d0])
                            + delta[a0][d1] * delta[a1][c0] * delta[b0][c1] * (PB_1 * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[a1][c1] * delta[b0][c0] * (PB_1 * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * delta[c0][c1] * (PB_1 * PQ[d0] * (-1.0) + PQ[b1] * PQ[d0])
                            + delta[a0][a1] * delta[b0][c0] * delta[c1][d1] * (PB_1 * PQ[d0] * (-1.0) + PQ[b1] * PQ[d0])
                            + delta[a0][a1] * delta[b0][c1] * delta[c0][d1] * (PB_1 * PQ[d0] * (-1.0) + PQ[b1] * PQ[d0])
                            + delta[a0][a1] * delta[b0][d1] * delta[c0][c1] * (PB_1 * PQ[d0] * (-1.0) + PQ[b1] * PQ[d0])
                            + delta[a1][c0] * delta[a0][b0] * delta[c1][d1] * (PB_1 * PQ[d0] * (-1.0) + PQ[b1] * PQ[d0])
                            + delta[a1][c1] * delta[a0][b0] * delta[c0][d1] * (PB_1 * PQ[d0] * (-1.0) + PQ[b1] * PQ[d0])
                            + delta[a1][d1] * delta[a0][b0] * delta[c0][c1] * (PB_1 * PQ[d0] * (-1.0) + PQ[b1] * PQ[d0])
                            + delta[a0][c0] * delta[a1][c1] * delta[b0][d0] * (PB_1 * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[a1][d0] * delta[b0][c1] * (PB_1 * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * delta[c1][d0] * (PB_1 * PQ[d1] * (-1.0) + PQ[b1] * PQ[d1])
                            + delta[a0][c1] * delta[a1][c0] * delta[b0][d0] * (PB_1 * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[a1][d0] * delta[b0][c0] * (PB_1 * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[a1][b0] * delta[c0][d0] * (PB_1 * PQ[d1] * (-1.0) + PQ[b1] * PQ[d1])
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][c1] * (PB_1 * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[a1][c1] * delta[b0][c0] * (PB_1 * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * delta[c0][c1] * (PB_1 * PQ[d1] * (-1.0) + PQ[b1] * PQ[d1])
                            + delta[a0][a1] * delta[b0][c0] * delta[c1][d0] * (PB_1 * PQ[d1] * (-1.0) + PQ[b1] * PQ[d1])
                            + delta[a0][a1] * delta[b0][c1] * delta[c0][d0] * (PB_1 * PQ[d1] * (-1.0) + PQ[b1] * PQ[d1])
                            + delta[a0][a1] * delta[b0][d0] * delta[c0][c1] * (PB_1 * PQ[d1] * (-1.0) + PQ[b1] * PQ[d1])
                            + delta[a1][c0] * delta[a0][b0] * delta[c1][d0] * (PB_1 * PQ[d1] * (-1.0) + PQ[b1] * PQ[d1])
                            + delta[a1][c1] * delta[a0][b0] * delta[c0][d0] * (PB_1 * PQ[d1] * (-1.0) + PQ[b1] * PQ[d1])
                            + delta[a1][d0] * delta[a0][b0] * delta[c0][c1] * (PB_1 * PQ[d1] * (-1.0) + PQ[b1] * PQ[d1])
                            + delta[a0][d0] * delta[a1][d1] * delta[b0][b1] * (PQ[c0] * PQ[c1])
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][d1] * (PQ[c0] * PQ[c1])
                            + delta[a0][d0] * delta[b0][d1] * delta[a1][b1] * (PQ[c0] * PQ[c1])
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][b1] * (PQ[c0] * PQ[c1])
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][d0] * (PQ[c0] * PQ[c1])
                            + delta[a0][d1] * delta[b0][d0] * delta[a1][b1] * (PQ[c0] * PQ[c1])
                            + delta[a0][a1] * delta[b0][b1] * delta[d0][d1] * (PQ[c0] * PQ[c1] * 2.0)
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][d1] * (PQ[c0] * PQ[c1])
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][d0] * (PQ[c0] * PQ[c1])
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][d1] * (PQ[c0] * PQ[c1])
                            + delta[a1][d0] * delta[b0][d1] * delta[a0][b1] * (PQ[c0] * PQ[c1])
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][d0] * (PQ[c0] * PQ[c1])
                            + delta[a1][d1] * delta[b0][d0] * delta[a0][b1] * (PQ[c0] * PQ[c1])
                            + delta[a0][b0] * delta[a1][b1] * delta[d0][d1] * (PQ[c0] * PQ[c1] * 2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[d0][d1] * (PQ[c0] * PQ[c1] * 2.0)
                            + delta[a0][c1] * delta[a1][d1] * delta[b0][b1] * (PQ[c0] * PQ[d0])
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][d1] * (PQ[c0] * PQ[d0])
                            + delta[a0][c1] * delta[b0][d1] * delta[a1][b1] * (PQ[c0] * PQ[d0])
                            + delta[a0][d1] * delta[a1][c1] * delta[b0][b1] * (PQ[c0] * PQ[d0])
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][c1] * (PQ[c0] * PQ[d0])
                            + delta[a0][d1] * delta[b0][c1] * delta[a1][b1] * (PQ[c0] * PQ[d0])
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d1] * (PQ[c0] * PQ[d0] * 2.0)
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][d1] * (PQ[c0] * PQ[d0])
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][c1] * (PQ[c0] * PQ[d0])
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][d1] * (PQ[c0] * PQ[d0])
                            + delta[a1][c1] * delta[b0][d1] * delta[a0][b1] * (PQ[c0] * PQ[d0])
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][c1] * (PQ[c0] * PQ[d0])
                            + delta[a1][d1] * delta[b0][c1] * delta[a0][b1] * (PQ[c0] * PQ[d0])
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d1] * (PQ[c0] * PQ[d0] * 2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d1] * (PQ[c0] * PQ[d0] * 2.0)
                            + delta[a0][c1] * delta[a1][d0] * delta[b0][b1] * (PQ[c0] * PQ[d1])
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][d0] * (PQ[c0] * PQ[d1])
                            + delta[a0][c1] * delta[b0][d0] * delta[a1][b1] * (PQ[c0] * PQ[d1])
                            + delta[a0][d0] * delta[a1][c1] * delta[b0][b1] * (PQ[c0] * PQ[d1])
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][c1] * (PQ[c0] * PQ[d1])
                            + delta[a0][d0] * delta[b0][c1] * delta[a1][b1] * (PQ[c0] * PQ[d1])
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d0] * (PQ[c0] * PQ[d1] * 2.0)
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][d0] * (PQ[c0] * PQ[d1])
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][c1] * (PQ[c0] * PQ[d1])
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][d0] * (PQ[c0] * PQ[d1])
                            + delta[a1][c1] * delta[b0][d0] * delta[a0][b1] * (PQ[c0] * PQ[d1])
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][c1] * (PQ[c0] * PQ[d1])
                            + delta[a1][d0] * delta[b0][c1] * delta[a0][b1] * (PQ[c0] * PQ[d1])
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d0] * (PQ[c0] * PQ[d1] * 2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d0] * (PQ[c0] * PQ[d1] * 2.0)
                            + delta[a0][c0] * delta[a1][d1] * delta[b0][b1] * (PQ[c1] * PQ[d0])
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d1] * (PQ[c1] * PQ[d0])
                            + delta[a0][c0] * delta[b0][d1] * delta[a1][b1] * (PQ[c1] * PQ[d0])
                            + delta[a0][d1] * delta[a1][c0] * delta[b0][b1] * (PQ[c1] * PQ[d0])
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][c0] * (PQ[c1] * PQ[d0])
                            + delta[a0][d1] * delta[b0][c0] * delta[a1][b1] * (PQ[c1] * PQ[d0])
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d1] * (PQ[c1] * PQ[d0] * 2.0)
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d1] * (PQ[c1] * PQ[d0])
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][c0] * (PQ[c1] * PQ[d0])
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d1] * (PQ[c1] * PQ[d0])
                            + delta[a1][c0] * delta[b0][d1] * delta[a0][b1] * (PQ[c1] * PQ[d0])
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][c0] * (PQ[c1] * PQ[d0])
                            + delta[a1][d1] * delta[b0][c0] * delta[a0][b1] * (PQ[c1] * PQ[d0])
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d1] * (PQ[c1] * PQ[d0] * 2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d1] * (PQ[c1] * PQ[d0] * 2.0)
                            + delta[a0][c0] * delta[a1][d0] * delta[b0][b1] * (PQ[c1] * PQ[d1])
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d0] * (PQ[c1] * PQ[d1])
                            + delta[a0][c0] * delta[b0][d0] * delta[a1][b1] * (PQ[c1] * PQ[d1])
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][b1] * (PQ[c1] * PQ[d1])
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][c0] * (PQ[c1] * PQ[d1])
                            + delta[a0][d0] * delta[b0][c0] * delta[a1][b1] * (PQ[c1] * PQ[d1])
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * (PQ[c1] * PQ[d1] * 2.0)
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d0] * (PQ[c1] * PQ[d1])
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][c0] * (PQ[c1] * PQ[d1])
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d0] * (PQ[c1] * PQ[d1])
                            + delta[a1][c0] * delta[b0][d0] * delta[a0][b1] * (PQ[c1] * PQ[d1])
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][c0] * (PQ[c1] * PQ[d1])
                            + delta[a1][d0] * delta[b0][c0] * delta[a0][b1] * (PQ[c1] * PQ[d1])
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * (PQ[c1] * PQ[d1] * 2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * (PQ[c1] * PQ[d1] * 2.0)
                            + delta[a0][c0] * delta[a1][c1] * delta[b0][b1] * (PQ[d0] * PQ[d1])
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][c1] * (PQ[d0] * PQ[d1])
                            + delta[a0][c0] * delta[b0][c1] * delta[a1][b1] * (PQ[d0] * PQ[d1])
                            + delta[a0][c1] * delta[a1][c0] * delta[b0][b1] * (PQ[d0] * PQ[d1])
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][c0] * (PQ[d0] * PQ[d1])
                            + delta[a0][c1] * delta[b0][c0] * delta[a1][b1] * (PQ[d0] * PQ[d1])
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][c1] * (PQ[d0] * PQ[d1] * 2.0)
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][c1] * (PQ[d0] * PQ[d1])
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][c0] * (PQ[d0] * PQ[d1])
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][c1] * (PQ[d0] * PQ[d1])
                            + delta[a1][c0] * delta[b0][c1] * delta[a0][b1] * (PQ[d0] * PQ[d1])
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][c0] * (PQ[d0] * PQ[d1])
                            + delta[a1][c1] * delta[b0][c0] * delta[a0][b1] * (PQ[d0] * PQ[d1])
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][c1] * (PQ[d0] * PQ[d1] * 2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][c1] * (PQ[d0] * PQ[d1] * 2.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD26(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[5];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[4] * (

                        0.125 * S2 / ( S4 * S4 * S4 * S4 ) * (
                            delta[a1][c1] * delta[b0][b1] * delta[d0][d1] * (PQ[a0] * PQ[c0] + PQ[a0] * QC_0)
                            + delta[a1][c1] * delta[b0][d0] * delta[b1][d1] * (PQ[a0] * QC_0)
                            + delta[a1][c1] * delta[b0][d1] * delta[b1][d0] * (PQ[a0] * QC_0)
                            + delta[a1][d0] * delta[b0][b1] * delta[c1][d1] * (PQ[a0] * PQ[c0] + PQ[a0] * QC_0)
                            + delta[a1][d0] * delta[b0][c1] * delta[b1][d1] * (PQ[a0] * QC_0)
                            + delta[a1][d0] * delta[b0][d1] * delta[b1][c1] * (PQ[a0] * QC_0)
                            + delta[a1][d1] * delta[b0][b1] * delta[c1][d0] * (PQ[a0] * PQ[c0] + PQ[a0] * QC_0)
                            + delta[a1][d1] * delta[b0][c1] * delta[b1][d0] * (PQ[a0] * QC_0)
                            + delta[a1][d1] * delta[b0][d0] * delta[b1][c1] * (PQ[a0] * QC_0)
                            + delta[a1][b0] * delta[b1][c1] * delta[d0][d1] * (PQ[a0] * PQ[c0] + PQ[a0] * QC_0)
                            + delta[a1][b0] * delta[b1][d0] * delta[c1][d1] * (PQ[a0] * PQ[c0] + PQ[a0] * QC_0)
                            + delta[a1][b0] * delta[b1][d1] * delta[c1][d0] * (PQ[a0] * PQ[c0] + PQ[a0] * QC_0)
                            + delta[b0][c1] * delta[a1][b1] * delta[d0][d1] * (PQ[a0] * PQ[c0] + PQ[a0] * QC_0)
                            + delta[b0][d0] * delta[a1][b1] * delta[c1][d1] * (PQ[a0] * PQ[c0] + PQ[a0] * QC_0)
                            + delta[b0][d1] * delta[a1][b1] * delta[c1][d0] * (PQ[a0] * PQ[c0] + PQ[a0] * QC_0)
                            + delta[a1][c0] * delta[b0][b1] * delta[d0][d1] * (PQ[a0] * PQ[c1] + PQ[a0] * QC_1)
                            + delta[a1][c0] * delta[b0][d0] * delta[b1][d1] * (PQ[a0] * QC_1)
                            + delta[a1][c0] * delta[b0][d1] * delta[b1][d0] * (PQ[a0] * QC_1)
                            + delta[a1][d0] * delta[b0][b1] * delta[c0][d1] * (PQ[a0] * PQ[c1] + PQ[a0] * QC_1)
                            + delta[a1][d0] * delta[b0][c0] * delta[b1][d1] * (PQ[a0] * QC_1)
                            + delta[a1][d0] * delta[b0][d1] * delta[b1][c0] * (PQ[a0] * QC_1)
                            + delta[a1][d1] * delta[b0][b1] * delta[c0][d0] * (PQ[a0] * PQ[c1] + PQ[a0] * QC_1)
                            + delta[a1][d1] * delta[b0][c0] * delta[b1][d0] * (PQ[a0] * QC_1)
                            + delta[a1][d1] * delta[b0][d0] * delta[b1][c0] * (PQ[a0] * QC_1)
                            + delta[a1][b0] * delta[b1][c0] * delta[d0][d1] * (PQ[a0] * PQ[c1] + PQ[a0] * QC_1)
                            + delta[a1][b0] * delta[b1][d0] * delta[c0][d1] * (PQ[a0] * PQ[c1] + PQ[a0] * QC_1)
                            + delta[a1][b0] * delta[b1][d1] * delta[c0][d0] * (PQ[a0] * PQ[c1] + PQ[a0] * QC_1)
                            + delta[b0][c0] * delta[a1][b1] * delta[d0][d1] * (PQ[a0] * PQ[c1] + PQ[a0] * QC_1)
                            + delta[b0][d0] * delta[a1][b1] * delta[c0][d1] * (PQ[a0] * PQ[c1] + PQ[a0] * QC_1)
                            + delta[b0][d1] * delta[a1][b1] * delta[c0][d0] * (PQ[a0] * PQ[c1] + PQ[a0] * QC_1)
                            + delta[a0][c1] * delta[b0][b1] * delta[d0][d1] * (PQ[a1] * PQ[c0] + PQ[a1] * QC_0)
                            + delta[a0][c1] * delta[b0][d0] * delta[b1][d1] * (PQ[a1] * QC_0)
                            + delta[a0][c1] * delta[b0][d1] * delta[b1][d0] * (PQ[a1] * QC_0)
                            + delta[a0][d0] * delta[b0][b1] * delta[c1][d1] * (PQ[a1] * PQ[c0] + PQ[a1] * QC_0)
                            + delta[a0][d0] * delta[b0][c1] * delta[b1][d1] * (PQ[a1] * QC_0)
                            + delta[a0][d0] * delta[b0][d1] * delta[b1][c1] * (PQ[a1] * QC_0)
                            + delta[a0][d1] * delta[b0][b1] * delta[c1][d0] * (PQ[a1] * PQ[c0] + PQ[a1] * QC_0)
                            + delta[a0][d1] * delta[b0][c1] * delta[b1][d0] * (PQ[a1] * QC_0)
                            + delta[a0][d1] * delta[b0][d0] * delta[b1][c1] * (PQ[a1] * QC_0)
                            + delta[a0][b0] * delta[b1][c1] * delta[d0][d1] * (PQ[a1] * PQ[c0] + PQ[a1] * QC_0)
                            + delta[a0][b0] * delta[b1][d0] * delta[c1][d1] * (PQ[a1] * PQ[c0] + PQ[a1] * QC_0)
                            + delta[a0][b0] * delta[b1][d1] * delta[c1][d0] * (PQ[a1] * PQ[c0] + PQ[a1] * QC_0)
                            + delta[b0][c1] * delta[a0][b1] * delta[d0][d1] * (PQ[a1] * PQ[c0] + PQ[a1] * QC_0)
                            + delta[b0][d0] * delta[a0][b1] * delta[c1][d1] * (PQ[a1] * PQ[c0] + PQ[a1] * QC_0)
                            + delta[b0][d1] * delta[a0][b1] * delta[c1][d0] * (PQ[a1] * PQ[c0] + PQ[a1] * QC_0)
                            + delta[a0][c0] * delta[b0][b1] * delta[d0][d1] * (PQ[a1] * PQ[c1] + PQ[a1] * QC_1)
                            + delta[a0][c0] * delta[b0][d0] * delta[b1][d1] * (PQ[a1] * QC_1)
                            + delta[a0][c0] * delta[b0][d1] * delta[b1][d0] * (PQ[a1] * QC_1)
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][d1] * (PQ[a1] * PQ[c1] + PQ[a1] * QC_1)
                            + delta[a0][d0] * delta[b0][c0] * delta[b1][d1] * (PQ[a1] * QC_1)
                            + delta[a0][d0] * delta[b0][d1] * delta[b1][c0] * (PQ[a1] * QC_1)
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][d0] * (PQ[a1] * PQ[c1] + PQ[a1] * QC_1)
                            + delta[a0][d1] * delta[b0][c0] * delta[b1][d0] * (PQ[a1] * QC_1)
                            + delta[a0][d1] * delta[b0][d0] * delta[b1][c0] * (PQ[a1] * QC_1)
                            + delta[a0][b0] * delta[b1][c0] * delta[d0][d1] * (PQ[a1] * PQ[c1] + PQ[a1] * QC_1)
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][d1] * (PQ[a1] * PQ[c1] + PQ[a1] * QC_1)
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][d0] * (PQ[a1] * PQ[c1] + PQ[a1] * QC_1)
                            + delta[b0][c0] * delta[a0][b1] * delta[d0][d1] * (PQ[a1] * PQ[c1] + PQ[a1] * QC_1)
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][d1] * (PQ[a1] * PQ[c1] + PQ[a1] * QC_1)
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][d0] * (PQ[a1] * PQ[c1] + PQ[a1] * QC_1)
                            + delta[a0][c1] * delta[a1][d0] * delta[b1][d1] * (PQ[b0] * QC_0)
                            + delta[a0][c1] * delta[a1][d1] * delta[b1][d0] * (PQ[b0] * QC_0)
                            + delta[a0][c1] * delta[a1][b1] * delta[d0][d1] * (PQ[b0] * PQ[c0] + PQ[b0] * QC_0)
                            + delta[a0][d0] * delta[a1][c1] * delta[b1][d1] * (PQ[b0] * QC_0)
                            + delta[a0][d0] * delta[a1][d1] * delta[b1][c1] * (PQ[b0] * QC_0)
                            + delta[a0][d0] * delta[a1][b1] * delta[c1][d1] * (PQ[b0] * PQ[c0] + PQ[b0] * QC_0)
                            + delta[a0][d1] * delta[a1][c1] * delta[b1][d0] * (PQ[b0] * QC_0)
                            + delta[a0][d1] * delta[a1][d0] * delta[b1][c1] * (PQ[b0] * QC_0)
                            + delta[a0][d1] * delta[a1][b1] * delta[c1][d0] * (PQ[b0] * PQ[c0] + PQ[b0] * QC_0)
                            + delta[a0][a1] * delta[b1][c1] * delta[d0][d1] * (PQ[b0] * PQ[c0] + PQ[b0] * QC_0)
                            + delta[a0][a1] * delta[b1][d0] * delta[c1][d1] * (PQ[b0] * PQ[c0] + PQ[b0] * QC_0)
                            + delta[a0][a1] * delta[b1][d1] * delta[c1][d0] * (PQ[b0] * PQ[c0] + PQ[b0] * QC_0)
                            + delta[a1][c1] * delta[a0][b1] * delta[d0][d1] * (PQ[b0] * PQ[c0] + PQ[b0] * QC_0)
                            + delta[a1][d0] * delta[a0][b1] * delta[c1][d1] * (PQ[b0] * PQ[c0] + PQ[b0] * QC_0)
                            + delta[a1][d1] * delta[a0][b1] * delta[c1][d0] * (PQ[b0] * PQ[c0] + PQ[b0] * QC_0)
                            + delta[a0][c0] * delta[a1][d0] * delta[b1][d1] * (PQ[b0] * QC_1)
                            + delta[a0][c0] * delta[a1][d1] * delta[b1][d0] * (PQ[b0] * QC_1)
                            + delta[a0][c0] * delta[a1][b1] * delta[d0][d1] * (PQ[b0] * PQ[c1] + PQ[b0] * QC_1)
                            + delta[a0][d0] * delta[a1][c0] * delta[b1][d1] * (PQ[b0] * QC_1)
                            + delta[a0][d0] * delta[a1][d1] * delta[b1][c0] * (PQ[b0] * QC_1)
                            + delta[a0][d0] * delta[a1][b1] * delta[c0][d1] * (PQ[b0] * PQ[c1] + PQ[b0] * QC_1)
                            + delta[a0][d1] * delta[a1][c0] * delta[b1][d0] * (PQ[b0] * QC_1)
                            + delta[a0][d1] * delta[a1][d0] * delta[b1][c0] * (PQ[b0] * QC_1)
                            + delta[a0][d1] * delta[a1][b1] * delta[c0][d0] * (PQ[b0] * PQ[c1] + PQ[b0] * QC_1)
                            + delta[a0][a1] * delta[b1][c0] * delta[d0][d1] * (PQ[b0] * PQ[c1] + PQ[b0] * QC_1)
                            + delta[a0][a1] * delta[b1][d0] * delta[c0][d1] * (PQ[b0] * PQ[c1] + PQ[b0] * QC_1)
                            + delta[a0][a1] * delta[b1][d1] * delta[c0][d0] * (PQ[b0] * PQ[c1] + PQ[b0] * QC_1)
                            + delta[a1][c0] * delta[a0][b1] * delta[d0][d1] * (PQ[b0] * PQ[c1] + PQ[b0] * QC_1)
                            + delta[a1][d0] * delta[a0][b1] * delta[c0][d1] * (PQ[b0] * PQ[c1] + PQ[b0] * QC_1)
                            + delta[a1][d1] * delta[a0][b1] * delta[c0][d0] * (PQ[b0] * PQ[c1] + PQ[b0] * QC_1)
                            + delta[a0][c1] * delta[a1][d0] * delta[b0][d1] * (PQ[b1] * QC_0)
                            + delta[a0][c1] * delta[a1][d1] * delta[b0][d0] * (PQ[b1] * QC_0)
                            + delta[a0][c1] * delta[a1][b0] * delta[d0][d1] * (PQ[b1] * PQ[c0] + PQ[b1] * QC_0)
                            + delta[a0][d0] * delta[a1][c1] * delta[b0][d1] * (PQ[b1] * QC_0)
                            + delta[a0][d0] * delta[a1][d1] * delta[b0][c1] * (PQ[b1] * QC_0)
                            + delta[a0][d0] * delta[a1][b0] * delta[c1][d1] * (PQ[b1] * PQ[c0] + PQ[b1] * QC_0)
                            + delta[a0][d1] * delta[a1][c1] * delta[b0][d0] * (PQ[b1] * QC_0)
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][c1] * (PQ[b1] * QC_0)
                            + delta[a0][d1] * delta[a1][b0] * delta[c1][d0] * (PQ[b1] * PQ[c0] + PQ[b1] * QC_0)
                            + delta[a0][a1] * delta[b0][c1] * delta[d0][d1] * (PQ[b1] * PQ[c0] + PQ[b1] * QC_0)
                            + delta[a0][a1] * delta[b0][d0] * delta[c1][d1] * (PQ[b1] * PQ[c0] + PQ[b1] * QC_0)
                            + delta[a0][a1] * delta[b0][d1] * delta[c1][d0] * (PQ[b1] * PQ[c0] + PQ[b1] * QC_0)
                            + delta[a1][c1] * delta[a0][b0] * delta[d0][d1] * (PQ[b1] * PQ[c0] + PQ[b1] * QC_0)
                            + delta[a1][d0] * delta[a0][b0] * delta[c1][d1] * (PQ[b1] * PQ[c0] + PQ[b1] * QC_0)
                            + delta[a1][d1] * delta[a0][b0] * delta[c1][d0] * (PQ[b1] * PQ[c0] + PQ[b1] * QC_0)
                            + delta[a0][c0] * delta[a1][d0] * delta[b0][d1] * (PQ[b1] * QC_1)
                            + delta[a0][c0] * delta[a1][d1] * delta[b0][d0] * (PQ[b1] * QC_1)
                            + delta[a0][c0] * delta[a1][b0] * delta[d0][d1] * (PQ[b1] * PQ[c1] + PQ[b1] * QC_1)
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][d1] * (PQ[b1] * QC_1)
                            + delta[a0][d0] * delta[a1][d1] * delta[b0][c0] * (PQ[b1] * QC_1)
                            + delta[a0][d0] * delta[a1][b0] * delta[c0][d1] * (PQ[b1] * PQ[c1] + PQ[b1] * QC_1)
                            + delta[a0][d1] * delta[a1][c0] * delta[b0][d0] * (PQ[b1] * QC_1)
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][c0] * (PQ[b1] * QC_1)
                            + delta[a0][d1] * delta[a1][b0] * delta[c0][d0] * (PQ[b1] * PQ[c1] + PQ[b1] * QC_1)
                            + delta[a0][a1] * delta[b0][c0] * delta[d0][d1] * (PQ[b1] * PQ[c1] + PQ[b1] * QC_1)
                            + delta[a0][a1] * delta[b0][d0] * delta[c0][d1] * (PQ[b1] * PQ[c1] + PQ[b1] * QC_1)
                            + delta[a0][a1] * delta[b0][d1] * delta[c0][d0] * (PQ[b1] * PQ[c1] + PQ[b1] * QC_1)
                            + delta[a1][c0] * delta[a0][b0] * delta[d0][d1] * (PQ[b1] * PQ[c1] + PQ[b1] * QC_1)
                            + delta[a1][d0] * delta[a0][b0] * delta[c0][d1] * (PQ[b1] * PQ[c1] + PQ[b1] * QC_1)
                            + delta[a1][d1] * delta[a0][b0] * delta[c0][d0] * (PQ[b1] * PQ[c1] + PQ[b1] * QC_1)
                            + delta[a0][d0] * delta[a1][d1] * delta[b0][b1] * (PQ[c0] * QC_1 + PQ[c1] * QC_0)
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][d1] * (PQ[c0] * QC_1 + PQ[c1] * QC_0)
                            + delta[a0][d0] * delta[b0][d1] * delta[a1][b1] * (PQ[c0] * QC_1 + PQ[c1] * QC_0)
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][b1] * (PQ[c0] * QC_1 + PQ[c1] * QC_0)
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][d0] * (PQ[c0] * QC_1 + PQ[c1] * QC_0)
                            + delta[a0][d1] * delta[b0][d0] * delta[a1][b1] * (PQ[c0] * QC_1 + PQ[c1] * QC_0)
                            + delta[a0][a1] * delta[b0][b1] * delta[d0][d1] * (PQ[c0] * PQ[c1] + PQ[c0] * QC_1 + PQ[c1] * QC_0)
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][d1] * (PQ[c0] * QC_1 + PQ[c1] * QC_0)
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][d0] * (PQ[c0] * QC_1 + PQ[c1] * QC_0)
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][d1] * (PQ[c0] * QC_1 + PQ[c1] * QC_0)
                            + delta[a1][d0] * delta[b0][d1] * delta[a0][b1] * (PQ[c0] * QC_1 + PQ[c1] * QC_0)
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][d0] * (PQ[c0] * QC_1 + PQ[c1] * QC_0)
                            + delta[a1][d1] * delta[b0][d0] * delta[a0][b1] * (PQ[c0] * QC_1 + PQ[c1] * QC_0)
                            + delta[a0][b0] * delta[a1][b1] * delta[d0][d1] * (PQ[c0] * PQ[c1] + PQ[c0] * QC_1 + PQ[c1] * QC_0)
                            + delta[a1][b0] * delta[a0][b1] * delta[d0][d1] * (PQ[c0] * PQ[c1] + PQ[c0] * QC_1 + PQ[c1] * QC_0)
                            + delta[a0][c1] * delta[a1][d1] * delta[b0][b1] * (PQ[c0] * QD_0 + PQ[d0] * QC_0)
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][d1] * (PQ[c0] * QD_0 + PQ[d0] * QC_0)
                            + delta[a0][c1] * delta[b0][d1] * delta[a1][b1] * (PQ[c0] * QD_0 + PQ[d0] * QC_0)
                            + delta[a0][d1] * delta[a1][c1] * delta[b0][b1] * (PQ[c0] * QD_0 + PQ[d0] * QC_0)
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][c1] * (PQ[c0] * QD_0 + PQ[d0] * QC_0)
                            + delta[a0][d1] * delta[b0][c1] * delta[a1][b1] * (PQ[c0] * QD_0 + PQ[d0] * QC_0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d1] * (PQ[c0] * PQ[d0] + PQ[c0] * QD_0 + PQ[d0] * QC_0)
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][d1] * (PQ[c0] * QD_0 + PQ[d0] * QC_0)
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][c1] * (PQ[c0] * QD_0 + PQ[d0] * QC_0)
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][d1] * (PQ[c0] * QD_0 + PQ[d0] * QC_0)
                            + delta[a1][c1] * delta[b0][d1] * delta[a0][b1] * (PQ[c0] * QD_0 + PQ[d0] * QC_0)
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][c1] * (PQ[c0] * QD_0 + PQ[d0] * QC_0)
                            + delta[a1][d1] * delta[b0][c1] * delta[a0][b1] * (PQ[c0] * QD_0 + PQ[d0] * QC_0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d1] * (PQ[c0] * PQ[d0] + PQ[c0] * QD_0 + PQ[d0] * QC_0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d1] * (PQ[c0] * PQ[d0] + PQ[c0] * QD_0 + PQ[d0] * QC_0)
                            + delta[a0][c0] * delta[a1][d1] * delta[b0][b1] * (PQ[c1] * QD_0 + PQ[d0] * QC_1)
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d1] * (PQ[c1] * QD_0 + PQ[d0] * QC_1)
                            + delta[a0][c0] * delta[b0][d1] * delta[a1][b1] * (PQ[c1] * QD_0 + PQ[d0] * QC_1)
                            + delta[a0][d1] * delta[a1][c0] * delta[b0][b1] * (PQ[c1] * QD_0 + PQ[d0] * QC_1)
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][c0] * (PQ[c1] * QD_0 + PQ[d0] * QC_1)
                            + delta[a0][d1] * delta[b0][c0] * delta[a1][b1] * (PQ[c1] * QD_0 + PQ[d0] * QC_1)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d1] * (PQ[c1] * PQ[d0] + PQ[c1] * QD_0 + PQ[d0] * QC_1)
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d1] * (PQ[c1] * QD_0 + PQ[d0] * QC_1)
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][c0] * (PQ[c1] * QD_0 + PQ[d0] * QC_1)
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d1] * (PQ[c1] * QD_0 + PQ[d0] * QC_1)
                            + delta[a1][c0] * delta[b0][d1] * delta[a0][b1] * (PQ[c1] * QD_0 + PQ[d0] * QC_1)
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][c0] * (PQ[c1] * QD_0 + PQ[d0] * QC_1)
                            + delta[a1][d1] * delta[b0][c0] * delta[a0][b1] * (PQ[c1] * QD_0 + PQ[d0] * QC_1)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d1] * (PQ[c1] * PQ[d0] + PQ[c1] * QD_0 + PQ[d0] * QC_1)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d1] * (PQ[c1] * PQ[d0] + PQ[c1] * QD_0 + PQ[d0] * QC_1)
                            + delta[a0][c1] * delta[a1][d0] * delta[b0][b1] * (PQ[c0] * QD_1 + PQ[d1] * QC_0)
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][d0] * (PQ[c0] * QD_1 + PQ[d1] * QC_0)
                            + delta[a0][c1] * delta[b0][d0] * delta[a1][b1] * (PQ[c0] * QD_1 + PQ[d1] * QC_0)
                            + delta[a0][d0] * delta[a1][c1] * delta[b0][b1] * (PQ[c0] * QD_1 + PQ[d1] * QC_0)
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][c1] * (PQ[c0] * QD_1 + PQ[d1] * QC_0)
                            + delta[a0][d0] * delta[b0][c1] * delta[a1][b1] * (PQ[c0] * QD_1 + PQ[d1] * QC_0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d0] * (PQ[c0] * PQ[d1] + PQ[c0] * QD_1 + PQ[d1] * QC_0)
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][d0] * (PQ[c0] * QD_1 + PQ[d1] * QC_0)
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][c1] * (PQ[c0] * QD_1 + PQ[d1] * QC_0)
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][d0] * (PQ[c0] * QD_1 + PQ[d1] * QC_0)
                            + delta[a1][c1] * delta[b0][d0] * delta[a0][b1] * (PQ[c0] * QD_1 + PQ[d1] * QC_0)
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][c1] * (PQ[c0] * QD_1 + PQ[d1] * QC_0)
                            + delta[a1][d0] * delta[b0][c1] * delta[a0][b1] * (PQ[c0] * QD_1 + PQ[d1] * QC_0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d0] * (PQ[c0] * PQ[d1] + PQ[c0] * QD_1 + PQ[d1] * QC_0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d0] * (PQ[c0] * PQ[d1] + PQ[c0] * QD_1 + PQ[d1] * QC_0)
                            + delta[a0][c0] * delta[a1][d0] * delta[b0][b1] * (PQ[c1] * QD_1 + PQ[d1] * QC_1)
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d0] * (PQ[c1] * QD_1 + PQ[d1] * QC_1)
                            + delta[a0][c0] * delta[b0][d0] * delta[a1][b1] * (PQ[c1] * QD_1 + PQ[d1] * QC_1)
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][b1] * (PQ[c1] * QD_1 + PQ[d1] * QC_1)
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][c0] * (PQ[c1] * QD_1 + PQ[d1] * QC_1)
                            + delta[a0][d0] * delta[b0][c0] * delta[a1][b1] * (PQ[c1] * QD_1 + PQ[d1] * QC_1)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * (PQ[c1] * PQ[d1] + PQ[c1] * QD_1 + PQ[d1] * QC_1)
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d0] * (PQ[c1] * QD_1 + PQ[d1] * QC_1)
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][c0] * (PQ[c1] * QD_1 + PQ[d1] * QC_1)
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d0] * (PQ[c1] * QD_1 + PQ[d1] * QC_1)
                            + delta[a1][c0] * delta[b0][d0] * delta[a0][b1] * (PQ[c1] * QD_1 + PQ[d1] * QC_1)
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][c0] * (PQ[c1] * QD_1 + PQ[d1] * QC_1)
                            + delta[a1][d0] * delta[b0][c0] * delta[a0][b1] * (PQ[c1] * QD_1 + PQ[d1] * QC_1)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * (PQ[c1] * PQ[d1] + PQ[c1] * QD_1 + PQ[d1] * QC_1)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * (PQ[c1] * PQ[d1] + PQ[c1] * QD_1 + PQ[d1] * QC_1)
                            + delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (PQ[a0] * PQ[a1] * 2.0)
                            + delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (PQ[a0] * PQ[a1] * 2.0)
                            + delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (PQ[a0] * PQ[a1] * 2.0)
                            + delta[b0][c0] * delta[b1][c1] * delta[d0][d1] * (PQ[a0] * PQ[a1])
                            + delta[b0][c0] * delta[b1][d0] * delta[c1][d1] * (PQ[a0] * PQ[a1])
                            + delta[b0][c0] * delta[b1][d1] * delta[c1][d0] * (PQ[a0] * PQ[a1])
                            + delta[b0][c1] * delta[b1][c0] * delta[d0][d1] * (PQ[a0] * PQ[a1])
                            + delta[b0][c1] * delta[b1][d0] * delta[c0][d1] * (PQ[a0] * PQ[a1])
                            + delta[b0][c1] * delta[b1][d1] * delta[c0][d0] * (PQ[a0] * PQ[a1])
                            + delta[b0][d0] * delta[b1][c0] * delta[c1][d1] * (PQ[a0] * PQ[a1])
                            + delta[b0][d0] * delta[b1][c1] * delta[c0][d1] * (PQ[a0] * PQ[a1])
                            + delta[b0][d0] * delta[b1][d1] * delta[c0][c1] * (PQ[a0] * PQ[a1])
                            + delta[b0][d1] * delta[b1][c0] * delta[c1][d0] * (PQ[a0] * PQ[a1])
                            + delta[b0][d1] * delta[b1][c1] * delta[c0][d0] * (PQ[a0] * PQ[a1])
                            + delta[b0][d1] * delta[b1][d0] * delta[c0][c1] * (PQ[a0] * PQ[a1])
                            + delta[a1][c0] * delta[b1][c1] * delta[d0][d1] * (PQ[a0] * PQ[b0])
                            + delta[a1][c0] * delta[b1][d0] * delta[c1][d1] * (PQ[a0] * PQ[b0])
                            + delta[a1][c0] * delta[b1][d1] * delta[c1][d0] * (PQ[a0] * PQ[b0])
                            + delta[a1][c1] * delta[b1][c0] * delta[d0][d1] * (PQ[a0] * PQ[b0])
                            + delta[a1][c1] * delta[b1][d0] * delta[c0][d1] * (PQ[a0] * PQ[b0])
                            + delta[a1][c1] * delta[b1][d1] * delta[c0][d0] * (PQ[a0] * PQ[b0])
                            + delta[a1][d0] * delta[b1][c0] * delta[c1][d1] * (PQ[a0] * PQ[b0])
                            + delta[a1][d0] * delta[b1][c1] * delta[c0][d1] * (PQ[a0] * PQ[b0])
                            + delta[a1][d0] * delta[b1][d1] * delta[c0][c1] * (PQ[a0] * PQ[b0])
                            + delta[a1][d1] * delta[b1][c0] * delta[c1][d0] * (PQ[a0] * PQ[b0])
                            + delta[a1][d1] * delta[b1][c1] * delta[c0][d0] * (PQ[a0] * PQ[b0])
                            + delta[a1][d1] * delta[b1][d0] * delta[c0][c1] * (PQ[a0] * PQ[b0])
                            + delta[a1][b1] * delta[c0][c1] * delta[d0][d1] * (PQ[a0] * PQ[b0] * 2.0)
                            + delta[a1][b1] * delta[c0][d0] * delta[c1][d1] * (PQ[a0] * PQ[b0] * 2.0)
                            + delta[a1][b1] * delta[c1][d0] * delta[c0][d1] * (PQ[a0] * PQ[b0] * 2.0)
                            + delta[a1][c0] * delta[b0][c1] * delta[d0][d1] * (PQ[a0] * PQ[b1])
                            + delta[a1][c0] * delta[b0][d0] * delta[c1][d1] * (PQ[a0] * PQ[b1])
                            + delta[a1][c0] * delta[b0][d1] * delta[c1][d0] * (PQ[a0] * PQ[b1])
                            + delta[a1][c1] * delta[b0][c0] * delta[d0][d1] * (PQ[a0] * PQ[b1])
                            + delta[a1][c1] * delta[b0][d0] * delta[c0][d1] * (PQ[a0] * PQ[b1])
                            + delta[a1][c1] * delta[b0][d1] * delta[c0][d0] * (PQ[a0] * PQ[b1])
                            + delta[a1][d0] * delta[b0][c0] * delta[c1][d1] * (PQ[a0] * PQ[b1])
                            + delta[a1][d0] * delta[b0][c1] * delta[c0][d1] * (PQ[a0] * PQ[b1])
                            + delta[a1][d0] * delta[b0][d1] * delta[c0][c1] * (PQ[a0] * PQ[b1])
                            + delta[a1][d1] * delta[b0][c0] * delta[c1][d0] * (PQ[a0] * PQ[b1])
                            + delta[a1][d1] * delta[b0][c1] * delta[c0][d0] * (PQ[a0] * PQ[b1])
                            + delta[a1][d1] * delta[b0][d0] * delta[c0][c1] * (PQ[a0] * PQ[b1])
                            + delta[a1][b0] * delta[c0][c1] * delta[d0][d1] * (PQ[a0] * PQ[b1] * 2.0)
                            + delta[a1][b0] * delta[c0][d0] * delta[c1][d1] * (PQ[a0] * PQ[b1] * 2.0)
                            + delta[a1][b0] * delta[c1][d0] * delta[c0][d1] * (PQ[a0] * PQ[b1] * 2.0)
                            + delta[a1][c0] * delta[b0][b1] * delta[c1][d1] * (PQ[a0] * PQ[d0] + PQ[a0] * QD_0)
                            + delta[a1][c1] * delta[b0][b1] * delta[c0][d1] * (PQ[a0] * PQ[d0] + PQ[a0] * QD_0)
                            + delta[a1][d1] * delta[b0][b1] * delta[c0][c1] * (PQ[a0] * PQ[d0] + PQ[a0] * QD_0)
                            + delta[a1][b0] * delta[b1][c0] * delta[c1][d1] * (PQ[a0] * PQ[d0] + PQ[a0] * QD_0)
                            + delta[a1][b0] * delta[b1][c1] * delta[c0][d1] * (PQ[a0] * PQ[d0] + PQ[a0] * QD_0)
                            + delta[a1][b0] * delta[b1][d1] * delta[c0][c1] * (PQ[a0] * PQ[d0] + PQ[a0] * QD_0)
                            + delta[b0][c0] * delta[a1][b1] * delta[c1][d1] * (PQ[a0] * PQ[d0] + PQ[a0] * QD_0)
                            + delta[b0][c1] * delta[a1][b1] * delta[c0][d1] * (PQ[a0] * PQ[d0] + PQ[a0] * QD_0)
                            + delta[b0][d1] * delta[a1][b1] * delta[c0][c1] * (PQ[a0] * PQ[d0] + PQ[a0] * QD_0)
                            + delta[a1][c0] * delta[b0][b1] * delta[c1][d0] * (PQ[a0] * PQ[d1] + PQ[a0] * QD_1)
                            + delta[a1][c1] * delta[b0][b1] * delta[c0][d0] * (PQ[a0] * PQ[d1] + PQ[a0] * QD_1)
                            + delta[a1][d0] * delta[b0][b1] * delta[c0][c1] * (PQ[a0] * PQ[d1] + PQ[a0] * QD_1)
                            + delta[a1][b0] * delta[b1][c0] * delta[c1][d0] * (PQ[a0] * PQ[d1] + PQ[a0] * QD_1)
                            + delta[a1][b0] * delta[b1][c1] * delta[c0][d0] * (PQ[a0] * PQ[d1] + PQ[a0] * QD_1)
                            + delta[a1][b0] * delta[b1][d0] * delta[c0][c1] * (PQ[a0] * PQ[d1] + PQ[a0] * QD_1)
                            + delta[b0][c0] * delta[a1][b1] * delta[c1][d0] * (PQ[a0] * PQ[d1] + PQ[a0] * QD_1)
                            + delta[b0][c1] * delta[a1][b1] * delta[c0][d0] * (PQ[a0] * PQ[d1] + PQ[a0] * QD_1)
                            + delta[b0][d0] * delta[a1][b1] * delta[c0][c1] * (PQ[a0] * PQ[d1] + PQ[a0] * QD_1)
                            + delta[a1][c0] * delta[b0][c1] * delta[b1][d1] * (PQ[a0] * QD_0)
                            + delta[a1][c0] * delta[b0][d1] * delta[b1][c1] * (PQ[a0] * QD_0)
                            + delta[a1][c1] * delta[b0][c0] * delta[b1][d1] * (PQ[a0] * QD_0)
                            + delta[a1][c1] * delta[b0][d1] * delta[b1][c0] * (PQ[a0] * QD_0)
                            + delta[a1][d1] * delta[b0][c0] * delta[b1][c1] * (PQ[a0] * QD_0)
                            + delta[a1][d1] * delta[b0][c1] * delta[b1][c0] * (PQ[a0] * QD_0)
                            + delta[a1][c0] * delta[b0][c1] * delta[b1][d0] * (PQ[a0] * QD_1)
                            + delta[a1][c0] * delta[b0][d0] * delta[b1][c1] * (PQ[a0] * QD_1)
                            + delta[a1][c1] * delta[b0][c0] * delta[b1][d0] * (PQ[a0] * QD_1)
                            + delta[a1][c1] * delta[b0][d0] * delta[b1][c0] * (PQ[a0] * QD_1)
                            + delta[a1][d0] * delta[b0][c0] * delta[b1][c1] * (PQ[a0] * QD_1)
                            + delta[a1][d0] * delta[b0][c1] * delta[b1][c0] * (PQ[a0] * QD_1)
                            + delta[a0][c0] * delta[b1][c1] * delta[d0][d1] * (PQ[a1] * PQ[b0])
                            + delta[a0][c0] * delta[b1][d0] * delta[c1][d1] * (PQ[a1] * PQ[b0])
                            + delta[a0][c0] * delta[b1][d1] * delta[c1][d0] * (PQ[a1] * PQ[b0])
                            + delta[a0][c1] * delta[b1][c0] * delta[d0][d1] * (PQ[a1] * PQ[b0])
                            + delta[a0][c1] * delta[b1][d0] * delta[c0][d1] * (PQ[a1] * PQ[b0])
                            + delta[a0][c1] * delta[b1][d1] * delta[c0][d0] * (PQ[a1] * PQ[b0])
                            + delta[a0][d0] * delta[b1][c0] * delta[c1][d1] * (PQ[a1] * PQ[b0])
                            + delta[a0][d0] * delta[b1][c1] * delta[c0][d1] * (PQ[a1] * PQ[b0])
                            + delta[a0][d0] * delta[b1][d1] * delta[c0][c1] * (PQ[a1] * PQ[b0])
                            + delta[a0][d1] * delta[b1][c0] * delta[c1][d0] * (PQ[a1] * PQ[b0])
                            + delta[a0][d1] * delta[b1][c1] * delta[c0][d0] * (PQ[a1] * PQ[b0])
                            + delta[a0][d1] * delta[b1][d0] * delta[c0][c1] * (PQ[a1] * PQ[b0])
                            + delta[a0][b1] * delta[c0][c1] * delta[d0][d1] * (PQ[a1] * PQ[b0] * 2.0)
                            + delta[a0][b1] * delta[c0][d0] * delta[c1][d1] * (PQ[a1] * PQ[b0] * 2.0)
                            + delta[a0][b1] * delta[c1][d0] * delta[c0][d1] * (PQ[a1] * PQ[b0] * 2.0)
                            + delta[a0][c0] * delta[b0][c1] * delta[d0][d1] * (PQ[a1] * PQ[b1])
                            + delta[a0][c0] * delta[b0][d0] * delta[c1][d1] * (PQ[a1] * PQ[b1])
                            + delta[a0][c0] * delta[b0][d1] * delta[c1][d0] * (PQ[a1] * PQ[b1])
                            + delta[a0][c1] * delta[b0][c0] * delta[d0][d1] * (PQ[a1] * PQ[b1])
                            + delta[a0][c1] * delta[b0][d0] * delta[c0][d1] * (PQ[a1] * PQ[b1])
                            + delta[a0][c1] * delta[b0][d1] * delta[c0][d0] * (PQ[a1] * PQ[b1])
                            + delta[a0][d0] * delta[b0][c0] * delta[c1][d1] * (PQ[a1] * PQ[b1])
                            + delta[a0][d0] * delta[b0][c1] * delta[c0][d1] * (PQ[a1] * PQ[b1])
                            + delta[a0][d0] * delta[b0][d1] * delta[c0][c1] * (PQ[a1] * PQ[b1])
                            + delta[a0][d1] * delta[b0][c0] * delta[c1][d0] * (PQ[a1] * PQ[b1])
                            + delta[a0][d1] * delta[b0][c1] * delta[c0][d0] * (PQ[a1] * PQ[b1])
                            + delta[a0][d1] * delta[b0][d0] * delta[c0][c1] * (PQ[a1] * PQ[b1])
                            + delta[a0][b0] * delta[c0][c1] * delta[d0][d1] * (PQ[a1] * PQ[b1] * 2.0)
                            + delta[a0][b0] * delta[c0][d0] * delta[c1][d1] * (PQ[a1] * PQ[b1] * 2.0)
                            + delta[a0][b0] * delta[c1][d0] * delta[c0][d1] * (PQ[a1] * PQ[b1] * 2.0)
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d1] * (PQ[a1] * PQ[d0] + PQ[a1] * QD_0)
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d1] * (PQ[a1] * PQ[d0] + PQ[a1] * QD_0)
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][c1] * (PQ[a1] * PQ[d0] + PQ[a1] * QD_0)
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d1] * (PQ[a1] * PQ[d0] + PQ[a1] * QD_0)
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d1] * (PQ[a1] * PQ[d0] + PQ[a1] * QD_0)
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][c1] * (PQ[a1] * PQ[d0] + PQ[a1] * QD_0)
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d1] * (PQ[a1] * PQ[d0] + PQ[a1] * QD_0)
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d1] * (PQ[a1] * PQ[d0] + PQ[a1] * QD_0)
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][c1] * (PQ[a1] * PQ[d0] + PQ[a1] * QD_0)
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d0] * (PQ[a1] * PQ[d1] + PQ[a1] * QD_1)
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d0] * (PQ[a1] * PQ[d1] + PQ[a1] * QD_1)
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][c1] * (PQ[a1] * PQ[d1] + PQ[a1] * QD_1)
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d0] * (PQ[a1] * PQ[d1] + PQ[a1] * QD_1)
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d0] * (PQ[a1] * PQ[d1] + PQ[a1] * QD_1)
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][c1] * (PQ[a1] * PQ[d1] + PQ[a1] * QD_1)
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d0] * (PQ[a1] * PQ[d1] + PQ[a1] * QD_1)
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d0] * (PQ[a1] * PQ[d1] + PQ[a1] * QD_1)
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][c1] * (PQ[a1] * PQ[d1] + PQ[a1] * QD_1)
                            + delta[a0][c0] * delta[b0][c1] * delta[b1][d1] * (PQ[a1] * QD_0)
                            + delta[a0][c0] * delta[b0][d1] * delta[b1][c1] * (PQ[a1] * QD_0)
                            + delta[a0][c1] * delta[b0][c0] * delta[b1][d1] * (PQ[a1] * QD_0)
                            + delta[a0][c1] * delta[b0][d1] * delta[b1][c0] * (PQ[a1] * QD_0)
                            + delta[a0][d1] * delta[b0][c0] * delta[b1][c1] * (PQ[a1] * QD_0)
                            + delta[a0][d1] * delta[b0][c1] * delta[b1][c0] * (PQ[a1] * QD_0)
                            + delta[a0][c0] * delta[b0][c1] * delta[b1][d0] * (PQ[a1] * QD_1)
                            + delta[a0][c0] * delta[b0][d0] * delta[b1][c1] * (PQ[a1] * QD_1)
                            + delta[a0][c1] * delta[b0][c0] * delta[b1][d0] * (PQ[a1] * QD_1)
                            + delta[a0][c1] * delta[b0][d0] * delta[b1][c0] * (PQ[a1] * QD_1)
                            + delta[a0][d0] * delta[b0][c0] * delta[b1][c1] * (PQ[a1] * QD_1)
                            + delta[a0][d0] * delta[b0][c1] * delta[b1][c0] * (PQ[a1] * QD_1)
                            + delta[a0][c0] * delta[a1][c1] * delta[d0][d1] * (PQ[b0] * PQ[b1])
                            + delta[a0][c0] * delta[a1][d0] * delta[c1][d1] * (PQ[b0] * PQ[b1])
                            + delta[a0][c0] * delta[a1][d1] * delta[c1][d0] * (PQ[b0] * PQ[b1])
                            + delta[a0][c1] * delta[a1][c0] * delta[d0][d1] * (PQ[b0] * PQ[b1])
                            + delta[a0][c1] * delta[a1][d0] * delta[c0][d1] * (PQ[b0] * PQ[b1])
                            + delta[a0][c1] * delta[a1][d1] * delta[c0][d0] * (PQ[b0] * PQ[b1])
                            + delta[a0][d0] * delta[a1][c0] * delta[c1][d1] * (PQ[b0] * PQ[b1])
                            + delta[a0][d0] * delta[a1][c1] * delta[c0][d1] * (PQ[b0] * PQ[b1])
                            + delta[a0][d0] * delta[a1][d1] * delta[c0][c1] * (PQ[b0] * PQ[b1])
                            + delta[a0][d1] * delta[a1][c0] * delta[c1][d0] * (PQ[b0] * PQ[b1])
                            + delta[a0][d1] * delta[a1][c1] * delta[c0][d0] * (PQ[b0] * PQ[b1])
                            + delta[a0][d1] * delta[a1][d0] * delta[c0][c1] * (PQ[b0] * PQ[b1])
                            + delta[a0][a1] * delta[c0][c1] * delta[d0][d1] * (PQ[b0] * PQ[b1] * 2.0)
                            + delta[a0][a1] * delta[c0][d0] * delta[c1][d1] * (PQ[b0] * PQ[b1] * 2.0)
                            + delta[a0][a1] * delta[c1][d0] * delta[c0][d1] * (PQ[b0] * PQ[b1] * 2.0)
                            + delta[a0][c0] * delta[a1][b1] * delta[c1][d1] * (PQ[b0] * PQ[d0] + PQ[b0] * QD_0)
                            + delta[a0][c1] * delta[a1][b1] * delta[c0][d1] * (PQ[b0] * PQ[d0] + PQ[b0] * QD_0)
                            + delta[a0][d1] * delta[a1][b1] * delta[c0][c1] * (PQ[b0] * PQ[d0] + PQ[b0] * QD_0)
                            + delta[a0][a1] * delta[b1][c0] * delta[c1][d1] * (PQ[b0] * PQ[d0] + PQ[b0] * QD_0)
                            + delta[a0][a1] * delta[b1][c1] * delta[c0][d1] * (PQ[b0] * PQ[d0] + PQ[b0] * QD_0)
                            + delta[a0][a1] * delta[b1][d1] * delta[c0][c1] * (PQ[b0] * PQ[d0] + PQ[b0] * QD_0)
                            + delta[a1][c0] * delta[a0][b1] * delta[c1][d1] * (PQ[b0] * PQ[d0] + PQ[b0] * QD_0)
                            + delta[a1][c1] * delta[a0][b1] * delta[c0][d1] * (PQ[b0] * PQ[d0] + PQ[b0] * QD_0)
                            + delta[a1][d1] * delta[a0][b1] * delta[c0][c1] * (PQ[b0] * PQ[d0] + PQ[b0] * QD_0)
                            + delta[a0][c0] * delta[a1][b1] * delta[c1][d0] * (PQ[b0] * PQ[d1] + PQ[b0] * QD_1)
                            + delta[a0][c1] * delta[a1][b1] * delta[c0][d0] * (PQ[b0] * PQ[d1] + PQ[b0] * QD_1)
                            + delta[a0][d0] * delta[a1][b1] * delta[c0][c1] * (PQ[b0] * PQ[d1] + PQ[b0] * QD_1)
                            + delta[a0][a1] * delta[b1][c0] * delta[c1][d0] * (PQ[b0] * PQ[d1] + PQ[b0] * QD_1)
                            + delta[a0][a1] * delta[b1][c1] * delta[c0][d0] * (PQ[b0] * PQ[d1] + PQ[b0] * QD_1)
                            + delta[a0][a1] * delta[b1][d0] * delta[c0][c1] * (PQ[b0] * PQ[d1] + PQ[b0] * QD_1)
                            + delta[a1][c0] * delta[a0][b1] * delta[c1][d0] * (PQ[b0] * PQ[d1] + PQ[b0] * QD_1)
                            + delta[a1][c1] * delta[a0][b1] * delta[c0][d0] * (PQ[b0] * PQ[d1] + PQ[b0] * QD_1)
                            + delta[a1][d0] * delta[a0][b1] * delta[c0][c1] * (PQ[b0] * PQ[d1] + PQ[b0] * QD_1)
                            + delta[a0][c0] * delta[a1][c1] * delta[b1][d1] * (PQ[b0] * QD_0)
                            + delta[a0][c0] * delta[a1][d1] * delta[b1][c1] * (PQ[b0] * QD_0)
                            + delta[a0][c1] * delta[a1][c0] * delta[b1][d1] * (PQ[b0] * QD_0)
                            + delta[a0][c1] * delta[a1][d1] * delta[b1][c0] * (PQ[b0] * QD_0)
                            + delta[a0][d1] * delta[a1][c0] * delta[b1][c1] * (PQ[b0] * QD_0)
                            + delta[a0][d1] * delta[a1][c1] * delta[b1][c0] * (PQ[b0] * QD_0)
                            + delta[a0][c0] * delta[a1][c1] * delta[b1][d0] * (PQ[b0] * QD_1)
                            + delta[a0][c0] * delta[a1][d0] * delta[b1][c1] * (PQ[b0] * QD_1)
                            + delta[a0][c1] * delta[a1][c0] * delta[b1][d0] * (PQ[b0] * QD_1)
                            + delta[a0][c1] * delta[a1][d0] * delta[b1][c0] * (PQ[b0] * QD_1)
                            + delta[a0][d0] * delta[a1][c0] * delta[b1][c1] * (PQ[b0] * QD_1)
                            + delta[a0][d0] * delta[a1][c1] * delta[b1][c0] * (PQ[b0] * QD_1)
                            + delta[a0][c0] * delta[a1][b0] * delta[c1][d1] * (PQ[b1] * PQ[d0] + PQ[b1] * QD_0)
                            + delta[a0][c1] * delta[a1][b0] * delta[c0][d1] * (PQ[b1] * PQ[d0] + PQ[b1] * QD_0)
                            + delta[a0][d1] * delta[a1][b0] * delta[c0][c1] * (PQ[b1] * PQ[d0] + PQ[b1] * QD_0)
                            + delta[a0][a1] * delta[b0][c0] * delta[c1][d1] * (PQ[b1] * PQ[d0] + PQ[b1] * QD_0)
                            + delta[a0][a1] * delta[b0][c1] * delta[c0][d1] * (PQ[b1] * PQ[d0] + PQ[b1] * QD_0)
                            + delta[a0][a1] * delta[b0][d1] * delta[c0][c1] * (PQ[b1] * PQ[d0] + PQ[b1] * QD_0)
                            + delta[a1][c0] * delta[a0][b0] * delta[c1][d1] * (PQ[b1] * PQ[d0] + PQ[b1] * QD_0)
                            + delta[a1][c1] * delta[a0][b0] * delta[c0][d1] * (PQ[b1] * PQ[d0] + PQ[b1] * QD_0)
                            + delta[a1][d1] * delta[a0][b0] * delta[c0][c1] * (PQ[b1] * PQ[d0] + PQ[b1] * QD_0)
                            + delta[a0][c0] * delta[a1][b0] * delta[c1][d0] * (PQ[b1] * PQ[d1] + PQ[b1] * QD_1)
                            + delta[a0][c1] * delta[a1][b0] * delta[c0][d0] * (PQ[b1] * PQ[d1] + PQ[b1] * QD_1)
                            + delta[a0][d0] * delta[a1][b0] * delta[c0][c1] * (PQ[b1] * PQ[d1] + PQ[b1] * QD_1)
                            + delta[a0][a1] * delta[b0][c0] * delta[c1][d0] * (PQ[b1] * PQ[d1] + PQ[b1] * QD_1)
                            + delta[a0][a1] * delta[b0][c1] * delta[c0][d0] * (PQ[b1] * PQ[d1] + PQ[b1] * QD_1)
                            + delta[a0][a1] * delta[b0][d0] * delta[c0][c1] * (PQ[b1] * PQ[d1] + PQ[b1] * QD_1)
                            + delta[a1][c0] * delta[a0][b0] * delta[c1][d0] * (PQ[b1] * PQ[d1] + PQ[b1] * QD_1)
                            + delta[a1][c1] * delta[a0][b0] * delta[c0][d0] * (PQ[b1] * PQ[d1] + PQ[b1] * QD_1)
                            + delta[a1][d0] * delta[a0][b0] * delta[c0][c1] * (PQ[b1] * PQ[d1] + PQ[b1] * QD_1)
                            + delta[a0][c0] * delta[a1][c1] * delta[b0][d1] * (PQ[b1] * QD_0)
                            + delta[a0][c0] * delta[a1][d1] * delta[b0][c1] * (PQ[b1] * QD_0)
                            + delta[a0][c1] * delta[a1][c0] * delta[b0][d1] * (PQ[b1] * QD_0)
                            + delta[a0][c1] * delta[a1][d1] * delta[b0][c0] * (PQ[b1] * QD_0)
                            + delta[a0][d1] * delta[a1][c0] * delta[b0][c1] * (PQ[b1] * QD_0)
                            + delta[a0][d1] * delta[a1][c1] * delta[b0][c0] * (PQ[b1] * QD_0)
                            + delta[a0][c0] * delta[a1][c1] * delta[b0][d0] * (PQ[b1] * QD_1)
                            + delta[a0][c0] * delta[a1][d0] * delta[b0][c1] * (PQ[b1] * QD_1)
                            + delta[a0][c1] * delta[a1][c0] * delta[b0][d0] * (PQ[b1] * QD_1)
                            + delta[a0][c1] * delta[a1][d0] * delta[b0][c0] * (PQ[b1] * QD_1)
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][c1] * (PQ[b1] * QD_1)
                            + delta[a0][d0] * delta[a1][c1] * delta[b0][c0] * (PQ[b1] * QD_1)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][c1] * (PQ[d0] * PQ[d1] + PQ[d0] * QD_1 + PQ[d1] * QD_0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][c1] * (PQ[d0] * PQ[d1] + PQ[d0] * QD_1 + PQ[d1] * QD_0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][c1] * (PQ[d0] * PQ[d1] + PQ[d0] * QD_1 + PQ[d1] * QD_0)
                            + delta[a0][c0] * delta[a1][c1] * delta[b0][b1] * (PQ[d0] * QD_1 + PQ[d1] * QD_0)
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][c1] * (PQ[d0] * QD_1 + PQ[d1] * QD_0)
                            + delta[a0][c0] * delta[b0][c1] * delta[a1][b1] * (PQ[d0] * QD_1 + PQ[d1] * QD_0)
                            + delta[a0][c1] * delta[a1][c0] * delta[b0][b1] * (PQ[d0] * QD_1 + PQ[d1] * QD_0)
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][c0] * (PQ[d0] * QD_1 + PQ[d1] * QD_0)
                            + delta[a0][c1] * delta[b0][c0] * delta[a1][b1] * (PQ[d0] * QD_1 + PQ[d1] * QD_0)
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][c1] * (PQ[d0] * QD_1 + PQ[d1] * QD_0)
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][c0] * (PQ[d0] * QD_1 + PQ[d1] * QD_0)
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][c1] * (PQ[d0] * QD_1 + PQ[d1] * QD_0)
                            + delta[a1][c0] * delta[b0][c1] * delta[a0][b1] * (PQ[d0] * QD_1 + PQ[d1] * QD_0)
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][c0] * (PQ[d0] * QD_1 + PQ[d1] * QD_0)
                            + delta[a1][c1] * delta[b0][c0] * delta[a0][b1] * (PQ[d0] * QD_1 + PQ[d1] * QD_0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD27(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[5];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[4] * (

                        0.25 * ( S1 * S1 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] + PB_0 * PA_0 * PQ[a1] * PQ[b1] + PB_0 * PA_1 * PQ[a0] * PQ[b1] + PB_1 * PA_0 * PQ[a1] * PQ[b0] + PB_1 * PA_1 * PQ[a0] * PQ[b0] + PA_0 * PA_1 * PQ[b0] * PQ[b1])
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] + PB_0 * PA_0 * PQ[a1] * PQ[b1] + PB_0 * PA_1 * PQ[a0] * PQ[b1] + PB_1 * PA_0 * PQ[a1] * PQ[b0] + PB_1 * PA_1 * PQ[a0] * PQ[b0] + PA_0 * PA_1 * PQ[b0] * PQ[b1])
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] + PB_0 * PA_0 * PQ[a1] * PQ[b1] + PB_0 * PA_1 * PQ[a0] * PQ[b1] + PB_1 * PA_0 * PQ[a1] * PQ[b0] + PB_1 * PA_1 * PQ[a0] * PQ[b0] + PA_0 * PA_1 * PQ[b0] * PQ[b1])
                            + delta[b1][c1] * delta[d0][d1] * (PB_0 * PA_0 * PQ[a1] * PQ[c0] + PB_0 * PA_1 * PQ[a0] * PQ[c0] + PA_0 * PA_1 * PQ[b0] * PQ[c0])
                            + delta[b1][d0] * delta[c1][d1] * (PB_0 * PA_0 * PQ[a1] * PQ[c0] + PB_0 * PA_1 * PQ[a0] * PQ[c0] + PA_0 * PA_1 * PQ[b0] * PQ[c0])
                            + delta[b1][d1] * delta[c1][d0] * (PB_0 * PA_0 * PQ[a1] * PQ[c0] + PB_0 * PA_1 * PQ[a0] * PQ[c0] + PA_0 * PA_1 * PQ[b0] * PQ[c0])
                            + delta[b1][c0] * delta[d0][d1] * (PB_0 * PA_0 * PQ[a1] * PQ[c1] + PB_0 * PA_1 * PQ[a0] * PQ[c1] + PA_0 * PA_1 * PQ[b0] * PQ[c1])
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * PA_0 * PQ[a1] * PQ[c1] + PB_0 * PA_1 * PQ[a0] * PQ[c1] + PA_0 * PA_1 * PQ[b0] * PQ[c1])
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * PA_0 * PQ[a1] * PQ[c1] + PB_0 * PA_1 * PQ[a0] * PQ[c1] + PA_0 * PA_1 * PQ[b0] * PQ[c1])
                            + delta[b1][c0] * delta[c1][d1] * (PB_0 * PA_0 * PQ[a1] * PQ[d0] + PB_0 * PA_1 * PQ[a0] * PQ[d0] + PA_0 * PA_1 * PQ[b0] * PQ[d0])
                            + delta[b1][c1] * delta[c0][d1] * (PB_0 * PA_0 * PQ[a1] * PQ[d0] + PB_0 * PA_1 * PQ[a0] * PQ[d0] + PA_0 * PA_1 * PQ[b0] * PQ[d0])
                            + delta[b1][d1] * delta[c0][c1] * (PB_0 * PA_0 * PQ[a1] * PQ[d0] + PB_0 * PA_1 * PQ[a0] * PQ[d0] + PA_0 * PA_1 * PQ[b0] * PQ[d0])
                            + delta[b1][c0] * delta[c1][d0] * (PB_0 * PA_0 * PQ[a1] * PQ[d1] + PB_0 * PA_1 * PQ[a0] * PQ[d1] + PA_0 * PA_1 * PQ[b0] * PQ[d1])
                            + delta[b1][c1] * delta[c0][d0] * (PB_0 * PA_0 * PQ[a1] * PQ[d1] + PB_0 * PA_1 * PQ[a0] * PQ[d1] + PA_0 * PA_1 * PQ[b0] * PQ[d1])
                            + delta[b1][d0] * delta[c0][c1] * (PB_0 * PA_0 * PQ[a1] * PQ[d1] + PB_0 * PA_1 * PQ[a0] * PQ[d1] + PA_0 * PA_1 * PQ[b0] * PQ[d1])
                            + delta[b0][c1] * delta[d0][d1] * (PB_1 * PA_0 * PQ[a1] * PQ[c0] + PB_1 * PA_1 * PQ[a0] * PQ[c0] + PA_0 * PA_1 * PQ[b1] * PQ[c0])
                            + delta[b0][d0] * delta[c1][d1] * (PB_1 * PA_0 * PQ[a1] * PQ[c0] + PB_1 * PA_1 * PQ[a0] * PQ[c0] + PA_0 * PA_1 * PQ[b1] * PQ[c0])
                            + delta[b0][d1] * delta[c1][d0] * (PB_1 * PA_0 * PQ[a1] * PQ[c0] + PB_1 * PA_1 * PQ[a0] * PQ[c0] + PA_0 * PA_1 * PQ[b1] * PQ[c0])
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * PA_0 * PQ[a1] * PQ[c1] + PB_1 * PA_1 * PQ[a0] * PQ[c1] + PA_0 * PA_1 * PQ[b1] * PQ[c1])
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * PA_0 * PQ[a1] * PQ[c1] + PB_1 * PA_1 * PQ[a0] * PQ[c1] + PA_0 * PA_1 * PQ[b1] * PQ[c1])
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * PA_0 * PQ[a1] * PQ[c1] + PB_1 * PA_1 * PQ[a0] * PQ[c1] + PA_0 * PA_1 * PQ[b1] * PQ[c1])
                            + delta[b0][c0] * delta[c1][d1] * (PB_1 * PA_0 * PQ[a1] * PQ[d0] + PB_1 * PA_1 * PQ[a0] * PQ[d0] + PA_0 * PA_1 * PQ[b1] * PQ[d0])
                            + delta[b0][c1] * delta[c0][d1] * (PB_1 * PA_0 * PQ[a1] * PQ[d0] + PB_1 * PA_1 * PQ[a0] * PQ[d0] + PA_0 * PA_1 * PQ[b1] * PQ[d0])
                            + delta[b0][d1] * delta[c0][c1] * (PB_1 * PA_0 * PQ[a1] * PQ[d0] + PB_1 * PA_1 * PQ[a0] * PQ[d0] + PA_0 * PA_1 * PQ[b1] * PQ[d0])
                            + delta[b0][c0] * delta[c1][d0] * (PB_1 * PA_0 * PQ[a1] * PQ[d1] + PB_1 * PA_1 * PQ[a0] * PQ[d1] + PA_0 * PA_1 * PQ[b1] * PQ[d1])
                            + delta[b0][c1] * delta[c0][d0] * (PB_1 * PA_0 * PQ[a1] * PQ[d1] + PB_1 * PA_1 * PQ[a0] * PQ[d1] + PA_0 * PA_1 * PQ[b1] * PQ[d1])
                            + delta[b0][d0] * delta[c0][c1] * (PB_1 * PA_0 * PQ[a1] * PQ[d1] + PB_1 * PA_1 * PQ[a0] * PQ[d1] + PA_0 * PA_1 * PQ[b1] * PQ[d1])
                            + delta[b0][b1] * delta[d0][d1] * (PA_0 * PQ[a1] * PQ[c0] * PQ[c1] * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * PQ[c1] * (-1.0) + PA_0 * PA_1 * PQ[c0] * PQ[c1])
                            + delta[b0][d0] * delta[b1][d1] * (PA_0 * PA_1 * PQ[c0] * PQ[c1])
                            + delta[b0][d1] * delta[b1][d0] * (PA_0 * PA_1 * PQ[c0] * PQ[c1])
                            + delta[b0][b1] * delta[c1][d1] * (PA_0 * PQ[a1] * PQ[c0] * PQ[d0] * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * PQ[d0] * (-1.0) + PA_0 * PA_1 * PQ[c0] * PQ[d0])
                            + delta[b0][c1] * delta[b1][d1] * (PA_0 * PA_1 * PQ[c0] * PQ[d0])
                            + delta[b0][d1] * delta[b1][c1] * (PA_0 * PA_1 * PQ[c0] * PQ[d0])
                            + delta[b0][b1] * delta[c1][d0] * (PA_0 * PQ[a1] * PQ[c0] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * PQ[d1] * (-1.0) + PA_0 * PA_1 * PQ[c0] * PQ[d1])
                            + delta[b0][c1] * delta[b1][d0] * (PA_0 * PA_1 * PQ[c0] * PQ[d1])
                            + delta[b0][d0] * delta[b1][c1] * (PA_0 * PA_1 * PQ[c0] * PQ[d1])
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * PQ[a1] * PQ[c1] * PQ[d0] * (-1.0) + PA_1 * PQ[a0] * PQ[c1] * PQ[d0] * (-1.0) + PA_0 * PA_1 * PQ[c1] * PQ[d0])
                            + delta[b0][c0] * delta[b1][d1] * (PA_0 * PA_1 * PQ[c1] * PQ[d0])
                            + delta[b0][d1] * delta[b1][c0] * (PA_0 * PA_1 * PQ[c1] * PQ[d0])
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * PQ[a1] * PQ[c1] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[c1] * PQ[d1] * (-1.0) + PA_0 * PA_1 * PQ[c1] * PQ[d1])
                            + delta[b0][c0] * delta[b1][d0] * (PA_0 * PA_1 * PQ[c1] * PQ[d1])
                            + delta[b0][d0] * delta[b1][c0] * (PA_0 * PA_1 * PQ[c1] * PQ[d1])
                            + delta[b0][b1] * delta[c0][c1] * (PA_0 * PQ[a1] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PA_1 * PQ[d0] * PQ[d1])
                            + delta[b0][c0] * delta[b1][c1] * (PA_0 * PA_1 * PQ[d0] * PQ[d1])
                            + delta[b0][c1] * delta[b1][c0] * (PA_0 * PA_1 * PQ[d0] * PQ[d1])
                            + delta[a1][c1] * delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] + PB_0 * PA_0 * PQ[b1] * PQ[c0] + PB_1 * PA_0 * PQ[b0] * PQ[c0])
                            + delta[a1][d0] * delta[c1][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] + PB_0 * PA_0 * PQ[b1] * PQ[c0] + PB_1 * PA_0 * PQ[b0] * PQ[c0])
                            + delta[a1][d1] * delta[c1][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] + PB_0 * PA_0 * PQ[b1] * PQ[c0] + PB_1 * PA_0 * PQ[b0] * PQ[c0])
                            + delta[a1][c0] * delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[c1] + PB_0 * PA_0 * PQ[b1] * PQ[c1] + PB_1 * PA_0 * PQ[b0] * PQ[c1])
                            + delta[a1][d0] * delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[c1] + PB_0 * PA_0 * PQ[b1] * PQ[c1] + PB_1 * PA_0 * PQ[b0] * PQ[c1])
                            + delta[a1][d1] * delta[c0][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[c1] + PB_0 * PA_0 * PQ[b1] * PQ[c1] + PB_1 * PA_0 * PQ[b0] * PQ[c1])
                            + delta[a1][c0] * delta[c1][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[d0] + PB_0 * PA_0 * PQ[b1] * PQ[d0] + PB_1 * PA_0 * PQ[b0] * PQ[d0])
                            + delta[a1][c1] * delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[d0] + PB_0 * PA_0 * PQ[b1] * PQ[d0] + PB_1 * PA_0 * PQ[b0] * PQ[d0])
                            + delta[a1][d1] * delta[c0][c1] * (PB_0 * PB_1 * PQ[a0] * PQ[d0] + PB_0 * PA_0 * PQ[b1] * PQ[d0] + PB_1 * PA_0 * PQ[b0] * PQ[d0])
                            + delta[a1][c0] * delta[c1][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[d1] + PB_0 * PA_0 * PQ[b1] * PQ[d1] + PB_1 * PA_0 * PQ[b0] * PQ[d1])
                            + delta[a1][c1] * delta[c0][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[d1] + PB_0 * PA_0 * PQ[b1] * PQ[d1] + PB_1 * PA_0 * PQ[b0] * PQ[d1])
                            + delta[a1][d0] * delta[c0][c1] * (PB_0 * PB_1 * PQ[a0] * PQ[d1] + PB_0 * PA_0 * PQ[b1] * PQ[d1] + PB_1 * PA_0 * PQ[b0] * PQ[d1])
                            + delta[a1][d0] * delta[b1][d1] * (PB_0 * PA_0 * PQ[c0] * PQ[c1])
                            + delta[a1][d1] * delta[b1][d0] * (PB_0 * PA_0 * PQ[c0] * PQ[c1])
                            + delta[a1][b1] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[c0] * PQ[c1] * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * (-1.0) + PB_0 * PA_0 * PQ[c0] * PQ[c1])
                            + delta[a1][c1] * delta[b1][d1] * (PB_0 * PA_0 * PQ[c0] * PQ[d0])
                            + delta[a1][d1] * delta[b1][c1] * (PB_0 * PA_0 * PQ[c0] * PQ[d0])
                            + delta[a1][b1] * delta[c1][d1] * (PB_0 * PQ[a0] * PQ[c0] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * PQ[d0] * (-1.0) + PB_0 * PA_0 * PQ[c0] * PQ[d0])
                            + delta[a1][c1] * delta[b1][d0] * (PB_0 * PA_0 * PQ[c0] * PQ[d1])
                            + delta[a1][d0] * delta[b1][c1] * (PB_0 * PA_0 * PQ[c0] * PQ[d1])
                            + delta[a1][b1] * delta[c1][d0] * (PB_0 * PQ[a0] * PQ[c0] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PQ[c0] * PQ[d1])
                            + delta[a1][c0] * delta[b1][d1] * (PB_0 * PA_0 * PQ[c1] * PQ[d0])
                            + delta[a1][d1] * delta[b1][c0] * (PB_0 * PA_0 * PQ[c1] * PQ[d0])
                            + delta[a1][b1] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[c1] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * PQ[d0] * (-1.0) + PB_0 * PA_0 * PQ[c1] * PQ[d0])
                            + delta[a1][c0] * delta[b1][d0] * (PB_0 * PA_0 * PQ[c1] * PQ[d1])
                            + delta[a1][d0] * delta[b1][c0] * (PB_0 * PA_0 * PQ[c1] * PQ[d1])
                            + delta[a1][b1] * delta[c0][d0] * (PB_0 * PQ[a0] * PQ[c1] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PQ[c1] * PQ[d1])
                            + delta[a1][c0] * delta[b1][c1] * (PB_0 * PA_0 * PQ[d0] * PQ[d1])
                            + delta[a1][c1] * delta[b1][c0] * (PB_0 * PA_0 * PQ[d0] * PQ[d1])
                            + delta[a1][b1] * delta[c0][c1] * (PB_0 * PQ[a0] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PQ[d0] * PQ[d1])
                            + delta[a1][d0] * delta[b0][d1] * (PB_1 * PA_0 * PQ[c0] * PQ[c1])
                            + delta[a1][d1] * delta[b0][d0] * (PB_1 * PA_0 * PQ[c0] * PQ[c1])
                            + delta[a1][b0] * delta[d0][d1] * (PB_1 * PQ[a0] * PQ[c0] * PQ[c1] * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * PQ[c1] * (-1.0) + PB_1 * PA_0 * PQ[c0] * PQ[c1])
                            + delta[a1][c1] * delta[b0][d1] * (PB_1 * PA_0 * PQ[c0] * PQ[d0])
                            + delta[a1][d1] * delta[b0][c1] * (PB_1 * PA_0 * PQ[c0] * PQ[d0])
                            + delta[a1][b0] * delta[c1][d1] * (PB_1 * PQ[a0] * PQ[c0] * PQ[d0] * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0) + PB_1 * PA_0 * PQ[c0] * PQ[d0])
                            + delta[a1][c1] * delta[b0][d0] * (PB_1 * PA_0 * PQ[c0] * PQ[d1])
                            + delta[a1][d0] * delta[b0][c1] * (PB_1 * PA_0 * PQ[c0] * PQ[d1])
                            + delta[a1][b0] * delta[c1][d0] * (PB_1 * PQ[a0] * PQ[c0] * PQ[d1] * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PQ[c0] * PQ[d1])
                            + delta[a1][c0] * delta[b0][d1] * (PB_1 * PA_0 * PQ[c1] * PQ[d0])
                            + delta[a1][d1] * delta[b0][c0] * (PB_1 * PA_0 * PQ[c1] * PQ[d0])
                            + delta[a1][b0] * delta[c0][d1] * (PB_1 * PQ[a0] * PQ[c1] * PQ[d0] * (-1.0) + PA_0 * PQ[b1] * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PA_0 * PQ[c1] * PQ[d0])
                            + delta[a1][c0] * delta[b0][d0] * (PB_1 * PA_0 * PQ[c1] * PQ[d1])
                            + delta[a1][d0] * delta[b0][c0] * (PB_1 * PA_0 * PQ[c1] * PQ[d1])
                            + delta[a1][b0] * delta[c0][d0] * (PB_1 * PQ[a0] * PQ[c1] * PQ[d1] * (-1.0) + PA_0 * PQ[b1] * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PQ[c1] * PQ[d1])
                            + delta[a1][c0] * delta[b0][c1] * (PB_1 * PA_0 * PQ[d0] * PQ[d1])
                            + delta[a1][c1] * delta[b0][c0] * (PB_1 * PA_0 * PQ[d0] * PQ[d1])
                            + delta[a1][b0] * delta[c0][c1] * (PB_1 * PQ[a0] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PQ[d0] * PQ[d1])
                            + delta[a1][d1] * delta[b0][b1] * (PA_0 * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a1][b0] * delta[b1][d1] * (PA_0 * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[b0][d1] * delta[a1][b1] * (PA_0 * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a1][d0] * delta[b0][b1] * (PA_0 * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a1][b0] * delta[b1][d0] * (PA_0 * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[b0][d0] * delta[a1][b1] * (PA_0 * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a1][c1] * delta[b0][b1] * (PA_0 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][b0] * delta[b1][c1] * (PA_0 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][c1] * delta[a1][b1] * (PA_0 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][c0] * delta[b0][b1] * (PA_0 * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][b0] * delta[b1][c0] * (PA_0 * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][c0] * delta[a1][b1] * (PA_0 * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[d0][d1] * (PB_0 * PB_1 * PQ[a1] * PQ[c0] + PB_0 * PA_1 * PQ[b1] * PQ[c0] + PB_1 * PA_1 * PQ[b0] * PQ[c0])
                            + delta[a0][d0] * delta[c1][d1] * (PB_0 * PB_1 * PQ[a1] * PQ[c0] + PB_0 * PA_1 * PQ[b1] * PQ[c0] + PB_1 * PA_1 * PQ[b0] * PQ[c0])
                            + delta[a0][d1] * delta[c1][d0] * (PB_0 * PB_1 * PQ[a1] * PQ[c0] + PB_0 * PA_1 * PQ[b1] * PQ[c0] + PB_1 * PA_1 * PQ[b0] * PQ[c0])
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * PB_1 * PQ[a1] * PQ[c1] + PB_0 * PA_1 * PQ[b1] * PQ[c1] + PB_1 * PA_1 * PQ[b0] * PQ[c1])
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * PB_1 * PQ[a1] * PQ[c1] + PB_0 * PA_1 * PQ[b1] * PQ[c1] + PB_1 * PA_1 * PQ[b0] * PQ[c1])
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * PB_1 * PQ[a1] * PQ[c1] + PB_0 * PA_1 * PQ[b1] * PQ[c1] + PB_1 * PA_1 * PQ[b0] * PQ[c1])
                            + delta[a0][c0] * delta[c1][d1] * (PB_0 * PB_1 * PQ[a1] * PQ[d0] + PB_0 * PA_1 * PQ[b1] * PQ[d0] + PB_1 * PA_1 * PQ[b0] * PQ[d0])
                            + delta[a0][c1] * delta[c0][d1] * (PB_0 * PB_1 * PQ[a1] * PQ[d0] + PB_0 * PA_1 * PQ[b1] * PQ[d0] + PB_1 * PA_1 * PQ[b0] * PQ[d0])
                            + delta[a0][d1] * delta[c0][c1] * (PB_0 * PB_1 * PQ[a1] * PQ[d0] + PB_0 * PA_1 * PQ[b1] * PQ[d0] + PB_1 * PA_1 * PQ[b0] * PQ[d0])
                            + delta[a0][c0] * delta[c1][d0] * (PB_0 * PB_1 * PQ[a1] * PQ[d1] + PB_0 * PA_1 * PQ[b1] * PQ[d1] + PB_1 * PA_1 * PQ[b0] * PQ[d1])
                            + delta[a0][c1] * delta[c0][d0] * (PB_0 * PB_1 * PQ[a1] * PQ[d1] + PB_0 * PA_1 * PQ[b1] * PQ[d1] + PB_1 * PA_1 * PQ[b0] * PQ[d1])
                            + delta[a0][d0] * delta[c0][c1] * (PB_0 * PB_1 * PQ[a1] * PQ[d1] + PB_0 * PA_1 * PQ[b1] * PQ[d1] + PB_1 * PA_1 * PQ[b0] * PQ[d1])
                            + delta[a0][d0] * delta[b1][d1] * (PB_0 * PA_1 * PQ[c0] * PQ[c1])
                            + delta[a0][d1] * delta[b1][d0] * (PB_0 * PA_1 * PQ[c0] * PQ[c1])
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PQ[a1] * PQ[c0] * PQ[c1] * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * PQ[c1] * (-1.0) + PB_0 * PA_1 * PQ[c0] * PQ[c1])
                            + delta[a0][c1] * delta[b1][d1] * (PB_0 * PA_1 * PQ[c0] * PQ[d0])
                            + delta[a0][d1] * delta[b1][c1] * (PB_0 * PA_1 * PQ[c0] * PQ[d0])
                            + delta[a0][b1] * delta[c1][d1] * (PB_0 * PQ[a1] * PQ[c0] * PQ[d0] * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * PQ[d0] * (-1.0) + PB_0 * PA_1 * PQ[c0] * PQ[d0])
                            + delta[a0][c1] * delta[b1][d0] * (PB_0 * PA_1 * PQ[c0] * PQ[d1])
                            + delta[a0][d0] * delta[b1][c1] * (PB_0 * PA_1 * PQ[c0] * PQ[d1])
                            + delta[a0][b1] * delta[c1][d0] * (PB_0 * PQ[a1] * PQ[c0] * PQ[d1] * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * PQ[d1] * (-1.0) + PB_0 * PA_1 * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * delta[b1][d1] * (PB_0 * PA_1 * PQ[c1] * PQ[d0])
                            + delta[a0][d1] * delta[b1][c0] * (PB_0 * PA_1 * PQ[c1] * PQ[d0])
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * PQ[a1] * PQ[c1] * PQ[d0] * (-1.0) + PA_1 * PQ[b0] * PQ[c1] * PQ[d0] * (-1.0) + PB_0 * PA_1 * PQ[c1] * PQ[d0])
                            + delta[a0][c0] * delta[b1][d0] * (PB_0 * PA_1 * PQ[c1] * PQ[d1])
                            + delta[a0][d0] * delta[b1][c0] * (PB_0 * PA_1 * PQ[c1] * PQ[d1])
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PQ[a1] * PQ[c1] * PQ[d1] * (-1.0) + PA_1 * PQ[b0] * PQ[c1] * PQ[d1] * (-1.0) + PB_0 * PA_1 * PQ[c1] * PQ[d1])
                            + delta[a0][c0] * delta[b1][c1] * (PB_0 * PA_1 * PQ[d0] * PQ[d1])
                            + delta[a0][c1] * delta[b1][c0] * (PB_0 * PA_1 * PQ[d0] * PQ[d1])
                            + delta[a0][b1] * delta[c0][c1] * (PB_0 * PQ[a1] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[b0] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PA_1 * PQ[d0] * PQ[d1])
                            + delta[a0][d0] * delta[b0][d1] * (PB_1 * PA_1 * PQ[c0] * PQ[c1])
                            + delta[a0][d1] * delta[b0][d0] * (PB_1 * PA_1 * PQ[c0] * PQ[c1])
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PQ[a1] * PQ[c0] * PQ[c1] * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * PQ[c1] * (-1.0) + PB_1 * PA_1 * PQ[c0] * PQ[c1])
                            + delta[a0][c1] * delta[b0][d1] * (PB_1 * PA_1 * PQ[c0] * PQ[d0])
                            + delta[a0][d1] * delta[b0][c1] * (PB_1 * PA_1 * PQ[c0] * PQ[d0])
                            + delta[a0][b0] * delta[c1][d1] * (PB_1 * PQ[a1] * PQ[c0] * PQ[d0] * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0) + PB_1 * PA_1 * PQ[c0] * PQ[d0])
                            + delta[a0][c1] * delta[b0][d0] * (PB_1 * PA_1 * PQ[c0] * PQ[d1])
                            + delta[a0][d0] * delta[b0][c1] * (PB_1 * PA_1 * PQ[c0] * PQ[d1])
                            + delta[a0][b0] * delta[c1][d0] * (PB_1 * PQ[a1] * PQ[c0] * PQ[d1] * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * PQ[d1] * (-1.0) + PB_1 * PA_1 * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * delta[b0][d1] * (PB_1 * PA_1 * PQ[c1] * PQ[d0])
                            + delta[a0][d1] * delta[b0][c0] * (PB_1 * PA_1 * PQ[c1] * PQ[d0])
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * PQ[a1] * PQ[c1] * PQ[d0] * (-1.0) + PA_1 * PQ[b1] * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PA_1 * PQ[c1] * PQ[d0])
                            + delta[a0][c0] * delta[b0][d0] * (PB_1 * PA_1 * PQ[c1] * PQ[d1])
                            + delta[a0][d0] * delta[b0][c0] * (PB_1 * PA_1 * PQ[c1] * PQ[d1])
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PQ[a1] * PQ[c1] * PQ[d1] * (-1.0) + PA_1 * PQ[b1] * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PA_1 * PQ[c1] * PQ[d1])
                            + delta[a0][c0] * delta[b0][c1] * (PB_1 * PA_1 * PQ[d0] * PQ[d1])
                            + delta[a0][c1] * delta[b0][c0] * (PB_1 * PA_1 * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * delta[c0][c1] * (PB_1 * PQ[a1] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PA_1 * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * delta[b0][b1] * (PA_1 * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * (PA_1 * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * (PA_1 * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * (PA_1 * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * (PA_1 * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * (PA_1 * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[b0][b1] * (PA_1 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[b1][c1] * (PA_1 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][c1] * delta[a0][b1] * (PA_1 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * (PA_1 * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * (PA_1 * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * (PA_1 * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[d0][d1] * (PB_0 * PQ[b1] * PQ[c0] * PQ[c1] * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * PQ[c1] * (-1.0) + PB_0 * PB_1 * PQ[c0] * PQ[c1])
                            + delta[a0][a1] * delta[c1][d1] * (PB_0 * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * PQ[d0] * (-1.0) + PB_0 * PB_1 * PQ[c0] * PQ[d0])
                            + delta[a0][a1] * delta[c1][d0] * (PB_0 * PQ[b1] * PQ[c0] * PQ[d1] * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * PQ[d1] * (-1.0) + PB_0 * PB_1 * PQ[c0] * PQ[d1])
                            + delta[a0][a1] * delta[c0][d1] * (PB_0 * PQ[b1] * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * PQ[d0] * (-1.0) + PB_0 * PB_1 * PQ[c1] * PQ[d0])
                            + delta[a0][a1] * delta[c0][d0] * (PB_0 * PQ[b1] * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * PQ[d1] * (-1.0) + PB_0 * PB_1 * PQ[c1] * PQ[d1])
                            + delta[a0][a1] * delta[c0][c1] * (PB_0 * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PB_1 * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * delta[a1][b1] * (PB_0 * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[b1][d1] * (PB_0 * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a1][d1] * delta[a0][b1] * (PB_0 * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][d0] * delta[a1][b1] * (PB_0 * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b1][d0] * (PB_0 * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a1][d0] * delta[a0][b1] * (PB_0 * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[a1][b1] * (PB_0 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b1][c1] * (PB_0 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][c1] * delta[a0][b1] * (PB_0 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[a1][b1] * (PB_0 * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b1][c0] * (PB_0 * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][c0] * delta[a0][b1] * (PB_0 * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * (PB_1 * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * (PB_1 * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * (PB_1 * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * (PB_1 * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * (PB_1 * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * (PB_1 * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[a1][b0] * (PB_1 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b0][c1] * (PB_1 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][c1] * delta[a0][b0] * (PB_1 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * (PB_1 * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * (PB_1 * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * (PB_1 * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[a1][d1] * (PB_0 * PB_1 * PQ[c0] * PQ[c1])
                            + delta[a0][d1] * delta[a1][d0] * (PB_0 * PB_1 * PQ[c0] * PQ[c1])
                            + delta[a0][c1] * delta[a1][d1] * (PB_0 * PB_1 * PQ[c0] * PQ[d0])
                            + delta[a0][d1] * delta[a1][c1] * (PB_0 * PB_1 * PQ[c0] * PQ[d0])
                            + delta[a0][c1] * delta[a1][d0] * (PB_0 * PB_1 * PQ[c0] * PQ[d1])
                            + delta[a0][d0] * delta[a1][c1] * (PB_0 * PB_1 * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * delta[a1][d1] * (PB_0 * PB_1 * PQ[c1] * PQ[d0])
                            + delta[a0][d1] * delta[a1][c0] * (PB_0 * PB_1 * PQ[c1] * PQ[d0])
                            + delta[a0][c0] * delta[a1][d0] * (PB_0 * PB_1 * PQ[c1] * PQ[d1])
                            + delta[a0][d0] * delta[a1][c0] * (PB_0 * PB_1 * PQ[c1] * PQ[d1])
                            + delta[a0][c0] * delta[a1][c1] * (PB_0 * PB_1 * PQ[d0] * PQ[d1])
                            + delta[a0][c1] * delta[a1][c0] * (PB_0 * PB_1 * PQ[d0] * PQ[d1])
                            + delta[a0][a1] * delta[b0][b1] * (PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * delta[a1][b1] * (PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a1][b0] * delta[a0][b1] * (PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD28(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[5];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[4] * (

                        0.25 * ( S1 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * (-2.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * (-2.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * (-2.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * (-2.0))
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * (-2.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * (-2.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * (-2.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * (-2.0))
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * (-2.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * (-2.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * (-2.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * (-2.0))
                            + delta[b1][c1] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c0] * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * QC_0 * (-1.0))
                            + delta[b1][d0] * delta[c1][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c0] * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * QC_0 * (-1.0))
                            + delta[b1][d1] * delta[c1][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c0] * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * QC_0 * (-1.0))
                            + delta[b1][c0] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c1] * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[c1] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[c1] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * QC_1 * (-1.0))
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c1] * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[c1] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[c1] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * QC_1 * (-1.0))
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c1] * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[c1] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[c1] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * QC_1 * (-1.0))
                            + delta[b1][c0] * delta[c1][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[d0] * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * QD_0 * (-1.0))
                            + delta[b1][c1] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[d0] * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * QD_0 * (-1.0))
                            + delta[b1][d1] * delta[c0][c1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[d0] * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * QD_0 * (-1.0))
                            + delta[b1][c0] * delta[c1][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[d1] * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * QD_1 * (-1.0))
                            + delta[b1][c1] * delta[c0][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[d1] * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * QD_1 * (-1.0))
                            + delta[b1][d0] * delta[c0][c1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[d1] * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * QD_1 * (-1.0))
                            + delta[b0][c1] * delta[d0][d1] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[c1][d1] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[c1][d0] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c1] * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[c1] * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[c1] * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * QC_1 * (-1.0))
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c1] * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[c1] * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[c1] * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * QC_1 * (-1.0))
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c1] * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[c1] * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[c1] * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[c1][d1] * (PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[b0][c1] * delta[c0][d1] * (PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[b0][d1] * delta[c0][c1] * (PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[b0][c0] * delta[c1][d0] * (PB_1 * PQ[a0] * PQ[a1] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[b0][c1] * delta[c0][d0] * (PB_1 * PQ[a0] * PQ[a1] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[b0][d0] * delta[c0][c1] * (PB_1 * PQ[a0] * PQ[a1] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[b0][b1] * delta[d0][d1] * (PA_0 * PQ[a1] * PQ[c0] * PQ[c1] * (-1.0) + PA_0 * PQ[a1] * PQ[c0] * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[c1] * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * PQ[c1] * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[c1] * QC_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1] + PQ[a0] * PQ[a1] * PQ[c0] * QC_1 + PQ[a0] * PQ[a1] * PQ[c1] * QC_0)
                            + delta[b0][b1] * delta[c1][d1] * (PA_0 * PQ[a1] * PQ[c0] * PQ[d0] * (-1.0) + PA_0 * PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[d0] * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * PQ[d0] * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[d0] * QC_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0] + PQ[a0] * PQ[a1] * PQ[c0] * QD_0 + PQ[a0] * PQ[a1] * PQ[d0] * QC_0)
                            + delta[b0][b1] * delta[c1][d0] * (PA_0 * PQ[a1] * PQ[c0] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[d1] * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[d1] * QC_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[c0] * PQ[d1] + PQ[a0] * PQ[a1] * PQ[c0] * QD_1 + PQ[a0] * PQ[a1] * PQ[d1] * QC_0)
                            + delta[b0][d0] * delta[b1][d1] * (PA_0 * PQ[a1] * PQ[c0] * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[c1] * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[c1] * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[b1][d0] * (PA_0 * PQ[a1] * PQ[c0] * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[c1] * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[c1] * QC_0 * (-1.0))
                            + delta[b0][c1] * delta[b1][d1] * (PA_0 * PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[d0] * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[b1][c1] * (PA_0 * PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[d0] * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][c1] * delta[b1][d0] * (PA_0 * PQ[a1] * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[d1] * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[b1][c1] * (PA_0 * PQ[a1] * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[d1] * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * PQ[a1] * PQ[c1] * PQ[d0] * (-1.0) + PA_0 * PQ[a1] * PQ[c1] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[d0] * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[c1] * PQ[d0] * (-1.0) + PA_1 * PQ[a0] * PQ[c1] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[d0] * QC_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[c1] * PQ[d0] + PQ[a0] * PQ[a1] * PQ[c1] * QD_0 + PQ[a0] * PQ[a1] * PQ[d0] * QC_1)
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * PQ[a1] * PQ[c1] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[c1] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[d1] * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[c1] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[c1] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[d1] * QC_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[c1] * PQ[d1] + PQ[a0] * PQ[a1] * PQ[c1] * QD_1 + PQ[a0] * PQ[a1] * PQ[d1] * QC_1)
                            + delta[b0][c0] * delta[b1][d1] * (PA_0 * PQ[a1] * PQ[c1] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[d0] * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[c1] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[d0] * QC_1 * (-1.0))
                            + delta[b0][d1] * delta[b1][c0] * (PA_0 * PQ[a1] * PQ[c1] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[d0] * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[c1] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[d0] * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[b1][d0] * (PA_0 * PQ[a1] * PQ[c1] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[d1] * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[c1] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[b0][d0] * delta[b1][c0] * (PA_0 * PQ[a1] * PQ[c1] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[d1] * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[c1] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[b0][b1] * delta[c0][c1] * (PA_0 * PQ[a1] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[d1] * QD_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d0] * PQ[d1] + PQ[a0] * PQ[a1] * PQ[d0] * QD_1 + PQ[a0] * PQ[a1] * PQ[d1] * QD_0)
                            + delta[b0][c0] * delta[b1][c1] * (PA_0 * PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][c1] * delta[b1][c0] * (PA_0 * PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][c1] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[c1][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[c1][d0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[a1][c0] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c1] * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c1] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c1] * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c1] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * QC_1 * (-1.0))
                            + delta[a1][d1] * delta[c0][d0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c1] * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c1] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[c1][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[a1][c1] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[a1][d1] * delta[c0][c1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[a1][c0] * delta[c1][d0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[d1] * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[a1][c1] * delta[c0][d0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[d1] * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[a1][d0] * delta[c0][c1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[d1] * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[a1][b1] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[c0] * PQ[c1] * (-1.0) + PB_0 * PQ[a0] * PQ[c0] * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[c1] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] + PQ[a0] * PQ[b0] * PQ[c0] * QC_1 + PQ[a0] * PQ[b0] * PQ[c1] * QC_0)
                            + delta[a1][b1] * delta[c1][d1] * (PB_0 * PQ[a0] * PQ[c0] * PQ[d0] * (-1.0) + PB_0 * PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[a0] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] + PQ[a0] * PQ[b0] * PQ[c0] * QD_0 + PQ[a0] * PQ[b0] * PQ[d0] * QC_0)
                            + delta[a1][b1] * delta[c1][d0] * (PB_0 * PQ[a0] * PQ[c0] * PQ[d1] * (-1.0) + PB_0 * PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1] + PQ[a0] * PQ[b0] * PQ[c0] * QD_1 + PQ[a0] * PQ[b0] * PQ[d1] * QC_0)
                            + delta[a1][d0] * delta[b1][d1] * (PB_0 * PQ[a0] * PQ[c0] * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[c1] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[b1][d0] * (PB_0 * PQ[a0] * PQ[c0] * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[c1] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[b1][d1] * (PB_0 * PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[a0] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[b1][c1] * (PB_0 * PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[a0] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[b1][d0] * (PB_0 * PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[b1][c1] * (PB_0 * PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][b1] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[c1] * PQ[d0] * (-1.0) + PB_0 * PQ[a0] * PQ[c1] * QD_0 * (-1.0) + PB_0 * PQ[a0] * PQ[d0] * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] + PQ[a0] * PQ[b0] * PQ[c1] * QD_0 + PQ[a0] * PQ[b0] * PQ[d0] * QC_1)
                            + delta[a1][b1] * delta[c0][d0] * (PB_0 * PQ[a0] * PQ[c1] * PQ[d1] * (-1.0) + PB_0 * PQ[a0] * PQ[c1] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[d1] * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[c1] * PQ[d1] + PQ[a0] * PQ[b0] * PQ[c1] * QD_1 + PQ[a0] * PQ[b0] * PQ[d1] * QC_1)
                            + delta[a1][c0] * delta[b1][d1] * (PB_0 * PQ[a0] * PQ[c1] * QD_0 * (-1.0) + PB_0 * PQ[a0] * PQ[d0] * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a1][d1] * delta[b1][c0] * (PB_0 * PQ[a0] * PQ[c1] * QD_0 * (-1.0) + PB_0 * PQ[a0] * PQ[d0] * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[b1][d0] * (PB_0 * PQ[a0] * PQ[c1] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[d1] * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[b1][c0] * (PB_0 * PQ[a0] * PQ[c1] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[d1] * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a1][b1] * delta[c0][c1] * (PB_0 * PQ[a0] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1] + PQ[a0] * PQ[b0] * PQ[d0] * QD_1 + PQ[a0] * PQ[b0] * PQ[d1] * QD_0)
                            + delta[a1][c0] * delta[b1][c1] * (PB_0 * PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][c1] * delta[b1][c0] * (PB_0 * PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][b0] * delta[d0][d1] * (PB_1 * PQ[a0] * PQ[c0] * PQ[c1] * (-1.0) + PB_1 * PQ[a0] * PQ[c0] * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[c1] * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * PQ[c1] * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c1] * QC_0 * (-1.0) + PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] + PQ[a0] * PQ[b1] * PQ[c0] * QC_1 + PQ[a0] * PQ[b1] * PQ[c1] * QC_0)
                            + delta[a1][b0] * delta[c1][d1] * (PB_1 * PQ[a0] * PQ[c0] * PQ[d0] * (-1.0) + PB_1 * PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] + PQ[a0] * PQ[b1] * PQ[c0] * QD_0 + PQ[a0] * PQ[b1] * PQ[d0] * QC_0)
                            + delta[a1][b0] * delta[c1][d0] * (PB_1 * PQ[a0] * PQ[c0] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * PQ[d1] * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PQ[a0] * PQ[b1] * PQ[c0] * PQ[d1] + PQ[a0] * PQ[b1] * PQ[c0] * QD_1 + PQ[a0] * PQ[b1] * PQ[d1] * QC_0)
                            + delta[a1][d0] * delta[b0][d1] * (PB_1 * PQ[a0] * PQ[c0] * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[c1] * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[b0][d0] * (PB_1 * PQ[a0] * PQ[c0] * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[c1] * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[b0][d1] * (PB_1 * PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[b0][c1] * (PB_1 * PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[b0][d0] * (PB_1 * PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[b0][c1] * (PB_1 * PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[c0][d1] * (PB_1 * PQ[a0] * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PQ[a0] * PQ[c1] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[d0] * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c1] * PQ[d0] * (-1.0) + PA_0 * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * QC_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[c1] * PQ[d0] + PQ[a0] * PQ[b1] * PQ[c1] * QD_0 + PQ[a0] * PQ[b1] * PQ[d0] * QC_1)
                            + delta[a1][b0] * delta[c0][d0] * (PB_1 * PQ[a0] * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[c1] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[d1] * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c1] * PQ[d1] * (-1.0) + PA_0 * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * QC_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[c1] * PQ[d1] + PQ[a0] * PQ[b1] * PQ[c1] * QD_1 + PQ[a0] * PQ[b1] * PQ[d1] * QC_1)
                            + delta[a1][c0] * delta[b0][d1] * (PB_1 * PQ[a0] * PQ[c1] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[d0] * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a1][d1] * delta[b0][c0] * (PB_1 * PQ[a0] * PQ[c1] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[d0] * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[b0][d0] * (PB_1 * PQ[a0] * PQ[c1] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[d1] * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[b0][c0] * (PB_1 * PQ[a0] * PQ[c1] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[d1] * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[c0][c1] * (PB_1 * PQ[a0] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1] + PQ[a0] * PQ[b1] * PQ[d0] * QD_1 + PQ[a0] * PQ[b1] * PQ[d1] * QD_0)
                            + delta[a1][c0] * delta[b0][c1] * (PB_1 * PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][c1] * delta[b0][c0] * (PB_1 * PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][d1] * delta[b0][b1] * (PA_0 * PQ[c0] * PQ[c1] * QD_0 * (-1.0) + PA_0 * PQ[c0] * PQ[d0] * QC_1 * (-1.0) + PA_0 * PQ[c1] * PQ[d0] * QC_0 * (-1.0) + PQ[a0] * PQ[c0] * PQ[c1] * QD_0 + PQ[a0] * PQ[c0] * PQ[d0] * QC_1 + PQ[a0] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a1][b0] * delta[b1][d1] * (PA_0 * PQ[c0] * PQ[c1] * QD_0 * (-1.0) + PA_0 * PQ[c0] * PQ[d0] * QC_1 * (-1.0) + PA_0 * PQ[c1] * PQ[d0] * QC_0 * (-1.0) + PQ[a0] * PQ[c0] * PQ[c1] * QD_0 + PQ[a0] * PQ[c0] * PQ[d0] * QC_1 + PQ[a0] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[b0][d1] * delta[a1][b1] * (PA_0 * PQ[c0] * PQ[c1] * QD_0 * (-1.0) + PA_0 * PQ[c0] * PQ[d0] * QC_1 * (-1.0) + PA_0 * PQ[c1] * PQ[d0] * QC_0 * (-1.0) + PQ[a0] * PQ[c0] * PQ[c1] * QD_0 + PQ[a0] * PQ[c0] * PQ[d0] * QC_1 + PQ[a0] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a1][d0] * delta[b0][b1] * (PA_0 * PQ[c0] * PQ[c1] * QD_1 * (-1.0) + PA_0 * PQ[c0] * PQ[d1] * QC_1 * (-1.0) + PA_0 * PQ[c1] * PQ[d1] * QC_0 * (-1.0) + PQ[a0] * PQ[c0] * PQ[c1] * QD_1 + PQ[a0] * PQ[c0] * PQ[d1] * QC_1 + PQ[a0] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a1][b0] * delta[b1][d0] * (PA_0 * PQ[c0] * PQ[c1] * QD_1 * (-1.0) + PA_0 * PQ[c0] * PQ[d1] * QC_1 * (-1.0) + PA_0 * PQ[c1] * PQ[d1] * QC_0 * (-1.0) + PQ[a0] * PQ[c0] * PQ[c1] * QD_1 + PQ[a0] * PQ[c0] * PQ[d1] * QC_1 + PQ[a0] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[b0][d0] * delta[a1][b1] * (PA_0 * PQ[c0] * PQ[c1] * QD_1 * (-1.0) + PA_0 * PQ[c0] * PQ[d1] * QC_1 * (-1.0) + PA_0 * PQ[c1] * PQ[d1] * QC_0 * (-1.0) + PQ[a0] * PQ[c0] * PQ[c1] * QD_1 + PQ[a0] * PQ[c0] * PQ[d1] * QC_1 + PQ[a0] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a1][c1] * delta[b0][b1] * (PA_0 * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PQ[a0] * PQ[c0] * PQ[d0] * QD_1 + PQ[a0] * PQ[c0] * PQ[d1] * QD_0 + PQ[a0] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a1][b0] * delta[b1][c1] * (PA_0 * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PQ[a0] * PQ[c0] * PQ[d0] * QD_1 + PQ[a0] * PQ[c0] * PQ[d1] * QD_0 + PQ[a0] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[b0][c1] * delta[a1][b1] * (PA_0 * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PQ[a0] * PQ[c0] * PQ[d0] * QD_1 + PQ[a0] * PQ[c0] * PQ[d1] * QD_0 + PQ[a0] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a1][c0] * delta[b0][b1] * (PA_0 * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[a0] * PQ[c1] * PQ[d0] * QD_1 + PQ[a0] * PQ[c1] * PQ[d1] * QD_0 + PQ[a0] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a1][b0] * delta[b1][c0] * (PA_0 * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[a0] * PQ[c1] * PQ[d0] * QD_1 + PQ[a0] * PQ[c1] * PQ[d1] * QD_0 + PQ[a0] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[b0][c0] * delta[a1][b1] * (PA_0 * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[a0] * PQ[c1] * PQ[d0] * QD_1 + PQ[a0] * PQ[c1] * PQ[d1] * QD_0 + PQ[a0] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a0][c1] * delta[d0][d1] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c0] * (-1.0) + PB_0 * PQ[a1] * PQ[b1] * QC_0 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[c0] * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[c1][d1] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c0] * (-1.0) + PB_0 * PQ[a1] * PQ[b1] * QC_0 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[c0] * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[c1][d0] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c0] * (-1.0) + PB_0 * PQ[a1] * PQ[b1] * QC_0 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[c0] * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c1] * (-1.0) + PB_0 * PQ[a1] * PQ[b1] * QC_1 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[c1] * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[c1] * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c1] * (-1.0) + PB_0 * PQ[a1] * PQ[b1] * QC_1 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[c1] * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[c1] * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c1] * (-1.0) + PB_0 * PQ[a1] * PQ[b1] * QC_1 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[c1] * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[c1] * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[c1][d1] * (PB_0 * PQ[a1] * PQ[b1] * PQ[d0] * (-1.0) + PB_0 * PQ[a1] * PQ[b1] * QD_0 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[d0] * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * QD_0 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[c0][d1] * (PB_0 * PQ[a1] * PQ[b1] * PQ[d0] * (-1.0) + PB_0 * PQ[a1] * PQ[b1] * QD_0 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[d0] * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * QD_0 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[a0][d1] * delta[c0][c1] * (PB_0 * PQ[a1] * PQ[b1] * PQ[d0] * (-1.0) + PB_0 * PQ[a1] * PQ[b1] * QD_0 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[d0] * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * QD_0 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[a0][c0] * delta[c1][d0] * (PB_0 * PQ[a1] * PQ[b1] * PQ[d1] * (-1.0) + PB_0 * PQ[a1] * PQ[b1] * QD_1 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[d1] * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * QD_1 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[d1] * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[a0][c1] * delta[c0][d0] * (PB_0 * PQ[a1] * PQ[b1] * PQ[d1] * (-1.0) + PB_0 * PQ[a1] * PQ[b1] * QD_1 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[d1] * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * QD_1 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[d1] * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[a0][d0] * delta[c0][c1] * (PB_0 * PQ[a1] * PQ[b1] * PQ[d1] * (-1.0) + PB_0 * PQ[a1] * PQ[b1] * QD_1 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[d1] * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * QD_1 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[d1] * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PQ[a1] * PQ[c0] * PQ[c1] * (-1.0) + PB_0 * PQ[a1] * PQ[c0] * QC_1 * (-1.0) + PB_0 * PQ[a1] * PQ[c1] * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * PQ[c1] * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[c1] * QC_0 * (-1.0) + PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] + PQ[a1] * PQ[b0] * PQ[c0] * QC_1 + PQ[a1] * PQ[b0] * PQ[c1] * QC_0)
                            + delta[a0][b1] * delta[c1][d1] * (PB_0 * PQ[a1] * PQ[c0] * PQ[d0] * (-1.0) + PB_0 * PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[a1] * PQ[d0] * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * PQ[d0] * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PA_1 * PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] + PQ[a1] * PQ[b0] * PQ[c0] * QD_0 + PQ[a1] * PQ[b0] * PQ[d0] * QC_0)
                            + delta[a0][b1] * delta[c1][d0] * (PB_0 * PQ[a1] * PQ[c0] * PQ[d1] * (-1.0) + PB_0 * PQ[a1] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[a1] * PQ[d1] * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * PQ[d1] * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PA_1 * PQ[b0] * PQ[d1] * QC_0 * (-1.0) + PQ[a1] * PQ[b0] * PQ[c0] * PQ[d1] + PQ[a1] * PQ[b0] * PQ[c0] * QD_1 + PQ[a1] * PQ[b0] * PQ[d1] * QC_0)
                            + delta[a0][d0] * delta[b1][d1] * (PB_0 * PQ[a1] * PQ[c0] * QC_1 * (-1.0) + PB_0 * PQ[a1] * PQ[c1] * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b1][d0] * (PB_0 * PQ[a1] * PQ[c0] * QC_1 * (-1.0) + PB_0 * PQ[a1] * PQ[c1] * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b1][d1] * (PB_0 * PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[a1] * PQ[d0] * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PA_1 * PQ[b0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b1][c1] * (PB_0 * PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[a1] * PQ[d0] * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PA_1 * PQ[b0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b1][d0] * (PB_0 * PQ[a1] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[a1] * PQ[d1] * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PA_1 * PQ[b0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b1][c1] * (PB_0 * PQ[a1] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[a1] * PQ[d1] * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PA_1 * PQ[b0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * PQ[a1] * PQ[c1] * PQ[d0] * (-1.0) + PB_0 * PQ[a1] * PQ[c1] * QD_0 * (-1.0) + PB_0 * PQ[a1] * PQ[d0] * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[c1] * PQ[d0] * (-1.0) + PA_1 * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PA_1 * PQ[b0] * PQ[d0] * QC_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[c1] * PQ[d0] + PQ[a1] * PQ[b0] * PQ[c1] * QD_0 + PQ[a1] * PQ[b0] * PQ[d0] * QC_1)
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PQ[a1] * PQ[c1] * PQ[d1] * (-1.0) + PB_0 * PQ[a1] * PQ[c1] * QD_1 * (-1.0) + PB_0 * PQ[a1] * PQ[d1] * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[c1] * PQ[d1] * (-1.0) + PA_1 * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PA_1 * PQ[b0] * PQ[d1] * QC_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[c1] * PQ[d1] + PQ[a1] * PQ[b0] * PQ[c1] * QD_1 + PQ[a1] * PQ[b0] * PQ[d1] * QC_1)
                            + delta[a0][c0] * delta[b1][d1] * (PB_0 * PQ[a1] * PQ[c1] * QD_0 * (-1.0) + PB_0 * PQ[a1] * PQ[d0] * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PA_1 * PQ[b0] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[b1][c0] * (PB_0 * PQ[a1] * PQ[c1] * QD_0 * (-1.0) + PB_0 * PQ[a1] * PQ[d0] * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PA_1 * PQ[b0] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[b1][d0] * (PB_0 * PQ[a1] * PQ[c1] * QD_1 * (-1.0) + PB_0 * PQ[a1] * PQ[d1] * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PA_1 * PQ[b0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[b1][c0] * (PB_0 * PQ[a1] * PQ[c1] * QD_1 * (-1.0) + PB_0 * PQ[a1] * PQ[d1] * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PA_1 * PQ[b0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][b1] * delta[c0][c1] * (PB_0 * PQ[a1] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[a1] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[b0] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1] + PQ[a1] * PQ[b0] * PQ[d0] * QD_1 + PQ[a1] * PQ[b0] * PQ[d1] * QD_0)
                            + delta[a0][c0] * delta[b1][c1] * (PB_0 * PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[a1] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[b0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[b1][c0] * (PB_0 * PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[a1] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[b0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PQ[a1] * PQ[c0] * PQ[c1] * (-1.0) + PB_1 * PQ[a1] * PQ[c0] * QC_1 * (-1.0) + PB_1 * PQ[a1] * PQ[c1] * QC_0 * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * PQ[c1] * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PA_1 * PQ[b1] * PQ[c1] * QC_0 * (-1.0) + PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] + PQ[a1] * PQ[b1] * PQ[c0] * QC_1 + PQ[a1] * PQ[b1] * PQ[c1] * QC_0)
                            + delta[a0][b0] * delta[c1][d1] * (PB_1 * PQ[a1] * PQ[c0] * PQ[d0] * (-1.0) + PB_1 * PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[a1] * PQ[d0] * QC_0 * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PA_1 * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] + PQ[a1] * PQ[b1] * PQ[c0] * QD_0 + PQ[a1] * PQ[b1] * PQ[d0] * QC_0)
                            + delta[a0][b0] * delta[c1][d0] * (PB_1 * PQ[a1] * PQ[c0] * PQ[d1] * (-1.0) + PB_1 * PQ[a1] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[a1] * PQ[d1] * QC_0 * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * PQ[d1] * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PA_1 * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PQ[a1] * PQ[b1] * PQ[c0] * PQ[d1] + PQ[a1] * PQ[b1] * PQ[c0] * QD_1 + PQ[a1] * PQ[b1] * PQ[d1] * QC_0)
                            + delta[a0][d0] * delta[b0][d1] * (PB_1 * PQ[a1] * PQ[c0] * QC_1 * (-1.0) + PB_1 * PQ[a1] * PQ[c1] * QC_0 * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PA_1 * PQ[b1] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * (PB_1 * PQ[a1] * PQ[c0] * QC_1 * (-1.0) + PB_1 * PQ[a1] * PQ[c1] * QC_0 * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PA_1 * PQ[b1] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][d1] * (PB_1 * PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[a1] * PQ[d0] * QC_0 * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PA_1 * PQ[b1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][c1] * (PB_1 * PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[a1] * PQ[d0] * QC_0 * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PA_1 * PQ[b1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][d0] * (PB_1 * PQ[a1] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[a1] * PQ[d1] * QC_0 * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PA_1 * PQ[b1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b0][c1] * (PB_1 * PQ[a1] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[a1] * PQ[d1] * QC_0 * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PA_1 * PQ[b1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * PQ[a1] * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PQ[a1] * PQ[c1] * QD_0 * (-1.0) + PB_1 * PQ[a1] * PQ[d0] * QC_1 * (-1.0) + PA_1 * PQ[b1] * PQ[c1] * PQ[d0] * (-1.0) + PA_1 * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PA_1 * PQ[b1] * PQ[d0] * QC_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[c1] * PQ[d0] + PQ[a1] * PQ[b1] * PQ[c1] * QD_0 + PQ[a1] * PQ[b1] * PQ[d0] * QC_1)
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PQ[a1] * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PQ[a1] * PQ[c1] * QD_1 * (-1.0) + PB_1 * PQ[a1] * PQ[d1] * QC_1 * (-1.0) + PA_1 * PQ[b1] * PQ[c1] * PQ[d1] * (-1.0) + PA_1 * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PA_1 * PQ[b1] * PQ[d1] * QC_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[c1] * PQ[d1] + PQ[a1] * PQ[b1] * PQ[c1] * QD_1 + PQ[a1] * PQ[b1] * PQ[d1] * QC_1)
                            + delta[a0][c0] * delta[b0][d1] * (PB_1 * PQ[a1] * PQ[c1] * QD_0 * (-1.0) + PB_1 * PQ[a1] * PQ[d0] * QC_1 * (-1.0) + PA_1 * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PA_1 * PQ[b1] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[b0][c0] * (PB_1 * PQ[a1] * PQ[c1] * QD_0 * (-1.0) + PB_1 * PQ[a1] * PQ[d0] * QC_1 * (-1.0) + PA_1 * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PA_1 * PQ[b1] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[b0][d0] * (PB_1 * PQ[a1] * PQ[c1] * QD_1 * (-1.0) + PB_1 * PQ[a1] * PQ[d1] * QC_1 * (-1.0) + PA_1 * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PA_1 * PQ[b1] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][c0] * (PB_1 * PQ[a1] * PQ[c1] * QD_1 * (-1.0) + PB_1 * PQ[a1] * PQ[d1] * QC_1 * (-1.0) + PA_1 * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PA_1 * PQ[b1] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[c0][c1] * (PB_1 * PQ[a1] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[a1] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1] + PQ[a1] * PQ[b1] * PQ[d0] * QD_1 + PQ[a1] * PQ[b1] * PQ[d1] * QD_0)
                            + delta[a0][c0] * delta[b0][c1] * (PB_1 * PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[a1] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[b1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][c0] * (PB_1 * PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[a1] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[b1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * (PA_1 * PQ[c0] * PQ[c1] * QD_0 * (-1.0) + PA_1 * PQ[c0] * PQ[d0] * QC_1 * (-1.0) + PA_1 * PQ[c1] * PQ[d0] * QC_0 * (-1.0) + PQ[a1] * PQ[c0] * PQ[c1] * QD_0 + PQ[a1] * PQ[c0] * PQ[d0] * QC_1 + PQ[a1] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a0][b0] * delta[b1][d1] * (PA_1 * PQ[c0] * PQ[c1] * QD_0 * (-1.0) + PA_1 * PQ[c0] * PQ[d0] * QC_1 * (-1.0) + PA_1 * PQ[c1] * PQ[d0] * QC_0 * (-1.0) + PQ[a1] * PQ[c0] * PQ[c1] * QD_0 + PQ[a1] * PQ[c0] * PQ[d0] * QC_1 + PQ[a1] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[b0][d1] * delta[a0][b1] * (PA_1 * PQ[c0] * PQ[c1] * QD_0 * (-1.0) + PA_1 * PQ[c0] * PQ[d0] * QC_1 * (-1.0) + PA_1 * PQ[c1] * PQ[d0] * QC_0 * (-1.0) + PQ[a1] * PQ[c0] * PQ[c1] * QD_0 + PQ[a1] * PQ[c0] * PQ[d0] * QC_1 + PQ[a1] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a0][d0] * delta[b0][b1] * (PA_1 * PQ[c0] * PQ[c1] * QD_1 * (-1.0) + PA_1 * PQ[c0] * PQ[d1] * QC_1 * (-1.0) + PA_1 * PQ[c1] * PQ[d1] * QC_0 * (-1.0) + PQ[a1] * PQ[c0] * PQ[c1] * QD_1 + PQ[a1] * PQ[c0] * PQ[d1] * QC_1 + PQ[a1] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a0][b0] * delta[b1][d0] * (PA_1 * PQ[c0] * PQ[c1] * QD_1 * (-1.0) + PA_1 * PQ[c0] * PQ[d1] * QC_1 * (-1.0) + PA_1 * PQ[c1] * PQ[d1] * QC_0 * (-1.0) + PQ[a1] * PQ[c0] * PQ[c1] * QD_1 + PQ[a1] * PQ[c0] * PQ[d1] * QC_1 + PQ[a1] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[b0][d0] * delta[a0][b1] * (PA_1 * PQ[c0] * PQ[c1] * QD_1 * (-1.0) + PA_1 * PQ[c0] * PQ[d1] * QC_1 * (-1.0) + PA_1 * PQ[c1] * PQ[d1] * QC_0 * (-1.0) + PQ[a1] * PQ[c0] * PQ[c1] * QD_1 + PQ[a1] * PQ[c0] * PQ[d1] * QC_1 + PQ[a1] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a0][c1] * delta[b0][b1] * (PA_1 * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PQ[a1] * PQ[c0] * PQ[d0] * QD_1 + PQ[a1] * PQ[c0] * PQ[d1] * QD_0 + PQ[a1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][b0] * delta[b1][c1] * (PA_1 * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PQ[a1] * PQ[c0] * PQ[d0] * QD_1 + PQ[a1] * PQ[c0] * PQ[d1] * QD_0 + PQ[a1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[b0][c1] * delta[a0][b1] * (PA_1 * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PQ[a1] * PQ[c0] * PQ[d0] * QD_1 + PQ[a1] * PQ[c0] * PQ[d1] * QD_0 + PQ[a1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][c0] * delta[b0][b1] * (PA_1 * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[a1] * PQ[c1] * PQ[d0] * QD_1 + PQ[a1] * PQ[c1] * PQ[d1] * QD_0 + PQ[a1] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a0][b0] * delta[b1][c0] * (PA_1 * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[a1] * PQ[c1] * PQ[d0] * QD_1 + PQ[a1] * PQ[c1] * PQ[d1] * QD_0 + PQ[a1] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[b0][c0] * delta[a0][b1] * (PA_1 * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[a1] * PQ[c1] * PQ[d0] * QD_1 + PQ[a1] * PQ[c1] * PQ[d1] * QD_0 + PQ[a1] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a0][a1] * delta[d0][d1] * (PB_0 * PQ[b1] * PQ[c0] * PQ[c1] * (-1.0) + PB_0 * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PB_0 * PQ[b1] * PQ[c1] * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * PQ[c1] * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * QC_0 * (-1.0) + PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] + PQ[b0] * PQ[b1] * PQ[c0] * QC_1 + PQ[b0] * PQ[b1] * PQ[c1] * QC_0)
                            + delta[a0][a1] * delta[c1][d1] * (PB_0 * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0) + PB_0 * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * PQ[d0] * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] + PQ[b0] * PQ[b1] * PQ[c0] * QD_0 + PQ[b0] * PQ[b1] * PQ[d0] * QC_0)
                            + delta[a0][a1] * delta[c1][d0] * (PB_0 * PQ[b1] * PQ[c0] * PQ[d1] * (-1.0) + PB_0 * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * PQ[d1] * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * QC_0 * (-1.0) + PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] + PQ[b0] * PQ[b1] * PQ[c0] * QD_1 + PQ[b0] * PQ[b1] * PQ[d1] * QC_0)
                            + delta[a0][d0] * delta[a1][d1] * (PB_0 * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PB_0 * PQ[b1] * PQ[c1] * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][d0] * (PB_0 * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PB_0 * PQ[b1] * PQ[c1] * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[a1][d1] * (PB_0 * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][c1] * (PB_0 * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[a1][d0] * (PB_0 * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[a1][c1] * (PB_0 * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[c0][d1] * (PB_0 * PQ[b1] * PQ[c1] * PQ[d0] * (-1.0) + PB_0 * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PB_0 * PQ[b1] * PQ[d0] * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * QC_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] + PQ[b0] * PQ[b1] * PQ[c1] * QD_0 + PQ[b0] * PQ[b1] * PQ[d0] * QC_1)
                            + delta[a0][a1] * delta[c0][d0] * (PB_0 * PQ[b1] * PQ[c1] * PQ[d1] * (-1.0) + PB_0 * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PB_0 * PQ[b1] * PQ[d1] * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * QC_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] + PQ[b0] * PQ[b1] * PQ[c1] * QD_1 + PQ[b0] * PQ[b1] * PQ[d1] * QC_1)
                            + delta[a0][c0] * delta[a1][d1] * (PB_0 * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PB_0 * PQ[b1] * PQ[d0] * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[a1][c0] * (PB_0 * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PB_0 * PQ[b1] * PQ[d0] * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[a1][d0] * (PB_0 * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PB_0 * PQ[b1] * PQ[d1] * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][c0] * (PB_0 * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PB_0 * PQ[b1] * PQ[d1] * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[c0][c1] * (PB_0 * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] + PQ[b0] * PQ[b1] * PQ[d0] * QD_1 + PQ[b0] * PQ[b1] * PQ[d1] * QD_0)
                            + delta[a0][c0] * delta[a1][c1] * (PB_0 * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[a1][c0] * (PB_0 * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][b1] * (PB_0 * PQ[c0] * PQ[c1] * QD_0 * (-1.0) + PB_0 * PQ[c0] * PQ[d0] * QC_1 * (-1.0) + PB_0 * PQ[c1] * PQ[d0] * QC_0 * (-1.0) + PQ[b0] * PQ[c0] * PQ[c1] * QD_0 + PQ[b0] * PQ[c0] * PQ[d0] * QC_1 + PQ[b0] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a0][a1] * delta[b1][d1] * (PB_0 * PQ[c0] * PQ[c1] * QD_0 * (-1.0) + PB_0 * PQ[c0] * PQ[d0] * QC_1 * (-1.0) + PB_0 * PQ[c1] * PQ[d0] * QC_0 * (-1.0) + PQ[b0] * PQ[c0] * PQ[c1] * QD_0 + PQ[b0] * PQ[c0] * PQ[d0] * QC_1 + PQ[b0] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a1][d1] * delta[a0][b1] * (PB_0 * PQ[c0] * PQ[c1] * QD_0 * (-1.0) + PB_0 * PQ[c0] * PQ[d0] * QC_1 * (-1.0) + PB_0 * PQ[c1] * PQ[d0] * QC_0 * (-1.0) + PQ[b0] * PQ[c0] * PQ[c1] * QD_0 + PQ[b0] * PQ[c0] * PQ[d0] * QC_1 + PQ[b0] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a0][d0] * delta[a1][b1] * (PB_0 * PQ[c0] * PQ[c1] * QD_1 * (-1.0) + PB_0 * PQ[c0] * PQ[d1] * QC_1 * (-1.0) + PB_0 * PQ[c1] * PQ[d1] * QC_0 * (-1.0) + PQ[b0] * PQ[c0] * PQ[c1] * QD_1 + PQ[b0] * PQ[c0] * PQ[d1] * QC_1 + PQ[b0] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a0][a1] * delta[b1][d0] * (PB_0 * PQ[c0] * PQ[c1] * QD_1 * (-1.0) + PB_0 * PQ[c0] * PQ[d1] * QC_1 * (-1.0) + PB_0 * PQ[c1] * PQ[d1] * QC_0 * (-1.0) + PQ[b0] * PQ[c0] * PQ[c1] * QD_1 + PQ[b0] * PQ[c0] * PQ[d1] * QC_1 + PQ[b0] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a1][d0] * delta[a0][b1] * (PB_0 * PQ[c0] * PQ[c1] * QD_1 * (-1.0) + PB_0 * PQ[c0] * PQ[d1] * QC_1 * (-1.0) + PB_0 * PQ[c1] * PQ[d1] * QC_0 * (-1.0) + PQ[b0] * PQ[c0] * PQ[c1] * QD_1 + PQ[b0] * PQ[c0] * PQ[d1] * QC_1 + PQ[b0] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a0][c1] * delta[a1][b1] * (PB_0 * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PQ[b0] * PQ[c0] * PQ[d0] * QD_1 + PQ[b0] * PQ[c0] * PQ[d1] * QD_0 + PQ[b0] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][a1] * delta[b1][c1] * (PB_0 * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PQ[b0] * PQ[c0] * PQ[d0] * QD_1 + PQ[b0] * PQ[c0] * PQ[d1] * QD_0 + PQ[b0] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a1][c1] * delta[a0][b1] * (PB_0 * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PQ[b0] * PQ[c0] * PQ[d0] * QD_1 + PQ[b0] * PQ[c0] * PQ[d1] * QD_0 + PQ[b0] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][c0] * delta[a1][b1] * (PB_0 * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * PQ[d0] * QD_1 + PQ[b0] * PQ[c1] * PQ[d1] * QD_0 + PQ[b0] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a0][a1] * delta[b1][c0] * (PB_0 * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * PQ[d0] * QD_1 + PQ[b0] * PQ[c1] * PQ[d1] * QD_0 + PQ[b0] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a1][c0] * delta[a0][b1] * (PB_0 * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * PQ[d0] * QD_1 + PQ[b0] * PQ[c1] * PQ[d1] * QD_0 + PQ[b0] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a0][d1] * delta[a1][b0] * (PB_1 * PQ[c0] * PQ[c1] * QD_0 * (-1.0) + PB_1 * PQ[c0] * PQ[d0] * QC_1 * (-1.0) + PB_1 * PQ[c1] * PQ[d0] * QC_0 * (-1.0) + PQ[b1] * PQ[c0] * PQ[c1] * QD_0 + PQ[b1] * PQ[c0] * PQ[d0] * QC_1 + PQ[b1] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a0][a1] * delta[b0][d1] * (PB_1 * PQ[c0] * PQ[c1] * QD_0 * (-1.0) + PB_1 * PQ[c0] * PQ[d0] * QC_1 * (-1.0) + PB_1 * PQ[c1] * PQ[d0] * QC_0 * (-1.0) + PQ[b1] * PQ[c0] * PQ[c1] * QD_0 + PQ[b1] * PQ[c0] * PQ[d0] * QC_1 + PQ[b1] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a1][d1] * delta[a0][b0] * (PB_1 * PQ[c0] * PQ[c1] * QD_0 * (-1.0) + PB_1 * PQ[c0] * PQ[d0] * QC_1 * (-1.0) + PB_1 * PQ[c1] * PQ[d0] * QC_0 * (-1.0) + PQ[b1] * PQ[c0] * PQ[c1] * QD_0 + PQ[b1] * PQ[c0] * PQ[d0] * QC_1 + PQ[b1] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a0][d0] * delta[a1][b0] * (PB_1 * PQ[c0] * PQ[c1] * QD_1 * (-1.0) + PB_1 * PQ[c0] * PQ[d1] * QC_1 * (-1.0) + PB_1 * PQ[c1] * PQ[d1] * QC_0 * (-1.0) + PQ[b1] * PQ[c0] * PQ[c1] * QD_1 + PQ[b1] * PQ[c0] * PQ[d1] * QC_1 + PQ[b1] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a0][a1] * delta[b0][d0] * (PB_1 * PQ[c0] * PQ[c1] * QD_1 * (-1.0) + PB_1 * PQ[c0] * PQ[d1] * QC_1 * (-1.0) + PB_1 * PQ[c1] * PQ[d1] * QC_0 * (-1.0) + PQ[b1] * PQ[c0] * PQ[c1] * QD_1 + PQ[b1] * PQ[c0] * PQ[d1] * QC_1 + PQ[b1] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a1][d0] * delta[a0][b0] * (PB_1 * PQ[c0] * PQ[c1] * QD_1 * (-1.0) + PB_1 * PQ[c0] * PQ[d1] * QC_1 * (-1.0) + PB_1 * PQ[c1] * PQ[d1] * QC_0 * (-1.0) + PQ[b1] * PQ[c0] * PQ[c1] * QD_1 + PQ[b1] * PQ[c0] * PQ[d1] * QC_1 + PQ[b1] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a0][c1] * delta[a1][b0] * (PB_1 * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PQ[b1] * PQ[c0] * PQ[d0] * QD_1 + PQ[b1] * PQ[c0] * PQ[d1] * QD_0 + PQ[b1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][a1] * delta[b0][c1] * (PB_1 * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PQ[b1] * PQ[c0] * PQ[d0] * QD_1 + PQ[b1] * PQ[c0] * PQ[d1] * QD_0 + PQ[b1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a1][c1] * delta[a0][b0] * (PB_1 * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PQ[b1] * PQ[c0] * PQ[d0] * QD_1 + PQ[b1] * PQ[c0] * PQ[d1] * QD_0 + PQ[b1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][c0] * delta[a1][b0] * (PB_1 * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[b1] * PQ[c1] * PQ[d0] * QD_1 + PQ[b1] * PQ[c1] * PQ[d1] * QD_0 + PQ[b1] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a0][a1] * delta[b0][c0] * (PB_1 * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[b1] * PQ[c1] * PQ[d0] * QD_1 + PQ[b1] * PQ[c1] * PQ[d1] * QD_0 + PQ[b1] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a1][c0] * delta[a0][b0] * (PB_1 * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[b1] * PQ[c1] * PQ[d0] * QD_1 + PQ[b1] * PQ[c1] * PQ[d1] * QD_0 + PQ[b1] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a0][a1] * delta[b0][b1] * (PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * 2.0 + PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * 2.0 + PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * 2.0 + PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * 2.0)
                            + delta[a0][b0] * delta[a1][b1] * (PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * 2.0 + PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * 2.0 + PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * 2.0 + PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * 2.0)
                            + delta[a1][b0] * delta[a0][b1] * (PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * 2.0 + PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * 2.0 + PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * 2.0 + PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * 2.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD29(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[5];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[4] * (

                        0.25 * ( S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[b1][c1] * delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * QC_0)
                            + delta[b1][d0] * delta[c1][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * QC_0)
                            + delta[b1][d1] * delta[c1][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * QC_0)
                            + delta[b1][c0] * delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * QC_1)
                            + delta[b1][d0] * delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * QC_1)
                            + delta[b1][d1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * QC_1)
                            + delta[b0][c1] * delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * QC_0)
                            + delta[b0][d0] * delta[c1][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * QC_0)
                            + delta[b0][d1] * delta[c1][d0] * (PQ[a0] * PQ[a1] * PQ[b1] * QC_0)
                            + delta[b0][c0] * delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * QC_1)
                            + delta[b0][d0] * delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * QC_1)
                            + delta[b0][d1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[b1] * QC_1)
                            + delta[b0][b1] * delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[c0] * QC_1 + PQ[a0] * PQ[a1] * PQ[c1] * QC_0 + PQ[a0] * PQ[a1] * QC_0 * QC_1)
                            + delta[b0][b1] * delta[c1][d1] * (PQ[a0] * PQ[a1] * PQ[c0] * QD_0 + PQ[a0] * PQ[a1] * PQ[d0] * QC_0 + PQ[a0] * PQ[a1] * QD_0 * QC_0)
                            + delta[b0][b1] * delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[c1] * QD_0 + PQ[a0] * PQ[a1] * PQ[d0] * QC_1 + PQ[a0] * PQ[a1] * QD_0 * QC_1)
                            + delta[b0][b1] * delta[c1][d0] * (PQ[a0] * PQ[a1] * PQ[c0] * QD_1 + PQ[a0] * PQ[a1] * PQ[d1] * QC_0 + PQ[a0] * PQ[a1] * QD_1 * QC_0)
                            + delta[b0][b1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[c1] * QD_1 + PQ[a0] * PQ[a1] * PQ[d1] * QC_1 + PQ[a0] * PQ[a1] * QD_1 * QC_1)
                            + delta[b0][d0] * delta[b1][d1] * (PQ[a0] * PQ[a1] * QC_0 * QC_1)
                            + delta[b0][d1] * delta[b1][d0] * (PQ[a0] * PQ[a1] * QC_0 * QC_1)
                            + delta[b0][c1] * delta[b1][d1] * (PQ[a0] * PQ[a1] * QD_0 * QC_0)
                            + delta[b0][d1] * delta[b1][c1] * (PQ[a0] * PQ[a1] * QD_0 * QC_0)
                            + delta[b0][c1] * delta[b1][d0] * (PQ[a0] * PQ[a1] * QD_1 * QC_0)
                            + delta[b0][d0] * delta[b1][c1] * (PQ[a0] * PQ[a1] * QD_1 * QC_0)
                            + delta[b0][c0] * delta[b1][d1] * (PQ[a0] * PQ[a1] * QD_0 * QC_1)
                            + delta[b0][d1] * delta[b1][c0] * (PQ[a0] * PQ[a1] * QD_0 * QC_1)
                            + delta[b0][c0] * delta[b1][d0] * (PQ[a0] * PQ[a1] * QD_1 * QC_1)
                            + delta[b0][d0] * delta[b1][c0] * (PQ[a0] * PQ[a1] * QD_1 * QC_1)
                            + delta[a1][c1] * delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * QC_0)
                            + delta[a1][d0] * delta[c1][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * QC_0)
                            + delta[a1][d1] * delta[c1][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * QC_0)
                            + delta[a1][c0] * delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * QC_1)
                            + delta[a1][d0] * delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * QC_1)
                            + delta[a1][d1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * QC_1)
                            + delta[a1][b1] * delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * QC_1 + PQ[a0] * PQ[b0] * PQ[c1] * QC_0 + PQ[a0] * PQ[b0] * QC_0 * QC_1)
                            + delta[a1][b1] * delta[c1][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * QD_0 + PQ[a0] * PQ[b0] * PQ[d0] * QC_0 + PQ[a0] * PQ[b0] * QD_0 * QC_0)
                            + delta[a1][b1] * delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[c1] * QD_0 + PQ[a0] * PQ[b0] * PQ[d0] * QC_1 + PQ[a0] * PQ[b0] * QD_0 * QC_1)
                            + delta[a1][b1] * delta[c1][d0] * (PQ[a0] * PQ[b0] * PQ[c0] * QD_1 + PQ[a0] * PQ[b0] * PQ[d1] * QC_0 + PQ[a0] * PQ[b0] * QD_1 * QC_0)
                            + delta[a1][b1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[c1] * QD_1 + PQ[a0] * PQ[b0] * PQ[d1] * QC_1 + PQ[a0] * PQ[b0] * QD_1 * QC_1)
                            + delta[a1][d0] * delta[b1][d1] * (PQ[a0] * PQ[b0] * QC_0 * QC_1)
                            + delta[a1][d1] * delta[b1][d0] * (PQ[a0] * PQ[b0] * QC_0 * QC_1)
                            + delta[a1][c1] * delta[b1][d1] * (PQ[a0] * PQ[b0] * QD_0 * QC_0)
                            + delta[a1][d1] * delta[b1][c1] * (PQ[a0] * PQ[b0] * QD_0 * QC_0)
                            + delta[a1][c1] * delta[b1][d0] * (PQ[a0] * PQ[b0] * QD_1 * QC_0)
                            + delta[a1][d0] * delta[b1][c1] * (PQ[a0] * PQ[b0] * QD_1 * QC_0)
                            + delta[a1][c0] * delta[b1][d1] * (PQ[a0] * PQ[b0] * QD_0 * QC_1)
                            + delta[a1][d1] * delta[b1][c0] * (PQ[a0] * PQ[b0] * QD_0 * QC_1)
                            + delta[a1][c0] * delta[b1][d0] * (PQ[a0] * PQ[b0] * QD_1 * QC_1)
                            + delta[a1][d0] * delta[b1][c0] * (PQ[a0] * PQ[b0] * QD_1 * QC_1)
                            + delta[a1][b0] * delta[d0][d1] * (PQ[a0] * PQ[b1] * PQ[c0] * QC_1 + PQ[a0] * PQ[b1] * PQ[c1] * QC_0 + PQ[a0] * PQ[b1] * QC_0 * QC_1)
                            + delta[a1][b0] * delta[c1][d1] * (PQ[a0] * PQ[b1] * PQ[c0] * QD_0 + PQ[a0] * PQ[b1] * PQ[d0] * QC_0 + PQ[a0] * PQ[b1] * QD_0 * QC_0)
                            + delta[a1][b0] * delta[c0][d1] * (PQ[a0] * PQ[b1] * PQ[c1] * QD_0 + PQ[a0] * PQ[b1] * PQ[d0] * QC_1 + PQ[a0] * PQ[b1] * QD_0 * QC_1)
                            + delta[a1][b0] * delta[c1][d0] * (PQ[a0] * PQ[b1] * PQ[c0] * QD_1 + PQ[a0] * PQ[b1] * PQ[d1] * QC_0 + PQ[a0] * PQ[b1] * QD_1 * QC_0)
                            + delta[a1][b0] * delta[c0][d0] * (PQ[a0] * PQ[b1] * PQ[c1] * QD_1 + PQ[a0] * PQ[b1] * PQ[d1] * QC_1 + PQ[a0] * PQ[b1] * QD_1 * QC_1)
                            + delta[a1][d0] * delta[b0][d1] * (PQ[a0] * PQ[b1] * QC_0 * QC_1)
                            + delta[a1][d1] * delta[b0][d0] * (PQ[a0] * PQ[b1] * QC_0 * QC_1)
                            + delta[a1][c1] * delta[b0][d1] * (PQ[a0] * PQ[b1] * QD_0 * QC_0)
                            + delta[a1][d1] * delta[b0][c1] * (PQ[a0] * PQ[b1] * QD_0 * QC_0)
                            + delta[a1][c1] * delta[b0][d0] * (PQ[a0] * PQ[b1] * QD_1 * QC_0)
                            + delta[a1][d0] * delta[b0][c1] * (PQ[a0] * PQ[b1] * QD_1 * QC_0)
                            + delta[a1][c0] * delta[b0][d1] * (PQ[a0] * PQ[b1] * QD_0 * QC_1)
                            + delta[a1][d1] * delta[b0][c0] * (PQ[a0] * PQ[b1] * QD_0 * QC_1)
                            + delta[a1][c0] * delta[b0][d0] * (PQ[a0] * PQ[b1] * QD_1 * QC_1)
                            + delta[a1][d0] * delta[b0][c0] * (PQ[a0] * PQ[b1] * QD_1 * QC_1)
                            + delta[a1][d1] * delta[b0][b1] * (PQ[a0] * PQ[c0] * QD_0 * QC_1 + PQ[a0] * PQ[c1] * QD_0 * QC_0 + PQ[a0] * PQ[d0] * QC_0 * QC_1)
                            + delta[a1][b0] * delta[b1][d1] * (PQ[a0] * PQ[c0] * QD_0 * QC_1 + PQ[a0] * PQ[c1] * QD_0 * QC_0 + PQ[a0] * PQ[d0] * QC_0 * QC_1)
                            + delta[b0][d1] * delta[a1][b1] * (PQ[a0] * PQ[c0] * QD_0 * QC_1 + PQ[a0] * PQ[c1] * QD_0 * QC_0 + PQ[a0] * PQ[d0] * QC_0 * QC_1)
                            + delta[a1][d0] * delta[b0][b1] * (PQ[a0] * PQ[c0] * QD_1 * QC_1 + PQ[a0] * PQ[c1] * QD_1 * QC_0 + PQ[a0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a1][b0] * delta[b1][d0] * (PQ[a0] * PQ[c0] * QD_1 * QC_1 + PQ[a0] * PQ[c1] * QD_1 * QC_0 + PQ[a0] * PQ[d1] * QC_0 * QC_1)
                            + delta[b0][d0] * delta[a1][b1] * (PQ[a0] * PQ[c0] * QD_1 * QC_1 + PQ[a0] * PQ[c1] * QD_1 * QC_0 + PQ[a0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a1][c1] * delta[b0][b1] * (PQ[a0] * PQ[c0] * QD_0 * QD_1 + PQ[a0] * PQ[d0] * QD_1 * QC_0 + PQ[a0] * PQ[d1] * QD_0 * QC_0)
                            + delta[a1][b0] * delta[b1][c1] * (PQ[a0] * PQ[c0] * QD_0 * QD_1 + PQ[a0] * PQ[d0] * QD_1 * QC_0 + PQ[a0] * PQ[d1] * QD_0 * QC_0)
                            + delta[b0][c1] * delta[a1][b1] * (PQ[a0] * PQ[c0] * QD_0 * QD_1 + PQ[a0] * PQ[d0] * QD_1 * QC_0 + PQ[a0] * PQ[d1] * QD_0 * QC_0)
                            + delta[a1][c0] * delta[b0][b1] * (PQ[a0] * PQ[c1] * QD_0 * QD_1 + PQ[a0] * PQ[d0] * QD_1 * QC_1 + PQ[a0] * PQ[d1] * QD_0 * QC_1)
                            + delta[a1][b0] * delta[b1][c0] * (PQ[a0] * PQ[c1] * QD_0 * QD_1 + PQ[a0] * PQ[d0] * QD_1 * QC_1 + PQ[a0] * PQ[d1] * QD_0 * QC_1)
                            + delta[b0][c0] * delta[a1][b1] * (PQ[a0] * PQ[c1] * QD_0 * QD_1 + PQ[a0] * PQ[d0] * QD_1 * QC_1 + PQ[a0] * PQ[d1] * QD_0 * QC_1)
                            + delta[a0][c1] * delta[d0][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * QC_0)
                            + delta[a0][d0] * delta[c1][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * QC_0)
                            + delta[a0][d1] * delta[c1][d0] * (PQ[a1] * PQ[b0] * PQ[b1] * QC_0)
                            + delta[a0][c0] * delta[d0][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * QC_1)
                            + delta[a0][d0] * delta[c0][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * QC_1)
                            + delta[a0][d1] * delta[c0][d0] * (PQ[a1] * PQ[b0] * PQ[b1] * QC_1)
                            + delta[a0][b1] * delta[d0][d1] * (PQ[a1] * PQ[b0] * PQ[c0] * QC_1 + PQ[a1] * PQ[b0] * PQ[c1] * QC_0 + PQ[a1] * PQ[b0] * QC_0 * QC_1)
                            + delta[a0][b1] * delta[c1][d1] * (PQ[a1] * PQ[b0] * PQ[c0] * QD_0 + PQ[a1] * PQ[b0] * PQ[d0] * QC_0 + PQ[a1] * PQ[b0] * QD_0 * QC_0)
                            + delta[a0][b1] * delta[c0][d1] * (PQ[a1] * PQ[b0] * PQ[c1] * QD_0 + PQ[a1] * PQ[b0] * PQ[d0] * QC_1 + PQ[a1] * PQ[b0] * QD_0 * QC_1)
                            + delta[a0][b1] * delta[c1][d0] * (PQ[a1] * PQ[b0] * PQ[c0] * QD_1 + PQ[a1] * PQ[b0] * PQ[d1] * QC_0 + PQ[a1] * PQ[b0] * QD_1 * QC_0)
                            + delta[a0][b1] * delta[c0][d0] * (PQ[a1] * PQ[b0] * PQ[c1] * QD_1 + PQ[a1] * PQ[b0] * PQ[d1] * QC_1 + PQ[a1] * PQ[b0] * QD_1 * QC_1)
                            + delta[a0][d0] * delta[b1][d1] * (PQ[a1] * PQ[b0] * QC_0 * QC_1)
                            + delta[a0][d1] * delta[b1][d0] * (PQ[a1] * PQ[b0] * QC_0 * QC_1)
                            + delta[a0][c1] * delta[b1][d1] * (PQ[a1] * PQ[b0] * QD_0 * QC_0)
                            + delta[a0][d1] * delta[b1][c1] * (PQ[a1] * PQ[b0] * QD_0 * QC_0)
                            + delta[a0][c1] * delta[b1][d0] * (PQ[a1] * PQ[b0] * QD_1 * QC_0)
                            + delta[a0][d0] * delta[b1][c1] * (PQ[a1] * PQ[b0] * QD_1 * QC_0)
                            + delta[a0][c0] * delta[b1][d1] * (PQ[a1] * PQ[b0] * QD_0 * QC_1)
                            + delta[a0][d1] * delta[b1][c0] * (PQ[a1] * PQ[b0] * QD_0 * QC_1)
                            + delta[a0][c0] * delta[b1][d0] * (PQ[a1] * PQ[b0] * QD_1 * QC_1)
                            + delta[a0][d0] * delta[b1][c0] * (PQ[a1] * PQ[b0] * QD_1 * QC_1)
                            + delta[a0][b0] * delta[d0][d1] * (PQ[a1] * PQ[b1] * PQ[c0] * QC_1 + PQ[a1] * PQ[b1] * PQ[c1] * QC_0 + PQ[a1] * PQ[b1] * QC_0 * QC_1)
                            + delta[a0][b0] * delta[c1][d1] * (PQ[a1] * PQ[b1] * PQ[c0] * QD_0 + PQ[a1] * PQ[b1] * PQ[d0] * QC_0 + PQ[a1] * PQ[b1] * QD_0 * QC_0)
                            + delta[a0][b0] * delta[c0][d1] * (PQ[a1] * PQ[b1] * PQ[c1] * QD_0 + PQ[a1] * PQ[b1] * PQ[d0] * QC_1 + PQ[a1] * PQ[b1] * QD_0 * QC_1)
                            + delta[a0][b0] * delta[c1][d0] * (PQ[a1] * PQ[b1] * PQ[c0] * QD_1 + PQ[a1] * PQ[b1] * PQ[d1] * QC_0 + PQ[a1] * PQ[b1] * QD_1 * QC_0)
                            + delta[a0][b0] * delta[c0][d0] * (PQ[a1] * PQ[b1] * PQ[c1] * QD_1 + PQ[a1] * PQ[b1] * PQ[d1] * QC_1 + PQ[a1] * PQ[b1] * QD_1 * QC_1)
                            + delta[a0][d0] * delta[b0][d1] * (PQ[a1] * PQ[b1] * QC_0 * QC_1)
                            + delta[a0][d1] * delta[b0][d0] * (PQ[a1] * PQ[b1] * QC_0 * QC_1)
                            + delta[a0][c1] * delta[b0][d1] * (PQ[a1] * PQ[b1] * QD_0 * QC_0)
                            + delta[a0][d1] * delta[b0][c1] * (PQ[a1] * PQ[b1] * QD_0 * QC_0)
                            + delta[a0][c1] * delta[b0][d0] * (PQ[a1] * PQ[b1] * QD_1 * QC_0)
                            + delta[a0][d0] * delta[b0][c1] * (PQ[a1] * PQ[b1] * QD_1 * QC_0)
                            + delta[a0][c0] * delta[b0][d1] * (PQ[a1] * PQ[b1] * QD_0 * QC_1)
                            + delta[a0][d1] * delta[b0][c0] * (PQ[a1] * PQ[b1] * QD_0 * QC_1)
                            + delta[a0][c0] * delta[b0][d0] * (PQ[a1] * PQ[b1] * QD_1 * QC_1)
                            + delta[a0][d0] * delta[b0][c0] * (PQ[a1] * PQ[b1] * QD_1 * QC_1)
                            + delta[a0][d1] * delta[b0][b1] * (PQ[a1] * PQ[c0] * QD_0 * QC_1 + PQ[a1] * PQ[c1] * QD_0 * QC_0 + PQ[a1] * PQ[d0] * QC_0 * QC_1)
                            + delta[a0][b0] * delta[b1][d1] * (PQ[a1] * PQ[c0] * QD_0 * QC_1 + PQ[a1] * PQ[c1] * QD_0 * QC_0 + PQ[a1] * PQ[d0] * QC_0 * QC_1)
                            + delta[b0][d1] * delta[a0][b1] * (PQ[a1] * PQ[c0] * QD_0 * QC_1 + PQ[a1] * PQ[c1] * QD_0 * QC_0 + PQ[a1] * PQ[d0] * QC_0 * QC_1)
                            + delta[a0][d0] * delta[b0][b1] * (PQ[a1] * PQ[c0] * QD_1 * QC_1 + PQ[a1] * PQ[c1] * QD_1 * QC_0 + PQ[a1] * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][b0] * delta[b1][d0] * (PQ[a1] * PQ[c0] * QD_1 * QC_1 + PQ[a1] * PQ[c1] * QD_1 * QC_0 + PQ[a1] * PQ[d1] * QC_0 * QC_1)
                            + delta[b0][d0] * delta[a0][b1] * (PQ[a1] * PQ[c0] * QD_1 * QC_1 + PQ[a1] * PQ[c1] * QD_1 * QC_0 + PQ[a1] * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][c1] * delta[b0][b1] * (PQ[a1] * PQ[c0] * QD_0 * QD_1 + PQ[a1] * PQ[d0] * QD_1 * QC_0 + PQ[a1] * PQ[d1] * QD_0 * QC_0)
                            + delta[a0][b0] * delta[b1][c1] * (PQ[a1] * PQ[c0] * QD_0 * QD_1 + PQ[a1] * PQ[d0] * QD_1 * QC_0 + PQ[a1] * PQ[d1] * QD_0 * QC_0)
                            + delta[b0][c1] * delta[a0][b1] * (PQ[a1] * PQ[c0] * QD_0 * QD_1 + PQ[a1] * PQ[d0] * QD_1 * QC_0 + PQ[a1] * PQ[d1] * QD_0 * QC_0)
                            + delta[a0][c0] * delta[b0][b1] * (PQ[a1] * PQ[c1] * QD_0 * QD_1 + PQ[a1] * PQ[d0] * QD_1 * QC_1 + PQ[a1] * PQ[d1] * QD_0 * QC_1)
                            + delta[a0][b0] * delta[b1][c0] * (PQ[a1] * PQ[c1] * QD_0 * QD_1 + PQ[a1] * PQ[d0] * QD_1 * QC_1 + PQ[a1] * PQ[d1] * QD_0 * QC_1)
                            + delta[b0][c0] * delta[a0][b1] * (PQ[a1] * PQ[c1] * QD_0 * QD_1 + PQ[a1] * PQ[d0] * QD_1 * QC_1 + PQ[a1] * PQ[d1] * QD_0 * QC_1)
                            + delta[a0][a1] * delta[d0][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * QC_1 + PQ[b0] * PQ[b1] * PQ[c1] * QC_0 + PQ[b0] * PQ[b1] * QC_0 * QC_1)
                            + delta[a0][a1] * delta[c1][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * QD_0 + PQ[b0] * PQ[b1] * PQ[d0] * QC_0 + PQ[b0] * PQ[b1] * QD_0 * QC_0)
                            + delta[a0][a1] * delta[c0][d1] * (PQ[b0] * PQ[b1] * PQ[c1] * QD_0 + PQ[b0] * PQ[b1] * PQ[d0] * QC_1 + PQ[b0] * PQ[b1] * QD_0 * QC_1)
                            + delta[a0][a1] * delta[c1][d0] * (PQ[b0] * PQ[b1] * PQ[c0] * QD_1 + PQ[b0] * PQ[b1] * PQ[d1] * QC_0 + PQ[b0] * PQ[b1] * QD_1 * QC_0)
                            + delta[a0][a1] * delta[c0][d0] * (PQ[b0] * PQ[b1] * PQ[c1] * QD_1 + PQ[b0] * PQ[b1] * PQ[d1] * QC_1 + PQ[b0] * PQ[b1] * QD_1 * QC_1)
                            + delta[a0][d0] * delta[a1][d1] * (PQ[b0] * PQ[b1] * QC_0 * QC_1)
                            + delta[a0][d1] * delta[a1][d0] * (PQ[b0] * PQ[b1] * QC_0 * QC_1)
                            + delta[a0][c1] * delta[a1][d1] * (PQ[b0] * PQ[b1] * QD_0 * QC_0)
                            + delta[a0][d1] * delta[a1][c1] * (PQ[b0] * PQ[b1] * QD_0 * QC_0)
                            + delta[a0][c1] * delta[a1][d0] * (PQ[b0] * PQ[b1] * QD_1 * QC_0)
                            + delta[a0][d0] * delta[a1][c1] * (PQ[b0] * PQ[b1] * QD_1 * QC_0)
                            + delta[a0][c0] * delta[a1][d1] * (PQ[b0] * PQ[b1] * QD_0 * QC_1)
                            + delta[a0][d1] * delta[a1][c0] * (PQ[b0] * PQ[b1] * QD_0 * QC_1)
                            + delta[a0][c0] * delta[a1][d0] * (PQ[b0] * PQ[b1] * QD_1 * QC_1)
                            + delta[a0][d0] * delta[a1][c0] * (PQ[b0] * PQ[b1] * QD_1 * QC_1)
                            + delta[a0][d1] * delta[a1][b1] * (PQ[b0] * PQ[c0] * QD_0 * QC_1 + PQ[b0] * PQ[c1] * QD_0 * QC_0 + PQ[b0] * PQ[d0] * QC_0 * QC_1)
                            + delta[a0][a1] * delta[b1][d1] * (PQ[b0] * PQ[c0] * QD_0 * QC_1 + PQ[b0] * PQ[c1] * QD_0 * QC_0 + PQ[b0] * PQ[d0] * QC_0 * QC_1)
                            + delta[a1][d1] * delta[a0][b1] * (PQ[b0] * PQ[c0] * QD_0 * QC_1 + PQ[b0] * PQ[c1] * QD_0 * QC_0 + PQ[b0] * PQ[d0] * QC_0 * QC_1)
                            + delta[a0][d0] * delta[a1][b1] * (PQ[b0] * PQ[c0] * QD_1 * QC_1 + PQ[b0] * PQ[c1] * QD_1 * QC_0 + PQ[b0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][a1] * delta[b1][d0] * (PQ[b0] * PQ[c0] * QD_1 * QC_1 + PQ[b0] * PQ[c1] * QD_1 * QC_0 + PQ[b0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a1][d0] * delta[a0][b1] * (PQ[b0] * PQ[c0] * QD_1 * QC_1 + PQ[b0] * PQ[c1] * QD_1 * QC_0 + PQ[b0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][c1] * delta[a1][b1] * (PQ[b0] * PQ[c0] * QD_0 * QD_1 + PQ[b0] * PQ[d0] * QD_1 * QC_0 + PQ[b0] * PQ[d1] * QD_0 * QC_0)
                            + delta[a0][a1] * delta[b1][c1] * (PQ[b0] * PQ[c0] * QD_0 * QD_1 + PQ[b0] * PQ[d0] * QD_1 * QC_0 + PQ[b0] * PQ[d1] * QD_0 * QC_0)
                            + delta[a1][c1] * delta[a0][b1] * (PQ[b0] * PQ[c0] * QD_0 * QD_1 + PQ[b0] * PQ[d0] * QD_1 * QC_0 + PQ[b0] * PQ[d1] * QD_0 * QC_0)
                            + delta[a0][c0] * delta[a1][b1] * (PQ[b0] * PQ[c1] * QD_0 * QD_1 + PQ[b0] * PQ[d0] * QD_1 * QC_1 + PQ[b0] * PQ[d1] * QD_0 * QC_1)
                            + delta[a0][a1] * delta[b1][c0] * (PQ[b0] * PQ[c1] * QD_0 * QD_1 + PQ[b0] * PQ[d0] * QD_1 * QC_1 + PQ[b0] * PQ[d1] * QD_0 * QC_1)
                            + delta[a1][c0] * delta[a0][b1] * (PQ[b0] * PQ[c1] * QD_0 * QD_1 + PQ[b0] * PQ[d0] * QD_1 * QC_1 + PQ[b0] * PQ[d1] * QD_0 * QC_1)
                            + delta[a0][d1] * delta[a1][b0] * (PQ[b1] * PQ[c0] * QD_0 * QC_1 + PQ[b1] * PQ[c1] * QD_0 * QC_0 + PQ[b1] * PQ[d0] * QC_0 * QC_1)
                            + delta[a0][a1] * delta[b0][d1] * (PQ[b1] * PQ[c0] * QD_0 * QC_1 + PQ[b1] * PQ[c1] * QD_0 * QC_0 + PQ[b1] * PQ[d0] * QC_0 * QC_1)
                            + delta[a1][d1] * delta[a0][b0] * (PQ[b1] * PQ[c0] * QD_0 * QC_1 + PQ[b1] * PQ[c1] * QD_0 * QC_0 + PQ[b1] * PQ[d0] * QC_0 * QC_1)
                            + delta[a0][d0] * delta[a1][b0] * (PQ[b1] * PQ[c0] * QD_1 * QC_1 + PQ[b1] * PQ[c1] * QD_1 * QC_0 + PQ[b1] * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][a1] * delta[b0][d0] * (PQ[b1] * PQ[c0] * QD_1 * QC_1 + PQ[b1] * PQ[c1] * QD_1 * QC_0 + PQ[b1] * PQ[d1] * QC_0 * QC_1)
                            + delta[a1][d0] * delta[a0][b0] * (PQ[b1] * PQ[c0] * QD_1 * QC_1 + PQ[b1] * PQ[c1] * QD_1 * QC_0 + PQ[b1] * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][c1] * delta[a1][b0] * (PQ[b1] * PQ[c0] * QD_0 * QD_1 + PQ[b1] * PQ[d0] * QD_1 * QC_0 + PQ[b1] * PQ[d1] * QD_0 * QC_0)
                            + delta[a0][a1] * delta[b0][c1] * (PQ[b1] * PQ[c0] * QD_0 * QD_1 + PQ[b1] * PQ[d0] * QD_1 * QC_0 + PQ[b1] * PQ[d1] * QD_0 * QC_0)
                            + delta[a1][c1] * delta[a0][b0] * (PQ[b1] * PQ[c0] * QD_0 * QD_1 + PQ[b1] * PQ[d0] * QD_1 * QC_0 + PQ[b1] * PQ[d1] * QD_0 * QC_0)
                            + delta[a0][c0] * delta[a1][b0] * (PQ[b1] * PQ[c1] * QD_0 * QD_1 + PQ[b1] * PQ[d0] * QD_1 * QC_1 + PQ[b1] * PQ[d1] * QD_0 * QC_1)
                            + delta[a0][a1] * delta[b0][c0] * (PQ[b1] * PQ[c1] * QD_0 * QD_1 + PQ[b1] * PQ[d0] * QD_1 * QC_1 + PQ[b1] * PQ[d1] * QD_0 * QC_1)
                            + delta[a1][c0] * delta[a0][b0] * (PQ[b1] * PQ[c1] * QD_0 * QD_1 + PQ[b1] * PQ[d0] * QD_1 * QC_1 + PQ[b1] * PQ[d1] * QD_0 * QC_1)
                            + delta[a0][a1] * delta[b0][b1] * (PQ[c0] * PQ[c1] * QD_0 * QD_1 + PQ[c0] * PQ[d0] * QD_1 * QC_1 + PQ[c0] * PQ[d1] * QD_0 * QC_1 + PQ[c1] * PQ[d0] * QD_1 * QC_0 + PQ[c1] * PQ[d1] * QD_0 * QC_0 + PQ[d0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][b0] * delta[a1][b1] * (PQ[c0] * PQ[c1] * QD_0 * QD_1 + PQ[c0] * PQ[d0] * QD_1 * QC_1 + PQ[c0] * PQ[d1] * QD_0 * QC_1 + PQ[c1] * PQ[d0] * QD_1 * QC_0 + PQ[c1] * PQ[d1] * QD_0 * QC_0 + PQ[d0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a1][b0] * delta[a0][b1] * (PQ[c0] * PQ[c1] * QD_0 * QD_1 + PQ[c0] * PQ[d0] * QD_1 * QC_1 + PQ[c0] * PQ[d1] * QD_0 * QC_1 + PQ[c1] * PQ[d0] * QD_1 * QC_0 + PQ[c1] * PQ[d1] * QD_0 * QC_0 + PQ[d0] * PQ[d1] * QC_0 * QC_1)
                            + delta[c0][c1] * delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1])
                            + delta[c0][d0] * delta[c1][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1])
                            + delta[c1][d0] * delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1])
                            + delta[b1][c0] * delta[c1][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * QD_0)
                            + delta[b1][c1] * delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * QD_0)
                            + delta[b1][d1] * delta[c0][c1] * (PQ[a0] * PQ[a1] * PQ[b0] * QD_0)
                            + delta[b1][c0] * delta[c1][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * QD_1)
                            + delta[b1][c1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * QD_1)
                            + delta[b1][d0] * delta[c0][c1] * (PQ[a0] * PQ[a1] * PQ[b0] * QD_1)
                            + delta[b0][c0] * delta[c1][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * QD_0)
                            + delta[b0][c1] * delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * QD_0)
                            + delta[b0][d1] * delta[c0][c1] * (PQ[a0] * PQ[a1] * PQ[b1] * QD_0)
                            + delta[b0][c0] * delta[c1][d0] * (PQ[a0] * PQ[a1] * PQ[b1] * QD_1)
                            + delta[b0][c1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[b1] * QD_1)
                            + delta[b0][d0] * delta[c0][c1] * (PQ[a0] * PQ[a1] * PQ[b1] * QD_1)
                            + delta[b0][b1] * delta[c0][c1] * (PQ[a0] * PQ[a1] * PQ[d0] * QD_1 + PQ[a0] * PQ[a1] * PQ[d1] * QD_0 + PQ[a0] * PQ[a1] * QD_0 * QD_1)
                            + delta[b0][c0] * delta[b1][c1] * (PQ[a0] * PQ[a1] * QD_0 * QD_1)
                            + delta[b0][c1] * delta[b1][c0] * (PQ[a0] * PQ[a1] * QD_0 * QD_1)
                            + delta[a1][c0] * delta[c1][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * QD_0)
                            + delta[a1][c1] * delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * QD_0)
                            + delta[a1][d1] * delta[c0][c1] * (PQ[a0] * PQ[b0] * PQ[b1] * QD_0)
                            + delta[a1][c0] * delta[c1][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * QD_1)
                            + delta[a1][c1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * QD_1)
                            + delta[a1][d0] * delta[c0][c1] * (PQ[a0] * PQ[b0] * PQ[b1] * QD_1)
                            + delta[a1][b1] * delta[c0][c1] * (PQ[a0] * PQ[b0] * PQ[d0] * QD_1 + PQ[a0] * PQ[b0] * PQ[d1] * QD_0 + PQ[a0] * PQ[b0] * QD_0 * QD_1)
                            + delta[a1][c0] * delta[b1][c1] * (PQ[a0] * PQ[b0] * QD_0 * QD_1)
                            + delta[a1][c1] * delta[b1][c0] * (PQ[a0] * PQ[b0] * QD_0 * QD_1)
                            + delta[a1][b0] * delta[c0][c1] * (PQ[a0] * PQ[b1] * PQ[d0] * QD_1 + PQ[a0] * PQ[b1] * PQ[d1] * QD_0 + PQ[a0] * PQ[b1] * QD_0 * QD_1)
                            + delta[a1][c0] * delta[b0][c1] * (PQ[a0] * PQ[b1] * QD_0 * QD_1)
                            + delta[a1][c1] * delta[b0][c0] * (PQ[a0] * PQ[b1] * QD_0 * QD_1)
                            + delta[a0][c0] * delta[c1][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * QD_0)
                            + delta[a0][c1] * delta[c0][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * QD_0)
                            + delta[a0][d1] * delta[c0][c1] * (PQ[a1] * PQ[b0] * PQ[b1] * QD_0)
                            + delta[a0][c0] * delta[c1][d0] * (PQ[a1] * PQ[b0] * PQ[b1] * QD_1)
                            + delta[a0][c1] * delta[c0][d0] * (PQ[a1] * PQ[b0] * PQ[b1] * QD_1)
                            + delta[a0][d0] * delta[c0][c1] * (PQ[a1] * PQ[b0] * PQ[b1] * QD_1)
                            + delta[a0][b1] * delta[c0][c1] * (PQ[a1] * PQ[b0] * PQ[d0] * QD_1 + PQ[a1] * PQ[b0] * PQ[d1] * QD_0 + PQ[a1] * PQ[b0] * QD_0 * QD_1)
                            + delta[a0][c0] * delta[b1][c1] * (PQ[a1] * PQ[b0] * QD_0 * QD_1)
                            + delta[a0][c1] * delta[b1][c0] * (PQ[a1] * PQ[b0] * QD_0 * QD_1)
                            + delta[a0][b0] * delta[c0][c1] * (PQ[a1] * PQ[b1] * PQ[d0] * QD_1 + PQ[a1] * PQ[b1] * PQ[d1] * QD_0 + PQ[a1] * PQ[b1] * QD_0 * QD_1)
                            + delta[a0][c0] * delta[b0][c1] * (PQ[a1] * PQ[b1] * QD_0 * QD_1)
                            + delta[a0][c1] * delta[b0][c0] * (PQ[a1] * PQ[b1] * QD_0 * QD_1)
                            + delta[a0][a1] * delta[c0][c1] * (PQ[b0] * PQ[b1] * PQ[d0] * QD_1 + PQ[b0] * PQ[b1] * PQ[d1] * QD_0 + PQ[b0] * PQ[b1] * QD_0 * QD_1)
                            + delta[a0][c0] * delta[a1][c1] * (PQ[b0] * PQ[b1] * QD_0 * QD_1)
                            + delta[a0][c1] * delta[a1][c0] * (PQ[b0] * PQ[b1] * QD_0 * QD_1)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD30(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[5];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[4] * (

                        0.5 * ( S1 * S1 * S1 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[c1] * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[c1] * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[c1] * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[c1] * (-1.0))
                            + delta[c1][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[d0] * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[d0] * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[c1][d0] * (PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[d1] * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c1] * PQ[d0] * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c1] * PQ[d0] * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[c0][d0] * (PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c1] * PQ[d1] * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c1] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[c0][c1] * (PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b1][d1] * (PB_0 * PA_0 * PA_1 * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[b1][d0] * (PB_0 * PA_0 * PA_1 * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[b1][c1] * (PB_0 * PA_0 * PA_1 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b1][c0] * (PB_0 * PA_0 * PA_1 * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][d1] * (PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[b0][c1] * (PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][c0] * (PB_1 * PA_0 * PA_1 * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][b1] * (PA_0 * PA_1 * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a1][d1] * (PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a1][d0] * (PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a1][c1] * (PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][c0] * (PB_0 * PB_1 * PA_0 * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][b1] * (PB_0 * PA_0 * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a1][b0] * (PB_1 * PA_0 * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * (PB_0 * PB_1 * PA_1 * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][d0] * (PB_0 * PB_1 * PA_1 * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * (PB_0 * PB_1 * PA_1 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * (PB_0 * PB_1 * PA_1 * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b1] * (PB_0 * PA_1 * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * (PB_1 * PA_1 * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][a1] * (PB_0 * PB_1 * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD31(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[5];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[4] * (

                        0.5 * ( S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1] + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * QC_1 + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c1] * QC_0 + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * QC_1 + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c1] * QC_0 + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * QC_1 + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c1] * QC_0 + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * QC_1 + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c1] * QC_0 + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * QC_1 + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c1] * QC_0 + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * QC_1 + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c1] * QC_0)
                            + delta[c1][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0] + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * QD_0 + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * QC_0 + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * QD_0 + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * QC_0 + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * QD_0 + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * QC_0 + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * QD_0 + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * QC_0 + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * QD_0 + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * QC_0 + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * QC_0)
                            + delta[c1][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[d1] + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * QD_1 + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d1] * QC_0 + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d1] + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * QD_1 + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d1] * QC_0 + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d1] + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * QD_1 + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d1] * QC_0 + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d1] + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * QD_1 + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d1] * QC_0 + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1] + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * QD_1 + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d1] * QC_0 + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * QD_1 + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d1] * QC_0)
                            + delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c1] * PQ[d0] + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c1] * QD_0 + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * QC_1 + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d0] + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c1] * QD_0 + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * QC_1 + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c1] * PQ[d0] + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c1] * QD_0 + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * QC_1 + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d0] + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c1] * QD_0 + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * QC_1 + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c1] * QD_0 + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * QC_1 + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c1] * QD_0 + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * QC_1)
                            + delta[c0][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c1] * PQ[d1] + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c1] * QD_1 + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d1] * QC_1 + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d1] + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c1] * QD_1 + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d1] * QC_1 + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c1] * PQ[d1] + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c1] * QD_1 + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d1] * QC_1 + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d1] + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c1] * QD_1 + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d1] * QC_1 + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c1] * PQ[d1] + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c1] * QD_1 + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d1] * QC_1 + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c1] * QD_1 + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d1] * QC_1)
                            + delta[c0][c1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * PQ[d1] + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * QD_1 + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d1] * QD_0 + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1] + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * QD_1 + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d1] * QD_0 + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1] + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * QD_1 + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d1] * QD_0 + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1] + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * QD_1 + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d1] * QD_0 + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1] + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * QD_1 + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d1] * QD_0 + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d1] * QD_0)
                            + delta[b1][d1] * (PB_0 * PA_0 * PQ[a1] * PQ[c0] * PQ[c1] * QD_0 + PB_0 * PA_0 * PQ[a1] * PQ[c0] * PQ[d0] * QC_1 + PB_0 * PA_0 * PQ[a1] * PQ[c1] * PQ[d0] * QC_0 + PB_0 * PA_1 * PQ[a0] * PQ[c0] * PQ[c1] * QD_0 + PB_0 * PA_1 * PQ[a0] * PQ[c0] * PQ[d0] * QC_1 + PB_0 * PA_1 * PQ[a0] * PQ[c1] * PQ[d0] * QC_0 + PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 + PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[d0] * QC_1 + PA_0 * PA_1 * PQ[b0] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[b1][d0] * (PB_0 * PA_0 * PQ[a1] * PQ[c0] * PQ[c1] * QD_1 + PB_0 * PA_0 * PQ[a1] * PQ[c0] * PQ[d1] * QC_1 + PB_0 * PA_0 * PQ[a1] * PQ[c1] * PQ[d1] * QC_0 + PB_0 * PA_1 * PQ[a0] * PQ[c0] * PQ[c1] * QD_1 + PB_0 * PA_1 * PQ[a0] * PQ[c0] * PQ[d1] * QC_1 + PB_0 * PA_1 * PQ[a0] * PQ[c1] * PQ[d1] * QC_0 + PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[c1] * QD_1 + PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[d1] * QC_1 + PA_0 * PA_1 * PQ[b0] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[b1][c1] * (PB_0 * PA_0 * PQ[a1] * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PA_0 * PQ[a1] * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PA_0 * PQ[a1] * PQ[d0] * PQ[d1] * QC_0 + PB_0 * PA_1 * PQ[a0] * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PA_1 * PQ[a0] * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PA_1 * PQ[a0] * PQ[d0] * PQ[d1] * QC_0 + PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 + PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 + PA_0 * PA_1 * PQ[b0] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[b1][c0] * (PB_0 * PA_0 * PQ[a1] * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PA_0 * PQ[a1] * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PA_0 * PQ[a1] * PQ[d0] * PQ[d1] * QC_1 + PB_0 * PA_1 * PQ[a0] * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PA_1 * PQ[a0] * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PA_1 * PQ[a0] * PQ[d0] * PQ[d1] * QC_1 + PA_0 * PA_1 * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 + PA_0 * PA_1 * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 + PA_0 * PA_1 * PQ[b0] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[b0][d1] * (PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[c1] * QD_0 + PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[d0] * QC_1 + PB_1 * PA_0 * PQ[a1] * PQ[c1] * PQ[d0] * QC_0 + PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[c1] * QD_0 + PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[d0] * QC_1 + PB_1 * PA_1 * PQ[a0] * PQ[c1] * PQ[d0] * QC_0 + PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 + PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[d0] * QC_1 + PA_0 * PA_1 * PQ[b1] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[b0][d0] * (PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[c1] * QD_1 + PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[d1] * QC_1 + PB_1 * PA_0 * PQ[a1] * PQ[c1] * PQ[d1] * QC_0 + PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[c1] * QD_1 + PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[d1] * QC_1 + PB_1 * PA_1 * PQ[a0] * PQ[c1] * PQ[d1] * QC_0 + PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[c1] * QD_1 + PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[d1] * QC_1 + PA_0 * PA_1 * PQ[b1] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[b0][c1] * (PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[d0] * QD_1 + PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[d1] * QD_0 + PB_1 * PA_0 * PQ[a1] * PQ[d0] * PQ[d1] * QC_0 + PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[d0] * QD_1 + PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[d1] * QD_0 + PB_1 * PA_1 * PQ[a0] * PQ[d0] * PQ[d1] * QC_0 + PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 + PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 + PA_0 * PA_1 * PQ[b1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[b0][c0] * (PB_1 * PA_0 * PQ[a1] * PQ[c1] * PQ[d0] * QD_1 + PB_1 * PA_0 * PQ[a1] * PQ[c1] * PQ[d1] * QD_0 + PB_1 * PA_0 * PQ[a1] * PQ[d0] * PQ[d1] * QC_1 + PB_1 * PA_1 * PQ[a0] * PQ[c1] * PQ[d0] * QD_1 + PB_1 * PA_1 * PQ[a0] * PQ[c1] * PQ[d1] * QD_0 + PB_1 * PA_1 * PQ[a0] * PQ[d0] * PQ[d1] * QC_1 + PA_0 * PA_1 * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 + PA_0 * PA_1 * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 + PA_0 * PA_1 * PQ[b1] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[b0][b1] * (PA_0 * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PA_0 * PA_1 * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PA_0 * PA_1 * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PA_0 * PA_1 * PQ[c1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a1][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[c1] * QD_0 + PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[d0] * QC_1 + PB_0 * PB_1 * PQ[a0] * PQ[c1] * PQ[d0] * QC_0 + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[d0] * QC_1 + PB_0 * PA_0 * PQ[b1] * PQ[c1] * PQ[d0] * QC_0 + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[d0] * QC_1 + PB_1 * PA_0 * PQ[b0] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a1][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[c1] * QD_1 + PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[d1] * QC_1 + PB_0 * PB_1 * PQ[a0] * PQ[c1] * PQ[d1] * QC_0 + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[c1] * QD_1 + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[d1] * QC_1 + PB_0 * PA_0 * PQ[b1] * PQ[c1] * PQ[d1] * QC_0 + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * QD_1 + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[d1] * QC_1 + PB_1 * PA_0 * PQ[b0] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a1][c1] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PB_1 * PQ[a0] * PQ[d0] * PQ[d1] * QC_0 + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PA_0 * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 + PB_1 * PA_0 * PQ[b0] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a1][c0] * (PB_0 * PB_1 * PQ[a0] * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PB_1 * PQ[a0] * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PB_1 * PQ[a0] * PQ[d0] * PQ[d1] * QC_1 + PB_0 * PA_0 * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PA_0 * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PA_0 * PQ[b1] * PQ[d0] * PQ[d1] * QC_1 + PB_1 * PA_0 * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 + PB_1 * PA_0 * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 + PB_1 * PA_0 * PQ[b0] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a1][b1] * (PB_0 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PA_0 * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PA_0 * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PB_0 * PA_0 * PQ[c1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a1][b0] * (PB_1 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PB_1 * PA_0 * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PB_1 * PA_0 * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PB_1 * PA_0 * PQ[c1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][d1] * (PB_0 * PB_1 * PQ[a1] * PQ[c0] * PQ[c1] * QD_0 + PB_0 * PB_1 * PQ[a1] * PQ[c0] * PQ[d0] * QC_1 + PB_0 * PB_1 * PQ[a1] * PQ[c1] * PQ[d0] * QC_0 + PB_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 + PB_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[d0] * QC_1 + PB_0 * PA_1 * PQ[b1] * PQ[c1] * PQ[d0] * QC_0 + PB_1 * PA_1 * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 + PB_1 * PA_1 * PQ[b0] * PQ[c0] * PQ[d0] * QC_1 + PB_1 * PA_1 * PQ[b0] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a0][d0] * (PB_0 * PB_1 * PQ[a1] * PQ[c0] * PQ[c1] * QD_1 + PB_0 * PB_1 * PQ[a1] * PQ[c0] * PQ[d1] * QC_1 + PB_0 * PB_1 * PQ[a1] * PQ[c1] * PQ[d1] * QC_0 + PB_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[c1] * QD_1 + PB_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[d1] * QC_1 + PB_0 * PA_1 * PQ[b1] * PQ[c1] * PQ[d1] * QC_0 + PB_1 * PA_1 * PQ[b0] * PQ[c0] * PQ[c1] * QD_1 + PB_1 * PA_1 * PQ[b0] * PQ[c0] * PQ[d1] * QC_1 + PB_1 * PA_1 * PQ[b0] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a0][c1] * (PB_0 * PB_1 * PQ[a1] * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PB_1 * PQ[a1] * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PB_1 * PQ[a1] * PQ[d0] * PQ[d1] * QC_0 + PB_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PA_1 * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 + PB_1 * PA_1 * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 + PB_1 * PA_1 * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 + PB_1 * PA_1 * PQ[b0] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][c0] * (PB_0 * PB_1 * PQ[a1] * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PB_1 * PQ[a1] * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PB_1 * PQ[a1] * PQ[d0] * PQ[d1] * QC_1 + PB_0 * PA_1 * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PA_1 * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PA_1 * PQ[b1] * PQ[d0] * PQ[d1] * QC_1 + PB_1 * PA_1 * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 + PB_1 * PA_1 * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 + PB_1 * PA_1 * PQ[b0] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a0][b1] * (PB_0 * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PB_0 * PQ[a1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PA_1 * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PA_1 * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PB_0 * PA_1 * PQ[c1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][b0] * (PB_1 * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PB_1 * PQ[a1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PA_1 * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PB_1 * PA_1 * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PB_1 * PA_1 * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PB_1 * PA_1 * PQ[c1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][a1] * (PB_0 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PB_0 * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PB_1 * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PB_1 * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PB_1 * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PB_0 * PB_1 * PQ[c1] * PQ[d0] * PQ[d1] * QC_0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD32(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[5];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[4] * (

                        0.5 * ( S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1] * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1] * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * QC_0 * QC_1 * (-1.0))
                            + delta[c1][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * QC_0 * (-1.0))
                            + delta[c1][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * QD_1 * QC_0 * (-1.0))
                            + delta[c0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * QC_1 * (-1.0))
                            + delta[c0][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d1] * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d1] * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * QD_1 * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * QD_1 * QC_1 * (-1.0))
                            + delta[c0][c1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * QD_1 * (-1.0))
                            + delta[b1][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[b1][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[b1][c1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[b1][c0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[a1] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[b0][d1] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][d0] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][c1] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[b0][c0] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[b0][b1] * (PA_0 * PQ[a1] * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[a1] * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PA_1 * PQ[a0] * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PQ[a0] * PQ[a1] * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PQ[a0] * PQ[a1] * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PQ[a0] * PQ[a1] * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PQ[a0] * PQ[a1] * PQ[d0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a1][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[a1][d0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a1][c1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a1][c0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[a1][b1] * (PB_0 * PQ[a0] * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PQ[a0] * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a1][b0] * (PB_1 * PQ[a0] * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PQ[a0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PQ[a0] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PQ[a0] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][d1] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_0 * PQ[a1] * PQ[b1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[a1] * PQ[b1] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][d0] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[a1] * PQ[b1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[a1] * PQ[b1] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][c1] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[a1] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[a1] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][c0] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[a1] * PQ[b1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[a1] * PQ[b1] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[a0][b1] * (PB_0 * PQ[a1] * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[a1] * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[a1] * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_0 * PQ[a1] * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[a1] * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[a1] * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PA_1 * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PQ[a1] * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PQ[a1] * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PQ[a1] * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][b0] * (PB_1 * PQ[a1] * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[a1] * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[a1] * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[a1] * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[a1] * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[a1] * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PA_1 * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_1 * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PQ[a1] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PQ[a1] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PQ[a1] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][a1] * (PB_0 * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_0 * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD33(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[6];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 5, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[4] * (

                        0.5 * ( S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * QC_0 * QC_1)
                            + delta[c1][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * QC_0)
                            + delta[c1][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * QD_1 * QC_0)
                            + delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * QC_1)
                            + delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * QD_1 * QC_1)
                            + delta[b1][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * QD_0 * QC_0 * QC_1)
                            + delta[b1][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * QD_1 * QC_0 * QC_1)
                            + delta[b1][c1] * (PQ[a0] * PQ[a1] * PQ[b0] * QD_0 * QD_1 * QC_0)
                            + delta[b1][c0] * (PQ[a0] * PQ[a1] * PQ[b0] * QD_0 * QD_1 * QC_1)
                            + delta[b0][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * QD_0 * QC_0 * QC_1)
                            + delta[b0][d0] * (PQ[a0] * PQ[a1] * PQ[b1] * QD_1 * QC_0 * QC_1)
                            + delta[b0][c1] * (PQ[a0] * PQ[a1] * PQ[b1] * QD_0 * QD_1 * QC_0)
                            + delta[b0][c0] * (PQ[a0] * PQ[a1] * PQ[b1] * QD_0 * QD_1 * QC_1)
                            + delta[b0][b1] * (PQ[a0] * PQ[a1] * PQ[c0] * QD_0 * QD_1 * QC_1 + PQ[a0] * PQ[a1] * PQ[c1] * QD_0 * QD_1 * QC_0 + PQ[a0] * PQ[a1] * PQ[d0] * QD_1 * QC_0 * QC_1 + PQ[a0] * PQ[a1] * PQ[d1] * QD_0 * QC_0 * QC_1)
                            + delta[a1][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * QC_0 * QC_1)
                            + delta[a1][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * QD_1 * QC_0 * QC_1)
                            + delta[a1][c1] * (PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_0)
                            + delta[a1][c0] * (PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_1)
                            + delta[a1][b1] * (PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * QD_1 * QC_1 + PQ[a0] * PQ[b0] * PQ[c1] * QD_0 * QD_1 * QC_0 + PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * QC_0 * QC_1 + PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * QC_0 * QC_1)
                            + delta[a1][b0] * (PQ[a0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 + PQ[a0] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 + PQ[a0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 + PQ[a0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1)
                            + delta[a0][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * QC_0 * QC_1)
                            + delta[a0][d0] * (PQ[a1] * PQ[b0] * PQ[b1] * QD_1 * QC_0 * QC_1)
                            + delta[a0][c1] * (PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_0)
                            + delta[a0][c0] * (PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_1)
                            + delta[a0][b1] * (PQ[a1] * PQ[b0] * PQ[c0] * QD_0 * QD_1 * QC_1 + PQ[a1] * PQ[b0] * PQ[c1] * QD_0 * QD_1 * QC_0 + PQ[a1] * PQ[b0] * PQ[d0] * QD_1 * QC_0 * QC_1 + PQ[a1] * PQ[b0] * PQ[d1] * QD_0 * QC_0 * QC_1)
                            + delta[a0][b0] * (PQ[a1] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 + PQ[a1] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 + PQ[a1] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 + PQ[a1] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1)
                            + delta[a0][a1] * (PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 + PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 + PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 + PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1)
                            + delta[c0][c1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * QD_1)
                        )

                    )

                    +

                    F8_t[4] * (

                        0.0625 / ( S4 * S4 * S4 * S4 ) * (
                            delta[a0][c0] * delta[a1][c1] * delta[b0][b1] * delta[d0][d1]
                            + delta[a0][c0] * delta[a1][c1] * delta[b0][d0] * delta[b1][d1]
                            + delta[a0][c0] * delta[a1][c1] * delta[b0][d1] * delta[b1][d0]
                            + delta[a0][c0] * delta[a1][d0] * delta[b0][b1] * delta[c1][d1]
                            + delta[a0][c0] * delta[a1][d0] * delta[b0][c1] * delta[b1][d1]
                            + delta[a0][c0] * delta[a1][d0] * delta[b0][d1] * delta[b1][c1]
                            + delta[a0][c0] * delta[a1][d1] * delta[b0][b1] * delta[c1][d0]
                            + delta[a0][c0] * delta[a1][d1] * delta[b0][c1] * delta[b1][d0]
                            + delta[a0][c0] * delta[a1][d1] * delta[b0][d0] * delta[b1][c1]
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][c1] * delta[d0][d1]
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d0] * delta[c1][d1]
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d1] * delta[c1][d0]
                            + delta[a0][c0] * delta[b0][c1] * delta[a1][b1] * delta[d0][d1]
                            + delta[a0][c0] * delta[b0][d0] * delta[a1][b1] * delta[c1][d1]
                            + delta[a0][c0] * delta[b0][d1] * delta[a1][b1] * delta[c1][d0]
                            + delta[a0][c1] * delta[a1][c0] * delta[b0][b1] * delta[d0][d1]
                            + delta[a0][c1] * delta[a1][c0] * delta[b0][d0] * delta[b1][d1]
                            + delta[a0][c1] * delta[a1][c0] * delta[b0][d1] * delta[b1][d0]
                            + delta[a0][c1] * delta[a1][d0] * delta[b0][b1] * delta[c0][d1]
                            + delta[a0][c1] * delta[a1][d0] * delta[b0][c0] * delta[b1][d1]
                            + delta[a0][c1] * delta[a1][d0] * delta[b0][d1] * delta[b1][c0]
                            + delta[a0][c1] * delta[a1][d1] * delta[b0][b1] * delta[c0][d0]
                            + delta[a0][c1] * delta[a1][d1] * delta[b0][c0] * delta[b1][d0]
                            + delta[a0][c1] * delta[a1][d1] * delta[b0][d0] * delta[b1][c0]
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][c0] * delta[d0][d1]
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][d0] * delta[c0][d1]
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][d1] * delta[c0][d0]
                            + delta[a0][c1] * delta[b0][c0] * delta[a1][b1] * delta[d0][d1]
                            + delta[a0][c1] * delta[b0][d0] * delta[a1][b1] * delta[c0][d1]
                            + delta[a0][c1] * delta[b0][d1] * delta[a1][b1] * delta[c0][d0]
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][b1] * delta[c1][d1]
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][c1] * delta[b1][d1]
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][d1] * delta[b1][c1]
                            + delta[a0][d0] * delta[a1][c1] * delta[b0][b1] * delta[c0][d1]
                            + delta[a0][d0] * delta[a1][c1] * delta[b0][c0] * delta[b1][d1]
                            + delta[a0][d0] * delta[a1][c1] * delta[b0][d1] * delta[b1][c0]
                            + delta[a0][d0] * delta[a1][d1] * delta[b0][b1] * delta[c0][c1]
                            + delta[a0][d0] * delta[a1][d1] * delta[b0][c0] * delta[b1][c1]
                            + delta[a0][d0] * delta[a1][d1] * delta[b0][c1] * delta[b1][c0]
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][c0] * delta[c1][d1]
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][c1] * delta[c0][d1]
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][d1] * delta[c0][c1]
                            + delta[a0][d0] * delta[b0][c0] * delta[a1][b1] * delta[c1][d1]
                            + delta[a0][d0] * delta[b0][c1] * delta[a1][b1] * delta[c0][d1]
                            + delta[a0][d0] * delta[b0][d1] * delta[a1][b1] * delta[c0][c1]
                            + delta[a0][d1] * delta[a1][c0] * delta[b0][b1] * delta[c1][d0]
                            + delta[a0][d1] * delta[a1][c0] * delta[b0][c1] * delta[b1][d0]
                            + delta[a0][d1] * delta[a1][c0] * delta[b0][d0] * delta[b1][c1]
                            + delta[a0][d1] * delta[a1][c1] * delta[b0][b1] * delta[c0][d0]
                            + delta[a0][d1] * delta[a1][c1] * delta[b0][c0] * delta[b1][d0]
                            + delta[a0][d1] * delta[a1][c1] * delta[b0][d0] * delta[b1][c0]
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][b1] * delta[c0][c1]
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][c0] * delta[b1][c1]
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][c1] * delta[b1][c0]
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][c0] * delta[c1][d0]
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][c1] * delta[c0][d0]
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][d0] * delta[c0][c1]
                            + delta[a0][d1] * delta[b0][c0] * delta[a1][b1] * delta[c1][d0]
                            + delta[a0][d1] * delta[b0][c1] * delta[a1][b1] * delta[c0][d0]
                            + delta[a0][d1] * delta[b0][d0] * delta[a1][b1] * delta[c0][c1]
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][c1] * delta[d0][d1]
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * delta[c1][d1]
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d0] * delta[c0][d1]
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][c1] * delta[d0][d1]
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d0] * delta[c1][d1]
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d1] * delta[c1][d0]
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][c0] * delta[d0][d1]
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][d0] * delta[c0][d1]
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][d1] * delta[c0][d0]
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][c0] * delta[c1][d1]
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][c1] * delta[c0][d1]
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][d1] * delta[c0][c1]
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][c0] * delta[c1][d0]
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][c1] * delta[c0][d0]
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][d0] * delta[c0][c1]
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][c1] * delta[d0][d1]
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d0] * delta[c1][d1]
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d1] * delta[c1][d0]
                            + delta[a1][c0] * delta[b0][c1] * delta[a0][b1] * delta[d0][d1]
                            + delta[a1][c0] * delta[b0][d0] * delta[a0][b1] * delta[c1][d1]
                            + delta[a1][c0] * delta[b0][d1] * delta[a0][b1] * delta[c1][d0]
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][c0] * delta[d0][d1]
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][d0] * delta[c0][d1]
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][d1] * delta[c0][d0]
                            + delta[a1][c1] * delta[b0][c0] * delta[a0][b1] * delta[d0][d1]
                            + delta[a1][c1] * delta[b0][d0] * delta[a0][b1] * delta[c0][d1]
                            + delta[a1][c1] * delta[b0][d1] * delta[a0][b1] * delta[c0][d0]
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][c0] * delta[c1][d1]
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][c1] * delta[c0][d1]
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][d1] * delta[c0][c1]
                            + delta[a1][d0] * delta[b0][c0] * delta[a0][b1] * delta[c1][d1]
                            + delta[a1][d0] * delta[b0][c1] * delta[a0][b1] * delta[c0][d1]
                            + delta[a1][d0] * delta[b0][d1] * delta[a0][b1] * delta[c0][c1]
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][c0] * delta[c1][d0]
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][c1] * delta[c0][d0]
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][d0] * delta[c0][c1]
                            + delta[a1][d1] * delta[b0][c0] * delta[a0][b1] * delta[c1][d0]
                            + delta[a1][d1] * delta[b0][c1] * delta[a0][b1] * delta[c0][d0]
                            + delta[a1][d1] * delta[b0][d0] * delta[a0][b1] * delta[c0][c1]
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][c1] * delta[d0][d1]
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * delta[c1][d1]
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d0] * delta[c0][d1]
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][c1] * delta[d0][d1]
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * delta[c1][d1]
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d0] * delta[c0][d1]
                        )

                    )

                    +

                    F8_t[5] * (

                        ( S1 * S1 * S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                        )

                    )

                    +

                    F8_t[5] * (

                        ( S1 * S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                        )

                    )

                    +

                    F8_t[5] * (

                        ( S1 * S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                        )

                    )

                    +

                    F8_t[5] * (

                        ( S1 * S2 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            
                            + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD34(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[6];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 5, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[5] * (

                        0.125 * ( S1 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (PQ[a0] * PQ[a1] * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (PQ[a0] * PQ[a1] * (-1.0))
                            + delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (PQ[a0] * PQ[a1] * (-1.0))
                            + delta[b0][c0] * delta[b1][c1] * delta[d0][d1] * (PQ[a0] * PQ[a1] * (-1.0))
                            + delta[b0][c0] * delta[b1][d0] * delta[c1][d1] * (PQ[a0] * PQ[a1] * (-1.0))
                            + delta[b0][c0] * delta[b1][d1] * delta[c1][d0] * (PQ[a0] * PQ[a1] * (-1.0))
                            + delta[b0][c1] * delta[b1][c0] * delta[d0][d1] * (PQ[a0] * PQ[a1] * (-1.0))
                            + delta[b0][c1] * delta[b1][d0] * delta[c0][d1] * (PQ[a0] * PQ[a1] * (-1.0))
                            + delta[b0][c1] * delta[b1][d1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * (-1.0))
                            + delta[b0][d0] * delta[b1][c0] * delta[c1][d1] * (PQ[a0] * PQ[a1] * (-1.0))
                            + delta[b0][d0] * delta[b1][c1] * delta[c0][d1] * (PQ[a0] * PQ[a1] * (-1.0))
                            + delta[b0][d0] * delta[b1][d1] * delta[c0][c1] * (PQ[a0] * PQ[a1] * (-1.0))
                            + delta[b0][d1] * delta[b1][c0] * delta[c1][d0] * (PQ[a0] * PQ[a1] * (-1.0))
                            + delta[b0][d1] * delta[b1][c1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * (-1.0))
                            + delta[b0][d1] * delta[b1][d0] * delta[c0][c1] * (PQ[a0] * PQ[a1] * (-1.0))
                            + delta[a1][c0] * delta[b1][c1] * delta[d0][d1] * (PQ[a0] * PQ[b0] * (-1.0))
                            + delta[a1][c0] * delta[b1][d0] * delta[c1][d1] * (PQ[a0] * PQ[b0] * (-1.0))
                            + delta[a1][c0] * delta[b1][d1] * delta[c1][d0] * (PQ[a0] * PQ[b0] * (-1.0))
                            + delta[a1][c1] * delta[b1][c0] * delta[d0][d1] * (PQ[a0] * PQ[b0] * (-1.0))
                            + delta[a1][c1] * delta[b1][d0] * delta[c0][d1] * (PQ[a0] * PQ[b0] * (-1.0))
                            + delta[a1][c1] * delta[b1][d1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * (-1.0))
                            + delta[a1][d0] * delta[b1][c0] * delta[c1][d1] * (PQ[a0] * PQ[b0] * (-1.0))
                            + delta[a1][d0] * delta[b1][c1] * delta[c0][d1] * (PQ[a0] * PQ[b0] * (-1.0))
                            + delta[a1][d0] * delta[b1][d1] * delta[c0][c1] * (PQ[a0] * PQ[b0] * (-1.0))
                            + delta[a1][d1] * delta[b1][c0] * delta[c1][d0] * (PQ[a0] * PQ[b0] * (-1.0))
                            + delta[a1][d1] * delta[b1][c1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * (-1.0))
                            + delta[a1][d1] * delta[b1][d0] * delta[c0][c1] * (PQ[a0] * PQ[b0] * (-1.0))
                            + delta[a1][b1] * delta[c0][c1] * delta[d0][d1] * (PQ[a0] * PQ[b0] * (-1.0))
                            + delta[a1][b1] * delta[c0][d0] * delta[c1][d1] * (PQ[a0] * PQ[b0] * (-1.0))
                            + delta[a1][b1] * delta[c1][d0] * delta[c0][d1] * (PQ[a0] * PQ[b0] * (-1.0))
                            + delta[a1][c0] * delta[b0][c1] * delta[d0][d1] * (PQ[a0] * PQ[b1] * (-1.0))
                            + delta[a1][c0] * delta[b0][d0] * delta[c1][d1] * (PQ[a0] * PQ[b1] * (-1.0))
                            + delta[a1][c0] * delta[b0][d1] * delta[c1][d0] * (PQ[a0] * PQ[b1] * (-1.0))
                            + delta[a1][c1] * delta[b0][c0] * delta[d0][d1] * (PQ[a0] * PQ[b1] * (-1.0))
                            + delta[a1][c1] * delta[b0][d0] * delta[c0][d1] * (PQ[a0] * PQ[b1] * (-1.0))
                            + delta[a1][c1] * delta[b0][d1] * delta[c0][d0] * (PQ[a0] * PQ[b1] * (-1.0))
                            + delta[a1][d0] * delta[b0][c0] * delta[c1][d1] * (PQ[a0] * PQ[b1] * (-1.0))
                            + delta[a1][d0] * delta[b0][c1] * delta[c0][d1] * (PQ[a0] * PQ[b1] * (-1.0))
                            + delta[a1][d0] * delta[b0][d1] * delta[c0][c1] * (PQ[a0] * PQ[b1] * (-1.0))
                            + delta[a1][d1] * delta[b0][c0] * delta[c1][d0] * (PQ[a0] * PQ[b1] * (-1.0))
                            + delta[a1][d1] * delta[b0][c1] * delta[c0][d0] * (PQ[a0] * PQ[b1] * (-1.0))
                            + delta[a1][d1] * delta[b0][d0] * delta[c0][c1] * (PQ[a0] * PQ[b1] * (-1.0))
                            + delta[a1][b0] * delta[c0][c1] * delta[d0][d1] * (PQ[a0] * PQ[b1] * (-1.0))
                            + delta[a1][b0] * delta[c0][d0] * delta[c1][d1] * (PQ[a0] * PQ[b1] * (-1.0))
                            + delta[a1][b0] * delta[c1][d0] * delta[c0][d1] * (PQ[a0] * PQ[b1] * (-1.0))
                            + delta[a1][c1] * delta[b0][b1] * delta[d0][d1] * (PQ[a0] * PQ[c0] * (-1.0))
                            + delta[a1][c1] * delta[b0][d0] * delta[b1][d1] * (PQ[a0] * PQ[c0] * (-1.0))
                            + delta[a1][c1] * delta[b0][d1] * delta[b1][d0] * (PQ[a0] * PQ[c0] * (-1.0))
                            + delta[a1][d0] * delta[b0][b1] * delta[c1][d1] * (PQ[a0] * PQ[c0] * (-1.0))
                            + delta[a1][d0] * delta[b0][c1] * delta[b1][d1] * (PQ[a0] * PQ[c0] * (-1.0))
                            + delta[a1][d0] * delta[b0][d1] * delta[b1][c1] * (PQ[a0] * PQ[c0] * (-1.0))
                            + delta[a1][d1] * delta[b0][b1] * delta[c1][d0] * (PQ[a0] * PQ[c0] * (-1.0))
                            + delta[a1][d1] * delta[b0][c1] * delta[b1][d0] * (PQ[a0] * PQ[c0] * (-1.0))
                            + delta[a1][d1] * delta[b0][d0] * delta[b1][c1] * (PQ[a0] * PQ[c0] * (-1.0))
                            + delta[a1][b0] * delta[b1][c1] * delta[d0][d1] * (PQ[a0] * PQ[c0] * (-1.0))
                            + delta[a1][b0] * delta[b1][d0] * delta[c1][d1] * (PQ[a0] * PQ[c0] * (-1.0))
                            + delta[a1][b0] * delta[b1][d1] * delta[c1][d0] * (PQ[a0] * PQ[c0] * (-1.0))
                            + delta[b0][c1] * delta[a1][b1] * delta[d0][d1] * (PQ[a0] * PQ[c0] * (-1.0))
                            + delta[b0][d0] * delta[a1][b1] * delta[c1][d1] * (PQ[a0] * PQ[c0] * (-1.0))
                            + delta[b0][d1] * delta[a1][b1] * delta[c1][d0] * (PQ[a0] * PQ[c0] * (-1.0))
                            + delta[a1][c0] * delta[b0][b1] * delta[d0][d1] * (PQ[a0] * PQ[c1] * (-1.0))
                            + delta[a1][c0] * delta[b0][d0] * delta[b1][d1] * (PQ[a0] * PQ[c1] * (-1.0))
                            + delta[a1][c0] * delta[b0][d1] * delta[b1][d0] * (PQ[a0] * PQ[c1] * (-1.0))
                            + delta[a1][d0] * delta[b0][b1] * delta[c0][d1] * (PQ[a0] * PQ[c1] * (-1.0))
                            + delta[a1][d0] * delta[b0][c0] * delta[b1][d1] * (PQ[a0] * PQ[c1] * (-1.0))
                            + delta[a1][d0] * delta[b0][d1] * delta[b1][c0] * (PQ[a0] * PQ[c1] * (-1.0))
                            + delta[a1][d1] * delta[b0][b1] * delta[c0][d0] * (PQ[a0] * PQ[c1] * (-1.0))
                            + delta[a1][d1] * delta[b0][c0] * delta[b1][d0] * (PQ[a0] * PQ[c1] * (-1.0))
                            + delta[a1][d1] * delta[b0][d0] * delta[b1][c0] * (PQ[a0] * PQ[c1] * (-1.0))
                            + delta[a1][b0] * delta[b1][c0] * delta[d0][d1] * (PQ[a0] * PQ[c1] * (-1.0))
                            + delta[a1][b0] * delta[b1][d0] * delta[c0][d1] * (PQ[a0] * PQ[c1] * (-1.0))
                            + delta[a1][b0] * delta[b1][d1] * delta[c0][d0] * (PQ[a0] * PQ[c1] * (-1.0))
                            + delta[b0][c0] * delta[a1][b1] * delta[d0][d1] * (PQ[a0] * PQ[c1] * (-1.0))
                            + delta[b0][d0] * delta[a1][b1] * delta[c0][d1] * (PQ[a0] * PQ[c1] * (-1.0))
                            + delta[b0][d1] * delta[a1][b1] * delta[c0][d0] * (PQ[a0] * PQ[c1] * (-1.0))
                            + delta[a1][c0] * delta[b0][b1] * delta[c1][d1] * (PQ[a0] * PQ[d0] * (-1.0))
                            + delta[a1][c0] * delta[b0][c1] * delta[b1][d1] * (PQ[a0] * PQ[d0] * (-1.0))
                            + delta[a1][c0] * delta[b0][d1] * delta[b1][c1] * (PQ[a0] * PQ[d0] * (-1.0))
                            + delta[a1][c1] * delta[b0][b1] * delta[c0][d1] * (PQ[a0] * PQ[d0] * (-1.0))
                            + delta[a1][c1] * delta[b0][c0] * delta[b1][d1] * (PQ[a0] * PQ[d0] * (-1.0))
                            + delta[a1][c1] * delta[b0][d1] * delta[b1][c0] * (PQ[a0] * PQ[d0] * (-1.0))
                            + delta[a1][d1] * delta[b0][b1] * delta[c0][c1] * (PQ[a0] * PQ[d0] * (-1.0))
                            + delta[a1][d1] * delta[b0][c0] * delta[b1][c1] * (PQ[a0] * PQ[d0] * (-1.0))
                            + delta[a1][d1] * delta[b0][c1] * delta[b1][c0] * (PQ[a0] * PQ[d0] * (-1.0))
                            + delta[a1][b0] * delta[b1][c0] * delta[c1][d1] * (PQ[a0] * PQ[d0] * (-1.0))
                            + delta[a1][b0] * delta[b1][c1] * delta[c0][d1] * (PQ[a0] * PQ[d0] * (-1.0))
                            + delta[a1][b0] * delta[b1][d1] * delta[c0][c1] * (PQ[a0] * PQ[d0] * (-1.0))
                            + delta[b0][c0] * delta[a1][b1] * delta[c1][d1] * (PQ[a0] * PQ[d0] * (-1.0))
                            + delta[b0][c1] * delta[a1][b1] * delta[c0][d1] * (PQ[a0] * PQ[d0] * (-1.0))
                            + delta[b0][d1] * delta[a1][b1] * delta[c0][c1] * (PQ[a0] * PQ[d0] * (-1.0))
                            + delta[a1][c0] * delta[b0][b1] * delta[c1][d0] * (PQ[a0] * PQ[d1] * (-1.0))
                            + delta[a1][c0] * delta[b0][c1] * delta[b1][d0] * (PQ[a0] * PQ[d1] * (-1.0))
                            + delta[a1][c0] * delta[b0][d0] * delta[b1][c1] * (PQ[a0] * PQ[d1] * (-1.0))
                            + delta[a1][c1] * delta[b0][b1] * delta[c0][d0] * (PQ[a0] * PQ[d1] * (-1.0))
                            + delta[a1][c1] * delta[b0][c0] * delta[b1][d0] * (PQ[a0] * PQ[d1] * (-1.0))
                            + delta[a1][c1] * delta[b0][d0] * delta[b1][c0] * (PQ[a0] * PQ[d1] * (-1.0))
                            + delta[a1][d0] * delta[b0][b1] * delta[c0][c1] * (PQ[a0] * PQ[d1] * (-1.0))
                            + delta[a1][d0] * delta[b0][c0] * delta[b1][c1] * (PQ[a0] * PQ[d1] * (-1.0))
                            + delta[a1][d0] * delta[b0][c1] * delta[b1][c0] * (PQ[a0] * PQ[d1] * (-1.0))
                            + delta[a1][b0] * delta[b1][c0] * delta[c1][d0] * (PQ[a0] * PQ[d1] * (-1.0))
                            + delta[a1][b0] * delta[b1][c1] * delta[c0][d0] * (PQ[a0] * PQ[d1] * (-1.0))
                            + delta[a1][b0] * delta[b1][d0] * delta[c0][c1] * (PQ[a0] * PQ[d1] * (-1.0))
                            + delta[b0][c0] * delta[a1][b1] * delta[c1][d0] * (PQ[a0] * PQ[d1] * (-1.0))
                            + delta[b0][c1] * delta[a1][b1] * delta[c0][d0] * (PQ[a0] * PQ[d1] * (-1.0))
                            + delta[b0][d0] * delta[a1][b1] * delta[c0][c1] * (PQ[a0] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[b1][c1] * delta[d0][d1] * (PQ[a1] * PQ[b0] * (-1.0))
                            + delta[a0][c0] * delta[b1][d0] * delta[c1][d1] * (PQ[a1] * PQ[b0] * (-1.0))
                            + delta[a0][c0] * delta[b1][d1] * delta[c1][d0] * (PQ[a1] * PQ[b0] * (-1.0))
                            + delta[a0][c1] * delta[b1][c0] * delta[d0][d1] * (PQ[a1] * PQ[b0] * (-1.0))
                            + delta[a0][c1] * delta[b1][d0] * delta[c0][d1] * (PQ[a1] * PQ[b0] * (-1.0))
                            + delta[a0][c1] * delta[b1][d1] * delta[c0][d0] * (PQ[a1] * PQ[b0] * (-1.0))
                            + delta[a0][d0] * delta[b1][c0] * delta[c1][d1] * (PQ[a1] * PQ[b0] * (-1.0))
                            + delta[a0][d0] * delta[b1][c1] * delta[c0][d1] * (PQ[a1] * PQ[b0] * (-1.0))
                            + delta[a0][d0] * delta[b1][d1] * delta[c0][c1] * (PQ[a1] * PQ[b0] * (-1.0))
                            + delta[a0][d1] * delta[b1][c0] * delta[c1][d0] * (PQ[a1] * PQ[b0] * (-1.0))
                            + delta[a0][d1] * delta[b1][c1] * delta[c0][d0] * (PQ[a1] * PQ[b0] * (-1.0))
                            + delta[a0][d1] * delta[b1][d0] * delta[c0][c1] * (PQ[a1] * PQ[b0] * (-1.0))
                            + delta[a0][b1] * delta[c0][c1] * delta[d0][d1] * (PQ[a1] * PQ[b0] * (-1.0))
                            + delta[a0][b1] * delta[c0][d0] * delta[c1][d1] * (PQ[a1] * PQ[b0] * (-1.0))
                            + delta[a0][b1] * delta[c1][d0] * delta[c0][d1] * (PQ[a1] * PQ[b0] * (-1.0))
                            + delta[a0][c0] * delta[b0][c1] * delta[d0][d1] * (PQ[a1] * PQ[b1] * (-1.0))
                            + delta[a0][c0] * delta[b0][d0] * delta[c1][d1] * (PQ[a1] * PQ[b1] * (-1.0))
                            + delta[a0][c0] * delta[b0][d1] * delta[c1][d0] * (PQ[a1] * PQ[b1] * (-1.0))
                            + delta[a0][c1] * delta[b0][c0] * delta[d0][d1] * (PQ[a1] * PQ[b1] * (-1.0))
                            + delta[a0][c1] * delta[b0][d0] * delta[c0][d1] * (PQ[a1] * PQ[b1] * (-1.0))
                            + delta[a0][c1] * delta[b0][d1] * delta[c0][d0] * (PQ[a1] * PQ[b1] * (-1.0))
                            + delta[a0][d0] * delta[b0][c0] * delta[c1][d1] * (PQ[a1] * PQ[b1] * (-1.0))
                            + delta[a0][d0] * delta[b0][c1] * delta[c0][d1] * (PQ[a1] * PQ[b1] * (-1.0))
                            + delta[a0][d0] * delta[b0][d1] * delta[c0][c1] * (PQ[a1] * PQ[b1] * (-1.0))
                            + delta[a0][d1] * delta[b0][c0] * delta[c1][d0] * (PQ[a1] * PQ[b1] * (-1.0))
                            + delta[a0][d1] * delta[b0][c1] * delta[c0][d0] * (PQ[a1] * PQ[b1] * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * delta[c0][c1] * (PQ[a1] * PQ[b1] * (-1.0))
                            + delta[a0][b0] * delta[c0][c1] * delta[d0][d1] * (PQ[a1] * PQ[b1] * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * delta[c1][d1] * (PQ[a1] * PQ[b1] * (-1.0))
                            + delta[a0][b0] * delta[c1][d0] * delta[c0][d1] * (PQ[a1] * PQ[b1] * (-1.0))
                            + delta[a0][c1] * delta[b0][b1] * delta[d0][d1] * (PQ[a1] * PQ[c0] * (-1.0))
                            + delta[a0][c1] * delta[b0][d0] * delta[b1][d1] * (PQ[a1] * PQ[c0] * (-1.0))
                            + delta[a0][c1] * delta[b0][d1] * delta[b1][d0] * (PQ[a1] * PQ[c0] * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * delta[c1][d1] * (PQ[a1] * PQ[c0] * (-1.0))
                            + delta[a0][d0] * delta[b0][c1] * delta[b1][d1] * (PQ[a1] * PQ[c0] * (-1.0))
                            + delta[a0][d0] * delta[b0][d1] * delta[b1][c1] * (PQ[a1] * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * delta[c1][d0] * (PQ[a1] * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[b0][c1] * delta[b1][d0] * (PQ[a1] * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * delta[b1][c1] * (PQ[a1] * PQ[c0] * (-1.0))
                            + delta[a0][b0] * delta[b1][c1] * delta[d0][d1] * (PQ[a1] * PQ[c0] * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * delta[c1][d1] * (PQ[a1] * PQ[c0] * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * delta[c1][d0] * (PQ[a1] * PQ[c0] * (-1.0))
                            + delta[b0][c1] * delta[a0][b1] * delta[d0][d1] * (PQ[a1] * PQ[c0] * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * delta[c1][d1] * (PQ[a1] * PQ[c0] * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * delta[c1][d0] * (PQ[a1] * PQ[c0] * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * delta[d0][d1] * (PQ[a1] * PQ[c1] * (-1.0))
                            + delta[a0][c0] * delta[b0][d0] * delta[b1][d1] * (PQ[a1] * PQ[c1] * (-1.0))
                            + delta[a0][c0] * delta[b0][d1] * delta[b1][d0] * (PQ[a1] * PQ[c1] * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][d1] * (PQ[a1] * PQ[c1] * (-1.0))
                            + delta[a0][d0] * delta[b0][c0] * delta[b1][d1] * (PQ[a1] * PQ[c1] * (-1.0))
                            + delta[a0][d0] * delta[b0][d1] * delta[b1][c0] * (PQ[a1] * PQ[c1] * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][d0] * (PQ[a1] * PQ[c1] * (-1.0))
                            + delta[a0][d1] * delta[b0][c0] * delta[b1][d0] * (PQ[a1] * PQ[c1] * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * delta[b1][c0] * (PQ[a1] * PQ[c1] * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * delta[d0][d1] * (PQ[a1] * PQ[c1] * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][d1] * (PQ[a1] * PQ[c1] * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][d0] * (PQ[a1] * PQ[c1] * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * delta[d0][d1] * (PQ[a1] * PQ[c1] * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][d1] * (PQ[a1] * PQ[c1] * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][d0] * (PQ[a1] * PQ[c1] * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d1] * (PQ[a1] * PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[b0][c1] * delta[b1][d1] * (PQ[a1] * PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[b0][d1] * delta[b1][c1] * (PQ[a1] * PQ[d0] * (-1.0))
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d1] * (PQ[a1] * PQ[d0] * (-1.0))
                            + delta[a0][c1] * delta[b0][c0] * delta[b1][d1] * (PQ[a1] * PQ[d0] * (-1.0))
                            + delta[a0][c1] * delta[b0][d1] * delta[b1][c0] * (PQ[a1] * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][c1] * (PQ[a1] * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[b0][c0] * delta[b1][c1] * (PQ[a1] * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[b0][c1] * delta[b1][c0] * (PQ[a1] * PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d1] * (PQ[a1] * PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d1] * (PQ[a1] * PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][c1] * (PQ[a1] * PQ[d0] * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d1] * (PQ[a1] * PQ[d0] * (-1.0))
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d1] * (PQ[a1] * PQ[d0] * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][c1] * (PQ[a1] * PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d0] * (PQ[a1] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[b0][c1] * delta[b1][d0] * (PQ[a1] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[b0][d0] * delta[b1][c1] * (PQ[a1] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d0] * (PQ[a1] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[b0][c0] * delta[b1][d0] * (PQ[a1] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[b0][d0] * delta[b1][c0] * (PQ[a1] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][c1] * (PQ[a1] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[b0][c0] * delta[b1][c1] * (PQ[a1] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[b0][c1] * delta[b1][c0] * (PQ[a1] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d0] * (PQ[a1] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d0] * (PQ[a1] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][c1] * (PQ[a1] * PQ[d1] * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d0] * (PQ[a1] * PQ[d1] * (-1.0))
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d0] * (PQ[a1] * PQ[d1] * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][c1] * (PQ[a1] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[a1][c1] * delta[d0][d1] * (PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][c0] * delta[a1][d0] * delta[c1][d1] * (PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][c0] * delta[a1][d1] * delta[c1][d0] * (PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][c1] * delta[a1][c0] * delta[d0][d1] * (PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][c1] * delta[a1][d0] * delta[c0][d1] * (PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][c1] * delta[a1][d1] * delta[c0][d0] * (PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][d0] * delta[a1][c0] * delta[c1][d1] * (PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][d0] * delta[a1][c1] * delta[c0][d1] * (PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][d0] * delta[a1][d1] * delta[c0][c1] * (PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][d1] * delta[a1][c0] * delta[c1][d0] * (PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][d1] * delta[a1][c1] * delta[c0][d0] * (PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][d1] * delta[a1][d0] * delta[c0][c1] * (PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][a1] * delta[c0][c1] * delta[d0][d1] * (PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][a1] * delta[c0][d0] * delta[c1][d1] * (PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][a1] * delta[c1][d0] * delta[c0][d1] * (PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][c1] * delta[a1][d0] * delta[b1][d1] * (PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a0][c1] * delta[a1][d1] * delta[b1][d0] * (PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a0][c1] * delta[a1][b1] * delta[d0][d1] * (PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a0][d0] * delta[a1][c1] * delta[b1][d1] * (PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a0][d0] * delta[a1][d1] * delta[b1][c1] * (PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a0][d0] * delta[a1][b1] * delta[c1][d1] * (PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[a1][c1] * delta[b1][d0] * (PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[a1][d0] * delta[b1][c1] * (PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[a1][b1] * delta[c1][d0] * (PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a0][a1] * delta[b1][c1] * delta[d0][d1] * (PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a0][a1] * delta[b1][d0] * delta[c1][d1] * (PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a0][a1] * delta[b1][d1] * delta[c1][d0] * (PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a1][c1] * delta[a0][b1] * delta[d0][d1] * (PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a1][d0] * delta[a0][b1] * delta[c1][d1] * (PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a1][d1] * delta[a0][b1] * delta[c1][d0] * (PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a0][c0] * delta[a1][d0] * delta[b1][d1] * (PQ[b0] * PQ[c1] * (-1.0))
                            + delta[a0][c0] * delta[a1][d1] * delta[b1][d0] * (PQ[b0] * PQ[c1] * (-1.0))
                            + delta[a0][c0] * delta[a1][b1] * delta[d0][d1] * (PQ[b0] * PQ[c1] * (-1.0))
                            + delta[a0][d0] * delta[a1][c0] * delta[b1][d1] * (PQ[b0] * PQ[c1] * (-1.0))
                            + delta[a0][d0] * delta[a1][d1] * delta[b1][c0] * (PQ[b0] * PQ[c1] * (-1.0))
                            + delta[a0][d0] * delta[a1][b1] * delta[c0][d1] * (PQ[b0] * PQ[c1] * (-1.0))
                            + delta[a0][d1] * delta[a1][c0] * delta[b1][d0] * (PQ[b0] * PQ[c1] * (-1.0))
                            + delta[a0][d1] * delta[a1][d0] * delta[b1][c0] * (PQ[b0] * PQ[c1] * (-1.0))
                            + delta[a0][d1] * delta[a1][b1] * delta[c0][d0] * (PQ[b0] * PQ[c1] * (-1.0))
                            + delta[a0][a1] * delta[b1][c0] * delta[d0][d1] * (PQ[b0] * PQ[c1] * (-1.0))
                            + delta[a0][a1] * delta[b1][d0] * delta[c0][d1] * (PQ[b0] * PQ[c1] * (-1.0))
                            + delta[a0][a1] * delta[b1][d1] * delta[c0][d0] * (PQ[b0] * PQ[c1] * (-1.0))
                            + delta[a1][c0] * delta[a0][b1] * delta[d0][d1] * (PQ[b0] * PQ[c1] * (-1.0))
                            + delta[a1][d0] * delta[a0][b1] * delta[c0][d1] * (PQ[b0] * PQ[c1] * (-1.0))
                            + delta[a1][d1] * delta[a0][b1] * delta[c0][d0] * (PQ[b0] * PQ[c1] * (-1.0))
                            + delta[a0][c0] * delta[a1][c1] * delta[b1][d1] * (PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[a1][d1] * delta[b1][c1] * (PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[a1][b1] * delta[c1][d1] * (PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][c1] * delta[a1][c0] * delta[b1][d1] * (PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][c1] * delta[a1][d1] * delta[b1][c0] * (PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][c1] * delta[a1][b1] * delta[c0][d1] * (PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[a1][c0] * delta[b1][c1] * (PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[a1][c1] * delta[b1][c0] * (PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[a1][b1] * delta[c0][c1] * (PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[b1][c0] * delta[c1][d1] * (PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[b1][c1] * delta[c0][d1] * (PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[b1][d1] * delta[c0][c1] * (PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a1][c0] * delta[a0][b1] * delta[c1][d1] * (PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a1][c1] * delta[a0][b1] * delta[c0][d1] * (PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a1][d1] * delta[a0][b1] * delta[c0][c1] * (PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[a1][c1] * delta[b1][d0] * (PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[a1][d0] * delta[b1][c1] * (PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[a1][b1] * delta[c1][d0] * (PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[a1][c0] * delta[b1][d0] * (PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[a1][d0] * delta[b1][c0] * (PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[a1][b1] * delta[c0][d0] * (PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[a1][c0] * delta[b1][c1] * (PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[a1][c1] * delta[b1][c0] * (PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[a1][b1] * delta[c0][c1] * (PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b1][c0] * delta[c1][d0] * (PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b1][c1] * delta[c0][d0] * (PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b1][d0] * delta[c0][c1] * (PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a1][c0] * delta[a0][b1] * delta[c1][d0] * (PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a1][c1] * delta[a0][b1] * delta[c0][d0] * (PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a1][d0] * delta[a0][b1] * delta[c0][c1] * (PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[a1][d0] * delta[b0][d1] * (PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a0][c1] * delta[a1][d1] * delta[b0][d0] * (PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a0][c1] * delta[a1][b0] * delta[d0][d1] * (PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a0][d0] * delta[a1][c1] * delta[b0][d1] * (PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a0][d0] * delta[a1][d1] * delta[b0][c1] * (PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * delta[c1][d1] * (PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[a1][c1] * delta[b0][d0] * (PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][c1] * (PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * delta[c1][d0] * (PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a0][a1] * delta[b0][c1] * delta[d0][d1] * (PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * delta[c1][d1] * (PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * delta[c1][d0] * (PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a1][c1] * delta[a0][b0] * delta[d0][d1] * (PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * delta[c1][d1] * (PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * delta[c1][d0] * (PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a0][c0] * delta[a1][d0] * delta[b0][d1] * (PQ[b1] * PQ[c1] * (-1.0))
                            + delta[a0][c0] * delta[a1][d1] * delta[b0][d0] * (PQ[b1] * PQ[c1] * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * delta[d0][d1] * (PQ[b1] * PQ[c1] * (-1.0))
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][d1] * (PQ[b1] * PQ[c1] * (-1.0))
                            + delta[a0][d0] * delta[a1][d1] * delta[b0][c0] * (PQ[b1] * PQ[c1] * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * delta[c0][d1] * (PQ[b1] * PQ[c1] * (-1.0))
                            + delta[a0][d1] * delta[a1][c0] * delta[b0][d0] * (PQ[b1] * PQ[c1] * (-1.0))
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][c0] * (PQ[b1] * PQ[c1] * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * delta[c0][d0] * (PQ[b1] * PQ[c1] * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * delta[d0][d1] * (PQ[b1] * PQ[c1] * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * delta[c0][d1] * (PQ[b1] * PQ[c1] * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * delta[c0][d0] * (PQ[b1] * PQ[c1] * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * delta[d0][d1] * (PQ[b1] * PQ[c1] * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * delta[c0][d1] * (PQ[b1] * PQ[c1] * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * delta[c0][d0] * (PQ[b1] * PQ[c1] * (-1.0))
                            + delta[a0][c0] * delta[a1][c1] * delta[b0][d1] * (PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[a1][d1] * delta[b0][c1] * (PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * delta[c1][d1] * (PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][c1] * delta[a1][c0] * delta[b0][d1] * (PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][c1] * delta[a1][d1] * delta[b0][c0] * (PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][c1] * delta[a1][b0] * delta[c0][d1] * (PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[a1][c0] * delta[b0][c1] * (PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[a1][c1] * delta[b0][c0] * (PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * delta[c0][c1] * (PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * delta[c1][d1] * (PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[b0][c1] * delta[c0][d1] * (PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * delta[c0][c1] * (PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * delta[c1][d1] * (PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a1][c1] * delta[a0][b0] * delta[c0][d1] * (PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * delta[c0][c1] * (PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[a1][c1] * delta[b0][d0] * (PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[a1][d0] * delta[b0][c1] * (PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * delta[c1][d0] * (PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[a1][c0] * delta[b0][d0] * (PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[a1][d0] * delta[b0][c0] * (PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[a1][b0] * delta[c0][d0] * (PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][c1] * (PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[a1][c1] * delta[b0][c0] * (PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * delta[c0][c1] * (PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * delta[c1][d0] * (PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b0][c1] * delta[c0][d0] * (PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * delta[c0][c1] * (PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * delta[c1][d0] * (PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a1][c1] * delta[a0][b0] * delta[c0][d0] * (PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * delta[c0][c1] * (PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[a1][d1] * delta[b0][b1] * (PQ[c0] * PQ[c1] * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][d1] * (PQ[c0] * PQ[c1] * (-1.0))
                            + delta[a0][d0] * delta[b0][d1] * delta[a1][b1] * (PQ[c0] * PQ[c1] * (-1.0))
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][b1] * (PQ[c0] * PQ[c1] * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][d0] * (PQ[c0] * PQ[c1] * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * delta[a1][b1] * (PQ[c0] * PQ[c1] * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[d0][d1] * (PQ[c0] * PQ[c1] * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][d1] * (PQ[c0] * PQ[c1] * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][d0] * (PQ[c0] * PQ[c1] * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][d1] * (PQ[c0] * PQ[c1] * (-1.0))
                            + delta[a1][d0] * delta[b0][d1] * delta[a0][b1] * (PQ[c0] * PQ[c1] * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][d0] * (PQ[c0] * PQ[c1] * (-1.0))
                            + delta[a1][d1] * delta[b0][d0] * delta[a0][b1] * (PQ[c0] * PQ[c1] * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[d0][d1] * (PQ[c0] * PQ[c1] * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[d0][d1] * (PQ[c0] * PQ[c1] * (-1.0))
                            + delta[a0][c1] * delta[a1][d1] * delta[b0][b1] * (PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][d1] * (PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][c1] * delta[b0][d1] * delta[a1][b1] * (PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[a1][c1] * delta[b0][b1] * (PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][c1] * (PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[b0][c1] * delta[a1][b1] * (PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d1] * (PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][d1] * (PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][c1] * (PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][d1] * (PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a1][c1] * delta[b0][d1] * delta[a0][b1] * (PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][c1] * (PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a1][d1] * delta[b0][c1] * delta[a0][b1] * (PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d1] * (PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d1] * (PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][c1] * delta[a1][d0] * delta[b0][b1] * (PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][d0] * (PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[b0][d0] * delta[a1][b1] * (PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[a1][c1] * delta[b0][b1] * (PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][c1] * (PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[b0][c1] * delta[a1][b1] * (PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c1][d0] * (PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][d0] * (PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][c1] * (PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][d0] * (PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a1][c1] * delta[b0][d0] * delta[a0][b1] * (PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][c1] * (PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a1][d0] * delta[b0][c1] * delta[a0][b1] * (PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c1][d0] * (PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c1][d0] * (PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[a1][d1] * delta[b0][b1] * (PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d1] * (PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[b0][d1] * delta[a1][b1] * (PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[a1][c0] * delta[b0][b1] * (PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][c0] * (PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[b0][c0] * delta[a1][b1] * (PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d1] * (PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d1] * (PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][c0] * (PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d1] * (PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a1][c0] * delta[b0][d1] * delta[a0][b1] * (PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][c0] * (PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a1][d1] * delta[b0][c0] * delta[a0][b1] * (PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d1] * (PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d1] * (PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[a1][d0] * delta[b0][b1] * (PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d0] * (PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[b0][d0] * delta[a1][b1] * (PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][b1] * (PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][c0] * (PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[b0][c0] * delta[a1][b1] * (PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * (PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d0] * (PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][c0] * (PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d0] * (PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a1][c0] * delta[b0][d0] * delta[a0][b1] * (PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][c0] * (PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a1][d0] * delta[b0][c0] * delta[a0][b1] * (PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * (PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * (PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[a1][c1] * delta[b0][b1] * (PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][c1] * (PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[b0][c1] * delta[a1][b1] * (PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[a1][c0] * delta[b0][b1] * (PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[a1][b0] * delta[b1][c0] * (PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[b0][c0] * delta[a1][b1] * (PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][c1] * (PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][c1] * (PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b0][c1] * delta[b1][c0] * (PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][c1] * (PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][c0] * delta[b0][c1] * delta[a0][b1] * (PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][c1] * delta[a0][b0] * delta[b1][c0] * (PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][c1] * delta[b0][c0] * delta[a0][b1] * (PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][c1] * (PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][c1] * (PQ[d0] * PQ[d1] * (-1.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD35(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[6];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 5, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[5] * (

                        0.25 * ( S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] + PA_1 * PQ[a0] * PQ[b0] * PQ[b1])
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] + PA_1 * PQ[a0] * PQ[b0] * PQ[b1])
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] + PA_1 * PQ[a0] * PQ[b0] * PQ[b1])
                            + delta[b1][c1] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c0] + PA_0 * PQ[a1] * PQ[b0] * PQ[c0] + PA_1 * PQ[a0] * PQ[b0] * PQ[c0])
                            + delta[b1][d0] * delta[c1][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c0] + PA_0 * PQ[a1] * PQ[b0] * PQ[c0] + PA_1 * PQ[a0] * PQ[b0] * PQ[c0])
                            + delta[b1][d1] * delta[c1][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c0] + PA_0 * PQ[a1] * PQ[b0] * PQ[c0] + PA_1 * PQ[a0] * PQ[b0] * PQ[c0])
                            + delta[b1][c0] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c1] + PA_0 * PQ[a1] * PQ[b0] * PQ[c1] + PA_1 * PQ[a0] * PQ[b0] * PQ[c1])
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c1] + PA_0 * PQ[a1] * PQ[b0] * PQ[c1] + PA_1 * PQ[a0] * PQ[b0] * PQ[c1])
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c1] + PA_0 * PQ[a1] * PQ[b0] * PQ[c1] + PA_1 * PQ[a0] * PQ[b0] * PQ[c1])
                            + delta[b1][c0] * delta[c1][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[d0] + PA_0 * PQ[a1] * PQ[b0] * PQ[d0] + PA_1 * PQ[a0] * PQ[b0] * PQ[d0])
                            + delta[b1][c1] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[d0] + PA_0 * PQ[a1] * PQ[b0] * PQ[d0] + PA_1 * PQ[a0] * PQ[b0] * PQ[d0])
                            + delta[b1][d1] * delta[c0][c1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[d0] + PA_0 * PQ[a1] * PQ[b0] * PQ[d0] + PA_1 * PQ[a0] * PQ[b0] * PQ[d0])
                            + delta[b1][c0] * delta[c1][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[d1] + PA_0 * PQ[a1] * PQ[b0] * PQ[d1] + PA_1 * PQ[a0] * PQ[b0] * PQ[d1])
                            + delta[b1][c1] * delta[c0][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[d1] + PA_0 * PQ[a1] * PQ[b0] * PQ[d1] + PA_1 * PQ[a0] * PQ[b0] * PQ[d1])
                            + delta[b1][d0] * delta[c0][c1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[d1] + PA_0 * PQ[a1] * PQ[b0] * PQ[d1] + PA_1 * PQ[a0] * PQ[b0] * PQ[d1])
                            + delta[b0][c1] * delta[d0][d1] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c0] + PA_0 * PQ[a1] * PQ[b1] * PQ[c0] + PA_1 * PQ[a0] * PQ[b1] * PQ[c0])
                            + delta[b0][d0] * delta[c1][d1] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c0] + PA_0 * PQ[a1] * PQ[b1] * PQ[c0] + PA_1 * PQ[a0] * PQ[b1] * PQ[c0])
                            + delta[b0][d1] * delta[c1][d0] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c0] + PA_0 * PQ[a1] * PQ[b1] * PQ[c0] + PA_1 * PQ[a0] * PQ[b1] * PQ[c0])
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c1] + PA_0 * PQ[a1] * PQ[b1] * PQ[c1] + PA_1 * PQ[a0] * PQ[b1] * PQ[c1])
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c1] + PA_0 * PQ[a1] * PQ[b1] * PQ[c1] + PA_1 * PQ[a0] * PQ[b1] * PQ[c1])
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c1] + PA_0 * PQ[a1] * PQ[b1] * PQ[c1] + PA_1 * PQ[a0] * PQ[b1] * PQ[c1])
                            + delta[b0][c0] * delta[c1][d1] * (PB_1 * PQ[a0] * PQ[a1] * PQ[d0] + PA_0 * PQ[a1] * PQ[b1] * PQ[d0] + PA_1 * PQ[a0] * PQ[b1] * PQ[d0])
                            + delta[b0][c1] * delta[c0][d1] * (PB_1 * PQ[a0] * PQ[a1] * PQ[d0] + PA_0 * PQ[a1] * PQ[b1] * PQ[d0] + PA_1 * PQ[a0] * PQ[b1] * PQ[d0])
                            + delta[b0][d1] * delta[c0][c1] * (PB_1 * PQ[a0] * PQ[a1] * PQ[d0] + PA_0 * PQ[a1] * PQ[b1] * PQ[d0] + PA_1 * PQ[a0] * PQ[b1] * PQ[d0])
                            + delta[b0][c0] * delta[c1][d0] * (PB_1 * PQ[a0] * PQ[a1] * PQ[d1] + PA_0 * PQ[a1] * PQ[b1] * PQ[d1] + PA_1 * PQ[a0] * PQ[b1] * PQ[d1])
                            + delta[b0][c1] * delta[c0][d0] * (PB_1 * PQ[a0] * PQ[a1] * PQ[d1] + PA_0 * PQ[a1] * PQ[b1] * PQ[d1] + PA_1 * PQ[a0] * PQ[b1] * PQ[d1])
                            + delta[b0][d0] * delta[c0][c1] * (PB_1 * PQ[a0] * PQ[a1] * PQ[d1] + PA_0 * PQ[a1] * PQ[b1] * PQ[d1] + PA_1 * PQ[a0] * PQ[b1] * PQ[d1])
                            + delta[b0][b1] * delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1] * (-1.0) + PA_0 * PQ[a1] * PQ[c0] * PQ[c1] + PA_1 * PQ[a0] * PQ[c0] * PQ[c1])
                            + delta[b0][d0] * delta[b1][d1] * (PA_0 * PQ[a1] * PQ[c0] * PQ[c1] + PA_1 * PQ[a0] * PQ[c0] * PQ[c1])
                            + delta[b0][d1] * delta[b1][d0] * (PA_0 * PQ[a1] * PQ[c0] * PQ[c1] + PA_1 * PQ[a0] * PQ[c0] * PQ[c1])
                            + delta[b0][b1] * delta[c1][d1] * (PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0] * (-1.0) + PA_0 * PQ[a1] * PQ[c0] * PQ[d0] + PA_1 * PQ[a0] * PQ[c0] * PQ[d0])
                            + delta[b0][c1] * delta[b1][d1] * (PA_0 * PQ[a1] * PQ[c0] * PQ[d0] + PA_1 * PQ[a0] * PQ[c0] * PQ[d0])
                            + delta[b0][d1] * delta[b1][c1] * (PA_0 * PQ[a1] * PQ[c0] * PQ[d0] + PA_1 * PQ[a0] * PQ[c0] * PQ[d0])
                            + delta[b0][b1] * delta[c1][d0] * (PQ[a0] * PQ[a1] * PQ[c0] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[c0] * PQ[d1] + PA_1 * PQ[a0] * PQ[c0] * PQ[d1])
                            + delta[b0][c1] * delta[b1][d0] * (PA_0 * PQ[a1] * PQ[c0] * PQ[d1] + PA_1 * PQ[a0] * PQ[c0] * PQ[d1])
                            + delta[b0][d0] * delta[b1][c1] * (PA_0 * PQ[a1] * PQ[c0] * PQ[d1] + PA_1 * PQ[a0] * PQ[c0] * PQ[d1])
                            + delta[b0][b1] * delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[c1] * PQ[d0] * (-1.0) + PA_0 * PQ[a1] * PQ[c1] * PQ[d0] + PA_1 * PQ[a0] * PQ[c1] * PQ[d0])
                            + delta[b0][c0] * delta[b1][d1] * (PA_0 * PQ[a1] * PQ[c1] * PQ[d0] + PA_1 * PQ[a0] * PQ[c1] * PQ[d0])
                            + delta[b0][d1] * delta[b1][c0] * (PA_0 * PQ[a1] * PQ[c1] * PQ[d0] + PA_1 * PQ[a0] * PQ[c1] * PQ[d0])
                            + delta[b0][b1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[c1] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[c1] * PQ[d1] + PA_1 * PQ[a0] * PQ[c1] * PQ[d1])
                            + delta[b0][c0] * delta[b1][d0] * (PA_0 * PQ[a1] * PQ[c1] * PQ[d1] + PA_1 * PQ[a0] * PQ[c1] * PQ[d1])
                            + delta[b0][d0] * delta[b1][c0] * (PA_0 * PQ[a1] * PQ[c1] * PQ[d1] + PA_1 * PQ[a0] * PQ[c1] * PQ[d1])
                            + delta[b0][b1] * delta[c0][c1] * (PQ[a0] * PQ[a1] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[d0] * PQ[d1] + PA_1 * PQ[a0] * PQ[d0] * PQ[d1])
                            + delta[b0][c0] * delta[b1][c1] * (PA_0 * PQ[a1] * PQ[d0] * PQ[d1] + PA_1 * PQ[a0] * PQ[d0] * PQ[d1])
                            + delta[b0][c1] * delta[b1][c0] * (PA_0 * PQ[a1] * PQ[d0] * PQ[d1] + PA_1 * PQ[a0] * PQ[d0] * PQ[d1])
                            + delta[a1][c1] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] + PA_0 * PQ[b0] * PQ[b1] * PQ[c0])
                            + delta[a1][d0] * delta[c1][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] + PA_0 * PQ[b0] * PQ[b1] * PQ[c0])
                            + delta[a1][d1] * delta[c1][d0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] + PA_0 * PQ[b0] * PQ[b1] * PQ[c0])
                            + delta[a1][c0] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c1] + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] + PA_0 * PQ[b0] * PQ[b1] * PQ[c1])
                            + delta[a1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c1] + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] + PA_0 * PQ[b0] * PQ[b1] * PQ[c1])
                            + delta[a1][d1] * delta[c0][d0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c1] + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] + PA_0 * PQ[b0] * PQ[b1] * PQ[c1])
                            + delta[a1][c0] * delta[c1][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[d0] + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] + PA_0 * PQ[b0] * PQ[b1] * PQ[d0])
                            + delta[a1][c1] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[d0] + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] + PA_0 * PQ[b0] * PQ[b1] * PQ[d0])
                            + delta[a1][d1] * delta[c0][c1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[d0] + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] + PA_0 * PQ[b0] * PQ[b1] * PQ[d0])
                            + delta[a1][c0] * delta[c1][d0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[d1] + PB_1 * PQ[a0] * PQ[b0] * PQ[d1] + PA_0 * PQ[b0] * PQ[b1] * PQ[d1])
                            + delta[a1][c1] * delta[c0][d0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[d1] + PB_1 * PQ[a0] * PQ[b0] * PQ[d1] + PA_0 * PQ[b0] * PQ[b1] * PQ[d1])
                            + delta[a1][d0] * delta[c0][c1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[d1] + PB_1 * PQ[a0] * PQ[b0] * PQ[d1] + PA_0 * PQ[b0] * PQ[b1] * PQ[d1])
                            + delta[a1][d0] * delta[b1][d1] * (PB_0 * PQ[a0] * PQ[c0] * PQ[c1] + PA_0 * PQ[b0] * PQ[c0] * PQ[c1])
                            + delta[a1][d1] * delta[b1][d0] * (PB_0 * PQ[a0] * PQ[c0] * PQ[c1] + PA_0 * PQ[b0] * PQ[c0] * PQ[c1])
                            + delta[a1][b1] * delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * (-1.0) + PB_0 * PQ[a0] * PQ[c0] * PQ[c1] + PA_0 * PQ[b0] * PQ[c0] * PQ[c1])
                            + delta[a1][c1] * delta[b1][d1] * (PB_0 * PQ[a0] * PQ[c0] * PQ[d0] + PA_0 * PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a1][d1] * delta[b1][c1] * (PB_0 * PQ[a0] * PQ[c0] * PQ[d0] + PA_0 * PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a1][b1] * delta[c1][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * (-1.0) + PB_0 * PQ[a0] * PQ[c0] * PQ[d0] + PA_0 * PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a1][c1] * delta[b1][d0] * (PB_0 * PQ[a0] * PQ[c0] * PQ[d1] + PA_0 * PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[a1][d0] * delta[b1][c1] * (PB_0 * PQ[a0] * PQ[c0] * PQ[d1] + PA_0 * PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[a1][b1] * delta[c1][d0] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1] * (-1.0) + PB_0 * PQ[a0] * PQ[c0] * PQ[d1] + PA_0 * PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[a1][c0] * delta[b1][d1] * (PB_0 * PQ[a0] * PQ[c1] * PQ[d0] + PA_0 * PQ[b0] * PQ[c1] * PQ[d0])
                            + delta[a1][d1] * delta[b1][c0] * (PB_0 * PQ[a0] * PQ[c1] * PQ[d0] + PA_0 * PQ[b0] * PQ[c1] * PQ[d0])
                            + delta[a1][b1] * delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] * (-1.0) + PB_0 * PQ[a0] * PQ[c1] * PQ[d0] + PA_0 * PQ[b0] * PQ[c1] * PQ[d0])
                            + delta[a1][c0] * delta[b1][d0] * (PB_0 * PQ[a0] * PQ[c1] * PQ[d1] + PA_0 * PQ[b0] * PQ[c1] * PQ[d1])
                            + delta[a1][d0] * delta[b1][c0] * (PB_0 * PQ[a0] * PQ[c1] * PQ[d1] + PA_0 * PQ[b0] * PQ[c1] * PQ[d1])
                            + delta[a1][b1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[c1] * PQ[d1] * (-1.0) + PB_0 * PQ[a0] * PQ[c1] * PQ[d1] + PA_0 * PQ[b0] * PQ[c1] * PQ[d1])
                            + delta[a1][c0] * delta[b1][c1] * (PB_0 * PQ[a0] * PQ[d0] * PQ[d1] + PA_0 * PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a1][c1] * delta[b1][c0] * (PB_0 * PQ[a0] * PQ[d0] * PQ[d1] + PA_0 * PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a1][b1] * delta[c0][c1] * (PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PQ[a0] * PQ[d0] * PQ[d1] + PA_0 * PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a1][d0] * delta[b0][d1] * (PB_1 * PQ[a0] * PQ[c0] * PQ[c1] + PA_0 * PQ[b1] * PQ[c0] * PQ[c1])
                            + delta[a1][d1] * delta[b0][d0] * (PB_1 * PQ[a0] * PQ[c0] * PQ[c1] + PA_0 * PQ[b1] * PQ[c0] * PQ[c1])
                            + delta[a1][b0] * delta[d0][d1] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * (-1.0) + PB_1 * PQ[a0] * PQ[c0] * PQ[c1] + PA_0 * PQ[b1] * PQ[c0] * PQ[c1])
                            + delta[a1][c1] * delta[b0][d1] * (PB_1 * PQ[a0] * PQ[c0] * PQ[d0] + PA_0 * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a1][d1] * delta[b0][c1] * (PB_1 * PQ[a0] * PQ[c0] * PQ[d0] + PA_0 * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a1][b0] * delta[c1][d1] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0) + PB_1 * PQ[a0] * PQ[c0] * PQ[d0] + PA_0 * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a1][c1] * delta[b0][d0] * (PB_1 * PQ[a0] * PQ[c0] * PQ[d1] + PA_0 * PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[a1][d0] * delta[b0][c1] * (PB_1 * PQ[a0] * PQ[c0] * PQ[d1] + PA_0 * PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[a1][b0] * delta[c1][d0] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[c0] * PQ[d1] + PA_0 * PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[a1][c0] * delta[b0][d1] * (PB_1 * PQ[a0] * PQ[c1] * PQ[d0] + PA_0 * PQ[b1] * PQ[c1] * PQ[d0])
                            + delta[a1][d1] * delta[b0][c0] * (PB_1 * PQ[a0] * PQ[c1] * PQ[d0] + PA_0 * PQ[b1] * PQ[c1] * PQ[d0])
                            + delta[a1][b0] * delta[c0][d1] * (PQ[a0] * PQ[b1] * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PQ[a0] * PQ[c1] * PQ[d0] + PA_0 * PQ[b1] * PQ[c1] * PQ[d0])
                            + delta[a1][c0] * delta[b0][d0] * (PB_1 * PQ[a0] * PQ[c1] * PQ[d1] + PA_0 * PQ[b1] * PQ[c1] * PQ[d1])
                            + delta[a1][d0] * delta[b0][c0] * (PB_1 * PQ[a0] * PQ[c1] * PQ[d1] + PA_0 * PQ[b1] * PQ[c1] * PQ[d1])
                            + delta[a1][b0] * delta[c0][d0] * (PQ[a0] * PQ[b1] * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[c1] * PQ[d1] + PA_0 * PQ[b1] * PQ[c1] * PQ[d1])
                            + delta[a1][c0] * delta[b0][c1] * (PB_1 * PQ[a0] * PQ[d0] * PQ[d1] + PA_0 * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a1][c1] * delta[b0][c0] * (PB_1 * PQ[a0] * PQ[d0] * PQ[d1] + PA_0 * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a1][b0] * delta[c0][c1] * (PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[d0] * PQ[d1] + PA_0 * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a1][d1] * delta[b0][b1] * (PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PA_0 * PQ[c0] * PQ[c1] * PQ[d0])
                            + delta[a1][b0] * delta[b1][d1] * (PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PA_0 * PQ[c0] * PQ[c1] * PQ[d0])
                            + delta[b0][d1] * delta[a1][b1] * (PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PA_0 * PQ[c0] * PQ[c1] * PQ[d0])
                            + delta[a1][d0] * delta[b0][b1] * (PQ[a0] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PA_0 * PQ[c0] * PQ[c1] * PQ[d1])
                            + delta[a1][b0] * delta[b1][d0] * (PQ[a0] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PA_0 * PQ[c0] * PQ[c1] * PQ[d1])
                            + delta[b0][d0] * delta[a1][b1] * (PQ[a0] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PA_0 * PQ[c0] * PQ[c1] * PQ[d1])
                            + delta[a1][c1] * delta[b0][b1] * (PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a1][b0] * delta[b1][c1] * (PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[b0][c1] * delta[a1][b1] * (PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a1][c0] * delta[b0][b1] * (PQ[a0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a1][b0] * delta[b1][c0] * (PQ[a0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[b0][c0] * delta[a1][b1] * (PQ[a0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][c1] * delta[d0][d1] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c0] + PB_1 * PQ[a1] * PQ[b0] * PQ[c0] + PA_1 * PQ[b0] * PQ[b1] * PQ[c0])
                            + delta[a0][d0] * delta[c1][d1] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c0] + PB_1 * PQ[a1] * PQ[b0] * PQ[c0] + PA_1 * PQ[b0] * PQ[b1] * PQ[c0])
                            + delta[a0][d1] * delta[c1][d0] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c0] + PB_1 * PQ[a1] * PQ[b0] * PQ[c0] + PA_1 * PQ[b0] * PQ[b1] * PQ[c0])
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c1] + PB_1 * PQ[a1] * PQ[b0] * PQ[c1] + PA_1 * PQ[b0] * PQ[b1] * PQ[c1])
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c1] + PB_1 * PQ[a1] * PQ[b0] * PQ[c1] + PA_1 * PQ[b0] * PQ[b1] * PQ[c1])
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c1] + PB_1 * PQ[a1] * PQ[b0] * PQ[c1] + PA_1 * PQ[b0] * PQ[b1] * PQ[c1])
                            + delta[a0][c0] * delta[c1][d1] * (PB_0 * PQ[a1] * PQ[b1] * PQ[d0] + PB_1 * PQ[a1] * PQ[b0] * PQ[d0] + PA_1 * PQ[b0] * PQ[b1] * PQ[d0])
                            + delta[a0][c1] * delta[c0][d1] * (PB_0 * PQ[a1] * PQ[b1] * PQ[d0] + PB_1 * PQ[a1] * PQ[b0] * PQ[d0] + PA_1 * PQ[b0] * PQ[b1] * PQ[d0])
                            + delta[a0][d1] * delta[c0][c1] * (PB_0 * PQ[a1] * PQ[b1] * PQ[d0] + PB_1 * PQ[a1] * PQ[b0] * PQ[d0] + PA_1 * PQ[b0] * PQ[b1] * PQ[d0])
                            + delta[a0][c0] * delta[c1][d0] * (PB_0 * PQ[a1] * PQ[b1] * PQ[d1] + PB_1 * PQ[a1] * PQ[b0] * PQ[d1] + PA_1 * PQ[b0] * PQ[b1] * PQ[d1])
                            + delta[a0][c1] * delta[c0][d0] * (PB_0 * PQ[a1] * PQ[b1] * PQ[d1] + PB_1 * PQ[a1] * PQ[b0] * PQ[d1] + PA_1 * PQ[b0] * PQ[b1] * PQ[d1])
                            + delta[a0][d0] * delta[c0][c1] * (PB_0 * PQ[a1] * PQ[b1] * PQ[d1] + PB_1 * PQ[a1] * PQ[b0] * PQ[d1] + PA_1 * PQ[b0] * PQ[b1] * PQ[d1])
                            + delta[a0][d0] * delta[b1][d1] * (PB_0 * PQ[a1] * PQ[c0] * PQ[c1] + PA_1 * PQ[b0] * PQ[c0] * PQ[c1])
                            + delta[a0][d1] * delta[b1][d0] * (PB_0 * PQ[a1] * PQ[c0] * PQ[c1] + PA_1 * PQ[b0] * PQ[c0] * PQ[c1])
                            + delta[a0][b1] * delta[d0][d1] * (PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * (-1.0) + PB_0 * PQ[a1] * PQ[c0] * PQ[c1] + PA_1 * PQ[b0] * PQ[c0] * PQ[c1])
                            + delta[a0][c1] * delta[b1][d1] * (PB_0 * PQ[a1] * PQ[c0] * PQ[d0] + PA_1 * PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a0][d1] * delta[b1][c1] * (PB_0 * PQ[a1] * PQ[c0] * PQ[d0] + PA_1 * PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a0][b1] * delta[c1][d1] * (PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * (-1.0) + PB_0 * PQ[a1] * PQ[c0] * PQ[d0] + PA_1 * PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a0][c1] * delta[b1][d0] * (PB_0 * PQ[a1] * PQ[c0] * PQ[d1] + PA_1 * PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[a0][d0] * delta[b1][c1] * (PB_0 * PQ[a1] * PQ[c0] * PQ[d1] + PA_1 * PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[a0][b1] * delta[c1][d0] * (PQ[a1] * PQ[b0] * PQ[c0] * PQ[d1] * (-1.0) + PB_0 * PQ[a1] * PQ[c0] * PQ[d1] + PA_1 * PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * delta[b1][d1] * (PB_0 * PQ[a1] * PQ[c1] * PQ[d0] + PA_1 * PQ[b0] * PQ[c1] * PQ[d0])
                            + delta[a0][d1] * delta[b1][c0] * (PB_0 * PQ[a1] * PQ[c1] * PQ[d0] + PA_1 * PQ[b0] * PQ[c1] * PQ[d0])
                            + delta[a0][b1] * delta[c0][d1] * (PQ[a1] * PQ[b0] * PQ[c1] * PQ[d0] * (-1.0) + PB_0 * PQ[a1] * PQ[c1] * PQ[d0] + PA_1 * PQ[b0] * PQ[c1] * PQ[d0])
                            + delta[a0][c0] * delta[b1][d0] * (PB_0 * PQ[a1] * PQ[c1] * PQ[d1] + PA_1 * PQ[b0] * PQ[c1] * PQ[d1])
                            + delta[a0][d0] * delta[b1][c0] * (PB_0 * PQ[a1] * PQ[c1] * PQ[d1] + PA_1 * PQ[b0] * PQ[c1] * PQ[d1])
                            + delta[a0][b1] * delta[c0][d0] * (PQ[a1] * PQ[b0] * PQ[c1] * PQ[d1] * (-1.0) + PB_0 * PQ[a1] * PQ[c1] * PQ[d1] + PA_1 * PQ[b0] * PQ[c1] * PQ[d1])
                            + delta[a0][c0] * delta[b1][c1] * (PB_0 * PQ[a1] * PQ[d0] * PQ[d1] + PA_1 * PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a0][c1] * delta[b1][c0] * (PB_0 * PQ[a1] * PQ[d0] * PQ[d1] + PA_1 * PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a0][b1] * delta[c0][c1] * (PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PQ[a1] * PQ[d0] * PQ[d1] + PA_1 * PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a0][d0] * delta[b0][d1] * (PB_1 * PQ[a1] * PQ[c0] * PQ[c1] + PA_1 * PQ[b1] * PQ[c0] * PQ[c1])
                            + delta[a0][d1] * delta[b0][d0] * (PB_1 * PQ[a1] * PQ[c0] * PQ[c1] + PA_1 * PQ[b1] * PQ[c0] * PQ[c1])
                            + delta[a0][b0] * delta[d0][d1] * (PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * (-1.0) + PB_1 * PQ[a1] * PQ[c0] * PQ[c1] + PA_1 * PQ[b1] * PQ[c0] * PQ[c1])
                            + delta[a0][c1] * delta[b0][d1] * (PB_1 * PQ[a1] * PQ[c0] * PQ[d0] + PA_1 * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a0][d1] * delta[b0][c1] * (PB_1 * PQ[a1] * PQ[c0] * PQ[d0] + PA_1 * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a0][b0] * delta[c1][d1] * (PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0) + PB_1 * PQ[a1] * PQ[c0] * PQ[d0] + PA_1 * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a0][c1] * delta[b0][d0] * (PB_1 * PQ[a1] * PQ[c0] * PQ[d1] + PA_1 * PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[a0][d0] * delta[b0][c1] * (PB_1 * PQ[a1] * PQ[c0] * PQ[d1] + PA_1 * PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[a0][b0] * delta[c1][d0] * (PQ[a1] * PQ[b1] * PQ[c0] * PQ[d1] * (-1.0) + PB_1 * PQ[a1] * PQ[c0] * PQ[d1] + PA_1 * PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * delta[b0][d1] * (PB_1 * PQ[a1] * PQ[c1] * PQ[d0] + PA_1 * PQ[b1] * PQ[c1] * PQ[d0])
                            + delta[a0][d1] * delta[b0][c0] * (PB_1 * PQ[a1] * PQ[c1] * PQ[d0] + PA_1 * PQ[b1] * PQ[c1] * PQ[d0])
                            + delta[a0][b0] * delta[c0][d1] * (PQ[a1] * PQ[b1] * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PQ[a1] * PQ[c1] * PQ[d0] + PA_1 * PQ[b1] * PQ[c1] * PQ[d0])
                            + delta[a0][c0] * delta[b0][d0] * (PB_1 * PQ[a1] * PQ[c1] * PQ[d1] + PA_1 * PQ[b1] * PQ[c1] * PQ[d1])
                            + delta[a0][d0] * delta[b0][c0] * (PB_1 * PQ[a1] * PQ[c1] * PQ[d1] + PA_1 * PQ[b1] * PQ[c1] * PQ[d1])
                            + delta[a0][b0] * delta[c0][d0] * (PQ[a1] * PQ[b1] * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PQ[a1] * PQ[c1] * PQ[d1] + PA_1 * PQ[b1] * PQ[c1] * PQ[d1])
                            + delta[a0][c0] * delta[b0][c1] * (PB_1 * PQ[a1] * PQ[d0] * PQ[d1] + PA_1 * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a0][c1] * delta[b0][c0] * (PB_1 * PQ[a1] * PQ[d0] * PQ[d1] + PA_1 * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * delta[c0][c1] * (PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[a1] * PQ[d0] * PQ[d1] + PA_1 * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * delta[b0][b1] * (PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PA_1 * PQ[c0] * PQ[c1] * PQ[d0])
                            + delta[a0][b0] * delta[b1][d1] * (PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PA_1 * PQ[c0] * PQ[c1] * PQ[d0])
                            + delta[b0][d1] * delta[a0][b1] * (PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PA_1 * PQ[c0] * PQ[c1] * PQ[d0])
                            + delta[a0][d0] * delta[b0][b1] * (PQ[a1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PA_1 * PQ[c0] * PQ[c1] * PQ[d1])
                            + delta[a0][b0] * delta[b1][d0] * (PQ[a1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PA_1 * PQ[c0] * PQ[c1] * PQ[d1])
                            + delta[b0][d0] * delta[a0][b1] * (PQ[a1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PA_1 * PQ[c0] * PQ[c1] * PQ[d1])
                            + delta[a0][c1] * delta[b0][b1] * (PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * delta[b1][c1] * (PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[b0][c1] * delta[a0][b1] * (PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][c0] * delta[b0][b1] * (PQ[a1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * delta[b1][c0] * (PQ[a1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[b0][c0] * delta[a0][b1] * (PQ[a1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][a1] * delta[d0][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * (-1.0) + PB_0 * PQ[b1] * PQ[c0] * PQ[c1] + PB_1 * PQ[b0] * PQ[c0] * PQ[c1])
                            + delta[a0][a1] * delta[c1][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0) + PB_0 * PQ[b1] * PQ[c0] * PQ[d0] + PB_1 * PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a0][a1] * delta[c1][d0] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * (-1.0) + PB_0 * PQ[b1] * PQ[c0] * PQ[d1] + PB_1 * PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[a0][a1] * delta[c0][d1] * (PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * (-1.0) + PB_0 * PQ[b1] * PQ[c1] * PQ[d0] + PB_1 * PQ[b0] * PQ[c1] * PQ[d0])
                            + delta[a0][a1] * delta[c0][d0] * (PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * (-1.0) + PB_0 * PQ[b1] * PQ[c1] * PQ[d1] + PB_1 * PQ[b0] * PQ[c1] * PQ[d1])
                            + delta[a0][a1] * delta[c0][c1] * (PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PQ[b1] * PQ[d0] * PQ[d1] + PB_1 * PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * delta[a1][b1] * (PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PB_0 * PQ[c0] * PQ[c1] * PQ[d0])
                            + delta[a0][a1] * delta[b1][d1] * (PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PB_0 * PQ[c0] * PQ[c1] * PQ[d0])
                            + delta[a1][d1] * delta[a0][b1] * (PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PB_0 * PQ[c0] * PQ[c1] * PQ[d0])
                            + delta[a0][d0] * delta[a1][b1] * (PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PB_0 * PQ[c0] * PQ[c1] * PQ[d1])
                            + delta[a0][a1] * delta[b1][d0] * (PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PB_0 * PQ[c0] * PQ[c1] * PQ[d1])
                            + delta[a1][d0] * delta[a0][b1] * (PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PB_0 * PQ[c0] * PQ[c1] * PQ[d1])
                            + delta[a0][c1] * delta[a1][b1] * (PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][a1] * delta[b1][c1] * (PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a1][c1] * delta[a0][b1] * (PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][c0] * delta[a1][b1] * (PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][a1] * delta[b1][c0] * (PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a1][c0] * delta[a0][b1] * (PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * delta[a1][b0] * (PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PQ[c0] * PQ[c1] * PQ[d0])
                            + delta[a0][a1] * delta[b0][d1] * (PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PQ[c0] * PQ[c1] * PQ[d0])
                            + delta[a1][d1] * delta[a0][b0] * (PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PQ[c0] * PQ[c1] * PQ[d0])
                            + delta[a0][d0] * delta[a1][b0] * (PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PQ[c0] * PQ[c1] * PQ[d1])
                            + delta[a0][a1] * delta[b0][d0] * (PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PQ[c0] * PQ[c1] * PQ[d1])
                            + delta[a1][d0] * delta[a0][b0] * (PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PQ[c0] * PQ[c1] * PQ[d1])
                            + delta[a0][c1] * delta[a1][b0] * (PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][a1] * delta[b0][c1] * (PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a1][c1] * delta[a0][b0] * (PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][c0] * delta[a1][b0] * (PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][a1] * delta[b0][c0] * (PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a1][c0] * delta[a0][b0] * (PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][a1] * delta[b0][b1] * (PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-2.0))
                            + delta[a0][b0] * delta[a1][b1] * (PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * (PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-2.0))
                            + delta[a0][d0] * delta[a1][d1] * (PB_0 * PQ[b1] * PQ[c0] * PQ[c1] + PB_1 * PQ[b0] * PQ[c0] * PQ[c1])
                            + delta[a0][d1] * delta[a1][d0] * (PB_0 * PQ[b1] * PQ[c0] * PQ[c1] + PB_1 * PQ[b0] * PQ[c0] * PQ[c1])
                            + delta[a0][c1] * delta[a1][d1] * (PB_0 * PQ[b1] * PQ[c0] * PQ[d0] + PB_1 * PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a0][d1] * delta[a1][c1] * (PB_0 * PQ[b1] * PQ[c0] * PQ[d0] + PB_1 * PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a0][c1] * delta[a1][d0] * (PB_0 * PQ[b1] * PQ[c0] * PQ[d1] + PB_1 * PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[a0][d0] * delta[a1][c1] * (PB_0 * PQ[b1] * PQ[c0] * PQ[d1] + PB_1 * PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * delta[a1][d1] * (PB_0 * PQ[b1] * PQ[c1] * PQ[d0] + PB_1 * PQ[b0] * PQ[c1] * PQ[d0])
                            + delta[a0][d1] * delta[a1][c0] * (PB_0 * PQ[b1] * PQ[c1] * PQ[d0] + PB_1 * PQ[b0] * PQ[c1] * PQ[d0])
                            + delta[a0][c0] * delta[a1][d0] * (PB_0 * PQ[b1] * PQ[c1] * PQ[d1] + PB_1 * PQ[b0] * PQ[c1] * PQ[d1])
                            + delta[a0][d0] * delta[a1][c0] * (PB_0 * PQ[b1] * PQ[c1] * PQ[d1] + PB_1 * PQ[b0] * PQ[c1] * PQ[d1])
                            + delta[a0][c0] * delta[a1][c1] * (PB_0 * PQ[b1] * PQ[d0] * PQ[d1] + PB_1 * PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a0][c1] * delta[a1][c0] * (PB_0 * PQ[b1] * PQ[d0] * PQ[d1] + PB_1 * PQ[b0] * PQ[d0] * PQ[d1])
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD36(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[6];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 5, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[5] * (

                        0.25 * ( S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * (-2.0))
                            + delta[c0][d0] * delta[c1][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * (-2.0))
                            + delta[c1][d0] * delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * (-2.0))
                            + delta[b1][c1] * delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * QC_0 * (-1.0))
                            + delta[b1][d0] * delta[c1][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * QC_0 * (-1.0))
                            + delta[b1][d1] * delta[c1][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * QC_0 * (-1.0))
                            + delta[b1][c0] * delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1] * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * QC_1 * (-1.0))
                            + delta[b1][d0] * delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1] * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * QC_1 * (-1.0))
                            + delta[b1][d1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1] * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * QC_1 * (-1.0))
                            + delta[b1][c0] * delta[c1][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * QD_0 * (-1.0))
                            + delta[b1][c1] * delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * QD_0 * (-1.0))
                            + delta[b1][d1] * delta[c0][c1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * QD_0 * (-1.0))
                            + delta[b1][c0] * delta[c1][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * QD_1 * (-1.0))
                            + delta[b1][c1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * QD_1 * (-1.0))
                            + delta[b1][d0] * delta[c0][c1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * QD_1 * (-1.0))
                            + delta[b0][c1] * delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * (-1.0) + PQ[a0] * PQ[a1] * PQ[b1] * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[c1][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * (-1.0) + PQ[a0] * PQ[a1] * PQ[b1] * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[c1][d0] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * (-1.0) + PQ[a0] * PQ[a1] * PQ[b1] * QC_0 * (-1.0))
                            + delta[b0][c0] * delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1] * (-1.0) + PQ[a0] * PQ[a1] * PQ[b1] * QC_1 * (-1.0))
                            + delta[b0][d0] * delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1] * (-1.0) + PQ[a0] * PQ[a1] * PQ[b1] * QC_1 * (-1.0))
                            + delta[b0][d1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1] * (-1.0) + PQ[a0] * PQ[a1] * PQ[b1] * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[c1][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * (-1.0) + PQ[a0] * PQ[a1] * PQ[b1] * QD_0 * (-1.0))
                            + delta[b0][c1] * delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * (-1.0) + PQ[a0] * PQ[a1] * PQ[b1] * QD_0 * (-1.0))
                            + delta[b0][d1] * delta[c0][c1] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * (-1.0) + PQ[a0] * PQ[a1] * PQ[b1] * QD_0 * (-1.0))
                            + delta[b0][c0] * delta[c1][d0] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[d1] * (-1.0) + PQ[a0] * PQ[a1] * PQ[b1] * QD_1 * (-1.0))
                            + delta[b0][c1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[d1] * (-1.0) + PQ[a0] * PQ[a1] * PQ[b1] * QD_1 * (-1.0))
                            + delta[b0][d0] * delta[c0][c1] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[d1] * (-1.0) + PQ[a0] * PQ[a1] * PQ[b1] * QD_1 * (-1.0))
                            + delta[b0][b1] * delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1] * (-1.0) + PQ[a0] * PQ[a1] * PQ[c0] * QC_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[c1] * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c1][d1] * (PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0] * (-1.0) + PQ[a0] * PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c1][d0] * (PQ[a0] * PQ[a1] * PQ[c0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[a1] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[b1][d1] * (PQ[a0] * PQ[a1] * PQ[c0] * QC_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[c1] * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[b1][d0] * (PQ[a0] * PQ[a1] * PQ[c0] * QC_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[c1] * QC_0 * (-1.0))
                            + delta[b0][c1] * delta[b1][d1] * (PQ[a0] * PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[b1][c1] * (PQ[a0] * PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][c1] * delta[b1][d0] * (PQ[a0] * PQ[a1] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[b1][c1] * (PQ[a0] * PQ[a1] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[c1] * PQ[d0] * (-1.0) + PQ[a0] * PQ[a1] * PQ[c1] * QD_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d0] * QC_1 * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[c1] * PQ[d1] * (-1.0) + PQ[a0] * PQ[a1] * PQ[c1] * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d1] * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[b1][d1] * (PQ[a0] * PQ[a1] * PQ[c1] * QD_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d0] * QC_1 * (-1.0))
                            + delta[b0][d1] * delta[b1][c0] * (PQ[a0] * PQ[a1] * PQ[c1] * QD_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d0] * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[b1][d0] * (PQ[a0] * PQ[a1] * PQ[c1] * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d1] * QC_1 * (-1.0))
                            + delta[b0][d0] * delta[b1][c0] * (PQ[a0] * PQ[a1] * PQ[c1] * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d1] * QC_1 * (-1.0))
                            + delta[b0][b1] * delta[c0][c1] * (PQ[a0] * PQ[a1] * PQ[d0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][c0] * delta[b1][c1] * (PQ[a0] * PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][c1] * delta[b1][c0] * (PQ[a0] * PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][c1] * delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[c1][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[c1][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[a1][c0] * delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * QC_1 * (-1.0))
                            + delta[a1][d1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[c1][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[a1][c1] * delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[a1][d1] * delta[c0][c1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[a1][c0] * delta[c1][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[a1][c1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[a1][d0] * delta[c0][c1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[a1][b1] * delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * (-1.0) + PQ[a0] * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a1][b1] * delta[c1][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * (-1.0) + PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][b1] * delta[c1][d0] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[b1][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[b1][d0] * (PQ[a0] * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[b1][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[b1][c1] * (PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[b1][d0] * (PQ[a0] * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[b1][c1] * (PQ[a0] * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][b1] * delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] * (-1.0) + PQ[a0] * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a1][b1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[c1] * PQ[d1] * (-1.0) + PQ[a0] * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[b1][d1] * (PQ[a0] * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a1][d1] * delta[b1][c0] * (PQ[a0] * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[b1][d0] * (PQ[a0] * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[b1][c0] * (PQ[a0] * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a1][b1] * delta[c0][c1] * (PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][c0] * delta[b1][c1] * (PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][c1] * delta[b1][c0] * (PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][b0] * delta[d0][d1] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * (-1.0) + PQ[a0] * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[c1][d1] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0) + PQ[a0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[c1][d0] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[b0][d1] * (PQ[a0] * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[b0][d0] * (PQ[a0] * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[b0][d1] * (PQ[a0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[b0][c1] * (PQ[a0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[b0][d0] * (PQ[a0] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[b0][c1] * (PQ[a0] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[c0][d1] * (PQ[a0] * PQ[b1] * PQ[c1] * PQ[d0] * (-1.0) + PQ[a0] * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[c0][d0] * (PQ[a0] * PQ[b1] * PQ[c1] * PQ[d1] * (-1.0) + PQ[a0] * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[b0][d1] * (PQ[a0] * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a1][d1] * delta[b0][c0] * (PQ[a0] * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[b0][d0] * (PQ[a0] * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a1][d0] * delta[b0][c0] * (PQ[a0] * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[c0][c1] * (PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][c0] * delta[b0][c1] * (PQ[a0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][c1] * delta[b0][c0] * (PQ[a0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][d1] * delta[b0][b1] * (PQ[a0] * PQ[c0] * PQ[c1] * QD_0 * (-1.0) + PQ[a0] * PQ[c0] * PQ[d0] * QC_1 * (-1.0) + PQ[a0] * PQ[c1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][d1] * (PQ[a0] * PQ[c0] * PQ[c1] * QD_0 * (-1.0) + PQ[a0] * PQ[c0] * PQ[d0] * QC_1 * (-1.0) + PQ[a0] * PQ[c1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[a1][b1] * (PQ[a0] * PQ[c0] * PQ[c1] * QD_0 * (-1.0) + PQ[a0] * PQ[c0] * PQ[d0] * QC_1 * (-1.0) + PQ[a0] * PQ[c1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[b0][b1] * (PQ[a0] * PQ[c0] * PQ[c1] * QD_1 * (-1.0) + PQ[a0] * PQ[c0] * PQ[d1] * QC_1 * (-1.0) + PQ[a0] * PQ[c1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][d0] * (PQ[a0] * PQ[c0] * PQ[c1] * QD_1 * (-1.0) + PQ[a0] * PQ[c0] * PQ[d1] * QC_1 * (-1.0) + PQ[a0] * PQ[c1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[a1][b1] * (PQ[a0] * PQ[c0] * PQ[c1] * QD_1 * (-1.0) + PQ[a0] * PQ[c0] * PQ[d1] * QC_1 * (-1.0) + PQ[a0] * PQ[c1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[b0][b1] * (PQ[a0] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PQ[a0] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][c1] * (PQ[a0] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PQ[a0] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][c1] * delta[a1][b1] * (PQ[a0] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PQ[a0] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][c0] * delta[b0][b1] * (PQ[a0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[a0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a1][b0] * delta[b1][c0] * (PQ[a0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[a0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[a1][b1] * (PQ[a0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[a0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][c1] * delta[d0][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * (-1.0) + PQ[a1] * PQ[b0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[c1][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * (-1.0) + PQ[a1] * PQ[b0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[c1][d0] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * (-1.0) + PQ[a1] * PQ[b0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[d0][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * (-1.0) + PQ[a1] * PQ[b0] * PQ[b1] * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[c0][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * (-1.0) + PQ[a1] * PQ[b0] * PQ[b1] * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[c0][d0] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * (-1.0) + PQ[a1] * PQ[b0] * PQ[b1] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[c1][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0) + PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[c0][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0) + PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[a0][d1] * delta[c0][c1] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0) + PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[a0][c0] * delta[c1][d0] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * (-1.0) + PQ[a1] * PQ[b0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[a0][c1] * delta[c0][d0] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * (-1.0) + PQ[a1] * PQ[b0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[a0][d0] * delta[c0][c1] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * (-1.0) + PQ[a1] * PQ[b0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[a0][b1] * delta[d0][d1] * (PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * (-1.0) + PQ[a1] * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][b1] * delta[c1][d1] * (PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * (-1.0) + PQ[a1] * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][b1] * delta[c1][d0] * (PQ[a1] * PQ[b0] * PQ[c0] * PQ[d1] * (-1.0) + PQ[a1] * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b1][d1] * (PQ[a1] * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b1][d0] * (PQ[a1] * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b1][d1] * (PQ[a1] * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b1][c1] * (PQ[a1] * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b1][d0] * (PQ[a1] * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b1][c1] * (PQ[a1] * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][b1] * delta[c0][d1] * (PQ[a1] * PQ[b0] * PQ[c1] * PQ[d0] * (-1.0) + PQ[a1] * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][b1] * delta[c0][d0] * (PQ[a1] * PQ[b0] * PQ[c1] * PQ[d1] * (-1.0) + PQ[a1] * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[b1][d1] * (PQ[a1] * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[b1][c0] * (PQ[a1] * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[b1][d0] * (PQ[a1] * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[b1][c0] * (PQ[a1] * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][b1] * delta[c0][c1] * (PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1] * (-1.0) + PQ[a1] * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c0] * delta[b1][c1] * (PQ[a1] * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[b1][c0] * (PQ[a1] * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * (-1.0) + PQ[a1] * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c1][d1] * (PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0) + PQ[a1] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c1][d0] * (PQ[a1] * PQ[b1] * PQ[c0] * PQ[d1] * (-1.0) + PQ[a1] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b0][d1] * (PQ[a1] * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * (PQ[a1] * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][d1] * (PQ[a1] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][c1] * (PQ[a1] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][d0] * (PQ[a1] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b0][c1] * (PQ[a1] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c0][d1] * (PQ[a1] * PQ[b1] * PQ[c1] * PQ[d0] * (-1.0) + PQ[a1] * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (PQ[a1] * PQ[b1] * PQ[c1] * PQ[d1] * (-1.0) + PQ[a1] * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[b0][d1] * (PQ[a1] * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[b0][c0] * (PQ[a1] * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[b0][d0] * (PQ[a1] * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][c0] * (PQ[a1] * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[c0][c1] * (PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0) + PQ[a1] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c0] * delta[b0][c1] * (PQ[a1] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][c0] * (PQ[a1] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * (PQ[a1] * PQ[c0] * PQ[c1] * QD_0 * (-1.0) + PQ[a1] * PQ[c0] * PQ[d0] * QC_1 * (-1.0) + PQ[a1] * PQ[c1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * (PQ[a1] * PQ[c0] * PQ[c1] * QD_0 * (-1.0) + PQ[a1] * PQ[c0] * PQ[d0] * QC_1 * (-1.0) + PQ[a1] * PQ[c1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * (PQ[a1] * PQ[c0] * PQ[c1] * QD_0 * (-1.0) + PQ[a1] * PQ[c0] * PQ[d0] * QC_1 * (-1.0) + PQ[a1] * PQ[c1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * (PQ[a1] * PQ[c0] * PQ[c1] * QD_1 * (-1.0) + PQ[a1] * PQ[c0] * PQ[d1] * QC_1 * (-1.0) + PQ[a1] * PQ[c1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * (PQ[a1] * PQ[c0] * PQ[c1] * QD_1 * (-1.0) + PQ[a1] * PQ[c0] * PQ[d1] * QC_1 * (-1.0) + PQ[a1] * PQ[c1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * (PQ[a1] * PQ[c0] * PQ[c1] * QD_1 * (-1.0) + PQ[a1] * PQ[c0] * PQ[d1] * QC_1 * (-1.0) + PQ[a1] * PQ[c1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][b1] * (PQ[a1] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PQ[a1] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PQ[a1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][c1] * (PQ[a1] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PQ[a1] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PQ[a1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][c1] * delta[a0][b1] * (PQ[a1] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PQ[a1] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PQ[a1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * (PQ[a1] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[a1] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[a1] * PQ[d0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * (PQ[a1] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[a1] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[a1] * PQ[d0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * (PQ[a1] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[a1] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[a1] * PQ[d0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[d0][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * (-1.0) + PQ[b0] * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[c1][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0) + PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[c1][d0] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * (-1.0) + PQ[b0] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[a1][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][d0] * (PQ[b0] * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[a1][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][c1] * (PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[a1][d0] * (PQ[b0] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[a1][c1] * (PQ[b0] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[c0][d1] * (PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * (-1.0) + PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[c0][d0] * (PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * (-1.0) + PQ[b0] * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[a1][d1] * (PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[a1][c0] * (PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[a1][d0] * (PQ[b0] * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[a1][c0] * (PQ[b0] * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[c0][c1] * (PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0) + PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][c1] * (PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[a1][c0] * (PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][b1] * (PQ[b0] * PQ[c0] * PQ[c1] * QD_0 * (-1.0) + PQ[b0] * PQ[c0] * PQ[d0] * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][d1] * (PQ[b0] * PQ[c0] * PQ[c1] * QD_0 * (-1.0) + PQ[b0] * PQ[c0] * PQ[d0] * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[a0][b1] * (PQ[b0] * PQ[c0] * PQ[c1] * QD_0 * (-1.0) + PQ[b0] * PQ[c0] * PQ[d0] * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[a1][b1] * (PQ[b0] * PQ[c0] * PQ[c1] * QD_1 * (-1.0) + PQ[b0] * PQ[c0] * PQ[d1] * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][d0] * (PQ[b0] * PQ[c0] * PQ[c1] * QD_1 * (-1.0) + PQ[b0] * PQ[c0] * PQ[d1] * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[a0][b1] * (PQ[b0] * PQ[c0] * PQ[c1] * QD_1 * (-1.0) + PQ[b0] * PQ[c0] * PQ[d1] * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[a1][b1] * (PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][c1] * (PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[a0][b1] * (PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][b1] * (PQ[b0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[b0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b1][c0] * (PQ[b0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[b0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[a0][b1] * (PQ[b0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[b0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * (PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * (-1.0) + PQ[b1] * PQ[c0] * PQ[d0] * QC_1 * (-1.0) + PQ[b1] * PQ[c1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * (PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * (-1.0) + PQ[b1] * PQ[c0] * PQ[d0] * QC_1 * (-1.0) + PQ[b1] * PQ[c1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * (PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * (-1.0) + PQ[b1] * PQ[c0] * PQ[d0] * QC_1 * (-1.0) + PQ[b1] * PQ[c1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * (PQ[b1] * PQ[c0] * PQ[c1] * QD_1 * (-1.0) + PQ[b1] * PQ[c0] * PQ[d1] * QC_1 * (-1.0) + PQ[b1] * PQ[c1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * (PQ[b1] * PQ[c0] * PQ[c1] * QD_1 * (-1.0) + PQ[b1] * PQ[c0] * PQ[d1] * QC_1 * (-1.0) + PQ[b1] * PQ[c1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * (PQ[b1] * PQ[c0] * PQ[c1] * QD_1 * (-1.0) + PQ[b1] * PQ[c0] * PQ[d1] * QC_1 * (-1.0) + PQ[b1] * PQ[c1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[a1][b0] * (PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][c1] * (PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][c1] * delta[a0][b0] * (PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * (PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[b1] * PQ[d0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * (PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[b1] * PQ[d0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * (PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[b1] * PQ[d0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * (PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * (PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * (PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                        )

                    )

                    +

                    F8_t[5] * (

                        0.5 * ( S1 * S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1] * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * (-1.0))
                            + delta[c1][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0] * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[c1][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d1] * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d1] * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1] * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c1] * PQ[d0] * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d0] * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[c0][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c1] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d1] * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c1] * PQ[d1] * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[c0][c1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b1][d1] * (PB_0 * PA_0 * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[b1][d0] * (PB_0 * PA_0 * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[b1][c1] * (PB_0 * PA_0 * PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b1][c0] * (PB_0 * PA_0 * PQ[a1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][d1] * (PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[b0][c1] * (PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][c0] * (PB_1 * PA_0 * PQ[a1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][b1] * (PA_0 * PA_1 * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] + PA_1 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a1][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a1][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a1][c1] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][c0] * (PB_0 * PB_1 * PQ[a0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][b1] * (PB_0 * PA_0 * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] + PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a1][b0] * (PB_1 * PA_0 * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] + PA_0 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * (PB_0 * PB_1 * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][d0] * (PB_0 * PB_1 * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * (PB_0 * PB_1 * PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * (PB_0 * PB_1 * PQ[a1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b1] * (PB_0 * PA_1 * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] + PA_1 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * (PB_1 * PA_1 * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] + PA_1 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][a1] * (PB_0 * PB_1 * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] + PB_1 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD37(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[6];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 5, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[5] * (

                        0.5 * ( S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * QC_1 + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1] * QC_0 + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * QC_1 + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1] * QC_0 + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * QC_1 + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * QC_0 + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * QC_1 + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * QC_0)
                            + delta[c1][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * QD_0 + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * QC_0 + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * QD_0 + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * QC_0 + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * QC_0 + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * QC_0)
                            + delta[c1][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d1] + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * QD_1 + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d1] * QC_0 + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d1] + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * QD_1 + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d1] * QC_0 + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * QD_1 + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * QC_0 + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * QD_1 + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * QC_0)
                            + delta[c0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d0] + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1] * QD_0 + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * QC_1 + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d0] + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1] * QD_0 + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * QC_1 + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * QD_0 + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * QC_1 + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * QD_0 + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * QC_1)
                            + delta[c0][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d1] + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1] * QD_1 + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d1] * QC_1 + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d1] + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1] * QD_1 + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d1] * QC_1 + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * QD_1 + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * QC_1 + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * QD_1 + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * QC_1)
                            + delta[c0][c1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1] + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * QD_1 + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d1] * QD_0 + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1] + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * QD_1 + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d1] * QD_0 + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * QD_0)
                            + delta[b1][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1] * QD_0 + PB_0 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0] * QC_1 + PB_0 * PQ[a0] * PQ[a1] * PQ[c1] * PQ[d0] * QC_0 + PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 + PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * QC_1 + PA_0 * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d0] * QC_0 + PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 + PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * QC_1 + PA_1 * PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[b1][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1] * QD_1 + PB_0 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[d1] * QC_1 + PB_0 * PQ[a0] * PQ[a1] * PQ[c1] * PQ[d1] * QC_0 + PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * QD_1 + PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d1] * QC_1 + PA_0 * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d1] * QC_0 + PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * QD_1 + PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1] * QC_1 + PA_1 * PQ[a0] * PQ[b0] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[b1][c1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PQ[a0] * PQ[a1] * PQ[d0] * PQ[d1] * QC_0 + PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 + PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 + PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1] * QC_0 + PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 + PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 + PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[b1][c0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PQ[a0] * PQ[a1] * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PQ[a0] * PQ[a1] * PQ[d0] * PQ[d1] * QC_1 + PA_0 * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 + PA_0 * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 + PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1] * QC_1 + PA_1 * PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 + PA_1 * PQ[a0] * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 + PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[b0][d1] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1] * QD_0 + PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0] * QC_1 + PB_1 * PQ[a0] * PQ[a1] * PQ[c1] * PQ[d0] * QC_0 + PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 + PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * QC_1 + PA_0 * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d0] * QC_0 + PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 + PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * QC_1 + PA_1 * PQ[a0] * PQ[b1] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[b0][d0] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1] * QD_1 + PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[d1] * QC_1 + PB_1 * PQ[a0] * PQ[a1] * PQ[c1] * PQ[d1] * QC_0 + PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * QD_1 + PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d1] * QC_1 + PA_0 * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d1] * QC_0 + PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_1 + PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d1] * QC_1 + PA_1 * PQ[a0] * PQ[b1] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[b0][c1] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0] * QD_1 + PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[d1] * QD_0 + PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * PQ[d1] * QC_0 + PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 + PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 + PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 + PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 + PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 + PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[b0][c0] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c1] * PQ[d0] * QD_1 + PB_1 * PQ[a0] * PQ[a1] * PQ[c1] * PQ[d1] * QD_0 + PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * PQ[d1] * QC_1 + PA_0 * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 + PA_0 * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 + PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1] * QC_1 + PA_1 * PQ[a0] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 + PA_1 * PQ[a0] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 + PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[b0][b1] * (PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PA_0 * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PA_0 * PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PA_0 * PQ[a1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 + PA_1 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PA_1 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PA_1 * PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PA_1 * PQ[a0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a1][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 + PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * QC_1 + PB_0 * PQ[a0] * PQ[b1] * PQ[c1] * PQ[d0] * QC_0 + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * QC_1 + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] * QC_0 + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QC_1 + PA_0 * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a1][d0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_1 + PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d1] * QC_1 + PB_0 * PQ[a0] * PQ[b1] * PQ[c1] * PQ[d1] * QC_0 + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * QD_1 + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1] * QC_1 + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] * PQ[d1] * QC_0 + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_1 + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QC_1 + PA_0 * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a1][c1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1] * QC_0 + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a1][c0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PQ[a0] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_1 + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1] * QC_1 + PA_0 * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 + PA_0 * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a1][b1] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PB_0 * PQ[a0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 + PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PA_0 * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PA_0 * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a1][b0] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PB_1 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PB_1 * PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PB_1 * PQ[a0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 + PA_0 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PA_0 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PA_0 * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PA_0 * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][d1] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 + PB_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * QC_1 + PB_0 * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d0] * QC_0 + PB_1 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 + PB_1 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * QC_1 + PB_1 * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d0] * QC_0 + PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 + PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QC_1 + PA_1 * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a0][d0] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * QD_1 + PB_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d1] * QC_1 + PB_0 * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d1] * QC_0 + PB_1 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * QD_1 + PB_1 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d1] * QC_1 + PB_1 * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d1] * QC_0 + PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_1 + PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QC_1 + PA_1 * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a0][c1] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 + PB_1 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 + PB_1 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 + PB_1 * PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1] * QC_0 + PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 + PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 + PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][c0] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1] * QC_1 + PB_1 * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 + PB_1 * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 + PB_1 * PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1] * QC_1 + PA_1 * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 + PA_1 * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 + PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a0][b1] * (PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PB_0 * PQ[a1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 + PA_1 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PA_1 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PA_1 * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PA_1 * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][b0] * (PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PB_1 * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PB_1 * PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PB_1 * PQ[a1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 + PA_1 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PA_1 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PA_1 * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PA_1 * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][a1] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PB_0 * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 + PB_1 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PB_1 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PB_1 * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PB_1 * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD38(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[7];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 6, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[5] * (

                        0.5 * ( S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * QC_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * QC_0 * QC_1 * (-1.0))
                            + delta[c1][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * QC_0 * (-1.0))
                            + delta[c1][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * QD_1 * QC_0 * (-1.0))
                            + delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * QC_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * QC_1 * (-1.0))
                            + delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * QC_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * QD_1 * QC_1 * (-1.0))
                            + delta[c0][c1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * QD_1 * (-1.0))
                            + delta[b1][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[b1][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[b1][c1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[b1][c0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b0] * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[b0][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][d0] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b1] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][c1] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[b0][c0] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[b1] * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[b0][b1] * (PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a1][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[a1][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a1][c1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a1][c0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[a1][b1] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a1][b0] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][d0] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][c1] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][c0] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[a0][b1] * (PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[a1] * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * (PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[a1] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][a1] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                        )

                    )

                    +

                    F8_t[6] * (

                        ( S1 * S1 * S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                        )

                    )

                    +

                    F8_t[6] * (

                        ( S1 * S1 * S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                        )

                    )

                    +

                    F8_t[6] * (

                        ( S1 * S1 * S2 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD39(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[7];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 6, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[6] * (

                        0.5 * ( S1 * S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * (-1.0))
                            + delta[c1][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[c1][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[c0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d0] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[c0][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[c0][c1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b1][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[b1][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[b1][c1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b1][c0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][d1] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[b0][c1] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][c0] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][b1] * (PA_0 * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a1][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a1][d0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a1][c1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][c0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][b1] * (PB_0 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a1][b0] * (PB_1 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][d0] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b1] * (PB_0 * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * (PB_1 * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][a1] * (PB_0 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD40(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[7];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 6, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[6] * (

                        0.5 * ( S1 * S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * QC_1 + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * QC_0)
                            + delta[c1][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * QC_0)
                            + delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * QD_0 + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * QC_1)
                            + delta[c1][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * QD_1 + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * QC_0)
                            + delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * QD_1 + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * QC_1)
                            + delta[b1][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 + PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * QC_1 + PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[b1][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * QD_1 + PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d1] * QC_1 + PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[b1][c1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 + PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 + PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[b1][c0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 + PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 + PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[b0][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 + PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * QC_1 + PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[b0][d0] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * QD_1 + PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d1] * QC_1 + PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[b0][c1] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 + PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 + PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[b0][c0] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 + PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 + PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[b0][b1] * (PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PQ[a0] * PQ[a1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a1][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QC_1 + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a1][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_1 + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QC_1 + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a1][c1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a1][c0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a1][b1] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a1][b0] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PQ[a0] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 + PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QC_1 + PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a0][d0] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_1 + PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QC_1 + PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a0][c1] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 + PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 + PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][c0] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 + PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 + PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a0][b1] * (PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PQ[a1] * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][b0] * (PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PQ[a1] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][a1] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[c0][c1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * QD_0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD41(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[8];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 7, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[6] * (

                        0.25 * ( S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1])
                            + delta[c0][d0] * delta[c1][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1])
                            + delta[c1][d0] * delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1])
                            + delta[b1][c1] * delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0])
                            + delta[b1][d0] * delta[c1][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0])
                            + delta[b1][d1] * delta[c1][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0])
                            + delta[b1][c0] * delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1])
                            + delta[b1][d0] * delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1])
                            + delta[b1][d1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1])
                            + delta[b1][c0] * delta[c1][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0])
                            + delta[b1][c1] * delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0])
                            + delta[b1][d1] * delta[c0][c1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0])
                            + delta[b1][c0] * delta[c1][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[d1])
                            + delta[b1][c1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[d1])
                            + delta[b1][d0] * delta[c0][c1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[d1])
                            + delta[b0][c1] * delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0])
                            + delta[b0][d0] * delta[c1][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0])
                            + delta[b0][d1] * delta[c1][d0] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0])
                            + delta[b0][c0] * delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1])
                            + delta[b0][d0] * delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1])
                            + delta[b0][d1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1])
                            + delta[b0][c0] * delta[c1][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0])
                            + delta[b0][c1] * delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0])
                            + delta[b0][d1] * delta[c0][c1] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0])
                            + delta[b0][c0] * delta[c1][d0] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[d1])
                            + delta[b0][c1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[d1])
                            + delta[b0][d0] * delta[c0][c1] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[d1])
                            + delta[b0][b1] * delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1])
                            + delta[b0][d0] * delta[b1][d1] * (PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1])
                            + delta[b0][d1] * delta[b1][d0] * (PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1])
                            + delta[b0][b1] * delta[c1][d1] * (PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0])
                            + delta[b0][c1] * delta[b1][d1] * (PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0])
                            + delta[b0][d1] * delta[b1][c1] * (PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0])
                            + delta[b0][b1] * delta[c1][d0] * (PQ[a0] * PQ[a1] * PQ[c0] * PQ[d1])
                            + delta[b0][c1] * delta[b1][d0] * (PQ[a0] * PQ[a1] * PQ[c0] * PQ[d1])
                            + delta[b0][d0] * delta[b1][c1] * (PQ[a0] * PQ[a1] * PQ[c0] * PQ[d1])
                            + delta[b0][b1] * delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[c1] * PQ[d0])
                            + delta[b0][c0] * delta[b1][d1] * (PQ[a0] * PQ[a1] * PQ[c1] * PQ[d0])
                            + delta[b0][d1] * delta[b1][c0] * (PQ[a0] * PQ[a1] * PQ[c1] * PQ[d0])
                            + delta[b0][b1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[c1] * PQ[d1])
                            + delta[b0][c0] * delta[b1][d0] * (PQ[a0] * PQ[a1] * PQ[c1] * PQ[d1])
                            + delta[b0][d0] * delta[b1][c0] * (PQ[a0] * PQ[a1] * PQ[c1] * PQ[d1])
                            + delta[b0][b1] * delta[c0][c1] * (PQ[a0] * PQ[a1] * PQ[d0] * PQ[d1])
                            + delta[b0][c0] * delta[b1][c1] * (PQ[a0] * PQ[a1] * PQ[d0] * PQ[d1])
                            + delta[b0][c1] * delta[b1][c0] * (PQ[a0] * PQ[a1] * PQ[d0] * PQ[d1])
                            + delta[a1][c1] * delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0])
                            + delta[a1][d0] * delta[c1][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0])
                            + delta[a1][d1] * delta[c1][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0])
                            + delta[a1][c0] * delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1])
                            + delta[a1][d0] * delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1])
                            + delta[a1][d1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1])
                            + delta[a1][c0] * delta[c1][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0])
                            + delta[a1][c1] * delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0])
                            + delta[a1][d1] * delta[c0][c1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0])
                            + delta[a1][c0] * delta[c1][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1])
                            + delta[a1][c1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1])
                            + delta[a1][d0] * delta[c0][c1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1])
                            + delta[a1][d0] * delta[b1][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1])
                            + delta[a1][d1] * delta[b1][d0] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1])
                            + delta[a1][b1] * delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1])
                            + delta[a1][c1] * delta[b1][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a1][d1] * delta[b1][c1] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a1][b1] * delta[c1][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a1][c1] * delta[b1][d0] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[a1][d0] * delta[b1][c1] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[a1][b1] * delta[c1][d0] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[a1][c0] * delta[b1][d1] * (PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0])
                            + delta[a1][d1] * delta[b1][c0] * (PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0])
                            + delta[a1][b1] * delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0])
                            + delta[a1][c0] * delta[b1][d0] * (PQ[a0] * PQ[b0] * PQ[c1] * PQ[d1])
                            + delta[a1][d0] * delta[b1][c0] * (PQ[a0] * PQ[b0] * PQ[c1] * PQ[d1])
                            + delta[a1][b1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[c1] * PQ[d1])
                            + delta[a1][c0] * delta[b1][c1] * (PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a1][c1] * delta[b1][c0] * (PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a1][b1] * delta[c0][c1] * (PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a1][d0] * delta[b0][d1] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1])
                            + delta[a1][d1] * delta[b0][d0] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1])
                            + delta[a1][b0] * delta[d0][d1] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1])
                            + delta[a1][c1] * delta[b0][d1] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a1][d1] * delta[b0][c1] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a1][b0] * delta[c1][d1] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a1][c1] * delta[b0][d0] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[a1][d0] * delta[b0][c1] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[a1][b0] * delta[c1][d0] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[a1][c0] * delta[b0][d1] * (PQ[a0] * PQ[b1] * PQ[c1] * PQ[d0])
                            + delta[a1][d1] * delta[b0][c0] * (PQ[a0] * PQ[b1] * PQ[c1] * PQ[d0])
                            + delta[a1][b0] * delta[c0][d1] * (PQ[a0] * PQ[b1] * PQ[c1] * PQ[d0])
                            + delta[a1][c0] * delta[b0][d0] * (PQ[a0] * PQ[b1] * PQ[c1] * PQ[d1])
                            + delta[a1][d0] * delta[b0][c0] * (PQ[a0] * PQ[b1] * PQ[c1] * PQ[d1])
                            + delta[a1][b0] * delta[c0][d0] * (PQ[a0] * PQ[b1] * PQ[c1] * PQ[d1])
                            + delta[a1][c0] * delta[b0][c1] * (PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a1][c1] * delta[b0][c0] * (PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a1][b0] * delta[c0][c1] * (PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a1][d1] * delta[b0][b1] * (PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0])
                            + delta[a1][b0] * delta[b1][d1] * (PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0])
                            + delta[b0][d1] * delta[a1][b1] * (PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0])
                            + delta[a1][d0] * delta[b0][b1] * (PQ[a0] * PQ[c0] * PQ[c1] * PQ[d1])
                            + delta[a1][b0] * delta[b1][d0] * (PQ[a0] * PQ[c0] * PQ[c1] * PQ[d1])
                            + delta[b0][d0] * delta[a1][b1] * (PQ[a0] * PQ[c0] * PQ[c1] * PQ[d1])
                            + delta[a1][c1] * delta[b0][b1] * (PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a1][b0] * delta[b1][c1] * (PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[b0][c1] * delta[a1][b1] * (PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a1][c0] * delta[b0][b1] * (PQ[a0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a1][b0] * delta[b1][c0] * (PQ[a0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[b0][c0] * delta[a1][b1] * (PQ[a0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][c1] * delta[d0][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0])
                            + delta[a0][d0] * delta[c1][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0])
                            + delta[a0][d1] * delta[c1][d0] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0])
                            + delta[a0][c0] * delta[d0][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1])
                            + delta[a0][d0] * delta[c0][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1])
                            + delta[a0][d1] * delta[c0][d0] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1])
                            + delta[a0][c0] * delta[c1][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0])
                            + delta[a0][c1] * delta[c0][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0])
                            + delta[a0][d1] * delta[c0][c1] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0])
                            + delta[a0][c0] * delta[c1][d0] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1])
                            + delta[a0][c1] * delta[c0][d0] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1])
                            + delta[a0][d0] * delta[c0][c1] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1])
                            + delta[a0][d0] * delta[b1][d1] * (PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1])
                            + delta[a0][d1] * delta[b1][d0] * (PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1])
                            + delta[a0][b1] * delta[d0][d1] * (PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1])
                            + delta[a0][c1] * delta[b1][d1] * (PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a0][d1] * delta[b1][c1] * (PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a0][b1] * delta[c1][d1] * (PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a0][c1] * delta[b1][d0] * (PQ[a1] * PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[a0][d0] * delta[b1][c1] * (PQ[a1] * PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[a0][b1] * delta[c1][d0] * (PQ[a1] * PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * delta[b1][d1] * (PQ[a1] * PQ[b0] * PQ[c1] * PQ[d0])
                            + delta[a0][d1] * delta[b1][c0] * (PQ[a1] * PQ[b0] * PQ[c1] * PQ[d0])
                            + delta[a0][b1] * delta[c0][d1] * (PQ[a1] * PQ[b0] * PQ[c1] * PQ[d0])
                            + delta[a0][c0] * delta[b1][d0] * (PQ[a1] * PQ[b0] * PQ[c1] * PQ[d1])
                            + delta[a0][d0] * delta[b1][c0] * (PQ[a1] * PQ[b0] * PQ[c1] * PQ[d1])
                            + delta[a0][b1] * delta[c0][d0] * (PQ[a1] * PQ[b0] * PQ[c1] * PQ[d1])
                            + delta[a0][c0] * delta[b1][c1] * (PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a0][c1] * delta[b1][c0] * (PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a0][b1] * delta[c0][c1] * (PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a0][d0] * delta[b0][d1] * (PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1])
                            + delta[a0][d1] * delta[b0][d0] * (PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1])
                            + delta[a0][b0] * delta[d0][d1] * (PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1])
                            + delta[a0][c1] * delta[b0][d1] * (PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a0][d1] * delta[b0][c1] * (PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a0][b0] * delta[c1][d1] * (PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a0][c1] * delta[b0][d0] * (PQ[a1] * PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[a0][d0] * delta[b0][c1] * (PQ[a1] * PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[a0][b0] * delta[c1][d0] * (PQ[a1] * PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * delta[b0][d1] * (PQ[a1] * PQ[b1] * PQ[c1] * PQ[d0])
                            + delta[a0][d1] * delta[b0][c0] * (PQ[a1] * PQ[b1] * PQ[c1] * PQ[d0])
                            + delta[a0][b0] * delta[c0][d1] * (PQ[a1] * PQ[b1] * PQ[c1] * PQ[d0])
                            + delta[a0][c0] * delta[b0][d0] * (PQ[a1] * PQ[b1] * PQ[c1] * PQ[d1])
                            + delta[a0][d0] * delta[b0][c0] * (PQ[a1] * PQ[b1] * PQ[c1] * PQ[d1])
                            + delta[a0][b0] * delta[c0][d0] * (PQ[a1] * PQ[b1] * PQ[c1] * PQ[d1])
                            + delta[a0][c0] * delta[b0][c1] * (PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a0][c1] * delta[b0][c0] * (PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * delta[c0][c1] * (PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * delta[b0][b1] * (PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0])
                            + delta[a0][b0] * delta[b1][d1] * (PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0])
                            + delta[b0][d1] * delta[a0][b1] * (PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0])
                            + delta[a0][d0] * delta[b0][b1] * (PQ[a1] * PQ[c0] * PQ[c1] * PQ[d1])
                            + delta[a0][b0] * delta[b1][d0] * (PQ[a1] * PQ[c0] * PQ[c1] * PQ[d1])
                            + delta[b0][d0] * delta[a0][b1] * (PQ[a1] * PQ[c0] * PQ[c1] * PQ[d1])
                            + delta[a0][c1] * delta[b0][b1] * (PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * delta[b1][c1] * (PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[b0][c1] * delta[a0][b1] * (PQ[a1] * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][c0] * delta[b0][b1] * (PQ[a1] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * delta[b1][c0] * (PQ[a1] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[b0][c0] * delta[a0][b1] * (PQ[a1] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][d0] * delta[a1][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1])
                            + delta[a0][d1] * delta[a1][d0] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1])
                            + delta[a0][a1] * delta[d0][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1])
                            + delta[a0][c1] * delta[a1][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a0][d1] * delta[a1][c1] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a0][a1] * delta[c1][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a0][c1] * delta[a1][d0] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[a0][d0] * delta[a1][c1] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[a0][a1] * delta[c1][d0] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * delta[a1][d1] * (PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0])
                            + delta[a0][d1] * delta[a1][c0] * (PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0])
                            + delta[a0][a1] * delta[c0][d1] * (PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0])
                            + delta[a0][c0] * delta[a1][d0] * (PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1])
                            + delta[a0][d0] * delta[a1][c0] * (PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1])
                            + delta[a0][a1] * delta[c0][d0] * (PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1])
                            + delta[a0][c0] * delta[a1][c1] * (PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a0][c1] * delta[a1][c0] * (PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a0][a1] * delta[c0][c1] * (PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * delta[a1][b1] * (PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0])
                            + delta[a0][a1] * delta[b1][d1] * (PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0])
                            + delta[a1][d1] * delta[a0][b1] * (PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0])
                            + delta[a0][d0] * delta[a1][b1] * (PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1])
                            + delta[a0][a1] * delta[b1][d0] * (PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1])
                            + delta[a1][d0] * delta[a0][b1] * (PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1])
                            + delta[a0][c1] * delta[a1][b1] * (PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][a1] * delta[b1][c1] * (PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a1][c1] * delta[a0][b1] * (PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][c0] * delta[a1][b1] * (PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][a1] * delta[b1][c0] * (PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a1][c0] * delta[a0][b1] * (PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * delta[a1][b0] * (PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0])
                            + delta[a0][a1] * delta[b0][d1] * (PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0])
                            + delta[a1][d1] * delta[a0][b0] * (PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0])
                            + delta[a0][d0] * delta[a1][b0] * (PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1])
                            + delta[a0][a1] * delta[b0][d0] * (PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1])
                            + delta[a1][d0] * delta[a0][b0] * (PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1])
                            + delta[a0][c1] * delta[a1][b0] * (PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][a1] * delta[b0][c1] * (PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a1][c1] * delta[a0][b0] * (PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][c0] * delta[a1][b0] * (PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][a1] * delta[b0][c0] * (PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a1][c0] * delta[a0][b0] * (PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][a1] * delta[b0][b1] * (PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * delta[a1][b1] * (PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a1][b0] * delta[a0][b1] * (PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                        )

                    )

                    +

                    F8_t[7] * (

                        ( S1 * S1 * S1 * S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                        )

                    )

                    +

                    F8_t[7] * (

                        ( S1 * S1 * S1 * S2 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 * S4 * S4 ) * (
                            
                            + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDDD42(double*         mat_J,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F8_t[9];

            gpu::computeBoysFunction(F8_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 8, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F8_t[7] * (

                        0.5 * ( S1 * S1 * S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * (-1.0))
                            + delta[c1][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[c1][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[c0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[c0][c1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b1][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[b1][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[b1][c1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b1][c0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[b0][c1] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][c0] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][b1] * (PQ[a0] * PQ[a1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a1][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a1][c1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][c0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][b1] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][b0] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][d0] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b1] * (PQ[a1] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * (PQ[a1] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                        )

                    )

                    +

                    F8_t[8] * (

                        ( S1 * S1 * S1 * S1 * S2 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 * S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDPP0(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pp_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   pp_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* pp_first_inds,
                       const uint32_t* pp_second_inds,
                       const uint32_t  pp_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pp_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pp_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * pp_mat_Q[kl] * pp_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = pp_first_inds[kl];
            const auto l = pp_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = p_prim_info[l / 3 + p_prim_count * 0];
            const auto c_l = p_prim_info[l / 3 + p_prim_count * 1];
            const auto x_l = p_prim_info[l / 3 + p_prim_count * 2];
            const auto y_l = p_prim_info[l / 3 + p_prim_count * 3];
            const auto z_l = p_prim_info[l / 3 + p_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = l % 3;

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[2];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 1, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[0] * (

                        0.25 / ( S1 * S1 ) * (
                            delta[a0][a1] * delta[b0][b1] * (QD_0 * QC_0)
                            + delta[a0][b0] * delta[a1][b1] * (QD_0 * QC_0)
                            + delta[a1][b0] * delta[a0][b1] * (QD_0 * QC_0)
                        )

                    )

                    +

                    F6_t[0] * (

                        0.25 / ( S1 * S2 ) * (
                            delta[b0][b1] * delta[c0][d0] * (PA_0 * PA_1)
                            + delta[a1][b1] * delta[c0][d0] * (PB_0 * PA_0)
                            + delta[a1][b0] * delta[c0][d0] * (PB_1 * PA_0)
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PA_1)
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PA_1)
                            + delta[a0][a1] * delta[c0][d0] * (PB_0 * PB_1)
                        )

                    )

                    +

                    F6_t[0] * (

                        0.5 / S1 * (
                            delta[b0][b1] * (PA_0 * PA_1 * QD_0 * QC_0)
                            + delta[a1][b1] * (PB_0 * PA_0 * QD_0 * QC_0)
                            + delta[a1][b0] * (PB_1 * PA_0 * QD_0 * QC_0)
                            + delta[a0][b1] * (PB_0 * PA_1 * QD_0 * QC_0)
                            + delta[a0][b0] * (PB_1 * PA_1 * QD_0 * QC_0)
                            + delta[a0][a1] * (PB_0 * PB_1 * QD_0 * QC_0)
                        )

                    )

                    +

                    F6_t[0] * (

                        0.5 / S2 * (
                            delta[c0][d0] * (PB_0 * PB_1 * PA_0 * PA_1)
                        )

                    )

                    +

                    F6_t[0] * (

                        (
                            
                            + PB_0 * PB_1 * PA_0 * PA_1 * QD_0 * QC_0
                        )

                    )

                    +

                    F6_t[0] * (

                        0.125 / ( S1 * S1 * S2 ) * (
                            delta[a0][a1] * delta[b0][b1] * delta[c0][d0]
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0]
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0]
                        )

                    )

                    +

                    F6_t[1] * (

                        0.125 / ( S1 * S1 * S4 ) * (
                            delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * (-2.0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * (-2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * (-2.0)
                        )

                    )

                    +

                    F6_t[1] * (

                        0.125 / ( S1 * S2 * S4 ) * (
                            delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * (-1.0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * (-1.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * (-1.0)
                        )

                    )

                    +

                    F6_t[1] * (

                        0.25 * S2 / ( S1 * S1 * S4 ) * (
                            delta[a0][a1] * delta[b0][b1] * (QD_0 * QC_0 * (-2.0))
                            + delta[a0][b0] * delta[a1][b1] * (QD_0 * QC_0 * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * (QD_0 * QC_0 * (-2.0))
                        )

                    )

                    +

                    F6_t[1] * (

                        0.25 / ( S1 * S4 ) * (
                            delta[b0][b1] * delta[c0][d0] * (PA_0 * PA_1 * (-1.0) + PA_0 * PQ[a1] + PA_1 * PQ[a0])
                            + delta[a1][b1] * delta[c0][d0] * (PB_0 * PA_0 * (-1.0) + PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[a1][b0] * delta[c0][d0] * (PB_1 * PA_0 * (-1.0) + PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[a1][d0] * delta[b0][b1] * (PA_0 * QC_0)
                            + delta[a1][b0] * delta[b1][d0] * (PA_0 * QC_0)
                            + delta[b0][d0] * delta[a1][b1] * (PA_0 * QC_0)
                            + delta[a1][c0] * delta[b0][b1] * (PA_0 * QD_0)
                            + delta[a1][b0] * delta[b1][c0] * (PA_0 * QD_0)
                            + delta[b0][c0] * delta[a1][b1] * (PA_0 * QD_0)
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PA_1 * (-1.0) + PB_0 * PQ[a1] + PA_1 * PQ[b0])
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PA_1 * (-1.0) + PB_1 * PQ[a1] + PA_1 * PQ[b1])
                            + delta[a0][d0] * delta[b0][b1] * (PA_1 * QC_0)
                            + delta[a0][b0] * delta[b1][d0] * (PA_1 * QC_0)
                            + delta[b0][d0] * delta[a0][b1] * (PA_1 * QC_0)
                            + delta[a0][c0] * delta[b0][b1] * (PA_1 * QD_0)
                            + delta[a0][b0] * delta[b1][c0] * (PA_1 * QD_0)
                            + delta[b0][c0] * delta[a0][b1] * (PA_1 * QD_0)
                            + delta[a0][a1] * delta[c0][d0] * (PB_0 * PB_1 * (-1.0) + PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[a0][d0] * delta[a1][b1] * (PB_0 * QC_0)
                            + delta[a0][a1] * delta[b1][d0] * (PB_0 * QC_0)
                            + delta[a1][d0] * delta[a0][b1] * (PB_0 * QC_0)
                            + delta[a0][d0] * delta[a1][b0] * (PB_1 * QC_0)
                            + delta[a0][a1] * delta[b0][d0] * (PB_1 * QC_0)
                            + delta[a1][d0] * delta[a0][b0] * (PB_1 * QC_0)
                            + delta[a0][a1] * delta[b0][b1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][b1] * (PB_0 * QD_0)
                            + delta[a0][a1] * delta[b1][c0] * (PB_0 * QD_0)
                            + delta[a1][c0] * delta[a0][b1] * (PB_0 * QD_0)
                            + delta[a0][c0] * delta[a1][b0] * (PB_1 * QD_0)
                            + delta[a0][a1] * delta[b0][c0] * (PB_1 * QD_0)
                            + delta[a1][c0] * delta[a0][b0] * (PB_1 * QD_0)
                        )

                    )

                    +

                    F6_t[1] * (

                        0.25 / ( S2 * S4 ) * (
                            delta[b0][b1] * delta[c0][d0] * (PA_0 * PA_1 * (-1.0))
                            + delta[a1][b1] * delta[c0][d0] * (PB_0 * PA_0 * (-1.0))
                            + delta[a1][b0] * delta[c0][d0] * (PB_1 * PA_0 * (-1.0))
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PA_1 * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PA_1 * (-1.0))
                            + delta[a0][a1] * delta[c0][d0] * (PB_0 * PB_1 * (-1.0))
                        )

                    )

                    +

                    F6_t[1] * (

                        0.5 * S1 / ( S2 * S4 ) * (
                            delta[c0][d0] * (PB_0 * PB_1 * PA_0 * PA_1 * (-1.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pp_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDPP1(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pp_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   pp_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* pp_first_inds,
                       const uint32_t* pp_second_inds,
                       const uint32_t  pp_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pp_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pp_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * pp_mat_Q[kl] * pp_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = pp_first_inds[kl];
            const auto l = pp_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = p_prim_info[l / 3 + p_prim_count * 0];
            const auto c_l = p_prim_info[l / 3 + p_prim_count * 1];
            const auto x_l = p_prim_info[l / 3 + p_prim_count * 2];
            const auto y_l = p_prim_info[l / 3 + p_prim_count * 3];
            const auto z_l = p_prim_info[l / 3 + p_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = l % 3;

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[3];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[1] * (

                        0.5 * S2 / ( S1 * S4 ) * (
                            delta[b0][b1] * (PA_0 * PA_1 * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[a1] * QD_0 * QC_0 + PA_1 * PQ[a0] * QD_0 * QC_0)
                            + delta[a1][b1] * (PB_0 * PA_0 * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[a0] * QD_0 * QC_0 + PA_0 * PQ[b0] * QD_0 * QC_0)
                            + delta[a1][b0] * (PB_1 * PA_0 * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[a0] * QD_0 * QC_0 + PA_0 * PQ[b1] * QD_0 * QC_0)
                            + delta[a0][b1] * (PB_0 * PA_1 * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[a1] * QD_0 * QC_0 + PA_1 * PQ[b0] * QD_0 * QC_0)
                            + delta[a0][b0] * (PB_1 * PA_1 * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[a1] * QD_0 * QC_0 + PA_1 * PQ[b1] * QD_0 * QC_0)
                            + delta[a0][a1] * (PB_0 * PB_1 * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[b1] * QD_0 * QC_0 + PB_1 * PQ[b0] * QD_0 * QC_0)
                        )

                    )

                    +

                    F6_t[1] * (

                        0.5 / S4 * (
                            delta[c0][d0] * (PB_0 * PB_1 * PA_0 * PQ[a1] + PB_0 * PB_1 * PA_1 * PQ[a0] + PB_0 * PA_0 * PA_1 * PQ[b1] + PB_1 * PA_0 * PA_1 * PQ[b0])
                            + delta[b1][d0] * (PB_0 * PA_0 * PA_1 * QC_0)
                            + delta[b1][c0] * (PB_0 * PA_0 * PA_1 * QD_0)
                            + delta[b0][d0] * (PB_1 * PA_0 * PA_1 * QC_0)
                            + delta[b0][c0] * (PB_1 * PA_0 * PA_1 * QD_0)
                            + delta[b0][b1] * (PA_0 * PA_1 * PQ[c0] * QD_0 * (-1.0) + PA_0 * PA_1 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][d0] * (PB_0 * PB_1 * PA_0 * QC_0)
                            + delta[a1][c0] * (PB_0 * PB_1 * PA_0 * QD_0)
                            + delta[a1][b1] * (PB_0 * PA_0 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][b0] * (PB_1 * PA_0 * PQ[c0] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d0] * (PB_0 * PB_1 * PA_1 * QC_0)
                            + delta[a0][c0] * (PB_0 * PB_1 * PA_1 * QD_0)
                            + delta[a0][b1] * (PB_0 * PA_1 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PA_1 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][b0] * (PB_1 * PA_1 * PQ[c0] * QD_0 * (-1.0) + PB_1 * PA_1 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][a1] * (PB_0 * PB_1 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PB_1 * PQ[d0] * QC_0 * (-1.0))
                        )

                    )

                    +

                    F6_t[1] * (

                        S1 / S4 * (
                            
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0] * QD_0 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[d0] * QC_0 * (-1.0)
                        )

                    )

                    +

                    F6_t[1] * (

                        S2 / S4 * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * QD_0 * QC_0
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * QD_0 * QC_0
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * QD_0 * QC_0
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * QD_0 * QC_0
                        )

                    )

                    +

                    F6_t[2] * (

                        ( S1 * S1 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[c0] * PQ[d0]
                        )

                    )

                    +

                    F6_t[2] * (

                        ( S1 * S2 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] * QD_0 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d0] * QC_0 * (-1.0)
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] * QD_0 * (-1.0)
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d0] * QC_0 * (-1.0)
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] * QD_0 * (-1.0)
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d0] * QC_0 * (-1.0)
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0] * QD_0 * (-1.0)
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d0] * QC_0 * (-1.0)
                        )

                    )

                    +

                    F6_t[2] * (

                        ( S2 * S2 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * QD_0 * QC_0
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * QD_0 * QC_0
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * QD_0 * QC_0
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * QD_0 * QC_0
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * QD_0 * QC_0
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * QD_0 * QC_0
                        )

                    )

                    +

                    F6_t[2] * (

                        0.25 * ( S2 * S2 ) / ( S1 * S1 * S4 * S4 ) * (
                            delta[a0][a1] * delta[b0][b1] * (QD_0 * QC_0)
                            + delta[a0][b0] * delta[a1][b1] * (QD_0 * QC_0)
                            + delta[a1][b0] * delta[a0][b1] * (QD_0 * QC_0)
                        )

                    )

                    +

                    F6_t[2] * (

                        0.25 * S2 / ( S1 * S4 * S4 ) * (
                            delta[b0][b1] * delta[c0][d0] * (PA_0 * PQ[a1] * (-1.0) + PA_1 * PQ[a0] * (-1.0) + PQ[a0] * PQ[a1])
                            + delta[a1][b1] * delta[c0][d0] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0) + PQ[a0] * PQ[b0])
                            + delta[a1][b0] * delta[c0][d0] * (PB_1 * PQ[a0] * (-1.0) + PA_0 * PQ[b1] * (-1.0) + PQ[a0] * PQ[b1])
                            + delta[a1][d0] * delta[b0][b1] * (PA_0 * QC_0 * (-1.0) + PQ[a0] * QC_0)
                            + delta[a1][b0] * delta[b1][d0] * (PA_0 * QC_0 * (-1.0) + PQ[a0] * QC_0)
                            + delta[b0][d0] * delta[a1][b1] * (PA_0 * QC_0 * (-1.0) + PQ[a0] * QC_0)
                            + delta[a1][c0] * delta[b0][b1] * (PA_0 * QD_0 * (-1.0) + PQ[a0] * QD_0)
                            + delta[a1][b0] * delta[b1][c0] * (PA_0 * QD_0 * (-1.0) + PQ[a0] * QD_0)
                            + delta[b0][c0] * delta[a1][b1] * (PA_0 * QD_0 * (-1.0) + PQ[a0] * QD_0)
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PQ[a1] * (-1.0) + PA_1 * PQ[b0] * (-1.0) + PQ[a1] * PQ[b0])
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PQ[a1] * (-1.0) + PA_1 * PQ[b1] * (-1.0) + PQ[a1] * PQ[b1])
                            + delta[a0][d0] * delta[b0][b1] * (PA_1 * QC_0 * (-1.0) + PQ[a1] * QC_0)
                            + delta[a0][b0] * delta[b1][d0] * (PA_1 * QC_0 * (-1.0) + PQ[a1] * QC_0)
                            + delta[b0][d0] * delta[a0][b1] * (PA_1 * QC_0 * (-1.0) + PQ[a1] * QC_0)
                            + delta[a0][c0] * delta[b0][b1] * (PA_1 * QD_0 * (-1.0) + PQ[a1] * QD_0)
                            + delta[a0][b0] * delta[b1][c0] * (PA_1 * QD_0 * (-1.0) + PQ[a1] * QD_0)
                            + delta[b0][c0] * delta[a0][b1] * (PA_1 * QD_0 * (-1.0) + PQ[a1] * QD_0)
                            + delta[a0][a1] * delta[c0][d0] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0) + PQ[b0] * PQ[b1])
                            + delta[a0][d0] * delta[a1][b1] * (PB_0 * QC_0 * (-1.0) + PQ[b0] * QC_0)
                            + delta[a0][a1] * delta[b1][d0] * (PB_0 * QC_0 * (-1.0) + PQ[b0] * QC_0)
                            + delta[a1][d0] * delta[a0][b1] * (PB_0 * QC_0 * (-1.0) + PQ[b0] * QC_0)
                            + delta[a0][c0] * delta[a1][b1] * (PB_0 * QD_0 * (-1.0) + PQ[b0] * QD_0)
                            + delta[a0][a1] * delta[b1][c0] * (PB_0 * QD_0 * (-1.0) + PQ[b0] * QD_0)
                            + delta[a1][c0] * delta[a0][b1] * (PB_0 * QD_0 * (-1.0) + PQ[b0] * QD_0)
                            + delta[a0][d0] * delta[a1][b0] * (PB_1 * QC_0 * (-1.0) + PQ[b1] * QC_0)
                            + delta[a0][a1] * delta[b0][d0] * (PB_1 * QC_0 * (-1.0) + PQ[b1] * QC_0)
                            + delta[a1][d0] * delta[a0][b0] * (PB_1 * QC_0 * (-1.0) + PQ[b1] * QC_0)
                            + delta[a0][c0] * delta[a1][b0] * (PB_1 * QD_0 * (-1.0) + PQ[b1] * QD_0)
                            + delta[a0][a1] * delta[b0][c0] * (PB_1 * QD_0 * (-1.0) + PQ[b1] * QD_0)
                            + delta[a1][c0] * delta[a0][b0] * (PB_1 * QD_0 * (-1.0) + PQ[b1] * QD_0)
                            + delta[a0][a1] * delta[b0][b1] * (PQ[c0] * QD_0 * 2.0 + PQ[d0] * QC_0 * 2.0)
                            + delta[a0][b0] * delta[a1][b1] * (PQ[c0] * QD_0 * 2.0 + PQ[d0] * QC_0 * 2.0)
                            + delta[a1][b0] * delta[a0][b1] * (PQ[c0] * QD_0 * 2.0 + PQ[d0] * QC_0 * 2.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pp_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDPP2(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pp_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   pp_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* pp_first_inds,
                       const uint32_t* pp_second_inds,
                       const uint32_t  pp_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pp_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pp_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * pp_mat_Q[kl] * pp_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = pp_first_inds[kl];
            const auto l = pp_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = p_prim_info[l / 3 + p_prim_count * 0];
            const auto c_l = p_prim_info[l / 3 + p_prim_count * 1];
            const auto x_l = p_prim_info[l / 3 + p_prim_count * 2];
            const auto y_l = p_prim_info[l / 3 + p_prim_count * 3];
            const auto z_l = p_prim_info[l / 3 + p_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = l % 3;

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[3];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[2] * (

                        0.25 / ( S4 * S4 ) * (
                            delta[b0][b1] * delta[c0][d0] * (PA_0 * PQ[a1] * (-1.0) + PA_1 * PQ[a0] * (-1.0) + PA_0 * PA_1)
                            + delta[b0][c0] * delta[b1][d0] * (PA_0 * PA_1)
                            + delta[b0][d0] * delta[b1][c0] * (PA_0 * PA_1)
                            + delta[a1][c0] * delta[b1][d0] * (PB_0 * PA_0)
                            + delta[a1][d0] * delta[b1][c0] * (PB_0 * PA_0)
                            + delta[a1][b1] * delta[c0][d0] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0) + PB_0 * PA_0)
                            + delta[a1][c0] * delta[b0][d0] * (PB_1 * PA_0)
                            + delta[a1][d0] * delta[b0][c0] * (PB_1 * PA_0)
                            + delta[a1][b0] * delta[c0][d0] * (PB_1 * PQ[a0] * (-1.0) + PA_0 * PQ[b1] * (-1.0) + PB_1 * PA_0)
                            + delta[a1][d0] * delta[b0][b1] * (PA_0 * PQ[c0] * (-1.0))
                            + delta[a1][b0] * delta[b1][d0] * (PA_0 * PQ[c0] * (-1.0))
                            + delta[b0][d0] * delta[a1][b1] * (PA_0 * PQ[c0] * (-1.0))
                            + delta[a1][c0] * delta[b0][b1] * (PA_0 * PQ[d0] * (-1.0))
                            + delta[a1][b0] * delta[b1][c0] * (PA_0 * PQ[d0] * (-1.0))
                            + delta[b0][c0] * delta[a1][b1] * (PA_0 * PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[b1][d0] * (PB_0 * PA_1)
                            + delta[a0][d0] * delta[b1][c0] * (PB_0 * PA_1)
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PQ[a1] * (-1.0) + PA_1 * PQ[b0] * (-1.0) + PB_0 * PA_1)
                            + delta[a0][c0] * delta[b0][d0] * (PB_1 * PA_1)
                            + delta[a0][d0] * delta[b0][c0] * (PB_1 * PA_1)
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PQ[a1] * (-1.0) + PA_1 * PQ[b1] * (-1.0) + PB_1 * PA_1)
                            + delta[a0][d0] * delta[b0][b1] * (PA_1 * PQ[c0] * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * (PA_1 * PQ[c0] * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * (PA_1 * PQ[c0] * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * (PA_1 * PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * (PA_1 * PQ[d0] * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * (PA_1 * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[c0][d0] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0) + PB_0 * PB_1)
                            + delta[a0][d0] * delta[a1][b1] * (PB_0 * PQ[c0] * (-1.0))
                            + delta[a0][a1] * delta[b1][d0] * (PB_0 * PQ[c0] * (-1.0))
                            + delta[a1][d0] * delta[a0][b1] * (PB_0 * PQ[c0] * (-1.0))
                            + delta[a0][c0] * delta[a1][b1] * (PB_0 * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[b1][c0] * (PB_0 * PQ[d0] * (-1.0))
                            + delta[a1][c0] * delta[a0][b1] * (PB_0 * PQ[d0] * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * (PB_1 * PQ[c0] * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * (PB_1 * PQ[c0] * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * (PB_1 * PQ[c0] * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * (PB_1 * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * (PB_1 * PQ[d0] * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * (PB_1 * PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[a1][d0] * (PB_0 * PB_1)
                            + delta[a0][d0] * delta[a1][c0] * (PB_0 * PB_1)
                            + delta[a0][a1] * delta[b0][b1] * (PQ[c0] * PQ[d0])
                            + delta[a0][b0] * delta[a1][b1] * (PQ[c0] * PQ[d0])
                            + delta[a1][b0] * delta[a0][b1] * (PQ[c0] * PQ[d0])
                        )

                    )

                    +

                    F6_t[2] * (

                        0.5 * ( S2 * S2 ) / ( S1 * S4 * S4 ) * (
                            delta[b0][b1] * (PA_0 * PQ[a1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[a0] * QD_0 * QC_0 * (-1.0) + PQ[a0] * PQ[a1] * QD_0 * QC_0)
                            + delta[a1][b1] * (PB_0 * PQ[a0] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[b0] * QD_0 * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * QD_0 * QC_0)
                            + delta[a1][b0] * (PB_1 * PQ[a0] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[b1] * QD_0 * QC_0 * (-1.0) + PQ[a0] * PQ[b1] * QD_0 * QC_0)
                            + delta[a0][b1] * (PB_0 * PQ[a1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[b0] * QD_0 * QC_0 * (-1.0) + PQ[a1] * PQ[b0] * QD_0 * QC_0)
                            + delta[a0][b0] * (PB_1 * PQ[a1] * QD_0 * QC_0 * (-1.0) + PA_1 * PQ[b1] * QD_0 * QC_0 * (-1.0) + PQ[a1] * PQ[b1] * QD_0 * QC_0)
                            + delta[a0][a1] * (PB_0 * PQ[b1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[b0] * QD_0 * QC_0 * (-1.0) + PQ[b0] * PQ[b1] * QD_0 * QC_0)
                        )

                    )

                    +

                    F6_t[2] * (

                        0.5 * S1 / ( S4 * S4 ) * (
                            delta[c0][d0] * (PB_0 * PB_1 * PA_0 * PQ[a1] * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * (-1.0))
                            + delta[b1][d0] * (PB_0 * PA_0 * PA_1 * PQ[c0] * (-1.0))
                            + delta[b1][c0] * (PB_0 * PA_0 * PA_1 * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PB_1 * PA_0 * PA_1 * PQ[c0] * (-1.0))
                            + delta[b0][c0] * (PB_1 * PA_0 * PA_1 * PQ[d0] * (-1.0))
                            + delta[b0][b1] * (PA_0 * PA_1 * PQ[c0] * PQ[d0])
                            + delta[a1][d0] * (PB_0 * PB_1 * PA_0 * PQ[c0] * (-1.0))
                            + delta[a1][c0] * (PB_0 * PB_1 * PA_0 * PQ[d0] * (-1.0))
                            + delta[a1][b1] * (PB_0 * PA_0 * PQ[c0] * PQ[d0])
                            + delta[a1][b0] * (PB_1 * PA_0 * PQ[c0] * PQ[d0])
                            + delta[a0][d0] * (PB_0 * PB_1 * PA_1 * PQ[c0] * (-1.0))
                            + delta[a0][c0] * (PB_0 * PB_1 * PA_1 * PQ[d0] * (-1.0))
                            + delta[a0][b1] * (PB_0 * PA_1 * PQ[c0] * PQ[d0])
                            + delta[a0][b0] * (PB_1 * PA_1 * PQ[c0] * PQ[d0])
                            + delta[a0][a1] * (PB_0 * PB_1 * PQ[c0] * PQ[d0])
                        )

                    )

                    +

                    F6_t[2] * (

                        0.5 * S2 / ( S4 * S4 ) * (
                            delta[c0][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] + PB_0 * PA_0 * PQ[a1] * PQ[b1] + PB_0 * PA_1 * PQ[a0] * PQ[b1] + PB_1 * PA_0 * PQ[a1] * PQ[b0] + PB_1 * PA_1 * PQ[a0] * PQ[b0] + PA_0 * PA_1 * PQ[b0] * PQ[b1])
                            + delta[b1][d0] * (PB_0 * PA_0 * PQ[a1] * QC_0 + PB_0 * PA_1 * PQ[a0] * QC_0 + PA_0 * PA_1 * PQ[b0] * QC_0)
                            + delta[b1][c0] * (PB_0 * PA_0 * PQ[a1] * QD_0 + PB_0 * PA_1 * PQ[a0] * QD_0 + PA_0 * PA_1 * PQ[b0] * QD_0)
                            + delta[b0][d0] * (PB_1 * PA_0 * PQ[a1] * QC_0 + PB_1 * PA_1 * PQ[a0] * QC_0 + PA_0 * PA_1 * PQ[b1] * QC_0)
                            + delta[b0][c0] * (PB_1 * PA_0 * PQ[a1] * QD_0 + PB_1 * PA_1 * PQ[a0] * QD_0 + PA_0 * PA_1 * PQ[b1] * QD_0)
                            + delta[b0][b1] * (PA_0 * PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[d0] * QC_0 * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PA_1 * PQ[c0] * QD_0 + PA_0 * PA_1 * PQ[d0] * QC_0)
                            + delta[a1][d0] * (PB_0 * PB_1 * PQ[a0] * QC_0 + PB_0 * PA_0 * PQ[b1] * QC_0 + PB_1 * PA_0 * PQ[b0] * QC_0)
                            + delta[a1][c0] * (PB_0 * PB_1 * PQ[a0] * QD_0 + PB_0 * PA_0 * PQ[b1] * QD_0 + PB_1 * PA_0 * PQ[b0] * QD_0)
                            + delta[a1][b1] * (PB_0 * PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[a0] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[c0] * QD_0 + PB_0 * PA_0 * PQ[d0] * QC_0)
                            + delta[a1][b0] * (PB_1 * PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[c0] * QD_0 + PB_1 * PA_0 * PQ[d0] * QC_0)
                            + delta[a0][d0] * (PB_0 * PB_1 * PQ[a1] * QC_0 + PB_0 * PA_1 * PQ[b1] * QC_0 + PB_1 * PA_1 * PQ[b0] * QC_0)
                            + delta[a0][c0] * (PB_0 * PB_1 * PQ[a1] * QD_0 + PB_0 * PA_1 * PQ[b1] * QD_0 + PB_1 * PA_1 * PQ[b0] * QD_0)
                            + delta[a0][b1] * (PB_0 * PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[a1] * PQ[d0] * QC_0 * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PA_1 * PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PA_1 * PQ[c0] * QD_0 + PB_0 * PA_1 * PQ[d0] * QC_0)
                            + delta[a0][b0] * (PB_1 * PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[a1] * PQ[d0] * QC_0 * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PA_1 * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PA_1 * PQ[c0] * QD_0 + PB_1 * PA_1 * PQ[d0] * QC_0)
                            + delta[a0][a1] * (PB_0 * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PB_1 * PQ[c0] * QD_0 + PB_0 * PB_1 * PQ[d0] * QC_0)
                        )

                    )

                    +

                    F6_t[2] * (

                        0.125 * S2 / ( S1 * S1 * S4 * S4 ) * (
                            delta[a0][a1] * delta[b0][b1] * delta[c0][d0]
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0]
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0]
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pp_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDPP3(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pp_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   pp_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* pp_first_inds,
                       const uint32_t* pp_second_inds,
                       const uint32_t  pp_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pp_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pp_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * pp_mat_Q[kl] * pp_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = pp_first_inds[kl];
            const auto l = pp_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = p_prim_info[l / 3 + p_prim_count * 0];
            const auto c_l = p_prim_info[l / 3 + p_prim_count * 1];
            const auto x_l = p_prim_info[l / 3 + p_prim_count * 2];
            const auto y_l = p_prim_info[l / 3 + p_prim_count * 3];
            const auto z_l = p_prim_info[l / 3 + p_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = l % 3;

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[4];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[2] * (

                        0.125 / ( S1 * S4 * S4 ) * (
                            delta[a0][c0] * delta[a1][d0] * delta[b0][b1]
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d0]
                            + delta[a0][c0] * delta[b0][d0] * delta[a1][b1]
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][b1]
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][c0]
                            + delta[a0][d0] * delta[b0][c0] * delta[a1][b1]
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * 2.0
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d0]
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][c0]
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d0]
                            + delta[a1][c0] * delta[b0][d0] * delta[a0][b1]
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][c0]
                            + delta[a1][d0] * delta[b0][c0] * delta[a0][b1]
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * 2.0
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * 2.0
                        )

                    )

                    +

                    F6_t[3] * (

                        ( S1 * S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[c0] * PQ[d0]
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[c0] * PQ[d0]
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[c0] * PQ[d0]
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[c0] * PQ[d0]
                        )

                    )

                    +

                    F6_t[3] * (

                        ( S1 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * QD_0 * (-1.0)
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * QC_0 * (-1.0)
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * QD_0 * (-1.0)
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * QC_0 * (-1.0)
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0)
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0)
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * QD_0 * (-1.0)
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * QC_0 * (-1.0)
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * (-1.0)
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * QC_0 * (-1.0)
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0)
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0)
                        )

                    )

                    +

                    F6_t[3] * (

                        ( S2 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * QD_0 * QC_0
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * QD_0 * QC_0
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * QC_0
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * QC_0
                        )

                    )

                    +

                    F6_t[3] * (

                        0.125 * S2 / ( S1 * S4 * S4 * S4 ) * (
                            delta[a0][c0] * delta[a1][d0] * delta[b0][b1] * (-1.0)
                            + delta[a0][c0] * delta[a1][b0] * delta[b1][d0] * (-1.0)
                            + delta[a0][c0] * delta[b0][d0] * delta[a1][b1] * (-1.0)
                            + delta[a0][d0] * delta[a1][c0] * delta[b0][b1] * (-1.0)
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][c0] * (-1.0)
                            + delta[a0][d0] * delta[b0][c0] * delta[a1][b1] * (-1.0)
                            + delta[a0][a1] * delta[b0][b1] * delta[c0][d0] * (-1.0)
                            + delta[a0][a1] * delta[b0][c0] * delta[b1][d0] * (-1.0)
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][c0] * (-1.0)
                            + delta[a1][c0] * delta[a0][b0] * delta[b1][d0] * (-1.0)
                            + delta[a1][c0] * delta[b0][d0] * delta[a0][b1] * (-1.0)
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][c0] * (-1.0)
                            + delta[a1][d0] * delta[b0][c0] * delta[a0][b1] * (-1.0)
                            + delta[a0][b0] * delta[a1][b1] * delta[c0][d0] * (-1.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[c0][d0] * (-1.0)
                        )

                    )

                    +

                    F6_t[3] * (

                        0.25 * ( S2 * S2 ) / ( S1 * S4 * S4 * S4 ) * (
                            delta[b0][b1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * (-1.0))
                            + delta[a1][b1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * (-1.0))
                            + delta[a1][b0] * delta[c0][d0] * (PQ[a0] * PQ[b1] * (-1.0))
                            + delta[a1][d0] * delta[b0][b1] * (PQ[a0] * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][d0] * (PQ[a0] * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[a1][b1] * (PQ[a0] * QC_0 * (-1.0))
                            + delta[a1][c0] * delta[b0][b1] * (PQ[a0] * QD_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][c0] * (PQ[a0] * QD_0 * (-1.0))
                            + delta[b0][c0] * delta[a1][b1] * (PQ[a0] * QD_0 * (-1.0))
                            + delta[a0][b1] * delta[c0][d0] * (PQ[a1] * PQ[b0] * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (PQ[a1] * PQ[b1] * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * (PQ[a1] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * (PQ[a1] * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * (PQ[a1] * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * (PQ[a1] * QD_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * (PQ[a1] * QD_0 * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * (PQ[a1] * QD_0 * (-1.0))
                            + delta[a0][a1] * delta[c0][d0] * (PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][d0] * delta[a1][b1] * (PQ[b0] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][d0] * (PQ[b0] * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[a0][b1] * (PQ[b0] * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][b1] * (PQ[b0] * QD_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][c0] * (PQ[b0] * QD_0 * (-1.0))
                            + delta[a1][c0] * delta[a0][b1] * (PQ[b0] * QD_0 * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * (PQ[b1] * QC_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * (PQ[b1] * QC_0 * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * (PQ[b1] * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[a1][b0] * (PQ[b1] * QD_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][c0] * (PQ[b1] * QD_0 * (-1.0))
                            + delta[a1][c0] * delta[a0][b0] * (PQ[b1] * QD_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                        )

                    )

                    +

                    F6_t[3] * (

                        0.25 * S2 / ( S4 * S4 * S4 ) * (
                            delta[b0][b1] * delta[c0][d0] * (PQ[a0] * PQ[a1] * (-1.0) + PA_0 * PQ[a1] + PA_1 * PQ[a0])
                            + delta[b0][c0] * delta[b1][d0] * (PA_0 * PQ[a1] + PA_1 * PQ[a0])
                            + delta[b0][d0] * delta[b1][c0] * (PA_0 * PQ[a1] + PA_1 * PQ[a0])
                            + delta[a1][c0] * delta[b1][d0] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[a1][d0] * delta[b1][c0] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[a1][b1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * (-1.0) + PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[a1][c0] * delta[b0][d0] * (PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[a1][d0] * delta[b0][c0] * (PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[a1][b0] * delta[c0][d0] * (PQ[a0] * PQ[b1] * (-1.0) + PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[a1][d0] * delta[b0][b1] * (PQ[a0] * PQ[c0] * (-1.0) + PA_0 * PQ[c0])
                            + delta[a1][b0] * delta[b1][d0] * (PQ[a0] * PQ[c0] * (-1.0) + PA_0 * PQ[c0])
                            + delta[b0][d0] * delta[a1][b1] * (PQ[a0] * PQ[c0] * (-1.0) + PA_0 * PQ[c0])
                            + delta[a1][c0] * delta[b0][b1] * (PQ[a0] * PQ[d0] * (-1.0) + PA_0 * PQ[d0])
                            + delta[a1][b0] * delta[b1][c0] * (PQ[a0] * PQ[d0] * (-1.0) + PA_0 * PQ[d0])
                            + delta[b0][c0] * delta[a1][b1] * (PQ[a0] * PQ[d0] * (-1.0) + PA_0 * PQ[d0])
                            + delta[a0][c0] * delta[b1][d0] * (PB_0 * PQ[a1] + PA_1 * PQ[b0])
                            + delta[a0][d0] * delta[b1][c0] * (PB_0 * PQ[a1] + PA_1 * PQ[b0])
                            + delta[a0][b1] * delta[c0][d0] * (PQ[a1] * PQ[b0] * (-1.0) + PB_0 * PQ[a1] + PA_1 * PQ[b0])
                            + delta[a0][c0] * delta[b0][d0] * (PB_1 * PQ[a1] + PA_1 * PQ[b1])
                            + delta[a0][d0] * delta[b0][c0] * (PB_1 * PQ[a1] + PA_1 * PQ[b1])
                            + delta[a0][b0] * delta[c0][d0] * (PQ[a1] * PQ[b1] * (-1.0) + PB_1 * PQ[a1] + PA_1 * PQ[b1])
                            + delta[a0][d0] * delta[b0][b1] * (PQ[a1] * PQ[c0] * (-1.0) + PA_1 * PQ[c0])
                            + delta[a0][b0] * delta[b1][d0] * (PQ[a1] * PQ[c0] * (-1.0) + PA_1 * PQ[c0])
                            + delta[b0][d0] * delta[a0][b1] * (PQ[a1] * PQ[c0] * (-1.0) + PA_1 * PQ[c0])
                            + delta[a0][c0] * delta[b0][b1] * (PQ[a1] * PQ[d0] * (-1.0) + PA_1 * PQ[d0])
                            + delta[a0][b0] * delta[b1][c0] * (PQ[a1] * PQ[d0] * (-1.0) + PA_1 * PQ[d0])
                            + delta[b0][c0] * delta[a0][b1] * (PQ[a1] * PQ[d0] * (-1.0) + PA_1 * PQ[d0])
                            + delta[a0][a1] * delta[c0][d0] * (PQ[b0] * PQ[b1] * (-1.0) + PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[a0][d0] * delta[a1][b1] * (PQ[b0] * PQ[c0] * (-1.0) + PB_0 * PQ[c0])
                            + delta[a0][a1] * delta[b1][d0] * (PQ[b0] * PQ[c0] * (-1.0) + PB_0 * PQ[c0])
                            + delta[a1][d0] * delta[a0][b1] * (PQ[b0] * PQ[c0] * (-1.0) + PB_0 * PQ[c0])
                            + delta[a0][c0] * delta[a1][b1] * (PQ[b0] * PQ[d0] * (-1.0) + PB_0 * PQ[d0])
                            + delta[a0][a1] * delta[b1][c0] * (PQ[b0] * PQ[d0] * (-1.0) + PB_0 * PQ[d0])
                            + delta[a1][c0] * delta[a0][b1] * (PQ[b0] * PQ[d0] * (-1.0) + PB_0 * PQ[d0])
                            + delta[a0][d0] * delta[a1][b0] * (PQ[b1] * PQ[c0] * (-1.0) + PB_1 * PQ[c0])
                            + delta[a0][a1] * delta[b0][d0] * (PQ[b1] * PQ[c0] * (-1.0) + PB_1 * PQ[c0])
                            + delta[a1][d0] * delta[a0][b0] * (PQ[b1] * PQ[c0] * (-1.0) + PB_1 * PQ[c0])
                            + delta[a0][c0] * delta[a1][b0] * (PQ[b1] * PQ[d0] * (-1.0) + PB_1 * PQ[d0])
                            + delta[a0][a1] * delta[b0][c0] * (PQ[b1] * PQ[d0] * (-1.0) + PB_1 * PQ[d0])
                            + delta[a1][c0] * delta[a0][b0] * (PQ[b1] * PQ[d0] * (-1.0) + PB_1 * PQ[d0])
                            + delta[a0][a1] * delta[b0][b1] * (PQ[c0] * PQ[d0] * (-2.0))
                            + delta[a0][b0] * delta[a1][b1] * (PQ[c0] * PQ[d0] * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * (PQ[c0] * PQ[d0] * (-2.0))
                            + delta[a0][c0] * delta[a1][d0] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[a0][d0] * delta[a1][c0] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pp_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDPP4(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pp_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   pp_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* pp_first_inds,
                       const uint32_t* pp_second_inds,
                       const uint32_t  pp_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pp_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pp_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * pp_mat_Q[kl] * pp_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = pp_first_inds[kl];
            const auto l = pp_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = p_prim_info[l / 3 + p_prim_count * 0];
            const auto c_l = p_prim_info[l / 3 + p_prim_count * 1];
            const auto x_l = p_prim_info[l / 3 + p_prim_count * 2];
            const auto y_l = p_prim_info[l / 3 + p_prim_count * 3];
            const auto z_l = p_prim_info[l / 3 + p_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = l % 3;

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[5];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[3] * (

                        0.5 * ( S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            delta[c0][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * (-1.0))
                            + delta[b1][d0] * (PB_0 * PA_0 * PQ[a1] * PQ[c0] * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[c0] * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[c0] * (-1.0))
                            + delta[b1][c0] * (PB_0 * PA_0 * PQ[a1] * PQ[d0] * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[d0] * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PB_1 * PA_0 * PQ[a1] * PQ[c0] * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[c0] * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[c0] * (-1.0))
                            + delta[b0][c0] * (PB_1 * PA_0 * PQ[a1] * PQ[d0] * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[d0] * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[b0][b1] * (PA_0 * PA_1 * PQ[c0] * PQ[d0] * (-1.0) + PA_0 * PQ[a1] * PQ[c0] * PQ[d0] + PA_1 * PQ[a0] * PQ[c0] * PQ[d0])
                            + delta[a1][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c0] * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a1][c0] * (PB_0 * PB_1 * PQ[a0] * PQ[d0] * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d0] * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a1][b1] * (PB_0 * PA_0 * PQ[c0] * PQ[d0] * (-1.0) + PB_0 * PQ[a0] * PQ[c0] * PQ[d0] + PA_0 * PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a1][b0] * (PB_1 * PA_0 * PQ[c0] * PQ[d0] * (-1.0) + PB_1 * PQ[a0] * PQ[c0] * PQ[d0] + PA_0 * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a0][d0] * (PB_0 * PB_1 * PQ[a1] * PQ[c0] * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[c0] * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a0][c0] * (PB_0 * PB_1 * PQ[a1] * PQ[d0] * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[d0] * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][b1] * (PB_0 * PA_1 * PQ[c0] * PQ[d0] * (-1.0) + PB_0 * PQ[a1] * PQ[c0] * PQ[d0] + PA_1 * PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a0][b0] * (PB_1 * PA_1 * PQ[c0] * PQ[d0] * (-1.0) + PB_1 * PQ[a1] * PQ[c0] * PQ[d0] + PA_1 * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a0][a1] * (PB_0 * PB_1 * PQ[c0] * PQ[d0] * (-1.0) + PB_0 * PQ[b1] * PQ[c0] * PQ[d0] + PB_1 * PQ[b0] * PQ[c0] * PQ[d0])
                        )

                    )

                    +

                    F6_t[3] * (

                        0.5 * ( S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            delta[c0][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] + PA_1 * PQ[a0] * PQ[b0] * PQ[b1])
                            + delta[b1][d0] * (PB_0 * PQ[a0] * PQ[a1] * QC_0 + PA_0 * PQ[a1] * PQ[b0] * QC_0 + PA_1 * PQ[a0] * PQ[b0] * QC_0)
                            + delta[b1][c0] * (PB_0 * PQ[a0] * PQ[a1] * QD_0 + PA_0 * PQ[a1] * PQ[b0] * QD_0 + PA_1 * PQ[a0] * PQ[b0] * QD_0)
                            + delta[b0][d0] * (PB_1 * PQ[a0] * PQ[a1] * QC_0 + PA_0 * PQ[a1] * PQ[b1] * QC_0 + PA_1 * PQ[a0] * PQ[b1] * QC_0)
                            + delta[b0][c0] * (PB_1 * PQ[a0] * PQ[a1] * QD_0 + PA_0 * PQ[a1] * PQ[b1] * QD_0 + PA_1 * PQ[a0] * PQ[b1] * QD_0)
                            + delta[b0][b1] * (PQ[a0] * PQ[a1] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PQ[a1] * PQ[c0] * QD_0 + PA_0 * PQ[a1] * PQ[d0] * QC_0 + PA_1 * PQ[a0] * PQ[c0] * QD_0 + PA_1 * PQ[a0] * PQ[d0] * QC_0)
                            + delta[a1][d0] * (PB_0 * PQ[a0] * PQ[b1] * QC_0 + PB_1 * PQ[a0] * PQ[b0] * QC_0 + PA_0 * PQ[b0] * PQ[b1] * QC_0)
                            + delta[a1][c0] * (PB_0 * PQ[a0] * PQ[b1] * QD_0 + PB_1 * PQ[a0] * PQ[b0] * QD_0 + PA_0 * PQ[b0] * PQ[b1] * QD_0)
                            + delta[a1][b1] * (PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[c0] * QD_0 + PB_0 * PQ[a0] * PQ[d0] * QC_0 + PA_0 * PQ[b0] * PQ[c0] * QD_0 + PA_0 * PQ[b0] * PQ[d0] * QC_0)
                            + delta[a1][b0] * (PQ[a0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[c0] * QD_0 + PB_1 * PQ[a0] * PQ[d0] * QC_0 + PA_0 * PQ[b1] * PQ[c0] * QD_0 + PA_0 * PQ[b1] * PQ[d0] * QC_0)
                            + delta[a0][d0] * (PB_0 * PQ[a1] * PQ[b1] * QC_0 + PB_1 * PQ[a1] * PQ[b0] * QC_0 + PA_1 * PQ[b0] * PQ[b1] * QC_0)
                            + delta[a0][c0] * (PB_0 * PQ[a1] * PQ[b1] * QD_0 + PB_1 * PQ[a1] * PQ[b0] * QD_0 + PA_1 * PQ[b0] * PQ[b1] * QD_0)
                            + delta[a0][b1] * (PQ[a1] * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PQ[a1] * PQ[c0] * QD_0 + PB_0 * PQ[a1] * PQ[d0] * QC_0 + PA_1 * PQ[b0] * PQ[c0] * QD_0 + PA_1 * PQ[b0] * PQ[d0] * QC_0)
                            + delta[a0][b0] * (PQ[a1] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PQ[a1] * PQ[c0] * QD_0 + PB_1 * PQ[a1] * PQ[d0] * QC_0 + PA_1 * PQ[b1] * PQ[c0] * QD_0 + PA_1 * PQ[b1] * PQ[d0] * QC_0)
                            + delta[a0][a1] * (PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PQ[b1] * PQ[c0] * QD_0 + PB_0 * PQ[b1] * PQ[d0] * QC_0 + PB_1 * PQ[b0] * PQ[c0] * QD_0 + PB_1 * PQ[b0] * PQ[d0] * QC_0)
                        )

                    )

                    +

                    F6_t[3] * (

                        0.5 * ( S2 * S2 * S2 ) / ( S1 * S4 * S4 * S4 ) * (
                            delta[b0][b1] * (PQ[a0] * PQ[a1] * QD_0 * QC_0 * (-1.0))
                            + delta[a1][b1] * (PQ[a0] * PQ[b0] * QD_0 * QC_0 * (-1.0))
                            + delta[a1][b0] * (PQ[a0] * PQ[b1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][b1] * (PQ[a1] * PQ[b0] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][b0] * (PQ[a1] * PQ[b1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][a1] * (PQ[b0] * PQ[b1] * QD_0 * QC_0 * (-1.0))
                        )

                    )

                    +

                    F6_t[4] * (

                        ( S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0]
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0]
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0]
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0]
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0]
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0]
                        )

                    )

                    +

                    F6_t[4] * (

                        ( S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * QD_0 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * QC_0 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * QD_0 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * QC_0 * (-1.0)
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0)
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0)
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0)
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0)
                        )

                    )

                    +

                    F6_t[4] * (

                        ( S2 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * QC_0
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pp_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDPP5(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pp_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   pp_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* pp_first_inds,
                       const uint32_t* pp_second_inds,
                       const uint32_t  pp_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pp_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pp_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * pp_mat_Q[kl] * pp_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = pp_first_inds[kl];
            const auto l = pp_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = p_prim_info[l / 3 + p_prim_count * 0];
            const auto c_l = p_prim_info[l / 3 + p_prim_count * 1];
            const auto x_l = p_prim_info[l / 3 + p_prim_count * 2];
            const auto y_l = p_prim_info[l / 3 + p_prim_count * 3];
            const auto z_l = p_prim_info[l / 3 + p_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = l % 3;

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[7];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 6, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[4] * (

                        0.5 * ( S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[c0][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * (-1.0))
                            + delta[b1][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[c0] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[c0] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[c0] * (-1.0))
                            + delta[b1][c0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[d0] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PB_1 * PQ[a0] * PQ[a1] * PQ[c0] * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[c0] * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[c0] * (-1.0))
                            + delta[b0][c0] * (PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[b0][b1] * (PA_0 * PQ[a1] * PQ[c0] * PQ[d0] * (-1.0) + PA_1 * PQ[a0] * PQ[c0] * PQ[d0] * (-1.0) + PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0])
                            + delta[a1][d0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a1][c0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a1][b1] * (PB_0 * PQ[a0] * PQ[c0] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * PQ[d0] * (-1.0) + PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a1][b0] * (PB_1 * PQ[a0] * PQ[c0] * PQ[d0] * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0) + PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a0][d0] * (PB_0 * PQ[a1] * PQ[b1] * PQ[c0] * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[c0] * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a0][c0] * (PB_0 * PQ[a1] * PQ[b1] * PQ[d0] * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[d0] * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][b1] * (PB_0 * PQ[a1] * PQ[c0] * PQ[d0] * (-1.0) + PA_1 * PQ[b0] * PQ[c0] * PQ[d0] * (-1.0) + PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a0][b0] * (PB_1 * PQ[a1] * PQ[c0] * PQ[d0] * (-1.0) + PA_1 * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0) + PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a0][a1] * (PB_0 * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * PQ[d0] * (-1.0) + PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0])
                        )

                    )

                    +

                    F6_t[4] * (

                        0.5 * ( S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[b1][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * QC_0)
                            + delta[b0][d0] * (PQ[a0] * PQ[a1] * PQ[b1] * QC_0)
                            + delta[b0][b1] * (PQ[a0] * PQ[a1] * PQ[c0] * QD_0 + PQ[a0] * PQ[a1] * PQ[d0] * QC_0)
                            + delta[a1][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * QC_0)
                            + delta[a1][b1] * (PQ[a0] * PQ[b0] * PQ[c0] * QD_0 + PQ[a0] * PQ[b0] * PQ[d0] * QC_0)
                            + delta[a1][b0] * (PQ[a0] * PQ[b1] * PQ[c0] * QD_0 + PQ[a0] * PQ[b1] * PQ[d0] * QC_0)
                            + delta[a0][d0] * (PQ[a1] * PQ[b0] * PQ[b1] * QC_0)
                            + delta[a0][b1] * (PQ[a1] * PQ[b0] * PQ[c0] * QD_0 + PQ[a1] * PQ[b0] * PQ[d0] * QC_0)
                            + delta[a0][b0] * (PQ[a1] * PQ[b1] * PQ[c0] * QD_0 + PQ[a1] * PQ[b1] * PQ[d0] * QC_0)
                            + delta[a0][a1] * (PQ[b0] * PQ[b1] * PQ[c0] * QD_0 + PQ[b0] * PQ[b1] * PQ[d0] * QC_0)
                            + delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1])
                            + delta[b1][c0] * (PQ[a0] * PQ[a1] * PQ[b0] * QD_0)
                            + delta[b0][c0] * (PQ[a0] * PQ[a1] * PQ[b1] * QD_0)
                            + delta[a1][c0] * (PQ[a0] * PQ[b0] * PQ[b1] * QD_0)
                            + delta[a0][c0] * (PQ[a1] * PQ[b0] * PQ[b1] * QD_0)
                        )

                    )

                    +

                    F6_t[4] * (

                        0.25 * ( S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[b0][b1] * delta[c0][d0] * (PQ[a0] * PQ[a1])
                            + delta[b0][c0] * delta[b1][d0] * (PQ[a0] * PQ[a1])
                            + delta[b0][d0] * delta[b1][c0] * (PQ[a0] * PQ[a1])
                            + delta[a1][c0] * delta[b1][d0] * (PQ[a0] * PQ[b0])
                            + delta[a1][d0] * delta[b1][c0] * (PQ[a0] * PQ[b0])
                            + delta[a1][b1] * delta[c0][d0] * (PQ[a0] * PQ[b0])
                            + delta[a1][c0] * delta[b0][d0] * (PQ[a0] * PQ[b1])
                            + delta[a1][d0] * delta[b0][c0] * (PQ[a0] * PQ[b1])
                            + delta[a1][b0] * delta[c0][d0] * (PQ[a0] * PQ[b1])
                            + delta[a1][d0] * delta[b0][b1] * (PQ[a0] * PQ[c0])
                            + delta[a1][b0] * delta[b1][d0] * (PQ[a0] * PQ[c0])
                            + delta[b0][d0] * delta[a1][b1] * (PQ[a0] * PQ[c0])
                            + delta[a1][c0] * delta[b0][b1] * (PQ[a0] * PQ[d0])
                            + delta[a1][b0] * delta[b1][c0] * (PQ[a0] * PQ[d0])
                            + delta[b0][c0] * delta[a1][b1] * (PQ[a0] * PQ[d0])
                            + delta[a0][c0] * delta[b1][d0] * (PQ[a1] * PQ[b0])
                            + delta[a0][d0] * delta[b1][c0] * (PQ[a1] * PQ[b0])
                            + delta[a0][b1] * delta[c0][d0] * (PQ[a1] * PQ[b0])
                            + delta[a0][c0] * delta[b0][d0] * (PQ[a1] * PQ[b1])
                            + delta[a0][d0] * delta[b0][c0] * (PQ[a1] * PQ[b1])
                            + delta[a0][b0] * delta[c0][d0] * (PQ[a1] * PQ[b1])
                            + delta[a0][d0] * delta[b0][b1] * (PQ[a1] * PQ[c0])
                            + delta[a0][b0] * delta[b1][d0] * (PQ[a1] * PQ[c0])
                            + delta[b0][d0] * delta[a0][b1] * (PQ[a1] * PQ[c0])
                            + delta[a0][c0] * delta[b0][b1] * (PQ[a1] * PQ[d0])
                            + delta[a0][b0] * delta[b1][c0] * (PQ[a1] * PQ[d0])
                            + delta[b0][c0] * delta[a0][b1] * (PQ[a1] * PQ[d0])
                            + delta[a0][c0] * delta[a1][d0] * (PQ[b0] * PQ[b1])
                            + delta[a0][d0] * delta[a1][c0] * (PQ[b0] * PQ[b1])
                            + delta[a0][a1] * delta[c0][d0] * (PQ[b0] * PQ[b1])
                            + delta[a0][d0] * delta[a1][b1] * (PQ[b0] * PQ[c0])
                            + delta[a0][a1] * delta[b1][d0] * (PQ[b0] * PQ[c0])
                            + delta[a1][d0] * delta[a0][b1] * (PQ[b0] * PQ[c0])
                            + delta[a0][c0] * delta[a1][b1] * (PQ[b0] * PQ[d0])
                            + delta[a0][a1] * delta[b1][c0] * (PQ[b0] * PQ[d0])
                            + delta[a1][c0] * delta[a0][b1] * (PQ[b0] * PQ[d0])
                            + delta[a0][d0] * delta[a1][b0] * (PQ[b1] * PQ[c0])
                            + delta[a0][a1] * delta[b0][d0] * (PQ[b1] * PQ[c0])
                            + delta[a1][d0] * delta[a0][b0] * (PQ[b1] * PQ[c0])
                            + delta[a0][c0] * delta[a1][b0] * (PQ[b1] * PQ[d0])
                            + delta[a0][a1] * delta[b0][c0] * (PQ[b1] * PQ[d0])
                            + delta[a1][c0] * delta[a0][b0] * (PQ[b1] * PQ[d0])
                            + delta[a0][a1] * delta[b0][b1] * (PQ[c0] * PQ[d0])
                            + delta[a0][b0] * delta[a1][b1] * (PQ[c0] * PQ[d0])
                            + delta[a1][b0] * delta[a0][b1] * (PQ[c0] * PQ[d0])
                        )

                    )

                    +

                    F6_t[5] * (

                        ( S1 * S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0]
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0]
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0]
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0]
                        )

                    )

                    +

                    F6_t[5] * (

                        ( S1 * S2 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            
                            + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0)
                            + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0)
                        )

                    )

                    +

                    F6_t[5] * (

                        0.5 * ( S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            delta[c0][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * (-1.0))
                            + delta[b1][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[c0] * (-1.0))
                            + delta[b1][c0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[c0] * (-1.0))
                            + delta[b0][c0] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[b0][b1] * (PQ[a0] * PQ[a1] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a1][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a1][c0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a1][b1] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a1][b0] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][d0] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a0][c0] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][b1] * (PQ[a1] * PQ[b0] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][b0] * (PQ[a1] * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][a1] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0))
                        )

                    )

                    +

                    F6_t[6] * (

                        ( S1 * S1 * S2 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0]
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pp_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDSD0(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   sd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   sd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* sd_first_inds,
                       const uint32_t* sd_second_inds,
                       const uint32_t  sd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (sd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < sd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * sd_mat_Q[kl] * sd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = sd_first_inds[kl];
            const auto l = sd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = s_prim_info[k + s_prim_count * 0];
            const auto c_k = s_prim_info[k + s_prim_count * 1];
            const auto x_k = s_prim_info[k + s_prim_count * 2];
            const auto y_k = s_prim_info[k + s_prim_count * 3];
            const auto z_k = s_prim_info[k + s_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[2];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 1, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[0] * (

                        0.25 / ( S1 * S2 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PA_0 * PA_1)
                            + delta[a1][b1] * delta[d0][d1] * (PB_0 * PA_0)
                            + delta[a1][b0] * delta[d0][d1] * (PB_1 * PA_0)
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PA_1)
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PA_1)
                            + delta[a0][a1] * delta[d0][d1] * (PB_0 * PB_1)
                        )

                    )

                    +

                    F6_t[0] * (

                        0.5 / S1 * (
                            delta[b0][b1] * (PA_0 * PA_1 * QD_0 * QD_1)
                            + delta[a1][b1] * (PB_0 * PA_0 * QD_0 * QD_1)
                            + delta[a1][b0] * (PB_1 * PA_0 * QD_0 * QD_1)
                            + delta[a0][b1] * (PB_0 * PA_1 * QD_0 * QD_1)
                            + delta[a0][b0] * (PB_1 * PA_1 * QD_0 * QD_1)
                            + delta[a0][a1] * (PB_0 * PB_1 * QD_0 * QD_1)
                        )

                    )

                    +

                    F6_t[0] * (

                        0.5 / S2 * (
                            delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PA_1)
                        )

                    )

                    +

                    F6_t[0] * (

                        (
                            
                            + PB_0 * PB_1 * PA_0 * PA_1 * QD_0 * QD_1
                        )

                    )

                    +

                    F6_t[0] * (

                        0.125 / ( S1 * S1 * S2 ) * (
                            delta[a0][a1] * delta[b0][b1] * delta[d0][d1]
                            + delta[a0][b0] * delta[a1][b1] * delta[d0][d1]
                            + delta[a1][b0] * delta[a0][b1] * delta[d0][d1]
                        )

                    )

                    +

                    F6_t[0] * (

                        0.25 / ( S1 * S1 ) * (
                            delta[a0][a1] * delta[b0][b1] * (QD_0 * QD_1)
                            + delta[a0][b0] * delta[a1][b1] * (QD_0 * QD_1)
                            + delta[a1][b0] * delta[a0][b1] * (QD_0 * QD_1)
                        )

                    )

                    +

                    F6_t[1] * (

                        0.125 / ( S1 * S1 * S4 ) * (
                            delta[a0][a1] * delta[b0][b1] * delta[d0][d1] * (-2.0)
                            + delta[a0][b0] * delta[a1][b1] * delta[d0][d1] * (-2.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[d0][d1] * (-2.0)
                        )

                    )

                    +

                    F6_t[1] * (

                        0.125 / ( S1 * S2 * S4 ) * (
                            delta[a0][a1] * delta[b0][b1] * delta[d0][d1] * (-1.0)
                            + delta[a0][b0] * delta[a1][b1] * delta[d0][d1] * (-1.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[d0][d1] * (-1.0)
                        )

                    )

                    +

                    F6_t[1] * (

                        0.25 * S2 / ( S1 * S1 * S4 ) * (
                            delta[a0][a1] * delta[b0][b1] * (QD_0 * QD_1 * (-2.0))
                            + delta[a0][b0] * delta[a1][b1] * (QD_0 * QD_1 * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * (QD_0 * QD_1 * (-2.0))
                        )

                    )

                    +

                    F6_t[1] * (

                        0.25 / ( S1 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PA_0 * PA_1 * (-1.0) + PA_0 * PQ[a1] + PA_1 * PQ[a0])
                            + delta[a1][b1] * delta[d0][d1] * (PB_0 * PA_0 * (-1.0) + PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[a1][b0] * delta[d0][d1] * (PB_1 * PA_0 * (-1.0) + PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[a1][d1] * delta[b0][b1] * (PA_0 * QD_0)
                            + delta[a1][b0] * delta[b1][d1] * (PA_0 * QD_0)
                            + delta[b0][d1] * delta[a1][b1] * (PA_0 * QD_0)
                            + delta[a1][d0] * delta[b0][b1] * (PA_0 * QD_1)
                            + delta[a1][b0] * delta[b1][d0] * (PA_0 * QD_1)
                            + delta[b0][d0] * delta[a1][b1] * (PA_0 * QD_1)
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PA_1 * (-1.0) + PB_0 * PQ[a1] + PA_1 * PQ[b0])
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PA_1 * (-1.0) + PB_1 * PQ[a1] + PA_1 * PQ[b1])
                            + delta[a0][d1] * delta[b0][b1] * (PA_1 * QD_0)
                            + delta[a0][b0] * delta[b1][d1] * (PA_1 * QD_0)
                            + delta[b0][d1] * delta[a0][b1] * (PA_1 * QD_0)
                            + delta[a0][d0] * delta[b0][b1] * (PA_1 * QD_1)
                            + delta[a0][b0] * delta[b1][d0] * (PA_1 * QD_1)
                            + delta[b0][d0] * delta[a0][b1] * (PA_1 * QD_1)
                            + delta[a0][a1] * delta[d0][d1] * (PB_0 * PB_1 * (-1.0) + PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[a0][a1] * delta[b0][b1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][d1] * delta[a1][b1] * (PB_0 * QD_0)
                            + delta[a0][a1] * delta[b1][d1] * (PB_0 * QD_0)
                            + delta[a1][d1] * delta[a0][b1] * (PB_0 * QD_0)
                            + delta[a0][d0] * delta[a1][b1] * (PB_0 * QD_1)
                            + delta[a0][a1] * delta[b1][d0] * (PB_0 * QD_1)
                            + delta[a1][d0] * delta[a0][b1] * (PB_0 * QD_1)
                            + delta[a0][d1] * delta[a1][b0] * (PB_1 * QD_0)
                            + delta[a0][a1] * delta[b0][d1] * (PB_1 * QD_0)
                            + delta[a1][d1] * delta[a0][b0] * (PB_1 * QD_0)
                            + delta[a0][d0] * delta[a1][b0] * (PB_1 * QD_1)
                            + delta[a0][a1] * delta[b0][d0] * (PB_1 * QD_1)
                            + delta[a1][d0] * delta[a0][b0] * (PB_1 * QD_1)
                        )

                    )

                    +

                    F6_t[1] * (

                        0.25 / ( S2 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PA_0 * PA_1 * (-1.0))
                            + delta[a1][b1] * delta[d0][d1] * (PB_0 * PA_0 * (-1.0))
                            + delta[a1][b0] * delta[d0][d1] * (PB_1 * PA_0 * (-1.0))
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PA_1 * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PA_1 * (-1.0))
                            + delta[a0][a1] * delta[d0][d1] * (PB_0 * PB_1 * (-1.0))
                        )

                    )

                    +

                    F6_t[1] * (

                        0.5 * S1 / ( S2 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PA_1 * (-1.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * sd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDSD1(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   sd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   sd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* sd_first_inds,
                       const uint32_t* sd_second_inds,
                       const uint32_t  sd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (sd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < sd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * sd_mat_Q[kl] * sd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = sd_first_inds[kl];
            const auto l = sd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = s_prim_info[k + s_prim_count * 0];
            const auto c_k = s_prim_info[k + s_prim_count * 1];
            const auto x_k = s_prim_info[k + s_prim_count * 2];
            const auto y_k = s_prim_info[k + s_prim_count * 3];
            const auto z_k = s_prim_info[k + s_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[3];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[1] * (

                        0.5 * S2 / ( S1 * S4 ) * (
                            delta[b0][b1] * (PA_0 * PA_1 * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[a1] * QD_0 * QD_1 + PA_1 * PQ[a0] * QD_0 * QD_1)
                            + delta[a1][b1] * (PB_0 * PA_0 * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[a0] * QD_0 * QD_1 + PA_0 * PQ[b0] * QD_0 * QD_1)
                            + delta[a1][b0] * (PB_1 * PA_0 * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[a0] * QD_0 * QD_1 + PA_0 * PQ[b1] * QD_0 * QD_1)
                            + delta[a0][b1] * (PB_0 * PA_1 * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[a1] * QD_0 * QD_1 + PA_1 * PQ[b0] * QD_0 * QD_1)
                            + delta[a0][b0] * (PB_1 * PA_1 * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[a1] * QD_0 * QD_1 + PA_1 * PQ[b1] * QD_0 * QD_1)
                            + delta[a0][a1] * (PB_0 * PB_1 * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[b1] * QD_0 * QD_1 + PB_1 * PQ[b0] * QD_0 * QD_1)
                        )

                    )

                    +

                    F6_t[1] * (

                        0.5 / S4 * (
                            delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] + PB_0 * PB_1 * PA_1 * PQ[a0] + PB_0 * PA_0 * PA_1 * PQ[b1] + PB_1 * PA_0 * PA_1 * PQ[b0])
                            + delta[b1][d1] * (PB_0 * PA_0 * PA_1 * QD_0)
                            + delta[b1][d0] * (PB_0 * PA_0 * PA_1 * QD_1)
                            + delta[b0][d1] * (PB_1 * PA_0 * PA_1 * QD_0)
                            + delta[b0][d0] * (PB_1 * PA_0 * PA_1 * QD_1)
                            + delta[b0][b1] * (PA_0 * PA_1 * PQ[d0] * QD_1 * (-1.0) + PA_0 * PA_1 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][d1] * (PB_0 * PB_1 * PA_0 * QD_0)
                            + delta[a1][d0] * (PB_0 * PB_1 * PA_0 * QD_1)
                            + delta[a1][b1] * (PB_0 * PA_0 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][b0] * (PB_1 * PA_0 * PQ[d0] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][d1] * (PB_0 * PB_1 * PA_1 * QD_0)
                            + delta[a0][d0] * (PB_0 * PB_1 * PA_1 * QD_1)
                            + delta[a0][b1] * (PB_0 * PA_1 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PA_1 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][b0] * (PB_1 * PA_1 * PQ[d0] * QD_1 * (-1.0) + PB_1 * PA_1 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][a1] * (PB_0 * PB_1 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[d1] * QD_0 * (-1.0))
                        )

                    )

                    +

                    F6_t[1] * (

                        S1 / S4 * (
                            
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[d1] * QD_0 * (-1.0)
                        )

                    )

                    +

                    F6_t[1] * (

                        S2 / S4 * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * QD_0 * QD_1
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * QD_0 * QD_1
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * QD_0 * QD_1
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * QD_0 * QD_1
                        )

                    )

                    +

                    F6_t[2] * (

                        ( S1 * S1 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[d0] * PQ[d1]
                        )

                    )

                    +

                    F6_t[2] * (

                        ( S1 * S2 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d1] * QD_0 * (-1.0)
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d0] * QD_1 * (-1.0)
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d1] * QD_0 * (-1.0)
                        )

                    )

                    +

                    F6_t[2] * (

                        ( S2 * S2 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * QD_0 * QD_1
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * QD_0 * QD_1
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * QD_0 * QD_1
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * QD_0 * QD_1
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * QD_0 * QD_1
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * QD_0 * QD_1
                        )

                    )

                    +

                    F6_t[2] * (

                        0.25 * S2 / ( S1 * S4 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PA_0 * PQ[a1] * (-1.0) + PA_1 * PQ[a0] * (-1.0) + PQ[a0] * PQ[a1])
                            + delta[a1][b1] * delta[d0][d1] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0) + PQ[a0] * PQ[b0])
                            + delta[a1][b0] * delta[d0][d1] * (PB_1 * PQ[a0] * (-1.0) + PA_0 * PQ[b1] * (-1.0) + PQ[a0] * PQ[b1])
                            + delta[a1][d1] * delta[b0][b1] * (PA_0 * QD_0 * (-1.0) + PQ[a0] * QD_0)
                            + delta[a1][b0] * delta[b1][d1] * (PA_0 * QD_0 * (-1.0) + PQ[a0] * QD_0)
                            + delta[b0][d1] * delta[a1][b1] * (PA_0 * QD_0 * (-1.0) + PQ[a0] * QD_0)
                            + delta[a1][d0] * delta[b0][b1] * (PA_0 * QD_1 * (-1.0) + PQ[a0] * QD_1)
                            + delta[a1][b0] * delta[b1][d0] * (PA_0 * QD_1 * (-1.0) + PQ[a0] * QD_1)
                            + delta[b0][d0] * delta[a1][b1] * (PA_0 * QD_1 * (-1.0) + PQ[a0] * QD_1)
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PQ[a1] * (-1.0) + PA_1 * PQ[b0] * (-1.0) + PQ[a1] * PQ[b0])
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PQ[a1] * (-1.0) + PA_1 * PQ[b1] * (-1.0) + PQ[a1] * PQ[b1])
                            + delta[a0][d1] * delta[b0][b1] * (PA_1 * QD_0 * (-1.0) + PQ[a1] * QD_0)
                            + delta[a0][b0] * delta[b1][d1] * (PA_1 * QD_0 * (-1.0) + PQ[a1] * QD_0)
                            + delta[b0][d1] * delta[a0][b1] * (PA_1 * QD_0 * (-1.0) + PQ[a1] * QD_0)
                            + delta[a0][d0] * delta[b0][b1] * (PA_1 * QD_1 * (-1.0) + PQ[a1] * QD_1)
                            + delta[a0][b0] * delta[b1][d0] * (PA_1 * QD_1 * (-1.0) + PQ[a1] * QD_1)
                            + delta[b0][d0] * delta[a0][b1] * (PA_1 * QD_1 * (-1.0) + PQ[a1] * QD_1)
                            + delta[a0][a1] * delta[d0][d1] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0) + PQ[b0] * PQ[b1])
                            + delta[a0][d1] * delta[a1][b1] * (PB_0 * QD_0 * (-1.0) + PQ[b0] * QD_0)
                            + delta[a0][a1] * delta[b1][d1] * (PB_0 * QD_0 * (-1.0) + PQ[b0] * QD_0)
                            + delta[a1][d1] * delta[a0][b1] * (PB_0 * QD_0 * (-1.0) + PQ[b0] * QD_0)
                            + delta[a0][d0] * delta[a1][b1] * (PB_0 * QD_1 * (-1.0) + PQ[b0] * QD_1)
                            + delta[a0][a1] * delta[b1][d0] * (PB_0 * QD_1 * (-1.0) + PQ[b0] * QD_1)
                            + delta[a1][d0] * delta[a0][b1] * (PB_0 * QD_1 * (-1.0) + PQ[b0] * QD_1)
                            + delta[a0][d1] * delta[a1][b0] * (PB_1 * QD_0 * (-1.0) + PQ[b1] * QD_0)
                            + delta[a0][a1] * delta[b0][d1] * (PB_1 * QD_0 * (-1.0) + PQ[b1] * QD_0)
                            + delta[a1][d1] * delta[a0][b0] * (PB_1 * QD_0 * (-1.0) + PQ[b1] * QD_0)
                            + delta[a0][d0] * delta[a1][b0] * (PB_1 * QD_1 * (-1.0) + PQ[b1] * QD_1)
                            + delta[a0][a1] * delta[b0][d0] * (PB_1 * QD_1 * (-1.0) + PQ[b1] * QD_1)
                            + delta[a1][d0] * delta[a0][b0] * (PB_1 * QD_1 * (-1.0) + PQ[b1] * QD_1)
                            + delta[a0][a1] * delta[b0][b1] * (PQ[d0] * QD_1 * 2.0 + PQ[d1] * QD_0 * 2.0)
                            + delta[a0][b0] * delta[a1][b1] * (PQ[d0] * QD_1 * 2.0 + PQ[d1] * QD_0 * 2.0)
                            + delta[a1][b0] * delta[a0][b1] * (PQ[d0] * QD_1 * 2.0 + PQ[d1] * QD_0 * 2.0)
                        )

                    )

                    +

                    F6_t[2] * (

                        0.25 / ( S4 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PA_0 * PQ[a1] * (-1.0) + PA_1 * PQ[a0] * (-1.0) + PA_0 * PA_1)
                            + delta[b0][d0] * delta[b1][d1] * (PA_0 * PA_1)
                            + delta[b0][d1] * delta[b1][d0] * (PA_0 * PA_1)
                            + delta[a1][d0] * delta[b1][d1] * (PB_0 * PA_0)
                            + delta[a1][d1] * delta[b1][d0] * (PB_0 * PA_0)
                            + delta[a1][b1] * delta[d0][d1] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0) + PB_0 * PA_0)
                            + delta[a1][d0] * delta[b0][d1] * (PB_1 * PA_0)
                            + delta[a1][d1] * delta[b0][d0] * (PB_1 * PA_0)
                            + delta[a1][b0] * delta[d0][d1] * (PB_1 * PQ[a0] * (-1.0) + PA_0 * PQ[b1] * (-1.0) + PB_1 * PA_0)
                            + delta[a1][d1] * delta[b0][b1] * (PA_0 * PQ[d0] * (-1.0))
                            + delta[a1][b0] * delta[b1][d1] * (PA_0 * PQ[d0] * (-1.0))
                            + delta[b0][d1] * delta[a1][b1] * (PA_0 * PQ[d0] * (-1.0))
                            + delta[a1][d0] * delta[b0][b1] * (PA_0 * PQ[d1] * (-1.0))
                            + delta[a1][b0] * delta[b1][d0] * (PA_0 * PQ[d1] * (-1.0))
                            + delta[b0][d0] * delta[a1][b1] * (PA_0 * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[b1][d1] * (PB_0 * PA_1)
                            + delta[a0][d1] * delta[b1][d0] * (PB_0 * PA_1)
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PQ[a1] * (-1.0) + PA_1 * PQ[b0] * (-1.0) + PB_0 * PA_1)
                            + delta[a0][d0] * delta[b0][d1] * (PB_1 * PA_1)
                            + delta[a0][d1] * delta[b0][d0] * (PB_1 * PA_1)
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PQ[a1] * (-1.0) + PA_1 * PQ[b1] * (-1.0) + PB_1 * PA_1)
                            + delta[a0][d1] * delta[b0][b1] * (PA_1 * PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * (PA_1 * PQ[d0] * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * (PA_1 * PQ[d0] * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * (PA_1 * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * (PA_1 * PQ[d1] * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * (PA_1 * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[d0][d1] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0) + PB_0 * PB_1)
                            + delta[a0][d1] * delta[a1][b1] * (PB_0 * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[b1][d1] * (PB_0 * PQ[d0] * (-1.0))
                            + delta[a1][d1] * delta[a0][b1] * (PB_0 * PQ[d0] * (-1.0))
                            + delta[a0][d0] * delta[a1][b1] * (PB_0 * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b1][d0] * (PB_0 * PQ[d1] * (-1.0))
                            + delta[a1][d0] * delta[a0][b1] * (PB_0 * PQ[d1] * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * (PB_1 * PQ[d0] * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * (PB_1 * PQ[d0] * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * (PB_1 * PQ[d0] * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * (PB_1 * PQ[d1] * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * (PB_1 * PQ[d1] * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * (PB_1 * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[a1][d1] * (PB_0 * PB_1)
                            + delta[a0][d1] * delta[a1][d0] * (PB_0 * PB_1)
                            + delta[a0][a1] * delta[b0][b1] * (PQ[d0] * PQ[d1])
                            + delta[a0][b0] * delta[a1][b1] * (PQ[d0] * PQ[d1])
                            + delta[a1][b0] * delta[a0][b1] * (PQ[d0] * PQ[d1])
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * sd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDSD2(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   sd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   sd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* sd_first_inds,
                       const uint32_t* sd_second_inds,
                       const uint32_t  sd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (sd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < sd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * sd_mat_Q[kl] * sd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = sd_first_inds[kl];
            const auto l = sd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = s_prim_info[k + s_prim_count * 0];
            const auto c_k = s_prim_info[k + s_prim_count * 1];
            const auto x_k = s_prim_info[k + s_prim_count * 2];
            const auto y_k = s_prim_info[k + s_prim_count * 3];
            const auto z_k = s_prim_info[k + s_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[3];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[2] * (

                        0.5 * ( S2 * S2 ) / ( S1 * S4 * S4 ) * (
                            delta[b0][b1] * (PA_0 * PQ[a1] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[a0] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * QD_0 * QD_1)
                            + delta[a1][b1] * (PB_0 * PQ[a0] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[b0] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * QD_0 * QD_1)
                            + delta[a1][b0] * (PB_1 * PQ[a0] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[b1] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[b1] * QD_0 * QD_1)
                            + delta[a0][b1] * (PB_0 * PQ[a1] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[b0] * QD_0 * QD_1 * (-1.0) + PQ[a1] * PQ[b0] * QD_0 * QD_1)
                            + delta[a0][b0] * (PB_1 * PQ[a1] * QD_0 * QD_1 * (-1.0) + PA_1 * PQ[b1] * QD_0 * QD_1 * (-1.0) + PQ[a1] * PQ[b1] * QD_0 * QD_1)
                            + delta[a0][a1] * (PB_0 * PQ[b1] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[b0] * QD_0 * QD_1 * (-1.0) + PQ[b0] * PQ[b1] * QD_0 * QD_1)
                        )

                    )

                    +

                    F6_t[2] * (

                        0.5 * S1 / ( S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PQ[a1] * (-1.0) + PB_0 * PB_1 * PA_1 * PQ[a0] * (-1.0) + PB_0 * PA_0 * PA_1 * PQ[b1] * (-1.0) + PB_1 * PA_0 * PA_1 * PQ[b0] * (-1.0))
                            + delta[b1][d1] * (PB_0 * PA_0 * PA_1 * PQ[d0] * (-1.0))
                            + delta[b1][d0] * (PB_0 * PA_0 * PA_1 * PQ[d1] * (-1.0))
                            + delta[b0][d1] * (PB_1 * PA_0 * PA_1 * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PB_1 * PA_0 * PA_1 * PQ[d1] * (-1.0))
                            + delta[b0][b1] * (PA_0 * PA_1 * PQ[d0] * PQ[d1])
                            + delta[a1][d1] * (PB_0 * PB_1 * PA_0 * PQ[d0] * (-1.0))
                            + delta[a1][d0] * (PB_0 * PB_1 * PA_0 * PQ[d1] * (-1.0))
                            + delta[a1][b1] * (PB_0 * PA_0 * PQ[d0] * PQ[d1])
                            + delta[a1][b0] * (PB_1 * PA_0 * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * (PB_0 * PB_1 * PA_1 * PQ[d0] * (-1.0))
                            + delta[a0][d0] * (PB_0 * PB_1 * PA_1 * PQ[d1] * (-1.0))
                            + delta[a0][b1] * (PB_0 * PA_1 * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * (PB_1 * PA_1 * PQ[d0] * PQ[d1])
                            + delta[a0][a1] * (PB_0 * PB_1 * PQ[d0] * PQ[d1])
                        )

                    )

                    +

                    F6_t[2] * (

                        0.5 * S2 / ( S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] + PB_0 * PA_0 * PQ[a1] * PQ[b1] + PB_0 * PA_1 * PQ[a0] * PQ[b1] + PB_1 * PA_0 * PQ[a1] * PQ[b0] + PB_1 * PA_1 * PQ[a0] * PQ[b0] + PA_0 * PA_1 * PQ[b0] * PQ[b1])
                            + delta[b1][d1] * (PB_0 * PA_0 * PQ[a1] * QD_0 + PB_0 * PA_1 * PQ[a0] * QD_0 + PA_0 * PA_1 * PQ[b0] * QD_0)
                            + delta[b1][d0] * (PB_0 * PA_0 * PQ[a1] * QD_1 + PB_0 * PA_1 * PQ[a0] * QD_1 + PA_0 * PA_1 * PQ[b0] * QD_1)
                            + delta[b0][d1] * (PB_1 * PA_0 * PQ[a1] * QD_0 + PB_1 * PA_1 * PQ[a0] * QD_0 + PA_0 * PA_1 * PQ[b1] * QD_0)
                            + delta[b0][d0] * (PB_1 * PA_0 * PQ[a1] * QD_1 + PB_1 * PA_1 * PQ[a0] * QD_1 + PA_0 * PA_1 * PQ[b1] * QD_1)
                            + delta[b0][b1] * (PA_0 * PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[a1] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[a0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PA_1 * PQ[d0] * QD_1 + PA_0 * PA_1 * PQ[d1] * QD_0)
                            + delta[a1][d1] * (PB_0 * PB_1 * PQ[a0] * QD_0 + PB_0 * PA_0 * PQ[b1] * QD_0 + PB_1 * PA_0 * PQ[b0] * QD_0)
                            + delta[a1][d0] * (PB_0 * PB_1 * PQ[a0] * QD_1 + PB_0 * PA_0 * PQ[b1] * QD_1 + PB_1 * PA_0 * PQ[b0] * QD_1)
                            + delta[a1][b1] * (PB_0 * PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[d0] * QD_1 + PB_0 * PA_0 * PQ[d1] * QD_0)
                            + delta[a1][b0] * (PB_1 * PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[d0] * QD_1 + PB_1 * PA_0 * PQ[d1] * QD_0)
                            + delta[a0][d1] * (PB_0 * PB_1 * PQ[a1] * QD_0 + PB_0 * PA_1 * PQ[b1] * QD_0 + PB_1 * PA_1 * PQ[b0] * QD_0)
                            + delta[a0][d0] * (PB_0 * PB_1 * PQ[a1] * QD_1 + PB_0 * PA_1 * PQ[b1] * QD_1 + PB_1 * PA_1 * PQ[b0] * QD_1)
                            + delta[a0][b1] * (PB_0 * PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[a1] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PA_1 * PQ[d0] * QD_1 + PB_0 * PA_1 * PQ[d1] * QD_0)
                            + delta[a0][b0] * (PB_1 * PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[a1] * PQ[d1] * QD_0 * (-1.0) + PA_1 * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PA_1 * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PA_1 * PQ[d0] * QD_1 + PB_1 * PA_1 * PQ[d1] * QD_0)
                            + delta[a0][a1] * (PB_0 * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PB_1 * PQ[d0] * QD_1 + PB_0 * PB_1 * PQ[d1] * QD_0)
                        )

                    )

                    +

                    F6_t[2] * (

                        0.125 * S2 / ( S1 * S1 * S4 * S4 ) * (
                            delta[a0][a1] * delta[b0][b1] * delta[d0][d1]
                            + delta[a0][b0] * delta[a1][b1] * delta[d0][d1]
                            + delta[a1][b0] * delta[a0][b1] * delta[d0][d1]
                        )

                    )

                    +

                    F6_t[2] * (

                        0.125 / ( S1 * S4 * S4 ) * (
                            delta[a0][d0] * delta[a1][d1] * delta[b0][b1]
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][d1]
                            + delta[a0][d0] * delta[b0][d1] * delta[a1][b1]
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][b1]
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][d0]
                            + delta[a0][d1] * delta[b0][d0] * delta[a1][b1]
                            + delta[a0][a1] * delta[b0][b1] * delta[d0][d1] * 2.0
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][d1]
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][d0]
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][d1]
                            + delta[a1][d0] * delta[b0][d1] * delta[a0][b1]
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][d0]
                            + delta[a1][d1] * delta[b0][d0] * delta[a0][b1]
                            + delta[a0][b0] * delta[a1][b1] * delta[d0][d1] * 2.0
                            + delta[a1][b0] * delta[a0][b1] * delta[d0][d1] * 2.0
                        )

                    )

                    +

                    F6_t[2] * (

                        0.25 * ( S2 * S2 ) / ( S1 * S1 * S4 * S4 ) * (
                            delta[a0][a1] * delta[b0][b1] * (QD_0 * QD_1)
                            + delta[a0][b0] * delta[a1][b1] * (QD_0 * QD_1)
                            + delta[a1][b0] * delta[a0][b1] * (QD_0 * QD_1)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * sd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDSD3(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   sd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   sd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* sd_first_inds,
                       const uint32_t* sd_second_inds,
                       const uint32_t  sd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (sd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < sd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * sd_mat_Q[kl] * sd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = sd_first_inds[kl];
            const auto l = sd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = s_prim_info[k + s_prim_count * 0];
            const auto c_k = s_prim_info[k + s_prim_count * 1];
            const auto x_k = s_prim_info[k + s_prim_count * 2];
            const auto y_k = s_prim_info[k + s_prim_count * 3];
            const auto z_k = s_prim_info[k + s_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[4];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[3] * (

                        ( S1 * S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d0] * PQ[d1]
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d0] * PQ[d1]
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d0] * PQ[d1]
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d0] * PQ[d1]
                        )

                    )

                    +

                    F6_t[3] * (

                        ( S1 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * QD_1 * (-1.0)
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d1] * QD_0 * (-1.0)
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * (-1.0)
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * (-1.0)
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0)
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0)
                        )

                    )

                    +

                    F6_t[3] * (

                        ( S2 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * QD_0 * QD_1
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * QD_0 * QD_1
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * QD_1
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * QD_1
                        )

                    )

                    +

                    F6_t[3] * (

                        0.125 * S2 / ( S1 * S4 * S4 * S4 ) * (
                            delta[a0][d0] * delta[a1][d1] * delta[b0][b1] * (-1.0)
                            + delta[a0][d0] * delta[a1][b0] * delta[b1][d1] * (-1.0)
                            + delta[a0][d0] * delta[b0][d1] * delta[a1][b1] * (-1.0)
                            + delta[a0][d1] * delta[a1][d0] * delta[b0][b1] * (-1.0)
                            + delta[a0][d1] * delta[a1][b0] * delta[b1][d0] * (-1.0)
                            + delta[a0][d1] * delta[b0][d0] * delta[a1][b1] * (-1.0)
                            + delta[a0][a1] * delta[b0][b1] * delta[d0][d1] * (-1.0)
                            + delta[a0][a1] * delta[b0][d0] * delta[b1][d1] * (-1.0)
                            + delta[a0][a1] * delta[b0][d1] * delta[b1][d0] * (-1.0)
                            + delta[a1][d0] * delta[a0][b0] * delta[b1][d1] * (-1.0)
                            + delta[a1][d0] * delta[b0][d1] * delta[a0][b1] * (-1.0)
                            + delta[a1][d1] * delta[a0][b0] * delta[b1][d0] * (-1.0)
                            + delta[a1][d1] * delta[b0][d0] * delta[a0][b1] * (-1.0)
                            + delta[a0][b0] * delta[a1][b1] * delta[d0][d1] * (-1.0)
                            + delta[a1][b0] * delta[a0][b1] * delta[d0][d1] * (-1.0)
                        )

                    )

                    +

                    F6_t[3] * (

                        0.25 * ( S2 * S2 ) / ( S1 * S4 * S4 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PQ[a0] * PQ[a1] * (-1.0))
                            + delta[a1][b1] * delta[d0][d1] * (PQ[a0] * PQ[b0] * (-1.0))
                            + delta[a1][b0] * delta[d0][d1] * (PQ[a0] * PQ[b1] * (-1.0))
                            + delta[a1][d1] * delta[b0][b1] * (PQ[a0] * QD_0 * (-1.0))
                            + delta[a1][b0] * delta[b1][d1] * (PQ[a0] * QD_0 * (-1.0))
                            + delta[b0][d1] * delta[a1][b1] * (PQ[a0] * QD_0 * (-1.0))
                            + delta[a1][d0] * delta[b0][b1] * (PQ[a0] * QD_1 * (-1.0))
                            + delta[a1][b0] * delta[b1][d0] * (PQ[a0] * QD_1 * (-1.0))
                            + delta[b0][d0] * delta[a1][b1] * (PQ[a0] * QD_1 * (-1.0))
                            + delta[a0][b1] * delta[d0][d1] * (PQ[a1] * PQ[b0] * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PQ[a1] * PQ[b1] * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * (PQ[a1] * QD_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * (PQ[a1] * QD_0 * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * (PQ[a1] * QD_0 * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * (PQ[a1] * QD_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * (PQ[a1] * QD_1 * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * (PQ[a1] * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[d0][d1] * (PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][d1] * delta[a1][b1] * (PQ[b0] * QD_0 * (-1.0))
                            + delta[a0][a1] * delta[b1][d1] * (PQ[b0] * QD_0 * (-1.0))
                            + delta[a1][d1] * delta[a0][b1] * (PQ[b0] * QD_0 * (-1.0))
                            + delta[a0][d0] * delta[a1][b1] * (PQ[b0] * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[b1][d0] * (PQ[b0] * QD_1 * (-1.0))
                            + delta[a1][d0] * delta[a0][b1] * (PQ[b0] * QD_1 * (-1.0))
                            + delta[a0][d1] * delta[a1][b0] * (PQ[b1] * QD_0 * (-1.0))
                            + delta[a0][a1] * delta[b0][d1] * (PQ[b1] * QD_0 * (-1.0))
                            + delta[a1][d1] * delta[a0][b0] * (PQ[b1] * QD_0 * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * (PQ[b1] * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * (PQ[b1] * QD_1 * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * (PQ[b1] * QD_1 * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * sd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDSD4(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   sd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   sd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* sd_first_inds,
                       const uint32_t* sd_second_inds,
                       const uint32_t  sd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (sd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < sd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * sd_mat_Q[kl] * sd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = sd_first_inds[kl];
            const auto l = sd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = s_prim_info[k + s_prim_count * 0];
            const auto c_k = s_prim_info[k + s_prim_count * 1];
            const auto x_k = s_prim_info[k + s_prim_count * 2];
            const auto y_k = s_prim_info[k + s_prim_count * 3];
            const auto z_k = s_prim_info[k + s_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[4];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[3] * (

                        0.25 * S2 / ( S4 * S4 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PQ[a0] * PQ[a1] * (-1.0) + PA_0 * PQ[a1] + PA_1 * PQ[a0])
                            + delta[b0][d0] * delta[b1][d1] * (PA_0 * PQ[a1] + PA_1 * PQ[a0])
                            + delta[b0][d1] * delta[b1][d0] * (PA_0 * PQ[a1] + PA_1 * PQ[a0])
                            + delta[a1][d0] * delta[b1][d1] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[a1][d1] * delta[b1][d0] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[a1][b1] * delta[d0][d1] * (PQ[a0] * PQ[b0] * (-1.0) + PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[a1][d0] * delta[b0][d1] * (PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[a1][d1] * delta[b0][d0] * (PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[a1][b0] * delta[d0][d1] * (PQ[a0] * PQ[b1] * (-1.0) + PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[a1][d1] * delta[b0][b1] * (PQ[a0] * PQ[d0] * (-1.0) + PA_0 * PQ[d0])
                            + delta[a1][b0] * delta[b1][d1] * (PQ[a0] * PQ[d0] * (-1.0) + PA_0 * PQ[d0])
                            + delta[b0][d1] * delta[a1][b1] * (PQ[a0] * PQ[d0] * (-1.0) + PA_0 * PQ[d0])
                            + delta[a1][d0] * delta[b0][b1] * (PQ[a0] * PQ[d1] * (-1.0) + PA_0 * PQ[d1])
                            + delta[a1][b0] * delta[b1][d0] * (PQ[a0] * PQ[d1] * (-1.0) + PA_0 * PQ[d1])
                            + delta[b0][d0] * delta[a1][b1] * (PQ[a0] * PQ[d1] * (-1.0) + PA_0 * PQ[d1])
                            + delta[a0][d0] * delta[b1][d1] * (PB_0 * PQ[a1] + PA_1 * PQ[b0])
                            + delta[a0][d1] * delta[b1][d0] * (PB_0 * PQ[a1] + PA_1 * PQ[b0])
                            + delta[a0][b1] * delta[d0][d1] * (PQ[a1] * PQ[b0] * (-1.0) + PB_0 * PQ[a1] + PA_1 * PQ[b0])
                            + delta[a0][d0] * delta[b0][d1] * (PB_1 * PQ[a1] + PA_1 * PQ[b1])
                            + delta[a0][d1] * delta[b0][d0] * (PB_1 * PQ[a1] + PA_1 * PQ[b1])
                            + delta[a0][b0] * delta[d0][d1] * (PQ[a1] * PQ[b1] * (-1.0) + PB_1 * PQ[a1] + PA_1 * PQ[b1])
                            + delta[a0][d1] * delta[b0][b1] * (PQ[a1] * PQ[d0] * (-1.0) + PA_1 * PQ[d0])
                            + delta[a0][b0] * delta[b1][d1] * (PQ[a1] * PQ[d0] * (-1.0) + PA_1 * PQ[d0])
                            + delta[b0][d1] * delta[a0][b1] * (PQ[a1] * PQ[d0] * (-1.0) + PA_1 * PQ[d0])
                            + delta[a0][d0] * delta[b0][b1] * (PQ[a1] * PQ[d1] * (-1.0) + PA_1 * PQ[d1])
                            + delta[a0][b0] * delta[b1][d0] * (PQ[a1] * PQ[d1] * (-1.0) + PA_1 * PQ[d1])
                            + delta[b0][d0] * delta[a0][b1] * (PQ[a1] * PQ[d1] * (-1.0) + PA_1 * PQ[d1])
                            + delta[a0][a1] * delta[d0][d1] * (PQ[b0] * PQ[b1] * (-1.0) + PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[a0][d1] * delta[a1][b1] * (PQ[b0] * PQ[d0] * (-1.0) + PB_0 * PQ[d0])
                            + delta[a0][a1] * delta[b1][d1] * (PQ[b0] * PQ[d0] * (-1.0) + PB_0 * PQ[d0])
                            + delta[a1][d1] * delta[a0][b1] * (PQ[b0] * PQ[d0] * (-1.0) + PB_0 * PQ[d0])
                            + delta[a0][d0] * delta[a1][b1] * (PQ[b0] * PQ[d1] * (-1.0) + PB_0 * PQ[d1])
                            + delta[a0][a1] * delta[b1][d0] * (PQ[b0] * PQ[d1] * (-1.0) + PB_0 * PQ[d1])
                            + delta[a1][d0] * delta[a0][b1] * (PQ[b0] * PQ[d1] * (-1.0) + PB_0 * PQ[d1])
                            + delta[a0][d1] * delta[a1][b0] * (PQ[b1] * PQ[d0] * (-1.0) + PB_1 * PQ[d0])
                            + delta[a0][a1] * delta[b0][d1] * (PQ[b1] * PQ[d0] * (-1.0) + PB_1 * PQ[d0])
                            + delta[a1][d1] * delta[a0][b0] * (PQ[b1] * PQ[d0] * (-1.0) + PB_1 * PQ[d0])
                            + delta[a0][d0] * delta[a1][b0] * (PQ[b1] * PQ[d1] * (-1.0) + PB_1 * PQ[d1])
                            + delta[a0][a1] * delta[b0][d0] * (PQ[b1] * PQ[d1] * (-1.0) + PB_1 * PQ[d1])
                            + delta[a1][d0] * delta[a0][b0] * (PQ[b1] * PQ[d1] * (-1.0) + PB_1 * PQ[d1])
                            + delta[a0][a1] * delta[b0][b1] * (PQ[d0] * PQ[d1] * (-2.0))
                            + delta[a0][b0] * delta[a1][b1] * (PQ[d0] * PQ[d1] * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * (PQ[d0] * PQ[d1] * (-2.0))
                            + delta[a0][d0] * delta[a1][d1] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[a0][d1] * delta[a1][d0] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                        )

                    )

                    +

                    F6_t[3] * (

                        0.5 * ( S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[a1] * (-1.0) + PB_0 * PA_0 * PQ[a1] * PQ[b1] * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[b1] * (-1.0) + PB_1 * PA_0 * PQ[a1] * PQ[b0] * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[b0] * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[b1] * (-1.0))
                            + delta[b1][d1] * (PB_0 * PA_0 * PQ[a1] * PQ[d0] * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[d0] * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[b1][d0] * (PB_0 * PA_0 * PQ[a1] * PQ[d1] * (-1.0) + PB_0 * PA_1 * PQ[a0] * PQ[d1] * (-1.0) + PA_0 * PA_1 * PQ[b0] * PQ[d1] * (-1.0))
                            + delta[b0][d1] * (PB_1 * PA_0 * PQ[a1] * PQ[d0] * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[d0] * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PB_1 * PA_0 * PQ[a1] * PQ[d1] * (-1.0) + PB_1 * PA_1 * PQ[a0] * PQ[d1] * (-1.0) + PA_0 * PA_1 * PQ[b1] * PQ[d1] * (-1.0))
                            + delta[b0][b1] * (PA_0 * PA_1 * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[d0] * PQ[d1] + PA_1 * PQ[a0] * PQ[d0] * PQ[d1])
                            + delta[a1][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[d0] * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d0] * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a1][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a1][b1] * (PB_0 * PA_0 * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PQ[a0] * PQ[d0] * PQ[d1] + PA_0 * PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a1][b0] * (PB_1 * PA_0 * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[d0] * PQ[d1] + PA_0 * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * (PB_0 * PB_1 * PQ[a1] * PQ[d0] * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[d0] * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][d0] * (PB_0 * PB_1 * PQ[a1] * PQ[d1] * (-1.0) + PB_0 * PA_1 * PQ[b1] * PQ[d1] * (-1.0) + PB_1 * PA_1 * PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a0][b1] * (PB_0 * PA_1 * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PQ[a1] * PQ[d0] * PQ[d1] + PA_1 * PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * (PB_1 * PA_1 * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[a1] * PQ[d0] * PQ[d1] + PA_1 * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a0][a1] * (PB_0 * PB_1 * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PQ[b1] * PQ[d0] * PQ[d1] + PB_1 * PQ[b0] * PQ[d0] * PQ[d1])
                        )

                    )

                    +

                    F6_t[3] * (

                        0.5 * ( S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] + PA_1 * PQ[a0] * PQ[b0] * PQ[b1])
                            + delta[b1][d1] * (PB_0 * PQ[a0] * PQ[a1] * QD_0 + PA_0 * PQ[a1] * PQ[b0] * QD_0 + PA_1 * PQ[a0] * PQ[b0] * QD_0)
                            + delta[b1][d0] * (PB_0 * PQ[a0] * PQ[a1] * QD_1 + PA_0 * PQ[a1] * PQ[b0] * QD_1 + PA_1 * PQ[a0] * PQ[b0] * QD_1)
                            + delta[b0][d1] * (PB_1 * PQ[a0] * PQ[a1] * QD_0 + PA_0 * PQ[a1] * PQ[b1] * QD_0 + PA_1 * PQ[a0] * PQ[b1] * QD_0)
                            + delta[b0][d0] * (PB_1 * PQ[a0] * PQ[a1] * QD_1 + PA_0 * PQ[a1] * PQ[b1] * QD_1 + PA_1 * PQ[a0] * PQ[b1] * QD_1)
                            + delta[b0][b1] * (PQ[a0] * PQ[a1] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[a1] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[a1] * PQ[d0] * QD_1 + PA_0 * PQ[a1] * PQ[d1] * QD_0 + PA_1 * PQ[a0] * PQ[d0] * QD_1 + PA_1 * PQ[a0] * PQ[d1] * QD_0)
                            + delta[a1][d1] * (PB_0 * PQ[a0] * PQ[b1] * QD_0 + PB_1 * PQ[a0] * PQ[b0] * QD_0 + PA_0 * PQ[b0] * PQ[b1] * QD_0)
                            + delta[a1][d0] * (PB_0 * PQ[a0] * PQ[b1] * QD_1 + PB_1 * PQ[a0] * PQ[b0] * QD_1 + PA_0 * PQ[b0] * PQ[b1] * QD_1)
                            + delta[a1][b1] * (PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[a0] * PQ[d0] * QD_1 + PB_0 * PQ[a0] * PQ[d1] * QD_0 + PA_0 * PQ[b0] * PQ[d0] * QD_1 + PA_0 * PQ[b0] * PQ[d1] * QD_0)
                            + delta[a1][b0] * (PQ[a0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[d0] * QD_1 + PB_1 * PQ[a0] * PQ[d1] * QD_0 + PA_0 * PQ[b1] * PQ[d0] * QD_1 + PA_0 * PQ[b1] * PQ[d1] * QD_0)
                            + delta[a0][d1] * (PB_0 * PQ[a1] * PQ[b1] * QD_0 + PB_1 * PQ[a1] * PQ[b0] * QD_0 + PA_1 * PQ[b0] * PQ[b1] * QD_0)
                            + delta[a0][d0] * (PB_0 * PQ[a1] * PQ[b1] * QD_1 + PB_1 * PQ[a1] * PQ[b0] * QD_1 + PA_1 * PQ[b0] * PQ[b1] * QD_1)
                            + delta[a0][b1] * (PQ[a1] * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PQ[a1] * PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[a1] * PQ[d0] * QD_1 + PB_0 * PQ[a1] * PQ[d1] * QD_0 + PA_1 * PQ[b0] * PQ[d0] * QD_1 + PA_1 * PQ[b0] * PQ[d1] * QD_0)
                            + delta[a0][b0] * (PQ[a1] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[a1] * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[a1] * PQ[d0] * QD_1 + PB_1 * PQ[a1] * PQ[d1] * QD_0 + PA_1 * PQ[b1] * PQ[d0] * QD_1 + PA_1 * PQ[b1] * PQ[d1] * QD_0)
                            + delta[a0][a1] * (PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[b1] * PQ[d0] * QD_1 + PB_0 * PQ[b1] * PQ[d1] * QD_0 + PB_1 * PQ[b0] * PQ[d0] * QD_1 + PB_1 * PQ[b0] * PQ[d1] * QD_0)
                        )

                    )

                    +

                    F6_t[3] * (

                        0.5 * ( S2 * S2 * S2 ) / ( S1 * S4 * S4 * S4 ) * (
                            delta[b0][b1] * (PQ[a0] * PQ[a1] * QD_0 * QD_1 * (-1.0))
                            + delta[a1][b1] * (PQ[a0] * PQ[b0] * QD_0 * QD_1 * (-1.0))
                            + delta[a1][b0] * (PQ[a0] * PQ[b1] * QD_0 * QD_1 * (-1.0))
                            + delta[a0][b1] * (PQ[a1] * PQ[b0] * QD_0 * QD_1 * (-1.0))
                            + delta[a0][b0] * (PQ[a1] * PQ[b1] * QD_0 * QD_1 * (-1.0))
                            + delta[a0][a1] * (PQ[b0] * PQ[b1] * QD_0 * QD_1 * (-1.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * sd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDSD5(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   sd_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   sd_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* sd_first_inds,
                       const uint32_t* sd_second_inds,
                       const uint32_t  sd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (sd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < sd_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * sd_mat_Q[kl] * sd_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = sd_first_inds[kl];
            const auto l = sd_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = s_prim_info[k + s_prim_count * 0];
            const auto c_k = s_prim_info[k + s_prim_count * 1];
            const auto x_k = s_prim_info[k + s_prim_count * 2];
            const auto y_k = s_prim_info[k + s_prim_count * 3];
            const auto z_k = s_prim_info[k + s_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[7];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 6, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[4] * (

                        ( S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * PQ[d1]
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1]
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1]
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1]
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1]
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1]
                        )

                    )

                    +

                    F6_t[4] * (

                        ( S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * QD_1 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d1] * QD_0 * (-1.0)
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0)
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0)
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0)
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0)
                        )

                    )

                    +

                    F6_t[4] * (

                        ( S2 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * QD_0 * QD_1
                        )

                    )

                    +

                    F6_t[4] * (

                        0.5 * ( S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * (-1.0) + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * (-1.0))
                            + delta[b1][d1] * (PB_0 * PQ[a0] * PQ[a1] * PQ[d0] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[b1][d0] * (PB_0 * PQ[a0] * PQ[a1] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[b0] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[b0] * PQ[d1] * (-1.0))
                            + delta[b0][d1] * (PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PB_1 * PQ[a0] * PQ[a1] * PQ[d1] * (-1.0) + PA_0 * PQ[a1] * PQ[b1] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[b1] * PQ[d1] * (-1.0))
                            + delta[b0][b1] * (PA_0 * PQ[a1] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[a0] * PQ[d0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[a1] * PQ[d0] * PQ[d1])
                            + delta[a1][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a1][d0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a1][b1] * (PB_0 * PQ[a0] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a1][b0] * (PB_1 * PQ[a0] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * (PB_0 * PQ[a1] * PQ[b1] * PQ[d0] * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[d0] * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][d0] * (PB_0 * PQ[a1] * PQ[b1] * PQ[d1] * (-1.0) + PB_1 * PQ[a1] * PQ[b0] * PQ[d1] * (-1.0) + PA_1 * PQ[b0] * PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a0][b1] * (PB_0 * PQ[a1] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[b0] * PQ[d0] * PQ[d1] * (-1.0) + PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * (PB_1 * PQ[a1] * PQ[d0] * PQ[d1] * (-1.0) + PA_1 * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0) + PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a0][a1] * (PB_0 * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * PQ[d1] * (-1.0) + PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1])
                        )

                    )

                    +

                    F6_t[4] * (

                        0.25 * ( S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PQ[a0] * PQ[a1])
                            + delta[b0][d0] * delta[b1][d1] * (PQ[a0] * PQ[a1])
                            + delta[b0][d1] * delta[b1][d0] * (PQ[a0] * PQ[a1])
                            + delta[a1][d0] * delta[b1][d1] * (PQ[a0] * PQ[b0])
                            + delta[a1][d1] * delta[b1][d0] * (PQ[a0] * PQ[b0])
                            + delta[a1][b1] * delta[d0][d1] * (PQ[a0] * PQ[b0])
                            + delta[a1][d0] * delta[b0][d1] * (PQ[a0] * PQ[b1])
                            + delta[a1][d1] * delta[b0][d0] * (PQ[a0] * PQ[b1])
                            + delta[a1][b0] * delta[d0][d1] * (PQ[a0] * PQ[b1])
                            + delta[a1][d1] * delta[b0][b1] * (PQ[a0] * PQ[d0])
                            + delta[a1][b0] * delta[b1][d1] * (PQ[a0] * PQ[d0])
                            + delta[b0][d1] * delta[a1][b1] * (PQ[a0] * PQ[d0])
                            + delta[a1][d0] * delta[b0][b1] * (PQ[a0] * PQ[d1])
                            + delta[a1][b0] * delta[b1][d0] * (PQ[a0] * PQ[d1])
                            + delta[b0][d0] * delta[a1][b1] * (PQ[a0] * PQ[d1])
                            + delta[a0][d0] * delta[b1][d1] * (PQ[a1] * PQ[b0])
                            + delta[a0][d1] * delta[b1][d0] * (PQ[a1] * PQ[b0])
                            + delta[a0][b1] * delta[d0][d1] * (PQ[a1] * PQ[b0])
                            + delta[a0][d0] * delta[b0][d1] * (PQ[a1] * PQ[b1])
                            + delta[a0][d1] * delta[b0][d0] * (PQ[a1] * PQ[b1])
                            + delta[a0][b0] * delta[d0][d1] * (PQ[a1] * PQ[b1])
                            + delta[a0][d1] * delta[b0][b1] * (PQ[a1] * PQ[d0])
                            + delta[a0][b0] * delta[b1][d1] * (PQ[a1] * PQ[d0])
                            + delta[b0][d1] * delta[a0][b1] * (PQ[a1] * PQ[d0])
                            + delta[a0][d0] * delta[b0][b1] * (PQ[a1] * PQ[d1])
                            + delta[a0][b0] * delta[b1][d0] * (PQ[a1] * PQ[d1])
                            + delta[b0][d0] * delta[a0][b1] * (PQ[a1] * PQ[d1])
                            + delta[a0][d0] * delta[a1][d1] * (PQ[b0] * PQ[b1])
                            + delta[a0][d1] * delta[a1][d0] * (PQ[b0] * PQ[b1])
                            + delta[a0][a1] * delta[d0][d1] * (PQ[b0] * PQ[b1])
                            + delta[a0][d1] * delta[a1][b1] * (PQ[b0] * PQ[d0])
                            + delta[a0][a1] * delta[b1][d1] * (PQ[b0] * PQ[d0])
                            + delta[a1][d1] * delta[a0][b1] * (PQ[b0] * PQ[d0])
                            + delta[a0][d0] * delta[a1][b1] * (PQ[b0] * PQ[d1])
                            + delta[a0][a1] * delta[b1][d0] * (PQ[b0] * PQ[d1])
                            + delta[a1][d0] * delta[a0][b1] * (PQ[b0] * PQ[d1])
                            + delta[a0][d1] * delta[a1][b0] * (PQ[b1] * PQ[d0])
                            + delta[a0][a1] * delta[b0][d1] * (PQ[b1] * PQ[d0])
                            + delta[a1][d1] * delta[a0][b0] * (PQ[b1] * PQ[d0])
                            + delta[a0][d0] * delta[a1][b0] * (PQ[b1] * PQ[d1])
                            + delta[a0][a1] * delta[b0][d0] * (PQ[b1] * PQ[d1])
                            + delta[a1][d0] * delta[a0][b0] * (PQ[b1] * PQ[d1])
                            + delta[a0][a1] * delta[b0][b1] * (PQ[d0] * PQ[d1])
                            + delta[a0][b0] * delta[a1][b1] * (PQ[d0] * PQ[d1])
                            + delta[a1][b0] * delta[a0][b1] * (PQ[d0] * PQ[d1])
                        )

                    )

                    +

                    F6_t[4] * (

                        0.5 * ( S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1])
                            + delta[b1][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * QD_0)
                            + delta[b1][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * QD_1)
                            + delta[b0][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * QD_0)
                            + delta[b0][d0] * (PQ[a0] * PQ[a1] * PQ[b1] * QD_1)
                            + delta[b0][b1] * (PQ[a0] * PQ[a1] * PQ[d0] * QD_1 + PQ[a0] * PQ[a1] * PQ[d1] * QD_0)
                            + delta[a1][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * QD_0)
                            + delta[a1][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * QD_1)
                            + delta[a1][b1] * (PQ[a0] * PQ[b0] * PQ[d0] * QD_1 + PQ[a0] * PQ[b0] * PQ[d1] * QD_0)
                            + delta[a1][b0] * (PQ[a0] * PQ[b1] * PQ[d0] * QD_1 + PQ[a0] * PQ[b1] * PQ[d1] * QD_0)
                            + delta[a0][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * QD_0)
                            + delta[a0][d0] * (PQ[a1] * PQ[b0] * PQ[b1] * QD_1)
                            + delta[a0][b1] * (PQ[a1] * PQ[b0] * PQ[d0] * QD_1 + PQ[a1] * PQ[b0] * PQ[d1] * QD_0)
                            + delta[a0][b0] * (PQ[a1] * PQ[b1] * PQ[d0] * QD_1 + PQ[a1] * PQ[b1] * PQ[d1] * QD_0)
                            + delta[a0][a1] * (PQ[b0] * PQ[b1] * PQ[d0] * QD_1 + PQ[b0] * PQ[b1] * PQ[d1] * QD_0)
                        )

                    )

                    +

                    F6_t[5] * (

                        ( S1 * S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1]
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1]
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1]
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1]
                        )

                    )

                    +

                    F6_t[5] * (

                        0.5 * ( S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * (-1.0))
                            + delta[b1][d1] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[b1][d0] * (PQ[a0] * PQ[a1] * PQ[b0] * PQ[d1] * (-1.0))
                            + delta[b0][d1] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PQ[a0] * PQ[a1] * PQ[b1] * PQ[d1] * (-1.0))
                            + delta[b0][b1] * (PQ[a0] * PQ[a1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a1][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a1][b1] * (PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a1][b0] * (PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][d1] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][d0] * (PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a0][b1] * (PQ[a1] * PQ[b0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * (PQ[a1] * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][a1] * (PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0))
                        )

                    )

                    +

                    F6_t[5] * (

                        ( S1 * S2 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0)
                            + PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0)
                        )

                    )

                    +

                    F6_t[6] * (

                        ( S1 * S1 * S2 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1]
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * sd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDSP0(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   sp_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   sp_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* sp_first_inds,
                       const uint32_t* sp_second_inds,
                       const uint32_t  sp_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (sp_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < sp_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * sp_mat_Q[kl] * sp_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = sp_first_inds[kl];
            const auto l = sp_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = s_prim_info[k + s_prim_count * 0];
            const auto c_k = s_prim_info[k + s_prim_count * 1];
            const auto x_k = s_prim_info[k + s_prim_count * 2];
            const auto y_k = s_prim_info[k + s_prim_count * 3];
            const auto z_k = s_prim_info[k + s_prim_count * 4];

            const auto a_l = p_prim_info[l / 3 + p_prim_count * 0];
            const auto c_l = p_prim_info[l / 3 + p_prim_count * 1];
            const auto x_l = p_prim_info[l / 3 + p_prim_count * 2];
            const auto y_l = p_prim_info[l / 3 + p_prim_count * 3];
            const auto z_l = p_prim_info[l / 3 + p_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto d0 = l % 3;

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F5_t[3];

            gpu::computeBoysFunction(F5_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F5_t[0] * (

                        0.5 / S1 * (
                            delta[b0][b1] * (PA_0 * PA_1 * QD_0)
                            + delta[a1][b1] * (PB_0 * PA_0 * QD_0)
                            + delta[a1][b0] * (PB_1 * PA_0 * QD_0)
                            + delta[a0][b1] * (PB_0 * PA_1 * QD_0)
                            + delta[a0][b0] * (PB_1 * PA_1 * QD_0)
                            + delta[a0][a1] * (PB_0 * PB_1 * QD_0)
                        )

                    )

                    +

                    F5_t[0] * (

                        (
                            
                            + PB_0 * PB_1 * PA_0 * PA_1 * QD_0
                        )

                    )

                    +

                    F5_t[0] * (

                        0.25 / ( S1 * S1 ) * (
                            delta[a0][a1] * delta[b0][b1] * (QD_0)
                            + delta[a0][b0] * delta[a1][b1] * (QD_0)
                            + delta[a1][b0] * delta[a0][b1] * (QD_0)
                        )

                    )

                    +

                    F5_t[1] * (

                        0.25 * S2 / ( S1 * S1 * S4 ) * (
                            delta[a0][a1] * delta[b0][b1] * (QD_0 * (-2.0))
                            + delta[a0][b0] * delta[a1][b1] * (QD_0 * (-2.0))
                            + delta[a1][b0] * delta[a0][b1] * (QD_0 * (-2.0))
                        )

                    )

                    +

                    F5_t[1] * (

                        0.25 / ( S1 * S4 ) * (
                            delta[a1][d0] * delta[b0][b1] * (PA_0)
                            + delta[a1][b0] * delta[b1][d0] * (PA_0)
                            + delta[b0][d0] * delta[a1][b1] * (PA_0)
                            + delta[a0][d0] * delta[b0][b1] * (PA_1)
                            + delta[a0][b0] * delta[b1][d0] * (PA_1)
                            + delta[b0][d0] * delta[a0][b1] * (PA_1)
                            + delta[a0][a1] * delta[b0][b1] * (PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * (PQ[d0] * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * (PQ[d0] * (-1.0))
                            + delta[a0][d0] * delta[a1][b1] * (PB_0)
                            + delta[a0][a1] * delta[b1][d0] * (PB_0)
                            + delta[a1][d0] * delta[a0][b1] * (PB_0)
                            + delta[a0][d0] * delta[a1][b0] * (PB_1)
                            + delta[a0][a1] * delta[b0][d0] * (PB_1)
                            + delta[a1][d0] * delta[a0][b0] * (PB_1)
                        )

                    )

                    +

                    F5_t[1] * (

                        0.5 * S2 / ( S1 * S4 ) * (
                            delta[b0][b1] * (PA_0 * PA_1 * QD_0 * (-1.0) + PA_0 * PQ[a1] * QD_0 + PA_1 * PQ[a0] * QD_0)
                            + delta[a1][b1] * (PB_0 * PA_0 * QD_0 * (-1.0) + PB_0 * PQ[a0] * QD_0 + PA_0 * PQ[b0] * QD_0)
                            + delta[a1][b0] * (PB_1 * PA_0 * QD_0 * (-1.0) + PB_1 * PQ[a0] * QD_0 + PA_0 * PQ[b1] * QD_0)
                            + delta[a0][b1] * (PB_0 * PA_1 * QD_0 * (-1.0) + PB_0 * PQ[a1] * QD_0 + PA_1 * PQ[b0] * QD_0)
                            + delta[a0][b0] * (PB_1 * PA_1 * QD_0 * (-1.0) + PB_1 * PQ[a1] * QD_0 + PA_1 * PQ[b1] * QD_0)
                            + delta[a0][a1] * (PB_0 * PB_1 * QD_0 * (-1.0) + PB_0 * PQ[b1] * QD_0 + PB_1 * PQ[b0] * QD_0)
                        )

                    )

                    +

                    F5_t[1] * (

                        0.5 / S4 * (
                            delta[b1][d0] * (PB_0 * PA_0 * PA_1)
                            + delta[b0][d0] * (PB_1 * PA_0 * PA_1)
                            + delta[b0][b1] * (PA_0 * PA_1 * PQ[d0] * (-1.0))
                            + delta[a1][d0] * (PB_0 * PB_1 * PA_0)
                            + delta[a1][b1] * (PB_0 * PA_0 * PQ[d0] * (-1.0))
                            + delta[a1][b0] * (PB_1 * PA_0 * PQ[d0] * (-1.0))
                            + delta[a0][d0] * (PB_0 * PB_1 * PA_1)
                            + delta[a0][b1] * (PB_0 * PA_1 * PQ[d0] * (-1.0))
                            + delta[a0][b0] * (PB_1 * PA_1 * PQ[d0] * (-1.0))
                            + delta[a0][a1] * (PB_0 * PB_1 * PQ[d0] * (-1.0))
                        )

                    )

                    +

                    F5_t[1] * (

                        S1 / S4 * (
                            
                            + PB_0 * PB_1 * PA_0 * PA_1 * PQ[d0] * (-1.0)
                        )

                    )

                    +

                    F5_t[1] * (

                        S2 / S4 * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * QD_0
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * QD_0
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * QD_0
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * QD_0
                        )

                    )

                    +

                    F5_t[2] * (

                        ( S1 * S2 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[a1] * PQ[d0] * (-1.0)
                            + PB_0 * PB_1 * PA_1 * PQ[a0] * PQ[d0] * (-1.0)
                            + PB_0 * PA_0 * PA_1 * PQ[b1] * PQ[d0] * (-1.0)
                            + PB_1 * PA_0 * PA_1 * PQ[b0] * PQ[d0] * (-1.0)
                        )

                    )

                    +

                    F5_t[2] * (

                        ( S2 * S2 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * QD_0
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * QD_0
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * QD_0
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * QD_0
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * QD_0
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * QD_0
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * sp_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDSP1(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   sp_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   sp_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* sp_first_inds,
                       const uint32_t* sp_second_inds,
                       const uint32_t  sp_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (sp_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < sp_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * sp_mat_Q[kl] * sp_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = sp_first_inds[kl];
            const auto l = sp_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = s_prim_info[k + s_prim_count * 0];
            const auto c_k = s_prim_info[k + s_prim_count * 1];
            const auto x_k = s_prim_info[k + s_prim_count * 2];
            const auto y_k = s_prim_info[k + s_prim_count * 3];
            const auto z_k = s_prim_info[k + s_prim_count * 4];

            const auto a_l = p_prim_info[l / 3 + p_prim_count * 0];
            const auto c_l = p_prim_info[l / 3 + p_prim_count * 1];
            const auto x_l = p_prim_info[l / 3 + p_prim_count * 2];
            const auto y_l = p_prim_info[l / 3 + p_prim_count * 3];
            const auto z_l = p_prim_info[l / 3 + p_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto d0 = l % 3;

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F5_t[4];

            gpu::computeBoysFunction(F5_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F5_t[2] * (

                        0.25 * S2 / ( S1 * S4 * S4 ) * (
                            delta[a1][d0] * delta[b0][b1] * (PA_0 * (-1.0) + PQ[a0])
                            + delta[a1][b0] * delta[b1][d0] * (PA_0 * (-1.0) + PQ[a0])
                            + delta[b0][d0] * delta[a1][b1] * (PA_0 * (-1.0) + PQ[a0])
                            + delta[a0][d0] * delta[b0][b1] * (PA_1 * (-1.0) + PQ[a1])
                            + delta[a0][b0] * delta[b1][d0] * (PA_1 * (-1.0) + PQ[a1])
                            + delta[b0][d0] * delta[a0][b1] * (PA_1 * (-1.0) + PQ[a1])
                            + delta[a0][d0] * delta[a1][b1] * (PB_0 * (-1.0) + PQ[b0])
                            + delta[a0][a1] * delta[b1][d0] * (PB_0 * (-1.0) + PQ[b0])
                            + delta[a1][d0] * delta[a0][b1] * (PB_0 * (-1.0) + PQ[b0])
                            + delta[a0][d0] * delta[a1][b0] * (PB_1 * (-1.0) + PQ[b1])
                            + delta[a0][a1] * delta[b0][d0] * (PB_1 * (-1.0) + PQ[b1])
                            + delta[a1][d0] * delta[a0][b0] * (PB_1 * (-1.0) + PQ[b1])
                            + delta[a0][a1] * delta[b0][b1] * (PQ[d0] * 2.0)
                            + delta[a0][b0] * delta[a1][b1] * (PQ[d0] * 2.0)
                            + delta[a1][b0] * delta[a0][b1] * (PQ[d0] * 2.0)
                        )

                    )

                    +

                    F5_t[2] * (

                        0.5 * ( S2 * S2 ) / ( S1 * S4 * S4 ) * (
                            delta[b0][b1] * (PA_0 * PQ[a1] * QD_0 * (-1.0) + PA_1 * PQ[a0] * QD_0 * (-1.0) + PQ[a0] * PQ[a1] * QD_0)
                            + delta[a1][b1] * (PB_0 * PQ[a0] * QD_0 * (-1.0) + PA_0 * PQ[b0] * QD_0 * (-1.0) + PQ[a0] * PQ[b0] * QD_0)
                            + delta[a1][b0] * (PB_1 * PQ[a0] * QD_0 * (-1.0) + PA_0 * PQ[b1] * QD_0 * (-1.0) + PQ[a0] * PQ[b1] * QD_0)
                            + delta[a0][b1] * (PB_0 * PQ[a1] * QD_0 * (-1.0) + PA_1 * PQ[b0] * QD_0 * (-1.0) + PQ[a1] * PQ[b0] * QD_0)
                            + delta[a0][b0] * (PB_1 * PQ[a1] * QD_0 * (-1.0) + PA_1 * PQ[b1] * QD_0 * (-1.0) + PQ[a1] * PQ[b1] * QD_0)
                            + delta[a0][a1] * (PB_0 * PQ[b1] * QD_0 * (-1.0) + PB_1 * PQ[b0] * QD_0 * (-1.0) + PQ[b0] * PQ[b1] * QD_0)
                        )

                    )

                    +

                    F5_t[2] * (

                        0.5 * S2 / ( S4 * S4 ) * (
                            delta[b1][d0] * (PB_0 * PA_0 * PQ[a1] + PB_0 * PA_1 * PQ[a0] + PA_0 * PA_1 * PQ[b0])
                            + delta[b0][d0] * (PB_1 * PA_0 * PQ[a1] + PB_1 * PA_1 * PQ[a0] + PA_0 * PA_1 * PQ[b1])
                            + delta[b0][b1] * (PA_0 * PQ[a1] * PQ[d0] * (-1.0) + PA_1 * PQ[a0] * PQ[d0] * (-1.0) + PA_0 * PA_1 * PQ[d0])
                            + delta[a1][d0] * (PB_0 * PB_1 * PQ[a0] + PB_0 * PA_0 * PQ[b1] + PB_1 * PA_0 * PQ[b0])
                            + delta[a1][b1] * (PB_0 * PQ[a0] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * (-1.0) + PB_0 * PA_0 * PQ[d0])
                            + delta[a1][b0] * (PB_1 * PQ[a0] * PQ[d0] * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * (-1.0) + PB_1 * PA_0 * PQ[d0])
                            + delta[a0][d0] * (PB_0 * PB_1 * PQ[a1] + PB_0 * PA_1 * PQ[b1] + PB_1 * PA_1 * PQ[b0])
                            + delta[a0][b1] * (PB_0 * PQ[a1] * PQ[d0] * (-1.0) + PA_1 * PQ[b0] * PQ[d0] * (-1.0) + PB_0 * PA_1 * PQ[d0])
                            + delta[a0][b0] * (PB_1 * PQ[a1] * PQ[d0] * (-1.0) + PA_1 * PQ[b1] * PQ[d0] * (-1.0) + PB_1 * PA_1 * PQ[d0])
                            + delta[a0][a1] * (PB_0 * PQ[b1] * PQ[d0] * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * (-1.0) + PB_0 * PB_1 * PQ[d0])
                        )

                    )

                    +

                    F5_t[2] * (

                        0.25 * ( S2 * S2 ) / ( S1 * S1 * S4 * S4 ) * (
                            delta[a0][a1] * delta[b0][b1] * (QD_0)
                            + delta[a0][b0] * delta[a1][b1] * (QD_0)
                            + delta[a1][b0] * delta[a0][b1] * (QD_0)
                        )

                    )

                    +

                    F5_t[3] * (

                        ( S1 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[a1] * PQ[d0] * (-1.0)
                            + PB_0 * PA_0 * PQ[a1] * PQ[b1] * PQ[d0] * (-1.0)
                            + PB_0 * PA_1 * PQ[a0] * PQ[b1] * PQ[d0] * (-1.0)
                            + PB_1 * PA_0 * PQ[a1] * PQ[b0] * PQ[d0] * (-1.0)
                            + PB_1 * PA_1 * PQ[a0] * PQ[b0] * PQ[d0] * (-1.0)
                            + PA_0 * PA_1 * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0)
                        )

                    )

                    +

                    F5_t[3] * (

                        ( S2 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * QD_0
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * QD_0
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * QD_0
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * QD_0
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * sp_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockDDSP2(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   sp_mat_D,
                       const double*   dd_mat_Q_local,
                       const double*   sp_mat_Q,
                       const uint32_t* dd_first_inds_local,
                       const uint32_t* dd_second_inds_local,
                       const uint32_t  dd_prim_pair_count_local,
                       const uint32_t* sp_first_inds,
                       const uint32_t* sp_second_inds,
                       const uint32_t  sp_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (sp_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < sp_prim_pair_count) && (ij < dd_prim_pair_count_local) && (fabs(dd_mat_Q_local[ij] * sp_mat_Q[kl] * sp_mat_D[kl]) > eri_threshold))
        {
            const auto i = dd_first_inds_local[ij];
            const auto j = dd_second_inds_local[ij];

            const auto k = sp_first_inds[kl];
            const auto l = sp_second_inds[kl];

            const auto a_i = d_prim_info[i / 6 + d_prim_count * 0];
            const auto c_i = d_prim_info[i / 6 + d_prim_count * 1];
            const auto x_i = d_prim_info[i / 6 + d_prim_count * 2];
            const auto y_i = d_prim_info[i / 6 + d_prim_count * 3];
            const auto z_i = d_prim_info[i / 6 + d_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = s_prim_info[k + s_prim_count * 0];
            const auto c_k = s_prim_info[k + s_prim_count * 1];
            const auto x_k = s_prim_info[k + s_prim_count * 2];
            const auto y_k = s_prim_info[k + s_prim_count * 3];
            const auto z_k = s_prim_info[k + s_prim_count * 4];

            const auto a_l = p_prim_info[l / 3 + p_prim_count * 0];
            const auto c_l = p_prim_info[l / 3 + p_prim_count * 1];
            const auto x_l = p_prim_info[l / 3 + p_prim_count * 2];
            const auto y_l = p_prim_info[l / 3 + p_prim_count * 3];
            const auto z_l = p_prim_info[l / 3 + p_prim_count * 4];

            const auto a0 = d_cart_inds[i % 6][0];
            const auto a1 = d_cart_inds[i % 6][1];
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto d0 = l % 3;

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F5_t[6];

            gpu::computeBoysFunction(F5_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 5, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PA_1 = (a_j / (a_i + a_j)) * rij[a1];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F5_t[3] * (

                        0.25 * ( S2 * S2 ) / ( S1 * S4 * S4 * S4 ) * (
                            delta[a1][d0] * delta[b0][b1] * (PQ[a0] * (-1.0))
                            + delta[a1][b0] * delta[b1][d0] * (PQ[a0] * (-1.0))
                            + delta[b0][d0] * delta[a1][b1] * (PQ[a0] * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * (PQ[a1] * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * (PQ[a1] * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * (PQ[a1] * (-1.0))
                            + delta[a0][d0] * delta[a1][b1] * (PQ[b0] * (-1.0))
                            + delta[a0][a1] * delta[b1][d0] * (PQ[b0] * (-1.0))
                            + delta[a1][d0] * delta[a0][b1] * (PQ[b0] * (-1.0))
                            + delta[a0][d0] * delta[a1][b0] * (PQ[b1] * (-1.0))
                            + delta[a0][a1] * delta[b0][d0] * (PQ[b1] * (-1.0))
                            + delta[a1][d0] * delta[a0][b0] * (PQ[b1] * (-1.0))
                            + delta[a0][a1] * delta[b0][b1] * (PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[a1][b1] * (PQ[d0] * (-1.0))
                            + delta[a1][b0] * delta[a0][b1] * (PQ[d0] * (-1.0))
                        )

                    )

                    +

                    F5_t[3] * (

                        0.5 * ( S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            delta[b1][d0] * (PB_0 * PQ[a0] * PQ[a1] + PA_0 * PQ[a1] * PQ[b0] + PA_1 * PQ[a0] * PQ[b0])
                            + delta[b0][d0] * (PB_1 * PQ[a0] * PQ[a1] + PA_0 * PQ[a1] * PQ[b1] + PA_1 * PQ[a0] * PQ[b1])
                            + delta[b0][b1] * (PQ[a0] * PQ[a1] * PQ[d0] * (-1.0) + PA_0 * PQ[a1] * PQ[d0] + PA_1 * PQ[a0] * PQ[d0])
                            + delta[a1][d0] * (PB_0 * PQ[a0] * PQ[b1] + PB_1 * PQ[a0] * PQ[b0] + PA_0 * PQ[b0] * PQ[b1])
                            + delta[a1][b1] * (PQ[a0] * PQ[b0] * PQ[d0] * (-1.0) + PB_0 * PQ[a0] * PQ[d0] + PA_0 * PQ[b0] * PQ[d0])
                            + delta[a1][b0] * (PQ[a0] * PQ[b1] * PQ[d0] * (-1.0) + PB_1 * PQ[a0] * PQ[d0] + PA_0 * PQ[b1] * PQ[d0])
                            + delta[a0][d0] * (PB_0 * PQ[a1] * PQ[b1] + PB_1 * PQ[a1] * PQ[b0] + PA_1 * PQ[b0] * PQ[b1])
                            + delta[a0][b1] * (PQ[a1] * PQ[b0] * PQ[d0] * (-1.0) + PB_0 * PQ[a1] * PQ[d0] + PA_1 * PQ[b0] * PQ[d0])
                            + delta[a0][b0] * (PQ[a1] * PQ[b1] * PQ[d0] * (-1.0) + PB_1 * PQ[a1] * PQ[d0] + PA_1 * PQ[b1] * PQ[d0])
                            + delta[a0][a1] * (PQ[b0] * PQ[b1] * PQ[d0] * (-1.0) + PB_0 * PQ[b1] * PQ[d0] + PB_1 * PQ[b0] * PQ[d0])
                        )

                    )

                    +

                    F5_t[3] * (

                        0.5 * ( S2 * S2 * S2 ) / ( S1 * S4 * S4 * S4 ) * (
                            delta[b0][b1] * (PQ[a0] * PQ[a1] * QD_0 * (-1.0))
                            + delta[a1][b1] * (PQ[a0] * PQ[b0] * QD_0 * (-1.0))
                            + delta[a1][b0] * (PQ[a0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[a0][b1] * (PQ[a1] * PQ[b0] * QD_0 * (-1.0))
                            + delta[a0][b0] * (PQ[a1] * PQ[b1] * QD_0 * (-1.0))
                            + delta[a0][a1] * (PQ[b0] * PQ[b1] * QD_0 * (-1.0))
                        )

                    )

                    +

                    F5_t[4] * (

                        ( S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[a1] * PQ[b1] * PQ[d0] * (-1.0)
                            + PB_1 * PQ[a0] * PQ[a1] * PQ[b0] * PQ[d0] * (-1.0)
                            + PA_0 * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0)
                            + PA_1 * PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0)
                        )

                    )

                    +

                    F5_t[4] * (

                        ( S2 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * QD_0
                        )

                    )

                    +

                    F5_t[4] * (

                        0.5 * ( S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[b1][d0] * (PQ[a0] * PQ[a1] * PQ[b0])
                            + delta[b0][d0] * (PQ[a0] * PQ[a1] * PQ[b1])
                            + delta[b0][b1] * (PQ[a0] * PQ[a1] * PQ[d0])
                            + delta[a1][d0] * (PQ[a0] * PQ[b0] * PQ[b1])
                            + delta[a1][b1] * (PQ[a0] * PQ[b0] * PQ[d0])
                            + delta[a1][b0] * (PQ[a0] * PQ[b1] * PQ[d0])
                            + delta[a0][d0] * (PQ[a1] * PQ[b0] * PQ[b1])
                            + delta[a0][b1] * (PQ[a1] * PQ[b0] * PQ[d0])
                            + delta[a0][b0] * (PQ[a1] * PQ[b1] * PQ[d0])
                            + delta[a0][a1] * (PQ[b0] * PQ[b1] * PQ[d0])
                        )

                    )

                    +

                    F5_t[5] * (

                        ( S1 * S2 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[a1] * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * sp_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < dd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDDD0(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[2];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 1, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[0] * (

                        0.125 / ( S1 * S2 * S2 ) * (
                            delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (PA_0)
                            + delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (PA_0)
                            + delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (PA_0)
                            + delta[a0][b1] * delta[c0][c1] * delta[d0][d1] * (PB_0)
                            + delta[a0][b1] * delta[c0][d0] * delta[c1][d1] * (PB_0)
                            + delta[a0][b1] * delta[c1][d0] * delta[c0][d1] * (PB_0)
                            + delta[a0][b0] * delta[c0][c1] * delta[d0][d1] * (PB_1)
                            + delta[a0][b0] * delta[c0][d0] * delta[c1][d1] * (PB_1)
                            + delta[a0][b0] * delta[c1][d0] * delta[c0][d1] * (PB_1)
                        )

                    )

                    +

                    F7_t[0] * (

                        0.25 / ( S1 * S2 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PA_0 * QC_0 * QC_1)
                            + delta[b0][b1] * delta[c1][d1] * (PA_0 * QD_0 * QC_0)
                            + delta[b0][b1] * delta[c1][d0] * (PA_0 * QD_1 * QC_0)
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * QD_0 * QC_1)
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * QD_1 * QC_1)
                            + delta[b0][b1] * delta[c0][c1] * (PA_0 * QD_0 * QD_1)
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * QC_0 * QC_1)
                            + delta[a0][b1] * delta[c1][d1] * (PB_0 * QD_0 * QC_0)
                            + delta[a0][b1] * delta[c1][d0] * (PB_0 * QD_1 * QC_0)
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * QD_0 * QC_1)
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * QD_1 * QC_1)
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * QC_0 * QC_1)
                            + delta[a0][b0] * delta[c1][d1] * (PB_1 * QD_0 * QC_0)
                            + delta[a0][b0] * delta[c1][d0] * (PB_1 * QD_1 * QC_0)
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * QD_0 * QC_1)
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * QD_1 * QC_1)
                            + delta[a0][b1] * delta[c0][c1] * (PB_0 * QD_0 * QD_1)
                            + delta[a0][b0] * delta[c0][c1] * (PB_1 * QD_0 * QD_1)
                        )

                    )

                    +

                    F7_t[0] * (

                        0.25 / ( S2 * S2 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PB_1 * PA_0)
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PB_1 * PA_0)
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PB_1 * PA_0)
                        )

                    )

                    +

                    F7_t[0] * (

                        0.5 / S1 * (
                            delta[b0][b1] * (PA_0 * QD_0 * QD_1 * QC_0 * QC_1)
                            + delta[a0][b1] * (PB_0 * QD_0 * QD_1 * QC_0 * QC_1)
                            + delta[a0][b0] * (PB_1 * QD_0 * QD_1 * QC_0 * QC_1)
                        )

                    )

                    +

                    F7_t[0] * (

                        0.5 / S2 * (
                            delta[d0][d1] * (PB_0 * PB_1 * PA_0 * QC_0 * QC_1)
                            + delta[c1][d1] * (PB_0 * PB_1 * PA_0 * QD_0 * QC_0)
                            + delta[c1][d0] * (PB_0 * PB_1 * PA_0 * QD_1 * QC_0)
                            + delta[c0][d1] * (PB_0 * PB_1 * PA_0 * QD_0 * QC_1)
                            + delta[c0][d0] * (PB_0 * PB_1 * PA_0 * QD_1 * QC_1)
                            + delta[c0][c1] * (PB_0 * PB_1 * PA_0 * QD_0 * QD_1)
                        )

                    )

                    +

                    F7_t[0] * (

                        (
                            
                            + PB_0 * PB_1 * PA_0 * QD_0 * QD_1 * QC_0 * QC_1
                        )

                    )

                    +

                    F7_t[1] * (

                        0.125 / ( S1 * S2 * S4 ) * (
                            delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (PA_0 * (-1.0) + PQ[a0])
                            + delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (PA_0 * (-1.0) + PQ[a0])
                            + delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (PA_0 * (-1.0) + PQ[a0])
                            + delta[a0][b1] * delta[c0][c1] * delta[d0][d1] * (PB_0 * (-1.0) + PQ[b0])
                            + delta[a0][b1] * delta[c0][d0] * delta[c1][d1] * (PB_0 * (-1.0) + PQ[b0])
                            + delta[a0][b1] * delta[c1][d0] * delta[c0][d1] * (PB_0 * (-1.0) + PQ[b0])
                            + delta[a0][b0] * delta[c0][c1] * delta[d0][d1] * (PB_1 * (-1.0) + PQ[b1])
                            + delta[a0][b0] * delta[c0][d0] * delta[c1][d1] * (PB_1 * (-1.0) + PQ[b1])
                            + delta[a0][b0] * delta[c1][d0] * delta[c0][d1] * (PB_1 * (-1.0) + PQ[b1])
                            + delta[a0][c1] * delta[b0][b1] * delta[d0][d1] * (QC_0)
                            + delta[a0][d0] * delta[b0][b1] * delta[c1][d1] * (QC_0)
                            + delta[a0][d1] * delta[b0][b1] * delta[c1][d0] * (QC_0)
                            + delta[a0][b0] * delta[b1][c1] * delta[d0][d1] * (QC_0)
                            + delta[a0][b0] * delta[b1][d0] * delta[c1][d1] * (QC_0)
                            + delta[a0][b0] * delta[b1][d1] * delta[c1][d0] * (QC_0)
                            + delta[b0][c1] * delta[a0][b1] * delta[d0][d1] * (QC_0)
                            + delta[b0][d0] * delta[a0][b1] * delta[c1][d1] * (QC_0)
                            + delta[b0][d1] * delta[a0][b1] * delta[c1][d0] * (QC_0)
                            + delta[a0][c0] * delta[b0][b1] * delta[d0][d1] * (QC_1)
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][d1] * (QC_1)
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][d0] * (QC_1)
                            + delta[a0][b0] * delta[b1][c0] * delta[d0][d1] * (QC_1)
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][d1] * (QC_1)
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][d0] * (QC_1)
                            + delta[b0][c0] * delta[a0][b1] * delta[d0][d1] * (QC_1)
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][d1] * (QC_1)
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][d0] * (QC_1)
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d1] * (QD_0)
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d1] * (QD_0)
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][c1] * (QD_0)
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d1] * (QD_0)
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d1] * (QD_0)
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][c1] * (QD_0)
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d1] * (QD_0)
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d1] * (QD_0)
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][c1] * (QD_0)
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d0] * (QD_1)
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d0] * (QD_1)
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][c1] * (QD_1)
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d0] * (QD_1)
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d0] * (QD_1)
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][c1] * (QD_1)
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d0] * (QD_1)
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d0] * (QD_1)
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][c1] * (QD_1)
                        )

                    )

                    +

                    F7_t[1] * (

                        0.125 / ( S2 * S2 * S4 ) * (
                            delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (PA_0 * (-2.0))
                            + delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (PA_0 * (-2.0))
                            + delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (PA_0 * (-2.0))
                            + delta[a0][b1] * delta[c0][c1] * delta[d0][d1] * (PB_0 * (-2.0))
                            + delta[a0][b1] * delta[c0][d0] * delta[c1][d1] * (PB_0 * (-2.0))
                            + delta[a0][b1] * delta[c1][d0] * delta[c0][d1] * (PB_0 * (-2.0))
                            + delta[a0][b0] * delta[c0][c1] * delta[d0][d1] * (PB_1 * (-2.0))
                            + delta[a0][b0] * delta[c0][d0] * delta[c1][d1] * (PB_1 * (-2.0))
                            + delta[a0][b0] * delta[c1][d0] * delta[c0][d1] * (PB_1 * (-2.0))
                        )

                    )

                    +

                    F7_t[1] * (

                        0.25 * S1 / ( S2 * S2 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PB_1 * PA_0 * (-2.0))
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PB_1 * PA_0 * (-2.0))
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PB_1 * PA_0 * (-2.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDDD1(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[2];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 1, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[1] * (

                        0.25 / ( S1 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PA_0 * QC_0 * QC_1 * (-1.0) + PQ[a0] * QC_0 * QC_1)
                            + delta[b0][b1] * delta[c1][d1] * (PA_0 * QD_0 * QC_0 * (-1.0) + PQ[a0] * QD_0 * QC_0)
                            + delta[b0][b1] * delta[c1][d0] * (PA_0 * QD_1 * QC_0 * (-1.0) + PQ[a0] * QD_1 * QC_0)
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * QD_0 * QC_1 * (-1.0) + PQ[a0] * QD_0 * QC_1)
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * QD_1 * QC_1 * (-1.0) + PQ[a0] * QD_1 * QC_1)
                            + delta[b0][b1] * delta[c0][c1] * (PA_0 * QD_0 * QD_1 * (-1.0) + PQ[a0] * QD_0 * QD_1)
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * QC_0 * QC_1 * (-1.0) + PQ[b0] * QC_0 * QC_1)
                            + delta[a0][b1] * delta[c1][d1] * (PB_0 * QD_0 * QC_0 * (-1.0) + PQ[b0] * QD_0 * QC_0)
                            + delta[a0][b1] * delta[c1][d0] * (PB_0 * QD_1 * QC_0 * (-1.0) + PQ[b0] * QD_1 * QC_0)
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * QD_0 * QC_1 * (-1.0) + PQ[b0] * QD_0 * QC_1)
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * QD_1 * QC_1 * (-1.0) + PQ[b0] * QD_1 * QC_1)
                            + delta[a0][b1] * delta[c0][c1] * (PB_0 * QD_0 * QD_1 * (-1.0) + PQ[b0] * QD_0 * QD_1)
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * QC_0 * QC_1 * (-1.0) + PQ[b1] * QC_0 * QC_1)
                            + delta[a0][b0] * delta[c1][d1] * (PB_1 * QD_0 * QC_0 * (-1.0) + PQ[b1] * QD_0 * QC_0)
                            + delta[a0][b0] * delta[c1][d0] * (PB_1 * QD_1 * QC_0 * (-1.0) + PQ[b1] * QD_1 * QC_0)
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * QD_0 * QC_1 * (-1.0) + PQ[b1] * QD_0 * QC_1)
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * QD_1 * QC_1 * (-1.0) + PQ[b1] * QD_1 * QC_1)
                            + delta[a0][b0] * delta[c0][c1] * (PB_1 * QD_0 * QD_1 * (-1.0) + PQ[b1] * QD_0 * QD_1)
                            + delta[a0][d1] * delta[b0][b1] * (QD_0 * QC_0 * QC_1)
                            + delta[a0][b0] * delta[b1][d1] * (QD_0 * QC_0 * QC_1)
                            + delta[b0][d1] * delta[a0][b1] * (QD_0 * QC_0 * QC_1)
                            + delta[a0][d0] * delta[b0][b1] * (QD_1 * QC_0 * QC_1)
                            + delta[a0][b0] * delta[b1][d0] * (QD_1 * QC_0 * QC_1)
                            + delta[b0][d0] * delta[a0][b1] * (QD_1 * QC_0 * QC_1)
                            + delta[a0][c1] * delta[b0][b1] * (QD_0 * QD_1 * QC_0)
                            + delta[a0][b0] * delta[b1][c1] * (QD_0 * QD_1 * QC_0)
                            + delta[b0][c1] * delta[a0][b1] * (QD_0 * QD_1 * QC_0)
                            + delta[a0][c0] * delta[b0][b1] * (QD_0 * QD_1 * QC_1)
                            + delta[a0][b0] * delta[b1][c0] * (QD_0 * QD_1 * QC_1)
                            + delta[b0][c0] * delta[a0][b1] * (QD_0 * QD_1 * QC_1)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDDD2(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[2];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 1, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[1] * (

                        0.25 / ( S2 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] + PB_0 * PA_0 * PQ[b1] + PB_1 * PA_0 * PQ[b0])
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PB_1 * PQ[a0] + PB_0 * PA_0 * PQ[b1] + PB_1 * PA_0 * PQ[b0])
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] + PB_0 * PA_0 * PQ[b1] + PB_1 * PA_0 * PQ[b0])
                            + delta[b1][c1] * delta[d0][d1] * (PB_0 * PA_0 * QC_0)
                            + delta[b1][d0] * delta[c1][d1] * (PB_0 * PA_0 * QC_0)
                            + delta[b1][d1] * delta[c1][d0] * (PB_0 * PA_0 * QC_0)
                            + delta[b1][c0] * delta[d0][d1] * (PB_0 * PA_0 * QC_1)
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * PA_0 * QC_1)
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * PA_0 * QC_1)
                            + delta[b1][c0] * delta[c1][d1] * (PB_0 * PA_0 * QD_0)
                            + delta[b1][c1] * delta[c0][d1] * (PB_0 * PA_0 * QD_0)
                            + delta[b1][d1] * delta[c0][c1] * (PB_0 * PA_0 * QD_0)
                            + delta[b1][c0] * delta[c1][d0] * (PB_0 * PA_0 * QD_1)
                            + delta[b1][c1] * delta[c0][d0] * (PB_0 * PA_0 * QD_1)
                            + delta[b1][d0] * delta[c0][c1] * (PB_0 * PA_0 * QD_1)
                            + delta[b0][c1] * delta[d0][d1] * (PB_1 * PA_0 * QC_0)
                            + delta[b0][d0] * delta[c1][d1] * (PB_1 * PA_0 * QC_0)
                            + delta[b0][d1] * delta[c1][d0] * (PB_1 * PA_0 * QC_0)
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * PA_0 * QC_1)
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * PA_0 * QC_1)
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * PA_0 * QC_1)
                            + delta[b0][c0] * delta[c1][d1] * (PB_1 * PA_0 * QD_0)
                            + delta[b0][c1] * delta[c0][d1] * (PB_1 * PA_0 * QD_0)
                            + delta[b0][d1] * delta[c0][c1] * (PB_1 * PA_0 * QD_0)
                            + delta[b0][c0] * delta[c1][d0] * (PB_1 * PA_0 * QD_1)
                            + delta[b0][c1] * delta[c0][d0] * (PB_1 * PA_0 * QD_1)
                            + delta[b0][d0] * delta[c0][c1] * (PB_1 * PA_0 * QD_1)
                            + delta[b0][b1] * delta[d0][d1] * (PA_0 * PQ[c0] * QC_1 * (-1.0) + PA_0 * PQ[c1] * QC_0 * (-1.0) + PA_0 * QC_0 * QC_1 * (-1.0))
                            + delta[b0][b1] * delta[c1][d1] * (PA_0 * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[d0] * QC_0 * (-1.0) + PA_0 * QD_0 * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c1][d0] * (PA_0 * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[d1] * QC_0 * (-1.0) + PA_0 * QD_1 * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * PQ[c1] * QD_0 * (-1.0) + PA_0 * PQ[d0] * QC_1 * (-1.0) + PA_0 * QD_0 * QC_1 * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * PQ[c1] * QD_1 * (-1.0) + PA_0 * PQ[d1] * QC_1 * (-1.0) + PA_0 * QD_1 * QC_1 * (-1.0))
                            + delta[b0][b1] * delta[c0][c1] * (PA_0 * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[d1] * QD_0 * (-1.0) + PA_0 * QD_0 * QD_1 * (-1.0))
                            + delta[a0][c1] * delta[d0][d1] * (PB_0 * PB_1 * QC_0)
                            + delta[a0][d0] * delta[c1][d1] * (PB_0 * PB_1 * QC_0)
                            + delta[a0][d1] * delta[c1][d0] * (PB_0 * PB_1 * QC_0)
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * PB_1 * QC_1)
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * PB_1 * QC_1)
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * PB_1 * QC_1)
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PQ[c0] * QC_1 * (-1.0) + PB_0 * PQ[c1] * QC_0 * (-1.0) + PB_0 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][b1] * delta[c1][d1] * (PB_0 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[d0] * QC_0 * (-1.0) + PB_0 * QD_0 * QC_0 * (-1.0))
                            + delta[a0][b1] * delta[c1][d0] * (PB_0 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[d1] * QC_0 * (-1.0) + PB_0 * QD_1 * QC_0 * (-1.0))
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * PQ[c1] * QD_0 * (-1.0) + PB_0 * PQ[d0] * QC_1 * (-1.0) + PB_0 * QD_0 * QC_1 * (-1.0))
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PQ[c1] * QD_1 * (-1.0) + PB_0 * PQ[d1] * QC_1 * (-1.0) + PB_0 * QD_1 * QC_1 * (-1.0))
                            + delta[a0][b1] * delta[c0][c1] * (PB_0 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[d1] * QD_0 * (-1.0) + PB_0 * QD_0 * QD_1 * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PQ[c0] * QC_1 * (-1.0) + PB_1 * PQ[c1] * QC_0 * (-1.0) + PB_1 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[c1][d1] * (PB_1 * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[d0] * QC_0 * (-1.0) + PB_1 * QD_0 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c1][d0] * (PB_1 * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[d1] * QC_0 * (-1.0) + PB_1 * QD_1 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * PQ[c1] * QD_0 * (-1.0) + PB_1 * PQ[d0] * QC_1 * (-1.0) + PB_1 * QD_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PQ[c1] * QD_1 * (-1.0) + PB_1 * PQ[d1] * QC_1 * (-1.0) + PB_1 * QD_1 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[c0][c1] * (PB_1 * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[d1] * QD_0 * (-1.0) + PB_1 * QD_0 * QD_1 * (-1.0))
                            + delta[a0][c0] * delta[c1][d1] * (PB_0 * PB_1 * QD_0)
                            + delta[a0][c1] * delta[c0][d1] * (PB_0 * PB_1 * QD_0)
                            + delta[a0][d1] * delta[c0][c1] * (PB_0 * PB_1 * QD_0)
                            + delta[a0][c0] * delta[c1][d0] * (PB_0 * PB_1 * QD_1)
                            + delta[a0][c1] * delta[c0][d0] * (PB_0 * PB_1 * QD_1)
                            + delta[a0][d0] * delta[c0][c1] * (PB_0 * PB_1 * QD_1)
                        )

                    )

                    +

                    F7_t[1] * (

                        0.5 * S1 / ( S2 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PQ[c0] * QC_1 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[c1] * QC_0 * (-1.0) + PB_0 * PB_1 * PA_0 * QC_0 * QC_1 * (-1.0))
                            + delta[c1][d1] * (PB_0 * PB_1 * PA_0 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[d0] * QC_0 * (-1.0) + PB_0 * PB_1 * PA_0 * QD_0 * QC_0 * (-1.0))
                            + delta[c1][d0] * (PB_0 * PB_1 * PA_0 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[d1] * QC_0 * (-1.0) + PB_0 * PB_1 * PA_0 * QD_1 * QC_0 * (-1.0))
                            + delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PQ[c1] * QD_0 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[d0] * QC_1 * (-1.0) + PB_0 * PB_1 * PA_0 * QD_0 * QC_1 * (-1.0))
                            + delta[c0][d0] * (PB_0 * PB_1 * PA_0 * PQ[c1] * QD_1 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[d1] * QC_1 * (-1.0) + PB_0 * PB_1 * PA_0 * QD_1 * QC_1 * (-1.0))
                            + delta[c0][c1] * (PB_0 * PB_1 * PA_0 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PB_1 * PA_0 * PQ[d1] * QD_0 * (-1.0) + PB_0 * PB_1 * PA_0 * QD_0 * QD_1 * (-1.0))
                        )

                    )

                    +

                    F7_t[1] * (

                        0.5 * S2 / ( S1 * S4 ) * (
                            delta[b0][b1] * (PA_0 * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[a0] * QD_0 * QD_1 * QC_0 * QC_1)
                            + delta[a0][b1] * (PB_0 * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[b0] * QD_0 * QD_1 * QC_0 * QC_1)
                            + delta[a0][b0] * (PB_1 * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDDD3(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[3];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[1] * (

                        0.5 / S4 * (
                            delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * QC_0 * QC_1 + PB_0 * PA_0 * PQ[b1] * QC_0 * QC_1 + PB_1 * PA_0 * PQ[b0] * QC_0 * QC_1)
                            + delta[c1][d1] * (PB_0 * PB_1 * PQ[a0] * QD_0 * QC_0 + PB_0 * PA_0 * PQ[b1] * QD_0 * QC_0 + PB_1 * PA_0 * PQ[b0] * QD_0 * QC_0)
                            + delta[c1][d0] * (PB_0 * PB_1 * PQ[a0] * QD_1 * QC_0 + PB_0 * PA_0 * PQ[b1] * QD_1 * QC_0 + PB_1 * PA_0 * PQ[b0] * QD_1 * QC_0)
                            + delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] * QD_0 * QC_1 + PB_0 * PA_0 * PQ[b1] * QD_0 * QC_1 + PB_1 * PA_0 * PQ[b0] * QD_0 * QC_1)
                            + delta[c0][d0] * (PB_0 * PB_1 * PQ[a0] * QD_1 * QC_1 + PB_0 * PA_0 * PQ[b1] * QD_1 * QC_1 + PB_1 * PA_0 * PQ[b0] * QD_1 * QC_1)
                            + delta[c0][c1] * (PB_0 * PB_1 * PQ[a0] * QD_0 * QD_1 + PB_0 * PA_0 * PQ[b1] * QD_0 * QD_1 + PB_1 * PA_0 * PQ[b0] * QD_0 * QD_1)
                            + delta[b1][d1] * (PB_0 * PA_0 * QD_0 * QC_0 * QC_1)
                            + delta[b1][d0] * (PB_0 * PA_0 * QD_1 * QC_0 * QC_1)
                            + delta[b1][c1] * (PB_0 * PA_0 * QD_0 * QD_1 * QC_0)
                            + delta[b1][c0] * (PB_0 * PA_0 * QD_0 * QD_1 * QC_1)
                            + delta[b0][d1] * (PB_1 * PA_0 * QD_0 * QC_0 * QC_1)
                            + delta[b0][d0] * (PB_1 * PA_0 * QD_1 * QC_0 * QC_1)
                            + delta[b0][c1] * (PB_1 * PA_0 * QD_0 * QD_1 * QC_0)
                            + delta[b0][c0] * (PB_1 * PA_0 * QD_0 * QD_1 * QC_1)
                            + delta[b0][b1] * (PA_0 * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][d1] * (PB_0 * PB_1 * QD_0 * QC_0 * QC_1)
                            + delta[a0][d0] * (PB_0 * PB_1 * QD_1 * QC_0 * QC_1)
                            + delta[a0][c1] * (PB_0 * PB_1 * QD_0 * QD_1 * QC_0)
                            + delta[a0][c0] * (PB_0 * PB_1 * QD_0 * QD_1 * QC_1)
                            + delta[a0][b1] * (PB_0 * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PB_0 * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * (PB_1 * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0))
                        )

                    )

                    +

                    F7_t[1] * (

                        S1 / S4 * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                        )

                    )

                    +

                    F7_t[1] * (

                        S2 / S4 * (
                            
                            + PB_0 * PB_1 * PQ[a0] * QD_0 * QD_1 * QC_0 * QC_1
                            + PB_0 * PA_0 * PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1
                            + PB_1 * PA_0 * PQ[b0] * QD_0 * QD_1 * QC_0 * QC_1
                        )

                    )

                    +

                    F7_t[2] * (

                        ( S1 * S1 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PB_0 * PB_1 * PA_0 * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PB_0 * PB_1 * PA_0 * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PB_0 * PB_1 * PA_0 * PQ[d0] * PQ[d1] * QC_0 * QC_1
                        )

                    )

                    +

                    F7_t[2] * (

                        ( S1 * S2 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PB_0 * PB_1 * PQ[a0] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PB_1 * PQ[a0] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PB_0 * PB_1 * PQ[a0] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                            + PB_0 * PA_0 * PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PB_0 * PA_0 * PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PA_0 * PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PB_0 * PA_0 * PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                            + PB_1 * PA_0 * PQ[b0] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PB_1 * PA_0 * PQ[b0] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PB_1 * PA_0 * PQ[b0] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PB_1 * PA_0 * PQ[b0] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                        )

                    )

                    +

                    F7_t[2] * (

                        ( S2 * S2 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1
                            + PB_1 * PQ[a0] * PQ[b0] * QD_0 * QD_1 * QC_0 * QC_1
                            + PA_0 * PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1
                        )

                    )

                    +

                    F7_t[2] * (

                        0.125 * S1 / ( S2 * S2 * S4 * S4 ) * (
                            delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (PA_0)
                            + delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (PA_0)
                            + delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (PA_0)
                            + delta[a0][b1] * delta[c0][c1] * delta[d0][d1] * (PB_0)
                            + delta[a0][b1] * delta[c0][d0] * delta[c1][d1] * (PB_0)
                            + delta[a0][b1] * delta[c1][d0] * delta[c0][d1] * (PB_0)
                            + delta[a0][b0] * delta[c0][c1] * delta[d0][d1] * (PB_1)
                            + delta[a0][b0] * delta[c0][d0] * delta[c1][d1] * (PB_1)
                            + delta[a0][b0] * delta[c1][d0] * delta[c0][d1] * (PB_1)
                        )

                    )

                    +

                    F7_t[2] * (

                        0.125 / ( S1 * S4 * S4 ) * (
                            delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (PQ[a0] * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (PQ[a0] * (-1.0))
                            + delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (PQ[a0] * (-1.0))
                            + delta[a0][b1] * delta[c0][c1] * delta[d0][d1] * (PQ[b0] * (-1.0))
                            + delta[a0][b1] * delta[c0][d0] * delta[c1][d1] * (PQ[b0] * (-1.0))
                            + delta[a0][b1] * delta[c1][d0] * delta[c0][d1] * (PQ[b0] * (-1.0))
                            + delta[a0][b0] * delta[c0][c1] * delta[d0][d1] * (PQ[b1] * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * delta[c1][d1] * (PQ[b1] * (-1.0))
                            + delta[a0][b0] * delta[c1][d0] * delta[c0][d1] * (PQ[b1] * (-1.0))
                            + delta[a0][c1] * delta[b0][b1] * delta[d0][d1] * (QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * delta[c1][d1] * (QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * delta[c1][d0] * (QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][c1] * delta[d0][d1] * (QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * delta[c1][d1] * (QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * delta[c1][d0] * (QC_0 * (-1.0))
                            + delta[b0][c1] * delta[a0][b1] * delta[d0][d1] * (QC_0 * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * delta[c1][d1] * (QC_0 * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * delta[c1][d0] * (QC_0 * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * delta[d0][d1] * (QC_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][d1] * (QC_1 * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][d0] * (QC_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * delta[d0][d1] * (QC_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][d1] * (QC_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][d0] * (QC_1 * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * delta[d0][d1] * (QC_1 * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][d1] * (QC_1 * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][d0] * (QC_1 * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d1] * (QD_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d1] * (QD_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][c1] * (QD_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d1] * (QD_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d1] * (QD_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][c1] * (QD_0 * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d1] * (QD_0 * (-1.0))
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d1] * (QD_0 * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][c1] * (QD_0 * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d0] * (QD_1 * (-1.0))
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d0] * (QD_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][c1] * (QD_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d0] * (QD_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d0] * (QD_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][c1] * (QD_1 * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d0] * (QD_1 * (-1.0))
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d0] * (QD_1 * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][c1] * (QD_1 * (-1.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDDD4(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[3];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[2] * (

                        0.125 / ( S2 * S4 * S4 ) * (
                            delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (PQ[a0] * (-2.0) + PA_0 * 2.0)
                            + delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (PQ[a0] * (-2.0) + PA_0 * 2.0)
                            + delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (PQ[a0] * (-2.0) + PA_0 * 2.0)
                            + delta[b0][c0] * delta[b1][c1] * delta[d0][d1] * (PA_0)
                            + delta[b0][c0] * delta[b1][d0] * delta[c1][d1] * (PA_0)
                            + delta[b0][c0] * delta[b1][d1] * delta[c1][d0] * (PA_0)
                            + delta[b0][c1] * delta[b1][c0] * delta[d0][d1] * (PA_0)
                            + delta[b0][c1] * delta[b1][d0] * delta[c0][d1] * (PA_0)
                            + delta[b0][c1] * delta[b1][d1] * delta[c0][d0] * (PA_0)
                            + delta[b0][d0] * delta[b1][c0] * delta[c1][d1] * (PA_0)
                            + delta[b0][d0] * delta[b1][c1] * delta[c0][d1] * (PA_0)
                            + delta[b0][d0] * delta[b1][d1] * delta[c0][c1] * (PA_0)
                            + delta[b0][d1] * delta[b1][c0] * delta[c1][d0] * (PA_0)
                            + delta[b0][d1] * delta[b1][c1] * delta[c0][d0] * (PA_0)
                            + delta[b0][d1] * delta[b1][d0] * delta[c0][c1] * (PA_0)
                            + delta[a0][b1] * delta[c0][c1] * delta[d0][d1] * (PQ[b0] * (-2.0) + PB_0 * 2.0)
                            + delta[a0][b1] * delta[c0][d0] * delta[c1][d1] * (PQ[b0] * (-2.0) + PB_0 * 2.0)
                            + delta[a0][b1] * delta[c1][d0] * delta[c0][d1] * (PQ[b0] * (-2.0) + PB_0 * 2.0)
                            + delta[a0][b0] * delta[c0][c1] * delta[d0][d1] * (PQ[b1] * (-2.0) + PB_1 * 2.0)
                            + delta[a0][b0] * delta[c0][d0] * delta[c1][d1] * (PQ[b1] * (-2.0) + PB_1 * 2.0)
                            + delta[a0][b0] * delta[c1][d0] * delta[c0][d1] * (PQ[b1] * (-2.0) + PB_1 * 2.0)
                            + delta[a0][c1] * delta[b0][b1] * delta[d0][d1] * (PQ[c0] * (-1.0) + QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * delta[c1][d1] * (PQ[c0] * (-1.0) + QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * delta[c1][d0] * (PQ[c0] * (-1.0) + QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][c1] * delta[d0][d1] * (PQ[c0] * (-1.0) + QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * delta[c1][d1] * (PQ[c0] * (-1.0) + QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * delta[c1][d0] * (PQ[c0] * (-1.0) + QC_0 * (-1.0))
                            + delta[b0][c1] * delta[a0][b1] * delta[d0][d1] * (PQ[c0] * (-1.0) + QC_0 * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * delta[c1][d1] * (PQ[c0] * (-1.0) + QC_0 * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * delta[c1][d0] * (PQ[c0] * (-1.0) + QC_0 * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * delta[d0][d1] * (PQ[c1] * (-1.0) + QC_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][d1] * (PQ[c1] * (-1.0) + QC_1 * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][d0] * (PQ[c1] * (-1.0) + QC_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * delta[d0][d1] * (PQ[c1] * (-1.0) + QC_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][d1] * (PQ[c1] * (-1.0) + QC_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][d0] * (PQ[c1] * (-1.0) + QC_1 * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * delta[d0][d1] * (PQ[c1] * (-1.0) + QC_1 * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][d1] * (PQ[c1] * (-1.0) + QC_1 * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][d0] * (PQ[c1] * (-1.0) + QC_1 * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d1] * (PQ[d0] * (-1.0) + QD_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d1] * (PQ[d0] * (-1.0) + QD_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][c1] * (PQ[d0] * (-1.0) + QD_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d1] * (PQ[d0] * (-1.0) + QD_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d1] * (PQ[d0] * (-1.0) + QD_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][c1] * (PQ[d0] * (-1.0) + QD_0 * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d1] * (PQ[d0] * (-1.0) + QD_0 * (-1.0))
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d1] * (PQ[d0] * (-1.0) + QD_0 * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][c1] * (PQ[d0] * (-1.0) + QD_0 * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d0] * (PQ[d1] * (-1.0) + QD_1 * (-1.0))
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d0] * (PQ[d1] * (-1.0) + QD_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][c1] * (PQ[d1] * (-1.0) + QD_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d0] * (PQ[d1] * (-1.0) + QD_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d0] * (PQ[d1] * (-1.0) + QD_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][c1] * (PQ[d1] * (-1.0) + QD_1 * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d0] * (PQ[d1] * (-1.0) + QD_1 * (-1.0))
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d0] * (PQ[d1] * (-1.0) + QD_1 * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][c1] * (PQ[d1] * (-1.0) + QD_1 * (-1.0))
                            + delta[a0][c0] * delta[b1][c1] * delta[d0][d1] * (PB_0)
                            + delta[a0][c0] * delta[b1][d0] * delta[c1][d1] * (PB_0)
                            + delta[a0][c0] * delta[b1][d1] * delta[c1][d0] * (PB_0)
                            + delta[a0][c1] * delta[b1][c0] * delta[d0][d1] * (PB_0)
                            + delta[a0][c1] * delta[b1][d0] * delta[c0][d1] * (PB_0)
                            + delta[a0][c1] * delta[b1][d1] * delta[c0][d0] * (PB_0)
                            + delta[a0][d0] * delta[b1][c0] * delta[c1][d1] * (PB_0)
                            + delta[a0][d0] * delta[b1][c1] * delta[c0][d1] * (PB_0)
                            + delta[a0][d0] * delta[b1][d1] * delta[c0][c1] * (PB_0)
                            + delta[a0][d1] * delta[b1][c0] * delta[c1][d0] * (PB_0)
                            + delta[a0][d1] * delta[b1][c1] * delta[c0][d0] * (PB_0)
                            + delta[a0][d1] * delta[b1][d0] * delta[c0][c1] * (PB_0)
                            + delta[a0][c0] * delta[b0][c1] * delta[d0][d1] * (PB_1)
                            + delta[a0][c0] * delta[b0][d0] * delta[c1][d1] * (PB_1)
                            + delta[a0][c0] * delta[b0][d1] * delta[c1][d0] * (PB_1)
                            + delta[a0][c1] * delta[b0][c0] * delta[d0][d1] * (PB_1)
                            + delta[a0][c1] * delta[b0][d0] * delta[c0][d1] * (PB_1)
                            + delta[a0][c1] * delta[b0][d1] * delta[c0][d0] * (PB_1)
                            + delta[a0][d0] * delta[b0][c0] * delta[c1][d1] * (PB_1)
                            + delta[a0][d0] * delta[b0][c1] * delta[c0][d1] * (PB_1)
                            + delta[a0][d0] * delta[b0][d1] * delta[c0][c1] * (PB_1)
                            + delta[a0][d1] * delta[b0][c0] * delta[c1][d0] * (PB_1)
                            + delta[a0][d1] * delta[b0][c1] * delta[c0][d0] * (PB_1)
                            + delta[a0][d1] * delta[b0][d0] * delta[c0][c1] * (PB_1)
                        )

                    )

                    +

                    F7_t[2] * (

                        0.25 * ( S1 * S1 ) / ( S2 * S2 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PB_1 * PA_0)
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PB_1 * PA_0)
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PB_1 * PA_0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDDD5(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[3];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[2] * (

                        0.25 * S1 / ( S2 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * (-2.0) + PB_0 * PA_0 * PQ[b1] * (-2.0) + PB_1 * PA_0 * PQ[b0] * (-2.0))
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PB_1 * PQ[a0] * (-2.0) + PB_0 * PA_0 * PQ[b1] * (-2.0) + PB_1 * PA_0 * PQ[b0] * (-2.0))
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] * (-2.0) + PB_0 * PA_0 * PQ[b1] * (-2.0) + PB_1 * PA_0 * PQ[b0] * (-2.0))
                            + delta[b1][c1] * delta[d0][d1] * (PB_0 * PA_0 * PQ[c0] * (-1.0) + PB_0 * PA_0 * QC_0 * (-1.0))
                            + delta[b1][d0] * delta[c1][d1] * (PB_0 * PA_0 * PQ[c0] * (-1.0) + PB_0 * PA_0 * QC_0 * (-1.0))
                            + delta[b1][d1] * delta[c1][d0] * (PB_0 * PA_0 * PQ[c0] * (-1.0) + PB_0 * PA_0 * QC_0 * (-1.0))
                            + delta[b1][c0] * delta[d0][d1] * (PB_0 * PA_0 * PQ[c1] * (-1.0) + PB_0 * PA_0 * QC_1 * (-1.0))
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * PA_0 * PQ[c1] * (-1.0) + PB_0 * PA_0 * QC_1 * (-1.0))
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * PA_0 * PQ[c1] * (-1.0) + PB_0 * PA_0 * QC_1 * (-1.0))
                            + delta[b1][c0] * delta[c1][d1] * (PB_0 * PA_0 * PQ[d0] * (-1.0) + PB_0 * PA_0 * QD_0 * (-1.0))
                            + delta[b1][c1] * delta[c0][d1] * (PB_0 * PA_0 * PQ[d0] * (-1.0) + PB_0 * PA_0 * QD_0 * (-1.0))
                            + delta[b1][d1] * delta[c0][c1] * (PB_0 * PA_0 * PQ[d0] * (-1.0) + PB_0 * PA_0 * QD_0 * (-1.0))
                            + delta[b1][c0] * delta[c1][d0] * (PB_0 * PA_0 * PQ[d1] * (-1.0) + PB_0 * PA_0 * QD_1 * (-1.0))
                            + delta[b1][c1] * delta[c0][d0] * (PB_0 * PA_0 * PQ[d1] * (-1.0) + PB_0 * PA_0 * QD_1 * (-1.0))
                            + delta[b1][d0] * delta[c0][c1] * (PB_0 * PA_0 * PQ[d1] * (-1.0) + PB_0 * PA_0 * QD_1 * (-1.0))
                            + delta[b0][c1] * delta[d0][d1] * (PB_1 * PA_0 * PQ[c0] * (-1.0) + PB_1 * PA_0 * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[c1][d1] * (PB_1 * PA_0 * PQ[c0] * (-1.0) + PB_1 * PA_0 * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[c1][d0] * (PB_1 * PA_0 * PQ[c0] * (-1.0) + PB_1 * PA_0 * QC_0 * (-1.0))
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * PA_0 * PQ[c1] * (-1.0) + PB_1 * PA_0 * QC_1 * (-1.0))
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * PA_0 * PQ[c1] * (-1.0) + PB_1 * PA_0 * QC_1 * (-1.0))
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * PA_0 * PQ[c1] * (-1.0) + PB_1 * PA_0 * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[c1][d1] * (PB_1 * PA_0 * PQ[d0] * (-1.0) + PB_1 * PA_0 * QD_0 * (-1.0))
                            + delta[b0][c1] * delta[c0][d1] * (PB_1 * PA_0 * PQ[d0] * (-1.0) + PB_1 * PA_0 * QD_0 * (-1.0))
                            + delta[b0][d1] * delta[c0][c1] * (PB_1 * PA_0 * PQ[d0] * (-1.0) + PB_1 * PA_0 * QD_0 * (-1.0))
                            + delta[b0][c0] * delta[c1][d0] * (PB_1 * PA_0 * PQ[d1] * (-1.0) + PB_1 * PA_0 * QD_1 * (-1.0))
                            + delta[b0][c1] * delta[c0][d0] * (PB_1 * PA_0 * PQ[d1] * (-1.0) + PB_1 * PA_0 * QD_1 * (-1.0))
                            + delta[b0][d0] * delta[c0][c1] * (PB_1 * PA_0 * PQ[d1] * (-1.0) + PB_1 * PA_0 * QD_1 * (-1.0))
                            + delta[b0][b1] * delta[d0][d1] * (PA_0 * PQ[c0] * PQ[c1] + PA_0 * PQ[c0] * QC_1 + PA_0 * PQ[c1] * QC_0)
                            + delta[b0][b1] * delta[c1][d1] * (PA_0 * PQ[c0] * PQ[d0] + PA_0 * PQ[c0] * QD_0 + PA_0 * PQ[d0] * QC_0)
                            + delta[b0][b1] * delta[c1][d0] * (PA_0 * PQ[c0] * PQ[d1] + PA_0 * PQ[c0] * QD_1 + PA_0 * PQ[d1] * QC_0)
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * PQ[c1] * PQ[d0] + PA_0 * PQ[c1] * QD_0 + PA_0 * PQ[d0] * QC_1)
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * PQ[c1] * PQ[d1] + PA_0 * PQ[c1] * QD_1 + PA_0 * PQ[d1] * QC_1)
                            + delta[b0][b1] * delta[c0][c1] * (PA_0 * PQ[d0] * PQ[d1] + PA_0 * PQ[d0] * QD_1 + PA_0 * PQ[d1] * QD_0)
                            + delta[a0][c1] * delta[d0][d1] * (PB_0 * PB_1 * PQ[c0] * (-1.0) + PB_0 * PB_1 * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[c1][d1] * (PB_0 * PB_1 * PQ[c0] * (-1.0) + PB_0 * PB_1 * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[c1][d0] * (PB_0 * PB_1 * PQ[c0] * (-1.0) + PB_0 * PB_1 * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * PB_1 * PQ[c1] * (-1.0) + PB_0 * PB_1 * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * PB_1 * PQ[c1] * (-1.0) + PB_0 * PB_1 * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * PB_1 * PQ[c1] * (-1.0) + PB_0 * PB_1 * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[c1][d1] * (PB_0 * PB_1 * PQ[d0] * (-1.0) + PB_0 * PB_1 * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[c0][d1] * (PB_0 * PB_1 * PQ[d0] * (-1.0) + PB_0 * PB_1 * QD_0 * (-1.0))
                            + delta[a0][d1] * delta[c0][c1] * (PB_0 * PB_1 * PQ[d0] * (-1.0) + PB_0 * PB_1 * QD_0 * (-1.0))
                            + delta[a0][c0] * delta[c1][d0] * (PB_0 * PB_1 * PQ[d1] * (-1.0) + PB_0 * PB_1 * QD_1 * (-1.0))
                            + delta[a0][c1] * delta[c0][d0] * (PB_0 * PB_1 * PQ[d1] * (-1.0) + PB_0 * PB_1 * QD_1 * (-1.0))
                            + delta[a0][d0] * delta[c0][c1] * (PB_0 * PB_1 * PQ[d1] * (-1.0) + PB_0 * PB_1 * QD_1 * (-1.0))
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PQ[c0] * PQ[c1] + PB_0 * PQ[c0] * QC_1 + PB_0 * PQ[c1] * QC_0)
                            + delta[a0][b1] * delta[c1][d1] * (PB_0 * PQ[c0] * PQ[d0] + PB_0 * PQ[c0] * QD_0 + PB_0 * PQ[d0] * QC_0)
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * PQ[c1] * PQ[d0] + PB_0 * PQ[c1] * QD_0 + PB_0 * PQ[d0] * QC_1)
                            + delta[a0][b1] * delta[c1][d0] * (PB_0 * PQ[c0] * PQ[d1] + PB_0 * PQ[c0] * QD_1 + PB_0 * PQ[d1] * QC_0)
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PQ[c1] * PQ[d1] + PB_0 * PQ[c1] * QD_1 + PB_0 * PQ[d1] * QC_1)
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PQ[c0] * PQ[c1] + PB_1 * PQ[c0] * QC_1 + PB_1 * PQ[c1] * QC_0)
                            + delta[a0][b0] * delta[c1][d1] * (PB_1 * PQ[c0] * PQ[d0] + PB_1 * PQ[c0] * QD_0 + PB_1 * PQ[d0] * QC_0)
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * PQ[c1] * PQ[d0] + PB_1 * PQ[c1] * QD_0 + PB_1 * PQ[d0] * QC_1)
                            + delta[a0][b0] * delta[c1][d0] * (PB_1 * PQ[c0] * PQ[d1] + PB_1 * PQ[c0] * QD_1 + PB_1 * PQ[d1] * QC_0)
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PQ[c1] * PQ[d1] + PB_1 * PQ[c1] * QD_1 + PB_1 * PQ[d1] * QC_1)
                            + delta[a0][b1] * delta[c0][c1] * (PB_0 * PQ[d0] * PQ[d1] + PB_0 * PQ[d0] * QD_1 + PB_0 * PQ[d1] * QD_0)
                            + delta[a0][b0] * delta[c0][c1] * (PB_1 * PQ[d0] * PQ[d1] + PB_1 * PQ[d0] * QD_1 + PB_1 * PQ[d1] * QD_0)
                        )

                    )

                    +

                    F7_t[2] * (

                        0.25 * S2 / ( S1 * S4 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PQ[a0] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][b1] * delta[c1][d1] * (PQ[a0] * QD_0 * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c1][d0] * (PQ[a0] * QD_1 * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c0][d1] * (PQ[a0] * QD_0 * QC_1 * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * (PQ[a0] * QD_1 * QC_1 * (-1.0))
                            + delta[b0][b1] * delta[c0][c1] * (PQ[a0] * QD_0 * QD_1 * (-1.0))
                            + delta[a0][b1] * delta[d0][d1] * (PQ[b0] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][b1] * delta[c1][d1] * (PQ[b0] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][b1] * delta[c1][d0] * (PQ[b0] * QD_1 * QC_0 * (-1.0))
                            + delta[a0][b1] * delta[c0][d1] * (PQ[b0] * QD_0 * QC_1 * (-1.0))
                            + delta[a0][b1] * delta[c0][d0] * (PQ[b0] * QD_1 * QC_1 * (-1.0))
                            + delta[a0][b1] * delta[c0][c1] * (PQ[b0] * QD_0 * QD_1 * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PQ[b1] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[c1][d1] * (PQ[b1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c1][d0] * (PQ[b1] * QD_1 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c0][d1] * (PQ[b1] * QD_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (PQ[b1] * QD_1 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[c0][c1] * (PQ[b1] * QD_0 * QD_1 * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * (QD_0 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * (QD_0 * QC_0 * QC_1 * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * (QD_0 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * (QD_1 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * (QD_1 * QC_0 * QC_1 * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * (QD_1 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][c1] * delta[b0][b1] * (QD_0 * QD_1 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][c1] * (QD_0 * QD_1 * QC_0 * (-1.0))
                            + delta[b0][c1] * delta[a0][b1] * (QD_0 * QD_1 * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * (QD_0 * QD_1 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * (QD_0 * QD_1 * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * (QD_0 * QD_1 * QC_1 * (-1.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDDD6(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[3];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[2] * (

                        0.25 / ( S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[b1] + PB_1 * PQ[a0] * PQ[b0] + PA_0 * PQ[b0] * PQ[b1])
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PQ[a0] * PQ[b1] + PB_1 * PQ[a0] * PQ[b0] + PA_0 * PQ[b0] * PQ[b1])
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[b1] + PB_1 * PQ[a0] * PQ[b0] + PA_0 * PQ[b0] * PQ[b1])
                            + delta[b1][c1] * delta[d0][d1] * (PB_0 * PQ[a0] * QC_0 + PA_0 * PQ[b0] * QC_0)
                            + delta[b1][d0] * delta[c1][d1] * (PB_0 * PQ[a0] * QC_0 + PA_0 * PQ[b0] * QC_0)
                            + delta[b1][d1] * delta[c1][d0] * (PB_0 * PQ[a0] * QC_0 + PA_0 * PQ[b0] * QC_0)
                            + delta[b1][c0] * delta[d0][d1] * (PB_0 * PQ[a0] * QC_1 + PA_0 * PQ[b0] * QC_1)
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] * QC_1 + PA_0 * PQ[b0] * QC_1)
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * PQ[a0] * QC_1 + PA_0 * PQ[b0] * QC_1)
                            + delta[b1][c0] * delta[c1][d1] * (PB_0 * PQ[a0] * QD_0 + PA_0 * PQ[b0] * QD_0)
                            + delta[b1][c1] * delta[c0][d1] * (PB_0 * PQ[a0] * QD_0 + PA_0 * PQ[b0] * QD_0)
                            + delta[b1][d1] * delta[c0][c1] * (PB_0 * PQ[a0] * QD_0 + PA_0 * PQ[b0] * QD_0)
                            + delta[b1][c0] * delta[c1][d0] * (PB_0 * PQ[a0] * QD_1 + PA_0 * PQ[b0] * QD_1)
                            + delta[b1][c1] * delta[c0][d0] * (PB_0 * PQ[a0] * QD_1 + PA_0 * PQ[b0] * QD_1)
                            + delta[b1][d0] * delta[c0][c1] * (PB_0 * PQ[a0] * QD_1 + PA_0 * PQ[b0] * QD_1)
                            + delta[b0][c1] * delta[d0][d1] * (PB_1 * PQ[a0] * QC_0 + PA_0 * PQ[b1] * QC_0)
                            + delta[b0][d0] * delta[c1][d1] * (PB_1 * PQ[a0] * QC_0 + PA_0 * PQ[b1] * QC_0)
                            + delta[b0][d1] * delta[c1][d0] * (PB_1 * PQ[a0] * QC_0 + PA_0 * PQ[b1] * QC_0)
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * PQ[a0] * QC_1 + PA_0 * PQ[b1] * QC_1)
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * PQ[a0] * QC_1 + PA_0 * PQ[b1] * QC_1)
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * PQ[a0] * QC_1 + PA_0 * PQ[b1] * QC_1)
                            + delta[b0][c0] * delta[c1][d1] * (PB_1 * PQ[a0] * QD_0 + PA_0 * PQ[b1] * QD_0)
                            + delta[b0][c1] * delta[c0][d1] * (PB_1 * PQ[a0] * QD_0 + PA_0 * PQ[b1] * QD_0)
                            + delta[b0][d1] * delta[c0][c1] * (PB_1 * PQ[a0] * QD_0 + PA_0 * PQ[b1] * QD_0)
                            + delta[b0][c0] * delta[c1][d0] * (PB_1 * PQ[a0] * QD_1 + PA_0 * PQ[b1] * QD_1)
                            + delta[b0][c1] * delta[c0][d0] * (PB_1 * PQ[a0] * QD_1 + PA_0 * PQ[b1] * QD_1)
                            + delta[b0][d0] * delta[c0][c1] * (PB_1 * PQ[a0] * QD_1 + PA_0 * PQ[b1] * QD_1)
                            + delta[b0][b1] * delta[d0][d1] * (PQ[a0] * PQ[c0] * QC_1 * (-1.0) + PQ[a0] * PQ[c1] * QC_0 * (-1.0) + PQ[a0] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[c0] * QC_1 + PA_0 * PQ[c1] * QC_0 + PA_0 * QC_0 * QC_1)
                            + delta[b0][b1] * delta[c1][d1] * (PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[d0] * QC_0 * (-1.0) + PQ[a0] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[c0] * QD_0 + PA_0 * PQ[d0] * QC_0 + PA_0 * QD_0 * QC_0)
                            + delta[b0][b1] * delta[c1][d0] * (PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[d1] * QC_0 * (-1.0) + PQ[a0] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[c0] * QD_1 + PA_0 * PQ[d1] * QC_0 + PA_0 * QD_1 * QC_0)
                            + delta[b0][b1] * delta[c0][d1] * (PQ[a0] * PQ[c1] * QD_0 * (-1.0) + PQ[a0] * PQ[d0] * QC_1 * (-1.0) + PQ[a0] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[c1] * QD_0 + PA_0 * PQ[d0] * QC_1 + PA_0 * QD_0 * QC_1)
                            + delta[b0][b1] * delta[c0][d0] * (PQ[a0] * PQ[c1] * QD_1 * (-1.0) + PQ[a0] * PQ[d1] * QC_1 * (-1.0) + PQ[a0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[c1] * QD_1 + PA_0 * PQ[d1] * QC_1 + PA_0 * QD_1 * QC_1)
                            + delta[b0][b1] * delta[c0][c1] * (PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[d1] * QD_0 * (-1.0) + PQ[a0] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[d0] * QD_1 + PA_0 * PQ[d1] * QD_0 + PA_0 * QD_0 * QD_1)
                            + delta[b0][d0] * delta[b1][d1] * (PA_0 * QC_0 * QC_1)
                            + delta[b0][d1] * delta[b1][d0] * (PA_0 * QC_0 * QC_1)
                            + delta[b0][c1] * delta[b1][d1] * (PA_0 * QD_0 * QC_0)
                            + delta[b0][d1] * delta[b1][c1] * (PA_0 * QD_0 * QC_0)
                            + delta[b0][c1] * delta[b1][d0] * (PA_0 * QD_1 * QC_0)
                            + delta[b0][d0] * delta[b1][c1] * (PA_0 * QD_1 * QC_0)
                            + delta[b0][c0] * delta[b1][d1] * (PA_0 * QD_0 * QC_1)
                            + delta[b0][d1] * delta[b1][c0] * (PA_0 * QD_0 * QC_1)
                            + delta[b0][c0] * delta[b1][d0] * (PA_0 * QD_1 * QC_1)
                            + delta[b0][d0] * delta[b1][c0] * (PA_0 * QD_1 * QC_1)
                            + delta[b0][c0] * delta[b1][c1] * (PA_0 * QD_0 * QD_1)
                            + delta[b0][c1] * delta[b1][c0] * (PA_0 * QD_0 * QD_1)
                            + delta[a0][c1] * delta[d0][d1] * (PB_0 * PQ[b1] * QC_0 + PB_1 * PQ[b0] * QC_0)
                            + delta[a0][d0] * delta[c1][d1] * (PB_0 * PQ[b1] * QC_0 + PB_1 * PQ[b0] * QC_0)
                            + delta[a0][d1] * delta[c1][d0] * (PB_0 * PQ[b1] * QC_0 + PB_1 * PQ[b0] * QC_0)
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * PQ[b1] * QC_1 + PB_1 * PQ[b0] * QC_1)
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * PQ[b1] * QC_1 + PB_1 * PQ[b0] * QC_1)
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * PQ[b1] * QC_1 + PB_1 * PQ[b0] * QC_1)
                            + delta[a0][b1] * delta[d0][d1] * (PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * QC_0 * (-1.0) + PQ[b0] * QC_0 * QC_1 * (-1.0) + PB_0 * PQ[c0] * QC_1 + PB_0 * PQ[c1] * QC_0 + PB_0 * QC_0 * QC_1)
                            + delta[a0][b1] * delta[c1][d1] * (PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PQ[b0] * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[c0] * QD_0 + PB_0 * PQ[d0] * QC_0 + PB_0 * QD_0 * QC_0)
                            + delta[a0][b1] * delta[c0][d1] * (PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PQ[b0] * PQ[d0] * QC_1 * (-1.0) + PQ[b0] * QD_0 * QC_1 * (-1.0) + PB_0 * PQ[c1] * QD_0 + PB_0 * PQ[d0] * QC_1 + PB_0 * QD_0 * QC_1)
                            + delta[a0][b1] * delta[c1][d0] * (PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PQ[b0] * PQ[d1] * QC_0 * (-1.0) + PQ[b0] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[c0] * QD_1 + PB_0 * PQ[d1] * QC_0 + PB_0 * QD_1 * QC_0)
                            + delta[a0][b1] * delta[c0][d0] * (PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PQ[b0] * PQ[d1] * QC_1 * (-1.0) + PQ[b0] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[c1] * QD_1 + PB_0 * PQ[d1] * QC_1 + PB_0 * QD_1 * QC_1)
                            + delta[a0][d0] * delta[b1][d1] * (PB_0 * QC_0 * QC_1)
                            + delta[a0][d1] * delta[b1][d0] * (PB_0 * QC_0 * QC_1)
                            + delta[a0][c1] * delta[b1][d1] * (PB_0 * QD_0 * QC_0)
                            + delta[a0][d1] * delta[b1][c1] * (PB_0 * QD_0 * QC_0)
                            + delta[a0][c1] * delta[b1][d0] * (PB_0 * QD_1 * QC_0)
                            + delta[a0][d0] * delta[b1][c1] * (PB_0 * QD_1 * QC_0)
                            + delta[a0][c0] * delta[b1][d1] * (PB_0 * QD_0 * QC_1)
                            + delta[a0][d1] * delta[b1][c0] * (PB_0 * QD_0 * QC_1)
                            + delta[a0][c0] * delta[b1][d0] * (PB_0 * QD_1 * QC_1)
                            + delta[a0][d0] * delta[b1][c0] * (PB_0 * QD_1 * QC_1)
                            + delta[a0][b0] * delta[d0][d1] * (PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PQ[b1] * PQ[c1] * QC_0 * (-1.0) + PQ[b1] * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[c0] * QC_1 + PB_1 * PQ[c1] * QC_0 + PB_1 * QC_0 * QC_1)
                            + delta[a0][b0] * delta[c1][d1] * (PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PQ[b1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[c0] * QD_0 + PB_1 * PQ[d0] * QC_0 + PB_1 * QD_0 * QC_0)
                            + delta[a0][b0] * delta[c0][d1] * (PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PQ[b1] * PQ[d0] * QC_1 * (-1.0) + PQ[b1] * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[c1] * QD_0 + PB_1 * PQ[d0] * QC_1 + PB_1 * QD_0 * QC_1)
                            + delta[a0][b0] * delta[c1][d0] * (PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PQ[b1] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[c0] * QD_1 + PB_1 * PQ[d1] * QC_0 + PB_1 * QD_1 * QC_0)
                            + delta[a0][b0] * delta[c0][d0] * (PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PQ[b1] * PQ[d1] * QC_1 * (-1.0) + PQ[b1] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[c1] * QD_1 + PB_1 * PQ[d1] * QC_1 + PB_1 * QD_1 * QC_1)
                            + delta[a0][d0] * delta[b0][d1] * (PB_1 * QC_0 * QC_1)
                            + delta[a0][d1] * delta[b0][d0] * (PB_1 * QC_0 * QC_1)
                            + delta[a0][c1] * delta[b0][d1] * (PB_1 * QD_0 * QC_0)
                            + delta[a0][d1] * delta[b0][c1] * (PB_1 * QD_0 * QC_0)
                            + delta[a0][c1] * delta[b0][d0] * (PB_1 * QD_1 * QC_0)
                            + delta[a0][d0] * delta[b0][c1] * (PB_1 * QD_1 * QC_0)
                            + delta[a0][c0] * delta[b0][d1] * (PB_1 * QD_0 * QC_1)
                            + delta[a0][d1] * delta[b0][c0] * (PB_1 * QD_0 * QC_1)
                            + delta[a0][c0] * delta[b0][d0] * (PB_1 * QD_1 * QC_1)
                            + delta[a0][d0] * delta[b0][c0] * (PB_1 * QD_1 * QC_1)
                            + delta[a0][b1] * delta[c0][c1] * (PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PQ[b0] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[d0] * QD_1 + PB_0 * PQ[d1] * QD_0 + PB_0 * QD_0 * QD_1)
                            + delta[a0][b0] * delta[c0][c1] * (PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PQ[b1] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[d0] * QD_1 + PB_1 * PQ[d1] * QD_0 + PB_1 * QD_0 * QD_1)
                            + delta[a0][d1] * delta[b0][b1] * (PQ[c0] * QD_0 * QC_1 * (-1.0) + PQ[c1] * QD_0 * QC_0 * (-1.0) + PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * (PQ[c0] * QD_0 * QC_1 * (-1.0) + PQ[c1] * QD_0 * QC_0 * (-1.0) + PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * (PQ[c0] * QD_0 * QC_1 * (-1.0) + PQ[c1] * QD_0 * QC_0 * (-1.0) + PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * (PQ[c0] * QD_1 * QC_1 * (-1.0) + PQ[c1] * QD_1 * QC_0 * (-1.0) + PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * (PQ[c0] * QD_1 * QC_1 * (-1.0) + PQ[c1] * QD_1 * QC_0 * (-1.0) + PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * (PQ[c0] * QD_1 * QC_1 * (-1.0) + PQ[c1] * QD_1 * QC_0 * (-1.0) + PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][c1] * delta[b0][b1] * (PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][c1] * (PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[b0][c1] * delta[a0][b1] * (PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * (PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * (PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * (PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[c1][d1] * (PB_0 * PQ[b1] * QD_0 + PB_1 * PQ[b0] * QD_0)
                            + delta[a0][c1] * delta[c0][d1] * (PB_0 * PQ[b1] * QD_0 + PB_1 * PQ[b0] * QD_0)
                            + delta[a0][d1] * delta[c0][c1] * (PB_0 * PQ[b1] * QD_0 + PB_1 * PQ[b0] * QD_0)
                            + delta[a0][c0] * delta[c1][d0] * (PB_0 * PQ[b1] * QD_1 + PB_1 * PQ[b0] * QD_1)
                            + delta[a0][c1] * delta[c0][d0] * (PB_0 * PQ[b1] * QD_1 + PB_1 * PQ[b0] * QD_1)
                            + delta[a0][d0] * delta[c0][c1] * (PB_0 * PQ[b1] * QD_1 + PB_1 * PQ[b0] * QD_1)
                            + delta[a0][c0] * delta[b1][c1] * (PB_0 * QD_0 * QD_1)
                            + delta[a0][c1] * delta[b1][c0] * (PB_0 * QD_0 * QD_1)
                            + delta[a0][c0] * delta[b0][c1] * (PB_1 * QD_0 * QD_1)
                            + delta[a0][c1] * delta[b0][c0] * (PB_1 * QD_0 * QD_1)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDDD7(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[4];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[2] * (

                        0.5 * ( S1 * S1 ) / ( S2 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[c1] + PB_0 * PB_1 * PA_0 * PQ[c0] * QC_1 + PB_0 * PB_1 * PA_0 * PQ[c1] * QC_0)
                            + delta[c1][d1] * (PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[d0] + PB_0 * PB_1 * PA_0 * PQ[c0] * QD_0 + PB_0 * PB_1 * PA_0 * PQ[d0] * QC_0)
                            + delta[c1][d0] * (PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[d1] + PB_0 * PB_1 * PA_0 * PQ[c0] * QD_1 + PB_0 * PB_1 * PA_0 * PQ[d1] * QC_0)
                            + delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PQ[c1] * PQ[d0] + PB_0 * PB_1 * PA_0 * PQ[c1] * QD_0 + PB_0 * PB_1 * PA_0 * PQ[d0] * QC_1)
                            + delta[c0][d0] * (PB_0 * PB_1 * PA_0 * PQ[c1] * PQ[d1] + PB_0 * PB_1 * PA_0 * PQ[c1] * QD_1 + PB_0 * PB_1 * PA_0 * PQ[d1] * QC_1)
                            + delta[c0][c1] * (PB_0 * PB_1 * PA_0 * PQ[d0] * PQ[d1] + PB_0 * PB_1 * PA_0 * PQ[d0] * QD_1 + PB_0 * PB_1 * PA_0 * PQ[d1] * QD_0)
                        )

                    )

                    +

                    F7_t[2] * (

                        0.5 * ( S2 * S2 ) / ( S1 * S4 * S4 ) * (
                            delta[b0][b1] * (PQ[a0] * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][b1] * (PQ[b0] * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * (PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1 * (-1.0))
                        )

                    )

                    +

                    F7_t[2] * (

                        0.5 * S1 / ( S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[c1] * QC_0 * (-1.0) + PB_0 * PB_1 * PQ[a0] * QC_0 * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c1] * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[b1] * QC_0 * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c1] * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[b0] * QC_0 * QC_1 * (-1.0))
                            + delta[c1][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PB_1 * PQ[a0] * QD_0 * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[b1] * QD_0 * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[b0] * QD_0 * QC_0 * (-1.0))
                            + delta[c1][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PB_1 * PQ[a0] * QD_1 * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[b1] * QD_1 * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[b0] * QD_1 * QC_0 * (-1.0))
                            + delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[c1] * QD_0 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[d0] * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[a0] * QD_0 * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d0] * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[b1] * QD_0 * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d0] * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[b0] * QD_0 * QC_1 * (-1.0))
                            + delta[c0][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[c1] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[d1] * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[a0] * QD_1 * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d1] * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[b1] * QD_1 * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d1] * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[b0] * QD_1 * QC_1 * (-1.0))
                            + delta[c0][c1] * (PB_0 * PB_1 * PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[a0] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PB_1 * PQ[a0] * QD_0 * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[b1] * QD_0 * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[b0] * QD_0 * QD_1 * (-1.0))
                            + delta[b1][d1] * (PB_0 * PA_0 * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[b1][d0] * (PB_0 * PA_0 * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[b1][c1] * (PB_0 * PA_0 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[b1][c0] * (PB_0 * PA_0 * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[b0][d1] * (PB_1 * PA_0 * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][d0] * (PB_1 * PA_0 * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][c1] * (PB_1 * PA_0 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[b0][c0] * (PB_1 * PA_0 * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_1 * PA_0 * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[b0][b1] * (PA_0 * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PA_0 * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PA_0 * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PA_0 * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PA_0 * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PA_0 * PQ[d0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][d1] * (PB_0 * PB_1 * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_0 * PB_1 * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][d0] * (PB_0 * PB_1 * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_0 * PB_1 * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][c1] * (PB_0 * PB_1 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PB_1 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][c0] * (PB_0 * PB_1 * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[a0][b1] * (PB_0 * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PB_0 * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PB_0 * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PB_0 * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PB_0 * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PB_0 * PQ[d0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][b0] * (PB_1 * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PB_1 * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PB_1 * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PB_1 * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PB_1 * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PB_1 * PQ[d0] * PQ[d1] * QC_0 * QC_1)
                        )

                    )

                    +

                    F7_t[2] * (

                        0.5 * S2 / ( S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[a0] * PQ[b1] * QC_0 * QC_1 + PB_1 * PQ[a0] * PQ[b0] * QC_0 * QC_1 + PA_0 * PQ[b0] * PQ[b1] * QC_0 * QC_1)
                            + delta[c1][d1] * (PB_0 * PQ[a0] * PQ[b1] * QD_0 * QC_0 + PB_1 * PQ[a0] * PQ[b0] * QD_0 * QC_0 + PA_0 * PQ[b0] * PQ[b1] * QD_0 * QC_0)
                            + delta[c1][d0] * (PB_0 * PQ[a0] * PQ[b1] * QD_1 * QC_0 + PB_1 * PQ[a0] * PQ[b0] * QD_1 * QC_0 + PA_0 * PQ[b0] * PQ[b1] * QD_1 * QC_0)
                            + delta[c0][d1] * (PB_0 * PQ[a0] * PQ[b1] * QD_0 * QC_1 + PB_1 * PQ[a0] * PQ[b0] * QD_0 * QC_1 + PA_0 * PQ[b0] * PQ[b1] * QD_0 * QC_1)
                            + delta[c0][d0] * (PB_0 * PQ[a0] * PQ[b1] * QD_1 * QC_1 + PB_1 * PQ[a0] * PQ[b0] * QD_1 * QC_1 + PA_0 * PQ[b0] * PQ[b1] * QD_1 * QC_1)
                            + delta[c0][c1] * (PB_0 * PQ[a0] * PQ[b1] * QD_0 * QD_1 + PB_1 * PQ[a0] * PQ[b0] * QD_0 * QD_1 + PA_0 * PQ[b0] * PQ[b1] * QD_0 * QD_1)
                            + delta[b1][d1] * (PB_0 * PQ[a0] * QD_0 * QC_0 * QC_1 + PA_0 * PQ[b0] * QD_0 * QC_0 * QC_1)
                            + delta[b1][d0] * (PB_0 * PQ[a0] * QD_1 * QC_0 * QC_1 + PA_0 * PQ[b0] * QD_1 * QC_0 * QC_1)
                            + delta[b1][c1] * (PB_0 * PQ[a0] * QD_0 * QD_1 * QC_0 + PA_0 * PQ[b0] * QD_0 * QD_1 * QC_0)
                            + delta[b1][c0] * (PB_0 * PQ[a0] * QD_0 * QD_1 * QC_1 + PA_0 * PQ[b0] * QD_0 * QD_1 * QC_1)
                            + delta[b0][d1] * (PB_1 * PQ[a0] * QD_0 * QC_0 * QC_1 + PA_0 * PQ[b1] * QD_0 * QC_0 * QC_1)
                            + delta[b0][d0] * (PB_1 * PQ[a0] * QD_1 * QC_0 * QC_1 + PA_0 * PQ[b1] * QD_1 * QC_0 * QC_1)
                            + delta[b0][c1] * (PB_1 * PQ[a0] * QD_0 * QD_1 * QC_0 + PA_0 * PQ[b1] * QD_0 * QD_1 * QC_0)
                            + delta[b0][c0] * (PB_1 * PQ[a0] * QD_0 * QD_1 * QC_1 + PA_0 * PQ[b1] * QD_0 * QD_1 * QC_1)
                            + delta[b0][b1] * (PQ[a0] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[a0] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[c0] * QD_0 * QD_1 * QC_1 + PA_0 * PQ[c1] * QD_0 * QD_1 * QC_0 + PA_0 * PQ[d0] * QD_1 * QC_0 * QC_1 + PA_0 * PQ[d1] * QD_0 * QC_0 * QC_1)
                            + delta[a0][d1] * (PB_0 * PQ[b1] * QD_0 * QC_0 * QC_1 + PB_1 * PQ[b0] * QD_0 * QC_0 * QC_1)
                            + delta[a0][d0] * (PB_0 * PQ[b1] * QD_1 * QC_0 * QC_1 + PB_1 * PQ[b0] * QD_1 * QC_0 * QC_1)
                            + delta[a0][c1] * (PB_0 * PQ[b1] * QD_0 * QD_1 * QC_0 + PB_1 * PQ[b0] * QD_0 * QD_1 * QC_0)
                            + delta[a0][c0] * (PB_0 * PQ[b1] * QD_0 * QD_1 * QC_1 + PB_1 * PQ[b0] * QD_0 * QD_1 * QC_1)
                            + delta[a0][b1] * (PQ[b0] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[b0] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[b0] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0) + PB_0 * PQ[c0] * QD_0 * QD_1 * QC_1 + PB_0 * PQ[c1] * QD_0 * QD_1 * QC_0 + PB_0 * PQ[d0] * QD_1 * QC_0 * QC_1 + PB_0 * PQ[d1] * QD_0 * QC_0 * QC_1)
                            + delta[a0][b0] * (PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[c0] * QD_0 * QD_1 * QC_1 + PB_1 * PQ[c1] * QD_0 * QD_1 * QC_0 + PB_1 * PQ[d0] * QD_1 * QC_0 * QC_1 + PB_1 * PQ[d1] * QD_0 * QC_0 * QC_1)
                        )

                    )

                    +

                    F7_t[3] * (

                        ( S1 * S1 * S1 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDDD8(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[4];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[3] * (

                        ( S1 * S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PB_0 * PB_1 * PQ[a0] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PB_0 * PB_1 * PQ[a0] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PB_0 * PB_1 * PQ[a0] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                            + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PB_0 * PA_0 * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PB_0 * PA_0 * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PB_0 * PA_0 * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                            + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PB_1 * PA_0 * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PB_1 * PA_0 * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PB_1 * PA_0 * PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                        )

                    )

                    +

                    F7_t[3] * (

                        ( S1 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                        )

                    )

                    +

                    F7_t[3] * (

                        ( S2 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1
                        )

                    )

                    +

                    F7_t[3] * (

                        0.125 * S1 / ( S2 * S4 * S4 * S4 ) * (
                            delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (PA_0 * (-1.0) + PQ[a0])
                            + delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (PA_0 * (-1.0) + PQ[a0])
                            + delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (PA_0 * (-1.0) + PQ[a0])
                            + delta[b0][c0] * delta[b1][c1] * delta[d0][d1] * (PA_0 * (-1.0))
                            + delta[b0][c0] * delta[b1][d0] * delta[c1][d1] * (PA_0 * (-1.0))
                            + delta[b0][c0] * delta[b1][d1] * delta[c1][d0] * (PA_0 * (-1.0))
                            + delta[b0][c1] * delta[b1][c0] * delta[d0][d1] * (PA_0 * (-1.0))
                            + delta[b0][c1] * delta[b1][d0] * delta[c0][d1] * (PA_0 * (-1.0))
                            + delta[b0][c1] * delta[b1][d1] * delta[c0][d0] * (PA_0 * (-1.0))
                            + delta[b0][d0] * delta[b1][c0] * delta[c1][d1] * (PA_0 * (-1.0))
                            + delta[b0][d0] * delta[b1][c1] * delta[c0][d1] * (PA_0 * (-1.0))
                            + delta[b0][d0] * delta[b1][d1] * delta[c0][c1] * (PA_0 * (-1.0))
                            + delta[b0][d1] * delta[b1][c0] * delta[c1][d0] * (PA_0 * (-1.0))
                            + delta[b0][d1] * delta[b1][c1] * delta[c0][d0] * (PA_0 * (-1.0))
                            + delta[b0][d1] * delta[b1][d0] * delta[c0][c1] * (PA_0 * (-1.0))
                            + delta[a0][c0] * delta[b1][c1] * delta[d0][d1] * (PB_0 * (-1.0))
                            + delta[a0][c0] * delta[b1][d0] * delta[c1][d1] * (PB_0 * (-1.0))
                            + delta[a0][c0] * delta[b1][d1] * delta[c1][d0] * (PB_0 * (-1.0))
                            + delta[a0][c1] * delta[b1][c0] * delta[d0][d1] * (PB_0 * (-1.0))
                            + delta[a0][c1] * delta[b1][d0] * delta[c0][d1] * (PB_0 * (-1.0))
                            + delta[a0][c1] * delta[b1][d1] * delta[c0][d0] * (PB_0 * (-1.0))
                            + delta[a0][d0] * delta[b1][c0] * delta[c1][d1] * (PB_0 * (-1.0))
                            + delta[a0][d0] * delta[b1][c1] * delta[c0][d1] * (PB_0 * (-1.0))
                            + delta[a0][d0] * delta[b1][d1] * delta[c0][c1] * (PB_0 * (-1.0))
                            + delta[a0][d1] * delta[b1][c0] * delta[c1][d0] * (PB_0 * (-1.0))
                            + delta[a0][d1] * delta[b1][c1] * delta[c0][d0] * (PB_0 * (-1.0))
                            + delta[a0][d1] * delta[b1][d0] * delta[c0][c1] * (PB_0 * (-1.0))
                            + delta[a0][b1] * delta[c0][c1] * delta[d0][d1] * (PB_0 * (-1.0) + PQ[b0])
                            + delta[a0][b1] * delta[c0][d0] * delta[c1][d1] * (PB_0 * (-1.0) + PQ[b0])
                            + delta[a0][b1] * delta[c1][d0] * delta[c0][d1] * (PB_0 * (-1.0) + PQ[b0])
                            + delta[a0][c0] * delta[b0][c1] * delta[d0][d1] * (PB_1 * (-1.0))
                            + delta[a0][c0] * delta[b0][d0] * delta[c1][d1] * (PB_1 * (-1.0))
                            + delta[a0][c0] * delta[b0][d1] * delta[c1][d0] * (PB_1 * (-1.0))
                            + delta[a0][c1] * delta[b0][c0] * delta[d0][d1] * (PB_1 * (-1.0))
                            + delta[a0][c1] * delta[b0][d0] * delta[c0][d1] * (PB_1 * (-1.0))
                            + delta[a0][c1] * delta[b0][d1] * delta[c0][d0] * (PB_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][c0] * delta[c1][d1] * (PB_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][c1] * delta[c0][d1] * (PB_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][d1] * delta[c0][c1] * (PB_1 * (-1.0))
                            + delta[a0][d1] * delta[b0][c0] * delta[c1][d0] * (PB_1 * (-1.0))
                            + delta[a0][d1] * delta[b0][c1] * delta[c0][d0] * (PB_1 * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * delta[c0][c1] * (PB_1 * (-1.0))
                            + delta[a0][b0] * delta[c0][c1] * delta[d0][d1] * (PB_1 * (-1.0) + PQ[b1])
                            + delta[a0][b0] * delta[c0][d0] * delta[c1][d1] * (PB_1 * (-1.0) + PQ[b1])
                            + delta[a0][b0] * delta[c1][d0] * delta[c0][d1] * (PB_1 * (-1.0) + PQ[b1])
                            + delta[a0][c1] * delta[b0][b1] * delta[d0][d1] * (PQ[c0])
                            + delta[a0][d0] * delta[b0][b1] * delta[c1][d1] * (PQ[c0])
                            + delta[a0][d1] * delta[b0][b1] * delta[c1][d0] * (PQ[c0])
                            + delta[a0][b0] * delta[b1][c1] * delta[d0][d1] * (PQ[c0])
                            + delta[a0][b0] * delta[b1][d0] * delta[c1][d1] * (PQ[c0])
                            + delta[a0][b0] * delta[b1][d1] * delta[c1][d0] * (PQ[c0])
                            + delta[b0][c1] * delta[a0][b1] * delta[d0][d1] * (PQ[c0])
                            + delta[b0][d0] * delta[a0][b1] * delta[c1][d1] * (PQ[c0])
                            + delta[b0][d1] * delta[a0][b1] * delta[c1][d0] * (PQ[c0])
                            + delta[a0][c0] * delta[b0][b1] * delta[d0][d1] * (PQ[c1])
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][d1] * (PQ[c1])
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][d0] * (PQ[c1])
                            + delta[a0][b0] * delta[b1][c0] * delta[d0][d1] * (PQ[c1])
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][d1] * (PQ[c1])
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][d0] * (PQ[c1])
                            + delta[b0][c0] * delta[a0][b1] * delta[d0][d1] * (PQ[c1])
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][d1] * (PQ[c1])
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][d0] * (PQ[c1])
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d1] * (PQ[d0])
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d1] * (PQ[d0])
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][c1] * (PQ[d0])
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d1] * (PQ[d0])
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d1] * (PQ[d0])
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][c1] * (PQ[d0])
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d1] * (PQ[d0])
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d1] * (PQ[d0])
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][c1] * (PQ[d0])
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d0] * (PQ[d1])
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d0] * (PQ[d1])
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][c1] * (PQ[d1])
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d0] * (PQ[d1])
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d0] * (PQ[d1])
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][c1] * (PQ[d1])
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d0] * (PQ[d1])
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d0] * (PQ[d1])
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][c1] * (PQ[d1])
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDDD9(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[4];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[3] * (

                        0.125 / ( S4 * S4 * S4 ) * (
                            delta[a0][c1] * delta[b0][b1] * delta[d0][d1] * (PQ[c0] + QC_0)
                            + delta[a0][c1] * delta[b0][d0] * delta[b1][d1] * (QC_0)
                            + delta[a0][c1] * delta[b0][d1] * delta[b1][d0] * (QC_0)
                            + delta[a0][d0] * delta[b0][b1] * delta[c1][d1] * (PQ[c0] + QC_0)
                            + delta[a0][d0] * delta[b0][c1] * delta[b1][d1] * (QC_0)
                            + delta[a0][d0] * delta[b0][d1] * delta[b1][c1] * (QC_0)
                            + delta[a0][d1] * delta[b0][b1] * delta[c1][d0] * (PQ[c0] + QC_0)
                            + delta[a0][d1] * delta[b0][c1] * delta[b1][d0] * (QC_0)
                            + delta[a0][d1] * delta[b0][d0] * delta[b1][c1] * (QC_0)
                            + delta[a0][b0] * delta[b1][c1] * delta[d0][d1] * (PQ[c0] + QC_0)
                            + delta[a0][b0] * delta[b1][d0] * delta[c1][d1] * (PQ[c0] + QC_0)
                            + delta[a0][b0] * delta[b1][d1] * delta[c1][d0] * (PQ[c0] + QC_0)
                            + delta[b0][c1] * delta[a0][b1] * delta[d0][d1] * (PQ[c0] + QC_0)
                            + delta[b0][d0] * delta[a0][b1] * delta[c1][d1] * (PQ[c0] + QC_0)
                            + delta[b0][d1] * delta[a0][b1] * delta[c1][d0] * (PQ[c0] + QC_0)
                            + delta[a0][c0] * delta[b0][b1] * delta[d0][d1] * (PQ[c1] + QC_1)
                            + delta[a0][c0] * delta[b0][d0] * delta[b1][d1] * (QC_1)
                            + delta[a0][c0] * delta[b0][d1] * delta[b1][d0] * (QC_1)
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][d1] * (PQ[c1] + QC_1)
                            + delta[a0][d0] * delta[b0][c0] * delta[b1][d1] * (QC_1)
                            + delta[a0][d0] * delta[b0][d1] * delta[b1][c0] * (QC_1)
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][d0] * (PQ[c1] + QC_1)
                            + delta[a0][d1] * delta[b0][c0] * delta[b1][d0] * (QC_1)
                            + delta[a0][d1] * delta[b0][d0] * delta[b1][c0] * (QC_1)
                            + delta[a0][b0] * delta[b1][c0] * delta[d0][d1] * (PQ[c1] + QC_1)
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][d1] * (PQ[c1] + QC_1)
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][d0] * (PQ[c1] + QC_1)
                            + delta[b0][c0] * delta[a0][b1] * delta[d0][d1] * (PQ[c1] + QC_1)
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][d1] * (PQ[c1] + QC_1)
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][d0] * (PQ[c1] + QC_1)
                            + delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (PQ[a0] * 2.0)
                            + delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (PQ[a0] * 2.0)
                            + delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (PQ[a0] * 2.0)
                            + delta[b0][c0] * delta[b1][c1] * delta[d0][d1] * (PQ[a0])
                            + delta[b0][c0] * delta[b1][d0] * delta[c1][d1] * (PQ[a0])
                            + delta[b0][c0] * delta[b1][d1] * delta[c1][d0] * (PQ[a0])
                            + delta[b0][c1] * delta[b1][c0] * delta[d0][d1] * (PQ[a0])
                            + delta[b0][c1] * delta[b1][d0] * delta[c0][d1] * (PQ[a0])
                            + delta[b0][c1] * delta[b1][d1] * delta[c0][d0] * (PQ[a0])
                            + delta[b0][d0] * delta[b1][c0] * delta[c1][d1] * (PQ[a0])
                            + delta[b0][d0] * delta[b1][c1] * delta[c0][d1] * (PQ[a0])
                            + delta[b0][d0] * delta[b1][d1] * delta[c0][c1] * (PQ[a0])
                            + delta[b0][d1] * delta[b1][c0] * delta[c1][d0] * (PQ[a0])
                            + delta[b0][d1] * delta[b1][c1] * delta[c0][d0] * (PQ[a0])
                            + delta[b0][d1] * delta[b1][d0] * delta[c0][c1] * (PQ[a0])
                            + delta[a0][c0] * delta[b1][c1] * delta[d0][d1] * (PQ[b0])
                            + delta[a0][c0] * delta[b1][d0] * delta[c1][d1] * (PQ[b0])
                            + delta[a0][c0] * delta[b1][d1] * delta[c1][d0] * (PQ[b0])
                            + delta[a0][c1] * delta[b1][c0] * delta[d0][d1] * (PQ[b0])
                            + delta[a0][c1] * delta[b1][d0] * delta[c0][d1] * (PQ[b0])
                            + delta[a0][c1] * delta[b1][d1] * delta[c0][d0] * (PQ[b0])
                            + delta[a0][d0] * delta[b1][c0] * delta[c1][d1] * (PQ[b0])
                            + delta[a0][d0] * delta[b1][c1] * delta[c0][d1] * (PQ[b0])
                            + delta[a0][d0] * delta[b1][d1] * delta[c0][c1] * (PQ[b0])
                            + delta[a0][d1] * delta[b1][c0] * delta[c1][d0] * (PQ[b0])
                            + delta[a0][d1] * delta[b1][c1] * delta[c0][d0] * (PQ[b0])
                            + delta[a0][d1] * delta[b1][d0] * delta[c0][c1] * (PQ[b0])
                            + delta[a0][b1] * delta[c0][c1] * delta[d0][d1] * (PQ[b0] * 2.0)
                            + delta[a0][b1] * delta[c0][d0] * delta[c1][d1] * (PQ[b0] * 2.0)
                            + delta[a0][b1] * delta[c1][d0] * delta[c0][d1] * (PQ[b0] * 2.0)
                            + delta[a0][c0] * delta[b0][c1] * delta[d0][d1] * (PQ[b1])
                            + delta[a0][c0] * delta[b0][d0] * delta[c1][d1] * (PQ[b1])
                            + delta[a0][c0] * delta[b0][d1] * delta[c1][d0] * (PQ[b1])
                            + delta[a0][c1] * delta[b0][c0] * delta[d0][d1] * (PQ[b1])
                            + delta[a0][c1] * delta[b0][d0] * delta[c0][d1] * (PQ[b1])
                            + delta[a0][c1] * delta[b0][d1] * delta[c0][d0] * (PQ[b1])
                            + delta[a0][d0] * delta[b0][c0] * delta[c1][d1] * (PQ[b1])
                            + delta[a0][d0] * delta[b0][c1] * delta[c0][d1] * (PQ[b1])
                            + delta[a0][d0] * delta[b0][d1] * delta[c0][c1] * (PQ[b1])
                            + delta[a0][d1] * delta[b0][c0] * delta[c1][d0] * (PQ[b1])
                            + delta[a0][d1] * delta[b0][c1] * delta[c0][d0] * (PQ[b1])
                            + delta[a0][d1] * delta[b0][d0] * delta[c0][c1] * (PQ[b1])
                            + delta[a0][b0] * delta[c0][c1] * delta[d0][d1] * (PQ[b1] * 2.0)
                            + delta[a0][b0] * delta[c0][d0] * delta[c1][d1] * (PQ[b1] * 2.0)
                            + delta[a0][b0] * delta[c1][d0] * delta[c0][d1] * (PQ[b1] * 2.0)
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d1] * (PQ[d0] + QD_0)
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d1] * (PQ[d0] + QD_0)
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][c1] * (PQ[d0] + QD_0)
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d1] * (PQ[d0] + QD_0)
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d1] * (PQ[d0] + QD_0)
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][c1] * (PQ[d0] + QD_0)
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d1] * (PQ[d0] + QD_0)
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d1] * (PQ[d0] + QD_0)
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][c1] * (PQ[d0] + QD_0)
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d0] * (PQ[d1] + QD_1)
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d0] * (PQ[d1] + QD_1)
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][c1] * (PQ[d1] + QD_1)
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d0] * (PQ[d1] + QD_1)
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d0] * (PQ[d1] + QD_1)
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][c1] * (PQ[d1] + QD_1)
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d0] * (PQ[d1] + QD_1)
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d0] * (PQ[d1] + QD_1)
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][c1] * (PQ[d1] + QD_1)
                            + delta[a0][c0] * delta[b0][c1] * delta[b1][d1] * (QD_0)
                            + delta[a0][c0] * delta[b0][d1] * delta[b1][c1] * (QD_0)
                            + delta[a0][c1] * delta[b0][c0] * delta[b1][d1] * (QD_0)
                            + delta[a0][c1] * delta[b0][d1] * delta[b1][c0] * (QD_0)
                            + delta[a0][d1] * delta[b0][c0] * delta[b1][c1] * (QD_0)
                            + delta[a0][d1] * delta[b0][c1] * delta[b1][c0] * (QD_0)
                            + delta[a0][c0] * delta[b0][c1] * delta[b1][d0] * (QD_1)
                            + delta[a0][c0] * delta[b0][d0] * delta[b1][c1] * (QD_1)
                            + delta[a0][c1] * delta[b0][c0] * delta[b1][d0] * (QD_1)
                            + delta[a0][c1] * delta[b0][d0] * delta[b1][c0] * (QD_1)
                            + delta[a0][d0] * delta[b0][c0] * delta[b1][c1] * (QD_1)
                            + delta[a0][d0] * delta[b0][c1] * delta[b1][c0] * (QD_1)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDDD10(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[4];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[3] * (

                        0.25 * ( S1 * S1 ) / ( S2 * S4 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] + PB_0 * PA_0 * PQ[b1] + PB_1 * PA_0 * PQ[b0])
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PB_1 * PQ[a0] + PB_0 * PA_0 * PQ[b1] + PB_1 * PA_0 * PQ[b0])
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] + PB_0 * PA_0 * PQ[b1] + PB_1 * PA_0 * PQ[b0])
                            + delta[b1][c1] * delta[d0][d1] * (PB_0 * PA_0 * PQ[c0])
                            + delta[b1][d0] * delta[c1][d1] * (PB_0 * PA_0 * PQ[c0])
                            + delta[b1][d1] * delta[c1][d0] * (PB_0 * PA_0 * PQ[c0])
                            + delta[b1][c0] * delta[d0][d1] * (PB_0 * PA_0 * PQ[c1])
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * PA_0 * PQ[c1])
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * PA_0 * PQ[c1])
                            + delta[b1][c0] * delta[c1][d1] * (PB_0 * PA_0 * PQ[d0])
                            + delta[b1][c1] * delta[c0][d1] * (PB_0 * PA_0 * PQ[d0])
                            + delta[b1][d1] * delta[c0][c1] * (PB_0 * PA_0 * PQ[d0])
                            + delta[b1][c0] * delta[c1][d0] * (PB_0 * PA_0 * PQ[d1])
                            + delta[b1][c1] * delta[c0][d0] * (PB_0 * PA_0 * PQ[d1])
                            + delta[b1][d0] * delta[c0][c1] * (PB_0 * PA_0 * PQ[d1])
                            + delta[b0][c1] * delta[d0][d1] * (PB_1 * PA_0 * PQ[c0])
                            + delta[b0][d0] * delta[c1][d1] * (PB_1 * PA_0 * PQ[c0])
                            + delta[b0][d1] * delta[c1][d0] * (PB_1 * PA_0 * PQ[c0])
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * PA_0 * PQ[c1])
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * PA_0 * PQ[c1])
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * PA_0 * PQ[c1])
                            + delta[b0][c0] * delta[c1][d1] * (PB_1 * PA_0 * PQ[d0])
                            + delta[b0][c1] * delta[c0][d1] * (PB_1 * PA_0 * PQ[d0])
                            + delta[b0][d1] * delta[c0][c1] * (PB_1 * PA_0 * PQ[d0])
                            + delta[b0][c0] * delta[c1][d0] * (PB_1 * PA_0 * PQ[d1])
                            + delta[b0][c1] * delta[c0][d0] * (PB_1 * PA_0 * PQ[d1])
                            + delta[b0][d0] * delta[c0][c1] * (PB_1 * PA_0 * PQ[d1])
                            + delta[b0][b1] * delta[d0][d1] * (PA_0 * PQ[c0] * PQ[c1] * (-1.0))
                            + delta[b0][b1] * delta[c1][d1] * (PA_0 * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[b0][b1] * delta[c1][d0] * (PA_0 * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[b0][b1] * delta[c0][c1] * (PA_0 * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PQ[c0] * PQ[c1] * (-1.0))
                            + delta[a0][b1] * delta[c1][d1] * (PB_0 * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][b1] * delta[c1][d0] * (PB_0 * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][b1] * delta[c0][c1] * (PB_0 * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PQ[c0] * PQ[c1] * (-1.0))
                            + delta[a0][b0] * delta[c1][d1] * (PB_1 * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[c1][d0] * (PB_1 * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[c0][c1] * (PB_1 * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[d0][d1] * (PB_0 * PB_1 * PQ[c0])
                            + delta[a0][d0] * delta[c1][d1] * (PB_0 * PB_1 * PQ[c0])
                            + delta[a0][d1] * delta[c1][d0] * (PB_0 * PB_1 * PQ[c0])
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * PB_1 * PQ[c1])
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * PB_1 * PQ[c1])
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * PB_1 * PQ[c1])
                            + delta[a0][c0] * delta[c1][d1] * (PB_0 * PB_1 * PQ[d0])
                            + delta[a0][c1] * delta[c0][d1] * (PB_0 * PB_1 * PQ[d0])
                            + delta[a0][d1] * delta[c0][c1] * (PB_0 * PB_1 * PQ[d0])
                            + delta[a0][c0] * delta[c1][d0] * (PB_0 * PB_1 * PQ[d1])
                            + delta[a0][c1] * delta[c0][d0] * (PB_0 * PB_1 * PQ[d1])
                            + delta[a0][d0] * delta[c0][c1] * (PB_0 * PB_1 * PQ[d1])
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDDD11(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[4];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[3] * (

                        0.25 * S1 / ( S4 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[b1] * (-2.0) + PB_1 * PQ[a0] * PQ[b0] * (-2.0) + PA_0 * PQ[b0] * PQ[b1] * (-2.0))
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PQ[a0] * PQ[b1] * (-2.0) + PB_1 * PQ[a0] * PQ[b0] * (-2.0) + PA_0 * PQ[b0] * PQ[b1] * (-2.0))
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[b1] * (-2.0) + PB_1 * PQ[a0] * PQ[b0] * (-2.0) + PA_0 * PQ[b0] * PQ[b1] * (-2.0))
                            + delta[b1][c1] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[c0] * (-1.0) + PB_0 * PQ[a0] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * (-1.0) + PA_0 * PQ[b0] * QC_0 * (-1.0))
                            + delta[b1][d0] * delta[c1][d1] * (PB_0 * PQ[a0] * PQ[c0] * (-1.0) + PB_0 * PQ[a0] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * (-1.0) + PA_0 * PQ[b0] * QC_0 * (-1.0))
                            + delta[b1][d1] * delta[c1][d0] * (PB_0 * PQ[a0] * PQ[c0] * (-1.0) + PB_0 * PQ[a0] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * (-1.0) + PA_0 * PQ[b0] * QC_0 * (-1.0))
                            + delta[b1][c0] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[c1] * (-1.0) + PB_0 * PQ[a0] * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * (-1.0) + PA_0 * PQ[b0] * QC_1 * (-1.0))
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[c1] * (-1.0) + PB_0 * PQ[a0] * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * (-1.0) + PA_0 * PQ[b0] * QC_1 * (-1.0))
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * PQ[a0] * PQ[c1] * (-1.0) + PB_0 * PQ[a0] * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * (-1.0) + PA_0 * PQ[b0] * QC_1 * (-1.0))
                            + delta[b1][c0] * delta[c1][d1] * (PB_0 * PQ[a0] * PQ[d0] * (-1.0) + PB_0 * PQ[a0] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * QD_0 * (-1.0))
                            + delta[b1][c1] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[d0] * (-1.0) + PB_0 * PQ[a0] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * QD_0 * (-1.0))
                            + delta[b1][d1] * delta[c0][c1] * (PB_0 * PQ[a0] * PQ[d0] * (-1.0) + PB_0 * PQ[a0] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * QD_0 * (-1.0))
                            + delta[b1][c0] * delta[c1][d0] * (PB_0 * PQ[a0] * PQ[d1] * (-1.0) + PB_0 * PQ[a0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * QD_1 * (-1.0))
                            + delta[b1][c1] * delta[c0][d0] * (PB_0 * PQ[a0] * PQ[d1] * (-1.0) + PB_0 * PQ[a0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * QD_1 * (-1.0))
                            + delta[b1][d0] * delta[c0][c1] * (PB_0 * PQ[a0] * PQ[d1] * (-1.0) + PB_0 * PQ[a0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * QD_1 * (-1.0))
                            + delta[b0][c1] * delta[d0][d1] * (PB_1 * PQ[a0] * PQ[c0] * (-1.0) + PB_1 * PQ[a0] * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * (-1.0) + PA_0 * PQ[b1] * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[c1][d1] * (PB_1 * PQ[a0] * PQ[c0] * (-1.0) + PB_1 * PQ[a0] * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * (-1.0) + PA_0 * PQ[b1] * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[c1][d0] * (PB_1 * PQ[a0] * PQ[c0] * (-1.0) + PB_1 * PQ[a0] * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * (-1.0) + PA_0 * PQ[b1] * QC_0 * (-1.0))
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * PQ[a0] * PQ[c1] * (-1.0) + PB_1 * PQ[a0] * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c1] * (-1.0) + PA_0 * PQ[b1] * QC_1 * (-1.0))
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * PQ[a0] * PQ[c1] * (-1.0) + PB_1 * PQ[a0] * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c1] * (-1.0) + PA_0 * PQ[b1] * QC_1 * (-1.0))
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * PQ[a0] * PQ[c1] * (-1.0) + PB_1 * PQ[a0] * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c1] * (-1.0) + PA_0 * PQ[b1] * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[c1][d1] * (PB_1 * PQ[a0] * PQ[d0] * (-1.0) + PB_1 * PQ[a0] * QD_0 * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * (-1.0) + PA_0 * PQ[b1] * QD_0 * (-1.0))
                            + delta[b0][c1] * delta[c0][d1] * (PB_1 * PQ[a0] * PQ[d0] * (-1.0) + PB_1 * PQ[a0] * QD_0 * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * (-1.0) + PA_0 * PQ[b1] * QD_0 * (-1.0))
                            + delta[b0][d1] * delta[c0][c1] * (PB_1 * PQ[a0] * PQ[d0] * (-1.0) + PB_1 * PQ[a0] * QD_0 * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * (-1.0) + PA_0 * PQ[b1] * QD_0 * (-1.0))
                            + delta[b0][c0] * delta[c1][d0] * (PB_1 * PQ[a0] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * QD_1 * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * (-1.0) + PA_0 * PQ[b1] * QD_1 * (-1.0))
                            + delta[b0][c1] * delta[c0][d0] * (PB_1 * PQ[a0] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * QD_1 * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * (-1.0) + PA_0 * PQ[b1] * QD_1 * (-1.0))
                            + delta[b0][d0] * delta[c0][c1] * (PB_1 * PQ[a0] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * QD_1 * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * (-1.0) + PA_0 * PQ[b1] * QD_1 * (-1.0))
                            + delta[b0][b1] * delta[d0][d1] * (PA_0 * PQ[c0] * PQ[c1] * (-1.0) + PA_0 * PQ[c0] * QC_1 * (-1.0) + PA_0 * PQ[c1] * QC_0 * (-1.0) + PQ[a0] * PQ[c0] * PQ[c1] + PQ[a0] * PQ[c0] * QC_1 + PQ[a0] * PQ[c1] * QC_0)
                            + delta[b0][b1] * delta[c1][d1] * (PA_0 * PQ[c0] * PQ[d0] * (-1.0) + PA_0 * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[d0] * QC_0 * (-1.0) + PQ[a0] * PQ[c0] * PQ[d0] + PQ[a0] * PQ[c0] * QD_0 + PQ[a0] * PQ[d0] * QC_0)
                            + delta[b0][b1] * delta[c1][d0] * (PA_0 * PQ[c0] * PQ[d1] * (-1.0) + PA_0 * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[d1] * QC_0 * (-1.0) + PQ[a0] * PQ[c0] * PQ[d1] + PQ[a0] * PQ[c0] * QD_1 + PQ[a0] * PQ[d1] * QC_0)
                            + delta[b0][d0] * delta[b1][d1] * (PA_0 * PQ[c0] * QC_1 * (-1.0) + PA_0 * PQ[c1] * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[b1][d0] * (PA_0 * PQ[c0] * QC_1 * (-1.0) + PA_0 * PQ[c1] * QC_0 * (-1.0))
                            + delta[b0][c1] * delta[b1][d1] * (PA_0 * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[b1][c1] * (PA_0 * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][c1] * delta[b1][d0] * (PA_0 * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[b1][c1] * (PA_0 * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * PQ[c1] * PQ[d0] * (-1.0) + PA_0 * PQ[c1] * QD_0 * (-1.0) + PA_0 * PQ[d0] * QC_1 * (-1.0) + PQ[a0] * PQ[c1] * PQ[d0] + PQ[a0] * PQ[c1] * QD_0 + PQ[a0] * PQ[d0] * QC_1)
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * PQ[c1] * PQ[d1] * (-1.0) + PA_0 * PQ[c1] * QD_1 * (-1.0) + PA_0 * PQ[d1] * QC_1 * (-1.0) + PQ[a0] * PQ[c1] * PQ[d1] + PQ[a0] * PQ[c1] * QD_1 + PQ[a0] * PQ[d1] * QC_1)
                            + delta[b0][c0] * delta[b1][d1] * (PA_0 * PQ[c1] * QD_0 * (-1.0) + PA_0 * PQ[d0] * QC_1 * (-1.0))
                            + delta[b0][d1] * delta[b1][c0] * (PA_0 * PQ[c1] * QD_0 * (-1.0) + PA_0 * PQ[d0] * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[b1][d0] * (PA_0 * PQ[c1] * QD_1 * (-1.0) + PA_0 * PQ[d1] * QC_1 * (-1.0))
                            + delta[b0][d0] * delta[b1][c0] * (PA_0 * PQ[c1] * QD_1 * (-1.0) + PA_0 * PQ[d1] * QC_1 * (-1.0))
                            + delta[b0][b1] * delta[c0][c1] * (PA_0 * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[d1] * QD_0 * (-1.0) + PQ[a0] * PQ[d0] * PQ[d1] + PQ[a0] * PQ[d0] * QD_1 + PQ[a0] * PQ[d1] * QD_0)
                            + delta[b0][c0] * delta[b1][c1] * (PA_0 * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][c1] * delta[b1][c0] * (PA_0 * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[d0][d1] * (PB_0 * PQ[b1] * PQ[c0] * (-1.0) + PB_0 * PQ[b1] * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * (-1.0) + PB_1 * PQ[b0] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[c1][d1] * (PB_0 * PQ[b1] * PQ[c0] * (-1.0) + PB_0 * PQ[b1] * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * (-1.0) + PB_1 * PQ[b0] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[c1][d0] * (PB_0 * PQ[b1] * PQ[c0] * (-1.0) + PB_0 * PQ[b1] * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * (-1.0) + PB_1 * PQ[b0] * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * PQ[b1] * PQ[c1] * (-1.0) + PB_0 * PQ[b1] * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * (-1.0) + PB_1 * PQ[b0] * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * PQ[b1] * PQ[c1] * (-1.0) + PB_0 * PQ[b1] * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * (-1.0) + PB_1 * PQ[b0] * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * PQ[b1] * PQ[c1] * (-1.0) + PB_0 * PQ[b1] * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * (-1.0) + PB_1 * PQ[b0] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[c1][d1] * (PB_0 * PQ[b1] * PQ[d0] * (-1.0) + PB_0 * PQ[b1] * QD_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * (-1.0) + PB_1 * PQ[b0] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[c0][d1] * (PB_0 * PQ[b1] * PQ[d0] * (-1.0) + PB_0 * PQ[b1] * QD_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * (-1.0) + PB_1 * PQ[b0] * QD_0 * (-1.0))
                            + delta[a0][d1] * delta[c0][c1] * (PB_0 * PQ[b1] * PQ[d0] * (-1.0) + PB_0 * PQ[b1] * QD_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * (-1.0) + PB_1 * PQ[b0] * QD_0 * (-1.0))
                            + delta[a0][c0] * delta[c1][d0] * (PB_0 * PQ[b1] * PQ[d1] * (-1.0) + PB_0 * PQ[b1] * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * (-1.0) + PB_1 * PQ[b0] * QD_1 * (-1.0))
                            + delta[a0][c1] * delta[c0][d0] * (PB_0 * PQ[b1] * PQ[d1] * (-1.0) + PB_0 * PQ[b1] * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * (-1.0) + PB_1 * PQ[b0] * QD_1 * (-1.0))
                            + delta[a0][d0] * delta[c0][c1] * (PB_0 * PQ[b1] * PQ[d1] * (-1.0) + PB_0 * PQ[b1] * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * (-1.0) + PB_1 * PQ[b0] * QD_1 * (-1.0))
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PQ[c0] * PQ[c1] * (-1.0) + PB_0 * PQ[c0] * QC_1 * (-1.0) + PB_0 * PQ[c1] * QC_0 * (-1.0) + PQ[b0] * PQ[c0] * PQ[c1] + PQ[b0] * PQ[c0] * QC_1 + PQ[b0] * PQ[c1] * QC_0)
                            + delta[a0][b1] * delta[c1][d1] * (PB_0 * PQ[c0] * PQ[d0] * (-1.0) + PB_0 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[d0] * QC_0 * (-1.0) + PQ[b0] * PQ[c0] * PQ[d0] + PQ[b0] * PQ[c0] * QD_0 + PQ[b0] * PQ[d0] * QC_0)
                            + delta[a0][b1] * delta[c1][d0] * (PB_0 * PQ[c0] * PQ[d1] * (-1.0) + PB_0 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[d1] * QC_0 * (-1.0) + PQ[b0] * PQ[c0] * PQ[d1] + PQ[b0] * PQ[c0] * QD_1 + PQ[b0] * PQ[d1] * QC_0)
                            + delta[a0][d0] * delta[b1][d1] * (PB_0 * PQ[c0] * QC_1 * (-1.0) + PB_0 * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b1][d0] * (PB_0 * PQ[c0] * QC_1 * (-1.0) + PB_0 * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b1][d1] * (PB_0 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b1][c1] * (PB_0 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b1][d0] * (PB_0 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b1][c1] * (PB_0 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * PQ[c1] * PQ[d0] * (-1.0) + PB_0 * PQ[c1] * QD_0 * (-1.0) + PB_0 * PQ[d0] * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * PQ[d0] + PQ[b0] * PQ[c1] * QD_0 + PQ[b0] * PQ[d0] * QC_1)
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PQ[c1] * PQ[d1] * (-1.0) + PB_0 * PQ[c1] * QD_1 * (-1.0) + PB_0 * PQ[d1] * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * PQ[d1] + PQ[b0] * PQ[c1] * QD_1 + PQ[b0] * PQ[d1] * QC_1)
                            + delta[a0][c0] * delta[b1][d1] * (PB_0 * PQ[c1] * QD_0 * (-1.0) + PB_0 * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[b1][c0] * (PB_0 * PQ[c1] * QD_0 * (-1.0) + PB_0 * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[b1][d0] * (PB_0 * PQ[c1] * QD_1 * (-1.0) + PB_0 * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[b1][c0] * (PB_0 * PQ[c1] * QD_1 * (-1.0) + PB_0 * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][b1] * delta[c0][c1] * (PB_0 * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[d1] * QD_0 * (-1.0) + PQ[b0] * PQ[d0] * PQ[d1] + PQ[b0] * PQ[d0] * QD_1 + PQ[b0] * PQ[d1] * QD_0)
                            + delta[a0][c0] * delta[b1][c1] * (PB_0 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[b1][c0] * (PB_0 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PQ[c0] * PQ[c1] * (-1.0) + PB_1 * PQ[c0] * QC_1 * (-1.0) + PB_1 * PQ[c1] * QC_0 * (-1.0) + PQ[b1] * PQ[c0] * PQ[c1] + PQ[b1] * PQ[c0] * QC_1 + PQ[b1] * PQ[c1] * QC_0)
                            + delta[a0][b0] * delta[c1][d1] * (PB_1 * PQ[c0] * PQ[d0] * (-1.0) + PB_1 * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[d0] * QC_0 * (-1.0) + PQ[b1] * PQ[c0] * PQ[d0] + PQ[b1] * PQ[c0] * QD_0 + PQ[b1] * PQ[d0] * QC_0)
                            + delta[a0][b0] * delta[c1][d0] * (PB_1 * PQ[c0] * PQ[d1] * (-1.0) + PB_1 * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[d1] * QC_0 * (-1.0) + PQ[b1] * PQ[c0] * PQ[d1] + PQ[b1] * PQ[c0] * QD_1 + PQ[b1] * PQ[d1] * QC_0)
                            + delta[a0][d0] * delta[b0][d1] * (PB_1 * PQ[c0] * QC_1 * (-1.0) + PB_1 * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * (PB_1 * PQ[c0] * QC_1 * (-1.0) + PB_1 * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][d1] * (PB_1 * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][c1] * (PB_1 * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][d0] * (PB_1 * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b0][c1] * (PB_1 * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PQ[c1] * QD_0 * (-1.0) + PB_1 * PQ[d0] * QC_1 * (-1.0) + PQ[b1] * PQ[c1] * PQ[d0] + PQ[b1] * PQ[c1] * QD_0 + PQ[b1] * PQ[d0] * QC_1)
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PQ[c1] * QD_1 * (-1.0) + PB_1 * PQ[d1] * QC_1 * (-1.0) + PQ[b1] * PQ[c1] * PQ[d1] + PQ[b1] * PQ[c1] * QD_1 + PQ[b1] * PQ[d1] * QC_1)
                            + delta[a0][c0] * delta[b0][d1] * (PB_1 * PQ[c1] * QD_0 * (-1.0) + PB_1 * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[b0][c0] * (PB_1 * PQ[c1] * QD_0 * (-1.0) + PB_1 * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[b0][d0] * (PB_1 * PQ[c1] * QD_1 * (-1.0) + PB_1 * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][c0] * (PB_1 * PQ[c1] * QD_1 * (-1.0) + PB_1 * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[c0][c1] * (PB_1 * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[d1] * QD_0 * (-1.0) + PQ[b1] * PQ[d0] * PQ[d1] + PQ[b1] * PQ[d0] * QD_1 + PQ[b1] * PQ[d1] * QD_0)
                            + delta[a0][c0] * delta[b0][c1] * (PB_1 * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][c0] * (PB_1 * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * (PQ[c0] * PQ[c1] * QD_0 + PQ[c0] * PQ[d0] * QC_1 + PQ[c1] * PQ[d0] * QC_0)
                            + delta[a0][b0] * delta[b1][d1] * (PQ[c0] * PQ[c1] * QD_0 + PQ[c0] * PQ[d0] * QC_1 + PQ[c1] * PQ[d0] * QC_0)
                            + delta[b0][d1] * delta[a0][b1] * (PQ[c0] * PQ[c1] * QD_0 + PQ[c0] * PQ[d0] * QC_1 + PQ[c1] * PQ[d0] * QC_0)
                            + delta[a0][d0] * delta[b0][b1] * (PQ[c0] * PQ[c1] * QD_1 + PQ[c0] * PQ[d1] * QC_1 + PQ[c1] * PQ[d1] * QC_0)
                            + delta[a0][b0] * delta[b1][d0] * (PQ[c0] * PQ[c1] * QD_1 + PQ[c0] * PQ[d1] * QC_1 + PQ[c1] * PQ[d1] * QC_0)
                            + delta[b0][d0] * delta[a0][b1] * (PQ[c0] * PQ[c1] * QD_1 + PQ[c0] * PQ[d1] * QC_1 + PQ[c1] * PQ[d1] * QC_0)
                            + delta[a0][c1] * delta[b0][b1] * (PQ[c0] * PQ[d0] * QD_1 + PQ[c0] * PQ[d1] * QD_0 + PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][b0] * delta[b1][c1] * (PQ[c0] * PQ[d0] * QD_1 + PQ[c0] * PQ[d1] * QD_0 + PQ[d0] * PQ[d1] * QC_0)
                            + delta[b0][c1] * delta[a0][b1] * (PQ[c0] * PQ[d0] * QD_1 + PQ[c0] * PQ[d1] * QD_0 + PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][c0] * delta[b0][b1] * (PQ[c1] * PQ[d0] * QD_1 + PQ[c1] * PQ[d1] * QD_0 + PQ[d0] * PQ[d1] * QC_1)
                            + delta[a0][b0] * delta[b1][c0] * (PQ[c1] * PQ[d0] * QD_1 + PQ[c1] * PQ[d1] * QD_0 + PQ[d0] * PQ[d1] * QC_1)
                            + delta[b0][c0] * delta[a0][b1] * (PQ[c1] * PQ[d0] * QD_1 + PQ[c1] * PQ[d1] * QD_0 + PQ[d0] * PQ[d1] * QC_1)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDDD12(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[4];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[3] * (

                        0.25 * S2 / ( S4 * S4 * S4 ) * (
                            delta[b1][c1] * delta[d0][d1] * (PQ[a0] * PQ[b0] * QC_0)
                            + delta[b1][d0] * delta[c1][d1] * (PQ[a0] * PQ[b0] * QC_0)
                            + delta[b1][d1] * delta[c1][d0] * (PQ[a0] * PQ[b0] * QC_0)
                            + delta[b1][c0] * delta[d0][d1] * (PQ[a0] * PQ[b0] * QC_1)
                            + delta[b1][d0] * delta[c0][d1] * (PQ[a0] * PQ[b0] * QC_1)
                            + delta[b1][d1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * QC_1)
                            + delta[b0][c1] * delta[d0][d1] * (PQ[a0] * PQ[b1] * QC_0)
                            + delta[b0][d0] * delta[c1][d1] * (PQ[a0] * PQ[b1] * QC_0)
                            + delta[b0][d1] * delta[c1][d0] * (PQ[a0] * PQ[b1] * QC_0)
                            + delta[b0][c0] * delta[d0][d1] * (PQ[a0] * PQ[b1] * QC_1)
                            + delta[b0][d0] * delta[c0][d1] * (PQ[a0] * PQ[b1] * QC_1)
                            + delta[b0][d1] * delta[c0][d0] * (PQ[a0] * PQ[b1] * QC_1)
                            + delta[b0][b1] * delta[d0][d1] * (PQ[a0] * PQ[c0] * QC_1 + PQ[a0] * PQ[c1] * QC_0 + PQ[a0] * QC_0 * QC_1)
                            + delta[b0][b1] * delta[c1][d1] * (PQ[a0] * PQ[c0] * QD_0 + PQ[a0] * PQ[d0] * QC_0 + PQ[a0] * QD_0 * QC_0)
                            + delta[b0][b1] * delta[c0][d1] * (PQ[a0] * PQ[c1] * QD_0 + PQ[a0] * PQ[d0] * QC_1 + PQ[a0] * QD_0 * QC_1)
                            + delta[b0][b1] * delta[c1][d0] * (PQ[a0] * PQ[c0] * QD_1 + PQ[a0] * PQ[d1] * QC_0 + PQ[a0] * QD_1 * QC_0)
                            + delta[b0][b1] * delta[c0][d0] * (PQ[a0] * PQ[c1] * QD_1 + PQ[a0] * PQ[d1] * QC_1 + PQ[a0] * QD_1 * QC_1)
                            + delta[b0][d0] * delta[b1][d1] * (PQ[a0] * QC_0 * QC_1)
                            + delta[b0][d1] * delta[b1][d0] * (PQ[a0] * QC_0 * QC_1)
                            + delta[b0][c1] * delta[b1][d1] * (PQ[a0] * QD_0 * QC_0)
                            + delta[b0][d1] * delta[b1][c1] * (PQ[a0] * QD_0 * QC_0)
                            + delta[b0][c1] * delta[b1][d0] * (PQ[a0] * QD_1 * QC_0)
                            + delta[b0][d0] * delta[b1][c1] * (PQ[a0] * QD_1 * QC_0)
                            + delta[b0][c0] * delta[b1][d1] * (PQ[a0] * QD_0 * QC_1)
                            + delta[b0][d1] * delta[b1][c0] * (PQ[a0] * QD_0 * QC_1)
                            + delta[b0][c0] * delta[b1][d0] * (PQ[a0] * QD_1 * QC_1)
                            + delta[b0][d0] * delta[b1][c0] * (PQ[a0] * QD_1 * QC_1)
                            + delta[a0][c1] * delta[d0][d1] * (PQ[b0] * PQ[b1] * QC_0)
                            + delta[a0][d0] * delta[c1][d1] * (PQ[b0] * PQ[b1] * QC_0)
                            + delta[a0][d1] * delta[c1][d0] * (PQ[b0] * PQ[b1] * QC_0)
                            + delta[a0][c0] * delta[d0][d1] * (PQ[b0] * PQ[b1] * QC_1)
                            + delta[a0][d0] * delta[c0][d1] * (PQ[b0] * PQ[b1] * QC_1)
                            + delta[a0][d1] * delta[c0][d0] * (PQ[b0] * PQ[b1] * QC_1)
                            + delta[a0][b1] * delta[d0][d1] * (PQ[b0] * PQ[c0] * QC_1 + PQ[b0] * PQ[c1] * QC_0 + PQ[b0] * QC_0 * QC_1)
                            + delta[a0][b1] * delta[c1][d1] * (PQ[b0] * PQ[c0] * QD_0 + PQ[b0] * PQ[d0] * QC_0 + PQ[b0] * QD_0 * QC_0)
                            + delta[a0][b1] * delta[c0][d1] * (PQ[b0] * PQ[c1] * QD_0 + PQ[b0] * PQ[d0] * QC_1 + PQ[b0] * QD_0 * QC_1)
                            + delta[a0][b1] * delta[c1][d0] * (PQ[b0] * PQ[c0] * QD_1 + PQ[b0] * PQ[d1] * QC_0 + PQ[b0] * QD_1 * QC_0)
                            + delta[a0][b1] * delta[c0][d0] * (PQ[b0] * PQ[c1] * QD_1 + PQ[b0] * PQ[d1] * QC_1 + PQ[b0] * QD_1 * QC_1)
                            + delta[a0][d0] * delta[b1][d1] * (PQ[b0] * QC_0 * QC_1)
                            + delta[a0][d1] * delta[b1][d0] * (PQ[b0] * QC_0 * QC_1)
                            + delta[a0][c1] * delta[b1][d1] * (PQ[b0] * QD_0 * QC_0)
                            + delta[a0][d1] * delta[b1][c1] * (PQ[b0] * QD_0 * QC_0)
                            + delta[a0][c1] * delta[b1][d0] * (PQ[b0] * QD_1 * QC_0)
                            + delta[a0][d0] * delta[b1][c1] * (PQ[b0] * QD_1 * QC_0)
                            + delta[a0][c0] * delta[b1][d1] * (PQ[b0] * QD_0 * QC_1)
                            + delta[a0][d1] * delta[b1][c0] * (PQ[b0] * QD_0 * QC_1)
                            + delta[a0][c0] * delta[b1][d0] * (PQ[b0] * QD_1 * QC_1)
                            + delta[a0][d0] * delta[b1][c0] * (PQ[b0] * QD_1 * QC_1)
                            + delta[a0][b0] * delta[d0][d1] * (PQ[b1] * PQ[c0] * QC_1 + PQ[b1] * PQ[c1] * QC_0 + PQ[b1] * QC_0 * QC_1)
                            + delta[a0][b0] * delta[c1][d1] * (PQ[b1] * PQ[c0] * QD_0 + PQ[b1] * PQ[d0] * QC_0 + PQ[b1] * QD_0 * QC_0)
                            + delta[a0][b0] * delta[c0][d1] * (PQ[b1] * PQ[c1] * QD_0 + PQ[b1] * PQ[d0] * QC_1 + PQ[b1] * QD_0 * QC_1)
                            + delta[a0][b0] * delta[c1][d0] * (PQ[b1] * PQ[c0] * QD_1 + PQ[b1] * PQ[d1] * QC_0 + PQ[b1] * QD_1 * QC_0)
                            + delta[a0][b0] * delta[c0][d0] * (PQ[b1] * PQ[c1] * QD_1 + PQ[b1] * PQ[d1] * QC_1 + PQ[b1] * QD_1 * QC_1)
                            + delta[a0][d0] * delta[b0][d1] * (PQ[b1] * QC_0 * QC_1)
                            + delta[a0][d1] * delta[b0][d0] * (PQ[b1] * QC_0 * QC_1)
                            + delta[a0][c1] * delta[b0][d1] * (PQ[b1] * QD_0 * QC_0)
                            + delta[a0][d1] * delta[b0][c1] * (PQ[b1] * QD_0 * QC_0)
                            + delta[a0][c1] * delta[b0][d0] * (PQ[b1] * QD_1 * QC_0)
                            + delta[a0][d0] * delta[b0][c1] * (PQ[b1] * QD_1 * QC_0)
                            + delta[a0][c0] * delta[b0][d1] * (PQ[b1] * QD_0 * QC_1)
                            + delta[a0][d1] * delta[b0][c0] * (PQ[b1] * QD_0 * QC_1)
                            + delta[a0][c0] * delta[b0][d0] * (PQ[b1] * QD_1 * QC_1)
                            + delta[a0][d0] * delta[b0][c0] * (PQ[b1] * QD_1 * QC_1)
                            + delta[a0][d1] * delta[b0][b1] * (PQ[c0] * QD_0 * QC_1 + PQ[c1] * QD_0 * QC_0 + PQ[d0] * QC_0 * QC_1)
                            + delta[a0][b0] * delta[b1][d1] * (PQ[c0] * QD_0 * QC_1 + PQ[c1] * QD_0 * QC_0 + PQ[d0] * QC_0 * QC_1)
                            + delta[b0][d1] * delta[a0][b1] * (PQ[c0] * QD_0 * QC_1 + PQ[c1] * QD_0 * QC_0 + PQ[d0] * QC_0 * QC_1)
                            + delta[a0][d0] * delta[b0][b1] * (PQ[c0] * QD_1 * QC_1 + PQ[c1] * QD_1 * QC_0 + PQ[d1] * QC_0 * QC_1)
                            + delta[a0][b0] * delta[b1][d0] * (PQ[c0] * QD_1 * QC_1 + PQ[c1] * QD_1 * QC_0 + PQ[d1] * QC_0 * QC_1)
                            + delta[b0][d0] * delta[a0][b1] * (PQ[c0] * QD_1 * QC_1 + PQ[c1] * QD_1 * QC_0 + PQ[d1] * QC_0 * QC_1)
                            + delta[a0][c1] * delta[b0][b1] * (PQ[c0] * QD_0 * QD_1 + PQ[d0] * QD_1 * QC_0 + PQ[d1] * QD_0 * QC_0)
                            + delta[a0][b0] * delta[b1][c1] * (PQ[c0] * QD_0 * QD_1 + PQ[d0] * QD_1 * QC_0 + PQ[d1] * QD_0 * QC_0)
                            + delta[b0][c1] * delta[a0][b1] * (PQ[c0] * QD_0 * QD_1 + PQ[d0] * QD_1 * QC_0 + PQ[d1] * QD_0 * QC_0)
                            + delta[a0][c0] * delta[b0][b1] * (PQ[c1] * QD_0 * QD_1 + PQ[d0] * QD_1 * QC_1 + PQ[d1] * QD_0 * QC_1)
                            + delta[a0][b0] * delta[b1][c0] * (PQ[c1] * QD_0 * QD_1 + PQ[d0] * QD_1 * QC_1 + PQ[d1] * QD_0 * QC_1)
                            + delta[b0][c0] * delta[a0][b1] * (PQ[c1] * QD_0 * QD_1 + PQ[d0] * QD_1 * QC_1 + PQ[d1] * QD_0 * QC_1)
                            + delta[c0][c1] * delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[b1])
                            + delta[c0][d0] * delta[c1][d1] * (PQ[a0] * PQ[b0] * PQ[b1])
                            + delta[c1][d0] * delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[b1])
                            + delta[b1][c0] * delta[c1][d1] * (PQ[a0] * PQ[b0] * QD_0)
                            + delta[b1][c1] * delta[c0][d1] * (PQ[a0] * PQ[b0] * QD_0)
                            + delta[b1][d1] * delta[c0][c1] * (PQ[a0] * PQ[b0] * QD_0)
                            + delta[b1][c0] * delta[c1][d0] * (PQ[a0] * PQ[b0] * QD_1)
                            + delta[b1][c1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * QD_1)
                            + delta[b1][d0] * delta[c0][c1] * (PQ[a0] * PQ[b0] * QD_1)
                            + delta[b0][c0] * delta[c1][d1] * (PQ[a0] * PQ[b1] * QD_0)
                            + delta[b0][c1] * delta[c0][d1] * (PQ[a0] * PQ[b1] * QD_0)
                            + delta[b0][d1] * delta[c0][c1] * (PQ[a0] * PQ[b1] * QD_0)
                            + delta[b0][c0] * delta[c1][d0] * (PQ[a0] * PQ[b1] * QD_1)
                            + delta[b0][c1] * delta[c0][d0] * (PQ[a0] * PQ[b1] * QD_1)
                            + delta[b0][d0] * delta[c0][c1] * (PQ[a0] * PQ[b1] * QD_1)
                            + delta[b0][b1] * delta[c0][c1] * (PQ[a0] * PQ[d0] * QD_1 + PQ[a0] * PQ[d1] * QD_0 + PQ[a0] * QD_0 * QD_1)
                            + delta[b0][c0] * delta[b1][c1] * (PQ[a0] * QD_0 * QD_1)
                            + delta[b0][c1] * delta[b1][c0] * (PQ[a0] * QD_0 * QD_1)
                            + delta[a0][c0] * delta[c1][d1] * (PQ[b0] * PQ[b1] * QD_0)
                            + delta[a0][c1] * delta[c0][d1] * (PQ[b0] * PQ[b1] * QD_0)
                            + delta[a0][d1] * delta[c0][c1] * (PQ[b0] * PQ[b1] * QD_0)
                            + delta[a0][c0] * delta[c1][d0] * (PQ[b0] * PQ[b1] * QD_1)
                            + delta[a0][c1] * delta[c0][d0] * (PQ[b0] * PQ[b1] * QD_1)
                            + delta[a0][d0] * delta[c0][c1] * (PQ[b0] * PQ[b1] * QD_1)
                            + delta[a0][b1] * delta[c0][c1] * (PQ[b0] * PQ[d0] * QD_1 + PQ[b0] * PQ[d1] * QD_0 + PQ[b0] * QD_0 * QD_1)
                            + delta[a0][c0] * delta[b1][c1] * (PQ[b0] * QD_0 * QD_1)
                            + delta[a0][c1] * delta[b1][c0] * (PQ[b0] * QD_0 * QD_1)
                            + delta[a0][b0] * delta[c0][c1] * (PQ[b1] * PQ[d0] * QD_1 + PQ[b1] * PQ[d1] * QD_0 + PQ[b1] * QD_0 * QD_1)
                            + delta[a0][c0] * delta[b0][c1] * (PQ[b1] * QD_0 * QD_1)
                            + delta[a0][c1] * delta[b0][c0] * (PQ[b1] * QD_0 * QD_1)
                        )

                    )

                    +

                    F7_t[3] * (

                        0.5 * ( S1 * S1 ) / ( S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[c1] + PB_0 * PB_1 * PQ[a0] * PQ[c0] * QC_1 + PB_0 * PB_1 * PQ[a0] * PQ[c1] * QC_0 + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[c1] + PB_0 * PA_0 * PQ[b1] * PQ[c0] * QC_1 + PB_0 * PA_0 * PQ[b1] * PQ[c1] * QC_0 + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[c1] + PB_1 * PA_0 * PQ[b0] * PQ[c0] * QC_1 + PB_1 * PA_0 * PQ[b0] * PQ[c1] * QC_0)
                            + delta[c1][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[d0] + PB_0 * PB_1 * PQ[a0] * PQ[c0] * QD_0 + PB_0 * PB_1 * PQ[a0] * PQ[d0] * QC_0 + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[d0] + PB_0 * PA_0 * PQ[b1] * PQ[c0] * QD_0 + PB_0 * PA_0 * PQ[b1] * PQ[d0] * QC_0 + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[d0] + PB_1 * PA_0 * PQ[b0] * PQ[c0] * QD_0 + PB_1 * PA_0 * PQ[b0] * PQ[d0] * QC_0)
                            + delta[c1][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[d1] + PB_0 * PB_1 * PQ[a0] * PQ[c0] * QD_1 + PB_0 * PB_1 * PQ[a0] * PQ[d1] * QC_0 + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[d1] + PB_0 * PA_0 * PQ[b1] * PQ[c0] * QD_1 + PB_0 * PA_0 * PQ[b1] * PQ[d1] * QC_0 + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[d1] + PB_1 * PA_0 * PQ[b0] * PQ[c0] * QD_1 + PB_1 * PA_0 * PQ[b0] * PQ[d1] * QC_0)
                            + delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[c1] * PQ[d0] + PB_0 * PB_1 * PQ[a0] * PQ[c1] * QD_0 + PB_0 * PB_1 * PQ[a0] * PQ[d0] * QC_1 + PB_0 * PA_0 * PQ[b1] * PQ[c1] * PQ[d0] + PB_0 * PA_0 * PQ[b1] * PQ[c1] * QD_0 + PB_0 * PA_0 * PQ[b1] * PQ[d0] * QC_1 + PB_1 * PA_0 * PQ[b0] * PQ[c1] * PQ[d0] + PB_1 * PA_0 * PQ[b0] * PQ[c1] * QD_0 + PB_1 * PA_0 * PQ[b0] * PQ[d0] * QC_1)
                            + delta[c0][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[c1] * PQ[d1] + PB_0 * PB_1 * PQ[a0] * PQ[c1] * QD_1 + PB_0 * PB_1 * PQ[a0] * PQ[d1] * QC_1 + PB_0 * PA_0 * PQ[b1] * PQ[c1] * PQ[d1] + PB_0 * PA_0 * PQ[b1] * PQ[c1] * QD_1 + PB_0 * PA_0 * PQ[b1] * PQ[d1] * QC_1 + PB_1 * PA_0 * PQ[b0] * PQ[c1] * PQ[d1] + PB_1 * PA_0 * PQ[b0] * PQ[c1] * QD_1 + PB_1 * PA_0 * PQ[b0] * PQ[d1] * QC_1)
                            + delta[c0][c1] * (PB_0 * PB_1 * PQ[a0] * PQ[d0] * PQ[d1] + PB_0 * PB_1 * PQ[a0] * PQ[d0] * QD_1 + PB_0 * PB_1 * PQ[a0] * PQ[d1] * QD_0 + PB_0 * PA_0 * PQ[b1] * PQ[d0] * PQ[d1] + PB_0 * PA_0 * PQ[b1] * PQ[d0] * QD_1 + PB_0 * PA_0 * PQ[b1] * PQ[d1] * QD_0 + PB_1 * PA_0 * PQ[b0] * PQ[d0] * PQ[d1] + PB_1 * PA_0 * PQ[b0] * PQ[d0] * QD_1 + PB_1 * PA_0 * PQ[b0] * PQ[d1] * QD_0)
                            + delta[b1][d1] * (PB_0 * PA_0 * PQ[c0] * PQ[c1] * QD_0 + PB_0 * PA_0 * PQ[c0] * PQ[d0] * QC_1 + PB_0 * PA_0 * PQ[c1] * PQ[d0] * QC_0)
                            + delta[b1][d0] * (PB_0 * PA_0 * PQ[c0] * PQ[c1] * QD_1 + PB_0 * PA_0 * PQ[c0] * PQ[d1] * QC_1 + PB_0 * PA_0 * PQ[c1] * PQ[d1] * QC_0)
                            + delta[b1][c1] * (PB_0 * PA_0 * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PA_0 * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PA_0 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[b1][c0] * (PB_0 * PA_0 * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PA_0 * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PA_0 * PQ[d0] * PQ[d1] * QC_1)
                            + delta[b0][d1] * (PB_1 * PA_0 * PQ[c0] * PQ[c1] * QD_0 + PB_1 * PA_0 * PQ[c0] * PQ[d0] * QC_1 + PB_1 * PA_0 * PQ[c1] * PQ[d0] * QC_0)
                            + delta[b0][d0] * (PB_1 * PA_0 * PQ[c0] * PQ[c1] * QD_1 + PB_1 * PA_0 * PQ[c0] * PQ[d1] * QC_1 + PB_1 * PA_0 * PQ[c1] * PQ[d1] * QC_0)
                            + delta[b0][c1] * (PB_1 * PA_0 * PQ[c0] * PQ[d0] * QD_1 + PB_1 * PA_0 * PQ[c0] * PQ[d1] * QD_0 + PB_1 * PA_0 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[b0][c0] * (PB_1 * PA_0 * PQ[c1] * PQ[d0] * QD_1 + PB_1 * PA_0 * PQ[c1] * PQ[d1] * QD_0 + PB_1 * PA_0 * PQ[d0] * PQ[d1] * QC_1)
                            + delta[b0][b1] * (PA_0 * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PA_0 * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][d1] * (PB_0 * PB_1 * PQ[c0] * PQ[c1] * QD_0 + PB_0 * PB_1 * PQ[c0] * PQ[d0] * QC_1 + PB_0 * PB_1 * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a0][d0] * (PB_0 * PB_1 * PQ[c0] * PQ[c1] * QD_1 + PB_0 * PB_1 * PQ[c0] * PQ[d1] * QC_1 + PB_0 * PB_1 * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a0][c1] * (PB_0 * PB_1 * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PB_1 * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PB_1 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][c0] * (PB_0 * PB_1 * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PB_1 * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PB_1 * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a0][b1] * (PB_0 * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PB_0 * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][b0] * (PB_1 * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PB_1 * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                        )

                    )

                    +

                    F7_t[3] * (

                        0.5 * ( S1 * S1 * S1 ) / ( S2 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[c1] * (-1.0))
                            + delta[c1][d1] * (PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[c1][d0] * (PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[c0][d0] * (PB_0 * PB_1 * PA_0 * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[c0][c1] * (PB_0 * PB_1 * PA_0 * PQ[d0] * PQ[d1] * (-1.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDDD13(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[5];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[3] * (

                        0.5 * ( S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * PQ[c1] * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c1] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * QC_0 * QC_1 * (-1.0))
                            + delta[c1][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * QD_0 * QC_0 * (-1.0))
                            + delta[c1][d0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * QD_1 * QC_0 * (-1.0))
                            + delta[c0][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * QD_0 * QC_1 * (-1.0))
                            + delta[c0][d0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * PQ[d1] * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d1] * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d1] * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * QD_1 * QC_1 * (-1.0))
                            + delta[c0][c1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * QD_0 * QD_1 * (-1.0))
                            + delta[b1][d1] * (PB_0 * PQ[a0] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[b1][d0] * (PB_0 * PQ[a0] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[b1][c1] * (PB_0 * PQ[a0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[a0] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[b1][c0] * (PB_0 * PQ[a0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[b0][d1] * (PB_1 * PQ[a0] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][d0] * (PB_1 * PQ[a0] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][c1] * (PB_1 * PQ[a0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[b0][c0] * (PB_1 * PQ[a0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[a0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[b0][b1] * (PA_0 * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PQ[a0] * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PQ[a0] * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PQ[a0] * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PQ[a0] * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PQ[a0] * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PQ[a0] * PQ[d0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][d1] * (PB_0 * PQ[b1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_0 * PQ[b1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[b1] * PQ[d0] * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][d0] * (PB_0 * PQ[b1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[b1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[b1] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][c1] * (PB_0 * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][c0] * (PB_0 * PQ[b1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[b1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[b1] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[a0][b1] * (PB_0 * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_0 * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PQ[b0] * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PQ[b0] * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PQ[b0] * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * QC_1)
                            + delta[a0][b0] * (PB_1 * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0) + PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1 + PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1 + PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1 + PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0 + PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0 + PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1)
                        )

                    )

                    +

                    F7_t[3] * (

                        0.5 * ( S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * QC_0 * QC_1)
                            + delta[c1][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * QC_0)
                            + delta[c1][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * QD_1 * QC_0)
                            + delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * QC_1)
                            + delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * QD_1 * QC_1)
                            + delta[b1][d1] * (PQ[a0] * PQ[b0] * QD_0 * QC_0 * QC_1)
                            + delta[b1][d0] * (PQ[a0] * PQ[b0] * QD_1 * QC_0 * QC_1)
                            + delta[b1][c1] * (PQ[a0] * PQ[b0] * QD_0 * QD_1 * QC_0)
                            + delta[b1][c0] * (PQ[a0] * PQ[b0] * QD_0 * QD_1 * QC_1)
                            + delta[b0][d1] * (PQ[a0] * PQ[b1] * QD_0 * QC_0 * QC_1)
                            + delta[b0][d0] * (PQ[a0] * PQ[b1] * QD_1 * QC_0 * QC_1)
                            + delta[b0][c1] * (PQ[a0] * PQ[b1] * QD_0 * QD_1 * QC_0)
                            + delta[b0][c0] * (PQ[a0] * PQ[b1] * QD_0 * QD_1 * QC_1)
                            + delta[b0][b1] * (PQ[a0] * PQ[c0] * QD_0 * QD_1 * QC_1 + PQ[a0] * PQ[c1] * QD_0 * QD_1 * QC_0 + PQ[a0] * PQ[d0] * QD_1 * QC_0 * QC_1 + PQ[a0] * PQ[d1] * QD_0 * QC_0 * QC_1)
                            + delta[a0][d1] * (PQ[b0] * PQ[b1] * QD_0 * QC_0 * QC_1)
                            + delta[a0][d0] * (PQ[b0] * PQ[b1] * QD_1 * QC_0 * QC_1)
                            + delta[a0][c1] * (PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_0)
                            + delta[a0][c0] * (PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_1)
                            + delta[a0][b1] * (PQ[b0] * PQ[c0] * QD_0 * QD_1 * QC_1 + PQ[b0] * PQ[c1] * QD_0 * QD_1 * QC_0 + PQ[b0] * PQ[d0] * QD_1 * QC_0 * QC_1 + PQ[b0] * PQ[d1] * QD_0 * QC_0 * QC_1)
                            + delta[a0][b0] * (PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 + PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 + PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 + PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1)
                            + delta[c0][c1] * (PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * QD_1)
                        )

                    )

                    +

                    F7_t[4] * (

                        ( S1 * S1 * S1 * S1 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                        )

                    )

                    +

                    F7_t[4] * (

                        ( S1 * S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PB_0 * PB_1 * PQ[a0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                            + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PB_0 * PA_0 * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                            + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PB_1 * PA_0 * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDDD14(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[5];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[4] * (

                        ( S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                        )

                    )

                    +

                    F7_t[4] * (

                        ( S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                        )

                    )

                    +

                    F7_t[4] * (

                        0.125 * S1 / ( S4 * S4 * S4 * S4 ) * (
                            delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (PQ[a0] * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (PQ[a0] * (-1.0))
                            + delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (PQ[a0] * (-1.0))
                            + delta[b0][c0] * delta[b1][c1] * delta[d0][d1] * (PQ[a0] * (-1.0))
                            + delta[b0][c0] * delta[b1][d0] * delta[c1][d1] * (PQ[a0] * (-1.0))
                            + delta[b0][c0] * delta[b1][d1] * delta[c1][d0] * (PQ[a0] * (-1.0))
                            + delta[b0][c1] * delta[b1][c0] * delta[d0][d1] * (PQ[a0] * (-1.0))
                            + delta[b0][c1] * delta[b1][d0] * delta[c0][d1] * (PQ[a0] * (-1.0))
                            + delta[b0][c1] * delta[b1][d1] * delta[c0][d0] * (PQ[a0] * (-1.0))
                            + delta[b0][d0] * delta[b1][c0] * delta[c1][d1] * (PQ[a0] * (-1.0))
                            + delta[b0][d0] * delta[b1][c1] * delta[c0][d1] * (PQ[a0] * (-1.0))
                            + delta[b0][d0] * delta[b1][d1] * delta[c0][c1] * (PQ[a0] * (-1.0))
                            + delta[b0][d1] * delta[b1][c0] * delta[c1][d0] * (PQ[a0] * (-1.0))
                            + delta[b0][d1] * delta[b1][c1] * delta[c0][d0] * (PQ[a0] * (-1.0))
                            + delta[b0][d1] * delta[b1][d0] * delta[c0][c1] * (PQ[a0] * (-1.0))
                            + delta[a0][c0] * delta[b1][c1] * delta[d0][d1] * (PQ[b0] * (-1.0))
                            + delta[a0][c0] * delta[b1][d0] * delta[c1][d1] * (PQ[b0] * (-1.0))
                            + delta[a0][c0] * delta[b1][d1] * delta[c1][d0] * (PQ[b0] * (-1.0))
                            + delta[a0][c1] * delta[b1][c0] * delta[d0][d1] * (PQ[b0] * (-1.0))
                            + delta[a0][c1] * delta[b1][d0] * delta[c0][d1] * (PQ[b0] * (-1.0))
                            + delta[a0][c1] * delta[b1][d1] * delta[c0][d0] * (PQ[b0] * (-1.0))
                            + delta[a0][d0] * delta[b1][c0] * delta[c1][d1] * (PQ[b0] * (-1.0))
                            + delta[a0][d0] * delta[b1][c1] * delta[c0][d1] * (PQ[b0] * (-1.0))
                            + delta[a0][d0] * delta[b1][d1] * delta[c0][c1] * (PQ[b0] * (-1.0))
                            + delta[a0][d1] * delta[b1][c0] * delta[c1][d0] * (PQ[b0] * (-1.0))
                            + delta[a0][d1] * delta[b1][c1] * delta[c0][d0] * (PQ[b0] * (-1.0))
                            + delta[a0][d1] * delta[b1][d0] * delta[c0][c1] * (PQ[b0] * (-1.0))
                            + delta[a0][b1] * delta[c0][c1] * delta[d0][d1] * (PQ[b0] * (-1.0))
                            + delta[a0][b1] * delta[c0][d0] * delta[c1][d1] * (PQ[b0] * (-1.0))
                            + delta[a0][b1] * delta[c1][d0] * delta[c0][d1] * (PQ[b0] * (-1.0))
                            + delta[a0][c0] * delta[b0][c1] * delta[d0][d1] * (PQ[b1] * (-1.0))
                            + delta[a0][c0] * delta[b0][d0] * delta[c1][d1] * (PQ[b1] * (-1.0))
                            + delta[a0][c0] * delta[b0][d1] * delta[c1][d0] * (PQ[b1] * (-1.0))
                            + delta[a0][c1] * delta[b0][c0] * delta[d0][d1] * (PQ[b1] * (-1.0))
                            + delta[a0][c1] * delta[b0][d0] * delta[c0][d1] * (PQ[b1] * (-1.0))
                            + delta[a0][c1] * delta[b0][d1] * delta[c0][d0] * (PQ[b1] * (-1.0))
                            + delta[a0][d0] * delta[b0][c0] * delta[c1][d1] * (PQ[b1] * (-1.0))
                            + delta[a0][d0] * delta[b0][c1] * delta[c0][d1] * (PQ[b1] * (-1.0))
                            + delta[a0][d0] * delta[b0][d1] * delta[c0][c1] * (PQ[b1] * (-1.0))
                            + delta[a0][d1] * delta[b0][c0] * delta[c1][d0] * (PQ[b1] * (-1.0))
                            + delta[a0][d1] * delta[b0][c1] * delta[c0][d0] * (PQ[b1] * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * delta[c0][c1] * (PQ[b1] * (-1.0))
                            + delta[a0][b0] * delta[c0][c1] * delta[d0][d1] * (PQ[b1] * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * delta[c1][d1] * (PQ[b1] * (-1.0))
                            + delta[a0][b0] * delta[c1][d0] * delta[c0][d1] * (PQ[b1] * (-1.0))
                            + delta[a0][c1] * delta[b0][b1] * delta[d0][d1] * (PQ[c0] * (-1.0))
                            + delta[a0][c1] * delta[b0][d0] * delta[b1][d1] * (PQ[c0] * (-1.0))
                            + delta[a0][c1] * delta[b0][d1] * delta[b1][d0] * (PQ[c0] * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * delta[c1][d1] * (PQ[c0] * (-1.0))
                            + delta[a0][d0] * delta[b0][c1] * delta[b1][d1] * (PQ[c0] * (-1.0))
                            + delta[a0][d0] * delta[b0][d1] * delta[b1][c1] * (PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * delta[c1][d0] * (PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[b0][c1] * delta[b1][d0] * (PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * delta[b1][c1] * (PQ[c0] * (-1.0))
                            + delta[a0][b0] * delta[b1][c1] * delta[d0][d1] * (PQ[c0] * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * delta[c1][d1] * (PQ[c0] * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * delta[c1][d0] * (PQ[c0] * (-1.0))
                            + delta[b0][c1] * delta[a0][b1] * delta[d0][d1] * (PQ[c0] * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * delta[c1][d1] * (PQ[c0] * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * delta[c1][d0] * (PQ[c0] * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * delta[d0][d1] * (PQ[c1] * (-1.0))
                            + delta[a0][c0] * delta[b0][d0] * delta[b1][d1] * (PQ[c1] * (-1.0))
                            + delta[a0][c0] * delta[b0][d1] * delta[b1][d0] * (PQ[c1] * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][d1] * (PQ[c1] * (-1.0))
                            + delta[a0][d0] * delta[b0][c0] * delta[b1][d1] * (PQ[c1] * (-1.0))
                            + delta[a0][d0] * delta[b0][d1] * delta[b1][c0] * (PQ[c1] * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][d0] * (PQ[c1] * (-1.0))
                            + delta[a0][d1] * delta[b0][c0] * delta[b1][d0] * (PQ[c1] * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * delta[b1][c0] * (PQ[c1] * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * delta[d0][d1] * (PQ[c1] * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][d1] * (PQ[c1] * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][d0] * (PQ[c1] * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * delta[d0][d1] * (PQ[c1] * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][d1] * (PQ[c1] * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][d0] * (PQ[c1] * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d1] * (PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[b0][c1] * delta[b1][d1] * (PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[b0][d1] * delta[b1][c1] * (PQ[d0] * (-1.0))
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d1] * (PQ[d0] * (-1.0))
                            + delta[a0][c1] * delta[b0][c0] * delta[b1][d1] * (PQ[d0] * (-1.0))
                            + delta[a0][c1] * delta[b0][d1] * delta[b1][c0] * (PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][c1] * (PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[b0][c0] * delta[b1][c1] * (PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[b0][c1] * delta[b1][c0] * (PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d1] * (PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d1] * (PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][c1] * (PQ[d0] * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d1] * (PQ[d0] * (-1.0))
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d1] * (PQ[d0] * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][c1] * (PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * delta[c1][d0] * (PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[b0][c1] * delta[b1][d0] * (PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[b0][d0] * delta[b1][c1] * (PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[b0][b1] * delta[c0][d0] * (PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[b0][c0] * delta[b1][d0] * (PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[b0][d0] * delta[b1][c0] * (PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][c1] * (PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[b0][c0] * delta[b1][c1] * (PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[b0][c1] * delta[b1][c0] * (PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * delta[c1][d0] * (PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[b1][c1] * delta[c0][d0] * (PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][c1] * (PQ[d1] * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * delta[c1][d0] * (PQ[d1] * (-1.0))
                            + delta[b0][c1] * delta[a0][b1] * delta[c0][d0] * (PQ[d1] * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][c1] * (PQ[d1] * (-1.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDDD15(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[5];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[4] * (

                        0.25 * ( S1 * S1 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[b1] + PB_1 * PQ[a0] * PQ[b0] + PA_0 * PQ[b0] * PQ[b1])
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PQ[a0] * PQ[b1] + PB_1 * PQ[a0] * PQ[b0] + PA_0 * PQ[b0] * PQ[b1])
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[b1] + PB_1 * PQ[a0] * PQ[b0] + PA_0 * PQ[b0] * PQ[b1])
                            + delta[b1][c1] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[c0] + PA_0 * PQ[b0] * PQ[c0])
                            + delta[b1][d0] * delta[c1][d1] * (PB_0 * PQ[a0] * PQ[c0] + PA_0 * PQ[b0] * PQ[c0])
                            + delta[b1][d1] * delta[c1][d0] * (PB_0 * PQ[a0] * PQ[c0] + PA_0 * PQ[b0] * PQ[c0])
                            + delta[b1][c0] * delta[d0][d1] * (PB_0 * PQ[a0] * PQ[c1] + PA_0 * PQ[b0] * PQ[c1])
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[c1] + PA_0 * PQ[b0] * PQ[c1])
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * PQ[a0] * PQ[c1] + PA_0 * PQ[b0] * PQ[c1])
                            + delta[b1][c0] * delta[c1][d1] * (PB_0 * PQ[a0] * PQ[d0] + PA_0 * PQ[b0] * PQ[d0])
                            + delta[b1][c1] * delta[c0][d1] * (PB_0 * PQ[a0] * PQ[d0] + PA_0 * PQ[b0] * PQ[d0])
                            + delta[b1][d1] * delta[c0][c1] * (PB_0 * PQ[a0] * PQ[d0] + PA_0 * PQ[b0] * PQ[d0])
                            + delta[b1][c0] * delta[c1][d0] * (PB_0 * PQ[a0] * PQ[d1] + PA_0 * PQ[b0] * PQ[d1])
                            + delta[b1][c1] * delta[c0][d0] * (PB_0 * PQ[a0] * PQ[d1] + PA_0 * PQ[b0] * PQ[d1])
                            + delta[b1][d0] * delta[c0][c1] * (PB_0 * PQ[a0] * PQ[d1] + PA_0 * PQ[b0] * PQ[d1])
                            + delta[b0][c1] * delta[d0][d1] * (PB_1 * PQ[a0] * PQ[c0] + PA_0 * PQ[b1] * PQ[c0])
                            + delta[b0][d0] * delta[c1][d1] * (PB_1 * PQ[a0] * PQ[c0] + PA_0 * PQ[b1] * PQ[c0])
                            + delta[b0][d1] * delta[c1][d0] * (PB_1 * PQ[a0] * PQ[c0] + PA_0 * PQ[b1] * PQ[c0])
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * PQ[a0] * PQ[c1] + PA_0 * PQ[b1] * PQ[c1])
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * PQ[a0] * PQ[c1] + PA_0 * PQ[b1] * PQ[c1])
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * PQ[a0] * PQ[c1] + PA_0 * PQ[b1] * PQ[c1])
                            + delta[b0][c0] * delta[c1][d1] * (PB_1 * PQ[a0] * PQ[d0] + PA_0 * PQ[b1] * PQ[d0])
                            + delta[b0][c1] * delta[c0][d1] * (PB_1 * PQ[a0] * PQ[d0] + PA_0 * PQ[b1] * PQ[d0])
                            + delta[b0][d1] * delta[c0][c1] * (PB_1 * PQ[a0] * PQ[d0] + PA_0 * PQ[b1] * PQ[d0])
                            + delta[b0][c0] * delta[c1][d0] * (PB_1 * PQ[a0] * PQ[d1] + PA_0 * PQ[b1] * PQ[d1])
                            + delta[b0][c1] * delta[c0][d0] * (PB_1 * PQ[a0] * PQ[d1] + PA_0 * PQ[b1] * PQ[d1])
                            + delta[b0][d0] * delta[c0][c1] * (PB_1 * PQ[a0] * PQ[d1] + PA_0 * PQ[b1] * PQ[d1])
                            + delta[b0][b1] * delta[d0][d1] * (PQ[a0] * PQ[c0] * PQ[c1] * (-1.0) + PA_0 * PQ[c0] * PQ[c1])
                            + delta[b0][d0] * delta[b1][d1] * (PA_0 * PQ[c0] * PQ[c1])
                            + delta[b0][d1] * delta[b1][d0] * (PA_0 * PQ[c0] * PQ[c1])
                            + delta[b0][b1] * delta[c1][d1] * (PQ[a0] * PQ[c0] * PQ[d0] * (-1.0) + PA_0 * PQ[c0] * PQ[d0])
                            + delta[b0][c1] * delta[b1][d1] * (PA_0 * PQ[c0] * PQ[d0])
                            + delta[b0][d1] * delta[b1][c1] * (PA_0 * PQ[c0] * PQ[d0])
                            + delta[b0][b1] * delta[c1][d0] * (PQ[a0] * PQ[c0] * PQ[d1] * (-1.0) + PA_0 * PQ[c0] * PQ[d1])
                            + delta[b0][c1] * delta[b1][d0] * (PA_0 * PQ[c0] * PQ[d1])
                            + delta[b0][d0] * delta[b1][c1] * (PA_0 * PQ[c0] * PQ[d1])
                            + delta[b0][b1] * delta[c0][d1] * (PQ[a0] * PQ[c1] * PQ[d0] * (-1.0) + PA_0 * PQ[c1] * PQ[d0])
                            + delta[b0][c0] * delta[b1][d1] * (PA_0 * PQ[c1] * PQ[d0])
                            + delta[b0][d1] * delta[b1][c0] * (PA_0 * PQ[c1] * PQ[d0])
                            + delta[b0][b1] * delta[c0][d0] * (PQ[a0] * PQ[c1] * PQ[d1] * (-1.0) + PA_0 * PQ[c1] * PQ[d1])
                            + delta[b0][c0] * delta[b1][d0] * (PA_0 * PQ[c1] * PQ[d1])
                            + delta[b0][d0] * delta[b1][c0] * (PA_0 * PQ[c1] * PQ[d1])
                            + delta[b0][b1] * delta[c0][c1] * (PQ[a0] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[d0] * PQ[d1])
                            + delta[b0][c0] * delta[b1][c1] * (PA_0 * PQ[d0] * PQ[d1])
                            + delta[b0][c1] * delta[b1][c0] * (PA_0 * PQ[d0] * PQ[d1])
                            + delta[a0][b1] * delta[d0][d1] * (PQ[b0] * PQ[c0] * PQ[c1] * (-1.0) + PB_0 * PQ[c0] * PQ[c1])
                            + delta[a0][b1] * delta[c1][d1] * (PQ[b0] * PQ[c0] * PQ[d0] * (-1.0) + PB_0 * PQ[c0] * PQ[d0])
                            + delta[a0][b1] * delta[c1][d0] * (PQ[b0] * PQ[c0] * PQ[d1] * (-1.0) + PB_0 * PQ[c0] * PQ[d1])
                            + delta[a0][b1] * delta[c0][d1] * (PQ[b0] * PQ[c1] * PQ[d0] * (-1.0) + PB_0 * PQ[c1] * PQ[d0])
                            + delta[a0][b1] * delta[c0][d0] * (PQ[b0] * PQ[c1] * PQ[d1] * (-1.0) + PB_0 * PQ[c1] * PQ[d1])
                            + delta[a0][b1] * delta[c0][c1] * (PQ[b0] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * delta[d0][d1] * (PQ[b1] * PQ[c0] * PQ[c1] * (-1.0) + PB_1 * PQ[c0] * PQ[c1])
                            + delta[a0][b0] * delta[c1][d1] * (PQ[b1] * PQ[c0] * PQ[d0] * (-1.0) + PB_1 * PQ[c0] * PQ[d0])
                            + delta[a0][b0] * delta[c1][d0] * (PQ[b1] * PQ[c0] * PQ[d1] * (-1.0) + PB_1 * PQ[c0] * PQ[d1])
                            + delta[a0][b0] * delta[c0][d1] * (PQ[b1] * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PQ[c1] * PQ[d0])
                            + delta[a0][b0] * delta[c0][d0] * (PQ[b1] * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PQ[c1] * PQ[d1])
                            + delta[a0][b0] * delta[c0][c1] * (PQ[b1] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * delta[b0][b1] * (PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * (PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * (PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * (PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * (PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * (PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[b0][b1] * (PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[b1][c1] * (PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][c1] * delta[a0][b1] * (PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * (PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * (PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * (PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[d0][d1] * (PB_0 * PQ[b1] * PQ[c0] + PB_1 * PQ[b0] * PQ[c0])
                            + delta[a0][d0] * delta[c1][d1] * (PB_0 * PQ[b1] * PQ[c0] + PB_1 * PQ[b0] * PQ[c0])
                            + delta[a0][d1] * delta[c1][d0] * (PB_0 * PQ[b1] * PQ[c0] + PB_1 * PQ[b0] * PQ[c0])
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * PQ[b1] * PQ[c1] + PB_1 * PQ[b0] * PQ[c1])
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * PQ[b1] * PQ[c1] + PB_1 * PQ[b0] * PQ[c1])
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * PQ[b1] * PQ[c1] + PB_1 * PQ[b0] * PQ[c1])
                            + delta[a0][c0] * delta[c1][d1] * (PB_0 * PQ[b1] * PQ[d0] + PB_1 * PQ[b0] * PQ[d0])
                            + delta[a0][c1] * delta[c0][d1] * (PB_0 * PQ[b1] * PQ[d0] + PB_1 * PQ[b0] * PQ[d0])
                            + delta[a0][d1] * delta[c0][c1] * (PB_0 * PQ[b1] * PQ[d0] + PB_1 * PQ[b0] * PQ[d0])
                            + delta[a0][c0] * delta[c1][d0] * (PB_0 * PQ[b1] * PQ[d1] + PB_1 * PQ[b0] * PQ[d1])
                            + delta[a0][c1] * delta[c0][d0] * (PB_0 * PQ[b1] * PQ[d1] + PB_1 * PQ[b0] * PQ[d1])
                            + delta[a0][d0] * delta[c0][c1] * (PB_0 * PQ[b1] * PQ[d1] + PB_1 * PQ[b0] * PQ[d1])
                            + delta[a0][d0] * delta[b1][d1] * (PB_0 * PQ[c0] * PQ[c1])
                            + delta[a0][d1] * delta[b1][d0] * (PB_0 * PQ[c0] * PQ[c1])
                            + delta[a0][c1] * delta[b1][d1] * (PB_0 * PQ[c0] * PQ[d0])
                            + delta[a0][d1] * delta[b1][c1] * (PB_0 * PQ[c0] * PQ[d0])
                            + delta[a0][c1] * delta[b1][d0] * (PB_0 * PQ[c0] * PQ[d1])
                            + delta[a0][d0] * delta[b1][c1] * (PB_0 * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * delta[b1][d1] * (PB_0 * PQ[c1] * PQ[d0])
                            + delta[a0][d1] * delta[b1][c0] * (PB_0 * PQ[c1] * PQ[d0])
                            + delta[a0][c0] * delta[b1][d0] * (PB_0 * PQ[c1] * PQ[d1])
                            + delta[a0][d0] * delta[b1][c0] * (PB_0 * PQ[c1] * PQ[d1])
                            + delta[a0][c0] * delta[b1][c1] * (PB_0 * PQ[d0] * PQ[d1])
                            + delta[a0][c1] * delta[b1][c0] * (PB_0 * PQ[d0] * PQ[d1])
                            + delta[a0][d0] * delta[b0][d1] * (PB_1 * PQ[c0] * PQ[c1])
                            + delta[a0][d1] * delta[b0][d0] * (PB_1 * PQ[c0] * PQ[c1])
                            + delta[a0][c1] * delta[b0][d1] * (PB_1 * PQ[c0] * PQ[d0])
                            + delta[a0][d1] * delta[b0][c1] * (PB_1 * PQ[c0] * PQ[d0])
                            + delta[a0][c1] * delta[b0][d0] * (PB_1 * PQ[c0] * PQ[d1])
                            + delta[a0][d0] * delta[b0][c1] * (PB_1 * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * delta[b0][d1] * (PB_1 * PQ[c1] * PQ[d0])
                            + delta[a0][d1] * delta[b0][c0] * (PB_1 * PQ[c1] * PQ[d0])
                            + delta[a0][c0] * delta[b0][d0] * (PB_1 * PQ[c1] * PQ[d1])
                            + delta[a0][d0] * delta[b0][c0] * (PB_1 * PQ[c1] * PQ[d1])
                            + delta[a0][c0] * delta[b0][c1] * (PB_1 * PQ[d0] * PQ[d1])
                            + delta[a0][c1] * delta[b0][c0] * (PB_1 * PQ[d0] * PQ[d1])
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDDD16(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[5];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[4] * (

                        0.25 * ( S1 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * (-2.0))
                            + delta[c0][d0] * delta[c1][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * (-2.0))
                            + delta[c1][d0] * delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * (-2.0))
                            + delta[b1][c1] * delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * (-1.0) + PQ[a0] * PQ[b0] * QC_0 * (-1.0))
                            + delta[b1][d0] * delta[c1][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * (-1.0) + PQ[a0] * PQ[b0] * QC_0 * (-1.0))
                            + delta[b1][d1] * delta[c1][d0] * (PQ[a0] * PQ[b0] * PQ[c0] * (-1.0) + PQ[a0] * PQ[b0] * QC_0 * (-1.0))
                            + delta[b1][c0] * delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[c1] * (-1.0) + PQ[a0] * PQ[b0] * QC_1 * (-1.0))
                            + delta[b1][d0] * delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[c1] * (-1.0) + PQ[a0] * PQ[b0] * QC_1 * (-1.0))
                            + delta[b1][d1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[c1] * (-1.0) + PQ[a0] * PQ[b0] * QC_1 * (-1.0))
                            + delta[b1][c0] * delta[c1][d1] * (PQ[a0] * PQ[b0] * PQ[d0] * (-1.0) + PQ[a0] * PQ[b0] * QD_0 * (-1.0))
                            + delta[b1][c1] * delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[d0] * (-1.0) + PQ[a0] * PQ[b0] * QD_0 * (-1.0))
                            + delta[b1][d1] * delta[c0][c1] * (PQ[a0] * PQ[b0] * PQ[d0] * (-1.0) + PQ[a0] * PQ[b0] * QD_0 * (-1.0))
                            + delta[b1][c0] * delta[c1][d0] * (PQ[a0] * PQ[b0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[b0] * QD_1 * (-1.0))
                            + delta[b1][c1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[b0] * QD_1 * (-1.0))
                            + delta[b1][d0] * delta[c0][c1] * (PQ[a0] * PQ[b0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[b0] * QD_1 * (-1.0))
                            + delta[b0][c1] * delta[d0][d1] * (PQ[a0] * PQ[b1] * PQ[c0] * (-1.0) + PQ[a0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[c1][d1] * (PQ[a0] * PQ[b1] * PQ[c0] * (-1.0) + PQ[a0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[c1][d0] * (PQ[a0] * PQ[b1] * PQ[c0] * (-1.0) + PQ[a0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[b0][c0] * delta[d0][d1] * (PQ[a0] * PQ[b1] * PQ[c1] * (-1.0) + PQ[a0] * PQ[b1] * QC_1 * (-1.0))
                            + delta[b0][d0] * delta[c0][d1] * (PQ[a0] * PQ[b1] * PQ[c1] * (-1.0) + PQ[a0] * PQ[b1] * QC_1 * (-1.0))
                            + delta[b0][d1] * delta[c0][d0] * (PQ[a0] * PQ[b1] * PQ[c1] * (-1.0) + PQ[a0] * PQ[b1] * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[c1][d1] * (PQ[a0] * PQ[b1] * PQ[d0] * (-1.0) + PQ[a0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[b0][c1] * delta[c0][d1] * (PQ[a0] * PQ[b1] * PQ[d0] * (-1.0) + PQ[a0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[b0][d1] * delta[c0][c1] * (PQ[a0] * PQ[b1] * PQ[d0] * (-1.0) + PQ[a0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[b0][c0] * delta[c1][d0] * (PQ[a0] * PQ[b1] * PQ[d1] * (-1.0) + PQ[a0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[b0][c1] * delta[c0][d0] * (PQ[a0] * PQ[b1] * PQ[d1] * (-1.0) + PQ[a0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[b0][d0] * delta[c0][c1] * (PQ[a0] * PQ[b1] * PQ[d1] * (-1.0) + PQ[a0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[b0][b1] * delta[d0][d1] * (PQ[a0] * PQ[c0] * PQ[c1] * (-1.0) + PQ[a0] * PQ[c0] * QC_1 * (-1.0) + PQ[a0] * PQ[c1] * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c1][d1] * (PQ[a0] * PQ[c0] * PQ[d0] * (-1.0) + PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c1][d0] * (PQ[a0] * PQ[c0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[b1][d1] * (PQ[a0] * PQ[c0] * QC_1 * (-1.0) + PQ[a0] * PQ[c1] * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[b1][d0] * (PQ[a0] * PQ[c0] * QC_1 * (-1.0) + PQ[a0] * PQ[c1] * QC_0 * (-1.0))
                            + delta[b0][c1] * delta[b1][d1] * (PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[b1][c1] * (PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][c1] * delta[b1][d0] * (PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[b1][c1] * (PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c0][d1] * (PQ[a0] * PQ[c1] * PQ[d0] * (-1.0) + PQ[a0] * PQ[c1] * QD_0 * (-1.0) + PQ[a0] * PQ[d0] * QC_1 * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * (PQ[a0] * PQ[c1] * PQ[d1] * (-1.0) + PQ[a0] * PQ[c1] * QD_1 * (-1.0) + PQ[a0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[b1][d1] * (PQ[a0] * PQ[c1] * QD_0 * (-1.0) + PQ[a0] * PQ[d0] * QC_1 * (-1.0))
                            + delta[b0][d1] * delta[b1][c0] * (PQ[a0] * PQ[c1] * QD_0 * (-1.0) + PQ[a0] * PQ[d0] * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[b1][d0] * (PQ[a0] * PQ[c1] * QD_1 * (-1.0) + PQ[a0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[b0][d0] * delta[b1][c0] * (PQ[a0] * PQ[c1] * QD_1 * (-1.0) + PQ[a0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[b0][b1] * delta[c0][c1] * (PQ[a0] * PQ[d0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][c0] * delta[b1][c1] * (PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][c1] * delta[b1][c0] * (PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[d0][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * (-1.0) + PQ[b0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[c1][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * (-1.0) + PQ[b0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[c1][d0] * (PQ[b0] * PQ[b1] * PQ[c0] * (-1.0) + PQ[b0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[d0][d1] * (PQ[b0] * PQ[b1] * PQ[c1] * (-1.0) + PQ[b0] * PQ[b1] * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[c0][d1] * (PQ[b0] * PQ[b1] * PQ[c1] * (-1.0) + PQ[b0] * PQ[b1] * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[c0][d0] * (PQ[b0] * PQ[b1] * PQ[c1] * (-1.0) + PQ[b0] * PQ[b1] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[c1][d1] * (PQ[b0] * PQ[b1] * PQ[d0] * (-1.0) + PQ[b0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[c0][d1] * (PQ[b0] * PQ[b1] * PQ[d0] * (-1.0) + PQ[b0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[a0][d1] * delta[c0][c1] * (PQ[b0] * PQ[b1] * PQ[d0] * (-1.0) + PQ[b0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[a0][c0] * delta[c1][d0] * (PQ[b0] * PQ[b1] * PQ[d1] * (-1.0) + PQ[b0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[a0][c1] * delta[c0][d0] * (PQ[b0] * PQ[b1] * PQ[d1] * (-1.0) + PQ[b0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[a0][d0] * delta[c0][c1] * (PQ[b0] * PQ[b1] * PQ[d1] * (-1.0) + PQ[b0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[a0][b1] * delta[d0][d1] * (PQ[b0] * PQ[c0] * PQ[c1] * (-1.0) + PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][b1] * delta[c1][d1] * (PQ[b0] * PQ[c0] * PQ[d0] * (-1.0) + PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PQ[b0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][b1] * delta[c1][d0] * (PQ[b0] * PQ[c0] * PQ[d1] * (-1.0) + PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PQ[b0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b1][d1] * (PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b1][d0] * (PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b1][d1] * (PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PQ[b0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b1][c1] * (PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PQ[b0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b1][d0] * (PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PQ[b0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b1][c1] * (PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PQ[b0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][b1] * delta[c0][d1] * (PQ[b0] * PQ[c1] * PQ[d0] * (-1.0) + PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PQ[b0] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][b1] * delta[c0][d0] * (PQ[b0] * PQ[c1] * PQ[d1] * (-1.0) + PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PQ[b0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[b1][d1] * (PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PQ[b0] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[b1][c0] * (PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PQ[b0] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[b1][d0] * (PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PQ[b0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[b1][c0] * (PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PQ[b0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][b1] * delta[c0][c1] * (PQ[b0] * PQ[d0] * PQ[d1] * (-1.0) + PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c0] * delta[b1][c1] * (PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[b1][c0] * (PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PQ[b1] * PQ[c0] * PQ[c1] * (-1.0) + PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PQ[b1] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c1][d1] * (PQ[b1] * PQ[c0] * PQ[d0] * (-1.0) + PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[b1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c1][d0] * (PQ[b1] * PQ[c0] * PQ[d1] * (-1.0) + PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[b1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b0][d1] * (PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PQ[b1] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * (PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PQ[b1] * PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][d1] * (PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[b1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][c1] * (PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[b1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][d0] * (PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[b1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b0][c1] * (PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[b1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c0][d1] * (PQ[b1] * PQ[c1] * PQ[d0] * (-1.0) + PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PQ[b1] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (PQ[b1] * PQ[c1] * PQ[d1] * (-1.0) + PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PQ[b1] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[b0][d1] * (PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PQ[b1] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[b0][c0] * (PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PQ[b1] * PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[b0][d0] * (PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PQ[b1] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][c0] * (PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PQ[b1] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[c0][c1] * (PQ[b1] * PQ[d0] * PQ[d1] * (-1.0) + PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[b1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c0] * delta[b0][c1] * (PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[b1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][c0] * (PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[b1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * (PQ[c0] * PQ[c1] * QD_0 * (-1.0) + PQ[c0] * PQ[d0] * QC_1 * (-1.0) + PQ[c1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * (PQ[c0] * PQ[c1] * QD_0 * (-1.0) + PQ[c0] * PQ[d0] * QC_1 * (-1.0) + PQ[c1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * (PQ[c0] * PQ[c1] * QD_0 * (-1.0) + PQ[c0] * PQ[d0] * QC_1 * (-1.0) + PQ[c1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * (PQ[c0] * PQ[c1] * QD_1 * (-1.0) + PQ[c0] * PQ[d1] * QC_1 * (-1.0) + PQ[c1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * (PQ[c0] * PQ[c1] * QD_1 * (-1.0) + PQ[c0] * PQ[d1] * QC_1 * (-1.0) + PQ[c1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * (PQ[c0] * PQ[c1] * QD_1 * (-1.0) + PQ[c0] * PQ[d1] * QC_1 * (-1.0) + PQ[c1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][b1] * (PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][c1] * (PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][c1] * delta[a0][b1] * (PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * (PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[d0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * (PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[d0] * PQ[d1] * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * (PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[d0] * PQ[d1] * QC_1 * (-1.0))
                        )

                    )

                    +

                    F7_t[4] * (

                        0.5 * ( S1 * S1 * S1 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[c1] * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[c1] * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * (-1.0))
                            + delta[c1][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[d0] * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[c1][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[c1] * PQ[d0] * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[c0][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[c1] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[c0][c1] * (PB_0 * PB_1 * PQ[a0] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b1][d1] * (PB_0 * PA_0 * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[b1][d0] * (PB_0 * PA_0 * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[b1][c1] * (PB_0 * PA_0 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b1][c0] * (PB_0 * PA_0 * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][d1] * (PB_1 * PA_0 * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PB_1 * PA_0 * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[b0][c1] * (PB_1 * PA_0 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][c0] * (PB_1 * PA_0 * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][b1] * (PA_0 * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * (PB_0 * PB_1 * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][d0] * (PB_0 * PB_1 * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * (PB_0 * PB_1 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * (PB_0 * PB_1 * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b1] * (PB_0 * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * (PB_1 * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDDD17(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[5];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[4] * (

                        0.5 * ( S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] + PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * QC_1 + PB_0 * PQ[a0] * PQ[b1] * PQ[c1] * QC_0 + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * QC_1 + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] * QC_0 + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * QC_1 + PA_0 * PQ[b0] * PQ[b1] * PQ[c1] * QC_0)
                            + delta[c1][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] + PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * QD_0 + PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * QC_0 + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * QD_0 + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * QC_0 + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * QC_0)
                            + delta[c1][d0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d1] + PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * QD_1 + PB_0 * PQ[a0] * PQ[b1] * PQ[d1] * QC_0 + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1] + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * QD_1 + PB_1 * PQ[a0] * PQ[b0] * PQ[d1] * QC_0 + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * QD_1 + PA_0 * PQ[b0] * PQ[b1] * PQ[d1] * QC_0)
                            + delta[c0][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c1] * PQ[d0] + PB_0 * PQ[a0] * PQ[b1] * PQ[c1] * QD_0 + PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * QC_1 + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] * QD_0 + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * QC_1 + PA_0 * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] + PA_0 * PQ[b0] * PQ[b1] * PQ[c1] * QD_0 + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * QC_1)
                            + delta[c0][d0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c1] * PQ[d1] + PB_0 * PQ[a0] * PQ[b1] * PQ[c1] * QD_1 + PB_0 * PQ[a0] * PQ[b1] * PQ[d1] * QC_1 + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] * PQ[d1] + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] * QD_1 + PB_1 * PQ[a0] * PQ[b0] * PQ[d1] * QC_1 + PA_0 * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] + PA_0 * PQ[b0] * PQ[b1] * PQ[c1] * QD_1 + PA_0 * PQ[b0] * PQ[b1] * PQ[d1] * QC_1)
                            + delta[c0][c1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1] + PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * QD_1 + PB_0 * PQ[a0] * PQ[b1] * PQ[d1] * QD_0 + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1] + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * QD_1 + PB_1 * PQ[a0] * PQ[b0] * PQ[d1] * QD_0 + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 + PA_0 * PQ[b0] * PQ[b1] * PQ[d1] * QD_0)
                            + delta[b1][d1] * (PB_0 * PQ[a0] * PQ[c0] * PQ[c1] * QD_0 + PB_0 * PQ[a0] * PQ[c0] * PQ[d0] * QC_1 + PB_0 * PQ[a0] * PQ[c1] * PQ[d0] * QC_0 + PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 + PA_0 * PQ[b0] * PQ[c0] * PQ[d0] * QC_1 + PA_0 * PQ[b0] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[b1][d0] * (PB_0 * PQ[a0] * PQ[c0] * PQ[c1] * QD_1 + PB_0 * PQ[a0] * PQ[c0] * PQ[d1] * QC_1 + PB_0 * PQ[a0] * PQ[c1] * PQ[d1] * QC_0 + PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * QD_1 + PA_0 * PQ[b0] * PQ[c0] * PQ[d1] * QC_1 + PA_0 * PQ[b0] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[b1][c1] * (PB_0 * PQ[a0] * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PQ[a0] * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PQ[a0] * PQ[d0] * PQ[d1] * QC_0 + PA_0 * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 + PA_0 * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 + PA_0 * PQ[b0] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[b1][c0] * (PB_0 * PQ[a0] * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PQ[a0] * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PQ[a0] * PQ[d0] * PQ[d1] * QC_1 + PA_0 * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 + PA_0 * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 + PA_0 * PQ[b0] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[b0][d1] * (PB_1 * PQ[a0] * PQ[c0] * PQ[c1] * QD_0 + PB_1 * PQ[a0] * PQ[c0] * PQ[d0] * QC_1 + PB_1 * PQ[a0] * PQ[c1] * PQ[d0] * QC_0 + PA_0 * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 + PA_0 * PQ[b1] * PQ[c0] * PQ[d0] * QC_1 + PA_0 * PQ[b1] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[b0][d0] * (PB_1 * PQ[a0] * PQ[c0] * PQ[c1] * QD_1 + PB_1 * PQ[a0] * PQ[c0] * PQ[d1] * QC_1 + PB_1 * PQ[a0] * PQ[c1] * PQ[d1] * QC_0 + PA_0 * PQ[b1] * PQ[c0] * PQ[c1] * QD_1 + PA_0 * PQ[b1] * PQ[c0] * PQ[d1] * QC_1 + PA_0 * PQ[b1] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[b0][c1] * (PB_1 * PQ[a0] * PQ[c0] * PQ[d0] * QD_1 + PB_1 * PQ[a0] * PQ[c0] * PQ[d1] * QD_0 + PB_1 * PQ[a0] * PQ[d0] * PQ[d1] * QC_0 + PA_0 * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 + PA_0 * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 + PA_0 * PQ[b1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[b0][c0] * (PB_1 * PQ[a0] * PQ[c1] * PQ[d0] * QD_1 + PB_1 * PQ[a0] * PQ[c1] * PQ[d1] * QD_0 + PB_1 * PQ[a0] * PQ[d0] * PQ[d1] * QC_1 + PA_0 * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 + PA_0 * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 + PA_0 * PQ[b1] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[b0][b1] * (PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[a0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PA_0 * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PA_0 * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PA_0 * PQ[c1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][d1] * (PB_0 * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 + PB_0 * PQ[b1] * PQ[c0] * PQ[d0] * QC_1 + PB_0 * PQ[b1] * PQ[c1] * PQ[d0] * QC_0 + PB_1 * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 + PB_1 * PQ[b0] * PQ[c0] * PQ[d0] * QC_1 + PB_1 * PQ[b0] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a0][d0] * (PB_0 * PQ[b1] * PQ[c0] * PQ[c1] * QD_1 + PB_0 * PQ[b1] * PQ[c0] * PQ[d1] * QC_1 + PB_0 * PQ[b1] * PQ[c1] * PQ[d1] * QC_0 + PB_1 * PQ[b0] * PQ[c0] * PQ[c1] * QD_1 + PB_1 * PQ[b0] * PQ[c0] * PQ[d1] * QC_1 + PB_1 * PQ[b0] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a0][c1] * (PB_0 * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 + PB_1 * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 + PB_1 * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 + PB_1 * PQ[b0] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][c0] * (PB_0 * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PQ[b1] * PQ[d0] * PQ[d1] * QC_1 + PB_1 * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 + PB_1 * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 + PB_1 * PQ[b0] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a0][b1] * (PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PB_0 * PQ[c1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][b0] * (PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PB_1 * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PB_1 * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PB_1 * PQ[c1] * PQ[d0] * PQ[d1] * QC_0)
                        )

                    )

                    +

                    F7_t[4] * (

                        0.5 * ( S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * QC_0 * QC_1 * (-1.0))
                            + delta[c1][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * QC_0 * (-1.0))
                            + delta[c1][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * QD_1 * QC_0 * (-1.0))
                            + delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * QC_1 * (-1.0))
                            + delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * QD_1 * QC_1 * (-1.0))
                            + delta[c0][c1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * QD_1 * (-1.0))
                            + delta[b1][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[b1][d0] * (PQ[a0] * PQ[b0] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[b1][c1] * (PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[b1][c0] * (PQ[a0] * PQ[b0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[b0][d1] * (PQ[a0] * PQ[b1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][d0] * (PQ[a0] * PQ[b1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][c1] * (PQ[a0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[b0][c0] * (PQ[a0] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[b0][b1] * (PQ[a0] * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PQ[a0] * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PQ[a0] * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][d0] * (PQ[b0] * PQ[b1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][c1] * (PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][c0] * (PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[a0][b1] * (PQ[b0] * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[b0] * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * (PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDDD18(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[6];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 5, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[5] * (

                        ( S1 * S1 * S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                            + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                            + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                        )

                    )

                    +

                    F7_t[5] * (

                        ( S1 * S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                        )

                    )

                    +

                    F7_t[5] * (

                        ( S1 * S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                        )

                    )

                    +

                    F7_t[5] * (

                        0.5 * ( S1 * S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * (-1.0))
                            + delta[c1][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[c1][d0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[c0][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[c0][d0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c1] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[c0][c1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b1][d1] * (PB_0 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[b1][d0] * (PB_0 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[b1][c1] * (PB_0 * PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b1][c0] * (PB_0 * PQ[a0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][d1] * (PB_1 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PB_1 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[b0][c1] * (PB_1 * PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][c0] * (PB_1 * PQ[a0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][b1] * (PA_0 * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * (PB_0 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][d0] * (PB_0 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * (PB_0 * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * (PB_0 * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b1] * (PB_0 * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * (PB_1 * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0) + PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                        )

                    )

                    +

                    F7_t[5] * (

                        0.5 * ( S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * QC_1 + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * QC_0)
                            + delta[c1][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * QC_0)
                            + delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * QD_0 + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * QC_1)
                            + delta[c1][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * QD_1 + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * QC_0)
                            + delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * QD_1 + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * QC_1)
                            + delta[b1][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 + PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * QC_1 + PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[b1][d0] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * QD_1 + PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1] * QC_1 + PQ[a0] * PQ[b0] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[b1][c1] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 + PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 + PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[b1][c0] * (PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 + PQ[a0] * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 + PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[b0][d1] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 + PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * QC_1 + PQ[a0] * PQ[b1] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[b0][d0] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_1 + PQ[a0] * PQ[b1] * PQ[c0] * PQ[d1] * QC_1 + PQ[a0] * PQ[b1] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[b0][c1] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 + PQ[a0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 + PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[b0][c0] * (PQ[a0] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 + PQ[a0] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 + PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[b0][b1] * (PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PQ[a0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PQ[a0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 + PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QC_1 + PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a0][d0] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_1 + PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QC_1 + PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a0][c1] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 + PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 + PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][c0] * (PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 + PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 + PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a0][b1] * (PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][b0] * (PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[c0][c1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * QD_0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDDD19(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F7_t[8];

            gpu::computeBoysFunction(F7_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 7, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F7_t[5] * (

                        0.25 * ( S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[b1])
                            + delta[c0][d0] * delta[c1][d1] * (PQ[a0] * PQ[b0] * PQ[b1])
                            + delta[c1][d0] * delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[b1])
                            + delta[b1][c1] * delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[c0])
                            + delta[b1][d0] * delta[c1][d1] * (PQ[a0] * PQ[b0] * PQ[c0])
                            + delta[b1][d1] * delta[c1][d0] * (PQ[a0] * PQ[b0] * PQ[c0])
                            + delta[b1][c0] * delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[c1])
                            + delta[b1][d0] * delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[c1])
                            + delta[b1][d1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[c1])
                            + delta[b1][c0] * delta[c1][d1] * (PQ[a0] * PQ[b0] * PQ[d0])
                            + delta[b1][c1] * delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[d0])
                            + delta[b1][d1] * delta[c0][c1] * (PQ[a0] * PQ[b0] * PQ[d0])
                            + delta[b1][c0] * delta[c1][d0] * (PQ[a0] * PQ[b0] * PQ[d1])
                            + delta[b1][c1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[d1])
                            + delta[b1][d0] * delta[c0][c1] * (PQ[a0] * PQ[b0] * PQ[d1])
                            + delta[b0][c1] * delta[d0][d1] * (PQ[a0] * PQ[b1] * PQ[c0])
                            + delta[b0][d0] * delta[c1][d1] * (PQ[a0] * PQ[b1] * PQ[c0])
                            + delta[b0][d1] * delta[c1][d0] * (PQ[a0] * PQ[b1] * PQ[c0])
                            + delta[b0][c0] * delta[d0][d1] * (PQ[a0] * PQ[b1] * PQ[c1])
                            + delta[b0][d0] * delta[c0][d1] * (PQ[a0] * PQ[b1] * PQ[c1])
                            + delta[b0][d1] * delta[c0][d0] * (PQ[a0] * PQ[b1] * PQ[c1])
                            + delta[b0][c0] * delta[c1][d1] * (PQ[a0] * PQ[b1] * PQ[d0])
                            + delta[b0][c1] * delta[c0][d1] * (PQ[a0] * PQ[b1] * PQ[d0])
                            + delta[b0][d1] * delta[c0][c1] * (PQ[a0] * PQ[b1] * PQ[d0])
                            + delta[b0][c0] * delta[c1][d0] * (PQ[a0] * PQ[b1] * PQ[d1])
                            + delta[b0][c1] * delta[c0][d0] * (PQ[a0] * PQ[b1] * PQ[d1])
                            + delta[b0][d0] * delta[c0][c1] * (PQ[a0] * PQ[b1] * PQ[d1])
                            + delta[b0][b1] * delta[d0][d1] * (PQ[a0] * PQ[c0] * PQ[c1])
                            + delta[b0][d0] * delta[b1][d1] * (PQ[a0] * PQ[c0] * PQ[c1])
                            + delta[b0][d1] * delta[b1][d0] * (PQ[a0] * PQ[c0] * PQ[c1])
                            + delta[b0][b1] * delta[c1][d1] * (PQ[a0] * PQ[c0] * PQ[d0])
                            + delta[b0][c1] * delta[b1][d1] * (PQ[a0] * PQ[c0] * PQ[d0])
                            + delta[b0][d1] * delta[b1][c1] * (PQ[a0] * PQ[c0] * PQ[d0])
                            + delta[b0][b1] * delta[c1][d0] * (PQ[a0] * PQ[c0] * PQ[d1])
                            + delta[b0][c1] * delta[b1][d0] * (PQ[a0] * PQ[c0] * PQ[d1])
                            + delta[b0][d0] * delta[b1][c1] * (PQ[a0] * PQ[c0] * PQ[d1])
                            + delta[b0][b1] * delta[c0][d1] * (PQ[a0] * PQ[c1] * PQ[d0])
                            + delta[b0][c0] * delta[b1][d1] * (PQ[a0] * PQ[c1] * PQ[d0])
                            + delta[b0][d1] * delta[b1][c0] * (PQ[a0] * PQ[c1] * PQ[d0])
                            + delta[b0][b1] * delta[c0][d0] * (PQ[a0] * PQ[c1] * PQ[d1])
                            + delta[b0][c0] * delta[b1][d0] * (PQ[a0] * PQ[c1] * PQ[d1])
                            + delta[b0][d0] * delta[b1][c0] * (PQ[a0] * PQ[c1] * PQ[d1])
                            + delta[b0][b1] * delta[c0][c1] * (PQ[a0] * PQ[d0] * PQ[d1])
                            + delta[b0][c0] * delta[b1][c1] * (PQ[a0] * PQ[d0] * PQ[d1])
                            + delta[b0][c1] * delta[b1][c0] * (PQ[a0] * PQ[d0] * PQ[d1])
                            + delta[a0][c1] * delta[d0][d1] * (PQ[b0] * PQ[b1] * PQ[c0])
                            + delta[a0][d0] * delta[c1][d1] * (PQ[b0] * PQ[b1] * PQ[c0])
                            + delta[a0][d1] * delta[c1][d0] * (PQ[b0] * PQ[b1] * PQ[c0])
                            + delta[a0][c0] * delta[d0][d1] * (PQ[b0] * PQ[b1] * PQ[c1])
                            + delta[a0][d0] * delta[c0][d1] * (PQ[b0] * PQ[b1] * PQ[c1])
                            + delta[a0][d1] * delta[c0][d0] * (PQ[b0] * PQ[b1] * PQ[c1])
                            + delta[a0][c0] * delta[c1][d1] * (PQ[b0] * PQ[b1] * PQ[d0])
                            + delta[a0][c1] * delta[c0][d1] * (PQ[b0] * PQ[b1] * PQ[d0])
                            + delta[a0][d1] * delta[c0][c1] * (PQ[b0] * PQ[b1] * PQ[d0])
                            + delta[a0][c0] * delta[c1][d0] * (PQ[b0] * PQ[b1] * PQ[d1])
                            + delta[a0][c1] * delta[c0][d0] * (PQ[b0] * PQ[b1] * PQ[d1])
                            + delta[a0][d0] * delta[c0][c1] * (PQ[b0] * PQ[b1] * PQ[d1])
                            + delta[a0][d0] * delta[b1][d1] * (PQ[b0] * PQ[c0] * PQ[c1])
                            + delta[a0][d1] * delta[b1][d0] * (PQ[b0] * PQ[c0] * PQ[c1])
                            + delta[a0][b1] * delta[d0][d1] * (PQ[b0] * PQ[c0] * PQ[c1])
                            + delta[a0][c1] * delta[b1][d1] * (PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a0][d1] * delta[b1][c1] * (PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a0][b1] * delta[c1][d1] * (PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a0][c1] * delta[b1][d0] * (PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[a0][d0] * delta[b1][c1] * (PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[a0][b1] * delta[c1][d0] * (PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * delta[b1][d1] * (PQ[b0] * PQ[c1] * PQ[d0])
                            + delta[a0][d1] * delta[b1][c0] * (PQ[b0] * PQ[c1] * PQ[d0])
                            + delta[a0][b1] * delta[c0][d1] * (PQ[b0] * PQ[c1] * PQ[d0])
                            + delta[a0][c0] * delta[b1][d0] * (PQ[b0] * PQ[c1] * PQ[d1])
                            + delta[a0][d0] * delta[b1][c0] * (PQ[b0] * PQ[c1] * PQ[d1])
                            + delta[a0][b1] * delta[c0][d0] * (PQ[b0] * PQ[c1] * PQ[d1])
                            + delta[a0][c0] * delta[b1][c1] * (PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a0][c1] * delta[b1][c0] * (PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a0][b1] * delta[c0][c1] * (PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a0][d0] * delta[b0][d1] * (PQ[b1] * PQ[c0] * PQ[c1])
                            + delta[a0][d1] * delta[b0][d0] * (PQ[b1] * PQ[c0] * PQ[c1])
                            + delta[a0][b0] * delta[d0][d1] * (PQ[b1] * PQ[c0] * PQ[c1])
                            + delta[a0][c1] * delta[b0][d1] * (PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a0][d1] * delta[b0][c1] * (PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a0][b0] * delta[c1][d1] * (PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a0][c1] * delta[b0][d0] * (PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[a0][d0] * delta[b0][c1] * (PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[a0][b0] * delta[c1][d0] * (PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * delta[b0][d1] * (PQ[b1] * PQ[c1] * PQ[d0])
                            + delta[a0][d1] * delta[b0][c0] * (PQ[b1] * PQ[c1] * PQ[d0])
                            + delta[a0][b0] * delta[c0][d1] * (PQ[b1] * PQ[c1] * PQ[d0])
                            + delta[a0][c0] * delta[b0][d0] * (PQ[b1] * PQ[c1] * PQ[d1])
                            + delta[a0][d0] * delta[b0][c0] * (PQ[b1] * PQ[c1] * PQ[d1])
                            + delta[a0][b0] * delta[c0][d0] * (PQ[b1] * PQ[c1] * PQ[d1])
                            + delta[a0][c0] * delta[b0][c1] * (PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a0][c1] * delta[b0][c0] * (PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * delta[c0][c1] * (PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * delta[b0][b1] * (PQ[c0] * PQ[c1] * PQ[d0])
                            + delta[a0][b0] * delta[b1][d1] * (PQ[c0] * PQ[c1] * PQ[d0])
                            + delta[b0][d1] * delta[a0][b1] * (PQ[c0] * PQ[c1] * PQ[d0])
                            + delta[a0][d0] * delta[b0][b1] * (PQ[c0] * PQ[c1] * PQ[d1])
                            + delta[a0][b0] * delta[b1][d0] * (PQ[c0] * PQ[c1] * PQ[d1])
                            + delta[b0][d0] * delta[a0][b1] * (PQ[c0] * PQ[c1] * PQ[d1])
                            + delta[a0][c1] * delta[b0][b1] * (PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * delta[b1][c1] * (PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[b0][c1] * delta[a0][b1] * (PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][c0] * delta[b0][b1] * (PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * delta[b1][c0] * (PQ[c1] * PQ[d0] * PQ[d1])
                            + delta[b0][c0] * delta[a0][b1] * (PQ[c1] * PQ[d0] * PQ[d1])
                        )

                    )

                    +

                    F7_t[6] * (

                        ( S1 * S1 * S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                        )

                    )

                    +

                    F7_t[6] * (

                        ( S1 * S1 * S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 * S4 ) * (
                            
                            + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                        )

                    )

                    +

                    F7_t[6] * (

                        0.5 * ( S1 * S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * (-1.0))
                            + delta[c1][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[c1][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[c0][c1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b1][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[b1][d0] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[b1][c1] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b1][c0] * (PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][d1] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[b0][c1] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][c0] * (PQ[a0] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][b1] * (PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][d0] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * (PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b1] * (PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * (PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                        )

                    )

                    +

                    F7_t[7] * (

                        ( S1 * S1 * S1 * S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDPD0(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[2];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 1, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[0] * (

                        0.25 / ( S1 * S2 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PA_0 * QC_0)
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * QD_0)
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * QD_1)
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * QC_0)
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * QC_0)
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * QD_0)
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * QD_1)
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * QD_0)
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * QD_1)
                        )

                    )

                    +

                    F6_t[0] * (

                        0.5 / S1 * (
                            delta[b0][b1] * (PA_0 * QD_0 * QD_1 * QC_0)
                            + delta[a0][b1] * (PB_0 * QD_0 * QD_1 * QC_0)
                            + delta[a0][b0] * (PB_1 * QD_0 * QD_1 * QC_0)
                        )

                    )

                    +

                    F6_t[0] * (

                        0.5 / S2 * (
                            delta[d0][d1] * (PB_0 * PB_1 * PA_0 * QC_0)
                            + delta[c0][d1] * (PB_0 * PB_1 * PA_0 * QD_0)
                            + delta[c0][d0] * (PB_0 * PB_1 * PA_0 * QD_1)
                        )

                    )

                    +

                    F6_t[0] * (

                        (
                            
                            + PB_0 * PB_1 * PA_0 * QD_0 * QD_1 * QC_0
                        )

                    )

                    +

                    F6_t[1] * (

                        0.25 / ( S1 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PA_0 * QC_0 * (-1.0) + PQ[a0] * QC_0)
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * QD_0 * (-1.0) + PQ[a0] * QD_0)
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * QD_1 * (-1.0) + PQ[a0] * QD_1)
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * QC_0 * (-1.0) + PQ[b0] * QC_0)
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * QD_0 * (-1.0) + PQ[b0] * QD_0)
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * QD_1 * (-1.0) + PQ[b0] * QD_1)
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * QC_0 * (-1.0) + PQ[b1] * QC_0)
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * QD_0 * (-1.0) + PQ[b1] * QD_0)
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * QD_1 * (-1.0) + PQ[b1] * QD_1)
                            + delta[a0][d1] * delta[b0][b1] * (QD_0 * QC_0)
                            + delta[a0][b0] * delta[b1][d1] * (QD_0 * QC_0)
                            + delta[b0][d1] * delta[a0][b1] * (QD_0 * QC_0)
                            + delta[a0][d0] * delta[b0][b1] * (QD_1 * QC_0)
                            + delta[a0][b0] * delta[b1][d0] * (QD_1 * QC_0)
                            + delta[b0][d0] * delta[a0][b1] * (QD_1 * QC_0)
                            + delta[a0][c0] * delta[b0][b1] * (QD_0 * QD_1)
                            + delta[a0][b0] * delta[b1][c0] * (QD_0 * QD_1)
                            + delta[b0][c0] * delta[a0][b1] * (QD_0 * QD_1)
                        )

                    )

                    +

                    F6_t[1] * (

                        0.25 / ( S2 * S4 ) * (
                            delta[b1][c0] * delta[d0][d1] * (PB_0 * PA_0)
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * PA_0)
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * PA_0)
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * PA_0)
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * PA_0)
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * PA_0)
                            + delta[b0][b1] * delta[d0][d1] * (PA_0 * PQ[c0] * (-1.0) + PA_0 * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * PQ[d0] * (-1.0) + PA_0 * QD_0 * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * PQ[d1] * (-1.0) + PA_0 * QD_1 * (-1.0))
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PQ[c0] * (-1.0) + PB_0 * QC_0 * (-1.0))
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * PQ[d0] * (-1.0) + PB_0 * QD_0 * (-1.0))
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PQ[d1] * (-1.0) + PB_0 * QD_1 * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PQ[c0] * (-1.0) + PB_1 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * PQ[d0] * (-1.0) + PB_1 * QD_0 * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PQ[d1] * (-1.0) + PB_1 * QD_1 * (-1.0))
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * PB_1)
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * PB_1)
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * PB_1)
                        )

                    )

                    +

                    F6_t[1] * (

                        0.5 * S1 / ( S2 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PQ[c0] * (-1.0) + PB_0 * PB_1 * PA_0 * QC_0 * (-1.0))
                            + delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PQ[d0] * (-1.0) + PB_0 * PB_1 * PA_0 * QD_0 * (-1.0))
                            + delta[c0][d0] * (PB_0 * PB_1 * PA_0 * PQ[d1] * (-1.0) + PB_0 * PB_1 * PA_0 * QD_1 * (-1.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDPD1(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[3];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[1] * (

                        0.5 * S2 / ( S1 * S4 ) * (
                            delta[b0][b1] * (PA_0 * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[a0] * QD_0 * QD_1 * QC_0)
                            + delta[a0][b1] * (PB_0 * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[b0] * QD_0 * QD_1 * QC_0)
                            + delta[a0][b0] * (PB_1 * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[b1] * QD_0 * QD_1 * QC_0)
                        )

                    )

                    +

                    F6_t[1] * (

                        0.5 / S4 * (
                            delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * QC_0 + PB_0 * PA_0 * PQ[b1] * QC_0 + PB_1 * PA_0 * PQ[b0] * QC_0)
                            + delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] * QD_0 + PB_0 * PA_0 * PQ[b1] * QD_0 + PB_1 * PA_0 * PQ[b0] * QD_0)
                            + delta[c0][d0] * (PB_0 * PB_1 * PQ[a0] * QD_1 + PB_0 * PA_0 * PQ[b1] * QD_1 + PB_1 * PA_0 * PQ[b0] * QD_1)
                            + delta[b1][d1] * (PB_0 * PA_0 * QD_0 * QC_0)
                            + delta[b1][d0] * (PB_0 * PA_0 * QD_1 * QC_0)
                            + delta[b1][c0] * (PB_0 * PA_0 * QD_0 * QD_1)
                            + delta[b0][d1] * (PB_1 * PA_0 * QD_0 * QC_0)
                            + delta[b0][d0] * (PB_1 * PA_0 * QD_1 * QC_0)
                            + delta[b0][c0] * (PB_1 * PA_0 * QD_0 * QD_1)
                            + delta[b0][b1] * (PA_0 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][d1] * (PB_0 * PB_1 * QD_0 * QC_0)
                            + delta[a0][d0] * (PB_0 * PB_1 * QD_1 * QC_0)
                            + delta[a0][b1] * (PB_0 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][b0] * (PB_1 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][c0] * (PB_0 * PB_1 * QD_0 * QD_1)
                        )

                    )

                    +

                    F6_t[1] * (

                        S1 / S4 * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PQ[d1] * QD_0 * QC_0 * (-1.0)
                        )

                    )

                    +

                    F6_t[1] * (

                        S2 / S4 * (
                            
                            + PB_0 * PB_1 * PQ[a0] * QD_0 * QD_1 * QC_0
                            + PB_0 * PA_0 * PQ[b1] * QD_0 * QD_1 * QC_0
                            + PB_1 * PA_0 * PQ[b0] * QD_0 * QD_1 * QC_0
                        )

                    )

                    +

                    F6_t[1] * (

                        0.125 / ( S1 * S2 * S4 ) * (
                            delta[a0][c0] * delta[b0][b1] * delta[d0][d1]
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][d1]
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][d0]
                            + delta[a0][b0] * delta[b1][c0] * delta[d0][d1]
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][d1]
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][d0]
                            + delta[b0][c0] * delta[a0][b1] * delta[d0][d1]
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][d1]
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][d0]
                        )

                    )

                    +

                    F6_t[2] * (

                        ( S1 * S1 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[d0] * QD_1
                            + PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[d1] * QD_0
                            + PB_0 * PB_1 * PA_0 * PQ[d0] * PQ[d1] * QC_0
                        )

                    )

                    +

                    F6_t[2] * (

                        ( S1 * S2 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PB_0 * PB_1 * PQ[a0] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PB_1 * PQ[a0] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                            + PB_0 * PA_0 * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PB_0 * PA_0 * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PA_0 * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                            + PB_1 * PA_0 * PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PB_1 * PA_0 * PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PB_1 * PA_0 * PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                        )

                    )

                    +

                    F6_t[2] * (

                        ( S2 * S2 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[b1] * QD_0 * QD_1 * QC_0
                            + PB_1 * PQ[a0] * PQ[b0] * QD_0 * QD_1 * QC_0
                            + PA_0 * PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_0
                        )

                    )

                    +

                    F6_t[2] * (

                        0.125 / ( S1 * S4 * S4 ) * (
                            delta[a0][c0] * delta[b0][b1] * delta[d0][d1] * (-1.0)
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][d1] * (-1.0)
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][d0] * (-1.0)
                            + delta[a0][b0] * delta[b1][c0] * delta[d0][d1] * (-1.0)
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][d1] * (-1.0)
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][d0] * (-1.0)
                            + delta[b0][c0] * delta[a0][b1] * delta[d0][d1] * (-1.0)
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][d1] * (-1.0)
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][d0] * (-1.0)
                        )

                    )

                    +

                    F6_t[2] * (

                        0.125 / ( S2 * S4 * S4 ) * (
                            delta[a0][c0] * delta[b0][b1] * delta[d0][d1] * (-1.0)
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][d1] * (-1.0)
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][d0] * (-1.0)
                            + delta[a0][b0] * delta[b1][c0] * delta[d0][d1] * (-1.0)
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][d1] * (-1.0)
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][d0] * (-1.0)
                            + delta[b0][c0] * delta[a0][b1] * delta[d0][d1] * (-1.0)
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][d1] * (-1.0)
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][d0] * (-1.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDPD2(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[3];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[2] * (

                        0.25 * S1 / ( S2 * S4 * S4 ) * (
                            delta[b1][c0] * delta[d0][d1] * (PB_0 * PA_0 * (-1.0))
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * PA_0 * (-1.0))
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * PA_0 * (-1.0))
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * PA_0 * (-1.0))
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * PA_0 * (-1.0))
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * PA_0 * (-1.0))
                            + delta[b0][b1] * delta[d0][d1] * (PA_0 * PQ[c0])
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * PQ[d0])
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * PQ[d1])
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * PB_1 * (-1.0))
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * PB_1 * (-1.0))
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * PB_1 * (-1.0))
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PQ[c0])
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * PQ[d0])
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PQ[d1])
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PQ[c0])
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * PQ[d0])
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PQ[d1])
                        )

                    )

                    +

                    F6_t[2] * (

                        0.25 * S2 / ( S1 * S4 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PQ[a0] * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c0][d1] * (PQ[a0] * QD_0 * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * (PQ[a0] * QD_1 * (-1.0))
                            + delta[a0][b1] * delta[d0][d1] * (PQ[b0] * QC_0 * (-1.0))
                            + delta[a0][b1] * delta[c0][d1] * (PQ[b0] * QD_0 * (-1.0))
                            + delta[a0][b1] * delta[c0][d0] * (PQ[b0] * QD_1 * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PQ[b1] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c0][d1] * (PQ[b1] * QD_0 * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (PQ[b1] * QD_1 * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * (QD_0 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * (QD_0 * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * (QD_0 * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * (QD_1 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * (QD_1 * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * (QD_1 * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * (QD_0 * QD_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * (QD_0 * QD_1 * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * (QD_0 * QD_1 * (-1.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDPD3(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[4];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[2] * (

                        0.25 / ( S4 * S4 ) * (
                            delta[b1][c0] * delta[d0][d1] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * PQ[a0] + PA_0 * PQ[b1])
                            + delta[b0][b1] * delta[d0][d1] * (PQ[a0] * PQ[c0] * (-1.0) + PQ[a0] * QC_0 * (-1.0) + PA_0 * PQ[c0] + PA_0 * QC_0)
                            + delta[b0][b1] * delta[c0][d1] * (PQ[a0] * PQ[d0] * (-1.0) + PQ[a0] * QD_0 * (-1.0) + PA_0 * PQ[d0] + PA_0 * QD_0)
                            + delta[b0][b1] * delta[c0][d0] * (PQ[a0] * PQ[d1] * (-1.0) + PQ[a0] * QD_1 * (-1.0) + PA_0 * PQ[d1] + PA_0 * QD_1)
                            + delta[b0][d0] * delta[b1][d1] * (PA_0 * QC_0)
                            + delta[b0][d1] * delta[b1][d0] * (PA_0 * QC_0)
                            + delta[b0][c0] * delta[b1][d1] * (PA_0 * QD_0)
                            + delta[b0][d1] * delta[b1][c0] * (PA_0 * QD_0)
                            + delta[b0][c0] * delta[b1][d0] * (PA_0 * QD_1)
                            + delta[b0][d0] * delta[b1][c0] * (PA_0 * QD_1)
                            + delta[a0][d0] * delta[b1][d1] * (PB_0 * QC_0)
                            + delta[a0][d1] * delta[b1][d0] * (PB_0 * QC_0)
                            + delta[a0][b1] * delta[d0][d1] * (PQ[b0] * PQ[c0] * (-1.0) + PQ[b0] * QC_0 * (-1.0) + PB_0 * PQ[c0] + PB_0 * QC_0)
                            + delta[a0][d0] * delta[b0][d1] * (PB_1 * QC_0)
                            + delta[a0][d1] * delta[b0][d0] * (PB_1 * QC_0)
                            + delta[a0][b0] * delta[d0][d1] * (PQ[b1] * PQ[c0] * (-1.0) + PQ[b1] * QC_0 * (-1.0) + PB_1 * PQ[c0] + PB_1 * QC_0)
                            + delta[a0][b1] * delta[c0][d1] * (PQ[b0] * PQ[d0] * (-1.0) + PQ[b0] * QD_0 * (-1.0) + PB_0 * PQ[d0] + PB_0 * QD_0)
                            + delta[a0][b1] * delta[c0][d0] * (PQ[b0] * PQ[d1] * (-1.0) + PQ[b0] * QD_1 * (-1.0) + PB_0 * PQ[d1] + PB_0 * QD_1)
                            + delta[a0][b0] * delta[c0][d1] * (PQ[b1] * PQ[d0] * (-1.0) + PQ[b1] * QD_0 * (-1.0) + PB_1 * PQ[d0] + PB_1 * QD_0)
                            + delta[a0][b0] * delta[c0][d0] * (PQ[b1] * PQ[d1] * (-1.0) + PQ[b1] * QD_1 * (-1.0) + PB_1 * PQ[d1] + PB_1 * QD_1)
                            + delta[a0][d1] * delta[b0][b1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[a0][c0] * delta[b1][d1] * (PB_0 * QD_0)
                            + delta[a0][d1] * delta[b1][c0] * (PB_0 * QD_0)
                            + delta[a0][c0] * delta[b1][d0] * (PB_0 * QD_1)
                            + delta[a0][d0] * delta[b1][c0] * (PB_0 * QD_1)
                            + delta[a0][c0] * delta[b0][d1] * (PB_1 * QD_0)
                            + delta[a0][d1] * delta[b0][c0] * (PB_1 * QD_0)
                            + delta[a0][c0] * delta[b0][d0] * (PB_1 * QD_1)
                            + delta[a0][d0] * delta[b0][c0] * (PB_1 * QD_1)
                        )

                    )

                    +

                    F6_t[2] * (

                        0.5 * ( S1 * S1 ) / ( S2 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PA_0 * PQ[c0])
                            + delta[c0][d1] * (PB_0 * PB_1 * PA_0 * PQ[d0])
                            + delta[c0][d0] * (PB_0 * PB_1 * PA_0 * PQ[d1])
                        )

                    )

                    +

                    F6_t[2] * (

                        0.5 * ( S2 * S2 ) / ( S1 * S4 * S4 ) * (
                            delta[b0][b1] * (PQ[a0] * QD_0 * QD_1 * QC_0 * (-1.0))
                            + delta[a0][b1] * (PQ[b0] * QD_0 * QD_1 * QC_0 * (-1.0))
                            + delta[a0][b0] * (PQ[b1] * QD_0 * QD_1 * QC_0 * (-1.0))
                        )

                    )

                    +

                    F6_t[2] * (

                        0.5 * S1 / ( S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] * (-1.0) + PB_0 * PB_1 * PQ[a0] * QC_0 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[c0] * (-1.0) + PB_0 * PA_0 * PQ[b1] * QC_0 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[c0] * (-1.0) + PB_1 * PA_0 * PQ[b0] * QC_0 * (-1.0))
                            + delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[d0] * (-1.0) + PB_0 * PB_1 * PQ[a0] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d0] * (-1.0) + PB_0 * PA_0 * PQ[b1] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d0] * (-1.0) + PB_1 * PA_0 * PQ[b0] * QD_0 * (-1.0))
                            + delta[c0][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[d1] * (-1.0) + PB_0 * PB_1 * PQ[a0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[b1] * PQ[d1] * (-1.0) + PB_0 * PA_0 * PQ[b1] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[b0] * PQ[d1] * (-1.0) + PB_1 * PA_0 * PQ[b0] * QD_1 * (-1.0))
                            + delta[b1][d1] * (PB_0 * PA_0 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[d0] * QC_0 * (-1.0))
                            + delta[b1][d0] * (PB_0 * PA_0 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[d1] * QC_0 * (-1.0))
                            + delta[b1][c0] * (PB_0 * PA_0 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][d1] * (PB_1 * PA_0 * PQ[c0] * QD_0 * (-1.0) + PB_1 * PA_0 * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][d0] * (PB_1 * PA_0 * PQ[c0] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][c0] * (PB_1 * PA_0 * PQ[d0] * QD_1 * (-1.0) + PB_1 * PA_0 * PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][b1] * (PA_0 * PQ[c0] * PQ[d0] * QD_1 + PA_0 * PQ[c0] * PQ[d1] * QD_0 + PA_0 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][d1] * (PB_0 * PB_1 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PB_1 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d0] * (PB_0 * PB_1 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][c0] * (PB_0 * PB_1 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][b1] * (PB_0 * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][b0] * (PB_1 * PQ[c0] * PQ[d0] * QD_1 + PB_1 * PQ[c0] * PQ[d1] * QD_0 + PB_1 * PQ[d0] * PQ[d1] * QC_0)
                        )

                    )

                    +

                    F6_t[2] * (

                        0.5 * S2 / ( S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[a0] * PQ[b1] * QC_0 + PB_1 * PQ[a0] * PQ[b0] * QC_0 + PA_0 * PQ[b0] * PQ[b1] * QC_0)
                            + delta[c0][d1] * (PB_0 * PQ[a0] * PQ[b1] * QD_0 + PB_1 * PQ[a0] * PQ[b0] * QD_0 + PA_0 * PQ[b0] * PQ[b1] * QD_0)
                            + delta[c0][d0] * (PB_0 * PQ[a0] * PQ[b1] * QD_1 + PB_1 * PQ[a0] * PQ[b0] * QD_1 + PA_0 * PQ[b0] * PQ[b1] * QD_1)
                            + delta[b1][d1] * (PB_0 * PQ[a0] * QD_0 * QC_0 + PA_0 * PQ[b0] * QD_0 * QC_0)
                            + delta[b1][d0] * (PB_0 * PQ[a0] * QD_1 * QC_0 + PA_0 * PQ[b0] * QD_1 * QC_0)
                            + delta[b1][c0] * (PB_0 * PQ[a0] * QD_0 * QD_1 + PA_0 * PQ[b0] * QD_0 * QD_1)
                            + delta[b0][d1] * (PB_1 * PQ[a0] * QD_0 * QC_0 + PA_0 * PQ[b1] * QD_0 * QC_0)
                            + delta[b0][d0] * (PB_1 * PQ[a0] * QD_1 * QC_0 + PA_0 * PQ[b1] * QD_1 * QC_0)
                            + delta[b0][c0] * (PB_1 * PQ[a0] * QD_0 * QD_1 + PA_0 * PQ[b1] * QD_0 * QD_1)
                            + delta[b0][b1] * (PQ[a0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[c0] * QD_0 * QD_1 + PA_0 * PQ[d0] * QD_1 * QC_0 + PA_0 * PQ[d1] * QD_0 * QC_0)
                            + delta[a0][d1] * (PB_0 * PQ[b1] * QD_0 * QC_0 + PB_1 * PQ[b0] * QD_0 * QC_0)
                            + delta[a0][d0] * (PB_0 * PQ[b1] * QD_1 * QC_0 + PB_1 * PQ[b0] * QD_1 * QC_0)
                            + delta[a0][b1] * (PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[c0] * QD_0 * QD_1 + PB_0 * PQ[d0] * QD_1 * QC_0 + PB_0 * PQ[d1] * QD_0 * QC_0)
                            + delta[a0][b0] * (PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[c0] * QD_0 * QD_1 + PB_1 * PQ[d0] * QD_1 * QC_0 + PB_1 * PQ[d1] * QD_0 * QC_0)
                            + delta[a0][c0] * (PB_0 * PQ[b1] * QD_0 * QD_1 + PB_1 * PQ[b0] * QD_0 * QD_1)
                        )

                    )

                    +

                    F6_t[3] * (

                        ( S1 * S1 * S1 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDPD4(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[4];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[3] * (

                        ( S1 * S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[d0] * QD_1
                            + PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[d1] * QD_0
                            + PB_0 * PB_1 * PQ[a0] * PQ[d0] * PQ[d1] * QC_0
                            + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[d0] * QD_1
                            + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[d1] * QD_0
                            + PB_0 * PA_0 * PQ[b1] * PQ[d0] * PQ[d1] * QC_0
                            + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[d0] * QD_1
                            + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[d1] * QD_0
                            + PB_1 * PA_0 * PQ[b0] * PQ[d0] * PQ[d1] * QC_0
                        )

                    )

                    +

                    F6_t[3] * (

                        ( S1 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                        )

                    )

                    +

                    F6_t[3] * (

                        ( S2 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_0
                        )

                    )

                    +

                    F6_t[3] * (

                        0.25 * S1 / ( S4 * S4 * S4 ) * (
                            delta[b1][c0] * delta[d0][d1] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0))
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0))
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0))
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * PQ[a0] * (-1.0) + PA_0 * PQ[b1] * (-1.0))
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * PQ[a0] * (-1.0) + PA_0 * PQ[b1] * (-1.0))
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * PQ[a0] * (-1.0) + PA_0 * PQ[b1] * (-1.0))
                            + delta[b0][b1] * delta[d0][d1] * (PA_0 * PQ[c0] * (-1.0) + PQ[a0] * PQ[c0])
                            + delta[b0][d0] * delta[b1][d1] * (PA_0 * PQ[c0] * (-1.0))
                            + delta[b0][d1] * delta[b1][d0] * (PA_0 * PQ[c0] * (-1.0))
                            + delta[b0][b1] * delta[c0][d1] * (PA_0 * PQ[d0] * (-1.0) + PQ[a0] * PQ[d0])
                            + delta[b0][c0] * delta[b1][d1] * (PA_0 * PQ[d0] * (-1.0))
                            + delta[b0][d1] * delta[b1][c0] * (PA_0 * PQ[d0] * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * (PA_0 * PQ[d1] * (-1.0) + PQ[a0] * PQ[d1])
                            + delta[b0][c0] * delta[b1][d0] * (PA_0 * PQ[d1] * (-1.0))
                            + delta[b0][d0] * delta[b1][c0] * (PA_0 * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0))
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0))
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0))
                            + delta[a0][d0] * delta[b1][d1] * (PB_0 * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[b1][d0] * (PB_0 * PQ[c0] * (-1.0))
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * PQ[c0] * (-1.0) + PQ[b0] * PQ[c0])
                            + delta[a0][c0] * delta[b1][d1] * (PB_0 * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[b1][c0] * (PB_0 * PQ[d0] * (-1.0))
                            + delta[a0][b1] * delta[c0][d1] * (PB_0 * PQ[d0] * (-1.0) + PQ[b0] * PQ[d0])
                            + delta[a0][c0] * delta[b1][d0] * (PB_0 * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[b1][c0] * (PB_0 * PQ[d1] * (-1.0))
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * PQ[d1] * (-1.0) + PQ[b0] * PQ[d1])
                            + delta[a0][d0] * delta[b0][d1] * (PB_1 * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * (PB_1 * PQ[c0] * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * PQ[c0] * (-1.0) + PQ[b1] * PQ[c0])
                            + delta[a0][c0] * delta[b0][d1] * (PB_1 * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[b0][c0] * (PB_1 * PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[c0][d1] * (PB_1 * PQ[d0] * (-1.0) + PQ[b1] * PQ[d0])
                            + delta[a0][c0] * delta[b0][d0] * (PB_1 * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[b0][c0] * (PB_1 * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * PQ[d1] * (-1.0) + PQ[b1] * PQ[d1])
                            + delta[a0][d1] * delta[b0][b1] * (PQ[c0] * PQ[d0])
                            + delta[a0][b0] * delta[b1][d1] * (PQ[c0] * PQ[d0])
                            + delta[b0][d1] * delta[a0][b1] * (PQ[c0] * PQ[d0])
                            + delta[a0][d0] * delta[b0][b1] * (PQ[c0] * PQ[d1])
                            + delta[a0][b0] * delta[b1][d0] * (PQ[c0] * PQ[d1])
                            + delta[b0][d0] * delta[a0][b1] * (PQ[c0] * PQ[d1])
                            + delta[a0][c0] * delta[b0][b1] * (PQ[d0] * PQ[d1])
                            + delta[a0][b0] * delta[b1][c0] * (PQ[d0] * PQ[d1])
                            + delta[b0][c0] * delta[a0][b1] * (PQ[d0] * PQ[d1])
                        )

                    )

                    +

                    F6_t[3] * (

                        0.25 * S2 / ( S4 * S4 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PQ[a0] * PQ[c0] + PQ[a0] * QC_0)
                            + delta[b0][d0] * delta[b1][d1] * (PQ[a0] * QC_0)
                            + delta[b0][d1] * delta[b1][d0] * (PQ[a0] * QC_0)
                            + delta[a0][d0] * delta[b1][d1] * (PQ[b0] * QC_0)
                            + delta[a0][d1] * delta[b1][d0] * (PQ[b0] * QC_0)
                            + delta[a0][b1] * delta[d0][d1] * (PQ[b0] * PQ[c0] + PQ[b0] * QC_0)
                            + delta[a0][d0] * delta[b0][d1] * (PQ[b1] * QC_0)
                            + delta[a0][d1] * delta[b0][d0] * (PQ[b1] * QC_0)
                            + delta[a0][b0] * delta[d0][d1] * (PQ[b1] * PQ[c0] + PQ[b1] * QC_0)
                            + delta[a0][d1] * delta[b0][b1] * (PQ[c0] * QD_0 + PQ[d0] * QC_0)
                            + delta[a0][b0] * delta[b1][d1] * (PQ[c0] * QD_0 + PQ[d0] * QC_0)
                            + delta[b0][d1] * delta[a0][b1] * (PQ[c0] * QD_0 + PQ[d0] * QC_0)
                            + delta[a0][d0] * delta[b0][b1] * (PQ[c0] * QD_1 + PQ[d1] * QC_0)
                            + delta[a0][b0] * delta[b1][d0] * (PQ[c0] * QD_1 + PQ[d1] * QC_0)
                            + delta[b0][d0] * delta[a0][b1] * (PQ[c0] * QD_1 + PQ[d1] * QC_0)
                            + delta[b1][c0] * delta[d0][d1] * (PQ[a0] * PQ[b0])
                            + delta[b1][d0] * delta[c0][d1] * (PQ[a0] * PQ[b0])
                            + delta[b1][d1] * delta[c0][d0] * (PQ[a0] * PQ[b0])
                            + delta[b0][c0] * delta[d0][d1] * (PQ[a0] * PQ[b1])
                            + delta[b0][d0] * delta[c0][d1] * (PQ[a0] * PQ[b1])
                            + delta[b0][d1] * delta[c0][d0] * (PQ[a0] * PQ[b1])
                            + delta[b0][b1] * delta[c0][d1] * (PQ[a0] * PQ[d0] + PQ[a0] * QD_0)
                            + delta[b0][b1] * delta[c0][d0] * (PQ[a0] * PQ[d1] + PQ[a0] * QD_1)
                            + delta[b0][c0] * delta[b1][d1] * (PQ[a0] * QD_0)
                            + delta[b0][d1] * delta[b1][c0] * (PQ[a0] * QD_0)
                            + delta[b0][c0] * delta[b1][d0] * (PQ[a0] * QD_1)
                            + delta[b0][d0] * delta[b1][c0] * (PQ[a0] * QD_1)
                            + delta[a0][c0] * delta[d0][d1] * (PQ[b0] * PQ[b1])
                            + delta[a0][d0] * delta[c0][d1] * (PQ[b0] * PQ[b1])
                            + delta[a0][d1] * delta[c0][d0] * (PQ[b0] * PQ[b1])
                            + delta[a0][b1] * delta[c0][d1] * (PQ[b0] * PQ[d0] + PQ[b0] * QD_0)
                            + delta[a0][b1] * delta[c0][d0] * (PQ[b0] * PQ[d1] + PQ[b0] * QD_1)
                            + delta[a0][c0] * delta[b1][d1] * (PQ[b0] * QD_0)
                            + delta[a0][d1] * delta[b1][c0] * (PQ[b0] * QD_0)
                            + delta[a0][c0] * delta[b1][d0] * (PQ[b0] * QD_1)
                            + delta[a0][d0] * delta[b1][c0] * (PQ[b0] * QD_1)
                            + delta[a0][b0] * delta[c0][d1] * (PQ[b1] * PQ[d0] + PQ[b1] * QD_0)
                            + delta[a0][b0] * delta[c0][d0] * (PQ[b1] * PQ[d1] + PQ[b1] * QD_1)
                            + delta[a0][c0] * delta[b0][d1] * (PQ[b1] * QD_0)
                            + delta[a0][d1] * delta[b0][c0] * (PQ[b1] * QD_0)
                            + delta[a0][c0] * delta[b0][d0] * (PQ[b1] * QD_1)
                            + delta[a0][d0] * delta[b0][c0] * (PQ[b1] * QD_1)
                            + delta[a0][c0] * delta[b0][b1] * (PQ[d0] * QD_1 + PQ[d1] * QD_0)
                            + delta[a0][b0] * delta[b1][c0] * (PQ[d0] * QD_1 + PQ[d1] * QD_0)
                            + delta[b0][c0] * delta[a0][b1] * (PQ[d0] * QD_1 + PQ[d1] * QD_0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDPD5(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[5];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[3] * (

                        0.5 * ( S1 * S1 ) / ( S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[c0] + PB_0 * PA_0 * PQ[b1] * PQ[c0] + PB_1 * PA_0 * PQ[b0] * PQ[c0])
                            + delta[c0][d1] * (PB_0 * PB_1 * PQ[a0] * PQ[d0] + PB_0 * PA_0 * PQ[b1] * PQ[d0] + PB_1 * PA_0 * PQ[b0] * PQ[d0])
                            + delta[c0][d0] * (PB_0 * PB_1 * PQ[a0] * PQ[d1] + PB_0 * PA_0 * PQ[b1] * PQ[d1] + PB_1 * PA_0 * PQ[b0] * PQ[d1])
                            + delta[b1][d1] * (PB_0 * PA_0 * PQ[c0] * PQ[d0])
                            + delta[b1][d0] * (PB_0 * PA_0 * PQ[c0] * PQ[d1])
                            + delta[b1][c0] * (PB_0 * PA_0 * PQ[d0] * PQ[d1])
                            + delta[b0][d1] * (PB_1 * PA_0 * PQ[c0] * PQ[d0])
                            + delta[b0][d0] * (PB_1 * PA_0 * PQ[c0] * PQ[d1])
                            + delta[b0][c0] * (PB_1 * PA_0 * PQ[d0] * PQ[d1])
                            + delta[b0][b1] * (PA_0 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b1] * (PB_0 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * (PB_1 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][d1] * (PB_0 * PB_1 * PQ[c0] * PQ[d0])
                            + delta[a0][d0] * (PB_0 * PB_1 * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * (PB_0 * PB_1 * PQ[d0] * PQ[d1])
                        )

                    )

                    +

                    F6_t[3] * (

                        0.5 * ( S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * QC_0 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[c0][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[c0][d0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[d1] * (-1.0) + PB_0 * PQ[a0] * PQ[b1] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * PQ[d1] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[b1][d1] * (PB_0 * PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[a0] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[b1][d0] * (PB_0 * PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[b1][c0] * (PB_0 * PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][d1] * (PB_1 * PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[a0] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][d0] * (PB_1 * PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][c0] * (PB_1 * PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[a0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][b1] * (PA_0 * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PQ[a0] * PQ[c0] * PQ[d0] * QD_1 + PQ[a0] * PQ[c0] * PQ[d1] * QD_0 + PQ[a0] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][d1] * (PB_0 * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d0] * (PB_0 * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][c0] * (PB_0 * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][b1] * (PB_0 * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PQ[b0] * PQ[c0] * PQ[d0] * QD_1 + PQ[b0] * PQ[c0] * PQ[d1] * QD_0 + PQ[b0] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][b0] * (PB_1 * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[d0] * PQ[d1] * QC_0 * (-1.0) + PQ[b1] * PQ[c0] * PQ[d0] * QD_1 + PQ[b1] * PQ[c0] * PQ[d1] * QD_0 + PQ[b1] * PQ[d0] * PQ[d1] * QC_0)
                        )

                    )

                    +

                    F6_t[3] * (

                        0.5 * ( S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * QC_0)
                            + delta[b1][d1] * (PQ[a0] * PQ[b0] * QD_0 * QC_0)
                            + delta[b1][d0] * (PQ[a0] * PQ[b0] * QD_1 * QC_0)
                            + delta[b0][d1] * (PQ[a0] * PQ[b1] * QD_0 * QC_0)
                            + delta[b0][d0] * (PQ[a0] * PQ[b1] * QD_1 * QC_0)
                            + delta[b0][b1] * (PQ[a0] * PQ[c0] * QD_0 * QD_1 + PQ[a0] * PQ[d0] * QD_1 * QC_0 + PQ[a0] * PQ[d1] * QD_0 * QC_0)
                            + delta[a0][d1] * (PQ[b0] * PQ[b1] * QD_0 * QC_0)
                            + delta[a0][d0] * (PQ[b0] * PQ[b1] * QD_1 * QC_0)
                            + delta[a0][b1] * (PQ[b0] * PQ[c0] * QD_0 * QD_1 + PQ[b0] * PQ[d0] * QD_1 * QC_0 + PQ[b0] * PQ[d1] * QD_0 * QC_0)
                            + delta[a0][b0] * (PQ[b1] * PQ[c0] * QD_0 * QD_1 + PQ[b1] * PQ[d0] * QD_1 * QC_0 + PQ[b1] * PQ[d1] * QD_0 * QC_0)
                            + delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * QD_0)
                            + delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * QD_1)
                            + delta[b1][c0] * (PQ[a0] * PQ[b0] * QD_0 * QD_1)
                            + delta[b0][c0] * (PQ[a0] * PQ[b1] * QD_0 * QD_1)
                            + delta[a0][c0] * (PQ[b0] * PQ[b1] * QD_0 * QD_1)
                        )

                    )

                    +

                    F6_t[3] * (

                        0.125 / ( S4 * S4 * S4 ) * (
                            delta[a0][c0] * delta[b0][b1] * delta[d0][d1]
                            + delta[a0][c0] * delta[b0][d0] * delta[b1][d1]
                            + delta[a0][c0] * delta[b0][d1] * delta[b1][d0]
                            + delta[a0][d0] * delta[b0][b1] * delta[c0][d1]
                            + delta[a0][d0] * delta[b0][c0] * delta[b1][d1]
                            + delta[a0][d0] * delta[b0][d1] * delta[b1][c0]
                            + delta[a0][d1] * delta[b0][b1] * delta[c0][d0]
                            + delta[a0][d1] * delta[b0][c0] * delta[b1][d0]
                            + delta[a0][d1] * delta[b0][d0] * delta[b1][c0]
                            + delta[a0][b0] * delta[b1][c0] * delta[d0][d1]
                            + delta[a0][b0] * delta[b1][d0] * delta[c0][d1]
                            + delta[a0][b0] * delta[b1][d1] * delta[c0][d0]
                            + delta[b0][c0] * delta[a0][b1] * delta[d0][d1]
                            + delta[b0][d0] * delta[a0][b1] * delta[c0][d1]
                            + delta[b0][d1] * delta[a0][b1] * delta[c0][d0]
                        )

                    )

                    +

                    F6_t[4] * (

                        ( S1 * S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                            + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                            + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                        )

                    )

                    +

                    F6_t[4] * (

                        ( S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * QD_1
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1] * QD_0
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1] * QC_0
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0
                        )

                    )

                    +

                    F6_t[4] * (

                        ( S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDPD6(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[7];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 6, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[4] * (

                        0.25 * ( S1 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[b1][c0] * delta[d0][d1] * (PQ[a0] * PQ[b0] * (-1.0))
                            + delta[b1][d0] * delta[c0][d1] * (PQ[a0] * PQ[b0] * (-1.0))
                            + delta[b1][d1] * delta[c0][d0] * (PQ[a0] * PQ[b0] * (-1.0))
                            + delta[b0][c0] * delta[d0][d1] * (PQ[a0] * PQ[b1] * (-1.0))
                            + delta[b0][d0] * delta[c0][d1] * (PQ[a0] * PQ[b1] * (-1.0))
                            + delta[b0][d1] * delta[c0][d0] * (PQ[a0] * PQ[b1] * (-1.0))
                            + delta[b0][b1] * delta[d0][d1] * (PQ[a0] * PQ[c0] * (-1.0))
                            + delta[b0][d0] * delta[b1][d1] * (PQ[a0] * PQ[c0] * (-1.0))
                            + delta[b0][d1] * delta[b1][d0] * (PQ[a0] * PQ[c0] * (-1.0))
                            + delta[b0][b1] * delta[c0][d1] * (PQ[a0] * PQ[d0] * (-1.0))
                            + delta[b0][c0] * delta[b1][d1] * (PQ[a0] * PQ[d0] * (-1.0))
                            + delta[b0][d1] * delta[b1][c0] * (PQ[a0] * PQ[d0] * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * (PQ[a0] * PQ[d1] * (-1.0))
                            + delta[b0][c0] * delta[b1][d0] * (PQ[a0] * PQ[d1] * (-1.0))
                            + delta[b0][d0] * delta[b1][c0] * (PQ[a0] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[d0][d1] * (PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][d0] * delta[c0][d1] * (PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][d1] * delta[c0][d0] * (PQ[b0] * PQ[b1] * (-1.0))
                            + delta[a0][d0] * delta[b1][d1] * (PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[b1][d0] * (PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a0][b1] * delta[d0][d1] * (PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a0][c0] * delta[b1][d1] * (PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[b1][c0] * (PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][b1] * delta[c0][d1] * (PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[b1][d0] * (PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[b1][c0] * (PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a0][b1] * delta[c0][d0] * (PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[b0][d1] * (PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * (PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a0][c0] * delta[b0][d1] * (PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[b0][c0] * (PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[c0][d1] * (PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[b0][d0] * (PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[b0][c0] * (PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * (PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * (PQ[c0] * PQ[d0] * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * (PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * (PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * (PQ[c0] * PQ[d1] * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * (PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * (PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * (PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * (PQ[d0] * PQ[d1] * (-1.0))
                        )

                    )

                    +

                    F6_t[4] * (

                        0.5 * ( S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[c0] + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] + PA_0 * PQ[b0] * PQ[b1] * PQ[c0])
                            + delta[c0][d1] * (PB_0 * PQ[a0] * PQ[b1] * PQ[d0] + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] + PA_0 * PQ[b0] * PQ[b1] * PQ[d0])
                            + delta[c0][d0] * (PB_0 * PQ[a0] * PQ[b1] * PQ[d1] + PB_1 * PQ[a0] * PQ[b0] * PQ[d1] + PA_0 * PQ[b0] * PQ[b1] * PQ[d1])
                            + delta[b1][d1] * (PB_0 * PQ[a0] * PQ[c0] * PQ[d0] + PA_0 * PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[b1][d0] * (PB_0 * PQ[a0] * PQ[c0] * PQ[d1] + PA_0 * PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[b1][c0] * (PB_0 * PQ[a0] * PQ[d0] * PQ[d1] + PA_0 * PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[b0][d1] * (PB_1 * PQ[a0] * PQ[c0] * PQ[d0] + PA_0 * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[b0][d0] * (PB_1 * PQ[a0] * PQ[c0] * PQ[d1] + PA_0 * PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[b0][c0] * (PB_1 * PQ[a0] * PQ[d0] * PQ[d1] + PA_0 * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[b0][b1] * (PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][b1] * (PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_0 * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * (PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * (PB_0 * PQ[b1] * PQ[c0] * PQ[d0] + PB_1 * PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a0][d0] * (PB_0 * PQ[b1] * PQ[c0] * PQ[d1] + PB_1 * PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * (PB_0 * PQ[b1] * PQ[d0] * PQ[d1] + PB_1 * PQ[b0] * PQ[d0] * PQ[d1])
                        )

                    )

                    +

                    F6_t[4] * (

                        0.5 * ( S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * (-1.0) + PQ[a0] * PQ[b0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[b1][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[b1][d0] * (PQ[a0] * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[b1][c0] * (PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][d1] * (PQ[a0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][d0] * (PQ[a0] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][c0] * (PQ[a0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][b1] * (PQ[a0] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PQ[a0] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d0] * (PQ[b0] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][c0] * (PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][b1] * (PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][b0] * (PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                        )

                    )

                    +

                    F6_t[5] * (

                        ( S1 * S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                        )

                    )

                    +

                    F6_t[5] * (

                        ( S1 * S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1
                            + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0
                            + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0
                        )

                    )

                    +

                    F6_t[5] * (

                        0.5 * ( S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0])
                            + delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0])
                            + delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1])
                            + delta[b1][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[b1][d0] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[b1][c0] * (PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[b0][d1] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[b0][d0] * (PQ[a0] * PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[b0][c0] * (PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[b0][b1] * (PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[a0][d0] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * (PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[a0][b1] * (PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * (PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1])
                        )

                    )

                    +

                    F6_t[6] * (

                        ( S1 * S1 * S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDPP0(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pp_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   pp_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* pp_first_inds,
                       const uint32_t* pp_second_inds,
                       const uint32_t  pp_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pp_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pp_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * pp_mat_Q[kl] * pp_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = pp_first_inds[kl];
            const auto l = pp_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = p_prim_info[l / 3 + p_prim_count * 0];
            const auto c_l = p_prim_info[l / 3 + p_prim_count * 1];
            const auto x_l = p_prim_info[l / 3 + p_prim_count * 2];
            const auto y_l = p_prim_info[l / 3 + p_prim_count * 3];
            const auto z_l = p_prim_info[l / 3 + p_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = l % 3;

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F5_t[3];

            gpu::computeBoysFunction(F5_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F5_t[0] * (

                        0.25 / ( S1 * S2 ) * (
                            delta[b0][b1] * delta[c0][d0] * (PA_0)
                            + delta[a0][b1] * delta[c0][d0] * (PB_0)
                            + delta[a0][b0] * delta[c0][d0] * (PB_1)
                        )

                    )

                    +

                    F5_t[0] * (

                        0.5 / S1 * (
                            delta[b0][b1] * (PA_0 * QD_0 * QC_0)
                            + delta[a0][b1] * (PB_0 * QD_0 * QC_0)
                            + delta[a0][b0] * (PB_1 * QD_0 * QC_0)
                        )

                    )

                    +

                    F5_t[0] * (

                        0.5 / S2 * (
                            delta[c0][d0] * (PB_0 * PB_1 * PA_0)
                        )

                    )

                    +

                    F5_t[0] * (

                        (
                            
                            + PB_0 * PB_1 * PA_0 * QD_0 * QC_0
                        )

                    )

                    +

                    F5_t[1] * (

                        0.25 / ( S1 * S4 ) * (
                            delta[b0][b1] * delta[c0][d0] * (PA_0 * (-1.0) + PQ[a0])
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * (-1.0) + PQ[b0])
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * (-1.0) + PQ[b1])
                            + delta[a0][d0] * delta[b0][b1] * (QC_0)
                            + delta[a0][b0] * delta[b1][d0] * (QC_0)
                            + delta[b0][d0] * delta[a0][b1] * (QC_0)
                            + delta[a0][c0] * delta[b0][b1] * (QD_0)
                            + delta[a0][b0] * delta[b1][c0] * (QD_0)
                            + delta[b0][c0] * delta[a0][b1] * (QD_0)
                        )

                    )

                    +

                    F5_t[1] * (

                        0.25 / ( S2 * S4 ) * (
                            delta[b0][b1] * delta[c0][d0] * (PA_0 * (-1.0))
                            + delta[a0][b1] * delta[c0][d0] * (PB_0 * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (PB_1 * (-1.0))
                        )

                    )

                    +

                    F5_t[1] * (

                        0.5 * S1 / ( S2 * S4 ) * (
                            delta[c0][d0] * (PB_0 * PB_1 * PA_0 * (-1.0))
                        )

                    )

                    +

                    F5_t[1] * (

                        0.5 * S2 / ( S1 * S4 ) * (
                            delta[b0][b1] * (PA_0 * QD_0 * QC_0 * (-1.0) + PQ[a0] * QD_0 * QC_0)
                            + delta[a0][b1] * (PB_0 * QD_0 * QC_0 * (-1.0) + PQ[b0] * QD_0 * QC_0)
                            + delta[a0][b0] * (PB_1 * QD_0 * QC_0 * (-1.0) + PQ[b1] * QD_0 * QC_0)
                        )

                    )

                    +

                    F5_t[1] * (

                        0.5 / S4 * (
                            delta[c0][d0] * (PB_0 * PB_1 * PQ[a0] + PB_0 * PA_0 * PQ[b1] + PB_1 * PA_0 * PQ[b0])
                            + delta[b1][d0] * (PB_0 * PA_0 * QC_0)
                            + delta[b1][c0] * (PB_0 * PA_0 * QD_0)
                            + delta[b0][d0] * (PB_1 * PA_0 * QC_0)
                            + delta[b0][c0] * (PB_1 * PA_0 * QD_0)
                            + delta[b0][b1] * (PA_0 * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d0] * (PB_0 * PB_1 * QC_0)
                            + delta[a0][b1] * (PB_0 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][b0] * (PB_1 * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][c0] * (PB_0 * PB_1 * QD_0)
                        )

                    )

                    +

                    F5_t[1] * (

                        S1 / S4 * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[c0] * QD_0 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PQ[d0] * QC_0 * (-1.0)
                        )

                    )

                    +

                    F5_t[1] * (

                        S2 / S4 * (
                            
                            + PB_0 * PB_1 * PQ[a0] * QD_0 * QC_0
                            + PB_0 * PA_0 * PQ[b1] * QD_0 * QC_0
                            + PB_1 * PA_0 * PQ[b0] * QD_0 * QC_0
                        )

                    )

                    +

                    F5_t[2] * (

                        ( S1 * S1 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[c0] * PQ[d0]
                        )

                    )

                    +

                    F5_t[2] * (

                        ( S1 * S2 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[c0] * QD_0 * (-1.0)
                            + PB_0 * PB_1 * PQ[a0] * PQ[d0] * QC_0 * (-1.0)
                            + PB_0 * PA_0 * PQ[b1] * PQ[c0] * QD_0 * (-1.0)
                            + PB_0 * PA_0 * PQ[b1] * PQ[d0] * QC_0 * (-1.0)
                            + PB_1 * PA_0 * PQ[b0] * PQ[c0] * QD_0 * (-1.0)
                            + PB_1 * PA_0 * PQ[b0] * PQ[d0] * QC_0 * (-1.0)
                        )

                    )

                    +

                    F5_t[2] * (

                        ( S2 * S2 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[b1] * QD_0 * QC_0
                            + PB_1 * PQ[a0] * PQ[b0] * QD_0 * QC_0
                            + PA_0 * PQ[b0] * PQ[b1] * QD_0 * QC_0
                        )

                    )

                    +

                    F5_t[2] * (

                        0.25 * S2 / ( S1 * S4 * S4 ) * (
                            delta[b0][b1] * delta[c0][d0] * (PQ[a0] * (-1.0))
                            + delta[a0][b1] * delta[c0][d0] * (PQ[b0] * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (PQ[b1] * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * (QC_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * (QC_0 * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * (QC_0 * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * (QD_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * (QD_0 * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * (QD_0 * (-1.0))
                        )

                    )

                    +

                    F5_t[2] * (

                        0.25 / ( S4 * S4 ) * (
                            delta[b0][b1] * delta[c0][d0] * (PQ[a0] * (-1.0) + PA_0)
                            + delta[b0][c0] * delta[b1][d0] * (PA_0)
                            + delta[b0][d0] * delta[b1][c0] * (PA_0)
                            + delta[a0][b1] * delta[c0][d0] * (PQ[b0] * (-1.0) + PB_0)
                            + delta[a0][b0] * delta[c0][d0] * (PQ[b1] * (-1.0) + PB_1)
                            + delta[a0][d0] * delta[b0][b1] * (PQ[c0] * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * (PQ[c0] * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * (PQ[c0] * (-1.0))
                            + delta[a0][c0] * delta[b0][b1] * (PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[b1][c0] * (PQ[d0] * (-1.0))
                            + delta[b0][c0] * delta[a0][b1] * (PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[b1][d0] * (PB_0)
                            + delta[a0][d0] * delta[b1][c0] * (PB_0)
                            + delta[a0][c0] * delta[b0][d0] * (PB_1)
                            + delta[a0][d0] * delta[b0][c0] * (PB_1)
                        )

                    )

                    +

                    F5_t[2] * (

                        0.5 * ( S2 * S2 ) / ( S1 * S4 * S4 ) * (
                            delta[b0][b1] * (PQ[a0] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][b1] * (PQ[b0] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][b0] * (PQ[b1] * QD_0 * QC_0 * (-1.0))
                        )

                    )

                    +

                    F5_t[2] * (

                        0.5 * S1 / ( S4 * S4 ) * (
                            delta[c0][d0] * (PB_0 * PB_1 * PQ[a0] * (-1.0) + PB_0 * PA_0 * PQ[b1] * (-1.0) + PB_1 * PA_0 * PQ[b0] * (-1.0))
                            + delta[b1][d0] * (PB_0 * PA_0 * PQ[c0] * (-1.0))
                            + delta[b1][c0] * (PB_0 * PA_0 * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PB_1 * PA_0 * PQ[c0] * (-1.0))
                            + delta[b0][c0] * (PB_1 * PA_0 * PQ[d0] * (-1.0))
                            + delta[b0][b1] * (PA_0 * PQ[c0] * PQ[d0])
                            + delta[a0][d0] * (PB_0 * PB_1 * PQ[c0] * (-1.0))
                            + delta[a0][c0] * (PB_0 * PB_1 * PQ[d0] * (-1.0))
                            + delta[a0][b1] * (PB_0 * PQ[c0] * PQ[d0])
                            + delta[a0][b0] * (PB_1 * PQ[c0] * PQ[d0])
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pp_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDPP1(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pp_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   pp_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* pp_first_inds,
                       const uint32_t* pp_second_inds,
                       const uint32_t  pp_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pp_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < pp_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * pp_mat_Q[kl] * pp_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = pp_first_inds[kl];
            const auto l = pp_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = p_prim_info[l / 3 + p_prim_count * 0];
            const auto c_l = p_prim_info[l / 3 + p_prim_count * 1];
            const auto x_l = p_prim_info[l / 3 + p_prim_count * 2];
            const auto y_l = p_prim_info[l / 3 + p_prim_count * 3];
            const auto z_l = p_prim_info[l / 3 + p_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = l % 3;

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F5_t[6];

            gpu::computeBoysFunction(F5_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 5, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F5_t[2] * (

                        0.5 * S2 / ( S4 * S4 ) * (
                            delta[c0][d0] * (PB_0 * PQ[a0] * PQ[b1] + PB_1 * PQ[a0] * PQ[b0] + PA_0 * PQ[b0] * PQ[b1])
                            + delta[b1][d0] * (PB_0 * PQ[a0] * QC_0 + PA_0 * PQ[b0] * QC_0)
                            + delta[b1][c0] * (PB_0 * PQ[a0] * QD_0 + PA_0 * PQ[b0] * QD_0)
                            + delta[b0][d0] * (PB_1 * PQ[a0] * QC_0 + PA_0 * PQ[b1] * QC_0)
                            + delta[b0][c0] * (PB_1 * PQ[a0] * QD_0 + PA_0 * PQ[b1] * QD_0)
                            + delta[b0][b1] * (PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PQ[c0] * QD_0 + PA_0 * PQ[d0] * QC_0)
                            + delta[a0][d0] * (PB_0 * PQ[b1] * QC_0 + PB_1 * PQ[b0] * QC_0)
                            + delta[a0][b1] * (PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PQ[c0] * QD_0 + PB_0 * PQ[d0] * QC_0)
                            + delta[a0][b0] * (PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PQ[c0] * QD_0 + PB_1 * PQ[d0] * QC_0)
                            + delta[a0][c0] * (PB_0 * PQ[b1] * QD_0 + PB_1 * PQ[b0] * QD_0)
                        )

                    )

                    +

                    F5_t[3] * (

                        ( S1 * S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[c0] * PQ[d0]
                            + PB_0 * PA_0 * PQ[b1] * PQ[c0] * PQ[d0]
                            + PB_1 * PA_0 * PQ[b0] * PQ[c0] * PQ[d0]
                        )

                    )

                    +

                    F5_t[3] * (

                        ( S1 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * QC_0 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0)
                        )

                    )

                    +

                    F5_t[3] * (

                        ( S2 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * QC_0
                        )

                    )

                    +

                    F5_t[3] * (

                        0.5 * ( S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            delta[c0][d0] * (PB_0 * PQ[a0] * PQ[b1] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * (-1.0))
                            + delta[b1][d0] * (PB_0 * PQ[a0] * PQ[c0] * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * (-1.0))
                            + delta[b1][c0] * (PB_0 * PQ[a0] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PB_1 * PQ[a0] * PQ[c0] * (-1.0) + PA_0 * PQ[b1] * PQ[c0] * (-1.0))
                            + delta[b0][c0] * (PB_1 * PQ[a0] * PQ[d0] * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[b0][b1] * (PA_0 * PQ[c0] * PQ[d0] * (-1.0) + PQ[a0] * PQ[c0] * PQ[d0])
                            + delta[a0][d0] * (PB_0 * PQ[b1] * PQ[c0] * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a0][c0] * (PB_0 * PQ[b1] * PQ[d0] * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][b1] * (PB_0 * PQ[c0] * PQ[d0] * (-1.0) + PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a0][b0] * (PB_1 * PQ[c0] * PQ[d0] * (-1.0) + PQ[b1] * PQ[c0] * PQ[d0])
                        )

                    )

                    +

                    F5_t[3] * (

                        0.5 * ( S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            delta[b1][d0] * (PQ[a0] * PQ[b0] * QC_0)
                            + delta[b0][d0] * (PQ[a0] * PQ[b1] * QC_0)
                            + delta[b0][b1] * (PQ[a0] * PQ[c0] * QD_0 + PQ[a0] * PQ[d0] * QC_0)
                            + delta[a0][d0] * (PQ[b0] * PQ[b1] * QC_0)
                            + delta[a0][b1] * (PQ[b0] * PQ[c0] * QD_0 + PQ[b0] * PQ[d0] * QC_0)
                            + delta[a0][b0] * (PQ[b1] * PQ[c0] * QD_0 + PQ[b1] * PQ[d0] * QC_0)
                            + delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[b1])
                            + delta[b1][c0] * (PQ[a0] * PQ[b0] * QD_0)
                            + delta[b0][c0] * (PQ[a0] * PQ[b1] * QD_0)
                            + delta[a0][c0] * (PQ[b0] * PQ[b1] * QD_0)
                        )

                    )

                    +

                    F5_t[3] * (

                        0.25 * S2 / ( S4 * S4 * S4 ) * (
                            delta[b0][b1] * delta[c0][d0] * (PQ[a0])
                            + delta[b0][c0] * delta[b1][d0] * (PQ[a0])
                            + delta[b0][d0] * delta[b1][c0] * (PQ[a0])
                            + delta[a0][c0] * delta[b1][d0] * (PQ[b0])
                            + delta[a0][d0] * delta[b1][c0] * (PQ[b0])
                            + delta[a0][b1] * delta[c0][d0] * (PQ[b0])
                            + delta[a0][c0] * delta[b0][d0] * (PQ[b1])
                            + delta[a0][d0] * delta[b0][c0] * (PQ[b1])
                            + delta[a0][b0] * delta[c0][d0] * (PQ[b1])
                            + delta[a0][d0] * delta[b0][b1] * (PQ[c0])
                            + delta[a0][b0] * delta[b1][d0] * (PQ[c0])
                            + delta[b0][d0] * delta[a0][b1] * (PQ[c0])
                            + delta[a0][c0] * delta[b0][b1] * (PQ[d0])
                            + delta[a0][b0] * delta[b1][c0] * (PQ[d0])
                            + delta[b0][c0] * delta[a0][b1] * (PQ[d0])
                        )

                    )

                    +

                    F5_t[4] * (

                        ( S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[c0] * PQ[d0]
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0]
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0]
                        )

                    )

                    +

                    F5_t[4] * (

                        ( S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0)
                            + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0)
                        )

                    )

                    +

                    F5_t[4] * (

                        0.5 * ( S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[b1] * (-1.0))
                            + delta[b1][d0] * (PQ[a0] * PQ[b0] * PQ[c0] * (-1.0))
                            + delta[b1][c0] * (PQ[a0] * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PQ[a0] * PQ[b1] * PQ[c0] * (-1.0))
                            + delta[b0][c0] * (PQ[a0] * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[b0][b1] * (PQ[a0] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][d0] * (PQ[b0] * PQ[b1] * PQ[c0] * (-1.0))
                            + delta[a0][c0] * (PQ[b0] * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][b1] * (PQ[b0] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][b0] * (PQ[b1] * PQ[c0] * PQ[d0] * (-1.0))
                        )

                    )

                    +

                    F5_t[5] * (

                        ( S1 * S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0]
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pp_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDSD0(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   sd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   sd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* sd_first_inds,
                       const uint32_t* sd_second_inds,
                       const uint32_t  sd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (sd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < sd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * sd_mat_Q[kl] * sd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = sd_first_inds[kl];
            const auto l = sd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = s_prim_info[k + s_prim_count * 0];
            const auto c_k = s_prim_info[k + s_prim_count * 1];
            const auto x_k = s_prim_info[k + s_prim_count * 2];
            const auto y_k = s_prim_info[k + s_prim_count * 3];
            const auto z_k = s_prim_info[k + s_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F5_t[3];

            gpu::computeBoysFunction(F5_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F5_t[0] * (

                        0.25 / ( S1 * S2 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PA_0)
                            + delta[a0][b1] * delta[d0][d1] * (PB_0)
                            + delta[a0][b0] * delta[d0][d1] * (PB_1)
                        )

                    )

                    +

                    F5_t[0] * (

                        0.5 / S1 * (
                            delta[b0][b1] * (PA_0 * QD_0 * QD_1)
                            + delta[a0][b1] * (PB_0 * QD_0 * QD_1)
                            + delta[a0][b0] * (PB_1 * QD_0 * QD_1)
                        )

                    )

                    +

                    F5_t[0] * (

                        0.5 / S2 * (
                            delta[d0][d1] * (PB_0 * PB_1 * PA_0)
                        )

                    )

                    +

                    F5_t[0] * (

                        (
                            
                            + PB_0 * PB_1 * PA_0 * QD_0 * QD_1
                        )

                    )

                    +

                    F5_t[1] * (

                        0.25 / ( S1 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PA_0 * (-1.0) + PQ[a0])
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * (-1.0) + PQ[b0])
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * (-1.0) + PQ[b1])
                            + delta[a0][d1] * delta[b0][b1] * (QD_0)
                            + delta[a0][b0] * delta[b1][d1] * (QD_0)
                            + delta[b0][d1] * delta[a0][b1] * (QD_0)
                            + delta[a0][d0] * delta[b0][b1] * (QD_1)
                            + delta[a0][b0] * delta[b1][d0] * (QD_1)
                            + delta[b0][d0] * delta[a0][b1] * (QD_1)
                        )

                    )

                    +

                    F5_t[1] * (

                        0.25 / ( S2 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PA_0 * (-1.0))
                            + delta[a0][b1] * delta[d0][d1] * (PB_0 * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PB_1 * (-1.0))
                        )

                    )

                    +

                    F5_t[1] * (

                        0.5 * S1 / ( S2 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PA_0 * (-1.0))
                        )

                    )

                    +

                    F5_t[1] * (

                        0.5 * S2 / ( S1 * S4 ) * (
                            delta[b0][b1] * (PA_0 * QD_0 * QD_1 * (-1.0) + PQ[a0] * QD_0 * QD_1)
                            + delta[a0][b1] * (PB_0 * QD_0 * QD_1 * (-1.0) + PQ[b0] * QD_0 * QD_1)
                            + delta[a0][b0] * (PB_1 * QD_0 * QD_1 * (-1.0) + PQ[b1] * QD_0 * QD_1)
                        )

                    )

                    +

                    F5_t[1] * (

                        0.5 / S4 * (
                            delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] + PB_0 * PA_0 * PQ[b1] + PB_1 * PA_0 * PQ[b0])
                            + delta[b1][d1] * (PB_0 * PA_0 * QD_0)
                            + delta[b1][d0] * (PB_0 * PA_0 * QD_1)
                            + delta[b0][d1] * (PB_1 * PA_0 * QD_0)
                            + delta[b0][d0] * (PB_1 * PA_0 * QD_1)
                            + delta[b0][b1] * (PA_0 * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][b1] * (PB_0 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][b0] * (PB_1 * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][d1] * (PB_0 * PB_1 * QD_0)
                            + delta[a0][d0] * (PB_0 * PB_1 * QD_1)
                        )

                    )

                    +

                    F5_t[1] * (

                        S1 / S4 * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PB_1 * PA_0 * PQ[d1] * QD_0 * (-1.0)
                        )

                    )

                    +

                    F5_t[1] * (

                        S2 / S4 * (
                            
                            + PB_0 * PB_1 * PQ[a0] * QD_0 * QD_1
                            + PB_0 * PA_0 * PQ[b1] * QD_0 * QD_1
                            + PB_1 * PA_0 * PQ[b0] * QD_0 * QD_1
                        )

                    )

                    +

                    F5_t[2] * (

                        ( S1 * S1 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PA_0 * PQ[d0] * PQ[d1]
                        )

                    )

                    +

                    F5_t[2] * (

                        ( S1 * S2 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PB_1 * PQ[a0] * PQ[d1] * QD_0 * (-1.0)
                            + PB_0 * PA_0 * PQ[b1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PA_0 * PQ[b1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_1 * PA_0 * PQ[b0] * PQ[d0] * QD_1 * (-1.0)
                            + PB_1 * PA_0 * PQ[b0] * PQ[d1] * QD_0 * (-1.0)
                        )

                    )

                    +

                    F5_t[2] * (

                        ( S2 * S2 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[b1] * QD_0 * QD_1
                            + PB_1 * PQ[a0] * PQ[b0] * QD_0 * QD_1
                            + PA_0 * PQ[b0] * PQ[b1] * QD_0 * QD_1
                        )

                    )

                    +

                    F5_t[2] * (

                        0.25 * S2 / ( S1 * S4 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PQ[a0] * (-1.0))
                            + delta[a0][b1] * delta[d0][d1] * (PQ[b0] * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PQ[b1] * (-1.0))
                            + delta[a0][d1] * delta[b0][b1] * (QD_0 * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * (QD_0 * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * (QD_0 * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * (QD_1 * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * (QD_1 * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * (QD_1 * (-1.0))
                        )

                    )

                    +

                    F5_t[2] * (

                        0.25 / ( S4 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PQ[a0] * (-1.0) + PA_0)
                            + delta[b0][d0] * delta[b1][d1] * (PA_0)
                            + delta[b0][d1] * delta[b1][d0] * (PA_0)
                            + delta[a0][b1] * delta[d0][d1] * (PQ[b0] * (-1.0) + PB_0)
                            + delta[a0][b0] * delta[d0][d1] * (PQ[b1] * (-1.0) + PB_1)
                            + delta[a0][d1] * delta[b0][b1] * (PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[b1][d1] * (PQ[d0] * (-1.0))
                            + delta[b0][d1] * delta[a0][b1] * (PQ[d0] * (-1.0))
                            + delta[a0][d0] * delta[b0][b1] * (PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[b1][d0] * (PQ[d1] * (-1.0))
                            + delta[b0][d0] * delta[a0][b1] * (PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[b1][d1] * (PB_0)
                            + delta[a0][d1] * delta[b1][d0] * (PB_0)
                            + delta[a0][d0] * delta[b0][d1] * (PB_1)
                            + delta[a0][d1] * delta[b0][d0] * (PB_1)
                        )

                    )

                    +

                    F5_t[2] * (

                        0.5 * ( S2 * S2 ) / ( S1 * S4 * S4 ) * (
                            delta[b0][b1] * (PQ[a0] * QD_0 * QD_1 * (-1.0))
                            + delta[a0][b1] * (PQ[b0] * QD_0 * QD_1 * (-1.0))
                            + delta[a0][b0] * (PQ[b1] * QD_0 * QD_1 * (-1.0))
                        )

                    )

                    +

                    F5_t[2] * (

                        0.5 * S1 / ( S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PQ[a0] * (-1.0) + PB_0 * PA_0 * PQ[b1] * (-1.0) + PB_1 * PA_0 * PQ[b0] * (-1.0))
                            + delta[b1][d1] * (PB_0 * PA_0 * PQ[d0] * (-1.0))
                            + delta[b1][d0] * (PB_0 * PA_0 * PQ[d1] * (-1.0))
                            + delta[b0][d1] * (PB_1 * PA_0 * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PB_1 * PA_0 * PQ[d1] * (-1.0))
                            + delta[b0][b1] * (PA_0 * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * (PB_0 * PB_1 * PQ[d0] * (-1.0))
                            + delta[a0][d0] * (PB_0 * PB_1 * PQ[d1] * (-1.0))
                            + delta[a0][b1] * (PB_0 * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * (PB_1 * PQ[d0] * PQ[d1])
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * sd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPDSD1(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   sd_mat_D,
                       const double*   pd_mat_Q_local,
                       const double*   sd_mat_Q,
                       const uint32_t* pd_first_inds_local,
                       const uint32_t* pd_second_inds_local,
                       const uint32_t  pd_prim_pair_count_local,
                       const uint32_t* sd_first_inds,
                       const uint32_t* sd_second_inds,
                       const uint32_t  sd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (sd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < sd_prim_pair_count) && (ij < pd_prim_pair_count_local) && (fabs(pd_mat_Q_local[ij] * sd_mat_Q[kl] * sd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pd_first_inds_local[ij];
            const auto j = pd_second_inds_local[ij];

            const auto k = sd_first_inds[kl];
            const auto l = sd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = s_prim_info[k + s_prim_count * 0];
            const auto c_k = s_prim_info[k + s_prim_count * 1];
            const auto x_k = s_prim_info[k + s_prim_count * 2];
            const auto y_k = s_prim_info[k + s_prim_count * 3];
            const auto z_k = s_prim_info[k + s_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F5_t[6];

            gpu::computeBoysFunction(F5_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 5, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F5_t[2] * (

                        0.5 * S2 / ( S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[a0] * PQ[b1] + PB_1 * PQ[a0] * PQ[b0] + PA_0 * PQ[b0] * PQ[b1])
                            + delta[b1][d1] * (PB_0 * PQ[a0] * QD_0 + PA_0 * PQ[b0] * QD_0)
                            + delta[b1][d0] * (PB_0 * PQ[a0] * QD_1 + PA_0 * PQ[b0] * QD_1)
                            + delta[b0][d1] * (PB_1 * PQ[a0] * QD_0 + PA_0 * PQ[b1] * QD_0)
                            + delta[b0][d0] * (PB_1 * PQ[a0] * QD_1 + PA_0 * PQ[b1] * QD_1)
                            + delta[b0][b1] * (PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[d0] * QD_1 + PA_0 * PQ[d1] * QD_0)
                            + delta[a0][b1] * (PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[d0] * QD_1 + PB_0 * PQ[d1] * QD_0)
                            + delta[a0][b0] * (PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[d0] * QD_1 + PB_1 * PQ[d1] * QD_0)
                            + delta[a0][d1] * (PB_0 * PQ[b1] * QD_0 + PB_1 * PQ[b0] * QD_0)
                            + delta[a0][d0] * (PB_0 * PQ[b1] * QD_1 + PB_1 * PQ[b0] * QD_1)
                        )

                    )

                    +

                    F5_t[3] * (

                        ( S1 * S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[a0] * PQ[d0] * PQ[d1]
                            + PB_0 * PA_0 * PQ[b1] * PQ[d0] * PQ[d1]
                            + PB_1 * PA_0 * PQ[b0] * PQ[d0] * PQ[d1]
                        )

                    )

                    +

                    F5_t[3] * (

                        ( S1 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * (-1.0)
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0)
                        )

                    )

                    +

                    F5_t[3] * (

                        ( S2 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[b0] * PQ[b1] * QD_0 * QD_1
                        )

                    )

                    +

                    F5_t[3] * (

                        0.5 * ( S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[a0] * PQ[b1] * (-1.0) + PB_1 * PQ[a0] * PQ[b0] * (-1.0) + PA_0 * PQ[b0] * PQ[b1] * (-1.0))
                            + delta[b1][d1] * (PB_0 * PQ[a0] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[b1][d0] * (PB_0 * PQ[a0] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * (-1.0))
                            + delta[b0][d1] * (PB_1 * PQ[a0] * PQ[d0] * (-1.0) + PA_0 * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PB_1 * PQ[a0] * PQ[d1] * (-1.0) + PA_0 * PQ[b1] * PQ[d1] * (-1.0))
                            + delta[b0][b1] * (PA_0 * PQ[d0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * (PB_0 * PQ[b1] * PQ[d0] * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][d0] * (PB_0 * PQ[b1] * PQ[d1] * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a0][b1] * (PB_0 * PQ[d0] * PQ[d1] * (-1.0) + PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * (PB_1 * PQ[d0] * PQ[d1] * (-1.0) + PQ[b1] * PQ[d0] * PQ[d1])
                        )

                    )

                    +

                    F5_t[3] * (

                        0.25 * S2 / ( S4 * S4 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PQ[a0])
                            + delta[b0][d0] * delta[b1][d1] * (PQ[a0])
                            + delta[b0][d1] * delta[b1][d0] * (PQ[a0])
                            + delta[a0][d0] * delta[b1][d1] * (PQ[b0])
                            + delta[a0][d1] * delta[b1][d0] * (PQ[b0])
                            + delta[a0][b1] * delta[d0][d1] * (PQ[b0])
                            + delta[a0][d0] * delta[b0][d1] * (PQ[b1])
                            + delta[a0][d1] * delta[b0][d0] * (PQ[b1])
                            + delta[a0][b0] * delta[d0][d1] * (PQ[b1])
                            + delta[a0][d1] * delta[b0][b1] * (PQ[d0])
                            + delta[a0][b0] * delta[b1][d1] * (PQ[d0])
                            + delta[b0][d1] * delta[a0][b1] * (PQ[d0])
                            + delta[a0][d0] * delta[b0][b1] * (PQ[d1])
                            + delta[a0][b0] * delta[b1][d0] * (PQ[d1])
                            + delta[b0][d0] * delta[a0][b1] * (PQ[d1])
                        )

                    )

                    +

                    F5_t[3] * (

                        0.5 * ( S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[b1])
                            + delta[b1][d1] * (PQ[a0] * PQ[b0] * QD_0)
                            + delta[b1][d0] * (PQ[a0] * PQ[b0] * QD_1)
                            + delta[b0][d1] * (PQ[a0] * PQ[b1] * QD_0)
                            + delta[b0][d0] * (PQ[a0] * PQ[b1] * QD_1)
                            + delta[b0][b1] * (PQ[a0] * PQ[d0] * QD_1 + PQ[a0] * PQ[d1] * QD_0)
                            + delta[a0][d1] * (PQ[b0] * PQ[b1] * QD_0)
                            + delta[a0][d0] * (PQ[b0] * PQ[b1] * QD_1)
                            + delta[a0][b1] * (PQ[b0] * PQ[d0] * QD_1 + PQ[b0] * PQ[d1] * QD_0)
                            + delta[a0][b0] * (PQ[b1] * PQ[d0] * QD_1 + PQ[b1] * PQ[d1] * QD_0)
                        )

                    )

                    +

                    F5_t[4] * (

                        ( S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[b1] * PQ[d0] * PQ[d1]
                            + PB_1 * PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1]
                            + PA_0 * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1]
                        )

                    )

                    +

                    F5_t[4] * (

                        0.5 * ( S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[b1] * (-1.0))
                            + delta[b1][d1] * (PQ[a0] * PQ[b0] * PQ[d0] * (-1.0))
                            + delta[b1][d0] * (PQ[a0] * PQ[b0] * PQ[d1] * (-1.0))
                            + delta[b0][d1] * (PQ[a0] * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PQ[a0] * PQ[b1] * PQ[d1] * (-1.0))
                            + delta[b0][b1] * (PQ[a0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][d1] * (PQ[b0] * PQ[b1] * PQ[d0] * (-1.0))
                            + delta[a0][d0] * (PQ[b0] * PQ[b1] * PQ[d1] * (-1.0))
                            + delta[a0][b1] * (PQ[b0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * (PQ[b1] * PQ[d0] * PQ[d1] * (-1.0))
                        )

                    )

                    +

                    F5_t[4] * (

                        ( S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0)
                            + PQ[a0] * PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0)
                        )

                    )

                    +

                    F5_t[5] * (

                        ( S1 * S1 * S2 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1]
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * sd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockSDDD0(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   sd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* sd_first_inds_local,
                       const uint32_t* sd_second_inds_local,
                       const uint32_t  sd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < sd_prim_pair_count_local) && (fabs(sd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = sd_first_inds_local[ij];
            const auto j = sd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = s_prim_info[i + s_prim_count * 0];
            const auto c_i = s_prim_info[i + s_prim_count * 1];
            const auto x_i = s_prim_info[i + s_prim_count * 2];
            const auto y_i = s_prim_info[i + s_prim_count * 3];
            const auto z_i = s_prim_info[i + s_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[3];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[0] * (

                        0.25 / ( S1 * S2 ) * (
                            delta[b0][b1] * delta[d0][d1] * (QC_0 * QC_1)
                            + delta[b0][b1] * delta[c1][d1] * (QD_0 * QC_0)
                            + delta[b0][b1] * delta[c1][d0] * (QD_1 * QC_0)
                            + delta[b0][b1] * delta[c0][d1] * (QD_0 * QC_1)
                            + delta[b0][b1] * delta[c0][d0] * (QD_1 * QC_1)
                            + delta[b0][b1] * delta[c0][c1] * (QD_0 * QD_1)
                        )

                    )

                    +

                    F6_t[0] * (

                        0.5 / S1 * (
                            delta[b0][b1] * (QD_0 * QD_1 * QC_0 * QC_1)
                        )

                    )

                    +

                    F6_t[0] * (

                        0.5 / S2 * (
                            delta[d0][d1] * (PB_0 * PB_1 * QC_0 * QC_1)
                            + delta[c1][d1] * (PB_0 * PB_1 * QD_0 * QC_0)
                            + delta[c1][d0] * (PB_0 * PB_1 * QD_1 * QC_0)
                            + delta[c0][d1] * (PB_0 * PB_1 * QD_0 * QC_1)
                            + delta[c0][d0] * (PB_0 * PB_1 * QD_1 * QC_1)
                            + delta[c0][c1] * (PB_0 * PB_1 * QD_0 * QD_1)
                        )

                    )

                    +

                    F6_t[0] * (

                        (
                            
                            + PB_0 * PB_1 * QD_0 * QD_1 * QC_0 * QC_1
                        )

                    )

                    +

                    F6_t[0] * (

                        0.125 / ( S1 * S2 * S2 ) * (
                            delta[b0][b1] * delta[c0][c1] * delta[d0][d1]
                            + delta[b0][b1] * delta[c0][d0] * delta[c1][d1]
                            + delta[b0][b1] * delta[c1][d0] * delta[c0][d1]
                        )

                    )

                    +

                    F6_t[0] * (

                        0.25 / ( S2 * S2 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PB_1)
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PB_1)
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PB_1)
                        )

                    )

                    +

                    F6_t[1] * (

                        0.125 / ( S1 * S2 * S4 ) * (
                            delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (-1.0)
                            + delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (-1.0)
                            + delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (-1.0)
                        )

                    )

                    +

                    F6_t[1] * (

                        0.125 / ( S2 * S2 * S4 ) * (
                            delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (-2.0)
                            + delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (-2.0)
                            + delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (-2.0)
                        )

                    )

                    +

                    F6_t[1] * (

                        0.25 * S1 / ( S2 * S2 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PB_1 * (-2.0))
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PB_1 * (-2.0))
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PB_1 * (-2.0))
                        )

                    )

                    +

                    F6_t[1] * (

                        0.25 / ( S1 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (QC_0 * QC_1 * (-1.0))
                            + delta[b0][b1] * delta[c1][d1] * (QD_0 * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c1][d0] * (QD_1 * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c0][d1] * (QD_0 * QC_1 * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * (QD_1 * QC_1 * (-1.0))
                            + delta[b0][b1] * delta[c0][c1] * (QD_0 * QD_1 * (-1.0))
                        )

                    )

                    +

                    F6_t[1] * (

                        0.25 / ( S2 * S4 ) * (
                            delta[b1][c1] * delta[d0][d1] * (PB_0 * QC_0)
                            + delta[b1][d0] * delta[c1][d1] * (PB_0 * QC_0)
                            + delta[b1][d1] * delta[c1][d0] * (PB_0 * QC_0)
                            + delta[b1][c0] * delta[d0][d1] * (PB_0 * QC_1)
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * QC_1)
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * QC_1)
                            + delta[b0][c1] * delta[d0][d1] * (PB_1 * QC_0)
                            + delta[b0][d0] * delta[c1][d1] * (PB_1 * QC_0)
                            + delta[b0][d1] * delta[c1][d0] * (PB_1 * QC_0)
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * QC_1)
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * QC_1)
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * QC_1)
                            + delta[b0][b1] * delta[d0][d1] * (PQ[c0] * QC_1 * (-1.0) + PQ[c1] * QC_0 * (-1.0) + QC_0 * QC_1 * (-1.0))
                            + delta[b0][b1] * delta[c1][d1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0) + QD_0 * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c1][d0] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0) + QD_1 * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c0][d1] * (PQ[c1] * QD_0 * (-1.0) + PQ[d0] * QC_1 * (-1.0) + QD_0 * QC_1 * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * (PQ[c1] * QD_1 * (-1.0) + PQ[d1] * QC_1 * (-1.0) + QD_1 * QC_1 * (-1.0))
                            + delta[b0][b1] * delta[c0][c1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0) + QD_0 * QD_1 * (-1.0))
                            + delta[c0][c1] * delta[d0][d1] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[b1][c0] * delta[c1][d1] * (PB_0 * QD_0)
                            + delta[b1][c1] * delta[c0][d1] * (PB_0 * QD_0)
                            + delta[b1][d1] * delta[c0][c1] * (PB_0 * QD_0)
                            + delta[b1][c0] * delta[c1][d0] * (PB_0 * QD_1)
                            + delta[b1][c1] * delta[c0][d0] * (PB_0 * QD_1)
                            + delta[b1][d0] * delta[c0][c1] * (PB_0 * QD_1)
                            + delta[b0][c0] * delta[c1][d1] * (PB_1 * QD_0)
                            + delta[b0][c1] * delta[c0][d1] * (PB_1 * QD_0)
                            + delta[b0][d1] * delta[c0][c1] * (PB_1 * QD_0)
                            + delta[b0][c0] * delta[c1][d0] * (PB_1 * QD_1)
                            + delta[b0][c1] * delta[c0][d0] * (PB_1 * QD_1)
                            + delta[b0][d0] * delta[c0][c1] * (PB_1 * QD_1)
                        )

                    )

                    +

                    F6_t[1] * (

                        0.5 * S1 / ( S2 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PQ[c0] * QC_1 * (-1.0) + PB_0 * PB_1 * PQ[c1] * QC_0 * (-1.0) + PB_0 * PB_1 * QC_0 * QC_1 * (-1.0))
                            + delta[c1][d1] * (PB_0 * PB_1 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PB_1 * PQ[d0] * QC_0 * (-1.0) + PB_0 * PB_1 * QD_0 * QC_0 * (-1.0))
                            + delta[c1][d0] * (PB_0 * PB_1 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[d1] * QC_0 * (-1.0) + PB_0 * PB_1 * QD_1 * QC_0 * (-1.0))
                            + delta[c0][d1] * (PB_0 * PB_1 * PQ[c1] * QD_0 * (-1.0) + PB_0 * PB_1 * PQ[d0] * QC_1 * (-1.0) + PB_0 * PB_1 * QD_0 * QC_1 * (-1.0))
                            + delta[c0][d0] * (PB_0 * PB_1 * PQ[c1] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[d1] * QC_1 * (-1.0) + PB_0 * PB_1 * QD_1 * QC_1 * (-1.0))
                            + delta[c0][c1] * (PB_0 * PB_1 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PB_1 * PQ[d1] * QD_0 * (-1.0) + PB_0 * PB_1 * QD_0 * QD_1 * (-1.0))
                        )

                    )

                    +

                    F6_t[1] * (

                        0.5 * S2 / ( S1 * S4 ) * (
                            delta[b0][b1] * (QD_0 * QD_1 * QC_0 * QC_1 * (-1.0))
                        )

                    )

                    +

                    F6_t[1] * (

                        0.5 / S4 * (
                            delta[d0][d1] * (PB_0 * PQ[b1] * QC_0 * QC_1 + PB_1 * PQ[b0] * QC_0 * QC_1)
                            + delta[c1][d1] * (PB_0 * PQ[b1] * QD_0 * QC_0 + PB_1 * PQ[b0] * QD_0 * QC_0)
                            + delta[c1][d0] * (PB_0 * PQ[b1] * QD_1 * QC_0 + PB_1 * PQ[b0] * QD_1 * QC_0)
                            + delta[c0][d1] * (PB_0 * PQ[b1] * QD_0 * QC_1 + PB_1 * PQ[b0] * QD_0 * QC_1)
                            + delta[c0][d0] * (PB_0 * PQ[b1] * QD_1 * QC_1 + PB_1 * PQ[b0] * QD_1 * QC_1)
                            + delta[b1][d1] * (PB_0 * QD_0 * QC_0 * QC_1)
                            + delta[b1][d0] * (PB_0 * QD_1 * QC_0 * QC_1)
                            + delta[b1][c1] * (PB_0 * QD_0 * QD_1 * QC_0)
                            + delta[b1][c0] * (PB_0 * QD_0 * QD_1 * QC_1)
                            + delta[b0][d1] * (PB_1 * QD_0 * QC_0 * QC_1)
                            + delta[b0][d0] * (PB_1 * QD_1 * QC_0 * QC_1)
                            + delta[b0][c1] * (PB_1 * QD_0 * QD_1 * QC_0)
                            + delta[b0][c0] * (PB_1 * QD_0 * QD_1 * QC_1)
                            + delta[b0][b1] * (PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0))
                            + delta[c0][c1] * (PB_0 * PQ[b1] * QD_0 * QD_1 + PB_1 * PQ[b0] * QD_0 * QD_1)
                        )

                    )

                    +

                    F6_t[1] * (

                        S1 / S4 * (
                            
                            + PB_0 * PB_1 * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PB_0 * PB_1 * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PB_1 * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PB_0 * PB_1 * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                        )

                    )

                    +

                    F6_t[1] * (

                        S2 / S4 * (
                            
                            + PB_0 * PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1
                            + PB_1 * PQ[b0] * QD_0 * QD_1 * QC_0 * QC_1
                        )

                    )

                    +

                    F6_t[2] * (

                        ( S1 * S1 ) / ( S4 * S4 ) * (
                            PB_0 * PB_1 * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PB_0 * PB_1 * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PB_0 * PB_1 * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PB_0 * PB_1 * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PB_0 * PB_1 * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PB_0 * PB_1 * PQ[d0] * PQ[d1] * QC_0 * QC_1
                        )

                    )

                    +

                    F6_t[2] * (

                        ( S1 * S2 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PB_0 * PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PB_0 * PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                            + PB_1 * PQ[b0] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PB_1 * PQ[b0] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PB_1 * PQ[b0] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PB_1 * PQ[b0] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                        )

                    )

                    +

                    F6_t[2] * (

                        ( S2 * S2 ) / ( S4 * S4 ) * (
                            
                            + PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_0 * QC_1
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < sd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockSDDD1(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   sd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* sd_first_inds_local,
                       const uint32_t* sd_second_inds_local,
                       const uint32_t  sd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < sd_prim_pair_count_local) && (fabs(sd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = sd_first_inds_local[ij];
            const auto j = sd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = s_prim_info[i + s_prim_count * 0];
            const auto c_i = s_prim_info[i + s_prim_count * 1];
            const auto x_i = s_prim_info[i + s_prim_count * 2];
            const auto y_i = s_prim_info[i + s_prim_count * 3];
            const auto z_i = s_prim_info[i + s_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[3];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[2] * (

                        0.25 * S1 / ( S2 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PQ[b1] * (-2.0) + PB_1 * PQ[b0] * (-2.0))
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PQ[b1] * (-2.0) + PB_1 * PQ[b0] * (-2.0))
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PQ[b1] * (-2.0) + PB_1 * PQ[b0] * (-2.0))
                            + delta[b1][c1] * delta[d0][d1] * (PB_0 * PQ[c0] * (-1.0) + PB_0 * QC_0 * (-1.0))
                            + delta[b1][d0] * delta[c1][d1] * (PB_0 * PQ[c0] * (-1.0) + PB_0 * QC_0 * (-1.0))
                            + delta[b1][d1] * delta[c1][d0] * (PB_0 * PQ[c0] * (-1.0) + PB_0 * QC_0 * (-1.0))
                            + delta[b1][c0] * delta[d0][d1] * (PB_0 * PQ[c1] * (-1.0) + PB_0 * QC_1 * (-1.0))
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * PQ[c1] * (-1.0) + PB_0 * QC_1 * (-1.0))
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * PQ[c1] * (-1.0) + PB_0 * QC_1 * (-1.0))
                            + delta[b1][c0] * delta[c1][d1] * (PB_0 * PQ[d0] * (-1.0) + PB_0 * QD_0 * (-1.0))
                            + delta[b1][c1] * delta[c0][d1] * (PB_0 * PQ[d0] * (-1.0) + PB_0 * QD_0 * (-1.0))
                            + delta[b1][d1] * delta[c0][c1] * (PB_0 * PQ[d0] * (-1.0) + PB_0 * QD_0 * (-1.0))
                            + delta[b1][c0] * delta[c1][d0] * (PB_0 * PQ[d1] * (-1.0) + PB_0 * QD_1 * (-1.0))
                            + delta[b1][c1] * delta[c0][d0] * (PB_0 * PQ[d1] * (-1.0) + PB_0 * QD_1 * (-1.0))
                            + delta[b1][d0] * delta[c0][c1] * (PB_0 * PQ[d1] * (-1.0) + PB_0 * QD_1 * (-1.0))
                            + delta[b0][c1] * delta[d0][d1] * (PB_1 * PQ[c0] * (-1.0) + PB_1 * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[c1][d1] * (PB_1 * PQ[c0] * (-1.0) + PB_1 * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[c1][d0] * (PB_1 * PQ[c0] * (-1.0) + PB_1 * QC_0 * (-1.0))
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * PQ[c1] * (-1.0) + PB_1 * QC_1 * (-1.0))
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * PQ[c1] * (-1.0) + PB_1 * QC_1 * (-1.0))
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * PQ[c1] * (-1.0) + PB_1 * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[c1][d1] * (PB_1 * PQ[d0] * (-1.0) + PB_1 * QD_0 * (-1.0))
                            + delta[b0][c1] * delta[c0][d1] * (PB_1 * PQ[d0] * (-1.0) + PB_1 * QD_0 * (-1.0))
                            + delta[b0][d1] * delta[c0][c1] * (PB_1 * PQ[d0] * (-1.0) + PB_1 * QD_0 * (-1.0))
                            + delta[b0][c0] * delta[c1][d0] * (PB_1 * PQ[d1] * (-1.0) + PB_1 * QD_1 * (-1.0))
                            + delta[b0][c1] * delta[c0][d0] * (PB_1 * PQ[d1] * (-1.0) + PB_1 * QD_1 * (-1.0))
                            + delta[b0][d0] * delta[c0][c1] * (PB_1 * PQ[d1] * (-1.0) + PB_1 * QD_1 * (-1.0))
                            + delta[b0][b1] * delta[d0][d1] * (PQ[c0] * PQ[c1] + PQ[c0] * QC_1 + PQ[c1] * QC_0)
                            + delta[b0][b1] * delta[c1][d1] * (PQ[c0] * PQ[d0] + PQ[c0] * QD_0 + PQ[d0] * QC_0)
                            + delta[b0][b1] * delta[c0][d1] * (PQ[c1] * PQ[d0] + PQ[c1] * QD_0 + PQ[d0] * QC_1)
                            + delta[b0][b1] * delta[c1][d0] * (PQ[c0] * PQ[d1] + PQ[c0] * QD_1 + PQ[d1] * QC_0)
                            + delta[b0][b1] * delta[c0][d0] * (PQ[c1] * PQ[d1] + PQ[c1] * QD_1 + PQ[d1] * QC_1)
                            + delta[b0][b1] * delta[c0][c1] * (PQ[d0] * PQ[d1] + PQ[d0] * QD_1 + PQ[d1] * QD_0)
                        )

                    )

                    +

                    F6_t[2] * (

                        0.25 / ( S4 * S4 ) * (
                            delta[b1][c1] * delta[d0][d1] * (PQ[b0] * QC_0)
                            + delta[b1][d0] * delta[c1][d1] * (PQ[b0] * QC_0)
                            + delta[b1][d1] * delta[c1][d0] * (PQ[b0] * QC_0)
                            + delta[b1][c0] * delta[d0][d1] * (PQ[b0] * QC_1)
                            + delta[b1][d0] * delta[c0][d1] * (PQ[b0] * QC_1)
                            + delta[b1][d1] * delta[c0][d0] * (PQ[b0] * QC_1)
                            + delta[b0][c1] * delta[d0][d1] * (PQ[b1] * QC_0)
                            + delta[b0][d0] * delta[c1][d1] * (PQ[b1] * QC_0)
                            + delta[b0][d1] * delta[c1][d0] * (PQ[b1] * QC_0)
                            + delta[b0][c0] * delta[d0][d1] * (PQ[b1] * QC_1)
                            + delta[b0][d0] * delta[c0][d1] * (PQ[b1] * QC_1)
                            + delta[b0][d1] * delta[c0][d0] * (PQ[b1] * QC_1)
                            + delta[b0][b1] * delta[d0][d1] * (PQ[c0] * QC_1 + PQ[c1] * QC_0 + QC_0 * QC_1)
                            + delta[b0][b1] * delta[c1][d1] * (PQ[c0] * QD_0 + PQ[d0] * QC_0 + QD_0 * QC_0)
                            + delta[b0][b1] * delta[c0][d1] * (PQ[c1] * QD_0 + PQ[d0] * QC_1 + QD_0 * QC_1)
                            + delta[b0][b1] * delta[c1][d0] * (PQ[c0] * QD_1 + PQ[d1] * QC_0 + QD_1 * QC_0)
                            + delta[b0][b1] * delta[c0][d0] * (PQ[c1] * QD_1 + PQ[d1] * QC_1 + QD_1 * QC_1)
                            + delta[b0][d0] * delta[b1][d1] * (QC_0 * QC_1)
                            + delta[b0][d1] * delta[b1][d0] * (QC_0 * QC_1)
                            + delta[b0][c1] * delta[b1][d1] * (QD_0 * QC_0)
                            + delta[b0][d1] * delta[b1][c1] * (QD_0 * QC_0)
                            + delta[b0][c1] * delta[b1][d0] * (QD_1 * QC_0)
                            + delta[b0][d0] * delta[b1][c1] * (QD_1 * QC_0)
                            + delta[b0][c0] * delta[b1][d1] * (QD_0 * QC_1)
                            + delta[b0][d1] * delta[b1][c0] * (QD_0 * QC_1)
                            + delta[b0][c0] * delta[b1][d0] * (QD_1 * QC_1)
                            + delta[b0][d0] * delta[b1][c0] * (QD_1 * QC_1)
                            + delta[c0][c1] * delta[d0][d1] * (PQ[b0] * PQ[b1])
                            + delta[c0][d0] * delta[c1][d1] * (PQ[b0] * PQ[b1])
                            + delta[c1][d0] * delta[c0][d1] * (PQ[b0] * PQ[b1])
                            + delta[b1][c0] * delta[c1][d1] * (PQ[b0] * QD_0)
                            + delta[b1][c1] * delta[c0][d1] * (PQ[b0] * QD_0)
                            + delta[b1][d1] * delta[c0][c1] * (PQ[b0] * QD_0)
                            + delta[b1][c0] * delta[c1][d0] * (PQ[b0] * QD_1)
                            + delta[b1][c1] * delta[c0][d0] * (PQ[b0] * QD_1)
                            + delta[b1][d0] * delta[c0][c1] * (PQ[b0] * QD_1)
                            + delta[b0][c0] * delta[c1][d1] * (PQ[b1] * QD_0)
                            + delta[b0][c1] * delta[c0][d1] * (PQ[b1] * QD_0)
                            + delta[b0][d1] * delta[c0][c1] * (PQ[b1] * QD_0)
                            + delta[b0][c0] * delta[c1][d0] * (PQ[b1] * QD_1)
                            + delta[b0][c1] * delta[c0][d0] * (PQ[b1] * QD_1)
                            + delta[b0][d0] * delta[c0][c1] * (PQ[b1] * QD_1)
                            + delta[b0][b1] * delta[c0][c1] * (PQ[d0] * QD_1 + PQ[d1] * QD_0 + QD_0 * QD_1)
                            + delta[b0][c0] * delta[b1][c1] * (QD_0 * QD_1)
                            + delta[b0][c1] * delta[b1][c0] * (QD_0 * QD_1)
                        )

                    )

                    +

                    F6_t[2] * (

                        0.5 * ( S1 * S1 ) / ( S2 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PQ[c0] * PQ[c1] + PB_0 * PB_1 * PQ[c0] * QC_1 + PB_0 * PB_1 * PQ[c1] * QC_0)
                            + delta[c1][d1] * (PB_0 * PB_1 * PQ[c0] * PQ[d0] + PB_0 * PB_1 * PQ[c0] * QD_0 + PB_0 * PB_1 * PQ[d0] * QC_0)
                            + delta[c0][d1] * (PB_0 * PB_1 * PQ[c1] * PQ[d0] + PB_0 * PB_1 * PQ[c1] * QD_0 + PB_0 * PB_1 * PQ[d0] * QC_1)
                            + delta[c1][d0] * (PB_0 * PB_1 * PQ[c0] * PQ[d1] + PB_0 * PB_1 * PQ[c0] * QD_1 + PB_0 * PB_1 * PQ[d1] * QC_0)
                            + delta[c0][d0] * (PB_0 * PB_1 * PQ[c1] * PQ[d1] + PB_0 * PB_1 * PQ[c1] * QD_1 + PB_0 * PB_1 * PQ[d1] * QC_1)
                            + delta[c0][c1] * (PB_0 * PB_1 * PQ[d0] * PQ[d1] + PB_0 * PB_1 * PQ[d0] * QD_1 + PB_0 * PB_1 * PQ[d1] * QD_0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < sd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockSDDD2(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   sd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* sd_first_inds_local,
                       const uint32_t* sd_second_inds_local,
                       const uint32_t  sd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < sd_prim_pair_count_local) && (fabs(sd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = sd_first_inds_local[ij];
            const auto j = sd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = s_prim_info[i + s_prim_count * 0];
            const auto c_i = s_prim_info[i + s_prim_count * 1];
            const auto x_i = s_prim_info[i + s_prim_count * 2];
            const auto y_i = s_prim_info[i + s_prim_count * 3];
            const auto z_i = s_prim_info[i + s_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[4];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[2] * (

                        0.5 * S1 / ( S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PB_0 * PQ[b1] * PQ[c1] * QC_0 * (-1.0) + PB_0 * PQ[b1] * QC_0 * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * QC_0 * (-1.0) + PB_1 * PQ[b0] * QC_0 * QC_1 * (-1.0))
                            + delta[c1][d1] * (PB_0 * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PQ[b1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PB_1 * PQ[b0] * QD_0 * QC_0 * (-1.0))
                            + delta[c1][d0] * (PB_0 * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PQ[b1] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * QC_0 * (-1.0) + PB_1 * PQ[b0] * QD_1 * QC_0 * (-1.0))
                            + delta[c0][d1] * (PB_0 * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PB_0 * PQ[b1] * PQ[d0] * QC_1 * (-1.0) + PB_0 * PQ[b1] * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * QC_1 * (-1.0) + PB_1 * PQ[b0] * QD_0 * QC_1 * (-1.0))
                            + delta[c0][d0] * (PB_0 * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PB_0 * PQ[b1] * PQ[d1] * QC_1 * (-1.0) + PB_0 * PQ[b1] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * QC_1 * (-1.0) + PB_1 * PQ[b0] * QD_1 * QC_1 * (-1.0))
                            + delta[c0][c1] * (PB_0 * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[b1] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PB_1 * PQ[b0] * QD_0 * QD_1 * (-1.0))
                            + delta[b1][d1] * (PB_0 * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_0 * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[b1][d0] * (PB_0 * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[b1][c1] * (PB_0 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[b1][c0] * (PB_0 * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[b0][d1] * (PB_1 * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_1 * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_1 * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][d0] * (PB_1 * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][c1] * (PB_1 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_1 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[b0][c0] * (PB_1 * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_1 * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_1 * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[b0][b1] * (PQ[c0] * PQ[c1] * QD_0 * QD_1 + PQ[c0] * PQ[d0] * QD_1 * QC_1 + PQ[c0] * PQ[d1] * QD_0 * QC_1 + PQ[c1] * PQ[d0] * QD_1 * QC_0 + PQ[c1] * PQ[d1] * QD_0 * QC_0 + PQ[d0] * PQ[d1] * QC_0 * QC_1)
                        )

                    )

                    +

                    F6_t[2] * (

                        0.5 * S2 / ( S4 * S4 ) * (
                            delta[d0][d1] * (PQ[b0] * PQ[b1] * QC_0 * QC_1)
                            + delta[c1][d1] * (PQ[b0] * PQ[b1] * QD_0 * QC_0)
                            + delta[c1][d0] * (PQ[b0] * PQ[b1] * QD_1 * QC_0)
                            + delta[c0][d1] * (PQ[b0] * PQ[b1] * QD_0 * QC_1)
                            + delta[c0][d0] * (PQ[b0] * PQ[b1] * QD_1 * QC_1)
                            + delta[b1][d1] * (PQ[b0] * QD_0 * QC_0 * QC_1)
                            + delta[b1][d0] * (PQ[b0] * QD_1 * QC_0 * QC_1)
                            + delta[b1][c1] * (PQ[b0] * QD_0 * QD_1 * QC_0)
                            + delta[b1][c0] * (PQ[b0] * QD_0 * QD_1 * QC_1)
                            + delta[b0][d1] * (PQ[b1] * QD_0 * QC_0 * QC_1)
                            + delta[b0][d0] * (PQ[b1] * QD_1 * QC_0 * QC_1)
                            + delta[b0][c1] * (PQ[b1] * QD_0 * QD_1 * QC_0)
                            + delta[b0][c0] * (PQ[b1] * QD_0 * QD_1 * QC_1)
                            + delta[b0][b1] * (PQ[c0] * QD_0 * QD_1 * QC_1 + PQ[c1] * QD_0 * QD_1 * QC_0 + PQ[d0] * QD_1 * QC_0 * QC_1 + PQ[d1] * QD_0 * QC_0 * QC_1)
                            + delta[c0][c1] * (PQ[b0] * PQ[b1] * QD_0 * QD_1)
                        )

                    )

                    +

                    F6_t[2] * (

                        0.125 * S1 / ( S2 * S2 * S4 * S4 ) * (
                            delta[b0][b1] * delta[c0][c1] * delta[d0][d1]
                            + delta[b0][b1] * delta[c0][d0] * delta[c1][d1]
                            + delta[b0][b1] * delta[c1][d0] * delta[c0][d1]
                        )

                    )

                    +

                    F6_t[2] * (

                        0.125 / ( S2 * S4 * S4 ) * (
                            delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * 2.0
                            + delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * 2.0
                            + delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * 2.0
                            + delta[b0][c0] * delta[b1][c1] * delta[d0][d1]
                            + delta[b0][c0] * delta[b1][d0] * delta[c1][d1]
                            + delta[b0][c0] * delta[b1][d1] * delta[c1][d0]
                            + delta[b0][c1] * delta[b1][c0] * delta[d0][d1]
                            + delta[b0][c1] * delta[b1][d0] * delta[c0][d1]
                            + delta[b0][c1] * delta[b1][d1] * delta[c0][d0]
                            + delta[b0][d0] * delta[b1][c0] * delta[c1][d1]
                            + delta[b0][d0] * delta[b1][c1] * delta[c0][d1]
                            + delta[b0][d0] * delta[b1][d1] * delta[c0][c1]
                            + delta[b0][d1] * delta[b1][c0] * delta[c1][d0]
                            + delta[b0][d1] * delta[b1][c1] * delta[c0][d0]
                            + delta[b0][d1] * delta[b1][d0] * delta[c0][c1]
                        )

                    )

                    +

                    F6_t[2] * (

                        0.25 * ( S1 * S1 ) / ( S2 * S2 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PB_1)
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PB_1)
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PB_1)
                        )

                    )

                    +

                    F6_t[3] * (

                        ( S1 * S1 * S1 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PB_1 * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PB_1 * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_0 * PB_1 * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PB_0 * PB_1 * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                        )

                    )

                    +

                    F6_t[3] * (

                        ( S1 * S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            PB_0 * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PB_0 * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PB_0 * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PB_0 * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PB_0 * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PB_0 * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                            + PB_1 * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PB_1 * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PB_1 * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PB_1 * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PB_1 * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PB_1 * PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                        )

                    )

                    +

                    F6_t[3] * (

                        ( S1 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                        )

                    )

                    +

                    F6_t[3] * (

                        0.125 * S1 / ( S2 * S4 * S4 * S4 ) * (
                            delta[b0][b1] * delta[c0][c1] * delta[d0][d1] * (-1.0)
                            + delta[b0][b1] * delta[c0][d0] * delta[c1][d1] * (-1.0)
                            + delta[b0][b1] * delta[c1][d0] * delta[c0][d1] * (-1.0)
                            + delta[b0][c0] * delta[b1][c1] * delta[d0][d1] * (-1.0)
                            + delta[b0][c0] * delta[b1][d0] * delta[c1][d1] * (-1.0)
                            + delta[b0][c0] * delta[b1][d1] * delta[c1][d0] * (-1.0)
                            + delta[b0][c1] * delta[b1][c0] * delta[d0][d1] * (-1.0)
                            + delta[b0][c1] * delta[b1][d0] * delta[c0][d1] * (-1.0)
                            + delta[b0][c1] * delta[b1][d1] * delta[c0][d0] * (-1.0)
                            + delta[b0][d0] * delta[b1][c0] * delta[c1][d1] * (-1.0)
                            + delta[b0][d0] * delta[b1][c1] * delta[c0][d1] * (-1.0)
                            + delta[b0][d0] * delta[b1][d1] * delta[c0][c1] * (-1.0)
                            + delta[b0][d1] * delta[b1][c0] * delta[c1][d0] * (-1.0)
                            + delta[b0][d1] * delta[b1][c1] * delta[c0][d0] * (-1.0)
                            + delta[b0][d1] * delta[b1][d0] * delta[c0][c1] * (-1.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < sd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockSDDD3(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   sd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* sd_first_inds_local,
                       const uint32_t* sd_second_inds_local,
                       const uint32_t  sd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < sd_prim_pair_count_local) && (fabs(sd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = sd_first_inds_local[ij];
            const auto j = sd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = s_prim_info[i + s_prim_count * 0];
            const auto c_i = s_prim_info[i + s_prim_count * 1];
            const auto x_i = s_prim_info[i + s_prim_count * 2];
            const auto y_i = s_prim_info[i + s_prim_count * 3];
            const auto z_i = s_prim_info[i + s_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[4];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[3] * (

                        0.25 * ( S1 * S1 ) / ( S2 * S4 * S4 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PQ[c0] * PQ[c1] * (-1.0))
                            + delta[b0][b1] * delta[c1][d1] * (PQ[c0] * PQ[d0] * (-1.0))
                            + delta[b0][b1] * delta[c1][d0] * (PQ[c0] * PQ[d1] * (-1.0))
                            + delta[b0][b1] * delta[c0][d1] * (PQ[c1] * PQ[d0] * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * (PQ[c1] * PQ[d1] * (-1.0))
                            + delta[b0][b1] * delta[c0][c1] * (PQ[d0] * PQ[d1] * (-1.0))
                            + delta[c0][c1] * delta[d0][d1] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[b1][c1] * delta[d0][d1] * (PB_0 * PQ[c0])
                            + delta[b1][d0] * delta[c1][d1] * (PB_0 * PQ[c0])
                            + delta[b1][d1] * delta[c1][d0] * (PB_0 * PQ[c0])
                            + delta[b1][c0] * delta[d0][d1] * (PB_0 * PQ[c1])
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * PQ[c1])
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * PQ[c1])
                            + delta[b1][c0] * delta[c1][d1] * (PB_0 * PQ[d0])
                            + delta[b1][c1] * delta[c0][d1] * (PB_0 * PQ[d0])
                            + delta[b1][d1] * delta[c0][c1] * (PB_0 * PQ[d0])
                            + delta[b1][c0] * delta[c1][d0] * (PB_0 * PQ[d1])
                            + delta[b1][c1] * delta[c0][d0] * (PB_0 * PQ[d1])
                            + delta[b1][d0] * delta[c0][c1] * (PB_0 * PQ[d1])
                            + delta[b0][c1] * delta[d0][d1] * (PB_1 * PQ[c0])
                            + delta[b0][d0] * delta[c1][d1] * (PB_1 * PQ[c0])
                            + delta[b0][d1] * delta[c1][d0] * (PB_1 * PQ[c0])
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * PQ[c1])
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * PQ[c1])
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * PQ[c1])
                            + delta[b0][c0] * delta[c1][d1] * (PB_1 * PQ[d0])
                            + delta[b0][c1] * delta[c0][d1] * (PB_1 * PQ[d0])
                            + delta[b0][d1] * delta[c0][c1] * (PB_1 * PQ[d0])
                            + delta[b0][c0] * delta[c1][d0] * (PB_1 * PQ[d1])
                            + delta[b0][c1] * delta[c0][d0] * (PB_1 * PQ[d1])
                            + delta[b0][d0] * delta[c0][c1] * (PB_1 * PQ[d1])
                        )

                    )

                    +

                    F6_t[3] * (

                        0.25 * S1 / ( S4 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PQ[b0] * PQ[b1] * (-2.0))
                            + delta[c0][d0] * delta[c1][d1] * (PQ[b0] * PQ[b1] * (-2.0))
                            + delta[c1][d0] * delta[c0][d1] * (PQ[b0] * PQ[b1] * (-2.0))
                            + delta[b1][c1] * delta[d0][d1] * (PQ[b0] * PQ[c0] * (-1.0) + PQ[b0] * QC_0 * (-1.0))
                            + delta[b1][d0] * delta[c1][d1] * (PQ[b0] * PQ[c0] * (-1.0) + PQ[b0] * QC_0 * (-1.0))
                            + delta[b1][d1] * delta[c1][d0] * (PQ[b0] * PQ[c0] * (-1.0) + PQ[b0] * QC_0 * (-1.0))
                            + delta[b1][c0] * delta[d0][d1] * (PQ[b0] * PQ[c1] * (-1.0) + PQ[b0] * QC_1 * (-1.0))
                            + delta[b1][d0] * delta[c0][d1] * (PQ[b0] * PQ[c1] * (-1.0) + PQ[b0] * QC_1 * (-1.0))
                            + delta[b1][d1] * delta[c0][d0] * (PQ[b0] * PQ[c1] * (-1.0) + PQ[b0] * QC_1 * (-1.0))
                            + delta[b1][c0] * delta[c1][d1] * (PQ[b0] * PQ[d0] * (-1.0) + PQ[b0] * QD_0 * (-1.0))
                            + delta[b1][c1] * delta[c0][d1] * (PQ[b0] * PQ[d0] * (-1.0) + PQ[b0] * QD_0 * (-1.0))
                            + delta[b1][d1] * delta[c0][c1] * (PQ[b0] * PQ[d0] * (-1.0) + PQ[b0] * QD_0 * (-1.0))
                            + delta[b1][c0] * delta[c1][d0] * (PQ[b0] * PQ[d1] * (-1.0) + PQ[b0] * QD_1 * (-1.0))
                            + delta[b1][c1] * delta[c0][d0] * (PQ[b0] * PQ[d1] * (-1.0) + PQ[b0] * QD_1 * (-1.0))
                            + delta[b1][d0] * delta[c0][c1] * (PQ[b0] * PQ[d1] * (-1.0) + PQ[b0] * QD_1 * (-1.0))
                            + delta[b0][c1] * delta[d0][d1] * (PQ[b1] * PQ[c0] * (-1.0) + PQ[b1] * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[c1][d1] * (PQ[b1] * PQ[c0] * (-1.0) + PQ[b1] * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[c1][d0] * (PQ[b1] * PQ[c0] * (-1.0) + PQ[b1] * QC_0 * (-1.0))
                            + delta[b0][c0] * delta[d0][d1] * (PQ[b1] * PQ[c1] * (-1.0) + PQ[b1] * QC_1 * (-1.0))
                            + delta[b0][d0] * delta[c0][d1] * (PQ[b1] * PQ[c1] * (-1.0) + PQ[b1] * QC_1 * (-1.0))
                            + delta[b0][d1] * delta[c0][d0] * (PQ[b1] * PQ[c1] * (-1.0) + PQ[b1] * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[c1][d1] * (PQ[b1] * PQ[d0] * (-1.0) + PQ[b1] * QD_0 * (-1.0))
                            + delta[b0][c1] * delta[c0][d1] * (PQ[b1] * PQ[d0] * (-1.0) + PQ[b1] * QD_0 * (-1.0))
                            + delta[b0][d1] * delta[c0][c1] * (PQ[b1] * PQ[d0] * (-1.0) + PQ[b1] * QD_0 * (-1.0))
                            + delta[b0][c0] * delta[c1][d0] * (PQ[b1] * PQ[d1] * (-1.0) + PQ[b1] * QD_1 * (-1.0))
                            + delta[b0][c1] * delta[c0][d0] * (PQ[b1] * PQ[d1] * (-1.0) + PQ[b1] * QD_1 * (-1.0))
                            + delta[b0][d0] * delta[c0][c1] * (PQ[b1] * PQ[d1] * (-1.0) + PQ[b1] * QD_1 * (-1.0))
                            + delta[b0][b1] * delta[d0][d1] * (PQ[c0] * PQ[c1] * (-1.0) + PQ[c0] * QC_1 * (-1.0) + PQ[c1] * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c1][d1] * (PQ[c0] * PQ[d0] * (-1.0) + PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c1][d0] * (PQ[c0] * PQ[d1] * (-1.0) + PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[b1][d1] * (PQ[c0] * QC_1 * (-1.0) + PQ[c1] * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[b1][d0] * (PQ[c0] * QC_1 * (-1.0) + PQ[c1] * QC_0 * (-1.0))
                            + delta[b0][c1] * delta[b1][d1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[b1][c1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][c1] * delta[b1][d0] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[b1][c1] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c0][d1] * (PQ[c1] * PQ[d0] * (-1.0) + PQ[c1] * QD_0 * (-1.0) + PQ[d0] * QC_1 * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * (PQ[c1] * PQ[d1] * (-1.0) + PQ[c1] * QD_1 * (-1.0) + PQ[d1] * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[b1][d1] * (PQ[c1] * QD_0 * (-1.0) + PQ[d0] * QC_1 * (-1.0))
                            + delta[b0][d1] * delta[b1][c0] * (PQ[c1] * QD_0 * (-1.0) + PQ[d0] * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[b1][d0] * (PQ[c1] * QD_1 * (-1.0) + PQ[d1] * QC_1 * (-1.0))
                            + delta[b0][d0] * delta[b1][c0] * (PQ[c1] * QD_1 * (-1.0) + PQ[d1] * QC_1 * (-1.0))
                            + delta[b0][b1] * delta[c0][c1] * (PQ[d0] * PQ[d1] * (-1.0) + PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][c0] * delta[b1][c1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][c1] * delta[b1][c0] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                        )

                    )

                    +

                    F6_t[3] * (

                        0.5 * ( S1 * S1 ) / ( S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[b1] * PQ[c0] * PQ[c1] + PB_0 * PQ[b1] * PQ[c0] * QC_1 + PB_0 * PQ[b1] * PQ[c1] * QC_0 + PB_1 * PQ[b0] * PQ[c0] * PQ[c1] + PB_1 * PQ[b0] * PQ[c0] * QC_1 + PB_1 * PQ[b0] * PQ[c1] * QC_0)
                            + delta[c1][d1] * (PB_0 * PQ[b1] * PQ[c0] * PQ[d0] + PB_0 * PQ[b1] * PQ[c0] * QD_0 + PB_0 * PQ[b1] * PQ[d0] * QC_0 + PB_1 * PQ[b0] * PQ[c0] * PQ[d0] + PB_1 * PQ[b0] * PQ[c0] * QD_0 + PB_1 * PQ[b0] * PQ[d0] * QC_0)
                            + delta[c0][d1] * (PB_0 * PQ[b1] * PQ[c1] * PQ[d0] + PB_0 * PQ[b1] * PQ[c1] * QD_0 + PB_0 * PQ[b1] * PQ[d0] * QC_1 + PB_1 * PQ[b0] * PQ[c1] * PQ[d0] + PB_1 * PQ[b0] * PQ[c1] * QD_0 + PB_1 * PQ[b0] * PQ[d0] * QC_1)
                            + delta[c1][d0] * (PB_0 * PQ[b1] * PQ[c0] * PQ[d1] + PB_0 * PQ[b1] * PQ[c0] * QD_1 + PB_0 * PQ[b1] * PQ[d1] * QC_0 + PB_1 * PQ[b0] * PQ[c0] * PQ[d1] + PB_1 * PQ[b0] * PQ[c0] * QD_1 + PB_1 * PQ[b0] * PQ[d1] * QC_0)
                            + delta[c0][d0] * (PB_0 * PQ[b1] * PQ[c1] * PQ[d1] + PB_0 * PQ[b1] * PQ[c1] * QD_1 + PB_0 * PQ[b1] * PQ[d1] * QC_1 + PB_1 * PQ[b0] * PQ[c1] * PQ[d1] + PB_1 * PQ[b0] * PQ[c1] * QD_1 + PB_1 * PQ[b0] * PQ[d1] * QC_1)
                            + delta[b1][d1] * (PB_0 * PQ[c0] * PQ[c1] * QD_0 + PB_0 * PQ[c0] * PQ[d0] * QC_1 + PB_0 * PQ[c1] * PQ[d0] * QC_0)
                            + delta[b1][d0] * (PB_0 * PQ[c0] * PQ[c1] * QD_1 + PB_0 * PQ[c0] * PQ[d1] * QC_1 + PB_0 * PQ[c1] * PQ[d1] * QC_0)
                            + delta[b1][c1] * (PB_0 * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[b1][c0] * (PB_0 * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PQ[d0] * PQ[d1] * QC_1)
                            + delta[b0][d1] * (PB_1 * PQ[c0] * PQ[c1] * QD_0 + PB_1 * PQ[c0] * PQ[d0] * QC_1 + PB_1 * PQ[c1] * PQ[d0] * QC_0)
                            + delta[b0][d0] * (PB_1 * PQ[c0] * PQ[c1] * QD_1 + PB_1 * PQ[c0] * PQ[d1] * QC_1 + PB_1 * PQ[c1] * PQ[d1] * QC_0)
                            + delta[b0][c1] * (PB_1 * PQ[c0] * PQ[d0] * QD_1 + PB_1 * PQ[c0] * PQ[d1] * QD_0 + PB_1 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[b0][c0] * (PB_1 * PQ[c1] * PQ[d0] * QD_1 + PB_1 * PQ[c1] * PQ[d1] * QD_0 + PB_1 * PQ[d0] * PQ[d1] * QC_1)
                            + delta[b0][b1] * (PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[c0][c1] * (PB_0 * PQ[b1] * PQ[d0] * PQ[d1] + PB_0 * PQ[b1] * PQ[d0] * QD_1 + PB_0 * PQ[b1] * PQ[d1] * QD_0 + PB_1 * PQ[b0] * PQ[d0] * PQ[d1] + PB_1 * PQ[b0] * PQ[d0] * QD_1 + PB_1 * PQ[b0] * PQ[d1] * QD_0)
                        )

                    )

                    +

                    F6_t[3] * (

                        0.5 * ( S1 * S1 * S1 ) / ( S2 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PQ[c0] * PQ[c1] * (-1.0))
                            + delta[c1][d1] * (PB_0 * PB_1 * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[c1][d0] * (PB_0 * PB_1 * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[c0][d1] * (PB_0 * PB_1 * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[c0][d0] * (PB_0 * PB_1 * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[c0][c1] * (PB_0 * PB_1 * PQ[d0] * PQ[d1] * (-1.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < sd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockSDDD4(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   sd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* sd_first_inds_local,
                       const uint32_t* sd_second_inds_local,
                       const uint32_t  sd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < sd_prim_pair_count_local) && (fabs(sd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = sd_first_inds_local[ij];
            const auto j = sd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = s_prim_info[i + s_prim_count * 0];
            const auto c_i = s_prim_info[i + s_prim_count * 1];
            const auto x_i = s_prim_info[i + s_prim_count * 2];
            const auto y_i = s_prim_info[i + s_prim_count * 3];
            const auto z_i = s_prim_info[i + s_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[5];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[3] * (

                        0.5 * ( S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * QC_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[c1] * QC_0 * (-1.0) + PQ[b0] * PQ[b1] * QC_0 * QC_1 * (-1.0))
                            + delta[c1][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0) + PQ[b0] * PQ[b1] * QD_0 * QC_0 * (-1.0))
                            + delta[c1][d0] * (PQ[b0] * PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d1] * QC_0 * (-1.0) + PQ[b0] * PQ[b1] * QD_1 * QC_0 * (-1.0))
                            + delta[c0][d1] * (PQ[b0] * PQ[b1] * PQ[c1] * QD_0 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d0] * QC_1 * (-1.0) + PQ[b0] * PQ[b1] * QD_0 * QC_1 * (-1.0))
                            + delta[c0][d0] * (PQ[b0] * PQ[b1] * PQ[c1] * QD_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d1] * QC_1 * (-1.0) + PQ[b0] * PQ[b1] * QD_1 * QC_1 * (-1.0))
                            + delta[c0][c1] * (PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0) + PQ[b0] * PQ[b1] * QD_0 * QD_1 * (-1.0))
                            + delta[b1][d1] * (PQ[b0] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PQ[b0] * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[b1][d0] * (PQ[b0] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PQ[b0] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[b1][c1] * (PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[b1][c0] * (PQ[b0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[b0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[b0] * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[b0][d1] * (PQ[b1] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PQ[b1] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PQ[b1] * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][d0] * (PQ[b1] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PQ[b1] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PQ[b1] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][c1] * (PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[b0][c0] * (PQ[b1] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[b1] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[b1] * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[b0][b1] * (PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                        )

                    )

                    +

                    F6_t[4] * (

                        ( S1 * S1 * S1 * S1 ) / ( S4 * S4 * S4 * S4 ) * (
                            PB_0 * PB_1 * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                        )

                    )

                    +

                    F6_t[4] * (

                        ( S1 * S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_0 * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PB_0 * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                            + PB_1 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_1 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_1 * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PB_1 * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                        )

                    )

                    +

                    F6_t[4] * (

                        ( S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                        )

                    )

                    +

                    F6_t[4] * (

                        0.5 * ( S1 * S1 * S1 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[b1] * PQ[c0] * PQ[c1] * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * PQ[c1] * (-1.0))
                            + delta[c1][d1] * (PB_0 * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[c1][d0] * (PB_0 * PQ[b1] * PQ[c0] * PQ[d1] * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[c0][d1] * (PB_0 * PQ[b1] * PQ[c1] * PQ[d0] * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[c0][d0] * (PB_0 * PQ[b1] * PQ[c1] * PQ[d1] * (-1.0) + PB_1 * PQ[b0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[c0][c1] * (PB_0 * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b1][d1] * (PB_0 * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[b1][d0] * (PB_0 * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[b1][c1] * (PB_0 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b1][c0] * (PB_0 * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][d1] * (PB_1 * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PB_1 * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[b0][c1] * (PB_1 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][c0] * (PB_1 * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][b1] * (PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                        )

                    )

                    +

                    F6_t[4] * (

                        0.5 * ( S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] + PQ[b0] * PQ[b1] * PQ[c0] * QC_1 + PQ[b0] * PQ[b1] * PQ[c1] * QC_0)
                            + delta[c1][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] + PQ[b0] * PQ[b1] * PQ[c0] * QD_0 + PQ[b0] * PQ[b1] * PQ[d0] * QC_0)
                            + delta[c0][d1] * (PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] + PQ[b0] * PQ[b1] * PQ[c1] * QD_0 + PQ[b0] * PQ[b1] * PQ[d0] * QC_1)
                            + delta[c1][d0] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] + PQ[b0] * PQ[b1] * PQ[c0] * QD_1 + PQ[b0] * PQ[b1] * PQ[d1] * QC_0)
                            + delta[c0][d0] * (PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] + PQ[b0] * PQ[b1] * PQ[c1] * QD_1 + PQ[b0] * PQ[b1] * PQ[d1] * QC_1)
                            + delta[b1][d1] * (PQ[b0] * PQ[c0] * PQ[c1] * QD_0 + PQ[b0] * PQ[c0] * PQ[d0] * QC_1 + PQ[b0] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[b1][d0] * (PQ[b0] * PQ[c0] * PQ[c1] * QD_1 + PQ[b0] * PQ[c0] * PQ[d1] * QC_1 + PQ[b0] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[b1][c1] * (PQ[b0] * PQ[c0] * PQ[d0] * QD_1 + PQ[b0] * PQ[c0] * PQ[d1] * QD_0 + PQ[b0] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[b1][c0] * (PQ[b0] * PQ[c1] * PQ[d0] * QD_1 + PQ[b0] * PQ[c1] * PQ[d1] * QD_0 + PQ[b0] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[b0][d1] * (PQ[b1] * PQ[c0] * PQ[c1] * QD_0 + PQ[b1] * PQ[c0] * PQ[d0] * QC_1 + PQ[b1] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[b0][d0] * (PQ[b1] * PQ[c0] * PQ[c1] * QD_1 + PQ[b1] * PQ[c0] * PQ[d1] * QC_1 + PQ[b1] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[b0][c1] * (PQ[b1] * PQ[c0] * PQ[d0] * QD_1 + PQ[b1] * PQ[c0] * PQ[d1] * QD_0 + PQ[b1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[b0][c0] * (PQ[b1] * PQ[c1] * PQ[d0] * QD_1 + PQ[b1] * PQ[c1] * PQ[d1] * QD_0 + PQ[b1] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[b0][b1] * (PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PQ[c1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[c0][c1] * (PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] + PQ[b0] * PQ[b1] * PQ[d0] * QD_1 + PQ[b0] * PQ[b1] * PQ[d1] * QD_0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < sd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockSDDD5(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   sd_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* sd_first_inds_local,
                       const uint32_t* sd_second_inds_local,
                       const uint32_t  sd_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < sd_prim_pair_count_local) && (fabs(sd_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = sd_first_inds_local[ij];
            const auto j = sd_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = s_prim_info[i + s_prim_count * 0];
            const auto c_i = s_prim_info[i + s_prim_count * 1];
            const auto x_i = s_prim_info[i + s_prim_count * 2];
            const auto y_i = s_prim_info[i + s_prim_count * 3];
            const auto z_i = s_prim_info[i + s_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[7];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 6, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[4] * (

                        0.25 * ( S1 * S1 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PQ[b0] * PQ[b1])
                            + delta[c0][d0] * delta[c1][d1] * (PQ[b0] * PQ[b1])
                            + delta[c1][d0] * delta[c0][d1] * (PQ[b0] * PQ[b1])
                            + delta[b1][c1] * delta[d0][d1] * (PQ[b0] * PQ[c0])
                            + delta[b1][d0] * delta[c1][d1] * (PQ[b0] * PQ[c0])
                            + delta[b1][d1] * delta[c1][d0] * (PQ[b0] * PQ[c0])
                            + delta[b1][c0] * delta[d0][d1] * (PQ[b0] * PQ[c1])
                            + delta[b1][d0] * delta[c0][d1] * (PQ[b0] * PQ[c1])
                            + delta[b1][d1] * delta[c0][d0] * (PQ[b0] * PQ[c1])
                            + delta[b1][c0] * delta[c1][d1] * (PQ[b0] * PQ[d0])
                            + delta[b1][c1] * delta[c0][d1] * (PQ[b0] * PQ[d0])
                            + delta[b1][d1] * delta[c0][c1] * (PQ[b0] * PQ[d0])
                            + delta[b1][c0] * delta[c1][d0] * (PQ[b0] * PQ[d1])
                            + delta[b1][c1] * delta[c0][d0] * (PQ[b0] * PQ[d1])
                            + delta[b1][d0] * delta[c0][c1] * (PQ[b0] * PQ[d1])
                            + delta[b0][c1] * delta[d0][d1] * (PQ[b1] * PQ[c0])
                            + delta[b0][d0] * delta[c1][d1] * (PQ[b1] * PQ[c0])
                            + delta[b0][d1] * delta[c1][d0] * (PQ[b1] * PQ[c0])
                            + delta[b0][c0] * delta[d0][d1] * (PQ[b1] * PQ[c1])
                            + delta[b0][d0] * delta[c0][d1] * (PQ[b1] * PQ[c1])
                            + delta[b0][d1] * delta[c0][d0] * (PQ[b1] * PQ[c1])
                            + delta[b0][c0] * delta[c1][d1] * (PQ[b1] * PQ[d0])
                            + delta[b0][c1] * delta[c0][d1] * (PQ[b1] * PQ[d0])
                            + delta[b0][d1] * delta[c0][c1] * (PQ[b1] * PQ[d0])
                            + delta[b0][c0] * delta[c1][d0] * (PQ[b1] * PQ[d1])
                            + delta[b0][c1] * delta[c0][d0] * (PQ[b1] * PQ[d1])
                            + delta[b0][d0] * delta[c0][c1] * (PQ[b1] * PQ[d1])
                            + delta[b0][b1] * delta[d0][d1] * (PQ[c0] * PQ[c1])
                            + delta[b0][d0] * delta[b1][d1] * (PQ[c0] * PQ[c1])
                            + delta[b0][d1] * delta[b1][d0] * (PQ[c0] * PQ[c1])
                            + delta[b0][b1] * delta[c1][d1] * (PQ[c0] * PQ[d0])
                            + delta[b0][c1] * delta[b1][d1] * (PQ[c0] * PQ[d0])
                            + delta[b0][d1] * delta[b1][c1] * (PQ[c0] * PQ[d0])
                            + delta[b0][b1] * delta[c1][d0] * (PQ[c0] * PQ[d1])
                            + delta[b0][c1] * delta[b1][d0] * (PQ[c0] * PQ[d1])
                            + delta[b0][d0] * delta[b1][c1] * (PQ[c0] * PQ[d1])
                            + delta[b0][b1] * delta[c0][d1] * (PQ[c1] * PQ[d0])
                            + delta[b0][c0] * delta[b1][d1] * (PQ[c1] * PQ[d0])
                            + delta[b0][d1] * delta[b1][c0] * (PQ[c1] * PQ[d0])
                            + delta[b0][b1] * delta[c0][d0] * (PQ[c1] * PQ[d1])
                            + delta[b0][c0] * delta[b1][d0] * (PQ[c1] * PQ[d1])
                            + delta[b0][d0] * delta[b1][c0] * (PQ[c1] * PQ[d1])
                            + delta[b0][b1] * delta[c0][c1] * (PQ[d0] * PQ[d1])
                            + delta[b0][c0] * delta[b1][c1] * (PQ[d0] * PQ[d1])
                            + delta[b0][c1] * delta[b1][c0] * (PQ[d0] * PQ[d1])
                        )

                    )

                    +

                    F6_t[5] * (

                        ( S1 * S1 * S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            PB_0 * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                            + PB_1 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                        )

                    )

                    +

                    F6_t[5] * (

                        ( S1 * S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            
                            + PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                        )

                    )

                    +

                    F6_t[5] * (

                        0.5 * ( S1 * S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * (-1.0))
                            + delta[c1][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[c1][d0] * (PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[c0][d1] * (PQ[b0] * PQ[b1] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[c0][d0] * (PQ[b0] * PQ[b1] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[c0][c1] * (PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b1][d1] * (PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[b1][d0] * (PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[b1][c1] * (PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b1][c0] * (PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][d1] * (PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PQ[b1] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[b0][c1] * (PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][c0] * (PQ[b1] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][b1] * (PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                        )

                    )

                    +

                    F6_t[6] * (

                        ( S1 * S1 * S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 * S4 ) * (
                            PQ[b0] * PQ[b1] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < sd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockSDPD0(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   sd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* sd_first_inds_local,
                       const uint32_t* sd_second_inds_local,
                       const uint32_t  sd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < sd_prim_pair_count_local) && (fabs(sd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = sd_first_inds_local[ij];
            const auto j = sd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = s_prim_info[i + s_prim_count * 0];
            const auto c_i = s_prim_info[i + s_prim_count * 1];
            const auto x_i = s_prim_info[i + s_prim_count * 2];
            const auto y_i = s_prim_info[i + s_prim_count * 3];
            const auto z_i = s_prim_info[i + s_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F5_t[3];

            gpu::computeBoysFunction(F5_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F5_t[0] * (

                        0.25 / ( S1 * S2 ) * (
                            delta[b0][b1] * delta[d0][d1] * QC_0
                            + delta[b0][b1] * delta[c0][d1] * QD_0
                            + delta[b0][b1] * delta[c0][d0] * QD_1
                        )

                    )

                    +

                    F5_t[0] * (

                        0.5 / S1 * (
                            delta[b0][b1] * (QD_0 * QD_1 * QC_0)
                        )

                    )

                    +

                    F5_t[0] * (

                        0.5 / S2 * (
                            delta[d0][d1] * (PB_0 * PB_1 * QC_0)
                            + delta[c0][d1] * (PB_0 * PB_1 * QD_0)
                            + delta[c0][d0] * (PB_0 * PB_1 * QD_1)
                        )

                    )

                    +

                    F5_t[0] * (

                        (
                            
                            + PB_0 * PB_1 * QD_0 * QD_1 * QC_0
                        )

                    )

                    +

                    F5_t[1] * (

                        0.25 / ( S1 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c0][d1] * (QD_0 * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * (QD_1 * (-1.0))
                        )

                    )

                    +

                    F5_t[1] * (

                        0.25 / ( S2 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PQ[c0] * (-1.0) + QC_0 * (-1.0))
                            + delta[b0][b1] * delta[c0][d1] * (PQ[d0] * (-1.0) + QD_0 * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * (PQ[d1] * (-1.0) + QD_1 * (-1.0))
                            + delta[b1][c0] * delta[d0][d1] * PB_0
                            + delta[b1][d0] * delta[c0][d1] * PB_0
                            + delta[b1][d1] * delta[c0][d0] * PB_0
                            + delta[b0][c0] * delta[d0][d1] * PB_1
                            + delta[b0][d0] * delta[c0][d1] * PB_1
                            + delta[b0][d1] * delta[c0][d0] * PB_1
                        )

                    )

                    +

                    F5_t[1] * (

                        0.5 * S1 / ( S2 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PQ[c0] * (-1.0) + PB_0 * PB_1 * QC_0 * (-1.0))
                            + delta[c0][d1] * (PB_0 * PB_1 * PQ[d0] * (-1.0) + PB_0 * PB_1 * QD_0 * (-1.0))
                            + delta[c0][d0] * (PB_0 * PB_1 * PQ[d1] * (-1.0) + PB_0 * PB_1 * QD_1 * (-1.0))
                        )

                    )

                    +

                    F5_t[1] * (

                        0.5 * S2 / ( S1 * S4 ) * (
                            delta[b0][b1] * (QD_0 * QD_1 * QC_0 * (-1.0))
                        )

                    )

                    +

                    F5_t[1] * (

                        0.5 / S4 * (
                            delta[d0][d1] * (PB_0 * PQ[b1] * QC_0 + PB_1 * PQ[b0] * QC_0)
                            + delta[b1][d1] * (PB_0 * QD_0 * QC_0)
                            + delta[b1][d0] * (PB_0 * QD_1 * QC_0)
                            + delta[b0][d1] * (PB_1 * QD_0 * QC_0)
                            + delta[b0][d0] * (PB_1 * QD_1 * QC_0)
                            + delta[b0][b1] * (PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[c0][d1] * (PB_0 * PQ[b1] * QD_0 + PB_1 * PQ[b0] * QD_0)
                            + delta[c0][d0] * (PB_0 * PQ[b1] * QD_1 + PB_1 * PQ[b0] * QD_1)
                            + delta[b1][c0] * (PB_0 * QD_0 * QD_1)
                            + delta[b0][c0] * (PB_1 * QD_0 * QD_1)
                        )

                    )

                    +

                    F5_t[1] * (

                        S1 / S4 * (
                            PB_0 * PB_1 * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PB_0 * PB_1 * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PB_1 * PQ[d1] * QD_0 * QC_0 * (-1.0)
                        )

                    )

                    +

                    F5_t[1] * (

                        S2 / S4 * (
                            
                            + PB_0 * PQ[b1] * QD_0 * QD_1 * QC_0
                            + PB_1 * PQ[b0] * QD_0 * QD_1 * QC_0
                        )

                    )

                    +

                    F5_t[2] * (

                        ( S1 * S1 ) / ( S4 * S4 ) * (
                            PB_0 * PB_1 * PQ[c0] * PQ[d0] * QD_1
                            + PB_0 * PB_1 * PQ[c0] * PQ[d1] * QD_0
                            + PB_0 * PB_1 * PQ[d0] * PQ[d1] * QC_0
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < sd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockSDPD1(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   sd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* sd_first_inds_local,
                       const uint32_t* sd_second_inds_local,
                       const uint32_t  sd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < sd_prim_pair_count_local) && (fabs(sd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = sd_first_inds_local[ij];
            const auto j = sd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = s_prim_info[i + s_prim_count * 0];
            const auto c_i = s_prim_info[i + s_prim_count * 1];
            const auto x_i = s_prim_info[i + s_prim_count * 2];
            const auto y_i = s_prim_info[i + s_prim_count * 3];
            const auto z_i = s_prim_info[i + s_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F5_t[4];

            gpu::computeBoysFunction(F5_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F5_t[2] * (

                        ( S1 * S2 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PB_0 * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                            + PB_1 * PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PB_1 * PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PB_1 * PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                        )

                    )

                    +

                    F5_t[2] * (

                        ( S2 * S2 ) / ( S4 * S4 ) * (
                            
                            + PQ[b0] * PQ[b1] * QD_0 * QD_1 * QC_0
                        )

                    )

                    +

                    F5_t[2] * (

                        0.25 * S1 / ( S2 * S4 * S4 ) * (
                            delta[b1][c0] * delta[d0][d1] * (PB_0 * (-1.0))
                            + delta[b1][d0] * delta[c0][d1] * (PB_0 * (-1.0))
                            + delta[b1][d1] * delta[c0][d0] * (PB_0 * (-1.0))
                            + delta[b0][c0] * delta[d0][d1] * (PB_1 * (-1.0))
                            + delta[b0][d0] * delta[c0][d1] * (PB_1 * (-1.0))
                            + delta[b0][d1] * delta[c0][d0] * (PB_1 * (-1.0))
                            + delta[b0][b1] * delta[d0][d1] * (PQ[c0])
                            + delta[b0][b1] * delta[c0][d1] * (PQ[d0])
                            + delta[b0][b1] * delta[c0][d0] * (PQ[d1])
                        )

                    )

                    +

                    F5_t[2] * (

                        0.25 / ( S4 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (PQ[c0] + QC_0)
                            + delta[b0][d0] * delta[b1][d1] * QC_0
                            + delta[b0][d1] * delta[b1][d0] * QC_0
                            + delta[b1][c0] * delta[d0][d1] * (PQ[b0])
                            + delta[b1][d0] * delta[c0][d1] * (PQ[b0])
                            + delta[b1][d1] * delta[c0][d0] * (PQ[b0])
                            + delta[b0][c0] * delta[d0][d1] * (PQ[b1])
                            + delta[b0][d0] * delta[c0][d1] * (PQ[b1])
                            + delta[b0][d1] * delta[c0][d0] * (PQ[b1])
                            + delta[b0][b1] * delta[c0][d1] * (PQ[d0] + QD_0)
                            + delta[b0][b1] * delta[c0][d0] * (PQ[d1] + QD_1)
                            + delta[b0][c0] * delta[b1][d1] * QD_0
                            + delta[b0][d1] * delta[b1][c0] * QD_0
                            + delta[b0][c0] * delta[b1][d0] * QD_1
                            + delta[b0][d0] * delta[b1][c0] * QD_1
                        )

                    )

                    +

                    F5_t[2] * (

                        0.5 * S1 / ( S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[b1] * PQ[c0] * (-1.0) + PB_0 * PQ[b1] * QC_0 * (-1.0) + PB_1 * PQ[b0] * PQ[c0] * (-1.0) + PB_1 * PQ[b0] * QC_0 * (-1.0))
                            + delta[c0][d1] * (PB_0 * PQ[b1] * PQ[d0] * (-1.0) + PB_0 * PQ[b1] * QD_0 * (-1.0) + PB_1 * PQ[b0] * PQ[d0] * (-1.0) + PB_1 * PQ[b0] * QD_0 * (-1.0))
                            + delta[c0][d0] * (PB_0 * PQ[b1] * PQ[d1] * (-1.0) + PB_0 * PQ[b1] * QD_1 * (-1.0) + PB_1 * PQ[b0] * PQ[d1] * (-1.0) + PB_1 * PQ[b0] * QD_1 * (-1.0))
                            + delta[b1][d1] * (PB_0 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[d0] * QC_0 * (-1.0))
                            + delta[b1][d0] * (PB_0 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[d1] * QC_0 * (-1.0))
                            + delta[b1][c0] * (PB_0 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][d1] * (PB_1 * PQ[c0] * QD_0 * (-1.0) + PB_1 * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][d0] * (PB_1 * PQ[c0] * QD_1 * (-1.0) + PB_1 * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][c0] * (PB_1 * PQ[d0] * QD_1 * (-1.0) + PB_1 * PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][b1] * (PQ[c0] * PQ[d0] * QD_1 + PQ[c0] * PQ[d1] * QD_0 + PQ[d0] * PQ[d1] * QC_0)
                        )

                    )

                    +

                    F5_t[2] * (

                        0.5 * S2 / ( S4 * S4 ) * (
                            delta[d0][d1] * (PQ[b0] * PQ[b1] * QC_0)
                            + delta[b1][d1] * (PQ[b0] * QD_0 * QC_0)
                            + delta[b1][d0] * (PQ[b0] * QD_1 * QC_0)
                            + delta[b0][d1] * (PQ[b1] * QD_0 * QC_0)
                            + delta[b0][d0] * (PQ[b1] * QD_1 * QC_0)
                            + delta[b0][b1] * (PQ[c0] * QD_0 * QD_1 + PQ[d0] * QD_1 * QC_0 + PQ[d1] * QD_0 * QC_0)
                            + delta[c0][d1] * (PQ[b0] * PQ[b1] * QD_0)
                            + delta[c0][d0] * (PQ[b0] * PQ[b1] * QD_1)
                            + delta[b1][c0] * (PQ[b0] * QD_0 * QD_1)
                            + delta[b0][c0] * (PQ[b1] * QD_0 * QD_1)
                        )

                    )

                    +

                    F5_t[2] * (

                        0.5 * ( S1 * S1 ) / ( S2 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * PQ[c0])
                            + delta[c0][d1] * (PB_0 * PB_1 * PQ[d0])
                            + delta[c0][d0] * (PB_0 * PB_1 * PQ[d1])
                        )

                    )

                    +

                    F5_t[3] * (

                        ( S1 * S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            PB_0 * PQ[b1] * PQ[c0] * PQ[d0] * QD_1
                            + PB_0 * PQ[b1] * PQ[c0] * PQ[d1] * QD_0
                            + PB_0 * PQ[b1] * PQ[d0] * PQ[d1] * QC_0
                            + PB_1 * PQ[b0] * PQ[c0] * PQ[d0] * QD_1
                            + PB_1 * PQ[b0] * PQ[c0] * PQ[d1] * QD_0
                            + PB_1 * PQ[b0] * PQ[d0] * PQ[d1] * QC_0
                        )

                    )

                    +

                    F5_t[3] * (

                        ( S1 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < sd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockSDPD2(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   sd_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* sd_first_inds_local,
                       const uint32_t* sd_second_inds_local,
                       const uint32_t  sd_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < sd_prim_pair_count_local) && (fabs(sd_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = sd_first_inds_local[ij];
            const auto j = sd_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = s_prim_info[i + s_prim_count * 0];
            const auto c_i = s_prim_info[i + s_prim_count * 1];
            const auto x_i = s_prim_info[i + s_prim_count * 2];
            const auto y_i = s_prim_info[i + s_prim_count * 3];
            const auto z_i = s_prim_info[i + s_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F5_t[6];

            gpu::computeBoysFunction(F5_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 5, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F5_t[3] * (

                        0.25 * S1 / ( S4 * S4 * S4 ) * (
                            delta[b1][c0] * delta[d0][d1] * (PQ[b0] * (-1.0))
                            + delta[b1][d0] * delta[c0][d1] * (PQ[b0] * (-1.0))
                            + delta[b1][d1] * delta[c0][d0] * (PQ[b0] * (-1.0))
                            + delta[b0][c0] * delta[d0][d1] * (PQ[b1] * (-1.0))
                            + delta[b0][d0] * delta[c0][d1] * (PQ[b1] * (-1.0))
                            + delta[b0][d1] * delta[c0][d0] * (PQ[b1] * (-1.0))
                            + delta[b0][b1] * delta[d0][d1] * (PQ[c0] * (-1.0))
                            + delta[b0][d0] * delta[b1][d1] * (PQ[c0] * (-1.0))
                            + delta[b0][d1] * delta[b1][d0] * (PQ[c0] * (-1.0))
                            + delta[b0][b1] * delta[c0][d1] * (PQ[d0] * (-1.0))
                            + delta[b0][c0] * delta[b1][d1] * (PQ[d0] * (-1.0))
                            + delta[b0][d1] * delta[b1][c0] * (PQ[d0] * (-1.0))
                            + delta[b0][b1] * delta[c0][d0] * (PQ[d1] * (-1.0))
                            + delta[b0][c0] * delta[b1][d0] * (PQ[d1] * (-1.0))
                            + delta[b0][d0] * delta[b1][c0] * (PQ[d1] * (-1.0))
                        )

                    )

                    +

                    F5_t[3] * (

                        0.5 * ( S1 * S1 ) / ( S4 * S4 * S4 ) * (
                            delta[b0][b1] * (PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[d0][d1] * (PB_0 * PQ[b1] * PQ[c0] + PB_1 * PQ[b0] * PQ[c0])
                            + delta[c0][d1] * (PB_0 * PQ[b1] * PQ[d0] + PB_1 * PQ[b0] * PQ[d0])
                            + delta[c0][d0] * (PB_0 * PQ[b1] * PQ[d1] + PB_1 * PQ[b0] * PQ[d1])
                            + delta[b1][d1] * (PB_0 * PQ[c0] * PQ[d0])
                            + delta[b1][d0] * (PB_0 * PQ[c0] * PQ[d1])
                            + delta[b1][c0] * (PB_0 * PQ[d0] * PQ[d1])
                            + delta[b0][d1] * (PB_1 * PQ[c0] * PQ[d0])
                            + delta[b0][d0] * (PB_1 * PQ[c0] * PQ[d1])
                            + delta[b0][c0] * (PB_1 * PQ[d0] * PQ[d1])
                        )

                    )

                    +

                    F5_t[3] * (

                        0.5 * ( S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[b0] * PQ[b1] * PQ[c0] * (-1.0) + PQ[b0] * PQ[b1] * QC_0 * (-1.0))
                            + delta[c0][d1] * (PQ[b0] * PQ[b1] * PQ[d0] * (-1.0) + PQ[b0] * PQ[b1] * QD_0 * (-1.0))
                            + delta[c0][d0] * (PQ[b0] * PQ[b1] * PQ[d1] * (-1.0) + PQ[b0] * PQ[b1] * QD_1 * (-1.0))
                            + delta[b1][d1] * (PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PQ[b0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[b1][d0] * (PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PQ[b0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[b1][c0] * (PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][d1] * (PQ[b1] * PQ[c0] * QD_0 * (-1.0) + PQ[b1] * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][d0] * (PQ[b1] * PQ[c0] * QD_1 * (-1.0) + PQ[b1] * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][c0] * (PQ[b1] * PQ[d0] * QD_1 * (-1.0) + PQ[b1] * PQ[d1] * QD_0 * (-1.0))
                            + delta[b0][b1] * (PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                        )

                    )

                    +

                    F5_t[3] * (

                        ( S1 * S1 * S1 ) / ( S4 * S4 * S4 ) * (
                            PB_0 * PB_1 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                        )

                    )

                    +

                    F5_t[4] * (

                        ( S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * QD_1
                            + PQ[b0] * PQ[b1] * PQ[c0] * PQ[d1] * QD_0
                            + PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1] * QC_0
                        )

                    )

                    +

                    F5_t[4] * (

                        ( S1 * S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            PB_0 * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                            + PB_1 * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                        )

                    )

                    +

                    F5_t[4] * (

                        0.5 * ( S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[b0] * PQ[b1] * PQ[c0])
                            + delta[c0][d1] * (PQ[b0] * PQ[b1] * PQ[d0])
                            + delta[c0][d0] * (PQ[b0] * PQ[b1] * PQ[d1])
                            + delta[b1][d1] * (PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[b1][d0] * (PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[b1][c0] * (PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[b0][d1] * (PQ[b1] * PQ[c0] * PQ[d0])
                            + delta[b0][d0] * (PQ[b1] * PQ[c0] * PQ[d1])
                            + delta[b0][c0] * (PQ[b1] * PQ[d0] * PQ[d1])
                            + delta[b0][b1] * (PQ[c0] * PQ[d0] * PQ[d1])
                        )

                    )

                    +

                    F5_t[5] * (

                        ( S1 * S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < sd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockSDPP(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pp_mat_D,
                       const double*   sd_mat_Q_local,
                       const double*   pp_mat_Q,
                       const uint32_t* sd_first_inds_local,
                       const uint32_t* sd_second_inds_local,
                       const uint32_t  sd_prim_pair_count_local,
                       const uint32_t* pp_first_inds,
                       const uint32_t* pp_second_inds,
                       const uint32_t  pp_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pp_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < pp_prim_pair_count) && (ij < sd_prim_pair_count_local) && (fabs(sd_mat_Q_local[ij] * pp_mat_Q[kl] * pp_mat_D[kl]) > eri_threshold))
        {
            const auto i = sd_first_inds_local[ij];
            const auto j = sd_second_inds_local[ij];

            const auto k = pp_first_inds[kl];
            const auto l = pp_second_inds[kl];

            const auto a_i = s_prim_info[i + s_prim_count * 0];
            const auto c_i = s_prim_info[i + s_prim_count * 1];
            const auto x_i = s_prim_info[i + s_prim_count * 2];
            const auto y_i = s_prim_info[i + s_prim_count * 3];
            const auto z_i = s_prim_info[i + s_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = p_prim_info[l / 3 + p_prim_count * 0];
            const auto c_l = p_prim_info[l / 3 + p_prim_count * 1];
            const auto x_l = p_prim_info[l / 3 + p_prim_count * 2];
            const auto y_l = p_prim_info[l / 3 + p_prim_count * 3];
            const auto z_l = p_prim_info[l / 3 + p_prim_count * 4];

            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto c0 = k % 3;
            const auto d0 = l % 3;

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F4_t[5];

            gpu::computeBoysFunction(F4_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F4_t[0] * (

                        0.5 / S1 * (
                            delta[b0][b1] * (QD_0 * QC_0)
                        )

                        + (

                            + PB_0 * PB_1 * QD_0 * QC_0
                        )

                        + 0.25 / ( S1 * S2 ) * (
                            delta[b0][b1] * delta[c0][d0]
                        )

                        + 0.5 / S2 * (
                            delta[c0][d0] * (PB_0 * PB_1)
                        )

                    )

                    + F4_t[1] * (

                        0.25 / ( S1 * S4 ) * (
                            delta[b0][b1] * delta[c0][d0] * (-1.0)
                        )

                        + 0.25 / ( S2 * S4 ) * (
                            delta[b0][b1] * delta[c0][d0] * (-1.0)
                        )

                        + 0.5 * S1 / ( S2 * S4 ) * (
                            delta[c0][d0] * (PB_0 * PB_1 * (-1.0))
                        )

                        + 0.5 * S2 / ( S1 * S4 ) * (
                            delta[b0][b1] * (QD_0 * QC_0 * (-1.0))
                        )

                        + 0.5 / S4 * (
                            delta[b1][d0] * (PB_0 * QC_0)
                            + delta[b0][d0] * (PB_1 * QC_0)
                            + delta[b0][b1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[c0][d0] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[b1][c0] * (PB_0 * QD_0)
                            + delta[b0][c0] * (PB_1 * QD_0)
                        )

                        + S1 / S4 * (
                            PB_0 * PB_1 * PQ[c0] * QD_0 * (-1.0)
                            + PB_0 * PB_1 * PQ[d0] * QC_0 * (-1.0)
                        )

                        + S2 / S4 * (

                            + PB_0 * PQ[b1] * QD_0 * QC_0
                            + PB_1 * PQ[b0] * QD_0 * QC_0
                        )

                    )

                    + F4_t[2] * (

                        ( S1 * S1 ) / ( S4 * S4 ) * (
                            PB_0 * PB_1 * PQ[c0] * PQ[d0]
                        )

                        + ( S1 * S2 ) / ( S4 * S4 ) * (

                            + PB_0 * PQ[b1] * PQ[c0] * QD_0 * (-1.0)
                            + PB_0 * PQ[b1] * PQ[d0] * QC_0 * (-1.0)
                            + PB_1 * PQ[b0] * PQ[c0] * QD_0 * (-1.0)
                            + PB_1 * PQ[b0] * PQ[d0] * QC_0 * (-1.0)
                        )

                        + ( S2 * S2 ) / ( S4 * S4 ) * (

                            + PQ[b0] * PQ[b1] * QD_0 * QC_0
                        )

                        + 0.5 * S1 / ( S4 * S4 ) * (
                            delta[c0][d0] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0))
                            + delta[b1][d0] * (PB_0 * PQ[c0] * (-1.0))
                            + delta[b1][c0] * (PB_0 * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PB_1 * PQ[c0] * (-1.0))
                            + delta[b0][c0] * (PB_1 * PQ[d0] * (-1.0))
                            + delta[b0][b1] * (PQ[c0] * PQ[d0])
                        )

                        + 0.5 * S2 / ( S4 * S4 ) * (
                            delta[b1][d0] * (PQ[b0] * QC_0)
                            + delta[b0][d0] * (PQ[b1] * QC_0)
                            + delta[b0][b1] * (PQ[c0] * QD_0 + PQ[d0] * QC_0)
                            + delta[c0][d0] * (PQ[b0] * PQ[b1])
                            + delta[b1][c0] * (PQ[b0] * QD_0)
                            + delta[b0][c0] * (PQ[b1] * QD_0)
                        )

                        + 0.25 / ( S4 * S4 ) * (
                            delta[b0][b1] * delta[c0][d0]
                            + delta[b0][c0] * delta[b1][d0]
                            + delta[b0][d0] * delta[b1][c0]
                        )

                    )

                    + F4_t[3] * (

                        ( S1 * S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            PB_0 * PQ[b1] * PQ[c0] * PQ[d0]
                            + PB_1 * PQ[b0] * PQ[c0] * PQ[d0]
                        )

                        + ( S1 * S2 * S2 ) / ( S4 * S4 * S4 ) * (

                            + PQ[b0] * PQ[b1] * PQ[c0] * QD_0 * (-1.0)
                            + PQ[b0] * PQ[b1] * PQ[d0] * QC_0 * (-1.0)
                        )

                        + 0.5 * ( S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            delta[c0][d0] * (PQ[b0] * PQ[b1] * (-1.0))
                            + delta[b1][d0] * (PQ[b0] * PQ[c0] * (-1.0))
                            + delta[b1][c0] * (PQ[b0] * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PQ[b1] * PQ[c0] * (-1.0))
                            + delta[b0][c0] * (PQ[b1] * PQ[d0] * (-1.0))
                            + delta[b0][b1] * (PQ[c0] * PQ[d0] * (-1.0))
                        )

                    )

                    + F4_t[4] * (

                        ( S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            PQ[b0] * PQ[b1] * PQ[c0] * PQ[d0]
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pp_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < sd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockSDSD(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   sd_mat_D,
                       const double*   sd_mat_Q_local,
                       const double*   sd_mat_Q,
                       const uint32_t* sd_first_inds_local,
                       const uint32_t* sd_second_inds_local,
                       const uint32_t  sd_prim_pair_count_local,
                       const uint32_t* sd_first_inds,
                       const uint32_t* sd_second_inds,
                       const uint32_t  sd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (sd_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < sd_prim_pair_count) && (ij < sd_prim_pair_count_local) && (fabs(sd_mat_Q_local[ij] * sd_mat_Q[kl] * sd_mat_D[kl]) > eri_threshold))
        {
            const auto i = sd_first_inds_local[ij];
            const auto j = sd_second_inds_local[ij];

            const auto k = sd_first_inds[kl];
            const auto l = sd_second_inds[kl];

            const auto a_i = s_prim_info[i + s_prim_count * 0];
            const auto c_i = s_prim_info[i + s_prim_count * 1];
            const auto x_i = s_prim_info[i + s_prim_count * 2];
            const auto y_i = s_prim_info[i + s_prim_count * 3];
            const auto z_i = s_prim_info[i + s_prim_count * 4];

            const auto a_j = d_prim_info[j / 6 + d_prim_count * 0];
            const auto c_j = d_prim_info[j / 6 + d_prim_count * 1];
            const auto x_j = d_prim_info[j / 6 + d_prim_count * 2];
            const auto y_j = d_prim_info[j / 6 + d_prim_count * 3];
            const auto z_j = d_prim_info[j / 6 + d_prim_count * 4];

            const auto a_k = s_prim_info[k + s_prim_count * 0];
            const auto c_k = s_prim_info[k + s_prim_count * 1];
            const auto x_k = s_prim_info[k + s_prim_count * 2];
            const auto y_k = s_prim_info[k + s_prim_count * 3];
            const auto z_k = s_prim_info[k + s_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto b0 = d_cart_inds[j % 6][0];
            const auto b1 = d_cart_inds[j % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F4_t[5];

            gpu::computeBoysFunction(F4_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto PB_1 = (-a_i / (a_i + a_j)) * rij[b1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F4_t[0] * (

                        0.25 / ( S1 * S2 ) * (
                            delta[b0][b1] * delta[d0][d1]
                        )

                        + 0.5 / S1 * (
                            delta[b0][b1] * (QD_0 * QD_1)
                        )

                        + 0.5 / S2 * (
                            delta[d0][d1] * (PB_0 * PB_1)
                        )

                        + (
                            PB_0 * PB_1 * QD_0 * QD_1
                        )

                    )

                    + F4_t[1] * (

                        0.25 / ( S1 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (-1.0)
                        )

                        + 0.25 / ( S2 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1] * (-1.0)
                        )

                        + 0.5 * S1 / ( S2 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PB_1 * (-1.0))
                        )

                        + 0.5 * S2 / ( S1 * S4 ) * (
                            delta[b0][b1] * (QD_0 * QD_1 * (-1.0))
                        )

                        + 0.5 / S4 * (
                            delta[b0][b1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                            + delta[d0][d1] * (PB_0 * PQ[b1] + PB_1 * PQ[b0])
                            + delta[b1][d1] * (PB_0 * QD_0)
                            + delta[b1][d0] * (PB_0 * QD_1)
                            + delta[b0][d1] * (PB_1 * QD_0)
                            + delta[b0][d0] * (PB_1 * QD_1)
                        )

                        + S1 / S4 * (
                            PB_0 * PB_1 * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PB_1 * PQ[d1] * QD_0 * (-1.0)
                        )

                        + S2 / S4 * (
                            PB_0 * PQ[b1] * QD_0 * QD_1
                            + PB_1 * PQ[b0] * QD_0 * QD_1
                        )

                    )

                    + F4_t[2] * (

                        ( S1 * S1 ) / ( S4 * S4 ) * (
                            PB_0 * PB_1 * PQ[d0] * PQ[d1]
                        )

                        + ( S2 * S2 ) / ( S4 * S4 ) * (
                            PQ[b0] * PQ[b1] * QD_0 * QD_1
                        )

                        + 0.5 * S1 / ( S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[b1] * (-1.0) + PB_1 * PQ[b0] * (-1.0))
                            + delta[b1][d1] * (PB_0 * PQ[d0] * (-1.0))
                            + delta[b1][d0] * (PB_0 * PQ[d1] * (-1.0))
                            + delta[b0][d1] * (PB_1 * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PB_1 * PQ[d1] * (-1.0))
                            + delta[b0][b1] * (PQ[d0] * PQ[d1])
                        )

                        + ( S1 * S2 ) / ( S4 * S4 ) * (
                            PB_0 * PQ[b1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PQ[b1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_1 * PQ[b0] * PQ[d0] * QD_1 * (-1.0)
                            + PB_1 * PQ[b0] * PQ[d1] * QD_0 * (-1.0)
                        )

                        + 0.25 / ( S4 * S4 ) * (
                            delta[b0][b1] * delta[d0][d1]
                            + delta[b0][d0] * delta[b1][d1]
                            + delta[b0][d1] * delta[b1][d0]
                        )

                        + 0.5 * S2 / ( S4 * S4 ) * (
                            delta[d0][d1] * (PQ[b0] * PQ[b1])
                            + delta[b1][d1] * (PQ[b0] * QD_0)
                            + delta[b1][d0] * (PQ[b0] * QD_1)
                            + delta[b0][d1] * (PQ[b1] * QD_0)
                            + delta[b0][d0] * (PQ[b1] * QD_1)
                            + delta[b0][b1] * (PQ[d0] * QD_1 + PQ[d1] * QD_0)
                        )

                    )

                    + F4_t[3] * (

                        ( S1 * S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            PB_0 * PQ[b1] * PQ[d0] * PQ[d1]
                            + PB_1 * PQ[b0] * PQ[d0] * PQ[d1]
                        )

                        + 0.5 * ( S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[b0] * PQ[b1] * (-1.0))
                            + delta[b1][d1] * (PQ[b0] * PQ[d0] * (-1.0))
                            + delta[b1][d0] * (PQ[b0] * PQ[d1] * (-1.0))
                            + delta[b0][d1] * (PQ[b1] * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PQ[b1] * PQ[d1] * (-1.0))
                            + delta[b0][b1] * (PQ[d0] * PQ[d1] * (-1.0))
                        )

                        + ( S1 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            PQ[b0] * PQ[b1] * PQ[d0] * QD_1 * (-1.0)
                            + PQ[b0] * PQ[b1] * PQ[d1] * QD_0 * (-1.0)
                        )

                    )

                    + F4_t[4] * (

                        ( S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            PQ[b0] * PQ[b1] * PQ[d0] * PQ[d1]
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * sd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < sd_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPPDD0(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pp_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pp_first_inds_local,
                       const uint32_t* pp_second_inds_local,
                       const uint32_t  pp_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pp_prim_pair_count_local) && (fabs(pp_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pp_first_inds_local[ij];
            const auto j = pp_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = p_prim_info[j / 3 + p_prim_count * 0];
            const auto c_j = p_prim_info[j / 3 + p_prim_count * 1];
            const auto x_j = p_prim_info[j / 3 + p_prim_count * 2];
            const auto y_j = p_prim_info[j / 3 + p_prim_count * 3];
            const auto z_j = p_prim_info[j / 3 + p_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = j % 3;
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[3];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[0] * (

                        0.25 / ( S1 * S2 ) * (
                            delta[a0][b0] * delta[d0][d1] * (QC_0 * QC_1)
                            + delta[a0][b0] * delta[c1][d1] * (QD_0 * QC_0)
                            + delta[a0][b0] * delta[c1][d0] * (QD_1 * QC_0)
                            + delta[a0][b0] * delta[c0][d1] * (QD_0 * QC_1)
                            + delta[a0][b0] * delta[c0][d0] * (QD_1 * QC_1)
                            + delta[a0][b0] * delta[c0][c1] * (QD_0 * QD_1)
                        )

                    )

                    +

                    F6_t[0] * (

                        0.25 / ( S2 * S2 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PA_0)
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PA_0)
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PA_0)
                        )

                    )

                    +

                    F6_t[0] * (

                        0.5 / S1 * (
                            delta[a0][b0] * (QD_0 * QD_1 * QC_0 * QC_1)
                        )

                    )

                    +

                    F6_t[0] * (

                        0.5 / S2 * (
                            delta[d0][d1] * (PB_0 * PA_0 * QC_0 * QC_1)
                            + delta[c1][d1] * (PB_0 * PA_0 * QD_0 * QC_0)
                            + delta[c1][d0] * (PB_0 * PA_0 * QD_1 * QC_0)
                            + delta[c0][d1] * (PB_0 * PA_0 * QD_0 * QC_1)
                            + delta[c0][d0] * (PB_0 * PA_0 * QD_1 * QC_1)
                            + delta[c0][c1] * (PB_0 * PA_0 * QD_0 * QD_1)
                        )

                    )

                    +

                    F6_t[0] * (

                        (
                            
                            + PB_0 * PA_0 * QD_0 * QD_1 * QC_0 * QC_1
                        )

                    )

                    +

                    F6_t[0] * (

                        0.125 / ( S1 * S2 * S2 ) * (
                            delta[a0][b0] * delta[c0][c1] * delta[d0][d1]
                            + delta[a0][b0] * delta[c0][d0] * delta[c1][d1]
                            + delta[a0][b0] * delta[c1][d0] * delta[c0][d1]
                        )

                    )

                    +

                    F6_t[1] * (

                        0.125 / ( S1 * S2 * S4 ) * (
                            delta[a0][b0] * delta[c0][c1] * delta[d0][d1] * (-1.0)
                            + delta[a0][b0] * delta[c0][d0] * delta[c1][d1] * (-1.0)
                            + delta[a0][b0] * delta[c1][d0] * delta[c0][d1] * (-1.0)
                        )

                    )

                    +

                    F6_t[1] * (

                        0.125 / ( S2 * S2 * S4 ) * (
                            delta[a0][b0] * delta[c0][c1] * delta[d0][d1] * (-2.0)
                            + delta[a0][b0] * delta[c0][d0] * delta[c1][d1] * (-2.0)
                            + delta[a0][b0] * delta[c1][d0] * delta[c0][d1] * (-2.0)
                        )

                    )

                    +

                    F6_t[1] * (

                        0.25 * S1 / ( S2 * S2 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PA_0 * (-2.0))
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PA_0 * (-2.0))
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PA_0 * (-2.0))
                        )

                    )

                    +

                    F6_t[1] * (

                        0.25 / ( S1 * S4 ) * (
                            delta[a0][b0] * delta[d0][d1] * (QC_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[c1][d1] * (QD_0 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c1][d0] * (QD_1 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c0][d1] * (QD_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (QD_1 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[c0][c1] * (QD_0 * QD_1 * (-1.0))
                        )

                    )

                    +

                    F6_t[1] * (

                        0.25 / ( S2 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[b0][c1] * delta[d0][d1] * (PA_0 * QC_0)
                            + delta[b0][d0] * delta[c1][d1] * (PA_0 * QC_0)
                            + delta[b0][d1] * delta[c1][d0] * (PA_0 * QC_0)
                            + delta[b0][c0] * delta[d0][d1] * (PA_0 * QC_1)
                            + delta[b0][d0] * delta[c0][d1] * (PA_0 * QC_1)
                            + delta[b0][d1] * delta[c0][d0] * (PA_0 * QC_1)
                            + delta[b0][c0] * delta[c1][d1] * (PA_0 * QD_0)
                            + delta[b0][c1] * delta[c0][d1] * (PA_0 * QD_0)
                            + delta[b0][d1] * delta[c0][c1] * (PA_0 * QD_0)
                            + delta[b0][c0] * delta[c1][d0] * (PA_0 * QD_1)
                            + delta[b0][c1] * delta[c0][d0] * (PA_0 * QD_1)
                            + delta[b0][d0] * delta[c0][c1] * (PA_0 * QD_1)
                            + delta[a0][c1] * delta[d0][d1] * (PB_0 * QC_0)
                            + delta[a0][d0] * delta[c1][d1] * (PB_0 * QC_0)
                            + delta[a0][d1] * delta[c1][d0] * (PB_0 * QC_0)
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * QC_1)
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * QC_1)
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * QC_1)
                            + delta[a0][b0] * delta[d0][d1] * (PQ[c0] * QC_1 * (-1.0) + PQ[c1] * QC_0 * (-1.0) + QC_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[c1][d1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0) + QD_0 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c1][d0] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0) + QD_1 * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c0][d1] * (PQ[c1] * QD_0 * (-1.0) + PQ[d0] * QC_1 * (-1.0) + QD_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (PQ[c1] * QD_1 * (-1.0) + PQ[d1] * QC_1 * (-1.0) + QD_1 * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[c0][c1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0) + QD_0 * QD_1 * (-1.0))
                            + delta[a0][c0] * delta[c1][d1] * (PB_0 * QD_0)
                            + delta[a0][c1] * delta[c0][d1] * (PB_0 * QD_0)
                            + delta[a0][d1] * delta[c0][c1] * (PB_0 * QD_0)
                            + delta[a0][c0] * delta[c1][d0] * (PB_0 * QD_1)
                            + delta[a0][c1] * delta[c0][d0] * (PB_0 * QD_1)
                            + delta[a0][d0] * delta[c0][c1] * (PB_0 * QD_1)
                        )

                    )

                    +

                    F6_t[1] * (

                        0.5 * S1 / ( S2 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PA_0 * PQ[c0] * QC_1 * (-1.0) + PB_0 * PA_0 * PQ[c1] * QC_0 * (-1.0) + PB_0 * PA_0 * QC_0 * QC_1 * (-1.0))
                            + delta[c1][d1] * (PB_0 * PA_0 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[d0] * QC_0 * (-1.0) + PB_0 * PA_0 * QD_0 * QC_0 * (-1.0))
                            + delta[c1][d0] * (PB_0 * PA_0 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[d1] * QC_0 * (-1.0) + PB_0 * PA_0 * QD_1 * QC_0 * (-1.0))
                            + delta[c0][d1] * (PB_0 * PA_0 * PQ[c1] * QD_0 * (-1.0) + PB_0 * PA_0 * PQ[d0] * QC_1 * (-1.0) + PB_0 * PA_0 * QD_0 * QC_1 * (-1.0))
                            + delta[c0][d0] * (PB_0 * PA_0 * PQ[c1] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[d1] * QC_1 * (-1.0) + PB_0 * PA_0 * QD_1 * QC_1 * (-1.0))
                            + delta[c0][c1] * (PB_0 * PA_0 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PA_0 * PQ[d1] * QD_0 * (-1.0) + PB_0 * PA_0 * QD_0 * QD_1 * (-1.0))
                        )

                    )

                    +

                    F6_t[1] * (

                        0.5 * S2 / ( S1 * S4 ) * (
                            delta[a0][b0] * (QD_0 * QD_1 * QC_0 * QC_1 * (-1.0))
                        )

                    )

                    +

                    F6_t[1] * (

                        0.5 / S4 * (
                            delta[d0][d1] * (PB_0 * PQ[a0] * QC_0 * QC_1 + PA_0 * PQ[b0] * QC_0 * QC_1)
                            + delta[c1][d1] * (PB_0 * PQ[a0] * QD_0 * QC_0 + PA_0 * PQ[b0] * QD_0 * QC_0)
                            + delta[c1][d0] * (PB_0 * PQ[a0] * QD_1 * QC_0 + PA_0 * PQ[b0] * QD_1 * QC_0)
                            + delta[c0][d1] * (PB_0 * PQ[a0] * QD_0 * QC_1 + PA_0 * PQ[b0] * QD_0 * QC_1)
                            + delta[c0][d0] * (PB_0 * PQ[a0] * QD_1 * QC_1 + PA_0 * PQ[b0] * QD_1 * QC_1)
                            + delta[c0][c1] * (PB_0 * PQ[a0] * QD_0 * QD_1 + PA_0 * PQ[b0] * QD_0 * QD_1)
                            + delta[b0][d1] * (PA_0 * QD_0 * QC_0 * QC_1)
                            + delta[b0][d0] * (PA_0 * QD_1 * QC_0 * QC_1)
                            + delta[b0][c1] * (PA_0 * QD_0 * QD_1 * QC_0)
                            + delta[b0][c0] * (PA_0 * QD_0 * QD_1 * QC_1)
                            + delta[a0][d1] * (PB_0 * QD_0 * QC_0 * QC_1)
                            + delta[a0][d0] * (PB_0 * QD_1 * QC_0 * QC_1)
                            + delta[a0][c1] * (PB_0 * QD_0 * QD_1 * QC_0)
                            + delta[a0][c0] * (PB_0 * QD_0 * QD_1 * QC_1)
                            + delta[a0][b0] * (PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0) + PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0) + PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0) + PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0))
                        )

                    )

                    +

                    F6_t[1] * (

                        S1 / S4 * (
                            
                            + PB_0 * PA_0 * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PB_0 * PA_0 * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PA_0 * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PB_0 * PA_0 * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                        )

                    )

                    +

                    F6_t[1] * (

                        S2 / S4 * (
                            
                            + PB_0 * PQ[a0] * QD_0 * QD_1 * QC_0 * QC_1
                            + PA_0 * PQ[b0] * QD_0 * QD_1 * QC_0 * QC_1
                        )

                    )

                    +

                    F6_t[2] * (

                        ( S1 * S1 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PA_0 * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PB_0 * PA_0 * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PB_0 * PA_0 * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PB_0 * PA_0 * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PB_0 * PA_0 * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PB_0 * PA_0 * PQ[d0] * PQ[d1] * QC_0 * QC_1
                        )

                    )

                    +

                    F6_t[2] * (

                        ( S1 * S2 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pp_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPPDD1(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pp_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pp_first_inds_local,
                       const uint32_t* pp_second_inds_local,
                       const uint32_t  pp_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pp_prim_pair_count_local) && (fabs(pp_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pp_first_inds_local[ij];
            const auto j = pp_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = p_prim_info[j / 3 + p_prim_count * 0];
            const auto c_j = p_prim_info[j / 3 + p_prim_count * 1];
            const auto x_j = p_prim_info[j / 3 + p_prim_count * 2];
            const auto y_j = p_prim_info[j / 3 + p_prim_count * 3];
            const auto z_j = p_prim_info[j / 3 + p_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = j % 3;
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[3];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[2] * (

                        ( S2 * S2 ) / ( S4 * S4 ) * (
                            
                            + PQ[a0] * PQ[b0] * QD_0 * QD_1 * QC_0 * QC_1
                        )

                    )

                    +

                    F6_t[2] * (

                        0.25 * ( S1 * S1 ) / ( S2 * S2 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PA_0)
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PA_0)
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PA_0)
                        )

                    )

                    +

                    F6_t[2] * (

                        0.25 * S1 / ( S2 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PQ[a0] * (-2.0) + PA_0 * PQ[b0] * (-2.0))
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PQ[a0] * (-2.0) + PA_0 * PQ[b0] * (-2.0))
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] * (-2.0) + PA_0 * PQ[b0] * (-2.0))
                            + delta[b0][c1] * delta[d0][d1] * (PA_0 * PQ[c0] * (-1.0) + PA_0 * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[c1][d1] * (PA_0 * PQ[c0] * (-1.0) + PA_0 * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[c1][d0] * (PA_0 * PQ[c0] * (-1.0) + PA_0 * QC_0 * (-1.0))
                            + delta[b0][c0] * delta[d0][d1] * (PA_0 * PQ[c1] * (-1.0) + PA_0 * QC_1 * (-1.0))
                            + delta[b0][d0] * delta[c0][d1] * (PA_0 * PQ[c1] * (-1.0) + PA_0 * QC_1 * (-1.0))
                            + delta[b0][d1] * delta[c0][d0] * (PA_0 * PQ[c1] * (-1.0) + PA_0 * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[c1][d1] * (PA_0 * PQ[d0] * (-1.0) + PA_0 * QD_0 * (-1.0))
                            + delta[b0][c1] * delta[c0][d1] * (PA_0 * PQ[d0] * (-1.0) + PA_0 * QD_0 * (-1.0))
                            + delta[b0][d1] * delta[c0][c1] * (PA_0 * PQ[d0] * (-1.0) + PA_0 * QD_0 * (-1.0))
                            + delta[b0][c0] * delta[c1][d0] * (PA_0 * PQ[d1] * (-1.0) + PA_0 * QD_1 * (-1.0))
                            + delta[b0][c1] * delta[c0][d0] * (PA_0 * PQ[d1] * (-1.0) + PA_0 * QD_1 * (-1.0))
                            + delta[b0][d0] * delta[c0][c1] * (PA_0 * PQ[d1] * (-1.0) + PA_0 * QD_1 * (-1.0))
                            + delta[a0][c1] * delta[d0][d1] * (PB_0 * PQ[c0] * (-1.0) + PB_0 * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[c1][d1] * (PB_0 * PQ[c0] * (-1.0) + PB_0 * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[c1][d0] * (PB_0 * PQ[c0] * (-1.0) + PB_0 * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * PQ[c1] * (-1.0) + PB_0 * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * PQ[c1] * (-1.0) + PB_0 * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * PQ[c1] * (-1.0) + PB_0 * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[c1][d1] * (PB_0 * PQ[d0] * (-1.0) + PB_0 * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[c0][d1] * (PB_0 * PQ[d0] * (-1.0) + PB_0 * QD_0 * (-1.0))
                            + delta[a0][d1] * delta[c0][c1] * (PB_0 * PQ[d0] * (-1.0) + PB_0 * QD_0 * (-1.0))
                            + delta[a0][c0] * delta[c1][d0] * (PB_0 * PQ[d1] * (-1.0) + PB_0 * QD_1 * (-1.0))
                            + delta[a0][c1] * delta[c0][d0] * (PB_0 * PQ[d1] * (-1.0) + PB_0 * QD_1 * (-1.0))
                            + delta[a0][d0] * delta[c0][c1] * (PB_0 * PQ[d1] * (-1.0) + PB_0 * QD_1 * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PQ[c0] * PQ[c1] + PQ[c0] * QC_1 + PQ[c1] * QC_0)
                            + delta[a0][b0] * delta[c1][d1] * (PQ[c0] * PQ[d0] + PQ[c0] * QD_0 + PQ[d0] * QC_0)
                            + delta[a0][b0] * delta[c0][d1] * (PQ[c1] * PQ[d0] + PQ[c1] * QD_0 + PQ[d0] * QC_1)
                            + delta[a0][b0] * delta[c1][d0] * (PQ[c0] * PQ[d1] + PQ[c0] * QD_1 + PQ[d1] * QC_0)
                            + delta[a0][b0] * delta[c0][d0] * (PQ[c1] * PQ[d1] + PQ[c1] * QD_1 + PQ[d1] * QC_1)
                            + delta[a0][b0] * delta[c0][c1] * (PQ[d0] * PQ[d1] + PQ[d0] * QD_1 + PQ[d1] * QD_0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pp_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPPDD2(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pp_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pp_first_inds_local,
                       const uint32_t* pp_second_inds_local,
                       const uint32_t  pp_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pp_prim_pair_count_local) && (fabs(pp_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pp_first_inds_local[ij];
            const auto j = pp_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = p_prim_info[j / 3 + p_prim_count * 0];
            const auto c_j = p_prim_info[j / 3 + p_prim_count * 1];
            const auto x_j = p_prim_info[j / 3 + p_prim_count * 2];
            const auto y_j = p_prim_info[j / 3 + p_prim_count * 3];
            const auto z_j = p_prim_info[j / 3 + p_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = j % 3;
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[3];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[2] * (

                        0.25 / ( S4 * S4 ) * (
                            delta[b0][c1] * delta[d0][d1] * (PQ[a0] * QC_0)
                            + delta[b0][d0] * delta[c1][d1] * (PQ[a0] * QC_0)
                            + delta[b0][d1] * delta[c1][d0] * (PQ[a0] * QC_0)
                            + delta[b0][c0] * delta[d0][d1] * (PQ[a0] * QC_1)
                            + delta[b0][d0] * delta[c0][d1] * (PQ[a0] * QC_1)
                            + delta[b0][d1] * delta[c0][d0] * (PQ[a0] * QC_1)
                            + delta[a0][c1] * delta[d0][d1] * (PQ[b0] * QC_0)
                            + delta[a0][d0] * delta[c1][d1] * (PQ[b0] * QC_0)
                            + delta[a0][d1] * delta[c1][d0] * (PQ[b0] * QC_0)
                            + delta[a0][c0] * delta[d0][d1] * (PQ[b0] * QC_1)
                            + delta[a0][d0] * delta[c0][d1] * (PQ[b0] * QC_1)
                            + delta[a0][d1] * delta[c0][d0] * (PQ[b0] * QC_1)
                            + delta[a0][b0] * delta[d0][d1] * (PQ[c0] * QC_1 + PQ[c1] * QC_0 + QC_0 * QC_1)
                            + delta[a0][b0] * delta[c1][d1] * (PQ[c0] * QD_0 + PQ[d0] * QC_0 + QD_0 * QC_0)
                            + delta[a0][b0] * delta[c0][d1] * (PQ[c1] * QD_0 + PQ[d0] * QC_1 + QD_0 * QC_1)
                            + delta[a0][b0] * delta[c1][d0] * (PQ[c0] * QD_1 + PQ[d1] * QC_0 + QD_1 * QC_0)
                            + delta[a0][b0] * delta[c0][d0] * (PQ[c1] * QD_1 + PQ[d1] * QC_1 + QD_1 * QC_1)
                            + delta[a0][d0] * delta[b0][d1] * (QC_0 * QC_1)
                            + delta[a0][d1] * delta[b0][d0] * (QC_0 * QC_1)
                            + delta[a0][c1] * delta[b0][d1] * (QD_0 * QC_0)
                            + delta[a0][d1] * delta[b0][c1] * (QD_0 * QC_0)
                            + delta[a0][c1] * delta[b0][d0] * (QD_1 * QC_0)
                            + delta[a0][d0] * delta[b0][c1] * (QD_1 * QC_0)
                            + delta[a0][c0] * delta[b0][d1] * (QD_0 * QC_1)
                            + delta[a0][d1] * delta[b0][c0] * (QD_0 * QC_1)
                            + delta[a0][c0] * delta[b0][d0] * (QD_1 * QC_1)
                            + delta[a0][d0] * delta[b0][c0] * (QD_1 * QC_1)
                            + delta[c0][c1] * delta[d0][d1] * (PQ[a0] * PQ[b0])
                            + delta[c0][d0] * delta[c1][d1] * (PQ[a0] * PQ[b0])
                            + delta[c1][d0] * delta[c0][d1] * (PQ[a0] * PQ[b0])
                            + delta[b0][c0] * delta[c1][d1] * (PQ[a0] * QD_0)
                            + delta[b0][c1] * delta[c0][d1] * (PQ[a0] * QD_0)
                            + delta[b0][d1] * delta[c0][c1] * (PQ[a0] * QD_0)
                            + delta[b0][c0] * delta[c1][d0] * (PQ[a0] * QD_1)
                            + delta[b0][c1] * delta[c0][d0] * (PQ[a0] * QD_1)
                            + delta[b0][d0] * delta[c0][c1] * (PQ[a0] * QD_1)
                            + delta[a0][c0] * delta[c1][d1] * (PQ[b0] * QD_0)
                            + delta[a0][c1] * delta[c0][d1] * (PQ[b0] * QD_0)
                            + delta[a0][d1] * delta[c0][c1] * (PQ[b0] * QD_0)
                            + delta[a0][c0] * delta[c1][d0] * (PQ[b0] * QD_1)
                            + delta[a0][c1] * delta[c0][d0] * (PQ[b0] * QD_1)
                            + delta[a0][d0] * delta[c0][c1] * (PQ[b0] * QD_1)
                            + delta[a0][b0] * delta[c0][c1] * (PQ[d0] * QD_1 + PQ[d1] * QD_0 + QD_0 * QD_1)
                            + delta[a0][c0] * delta[b0][c1] * (QD_0 * QD_1)
                            + delta[a0][c1] * delta[b0][c0] * (QD_0 * QD_1)
                        )

                    )

                    +

                    F6_t[2] * (

                        0.5 * ( S1 * S1 ) / ( S2 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PA_0 * PQ[c0] * PQ[c1] + PB_0 * PA_0 * PQ[c0] * QC_1 + PB_0 * PA_0 * PQ[c1] * QC_0)
                            + delta[c1][d1] * (PB_0 * PA_0 * PQ[c0] * PQ[d0] + PB_0 * PA_0 * PQ[c0] * QD_0 + PB_0 * PA_0 * PQ[d0] * QC_0)
                            + delta[c1][d0] * (PB_0 * PA_0 * PQ[c0] * PQ[d1] + PB_0 * PA_0 * PQ[c0] * QD_1 + PB_0 * PA_0 * PQ[d1] * QC_0)
                            + delta[c0][d1] * (PB_0 * PA_0 * PQ[c1] * PQ[d0] + PB_0 * PA_0 * PQ[c1] * QD_0 + PB_0 * PA_0 * PQ[d0] * QC_1)
                            + delta[c0][d0] * (PB_0 * PA_0 * PQ[c1] * PQ[d1] + PB_0 * PA_0 * PQ[c1] * QD_1 + PB_0 * PA_0 * PQ[d1] * QC_1)
                            + delta[c0][c1] * (PB_0 * PA_0 * PQ[d0] * PQ[d1] + PB_0 * PA_0 * PQ[d0] * QD_1 + PB_0 * PA_0 * PQ[d1] * QD_0)
                        )

                    )

                    +

                    F6_t[2] * (

                        0.5 * S1 / ( S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[a0] * PQ[c0] * QC_1 * (-1.0) + PB_0 * PQ[a0] * PQ[c1] * QC_0 * (-1.0) + PB_0 * PQ[a0] * QC_0 * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * QC_0 * (-1.0) + PA_0 * PQ[b0] * QC_0 * QC_1 * (-1.0))
                            + delta[c1][d1] * (PB_0 * PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[a0] * PQ[d0] * QC_0 * (-1.0) + PB_0 * PQ[a0] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PA_0 * PQ[b0] * QD_0 * QC_0 * (-1.0))
                            + delta[c1][d0] * (PB_0 * PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[d1] * QC_0 * (-1.0) + PB_0 * PQ[a0] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * QC_0 * (-1.0) + PA_0 * PQ[b0] * QD_1 * QC_0 * (-1.0))
                            + delta[c0][d1] * (PB_0 * PQ[a0] * PQ[c1] * QD_0 * (-1.0) + PB_0 * PQ[a0] * PQ[d0] * QC_1 * (-1.0) + PB_0 * PQ[a0] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * QC_1 * (-1.0) + PA_0 * PQ[b0] * QD_0 * QC_1 * (-1.0))
                            + delta[c0][d0] * (PB_0 * PQ[a0] * PQ[c1] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[d1] * QC_1 * (-1.0) + PB_0 * PQ[a0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * QC_1 * (-1.0) + PA_0 * PQ[b0] * QD_1 * QC_1 * (-1.0))
                            + delta[c0][c1] * (PB_0 * PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[a0] * PQ[d1] * QD_0 * (-1.0) + PB_0 * PQ[a0] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PA_0 * PQ[b0] * QD_0 * QD_1 * (-1.0))
                            + delta[b0][d1] * (PA_0 * PQ[c0] * QD_0 * QC_1 * (-1.0) + PA_0 * PQ[c1] * QD_0 * QC_0 * (-1.0) + PA_0 * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][d0] * (PA_0 * PQ[c0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[c1] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][c1] * (PA_0 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PA_0 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[b0][c0] * (PA_0 * PQ[c1] * QD_0 * QD_1 * (-1.0) + PA_0 * PQ[d0] * QD_1 * QC_1 * (-1.0) + PA_0 * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[a0][d1] * (PB_0 * PQ[c0] * QD_0 * QC_1 * (-1.0) + PB_0 * PQ[c1] * QD_0 * QC_0 * (-1.0) + PB_0 * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][d0] * (PB_0 * PQ[c0] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[c1] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][c1] * (PB_0 * PQ[c0] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[d0] * QD_1 * QC_0 * (-1.0) + PB_0 * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][c0] * (PB_0 * PQ[c1] * QD_0 * QD_1 * (-1.0) + PB_0 * PQ[d0] * QD_1 * QC_1 * (-1.0) + PB_0 * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * (PQ[c0] * PQ[c1] * QD_0 * QD_1 + PQ[c0] * PQ[d0] * QD_1 * QC_1 + PQ[c0] * PQ[d1] * QD_0 * QC_1 + PQ[c1] * PQ[d0] * QD_1 * QC_0 + PQ[c1] * PQ[d1] * QD_0 * QC_0 + PQ[d0] * PQ[d1] * QC_0 * QC_1)
                        )

                    )

                    +

                    F6_t[2] * (

                        0.5 * S2 / ( S4 * S4 ) * (
                            delta[d0][d1] * (PQ[a0] * PQ[b0] * QC_0 * QC_1)
                            + delta[c1][d1] * (PQ[a0] * PQ[b0] * QD_0 * QC_0)
                            + delta[c1][d0] * (PQ[a0] * PQ[b0] * QD_1 * QC_0)
                            + delta[c0][d1] * (PQ[a0] * PQ[b0] * QD_0 * QC_1)
                            + delta[c0][d0] * (PQ[a0] * PQ[b0] * QD_1 * QC_1)
                            + delta[b0][d1] * (PQ[a0] * QD_0 * QC_0 * QC_1)
                            + delta[b0][d0] * (PQ[a0] * QD_1 * QC_0 * QC_1)
                            + delta[b0][c1] * (PQ[a0] * QD_0 * QD_1 * QC_0)
                            + delta[b0][c0] * (PQ[a0] * QD_0 * QD_1 * QC_1)
                            + delta[a0][d1] * (PQ[b0] * QD_0 * QC_0 * QC_1)
                            + delta[a0][d0] * (PQ[b0] * QD_1 * QC_0 * QC_1)
                            + delta[a0][c1] * (PQ[b0] * QD_0 * QD_1 * QC_0)
                            + delta[a0][c0] * (PQ[b0] * QD_0 * QD_1 * QC_1)
                            + delta[a0][b0] * (PQ[c0] * QD_0 * QD_1 * QC_1 + PQ[c1] * QD_0 * QD_1 * QC_0 + PQ[d0] * QD_1 * QC_0 * QC_1 + PQ[d1] * QD_0 * QC_0 * QC_1)
                            + delta[c0][c1] * (PQ[a0] * PQ[b0] * QD_0 * QD_1)
                        )

                    )

                    +

                    F6_t[2] * (

                        0.125 * S1 / ( S2 * S2 * S4 * S4 ) * (
                            delta[a0][b0] * delta[c0][c1] * delta[d0][d1]
                            + delta[a0][b0] * delta[c0][d0] * delta[c1][d1]
                            + delta[a0][b0] * delta[c1][d0] * delta[c0][d1]
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pp_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPPDD3(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pp_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pp_first_inds_local,
                       const uint32_t* pp_second_inds_local,
                       const uint32_t  pp_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pp_prim_pair_count_local) && (fabs(pp_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pp_first_inds_local[ij];
            const auto j = pp_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = p_prim_info[j / 3 + p_prim_count * 0];
            const auto c_j = p_prim_info[j / 3 + p_prim_count * 1];
            const auto x_j = p_prim_info[j / 3 + p_prim_count * 2];
            const auto y_j = p_prim_info[j / 3 + p_prim_count * 3];
            const auto z_j = p_prim_info[j / 3 + p_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = j % 3;
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[4];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[2] * (

                        0.125 / ( S2 * S4 * S4 ) * (
                            delta[a0][c0] * delta[b0][c1] * delta[d0][d1]
                            + delta[a0][c0] * delta[b0][d0] * delta[c1][d1]
                            + delta[a0][c0] * delta[b0][d1] * delta[c1][d0]
                            + delta[a0][c1] * delta[b0][c0] * delta[d0][d1]
                            + delta[a0][c1] * delta[b0][d0] * delta[c0][d1]
                            + delta[a0][c1] * delta[b0][d1] * delta[c0][d0]
                            + delta[a0][d0] * delta[b0][c0] * delta[c1][d1]
                            + delta[a0][d0] * delta[b0][c1] * delta[c0][d1]
                            + delta[a0][d0] * delta[b0][d1] * delta[c0][c1]
                            + delta[a0][d1] * delta[b0][c0] * delta[c1][d0]
                            + delta[a0][d1] * delta[b0][c1] * delta[c0][d0]
                            + delta[a0][d1] * delta[b0][d0] * delta[c0][c1]
                            + delta[a0][b0] * delta[c0][c1] * delta[d0][d1] * 2.0
                            + delta[a0][b0] * delta[c0][d0] * delta[c1][d1] * 2.0
                            + delta[a0][b0] * delta[c1][d0] * delta[c0][d1] * 2.0
                        )

                    )

                    +

                    F6_t[3] * (

                        ( S1 * S1 * S1 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PA_0 * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PA_0 * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_0 * PA_0 * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PB_0 * PA_0 * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                        )

                    )

                    +

                    F6_t[3] * (

                        ( S1 * S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PB_0 * PQ[a0] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PB_0 * PQ[a0] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PB_0 * PQ[a0] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PB_0 * PQ[a0] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PB_0 * PQ[a0] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                            + PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PA_0 * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PA_0 * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PA_0 * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PA_0 * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PA_0 * PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                        )

                    )

                    +

                    F6_t[3] * (

                        ( S1 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PQ[a0] * PQ[b0] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                        )

                    )

                    +

                    F6_t[3] * (

                        0.125 * S1 / ( S2 * S4 * S4 * S4 ) * (
                            delta[a0][c0] * delta[b0][c1] * delta[d0][d1] * (-1.0)
                            + delta[a0][c0] * delta[b0][d0] * delta[c1][d1] * (-1.0)
                            + delta[a0][c0] * delta[b0][d1] * delta[c1][d0] * (-1.0)
                            + delta[a0][c1] * delta[b0][c0] * delta[d0][d1] * (-1.0)
                            + delta[a0][c1] * delta[b0][d0] * delta[c0][d1] * (-1.0)
                            + delta[a0][c1] * delta[b0][d1] * delta[c0][d0] * (-1.0)
                            + delta[a0][d0] * delta[b0][c0] * delta[c1][d1] * (-1.0)
                            + delta[a0][d0] * delta[b0][c1] * delta[c0][d1] * (-1.0)
                            + delta[a0][d0] * delta[b0][d1] * delta[c0][c1] * (-1.0)
                            + delta[a0][d1] * delta[b0][c0] * delta[c1][d0] * (-1.0)
                            + delta[a0][d1] * delta[b0][c1] * delta[c0][d0] * (-1.0)
                            + delta[a0][d1] * delta[b0][d0] * delta[c0][c1] * (-1.0)
                            + delta[a0][b0] * delta[c0][c1] * delta[d0][d1] * (-1.0)
                            + delta[a0][b0] * delta[c0][d0] * delta[c1][d1] * (-1.0)
                            + delta[a0][b0] * delta[c1][d0] * delta[c0][d1] * (-1.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pp_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPPDD4(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pp_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pp_first_inds_local,
                       const uint32_t* pp_second_inds_local,
                       const uint32_t  pp_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pp_prim_pair_count_local) && (fabs(pp_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pp_first_inds_local[ij];
            const auto j = pp_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = p_prim_info[j / 3 + p_prim_count * 0];
            const auto c_j = p_prim_info[j / 3 + p_prim_count * 1];
            const auto x_j = p_prim_info[j / 3 + p_prim_count * 2];
            const auto y_j = p_prim_info[j / 3 + p_prim_count * 3];
            const auto z_j = p_prim_info[j / 3 + p_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = j % 3;
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[4];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[3] * (

                        0.25 * ( S1 * S1 ) / ( S2 * S4 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[b0][c1] * delta[d0][d1] * (PA_0 * PQ[c0])
                            + delta[b0][d0] * delta[c1][d1] * (PA_0 * PQ[c0])
                            + delta[b0][d1] * delta[c1][d0] * (PA_0 * PQ[c0])
                            + delta[b0][c0] * delta[d0][d1] * (PA_0 * PQ[c1])
                            + delta[b0][d0] * delta[c0][d1] * (PA_0 * PQ[c1])
                            + delta[b0][d1] * delta[c0][d0] * (PA_0 * PQ[c1])
                            + delta[b0][c0] * delta[c1][d1] * (PA_0 * PQ[d0])
                            + delta[b0][c1] * delta[c0][d1] * (PA_0 * PQ[d0])
                            + delta[b0][d1] * delta[c0][c1] * (PA_0 * PQ[d0])
                            + delta[b0][c0] * delta[c1][d0] * (PA_0 * PQ[d1])
                            + delta[b0][c1] * delta[c0][d0] * (PA_0 * PQ[d1])
                            + delta[b0][d0] * delta[c0][c1] * (PA_0 * PQ[d1])
                            + delta[a0][b0] * delta[d0][d1] * (PQ[c0] * PQ[c1] * (-1.0))
                            + delta[a0][b0] * delta[c1][d1] * (PQ[c0] * PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[c1][d0] * (PQ[c0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[c0][d1] * (PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[c0][c1] * (PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * delta[d0][d1] * (PB_0 * PQ[c0])
                            + delta[a0][d0] * delta[c1][d1] * (PB_0 * PQ[c0])
                            + delta[a0][d1] * delta[c1][d0] * (PB_0 * PQ[c0])
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * PQ[c1])
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * PQ[c1])
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * PQ[c1])
                            + delta[a0][c0] * delta[c1][d1] * (PB_0 * PQ[d0])
                            + delta[a0][c1] * delta[c0][d1] * (PB_0 * PQ[d0])
                            + delta[a0][d1] * delta[c0][c1] * (PB_0 * PQ[d0])
                            + delta[a0][c0] * delta[c1][d0] * (PB_0 * PQ[d1])
                            + delta[a0][c1] * delta[c0][d0] * (PB_0 * PQ[d1])
                            + delta[a0][d0] * delta[c0][c1] * (PB_0 * PQ[d1])
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pp_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPPDD5(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pp_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pp_first_inds_local,
                       const uint32_t* pp_second_inds_local,
                       const uint32_t  pp_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pp_prim_pair_count_local) && (fabs(pp_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pp_first_inds_local[ij];
            const auto j = pp_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = p_prim_info[j / 3 + p_prim_count * 0];
            const auto c_j = p_prim_info[j / 3 + p_prim_count * 1];
            const auto x_j = p_prim_info[j / 3 + p_prim_count * 2];
            const auto y_j = p_prim_info[j / 3 + p_prim_count * 3];
            const auto z_j = p_prim_info[j / 3 + p_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = j % 3;
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[4];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[3] * (

                        0.25 * S1 / ( S4 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PQ[a0] * PQ[b0] * (-2.0))
                            + delta[c0][d0] * delta[c1][d1] * (PQ[a0] * PQ[b0] * (-2.0))
                            + delta[c1][d0] * delta[c0][d1] * (PQ[a0] * PQ[b0] * (-2.0))
                            + delta[b0][c1] * delta[d0][d1] * (PQ[a0] * PQ[c0] * (-1.0) + PQ[a0] * QC_0 * (-1.0))
                            + delta[b0][d0] * delta[c1][d1] * (PQ[a0] * PQ[c0] * (-1.0) + PQ[a0] * QC_0 * (-1.0))
                            + delta[b0][d1] * delta[c1][d0] * (PQ[a0] * PQ[c0] * (-1.0) + PQ[a0] * QC_0 * (-1.0))
                            + delta[b0][c0] * delta[d0][d1] * (PQ[a0] * PQ[c1] * (-1.0) + PQ[a0] * QC_1 * (-1.0))
                            + delta[b0][d0] * delta[c0][d1] * (PQ[a0] * PQ[c1] * (-1.0) + PQ[a0] * QC_1 * (-1.0))
                            + delta[b0][d1] * delta[c0][d0] * (PQ[a0] * PQ[c1] * (-1.0) + PQ[a0] * QC_1 * (-1.0))
                            + delta[b0][c0] * delta[c1][d1] * (PQ[a0] * PQ[d0] * (-1.0) + PQ[a0] * QD_0 * (-1.0))
                            + delta[b0][c1] * delta[c0][d1] * (PQ[a0] * PQ[d0] * (-1.0) + PQ[a0] * QD_0 * (-1.0))
                            + delta[b0][d1] * delta[c0][c1] * (PQ[a0] * PQ[d0] * (-1.0) + PQ[a0] * QD_0 * (-1.0))
                            + delta[b0][c0] * delta[c1][d0] * (PQ[a0] * PQ[d1] * (-1.0) + PQ[a0] * QD_1 * (-1.0))
                            + delta[b0][c1] * delta[c0][d0] * (PQ[a0] * PQ[d1] * (-1.0) + PQ[a0] * QD_1 * (-1.0))
                            + delta[b0][d0] * delta[c0][c1] * (PQ[a0] * PQ[d1] * (-1.0) + PQ[a0] * QD_1 * (-1.0))
                            + delta[a0][c1] * delta[d0][d1] * (PQ[b0] * PQ[c0] * (-1.0) + PQ[b0] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[c1][d1] * (PQ[b0] * PQ[c0] * (-1.0) + PQ[b0] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[c1][d0] * (PQ[b0] * PQ[c0] * (-1.0) + PQ[b0] * QC_0 * (-1.0))
                            + delta[a0][c0] * delta[d0][d1] * (PQ[b0] * PQ[c1] * (-1.0) + PQ[b0] * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[c0][d1] * (PQ[b0] * PQ[c1] * (-1.0) + PQ[b0] * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[c0][d0] * (PQ[b0] * PQ[c1] * (-1.0) + PQ[b0] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[c1][d1] * (PQ[b0] * PQ[d0] * (-1.0) + PQ[b0] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[c0][d1] * (PQ[b0] * PQ[d0] * (-1.0) + PQ[b0] * QD_0 * (-1.0))
                            + delta[a0][d1] * delta[c0][c1] * (PQ[b0] * PQ[d0] * (-1.0) + PQ[b0] * QD_0 * (-1.0))
                            + delta[a0][c0] * delta[c1][d0] * (PQ[b0] * PQ[d1] * (-1.0) + PQ[b0] * QD_1 * (-1.0))
                            + delta[a0][c1] * delta[c0][d0] * (PQ[b0] * PQ[d1] * (-1.0) + PQ[b0] * QD_1 * (-1.0))
                            + delta[a0][d0] * delta[c0][c1] * (PQ[b0] * PQ[d1] * (-1.0) + PQ[b0] * QD_1 * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PQ[c0] * PQ[c1] * (-1.0) + PQ[c0] * QC_1 * (-1.0) + PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c1][d1] * (PQ[c0] * PQ[d0] * (-1.0) + PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c1][d0] * (PQ[c0] * PQ[d1] * (-1.0) + PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b0][d1] * (PQ[c0] * QC_1 * (-1.0) + PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * (PQ[c0] * QC_1 * (-1.0) + PQ[c1] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][d1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d1] * delta[b0][c1] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][d0] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][d0] * delta[b0][c1] * (PQ[c0] * QD_1 * (-1.0) + PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c0][d1] * (PQ[c1] * PQ[d0] * (-1.0) + PQ[c1] * QD_0 * (-1.0) + PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (PQ[c1] * PQ[d1] * (-1.0) + PQ[c1] * QD_1 * (-1.0) + PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[b0][d1] * (PQ[c1] * QD_0 * (-1.0) + PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][d1] * delta[b0][c0] * (PQ[c1] * QD_0 * (-1.0) + PQ[d0] * QC_1 * (-1.0))
                            + delta[a0][c0] * delta[b0][d0] * (PQ[c1] * QD_1 * (-1.0) + PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][d0] * delta[b0][c0] * (PQ[c1] * QD_1 * (-1.0) + PQ[d1] * QC_1 * (-1.0))
                            + delta[a0][b0] * delta[c0][c1] * (PQ[d0] * PQ[d1] * (-1.0) + PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c0] * delta[b0][c1] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][c1] * delta[b0][c0] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                        )

                    )

                    +

                    F6_t[3] * (

                        0.5 * ( S1 * S1 ) / ( S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[a0] * PQ[c0] * PQ[c1] + PB_0 * PQ[a0] * PQ[c0] * QC_1 + PB_0 * PQ[a0] * PQ[c1] * QC_0 + PA_0 * PQ[b0] * PQ[c0] * PQ[c1] + PA_0 * PQ[b0] * PQ[c0] * QC_1 + PA_0 * PQ[b0] * PQ[c1] * QC_0)
                            + delta[c1][d1] * (PB_0 * PQ[a0] * PQ[c0] * PQ[d0] + PB_0 * PQ[a0] * PQ[c0] * QD_0 + PB_0 * PQ[a0] * PQ[d0] * QC_0 + PA_0 * PQ[b0] * PQ[c0] * PQ[d0] + PA_0 * PQ[b0] * PQ[c0] * QD_0 + PA_0 * PQ[b0] * PQ[d0] * QC_0)
                            + delta[c1][d0] * (PB_0 * PQ[a0] * PQ[c0] * PQ[d1] + PB_0 * PQ[a0] * PQ[c0] * QD_1 + PB_0 * PQ[a0] * PQ[d1] * QC_0 + PA_0 * PQ[b0] * PQ[c0] * PQ[d1] + PA_0 * PQ[b0] * PQ[c0] * QD_1 + PA_0 * PQ[b0] * PQ[d1] * QC_0)
                            + delta[c0][d1] * (PB_0 * PQ[a0] * PQ[c1] * PQ[d0] + PB_0 * PQ[a0] * PQ[c1] * QD_0 + PB_0 * PQ[a0] * PQ[d0] * QC_1 + PA_0 * PQ[b0] * PQ[c1] * PQ[d0] + PA_0 * PQ[b0] * PQ[c1] * QD_0 + PA_0 * PQ[b0] * PQ[d0] * QC_1)
                            + delta[c0][d0] * (PB_0 * PQ[a0] * PQ[c1] * PQ[d1] + PB_0 * PQ[a0] * PQ[c1] * QD_1 + PB_0 * PQ[a0] * PQ[d1] * QC_1 + PA_0 * PQ[b0] * PQ[c1] * PQ[d1] + PA_0 * PQ[b0] * PQ[c1] * QD_1 + PA_0 * PQ[b0] * PQ[d1] * QC_1)
                            + delta[c0][c1] * (PB_0 * PQ[a0] * PQ[d0] * PQ[d1] + PB_0 * PQ[a0] * PQ[d0] * QD_1 + PB_0 * PQ[a0] * PQ[d1] * QD_0 + PA_0 * PQ[b0] * PQ[d0] * PQ[d1] + PA_0 * PQ[b0] * PQ[d0] * QD_1 + PA_0 * PQ[b0] * PQ[d1] * QD_0)
                            + delta[b0][d1] * (PA_0 * PQ[c0] * PQ[c1] * QD_0 + PA_0 * PQ[c0] * PQ[d0] * QC_1 + PA_0 * PQ[c1] * PQ[d0] * QC_0)
                            + delta[b0][d0] * (PA_0 * PQ[c0] * PQ[c1] * QD_1 + PA_0 * PQ[c0] * PQ[d1] * QC_1 + PA_0 * PQ[c1] * PQ[d1] * QC_0)
                            + delta[b0][c1] * (PA_0 * PQ[c0] * PQ[d0] * QD_1 + PA_0 * PQ[c0] * PQ[d1] * QD_0 + PA_0 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[b0][c0] * (PA_0 * PQ[c1] * PQ[d0] * QD_1 + PA_0 * PQ[c1] * PQ[d1] * QD_0 + PA_0 * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a0][d1] * (PB_0 * PQ[c0] * PQ[c1] * QD_0 + PB_0 * PQ[c0] * PQ[d0] * QC_1 + PB_0 * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a0][d0] * (PB_0 * PQ[c0] * PQ[c1] * QD_1 + PB_0 * PQ[c0] * PQ[d1] * QC_1 + PB_0 * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a0][c1] * (PB_0 * PQ[c0] * PQ[d0] * QD_1 + PB_0 * PQ[c0] * PQ[d1] * QD_0 + PB_0 * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][c0] * (PB_0 * PQ[c1] * PQ[d0] * QD_1 + PB_0 * PQ[c1] * PQ[d1] * QD_0 + PB_0 * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a0][b0] * (PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0) + PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0) + PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0) + PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                        )

                    )

                    +

                    F6_t[3] * (

                        0.5 * ( S1 * S1 * S1 ) / ( S2 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PA_0 * PQ[c0] * PQ[c1] * (-1.0))
                            + delta[c1][d1] * (PB_0 * PA_0 * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[c1][d0] * (PB_0 * PA_0 * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[c0][d1] * (PB_0 * PA_0 * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[c0][d0] * (PB_0 * PA_0 * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[c0][c1] * (PB_0 * PA_0 * PQ[d0] * PQ[d1] * (-1.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pp_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPPDD6(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pp_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pp_first_inds_local,
                       const uint32_t* pp_second_inds_local,
                       const uint32_t  pp_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pp_prim_pair_count_local) && (fabs(pp_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pp_first_inds_local[ij];
            const auto j = pp_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = p_prim_info[j / 3 + p_prim_count * 0];
            const auto c_j = p_prim_info[j / 3 + p_prim_count * 1];
            const auto x_j = p_prim_info[j / 3 + p_prim_count * 2];
            const auto y_j = p_prim_info[j / 3 + p_prim_count * 3];
            const auto z_j = p_prim_info[j / 3 + p_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = j % 3;
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[5];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[3] * (

                        0.5 * ( S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[c1] * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * QC_0 * QC_1 * (-1.0))
                            + delta[c1][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * QD_0 * QC_0 * (-1.0))
                            + delta[c1][d0] * (PQ[a0] * PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d1] * QC_0 * (-1.0) + PQ[a0] * PQ[b0] * QD_1 * QC_0 * (-1.0))
                            + delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d0] * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * QD_0 * QC_1 * (-1.0))
                            + delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d1] * QC_1 * (-1.0) + PQ[a0] * PQ[b0] * QD_1 * QC_1 * (-1.0))
                            + delta[c0][c1] * (PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PQ[a0] * PQ[b0] * QD_0 * QD_1 * (-1.0))
                            + delta[b0][d1] * (PQ[a0] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PQ[a0] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PQ[a0] * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][d0] * (PQ[a0] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][c1] * (PQ[a0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[a0] * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[b0][c0] * (PQ[a0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[a0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[a0] * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[a0][d1] * (PQ[b0] * PQ[c0] * QD_0 * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * QD_0 * QC_0 * (-1.0) + PQ[b0] * PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][d0] * (PQ[b0] * PQ[c0] * QD_1 * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * QD_1 * QC_0 * (-1.0) + PQ[b0] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[a0][c1] * (PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][c0] * (PQ[b0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[b0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[b0] * PQ[d1] * QD_0 * QC_1 * (-1.0))
                            + delta[a0][b0] * (PQ[c0] * PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[c0] * PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[c0] * PQ[d1] * QD_0 * QC_1 * (-1.0) + PQ[c1] * PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[c1] * PQ[d1] * QD_0 * QC_0 * (-1.0) + PQ[d0] * PQ[d1] * QC_0 * QC_1 * (-1.0))
                        )

                    )

                    +

                    F6_t[4] * (

                        ( S1 * S1 * S1 * S1 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PA_0 * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                        )

                    )

                    +

                    F6_t[4] * (

                        ( S1 * S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                        )

                    )

                    +

                    F6_t[4] * (

                        ( S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PQ[a0] * PQ[b0] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                        )

                    )

                    +

                    F6_t[4] * (

                        0.5 * ( S1 * S1 * S1 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[a0] * PQ[c0] * PQ[c1] * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * (-1.0))
                            + delta[c1][d1] * (PB_0 * PQ[a0] * PQ[c0] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[c1][d0] * (PB_0 * PQ[a0] * PQ[c0] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[c0][d1] * (PB_0 * PQ[a0] * PQ[c1] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[c0][d0] * (PB_0 * PQ[a0] * PQ[c1] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[c0][c1] * (PB_0 * PQ[a0] * PQ[d0] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][d1] * (PA_0 * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PA_0 * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[b0][c1] * (PA_0 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][c0] * (PA_0 * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][d1] * (PB_0 * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][d0] * (PB_0 * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * (PB_0 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * (PB_0 * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * (PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1])
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pp_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPPDD7(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pp_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pp_first_inds_local,
                       const uint32_t* pp_second_inds_local,
                       const uint32_t  pp_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pp_prim_pair_count_local) && (fabs(pp_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pp_first_inds_local[ij];
            const auto j = pp_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = p_prim_info[j / 3 + p_prim_count * 0];
            const auto c_j = p_prim_info[j / 3 + p_prim_count * 1];
            const auto x_j = p_prim_info[j / 3 + p_prim_count * 2];
            const auto y_j = p_prim_info[j / 3 + p_prim_count * 3];
            const auto z_j = p_prim_info[j / 3 + p_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = j % 3;
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[6];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 5, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[4] * (

                        0.5 * ( S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] + PQ[a0] * PQ[b0] * PQ[c0] * QC_1 + PQ[a0] * PQ[b0] * PQ[c1] * QC_0)
                            + delta[c1][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] + PQ[a0] * PQ[b0] * PQ[c0] * QD_0 + PQ[a0] * PQ[b0] * PQ[d0] * QC_0)
                            + delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] + PQ[a0] * PQ[b0] * PQ[c1] * QD_0 + PQ[a0] * PQ[b0] * PQ[d0] * QC_1)
                            + delta[c1][d0] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1] + PQ[a0] * PQ[b0] * PQ[c0] * QD_1 + PQ[a0] * PQ[b0] * PQ[d1] * QC_0)
                            + delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[c1] * PQ[d1] + PQ[a0] * PQ[b0] * PQ[c1] * QD_1 + PQ[a0] * PQ[b0] * PQ[d1] * QC_1)
                            + delta[b0][d1] * (PQ[a0] * PQ[c0] * PQ[c1] * QD_0 + PQ[a0] * PQ[c0] * PQ[d0] * QC_1 + PQ[a0] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[b0][d0] * (PQ[a0] * PQ[c0] * PQ[c1] * QD_1 + PQ[a0] * PQ[c0] * PQ[d1] * QC_1 + PQ[a0] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[b0][c1] * (PQ[a0] * PQ[c0] * PQ[d0] * QD_1 + PQ[a0] * PQ[c0] * PQ[d1] * QD_0 + PQ[a0] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[b0][c0] * (PQ[a0] * PQ[c1] * PQ[d0] * QD_1 + PQ[a0] * PQ[c1] * PQ[d1] * QD_0 + PQ[a0] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a0][d1] * (PQ[b0] * PQ[c0] * PQ[c1] * QD_0 + PQ[b0] * PQ[c0] * PQ[d0] * QC_1 + PQ[b0] * PQ[c1] * PQ[d0] * QC_0)
                            + delta[a0][d0] * (PQ[b0] * PQ[c0] * PQ[c1] * QD_1 + PQ[b0] * PQ[c0] * PQ[d1] * QC_1 + PQ[b0] * PQ[c1] * PQ[d1] * QC_0)
                            + delta[a0][c1] * (PQ[b0] * PQ[c0] * PQ[d0] * QD_1 + PQ[b0] * PQ[c0] * PQ[d1] * QD_0 + PQ[b0] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[a0][c0] * (PQ[b0] * PQ[c1] * PQ[d0] * QD_1 + PQ[b0] * PQ[c1] * PQ[d1] * QD_0 + PQ[b0] * PQ[d0] * PQ[d1] * QC_1)
                            + delta[a0][b0] * (PQ[c0] * PQ[c1] * PQ[d0] * QD_1 + PQ[c0] * PQ[c1] * PQ[d1] * QD_0 + PQ[c0] * PQ[d0] * PQ[d1] * QC_1 + PQ[c1] * PQ[d0] * PQ[d1] * QC_0)
                            + delta[c0][c1] * (PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1] + PQ[a0] * PQ[b0] * PQ[d0] * QD_1 + PQ[a0] * PQ[b0] * PQ[d1] * QD_0)
                        )

                    )

                    +

                    F6_t[4] * (

                        0.25 * ( S1 * S1 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PQ[a0] * PQ[b0])
                            + delta[c0][d0] * delta[c1][d1] * (PQ[a0] * PQ[b0])
                            + delta[c1][d0] * delta[c0][d1] * (PQ[a0] * PQ[b0])
                            + delta[b0][c1] * delta[d0][d1] * (PQ[a0] * PQ[c0])
                            + delta[b0][d0] * delta[c1][d1] * (PQ[a0] * PQ[c0])
                            + delta[b0][d1] * delta[c1][d0] * (PQ[a0] * PQ[c0])
                            + delta[b0][c0] * delta[d0][d1] * (PQ[a0] * PQ[c1])
                            + delta[b0][d0] * delta[c0][d1] * (PQ[a0] * PQ[c1])
                            + delta[b0][d1] * delta[c0][d0] * (PQ[a0] * PQ[c1])
                            + delta[b0][c0] * delta[c1][d1] * (PQ[a0] * PQ[d0])
                            + delta[b0][c1] * delta[c0][d1] * (PQ[a0] * PQ[d0])
                            + delta[b0][d1] * delta[c0][c1] * (PQ[a0] * PQ[d0])
                            + delta[b0][c0] * delta[c1][d0] * (PQ[a0] * PQ[d1])
                            + delta[b0][c1] * delta[c0][d0] * (PQ[a0] * PQ[d1])
                            + delta[b0][d0] * delta[c0][c1] * (PQ[a0] * PQ[d1])
                            + delta[a0][c1] * delta[d0][d1] * (PQ[b0] * PQ[c0])
                            + delta[a0][d0] * delta[c1][d1] * (PQ[b0] * PQ[c0])
                            + delta[a0][d1] * delta[c1][d0] * (PQ[b0] * PQ[c0])
                            + delta[a0][c0] * delta[d0][d1] * (PQ[b0] * PQ[c1])
                            + delta[a0][d0] * delta[c0][d1] * (PQ[b0] * PQ[c1])
                            + delta[a0][d1] * delta[c0][d0] * (PQ[b0] * PQ[c1])
                            + delta[a0][c0] * delta[c1][d1] * (PQ[b0] * PQ[d0])
                            + delta[a0][c1] * delta[c0][d1] * (PQ[b0] * PQ[d0])
                            + delta[a0][d1] * delta[c0][c1] * (PQ[b0] * PQ[d0])
                            + delta[a0][c0] * delta[c1][d0] * (PQ[b0] * PQ[d1])
                            + delta[a0][c1] * delta[c0][d0] * (PQ[b0] * PQ[d1])
                            + delta[a0][d0] * delta[c0][c1] * (PQ[b0] * PQ[d1])
                            + delta[a0][d0] * delta[b0][d1] * (PQ[c0] * PQ[c1])
                            + delta[a0][d1] * delta[b0][d0] * (PQ[c0] * PQ[c1])
                            + delta[a0][b0] * delta[d0][d1] * (PQ[c0] * PQ[c1])
                            + delta[a0][c1] * delta[b0][d1] * (PQ[c0] * PQ[d0])
                            + delta[a0][d1] * delta[b0][c1] * (PQ[c0] * PQ[d0])
                            + delta[a0][b0] * delta[c1][d1] * (PQ[c0] * PQ[d0])
                            + delta[a0][c1] * delta[b0][d0] * (PQ[c0] * PQ[d1])
                            + delta[a0][d0] * delta[b0][c1] * (PQ[c0] * PQ[d1])
                            + delta[a0][b0] * delta[c1][d0] * (PQ[c0] * PQ[d1])
                            + delta[a0][c0] * delta[b0][d1] * (PQ[c1] * PQ[d0])
                            + delta[a0][d1] * delta[b0][c0] * (PQ[c1] * PQ[d0])
                            + delta[a0][b0] * delta[c0][d1] * (PQ[c1] * PQ[d0])
                            + delta[a0][c0] * delta[b0][d0] * (PQ[c1] * PQ[d1])
                            + delta[a0][d0] * delta[b0][c0] * (PQ[c1] * PQ[d1])
                            + delta[a0][b0] * delta[c0][d0] * (PQ[c1] * PQ[d1])
                            + delta[a0][c0] * delta[b0][c1] * (PQ[d0] * PQ[d1])
                            + delta[a0][c1] * delta[b0][c0] * (PQ[d0] * PQ[d1])
                            + delta[a0][b0] * delta[c0][c1] * (PQ[d0] * PQ[d1])
                        )

                    )

                    +

                    F6_t[5] * (

                        ( S1 * S1 * S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                            + PA_0 * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                        )

                    )

                    +

                    F6_t[5] * (

                        ( S1 * S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            
                            + PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pp_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPPDD8(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   pp_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* pp_first_inds_local,
                       const uint32_t* pp_second_inds_local,
                       const uint32_t  pp_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)

{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM_LARGE + 1][TILE_DIM_SMALL];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM_LARGE - 1) / TILE_DIM_LARGE; m++)
    {
        const uint32_t kl = m * TILE_DIM_LARGE + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < pp_prim_pair_count_local) && (fabs(pp_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pp_first_inds_local[ij];
            const auto j = pp_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = p_prim_info[j / 3 + p_prim_count * 0];
            const auto c_j = p_prim_info[j / 3 + p_prim_count * 1];
            const auto x_j = p_prim_info[j / 3 + p_prim_count * 2];
            const auto y_j = p_prim_info[j / 3 + p_prim_count * 3];
            const auto z_j = p_prim_info[j / 3 + p_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = j % 3;
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F6_t[7];

            gpu::computeBoysFunction(F6_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 6, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F6_t[5] * (

                        0.5 * ( S1 * S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * (-1.0))
                            + delta[c1][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[c1][d0] * (PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[c0][c1] * (PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][d1] * (PQ[a0] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PQ[a0] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[b0][c1] * (PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][c0] * (PQ[a0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][d1] * (PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[a0][d0] * (PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[a0][c1] * (PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][c0] * (PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * (PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                        )

                    )

                    +

                    F6_t[6] * (

                        ( S1 * S1 * S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM_LARGE; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pp_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPPPD0(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   pp_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* pp_first_inds_local,
                       const uint32_t* pp_second_inds_local,
                       const uint32_t  pp_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < pp_prim_pair_count_local) && (fabs(pp_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pp_first_inds_local[ij];
            const auto j = pp_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = p_prim_info[j / 3 + p_prim_count * 0];
            const auto c_j = p_prim_info[j / 3 + p_prim_count * 1];
            const auto x_j = p_prim_info[j / 3 + p_prim_count * 2];
            const auto y_j = p_prim_info[j / 3 + p_prim_count * 3];
            const auto z_j = p_prim_info[j / 3 + p_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = j % 3;
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F5_t[3];

            gpu::computeBoysFunction(F5_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F5_t[0] * (

                        0.25 / ( S1 * S2 ) * (
                            delta[a0][b0] * delta[d0][d1] * QC_0
                            + delta[a0][b0] * delta[c0][d1] * QD_0
                            + delta[a0][b0] * delta[c0][d0] * QD_1
                        )

                    )

                    +

                    F5_t[0] * (

                        0.5 / S1 * (
                            delta[a0][b0] * (QD_0 * QD_1 * QC_0)
                        )

                    )

                    +

                    F5_t[0] * (

                        0.5 / S2 * (
                            delta[d0][d1] * (PB_0 * PA_0 * QC_0)
                            + delta[c0][d1] * (PB_0 * PA_0 * QD_0)
                            + delta[c0][d0] * (PB_0 * PA_0 * QD_1)
                        )

                    )

                    +

                    F5_t[0] * (

                        (
                            
                            + PB_0 * PA_0 * QD_0 * QD_1 * QC_0
                        )

                    )

                    +

                    F5_t[1] * (

                        0.25 / ( S1 * S4 ) * (
                            delta[a0][b0] * delta[d0][d1] * (QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c0][d1] * (QD_0 * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (QD_1 * (-1.0))
                        )

                    )

                    +

                    F5_t[1] * (

                        0.25 / ( S2 * S4 ) * (
                            delta[b0][c0] * delta[d0][d1] * PA_0
                            + delta[b0][d0] * delta[c0][d1] * PA_0
                            + delta[b0][d1] * delta[c0][d0] * PA_0
                            + delta[a0][b0] * delta[d0][d1] * (PQ[c0] * (-1.0) + QC_0 * (-1.0))
                            + delta[a0][b0] * delta[c0][d1] * (PQ[d0] * (-1.0) + QD_0 * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (PQ[d1] * (-1.0) + QD_1 * (-1.0))
                            + delta[a0][c0] * delta[d0][d1] * PB_0
                            + delta[a0][d0] * delta[c0][d1] * PB_0
                            + delta[a0][d1] * delta[c0][d0] * PB_0
                        )

                    )

                    +

                    F5_t[1] * (

                        0.5 * S1 / ( S2 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PA_0 * PQ[c0] * (-1.0) + PB_0 * PA_0 * QC_0 * (-1.0))
                            + delta[c0][d1] * (PB_0 * PA_0 * PQ[d0] * (-1.0) + PB_0 * PA_0 * QD_0 * (-1.0))
                            + delta[c0][d0] * (PB_0 * PA_0 * PQ[d1] * (-1.0) + PB_0 * PA_0 * QD_1 * (-1.0))
                        )

                    )

                    +

                    F5_t[1] * (

                        0.5 * S2 / ( S1 * S4 ) * (
                            delta[a0][b0] * (QD_0 * QD_1 * QC_0 * (-1.0))
                        )

                    )

                    +

                    F5_t[1] * (

                        0.5 / S4 * (
                            delta[d0][d1] * (PB_0 * PQ[a0] * QC_0 + PA_0 * PQ[b0] * QC_0)
                            + delta[c0][d1] * (PB_0 * PQ[a0] * QD_0 + PA_0 * PQ[b0] * QD_0)
                            + delta[c0][d0] * (PB_0 * PQ[a0] * QD_1 + PA_0 * PQ[b0] * QD_1)
                            + delta[b0][d1] * (PA_0 * QD_0 * QC_0)
                            + delta[b0][d0] * (PA_0 * QD_1 * QC_0)
                            + delta[b0][c0] * (PA_0 * QD_0 * QD_1)
                            + delta[a0][d1] * (PB_0 * QD_0 * QC_0)
                            + delta[a0][d0] * (PB_0 * QD_1 * QC_0)
                            + delta[a0][b0] * (PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[a0][c0] * (PB_0 * QD_0 * QD_1)
                        )

                    )

                    +

                    F5_t[1] * (

                        S1 / S4 * (
                            
                            + PB_0 * PA_0 * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PB_0 * PA_0 * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PA_0 * PQ[d1] * QD_0 * QC_0 * (-1.0)
                        )

                    )

                    +

                    F5_t[1] * (

                        S2 / S4 * (
                            
                            + PB_0 * PQ[a0] * QD_0 * QD_1 * QC_0
                            + PA_0 * PQ[b0] * QD_0 * QD_1 * QC_0
                        )

                    )

                    +

                    F5_t[2] * (

                        ( S1 * S1 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PA_0 * PQ[c0] * PQ[d0] * QD_1
                            + PB_0 * PA_0 * PQ[c0] * PQ[d1] * QD_0
                            + PB_0 * PA_0 * PQ[d0] * PQ[d1] * QC_0
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pp_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPPPD1(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   pp_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* pp_first_inds_local,
                       const uint32_t* pp_second_inds_local,
                       const uint32_t  pp_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < pp_prim_pair_count_local) && (fabs(pp_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pp_first_inds_local[ij];
            const auto j = pp_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = p_prim_info[j / 3 + p_prim_count * 0];
            const auto c_j = p_prim_info[j / 3 + p_prim_count * 1];
            const auto x_j = p_prim_info[j / 3 + p_prim_count * 2];
            const auto y_j = p_prim_info[j / 3 + p_prim_count * 3];
            const auto z_j = p_prim_info[j / 3 + p_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = j % 3;
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F5_t[4];

            gpu::computeBoysFunction(F5_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F5_t[2] * (

                        ( S1 * S2 ) / ( S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                        )

                    )

                    +

                    F5_t[2] * (

                        ( S2 * S2 ) / ( S4 * S4 ) * (
                            
                            + PQ[a0] * PQ[b0] * QD_0 * QD_1 * QC_0
                        )

                    )

                    +

                    F5_t[2] * (

                        0.25 * S1 / ( S2 * S4 * S4 ) * (
                            delta[b0][c0] * delta[d0][d1] * (PA_0 * (-1.0))
                            + delta[b0][d0] * delta[c0][d1] * (PA_0 * (-1.0))
                            + delta[b0][d1] * delta[c0][d0] * (PA_0 * (-1.0))
                            + delta[a0][c0] * delta[d0][d1] * (PB_0 * (-1.0))
                            + delta[a0][d0] * delta[c0][d1] * (PB_0 * (-1.0))
                            + delta[a0][d1] * delta[c0][d0] * (PB_0 * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PQ[c0])
                            + delta[a0][b0] * delta[c0][d1] * (PQ[d0])
                            + delta[a0][b0] * delta[c0][d0] * (PQ[d1])
                        )

                    )

                    +

                    F5_t[2] * (

                        0.25 / ( S4 * S4 ) * (
                            delta[a0][d0] * delta[b0][d1] * QC_0
                            + delta[a0][d1] * delta[b0][d0] * QC_0
                            + delta[a0][b0] * delta[d0][d1] * (PQ[c0] + QC_0)
                            + delta[b0][c0] * delta[d0][d1] * (PQ[a0])
                            + delta[b0][d0] * delta[c0][d1] * (PQ[a0])
                            + delta[b0][d1] * delta[c0][d0] * (PQ[a0])
                            + delta[a0][c0] * delta[d0][d1] * (PQ[b0])
                            + delta[a0][d0] * delta[c0][d1] * (PQ[b0])
                            + delta[a0][d1] * delta[c0][d0] * (PQ[b0])
                            + delta[a0][b0] * delta[c0][d1] * (PQ[d0] + QD_0)
                            + delta[a0][b0] * delta[c0][d0] * (PQ[d1] + QD_1)
                            + delta[a0][c0] * delta[b0][d1] * QD_0
                            + delta[a0][d1] * delta[b0][c0] * QD_0
                            + delta[a0][c0] * delta[b0][d0] * QD_1
                            + delta[a0][d0] * delta[b0][c0] * QD_1
                        )

                    )

                    +

                    F5_t[2] * (

                        0.5 * ( S1 * S1 ) / ( S2 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PA_0 * PQ[c0])
                            + delta[c0][d1] * (PB_0 * PA_0 * PQ[d0])
                            + delta[c0][d0] * (PB_0 * PA_0 * PQ[d1])
                        )

                    )

                    +

                    F5_t[2] * (

                        0.5 * S1 / ( S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[a0] * PQ[c0] * (-1.0) + PB_0 * PQ[a0] * QC_0 * (-1.0) + PA_0 * PQ[b0] * PQ[c0] * (-1.0) + PA_0 * PQ[b0] * QC_0 * (-1.0))
                            + delta[c0][d1] * (PB_0 * PQ[a0] * PQ[d0] * (-1.0) + PB_0 * PQ[a0] * QD_0 * (-1.0) + PA_0 * PQ[b0] * PQ[d0] * (-1.0) + PA_0 * PQ[b0] * QD_0 * (-1.0))
                            + delta[c0][d0] * (PB_0 * PQ[a0] * PQ[d1] * (-1.0) + PB_0 * PQ[a0] * QD_1 * (-1.0) + PA_0 * PQ[b0] * PQ[d1] * (-1.0) + PA_0 * PQ[b0] * QD_1 * (-1.0))
                            + delta[b0][d1] * (PA_0 * PQ[c0] * QD_0 * (-1.0) + PA_0 * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][d0] * (PA_0 * PQ[c0] * QD_1 * (-1.0) + PA_0 * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][c0] * (PA_0 * PQ[d0] * QD_1 * (-1.0) + PA_0 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][d1] * (PB_0 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d0] * (PB_0 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][c0] * (PB_0 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][b0] * (PQ[c0] * PQ[d0] * QD_1 + PQ[c0] * PQ[d1] * QD_0 + PQ[d0] * PQ[d1] * QC_0)
                        )

                    )

                    +

                    F5_t[2] * (

                        0.5 * S2 / ( S4 * S4 ) * (
                            delta[d0][d1] * (PQ[a0] * PQ[b0] * QC_0)
                            + delta[b0][d1] * (PQ[a0] * QD_0 * QC_0)
                            + delta[b0][d0] * (PQ[a0] * QD_1 * QC_0)
                            + delta[a0][d1] * (PQ[b0] * QD_0 * QC_0)
                            + delta[a0][d0] * (PQ[b0] * QD_1 * QC_0)
                            + delta[a0][b0] * (PQ[c0] * QD_0 * QD_1 + PQ[d0] * QD_1 * QC_0 + PQ[d1] * QD_0 * QC_0)
                            + delta[c0][d1] * (PQ[a0] * PQ[b0] * QD_0)
                            + delta[c0][d0] * (PQ[a0] * PQ[b0] * QD_1)
                            + delta[b0][c0] * (PQ[a0] * QD_0 * QD_1)
                            + delta[a0][c0] * (PQ[b0] * QD_0 * QD_1)
                        )

                    )

                    +

                    F5_t[3] * (

                        ( S1 * S1 * S1 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PA_0 * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                        )

                    )

                    +

                    F5_t[3] * (

                        ( S1 * S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[c0] * PQ[d0] * QD_1
                            + PB_0 * PQ[a0] * PQ[c0] * PQ[d1] * QD_0
                            + PB_0 * PQ[a0] * PQ[d0] * PQ[d1] * QC_0
                            + PA_0 * PQ[b0] * PQ[c0] * PQ[d0] * QD_1
                            + PA_0 * PQ[b0] * PQ[c0] * PQ[d1] * QD_0
                            + PA_0 * PQ[b0] * PQ[d0] * PQ[d1] * QC_0
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pp_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPPPD2(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   pd_mat_D,
                       const double*   pp_mat_Q_local,
                       const double*   pd_mat_Q,
                       const uint32_t* pp_first_inds_local,
                       const uint32_t* pp_second_inds_local,
                       const uint32_t  pp_prim_pair_count_local,
                       const uint32_t* pd_first_inds,
                       const uint32_t* pd_second_inds,
                       const uint32_t  pd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pd_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < pd_prim_pair_count) && (ij < pp_prim_pair_count_local) && (fabs(pp_mat_Q_local[ij] * pd_mat_Q[kl] * pd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pp_first_inds_local[ij];
            const auto j = pp_second_inds_local[ij];

            const auto k = pd_first_inds[kl];
            const auto l = pd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = p_prim_info[j / 3 + p_prim_count * 0];
            const auto c_j = p_prim_info[j / 3 + p_prim_count * 1];
            const auto x_j = p_prim_info[j / 3 + p_prim_count * 2];
            const auto y_j = p_prim_info[j / 3 + p_prim_count * 3];
            const auto z_j = p_prim_info[j / 3 + p_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = j % 3;
            const auto c0 = k % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F5_t[6];

            gpu::computeBoysFunction(F5_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 5, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F5_t[3] * (

                        ( S1 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            
                            + PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * QD_1 * (-1.0)
                            + PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * QC_0 * (-1.0)
                            + PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * QC_0 * (-1.0)
                        )

                    )

                    +

                    F5_t[3] * (

                        0.25 * S1 / ( S4 * S4 * S4 ) * (
                            delta[b0][c0] * delta[d0][d1] * (PQ[a0] * (-1.0))
                            + delta[b0][d0] * delta[c0][d1] * (PQ[a0] * (-1.0))
                            + delta[b0][d1] * delta[c0][d0] * (PQ[a0] * (-1.0))
                            + delta[a0][c0] * delta[d0][d1] * (PQ[b0] * (-1.0))
                            + delta[a0][d0] * delta[c0][d1] * (PQ[b0] * (-1.0))
                            + delta[a0][d1] * delta[c0][d0] * (PQ[b0] * (-1.0))
                            + delta[a0][d0] * delta[b0][d1] * (PQ[c0] * (-1.0))
                            + delta[a0][d1] * delta[b0][d0] * (PQ[c0] * (-1.0))
                            + delta[a0][b0] * delta[d0][d1] * (PQ[c0] * (-1.0))
                            + delta[a0][c0] * delta[b0][d1] * (PQ[d0] * (-1.0))
                            + delta[a0][d1] * delta[b0][c0] * (PQ[d0] * (-1.0))
                            + delta[a0][b0] * delta[c0][d1] * (PQ[d0] * (-1.0))
                            + delta[a0][c0] * delta[b0][d0] * (PQ[d1] * (-1.0))
                            + delta[a0][d0] * delta[b0][c0] * (PQ[d1] * (-1.0))
                            + delta[a0][b0] * delta[c0][d0] * (PQ[d1] * (-1.0))
                        )

                    )

                    +

                    F5_t[3] * (

                        0.5 * ( S1 * S1 ) / ( S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[a0] * PQ[c0] + PA_0 * PQ[b0] * PQ[c0])
                            + delta[c0][d1] * (PB_0 * PQ[a0] * PQ[d0] + PA_0 * PQ[b0] * PQ[d0])
                            + delta[c0][d0] * (PB_0 * PQ[a0] * PQ[d1] + PA_0 * PQ[b0] * PQ[d1])
                            + delta[b0][d1] * (PA_0 * PQ[c0] * PQ[d0])
                            + delta[b0][d0] * (PA_0 * PQ[c0] * PQ[d1])
                            + delta[b0][c0] * (PA_0 * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * (PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[a0][d1] * (PB_0 * PQ[c0] * PQ[d0])
                            + delta[a0][d0] * (PB_0 * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * (PB_0 * PQ[d0] * PQ[d1])
                        )

                    )

                    +

                    F5_t[3] * (

                        0.5 * ( S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[c0] * (-1.0) + PQ[a0] * PQ[b0] * QC_0 * (-1.0))
                            + delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[d0] * (-1.0) + PQ[a0] * PQ[b0] * QD_0 * (-1.0))
                            + delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[d1] * (-1.0) + PQ[a0] * PQ[b0] * QD_1 * (-1.0))
                            + delta[b0][d1] * (PQ[a0] * PQ[c0] * QD_0 * (-1.0) + PQ[a0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[b0][d0] * (PQ[a0] * PQ[c0] * QD_1 * (-1.0) + PQ[a0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[b0][c0] * (PQ[a0] * PQ[d0] * QD_1 * (-1.0) + PQ[a0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][d1] * (PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PQ[b0] * PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][d0] * (PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PQ[b0] * PQ[d1] * QC_0 * (-1.0))
                            + delta[a0][c0] * (PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][b0] * (PQ[c0] * PQ[d0] * QD_1 * (-1.0) + PQ[c0] * PQ[d1] * QD_0 * (-1.0) + PQ[d0] * PQ[d1] * QC_0 * (-1.0))
                        )

                    )

                    +

                    F5_t[4] * (

                        ( S1 * S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[a0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                            + PA_0 * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                        )

                    )

                    +

                    F5_t[4] * (

                        ( S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * QD_1
                            + PQ[a0] * PQ[b0] * PQ[c0] * PQ[d1] * QD_0
                            + PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1] * QC_0
                        )

                    )

                    +

                    F5_t[4] * (

                        0.5 * ( S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[a0] * PQ[b0] * PQ[c0])
                            + delta[c0][d1] * (PQ[a0] * PQ[b0] * PQ[d0])
                            + delta[c0][d0] * (PQ[a0] * PQ[b0] * PQ[d1])
                            + delta[b0][d1] * (PQ[a0] * PQ[c0] * PQ[d0])
                            + delta[b0][d0] * (PQ[a0] * PQ[c0] * PQ[d1])
                            + delta[b0][c0] * (PQ[a0] * PQ[d0] * PQ[d1])
                            + delta[a0][d1] * (PQ[b0] * PQ[c0] * PQ[d0])
                            + delta[a0][d0] * (PQ[b0] * PQ[c0] * PQ[d1])
                            + delta[a0][c0] * (PQ[b0] * PQ[d0] * PQ[d1])
                            + delta[a0][b0] * (PQ[c0] * PQ[d0] * PQ[d1])
                        )

                    )

                    +

                    F5_t[5] * (

                        ( S1 * S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * (-1.0)
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pp_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPPPP(double*         mat_J,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   pp_mat_D,
                       const double*   pp_mat_Q_local,
                       const double*   pp_mat_Q,
                       const uint32_t* pp_first_inds_local,
                       const uint32_t* pp_second_inds_local,
                       const uint32_t  pp_prim_pair_count_local,
                       const uint32_t* pp_first_inds,
                       const uint32_t* pp_second_inds,
                       const uint32_t  pp_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (pp_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < pp_prim_pair_count) && (ij < pp_prim_pair_count_local) && (fabs(pp_mat_Q_local[ij] * pp_mat_Q[kl] * pp_mat_D[kl]) > eri_threshold))
        {
            const auto i = pp_first_inds_local[ij];
            const auto j = pp_second_inds_local[ij];

            const auto k = pp_first_inds[kl];
            const auto l = pp_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = p_prim_info[j / 3 + p_prim_count * 0];
            const auto c_j = p_prim_info[j / 3 + p_prim_count * 1];
            const auto x_j = p_prim_info[j / 3 + p_prim_count * 2];
            const auto y_j = p_prim_info[j / 3 + p_prim_count * 3];
            const auto z_j = p_prim_info[j / 3 + p_prim_count * 4];

            const auto a_k = p_prim_info[k / 3 + p_prim_count * 0];
            const auto c_k = p_prim_info[k / 3 + p_prim_count * 1];
            const auto x_k = p_prim_info[k / 3 + p_prim_count * 2];
            const auto y_k = p_prim_info[k / 3 + p_prim_count * 3];
            const auto z_k = p_prim_info[k / 3 + p_prim_count * 4];

            const auto a_l = p_prim_info[l / 3 + p_prim_count * 0];
            const auto c_l = p_prim_info[l / 3 + p_prim_count * 1];
            const auto x_l = p_prim_info[l / 3 + p_prim_count * 2];
            const auto y_l = p_prim_info[l / 3 + p_prim_count * 3];
            const auto z_l = p_prim_info[l / 3 + p_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = j % 3;
            const auto c0 = k % 3;
            const auto d0 = l % 3;

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F4_t[5];

            gpu::computeBoysFunction(F4_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F4_t[0] * (

                        0.5 / S1 * (
                            delta[a0][b0] * (QD_0 * QC_0)
                        )

                        + 0.5 / S2 * (
                            delta[c0][d0] * (PB_0 * PA_0)
                        )

                        + (

                            + PB_0 * PA_0 * QD_0 * QC_0
                        )

                        + 0.25 / ( S1 * S2 ) * (
                            delta[a0][b0] * delta[c0][d0]
                        )

                    )

                    + F4_t[1] * (

                        0.25 / ( S1 * S4 ) * (
                            delta[a0][b0] * delta[c0][d0] * (-1.0)
                        )

                        + 0.25 / ( S2 * S4 ) * (
                            delta[a0][b0] * delta[c0][d0] * (-1.0)
                        )

                        + 0.5 * S1 / ( S2 * S4 ) * (
                            delta[c0][d0] * (PB_0 * PA_0 * (-1.0))
                        )

                        + 0.5 * S2 / ( S1 * S4 ) * (
                            delta[a0][b0] * (QD_0 * QC_0 * (-1.0))
                        )

                        + 0.5 / S4 * (
                            delta[c0][d0] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[b0][d0] * (PA_0 * QC_0)
                            + delta[b0][c0] * (PA_0 * QD_0)
                            + delta[a0][d0] * (PB_0 * QC_0)
                            + delta[a0][b0] * (PQ[c0] * QD_0 * (-1.0) + PQ[d0] * QC_0 * (-1.0))
                            + delta[a0][c0] * (PB_0 * QD_0)
                        )

                        + S1 / S4 * (

                            + PB_0 * PA_0 * PQ[c0] * QD_0 * (-1.0)
                            + PB_0 * PA_0 * PQ[d0] * QC_0 * (-1.0)
                        )

                        + S2 / S4 * (

                            + PB_0 * PQ[a0] * QD_0 * QC_0
                            + PA_0 * PQ[b0] * QD_0 * QC_0
                        )

                    )

                    + F4_t[2] * (

                        ( S1 * S1 ) / ( S4 * S4 ) * (

                            + PB_0 * PA_0 * PQ[c0] * PQ[d0]
                        )

                        + ( S1 * S2 ) / ( S4 * S4 ) * (

                            + PB_0 * PQ[a0] * PQ[c0] * QD_0 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[d0] * QC_0 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[c0] * QD_0 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[d0] * QC_0 * (-1.0)
                        )

                        + ( S2 * S2 ) / ( S4 * S4 ) * (

                            + PQ[a0] * PQ[b0] * QD_0 * QC_0
                        )

                        + 0.5 * S1 / ( S4 * S4 ) * (
                            delta[c0][d0] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0))
                            + delta[b0][d0] * (PA_0 * PQ[c0] * (-1.0))
                            + delta[b0][c0] * (PA_0 * PQ[d0] * (-1.0))
                            + delta[a0][d0] * (PB_0 * PQ[c0] * (-1.0))
                            + delta[a0][c0] * (PB_0 * PQ[d0] * (-1.0))
                            + delta[a0][b0] * (PQ[c0] * PQ[d0])
                        )

                        + 0.5 * S2 / ( S4 * S4 ) * (
                            delta[b0][d0] * (PQ[a0] * QC_0)
                            + delta[a0][d0] * (PQ[b0] * QC_0)
                            + delta[a0][b0] * (PQ[c0] * QD_0 + PQ[d0] * QC_0)
                            + delta[c0][d0] * (PQ[a0] * PQ[b0])
                            + delta[b0][c0] * (PQ[a0] * QD_0)
                            + delta[a0][c0] * (PQ[b0] * QD_0)
                        )

                        + 0.25 / ( S4 * S4 ) * (
                            delta[a0][c0] * delta[b0][d0]
                            + delta[a0][d0] * delta[b0][c0]
                            + delta[a0][b0] * delta[c0][d0]
                        )

                    )

                    + F4_t[3] * (

                        ( S1 * S1 * S2 ) / ( S4 * S4 * S4 ) * (

                            + PB_0 * PQ[a0] * PQ[c0] * PQ[d0]
                            + PA_0 * PQ[b0] * PQ[c0] * PQ[d0]
                        )

                        + ( S1 * S2 * S2 ) / ( S4 * S4 * S4 ) * (

                            + PQ[a0] * PQ[b0] * PQ[c0] * QD_0 * (-1.0)
                            + PQ[a0] * PQ[b0] * PQ[d0] * QC_0 * (-1.0)
                        )

                        + 0.5 * ( S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            delta[c0][d0] * (PQ[a0] * PQ[b0] * (-1.0))
                            + delta[b0][d0] * (PQ[a0] * PQ[c0] * (-1.0))
                            + delta[b0][c0] * (PQ[a0] * PQ[d0] * (-1.0))
                            + delta[a0][d0] * (PQ[b0] * PQ[c0] * (-1.0))
                            + delta[a0][c0] * (PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][b0] * (PQ[c0] * PQ[d0] * (-1.0))
                        )

                    )

                    + F4_t[4] * (

                        ( S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[b0] * PQ[c0] * PQ[d0]
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * pp_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pp_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockPPSD(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   sd_mat_D,
                       const double*   pp_mat_Q_local,
                       const double*   sd_mat_Q,
                       const uint32_t* pp_first_inds_local,
                       const uint32_t* pp_second_inds_local,
                       const uint32_t  pp_prim_pair_count_local,
                       const uint32_t* sd_first_inds,
                       const uint32_t* sd_second_inds,
                       const uint32_t  sd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (sd_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < sd_prim_pair_count) && (ij < pp_prim_pair_count_local) && (fabs(pp_mat_Q_local[ij] * sd_mat_Q[kl] * sd_mat_D[kl]) > eri_threshold))
        {
            const auto i = pp_first_inds_local[ij];
            const auto j = pp_second_inds_local[ij];

            const auto k = sd_first_inds[kl];
            const auto l = sd_second_inds[kl];

            const auto a_i = p_prim_info[i / 3 + p_prim_count * 0];
            const auto c_i = p_prim_info[i / 3 + p_prim_count * 1];
            const auto x_i = p_prim_info[i / 3 + p_prim_count * 2];
            const auto y_i = p_prim_info[i / 3 + p_prim_count * 3];
            const auto z_i = p_prim_info[i / 3 + p_prim_count * 4];

            const auto a_j = p_prim_info[j / 3 + p_prim_count * 0];
            const auto c_j = p_prim_info[j / 3 + p_prim_count * 1];
            const auto x_j = p_prim_info[j / 3 + p_prim_count * 2];
            const auto y_j = p_prim_info[j / 3 + p_prim_count * 3];
            const auto z_j = p_prim_info[j / 3 + p_prim_count * 4];

            const auto a_k = s_prim_info[k + s_prim_count * 0];
            const auto c_k = s_prim_info[k + s_prim_count * 1];
            const auto x_k = s_prim_info[k + s_prim_count * 2];
            const auto y_k = s_prim_info[k + s_prim_count * 3];
            const auto z_k = s_prim_info[k + s_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto a0 = i % 3;
            const auto b0 = j % 3;
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F4_t[5];

            gpu::computeBoysFunction(F4_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 4, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PA_0 = (a_j / (a_i + a_j)) * rij[a0];
            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F4_t[0] * (

                        0.5 / S2 * (
                            delta[d0][d1] * (PB_0 * PA_0)
                        )

                        + (

                            + PB_0 * PA_0 * QD_0 * QD_1
                        )

                        + 0.25 / ( S1 * S2 ) * (
                            delta[a0][b0] * delta[d0][d1]
                        )

                        + 0.5 / S1 * (
                            delta[a0][b0] * (QD_0 * QD_1)
                        )

                    )

                    + F4_t[1] * (

                        0.25 / ( S1 * S4 ) * (
                            delta[a0][b0] * delta[d0][d1] * (-1.0)
                        )

                        + 0.25 / ( S2 * S4 ) * (
                            delta[a0][b0] * delta[d0][d1] * (-1.0)
                        )

                        + 0.5 * S1 / ( S2 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PA_0 * (-1.0))
                        )

                        + 0.5 * S2 / ( S1 * S4 ) * (
                            delta[a0][b0] * (QD_0 * QD_1 * (-1.0))
                        )

                        + 0.5 / S4 * (
                            delta[d0][d1] * (PB_0 * PQ[a0] + PA_0 * PQ[b0])
                            + delta[b0][d1] * (PA_0 * QD_0)
                            + delta[b0][d0] * (PA_0 * QD_1)
                            + delta[a0][b0] * (PQ[d0] * QD_1 * (-1.0) + PQ[d1] * QD_0 * (-1.0))
                            + delta[a0][d1] * (PB_0 * QD_0)
                            + delta[a0][d0] * (PB_0 * QD_1)
                        )

                        + S1 / S4 * (

                            + PB_0 * PA_0 * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PA_0 * PQ[d1] * QD_0 * (-1.0)
                        )

                        + S2 / S4 * (

                            + PB_0 * PQ[a0] * QD_0 * QD_1
                            + PA_0 * PQ[b0] * QD_0 * QD_1
                        )

                    )

                    + F4_t[2] * (

                        ( S1 * S1 ) / ( S4 * S4 ) * (

                            + PB_0 * PA_0 * PQ[d0] * PQ[d1]
                        )

                        + ( S1 * S2 ) / ( S4 * S4 ) * (

                            + PB_0 * PQ[a0] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PQ[a0] * PQ[d1] * QD_0 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[d0] * QD_1 * (-1.0)
                            + PA_0 * PQ[b0] * PQ[d1] * QD_0 * (-1.0)
                        )

                        + ( S2 * S2 ) / ( S4 * S4 ) * (
                            PQ[a0] * PQ[b0] * QD_0 * QD_1
                        )

                        + 0.5 * S1 / ( S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[a0] * (-1.0) + PA_0 * PQ[b0] * (-1.0))
                            + delta[b0][d1] * (PA_0 * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PA_0 * PQ[d1] * (-1.0))
                            + delta[a0][d1] * (PB_0 * PQ[d0] * (-1.0))
                            + delta[a0][d0] * (PB_0 * PQ[d1] * (-1.0))
                            + delta[a0][b0] * (PQ[d0] * PQ[d1])
                        )

                        + 0.25 / ( S4 * S4 ) * (
                            delta[a0][d0] * delta[b0][d1]
                            + delta[a0][d1] * delta[b0][d0]
                            + delta[a0][b0] * delta[d0][d1]
                        )

                        + 0.5 * S2 / ( S4 * S4 ) * (
                            delta[d0][d1] * (PQ[a0] * PQ[b0])
                            + delta[b0][d1] * (PQ[a0] * QD_0)
                            + delta[b0][d0] * (PQ[a0] * QD_1)
                            + delta[a0][d1] * (PQ[b0] * QD_0)
                            + delta[a0][d0] * (PQ[b0] * QD_1)
                            + delta[a0][b0] * (PQ[d0] * QD_1 + PQ[d1] * QD_0)
                        )

                    )

                    + F4_t[3] * (

                        ( S1 * S1 * S2 ) / ( S4 * S4 * S4 ) * (

                            + PB_0 * PQ[a0] * PQ[d0] * PQ[d1]
                            + PA_0 * PQ[b0] * PQ[d0] * PQ[d1]
                        )

                        + 0.5 * ( S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[a0] * PQ[b0] * (-1.0))
                            + delta[b0][d1] * (PQ[a0] * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PQ[a0] * PQ[d1] * (-1.0))
                            + delta[a0][d1] * (PQ[b0] * PQ[d0] * (-1.0))
                            + delta[a0][d0] * (PQ[b0] * PQ[d1] * (-1.0))
                            + delta[a0][b0] * (PQ[d0] * PQ[d1] * (-1.0))
                        )

                        + ( S1 * S2 * S2 ) / ( S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[b0] * PQ[d0] * QD_1 * (-1.0)
                            + PQ[a0] * PQ[b0] * PQ[d1] * QD_0 * (-1.0)
                        )

                    )

                    + F4_t[4] * (

                        ( S1 * S1 * S2 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            PQ[a0] * PQ[b0] * PQ[d0] * PQ[d1]
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * sd_mat_D[kl] * 2.0;
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < pp_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockSPDD0(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   sp_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* sp_first_inds_local,
                       const uint32_t* sp_second_inds_local,
                       const uint32_t  sp_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < sp_prim_pair_count_local) && (fabs(sp_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = sp_first_inds_local[ij];
            const auto j = sp_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = s_prim_info[i + s_prim_count * 0];
            const auto c_i = s_prim_info[i + s_prim_count * 1];
            const auto x_i = s_prim_info[i + s_prim_count * 2];
            const auto y_i = s_prim_info[i + s_prim_count * 3];
            const auto z_i = s_prim_info[i + s_prim_count * 4];

            const auto a_j = p_prim_info[j / 3 + p_prim_count * 0];
            const auto c_j = p_prim_info[j / 3 + p_prim_count * 1];
            const auto x_j = p_prim_info[j / 3 + p_prim_count * 2];
            const auto y_j = p_prim_info[j / 3 + p_prim_count * 3];
            const auto z_j = p_prim_info[j / 3 + p_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto b0 = j % 3;
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F5_t[3];

            gpu::computeBoysFunction(F5_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 2, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F5_t[0] * (

                        0.5 / S2 * (
                            delta[d0][d1] * (PB_0 * QC_0 * QC_1)
                            + delta[c1][d1] * (PB_0 * QD_0 * QC_0)
                            + delta[c1][d0] * (PB_0 * QD_1 * QC_0)
                            + delta[c0][d1] * (PB_0 * QD_0 * QC_1)
                            + delta[c0][d0] * (PB_0 * QD_1 * QC_1)
                            + delta[c0][c1] * (PB_0 * QD_0 * QD_1)
                        )

                    )

                    +

                    F5_t[0] * (

                        (
                            
                            + PB_0 * QD_0 * QD_1 * QC_0 * QC_1
                        )

                    )

                    +

                    F5_t[0] * (

                        0.25 / ( S2 * S2 ) * (
                            delta[c0][c1] * delta[d0][d1] * PB_0
                            + delta[c0][d0] * delta[c1][d1] * PB_0
                            + delta[c1][d0] * delta[c0][d1] * PB_0
                        )

                    )

                    +

                    F5_t[1] * (

                        0.25 * S1 / ( S2 * S2 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PB_0 * (-2.0))
                            + delta[c0][d0] * delta[c1][d1] * (PB_0 * (-2.0))
                            + delta[c1][d0] * delta[c0][d1] * (PB_0 * (-2.0))
                        )

                    )

                    +

                    F5_t[1] * (

                        0.25 / ( S2 * S4 ) * (
                            delta[b0][c1] * delta[d0][d1] * QC_0
                            + delta[b0][d0] * delta[c1][d1] * QC_0
                            + delta[b0][d1] * delta[c1][d0] * QC_0
                            + delta[b0][c0] * delta[d0][d1] * QC_1
                            + delta[b0][d0] * delta[c0][d1] * QC_1
                            + delta[b0][d1] * delta[c0][d0] * QC_1
                            + delta[c0][c1] * delta[d0][d1] * (PQ[b0])
                            + delta[c0][d0] * delta[c1][d1] * (PQ[b0])
                            + delta[c1][d0] * delta[c0][d1] * (PQ[b0])
                            + delta[b0][c0] * delta[c1][d1] * QD_0
                            + delta[b0][c1] * delta[c0][d1] * QD_0
                            + delta[b0][d1] * delta[c0][c1] * QD_0
                            + delta[b0][c0] * delta[c1][d0] * QD_1
                            + delta[b0][c1] * delta[c0][d0] * QD_1
                            + delta[b0][d0] * delta[c0][c1] * QD_1
                        )

                    )

                    +

                    F5_t[1] * (

                        0.5 * S1 / ( S2 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[c0] * QC_1 * (-1.0) + PB_0 * PQ[c1] * QC_0 * (-1.0) + PB_0 * QC_0 * QC_1 * (-1.0))
                            + delta[c1][d1] * (PB_0 * PQ[c0] * QD_0 * (-1.0) + PB_0 * PQ[d0] * QC_0 * (-1.0) + PB_0 * QD_0 * QC_0 * (-1.0))
                            + delta[c1][d0] * (PB_0 * PQ[c0] * QD_1 * (-1.0) + PB_0 * PQ[d1] * QC_0 * (-1.0) + PB_0 * QD_1 * QC_0 * (-1.0))
                            + delta[c0][d1] * (PB_0 * PQ[c1] * QD_0 * (-1.0) + PB_0 * PQ[d0] * QC_1 * (-1.0) + PB_0 * QD_0 * QC_1 * (-1.0))
                            + delta[c0][d0] * (PB_0 * PQ[c1] * QD_1 * (-1.0) + PB_0 * PQ[d1] * QC_1 * (-1.0) + PB_0 * QD_1 * QC_1 * (-1.0))
                            + delta[c0][c1] * (PB_0 * PQ[d0] * QD_1 * (-1.0) + PB_0 * PQ[d1] * QD_0 * (-1.0) + PB_0 * QD_0 * QD_1 * (-1.0))
                        )

                    )

                    +

                    F5_t[1] * (

                        0.5 / S4 * (
                            delta[d0][d1] * (PQ[b0] * QC_0 * QC_1)
                            + delta[c1][d1] * (PQ[b0] * QD_0 * QC_0)
                            + delta[c1][d0] * (PQ[b0] * QD_1 * QC_0)
                            + delta[c0][d1] * (PQ[b0] * QD_0 * QC_1)
                            + delta[c0][d0] * (PQ[b0] * QD_1 * QC_1)
                            + delta[b0][d1] * (QD_0 * QC_0 * QC_1)
                            + delta[b0][d0] * (QD_1 * QC_0 * QC_1)
                            + delta[b0][c1] * (QD_0 * QD_1 * QC_0)
                            + delta[b0][c0] * (QD_0 * QD_1 * QC_1)
                            + delta[c0][c1] * (PQ[b0] * QD_0 * QD_1)
                        )

                    )

                    +

                    F5_t[1] * (

                        S1 / S4 * (
                            
                            + PB_0 * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PB_0 * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PB_0 * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PB_0 * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                        )

                    )

                    +

                    F5_t[1] * (

                        S2 / S4 * (
                            
                            + PQ[b0] * QD_0 * QD_1 * QC_0 * QC_1
                        )

                    )

                    +

                    F5_t[2] * (

                        ( S1 * S1 ) / ( S4 * S4 ) * (
                            PB_0 * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PB_0 * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PB_0 * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PB_0 * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PB_0 * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PB_0 * PQ[d0] * PQ[d1] * QC_0 * QC_1
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < sp_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockSPDD1(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   sp_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* sp_first_inds_local,
                       const uint32_t* sp_second_inds_local,
                       const uint32_t  sp_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < sp_prim_pair_count_local) && (fabs(sp_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = sp_first_inds_local[ij];
            const auto j = sp_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = s_prim_info[i + s_prim_count * 0];
            const auto c_i = s_prim_info[i + s_prim_count * 1];
            const auto x_i = s_prim_info[i + s_prim_count * 2];
            const auto y_i = s_prim_info[i + s_prim_count * 3];
            const auto z_i = s_prim_info[i + s_prim_count * 4];

            const auto a_j = p_prim_info[j / 3 + p_prim_count * 0];
            const auto c_j = p_prim_info[j / 3 + p_prim_count * 1];
            const auto x_j = p_prim_info[j / 3 + p_prim_count * 2];
            const auto y_j = p_prim_info[j / 3 + p_prim_count * 3];
            const auto z_j = p_prim_info[j / 3 + p_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto b0 = j % 3;
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F5_t[4];

            gpu::computeBoysFunction(F5_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 3, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F5_t[2] * (

                        ( S1 * S2 ) / ( S4 * S4 ) * (
                            
                            + PQ[b0] * PQ[c0] * QD_0 * QD_1 * QC_1 * (-1.0)
                            + PQ[b0] * PQ[c1] * QD_0 * QD_1 * QC_0 * (-1.0)
                            + PQ[b0] * PQ[d0] * QD_1 * QC_0 * QC_1 * (-1.0)
                            + PQ[b0] * PQ[d1] * QD_0 * QC_0 * QC_1 * (-1.0)
                        )

                    )

                    +

                    F5_t[2] * (

                        0.25 * S1 / ( S2 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PQ[b0] * (-2.0))
                            + delta[c0][d0] * delta[c1][d1] * (PQ[b0] * (-2.0))
                            + delta[c1][d0] * delta[c0][d1] * (PQ[b0] * (-2.0))
                            + delta[b0][c1] * delta[d0][d1] * (PQ[c0] * (-1.0) + QC_0 * (-1.0))
                            + delta[b0][d0] * delta[c1][d1] * (PQ[c0] * (-1.0) + QC_0 * (-1.0))
                            + delta[b0][d1] * delta[c1][d0] * (PQ[c0] * (-1.0) + QC_0 * (-1.0))
                            + delta[b0][c0] * delta[d0][d1] * (PQ[c1] * (-1.0) + QC_1 * (-1.0))
                            + delta[b0][d0] * delta[c0][d1] * (PQ[c1] * (-1.0) + QC_1 * (-1.0))
                            + delta[b0][d1] * delta[c0][d0] * (PQ[c1] * (-1.0) + QC_1 * (-1.0))
                            + delta[b0][c0] * delta[c1][d1] * (PQ[d0] * (-1.0) + QD_0 * (-1.0))
                            + delta[b0][c1] * delta[c0][d1] * (PQ[d0] * (-1.0) + QD_0 * (-1.0))
                            + delta[b0][d1] * delta[c0][c1] * (PQ[d0] * (-1.0) + QD_0 * (-1.0))
                            + delta[b0][c0] * delta[c1][d0] * (PQ[d1] * (-1.0) + QD_1 * (-1.0))
                            + delta[b0][c1] * delta[c0][d0] * (PQ[d1] * (-1.0) + QD_1 * (-1.0))
                            + delta[b0][d0] * delta[c0][c1] * (PQ[d1] * (-1.0) + QD_1 * (-1.0))
                        )

                    )

                    +

                    F5_t[2] * (

                        0.5 * ( S1 * S1 ) / ( S2 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[c0] * PQ[c1] + PB_0 * PQ[c0] * QC_1 + PB_0 * PQ[c1] * QC_0)
                            + delta[c1][d1] * (PB_0 * PQ[c0] * PQ[d0] + PB_0 * PQ[c0] * QD_0 + PB_0 * PQ[d0] * QC_0)
                            + delta[c0][d1] * (PB_0 * PQ[c1] * PQ[d0] + PB_0 * PQ[c1] * QD_0 + PB_0 * PQ[d0] * QC_1)
                            + delta[c1][d0] * (PB_0 * PQ[c0] * PQ[d1] + PB_0 * PQ[c0] * QD_1 + PB_0 * PQ[d1] * QC_0)
                            + delta[c0][d0] * (PB_0 * PQ[c1] * PQ[d1] + PB_0 * PQ[c1] * QD_1 + PB_0 * PQ[d1] * QC_1)
                            + delta[c0][c1] * (PB_0 * PQ[d0] * PQ[d1] + PB_0 * PQ[d0] * QD_1 + PB_0 * PQ[d1] * QD_0)
                        )

                    )

                    +

                    F5_t[2] * (

                        0.5 * S1 / ( S4 * S4 ) * (
                            delta[d0][d1] * (PQ[b0] * PQ[c0] * QC_1 * (-1.0) + PQ[b0] * PQ[c1] * QC_0 * (-1.0) + PQ[b0] * QC_0 * QC_1 * (-1.0))
                            + delta[c1][d1] * (PQ[b0] * PQ[c0] * QD_0 * (-1.0) + PQ[b0] * PQ[d0] * QC_0 * (-1.0) + PQ[b0] * QD_0 * QC_0 * (-1.0))
                            + delta[c1][d0] * (PQ[b0] * PQ[c0] * QD_1 * (-1.0) + PQ[b0] * PQ[d1] * QC_0 * (-1.0) + PQ[b0] * QD_1 * QC_0 * (-1.0))
                            + delta[c0][d1] * (PQ[b0] * PQ[c1] * QD_0 * (-1.0) + PQ[b0] * PQ[d0] * QC_1 * (-1.0) + PQ[b0] * QD_0 * QC_1 * (-1.0))
                            + delta[c0][d0] * (PQ[b0] * PQ[c1] * QD_1 * (-1.0) + PQ[b0] * PQ[d1] * QC_1 * (-1.0) + PQ[b0] * QD_1 * QC_1 * (-1.0))
                            + delta[c0][c1] * (PQ[b0] * PQ[d0] * QD_1 * (-1.0) + PQ[b0] * PQ[d1] * QD_0 * (-1.0) + PQ[b0] * QD_0 * QD_1 * (-1.0))
                            + delta[b0][d1] * (PQ[c0] * QD_0 * QC_1 * (-1.0) + PQ[c1] * QD_0 * QC_0 * (-1.0) + PQ[d0] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][d0] * (PQ[c0] * QD_1 * QC_1 * (-1.0) + PQ[c1] * QD_1 * QC_0 * (-1.0) + PQ[d1] * QC_0 * QC_1 * (-1.0))
                            + delta[b0][c1] * (PQ[c0] * QD_0 * QD_1 * (-1.0) + PQ[d0] * QD_1 * QC_0 * (-1.0) + PQ[d1] * QD_0 * QC_0 * (-1.0))
                            + delta[b0][c0] * (PQ[c1] * QD_0 * QD_1 * (-1.0) + PQ[d0] * QD_1 * QC_1 * (-1.0) + PQ[d1] * QD_0 * QC_1 * (-1.0))
                        )

                    )

                    +

                    F5_t[2] * (

                        0.25 * ( S1 * S1 ) / ( S2 * S2 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * PB_0
                            + delta[c0][d0] * delta[c1][d1] * PB_0
                            + delta[c1][d0] * delta[c0][d1] * PB_0
                        )

                    )

                    +

                    F5_t[3] * (

                        ( S1 * S1 * S1 ) / ( S4 * S4 * S4 ) * (
                            
                            + PB_0 * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PB_0 * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PB_0 * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PB_0 * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                        )

                    )

                    +

                    F5_t[3] * (

                        ( S1 * S1 * S2 ) / ( S4 * S4 * S4 ) * (
                            PQ[b0] * PQ[c0] * PQ[c1] * QD_0 * QD_1
                            + PQ[b0] * PQ[c0] * PQ[d0] * QD_1 * QC_1
                            + PQ[b0] * PQ[c0] * PQ[d1] * QD_0 * QC_1
                            + PQ[b0] * PQ[c1] * PQ[d0] * QD_1 * QC_0
                            + PQ[b0] * PQ[c1] * PQ[d1] * QD_0 * QC_0
                            + PQ[b0] * PQ[d0] * PQ[d1] * QC_0 * QC_1
                        )

                    )

                    +

                    F5_t[3] * (

                        0.5 * ( S1 * S1 ) / ( S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[b0] * PQ[c0] * PQ[c1] + PQ[b0] * PQ[c0] * QC_1 + PQ[b0] * PQ[c1] * QC_0)
                            + delta[c1][d1] * (PQ[b0] * PQ[c0] * PQ[d0] + PQ[b0] * PQ[c0] * QD_0 + PQ[b0] * PQ[d0] * QC_0)
                            + delta[c0][d1] * (PQ[b0] * PQ[c1] * PQ[d0] + PQ[b0] * PQ[c1] * QD_0 + PQ[b0] * PQ[d0] * QC_1)
                            + delta[c1][d0] * (PQ[b0] * PQ[c0] * PQ[d1] + PQ[b0] * PQ[c0] * QD_1 + PQ[b0] * PQ[d1] * QC_0)
                            + delta[c0][d0] * (PQ[b0] * PQ[c1] * PQ[d1] + PQ[b0] * PQ[c1] * QD_1 + PQ[b0] * PQ[d1] * QC_1)
                            + delta[b0][d1] * (PQ[c0] * PQ[c1] * QD_0 + PQ[c0] * PQ[d0] * QC_1 + PQ[c1] * PQ[d0] * QC_0)
                            + delta[b0][d0] * (PQ[c0] * PQ[c1] * QD_1 + PQ[c0] * PQ[d1] * QC_1 + PQ[c1] * PQ[d1] * QC_0)
                            + delta[b0][c1] * (PQ[c0] * PQ[d0] * QD_1 + PQ[c0] * PQ[d1] * QD_0 + PQ[d0] * PQ[d1] * QC_0)
                            + delta[b0][c0] * (PQ[c1] * PQ[d0] * QD_1 + PQ[c1] * PQ[d1] * QD_0 + PQ[d0] * PQ[d1] * QC_1)
                            + delta[c0][c1] * (PQ[b0] * PQ[d0] * PQ[d1] + PQ[b0] * PQ[d0] * QD_1 + PQ[b0] * PQ[d1] * QD_0)
                        )

                    )

                    +

                    F5_t[3] * (

                        0.5 * ( S1 * S1 * S1 ) / ( S2 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PB_0 * PQ[c0] * PQ[c1] * (-1.0))
                            + delta[c1][d1] * (PB_0 * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[c1][d0] * (PB_0 * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[c0][d1] * (PB_0 * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[c0][d0] * (PB_0 * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[c0][c1] * (PB_0 * PQ[d0] * PQ[d1] * (-1.0))
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < sp_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

__global__ void
computeCoulombFockSPDD2(double*         mat_J,
                       const double*   s_prim_info,
                       const uint32_t  s_prim_count,
                       const double*   p_prim_info,
                       const uint32_t  p_prim_count,
                       const double*   d_prim_info,
                       const uint32_t  d_prim_count,
                       const double*   dd_mat_D,
                       const double*   sp_mat_Q_local,
                       const double*   dd_mat_Q,
                       const uint32_t* sp_first_inds_local,
                       const uint32_t* sp_second_inds_local,
                       const uint32_t  sp_prim_pair_count_local,
                       const uint32_t* dd_first_inds,
                       const uint32_t* dd_second_inds,
                       const uint32_t  dd_prim_pair_count,
                       const double*   boys_func_table,
                       const double*   boys_func_ft,
                       const double    eri_threshold)
{
    // each thread row scans over [ij|??] and sum up to a primitive J matrix element
    // J. Chem. Theory Comput. 2009, 5, 4, 1004–1015

    __shared__ double   ERIs[TILE_DIM][TILE_DIM + 1];
    __shared__ uint32_t skip_thread_block;
    __shared__ uint32_t d_cart_inds[6][2];
    __shared__ double   delta[3][3];

    const uint32_t ij = blockDim.x * blockIdx.x + threadIdx.x;

    double J_ij = 0.0;

    if ((threadIdx.y == 0) && (threadIdx.x == 0))
    {
        skip_thread_block = 0;

        d_cart_inds[0][0] = 0; d_cart_inds[0][1] = 0;
        d_cart_inds[1][0] = 0; d_cart_inds[1][1] = 1;
        d_cart_inds[2][0] = 0; d_cart_inds[2][1] = 2;
        d_cart_inds[3][0] = 1; d_cart_inds[3][1] = 1;
        d_cart_inds[4][0] = 1; d_cart_inds[4][1] = 2;
        d_cart_inds[5][0] = 2; d_cart_inds[5][1] = 2;

        delta[0][0] = 1.0; delta[0][1] = 0.0; delta[0][2] = 0.0;
        delta[1][0] = 0.0; delta[1][1] = 1.0; delta[1][2] = 0.0;
        delta[2][0] = 0.0; delta[2][1] = 0.0; delta[2][2] = 1.0;
    }

    __syncthreads();

    for (uint32_t m = 0; m < (dd_prim_pair_count + TILE_DIM - 1) / TILE_DIM; m++)
    {
        const uint32_t kl = m * TILE_DIM + threadIdx.y;

        if ((kl < dd_prim_pair_count) && (ij < sp_prim_pair_count_local) && (fabs(sp_mat_Q_local[ij] * dd_mat_Q[kl] * dd_mat_D[kl]) > eri_threshold))
        {
            const auto i = sp_first_inds_local[ij];
            const auto j = sp_second_inds_local[ij];

            const auto k = dd_first_inds[kl];
            const auto l = dd_second_inds[kl];

            const auto a_i = s_prim_info[i + s_prim_count * 0];
            const auto c_i = s_prim_info[i + s_prim_count * 1];
            const auto x_i = s_prim_info[i + s_prim_count * 2];
            const auto y_i = s_prim_info[i + s_prim_count * 3];
            const auto z_i = s_prim_info[i + s_prim_count * 4];

            const auto a_j = p_prim_info[j / 3 + p_prim_count * 0];
            const auto c_j = p_prim_info[j / 3 + p_prim_count * 1];
            const auto x_j = p_prim_info[j / 3 + p_prim_count * 2];
            const auto y_j = p_prim_info[j / 3 + p_prim_count * 3];
            const auto z_j = p_prim_info[j / 3 + p_prim_count * 4];

            const auto a_k = d_prim_info[k / 6 + d_prim_count * 0];
            const auto c_k = d_prim_info[k / 6 + d_prim_count * 1];
            const auto x_k = d_prim_info[k / 6 + d_prim_count * 2];
            const auto y_k = d_prim_info[k / 6 + d_prim_count * 3];
            const auto z_k = d_prim_info[k / 6 + d_prim_count * 4];

            const auto a_l = d_prim_info[l / 6 + d_prim_count * 0];
            const auto c_l = d_prim_info[l / 6 + d_prim_count * 1];
            const auto x_l = d_prim_info[l / 6 + d_prim_count * 2];
            const auto y_l = d_prim_info[l / 6 + d_prim_count * 3];
            const auto z_l = d_prim_info[l / 6 + d_prim_count * 4];

            const auto b0 = j % 3;
            const auto c0 = d_cart_inds[k % 6][0];
            const auto c1 = d_cart_inds[k % 6][1];
            const auto d0 = d_cart_inds[l % 6][0];
            const auto d1 = d_cart_inds[l % 6][1];

            const auto r2_ij = (x_j - x_i) * (x_j - x_i) + (y_j - y_i) * (y_j - y_i) + (z_j - z_i) * (z_j - z_i);
            const auto r2_kl = (x_l - x_k) * (x_l - x_k) + (y_l - y_k) * (y_l - y_k) + (z_l - z_k) * (z_l - z_k);

            const double PQ[3] = {(a_k * x_k + a_l * x_l) / (a_k + a_l) - (a_i * x_i + a_j * x_j) / (a_i + a_j),
                                  (a_k * y_k + a_l * y_l) / (a_k + a_l) - (a_i * y_i + a_j * y_j) / (a_i + a_j),
                                  (a_k * z_k + a_l * z_l) / (a_k + a_l) - (a_i * z_i + a_j * z_j) / (a_i + a_j)};

            const auto r2_PQ = PQ[0] * PQ[0] + PQ[1] * PQ[1] + PQ[2] * PQ[2];

            // Electron. J. Theor. Chem., Vol. 2, 66–70 (1997)
            // J. Chem. Phys. 84, 3963-3974 (1986)

            const auto Lambda = sqrt(4.0 * (a_i + a_j) * (a_k + a_l) / (MATH_CONST_PI * (a_i + a_j + a_k + a_l)));

            double F5_t[6];

            gpu::computeBoysFunction(F5_t, (a_i + a_j) * (a_k + a_l) / (a_i + a_j + a_k + a_l) * r2_PQ, 5, boys_func_table, boys_func_ft);

            const auto S_ij_00 = c_i * c_j * pow(MATH_CONST_PI / (a_i + a_j), 1.5) * exp(-a_i * a_j / (a_i + a_j) * r2_ij);
            const auto S_kl_00 = c_k * c_l * pow(MATH_CONST_PI / (a_k + a_l), 1.5) * exp(-a_k * a_l / (a_k + a_l) * r2_kl);

            const auto S1 = (a_i + a_j);
            const auto S2 = (a_k + a_l);
            const auto S4 = (a_i + a_j + a_k + a_l);

            const double rij[3] = {x_j - x_i, y_j - y_i, z_j - z_i};
            const double rkl[3] = {x_l - x_k, y_l - y_k, z_l - z_k};

            const auto PB_0 = (-a_i / (a_i + a_j)) * rij[b0];
            const auto QC_0 = (a_l / (a_k + a_l)) * rkl[c0];
            const auto QC_1 = (a_l / (a_k + a_l)) * rkl[c1];
            const auto QD_0 = (-a_k / (a_k + a_l)) * rkl[d0];
            const auto QD_1 = (-a_k / (a_k + a_l)) * rkl[d1];

            const double eri_ijkl = Lambda * S_ij_00 * S_kl_00 * (

                    F5_t[3] * (

                        0.25 * ( S1 * S1 ) / ( S2 * S4 * S4 * S4 ) * (
                            delta[c0][c1] * delta[d0][d1] * (PQ[b0])
                            + delta[c0][d0] * delta[c1][d1] * (PQ[b0])
                            + delta[c1][d0] * delta[c0][d1] * (PQ[b0])
                            + delta[b0][c1] * delta[d0][d1] * (PQ[c0])
                            + delta[b0][d0] * delta[c1][d1] * (PQ[c0])
                            + delta[b0][d1] * delta[c1][d0] * (PQ[c0])
                            + delta[b0][c0] * delta[d0][d1] * (PQ[c1])
                            + delta[b0][d0] * delta[c0][d1] * (PQ[c1])
                            + delta[b0][d1] * delta[c0][d0] * (PQ[c1])
                            + delta[b0][c0] * delta[c1][d1] * (PQ[d0])
                            + delta[b0][c1] * delta[c0][d1] * (PQ[d0])
                            + delta[b0][d1] * delta[c0][c1] * (PQ[d0])
                            + delta[b0][c0] * delta[c1][d0] * (PQ[d1])
                            + delta[b0][c1] * delta[c0][d0] * (PQ[d1])
                            + delta[b0][d0] * delta[c0][c1] * (PQ[d1])
                        )

                    )

                    +

                    F5_t[4] * (

                        ( S1 * S1 * S1 * S1 ) / ( S4 * S4 * S4 * S4 ) * (
                            PB_0 * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                        )

                    )

                    +

                    F5_t[4] * (

                        ( S1 * S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 ) * (
                            
                            + PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * QD_1 * (-1.0)
                            + PQ[b0] * PQ[c0] * PQ[c1] * PQ[d1] * QD_0 * (-1.0)
                            + PQ[b0] * PQ[c0] * PQ[d0] * PQ[d1] * QC_1 * (-1.0)
                            + PQ[b0] * PQ[c1] * PQ[d0] * PQ[d1] * QC_0 * (-1.0)
                        )

                    )

                    +

                    F5_t[4] * (

                        0.5 * ( S1 * S1 * S1 ) / ( S4 * S4 * S4 * S4 ) * (
                            delta[d0][d1] * (PQ[b0] * PQ[c0] * PQ[c1] * (-1.0))
                            + delta[c1][d1] * (PQ[b0] * PQ[c0] * PQ[d0] * (-1.0))
                            + delta[c1][d0] * (PQ[b0] * PQ[c0] * PQ[d1] * (-1.0))
                            + delta[c0][d1] * (PQ[b0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[c0][d0] * (PQ[b0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[c0][c1] * (PQ[b0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][d1] * (PQ[c0] * PQ[c1] * PQ[d0] * (-1.0))
                            + delta[b0][d0] * (PQ[c0] * PQ[c1] * PQ[d1] * (-1.0))
                            + delta[b0][c1] * (PQ[c0] * PQ[d0] * PQ[d1] * (-1.0))
                            + delta[b0][c0] * (PQ[c1] * PQ[d0] * PQ[d1] * (-1.0))
                        )

                    )

                    +

                    F5_t[5] * (

                        ( S1 * S1 * S1 * S1 * S2 ) / ( S4 * S4 * S4 * S4 * S4 ) * (
                            PQ[b0] * PQ[c0] * PQ[c1] * PQ[d0] * PQ[d1]
                        )

                    )

                    );

            // NOTE: doubling for off-diagonal elements of D due to k<=>l symmetry
            //       (static_cast<double>(k != l) + 1.0) == (k == l ? 1.0 : 2.0)
            ERIs[threadIdx.y][threadIdx.x] = eri_ijkl * dd_mat_D[kl] * (static_cast<double>(k != l) + 1.0);
        }
        else
        {
            ERIs[threadIdx.y][threadIdx.x] = 0.0;

            // indicator for early exit for thread block (ERIs[0][0] has the largest upper bound)
            if ((threadIdx.y == 0) && (threadIdx.x == 0)) skip_thread_block = 1;
        }

        __syncthreads();

        // early exit for thread block
        if (skip_thread_block == 1) break;

        if (threadIdx.y == 0)
        {
            for (uint32_t n = 0; n < TILE_DIM; n++)
            {
                J_ij += ERIs[n][threadIdx.x];
            }
        }

        __syncthreads();
    }

    if ((threadIdx.y == 0) && (ij < sp_prim_pair_count_local))
    {
        mat_J[ij] += J_ij;
    }
}

}  // namespace gpu
