import numpy as np

from veloxchem.veloxchemlib import compute_nuclear_potential_values
from veloxchem.molecule import Molecule
from veloxchem.molecularbasis import MolecularBasis
from veloxchem.oneeints import compute_nuclear_potential_integrals
from veloxchem.oneeints import compute_nuclear_potential_gradient_bfs


class TestOneElecIntsNuclearPotential:

    def get_molecule_and_basis(self):

        xyz_string = """3
        xyz
        O    1.2361419   1.0137761  -0.0612424
        H    0.5104418   0.8944555   0.5514190
        H    1.9926927   1.1973129   0.4956931
        """
        basis_label = 'def2-svp'

        mol = Molecule.read_xyz_string(xyz_string)
        bas = MolecularBasis.read(mol, basis_label, ostream=None)

        return mol, bas

    def get_point_coords(self):

        return np.array([[-1.88163847, 0.03031404, 2.34752286],
                         [-2.74817258, -1.07142577, 3.49085649],
                         [-1.77217571, -0.91045342, 0.80645234],
                         [-0.45964621, -1.92724966, -2.25894233],
                         [0.82534469, -0.71042988, -1.88467999],
                         [-0.95087901, -1.559306, -3.96048026]])

    def get_density_matrix(self):

        return np.array([
            [
                2.13339302e+00, 2.73557830e-01, 2.43455879e-01, 7.27621176e-02,
                -8.10626607e-03, 7.57480846e-02, -7.96385623e-03,
                -1.93475762e-04, -4.93022241e-03, 3.20216961e-03,
                -3.49155699e-03, -5.75394141e-02, -7.22454170e-02,
                -1.38225865e-02, -1.30967759e-02, -3.15495453e-03,
                -5.29571121e-03, 1.60960694e-02, -1.67111162e-02,
                2.37019737e-04, 3.88671875e-04, -2.37017366e-03,
                -8.74388233e-05, -3.81582441e-04
            ],
            [
                2.73557830e-01, 6.73301370e-01, 4.42107854e-01, 1.31828491e-01,
                -9.68947057e-03, 1.40881467e-01, -8.92153794e-03,
                5.54013414e-03, -5.38192462e-03, 5.24205029e-03,
                -4.71336760e-03, -1.10704950e-01, -1.48136982e-01,
                -2.08376621e-02, -2.03177885e-02, -4.53780122e-03,
                -1.02313355e-02, 2.38158420e-02, -2.49932152e-02,
                1.83371203e-03, 1.09209288e-03, -4.49382522e-03,
                -2.48564780e-04, 2.40313871e-03
            ],
            [
                2.43455879e-01, 4.42107854e-01, 3.78598969e-01, -5.84623238e-03,
                -1.65478624e-02, -2.01869913e-02, -2.81288531e-02,
                -2.35767567e-02, -2.51093365e-02, 1.42122578e-04,
                7.28819232e-05, -2.97696314e-01, -2.42404421e-01,
                -1.28974029e-02, -1.33460507e-02, -1.96399881e-02,
                -1.55221555e-02, 5.99256306e-04, -5.72064897e-04,
                4.93572258e-04, 8.53686669e-05, -9.47839769e-03,
                -1.17965978e-03, -3.90031197e-04
            ],
            [
                7.27621176e-02, 1.31828491e-01, -5.84623238e-03, 3.41984616e-01,
                4.98787976e-02, -4.89110875e-02, -2.51801335e-02,
                -4.10974038e-02, -1.61749872e-02, 6.93536380e-03,
                -9.97647262e-04, 2.63665970e-01, 1.53079459e-01,
                -2.63639790e-02, 1.54400118e-02, -2.99377648e-01,
                -1.46733824e-01, 3.83884090e-02, -1.03712536e-02,
                8.63632799e-04, -2.45214231e-03, 7.95136593e-03,
                -1.48074556e-02, 2.17903892e-03
            ],
            [
                -8.10626607e-03, -9.68947057e-03, -1.65478624e-02,
                4.98787976e-02, 9.10691559e-03, -2.65634205e-02,
                -6.23725768e-03, -1.20940673e-02, -5.98249210e-03,
                6.83758110e-04, 2.71030847e-04, 3.61762969e-02, 2.40908044e-02,
                -3.82098076e-03, 4.01378872e-03, -5.77256574e-02,
                -2.78469569e-02, 4.71153589e-03, 7.67217714e-04, 9.81223689e-06,
                -6.19339387e-04, 1.17326455e-03, -2.87938251e-03, 1.25026391e-04
            ],
            [
                7.57480846e-02, 1.40881467e-01, -2.01869913e-02,
                -4.89110875e-02, -2.65634205e-02, 3.62672114e-01,
                7.10926718e-02, 7.35540337e-02, 3.89447366e-02, 2.19434547e-03,
                -9.67004384e-03, 2.34438170e-01, 1.36611991e-01, 1.40072175e-02,
                -2.25539650e-02, 3.19053661e-01, 1.56229962e-01, 9.49116921e-03,
                -3.71858661e-02, 1.50528708e-03, 3.38617482e-03, 5.98949821e-03,
                1.60790444e-02, 3.33877198e-03
            ],
            [
                -7.96385623e-03, -8.92153794e-03, -2.81288531e-02,
                -2.51801335e-02, -6.23725768e-03, 7.10926718e-02,
                1.62959715e-02, 1.23197621e-02, 5.74149025e-03, -1.31656170e-04,
                -1.96535875e-03, 5.05949696e-02, 3.40192177e-02, 4.73309519e-03,
                -4.05016170e-03, 7.59697816e-02, 3.78486145e-02,
                -8.17686898e-05, -6.33174167e-03, 2.05259891e-04,
                6.15488623e-04, 1.35469587e-03, 3.80244967e-03, 5.40619038e-04
            ],
            [
                -1.93475762e-04, 5.54013414e-03, -2.35767567e-02,
                -4.10974038e-02, -1.20940673e-02, 7.35540337e-02,
                1.23197621e-02, 7.75861178e-01, 6.18363269e-01, 3.01860899e-02,
                3.12461237e-02, -1.56582888e-02, -9.98800475e-03,
                3.23819358e-03, -7.18553522e-03, -6.04145208e-02,
                -6.93873491e-02, -8.93568510e-03, -1.22288990e-02,
                4.64058527e-04, 2.05585121e-02, -2.03885708e-04, 8.07360259e-04,
                8.75504241e-04
            ],
            [
                -4.93022241e-03, -5.38192462e-03, -2.51093365e-02,
                -1.61749872e-02, -5.98249210e-03, 3.89447366e-02,
                5.74149025e-03, 6.18363269e-01, 4.94646964e-01, 2.44285743e-02,
                2.55555922e-02, -8.08203797e-03, -4.15940755e-03,
                1.02578926e-03, -3.73606415e-03, -7.69164620e-02,
                -6.95428124e-02, -6.07463975e-03, -8.35244464e-03,
                3.22838266e-04, 1.62420698e-02, 3.61336356e-05, -7.66080114e-04,
                6.30734975e-04
            ],
            [
                3.20216961e-03, 5.24205029e-03, 1.42122578e-04, 6.93536380e-03,
                6.83758110e-04, 2.19434547e-03, -1.31656170e-04, 3.01860899e-02,
                2.44285743e-02, 1.39372010e-03, 1.21659989e-03, 5.41951639e-03,
                2.87957729e-03, -5.61672146e-04, 2.38775659e-05,
                -9.61431422e-03, -6.33155495e-03, 6.32119955e-04,
                -8.13584707e-04, 4.43365305e-05, 7.69774976e-04, 1.70919902e-04,
                -3.23140412e-04, 9.38691414e-05
            ],
            [
                -3.49155699e-03, -4.71336760e-03, 7.28819232e-05,
                -9.97647262e-04, 2.71030847e-04, -9.67004384e-03,
                -1.96535875e-03, 3.12461237e-02, 2.55555922e-02, 1.21659989e-03,
                1.71031415e-03, -1.01000264e-02, -5.99005871e-03,
                -2.98486167e-04, 4.39969586e-04, -1.32426845e-02,
                -8.22340573e-03, -8.36870392e-04, 8.29066505e-04,
                -3.53410528e-05, 7.80999606e-04, -2.54675744e-04,
                -5.00626111e-04, -8.72362988e-05
            ],
            [
                -5.75394141e-02, -1.10704950e-01, -2.97696314e-01,
                2.63665970e-01, 3.61762969e-02, 2.34438170e-01, 5.05949696e-02,
                -1.56582888e-02, -8.08203797e-03, 5.41951639e-03,
                -1.01000264e-02, 6.18455714e-01, 4.10856954e-01,
                -2.96715638e-03, 6.97343528e-03, -3.26258863e-03,
                5.30714634e-03, 3.99663587e-02, -3.49413544e-02, 1.44695391e-03,
                -1.05002176e-03, 1.82090956e-02, -4.23176283e-05, 4.54100761e-03
            ],
            [
                -7.22454170e-02, -1.48136982e-01, -2.42404421e-01,
                1.53079459e-01, 2.40908044e-02, 1.36611991e-01, 3.40192177e-02,
                -9.98800475e-03, -4.15940755e-03, 2.87957729e-03,
                -5.99005871e-03, 4.10856954e-01, 2.81480063e-01, 6.48403667e-04,
                6.65960336e-03, 9.84161244e-04, 5.83238133e-03, 2.28851119e-02,
                -1.97535041e-02, 7.26370728e-04, -7.69957759e-04,
                1.22335566e-02, 1.30402088e-04, 2.65805537e-03
            ],
            [
                -1.38225865e-02, -2.08376621e-02, -1.28974029e-02,
                -2.63639790e-02, -3.82098076e-03, 1.40072175e-02,
                4.73309519e-03, 3.23819358e-03, 1.02578926e-03, -5.61672146e-04,
                -2.98486167e-04, -2.96715638e-03, 6.48403667e-04,
                2.76874778e-03, -1.28351004e-03, 3.18198523e-02, 1.59261315e-02,
                -2.58004850e-03, -1.86043099e-04, -4.02451880e-05,
                2.02317399e-04, -1.03002427e-04, 1.57612823e-03, -5.78681857e-05
            ],
            [
                -1.30967759e-02, -2.03177885e-02, -1.33460507e-02,
                1.54400118e-02, 4.01378872e-03, -2.25539650e-02,
                -4.05016170e-03, -7.18553522e-03, -3.73606415e-03,
                2.38775659e-05, 4.39969586e-04, 6.97343528e-03, 6.65960336e-03,
                -1.28351004e-03, 2.41038383e-03, -2.85594982e-02,
                -1.36484725e-02, 8.12871012e-04, 1.88029310e-03,
                -7.71664578e-05, -3.50609461e-04, 2.92180166e-04,
                -1.43349212e-03, -1.04845305e-04
            ],
            [
                -3.15495453e-03, -4.53780122e-03, -1.96399881e-02,
                -2.99377648e-01, -5.77256574e-02, 3.19053661e-01,
                7.59697816e-02, -6.04145208e-02, -7.69164620e-02,
                -9.61431422e-03, -1.32426845e-02, -3.26258863e-03,
                9.84161244e-04, 3.18198523e-02, -2.85594982e-02, 5.06295471e-01,
                2.56075763e-01, -2.06245881e-02, -1.96463070e-02,
                4.38021037e-04, 6.11150575e-04, -1.01244725e-03, 2.45418827e-02,
                8.44393150e-04
            ],
            [
                -5.29571121e-03, -1.02313355e-02, -1.55221555e-02,
                -1.46733824e-01, -2.78469569e-02, 1.56229962e-01,
                3.78486145e-02, -6.93873491e-02, -6.95428124e-02,
                -6.33155495e-03, -8.22340573e-03, 5.30714634e-03,
                5.83238133e-03, 1.59261315e-02, -1.36484725e-02, 2.56075763e-01,
                1.31608056e-01, -9.77412566e-03, -9.23402866e-03,
                1.88986086e-04, -7.47865302e-04, -3.02150738e-04,
                1.22262326e-02, 3.91026322e-04
            ],
            [
                1.60960694e-02, 2.38158420e-02, 5.99256306e-04, 3.83884090e-02,
                4.71153589e-03, 9.49116921e-03, -8.17686898e-05,
                -8.93568510e-03, -6.07463975e-03, 6.32119955e-04,
                -8.36870392e-04, 3.99663587e-02, 2.28851119e-02,
                -2.58004850e-03, 8.12871012e-04, -2.06245881e-02,
                -9.77412566e-03, 5.02262632e-03, -2.75632827e-03,
                1.65145296e-04, -3.29982825e-04, 1.15241026e-03,
                -1.04324188e-03, 3.91029859e-04
            ],
            [
                -1.67111162e-02, -2.49932152e-02, -5.72064897e-04,
                -1.03712536e-02, 7.67217714e-04, -3.71858661e-02,
                -6.33174167e-03, -1.22288990e-02, -8.35244464e-03,
                -8.13584707e-04, 8.29066505e-04, -3.49413544e-02,
                -1.97535041e-02, -1.86043099e-04, 1.88029310e-03,
                -1.96463070e-02, -9.23402866e-03, -2.75632827e-03,
                4.60008319e-03, -2.09361887e-04, -4.20696403e-04,
                -9.35392706e-04, -1.03371796e-03, -4.62847551e-04
            ],
            [
                2.37019737e-04, 1.83371203e-03, 4.93572258e-04, 8.63632799e-04,
                9.81223689e-06, 1.50528708e-03, 2.05259891e-04, 4.64058527e-04,
                3.22838266e-04, 4.43365305e-05, -3.53410528e-05, 1.44695391e-03,
                7.26370728e-04, -4.02451880e-05, -7.71664578e-05,
                4.38021037e-04, 1.88986086e-04, 1.65145296e-04, -2.09361887e-04,
                1.10067938e-05, 1.56684818e-05, 3.79541663e-05, 2.41198150e-05,
                2.27994584e-05
            ],
            [
                3.88671875e-04, 1.09209288e-03, 8.53686669e-05, -2.45214231e-03,
                -6.19339387e-04, 3.38617482e-03, 6.15488623e-04, 2.05585121e-02,
                1.62420698e-02, 7.69774976e-04, 7.80999606e-04, -1.05002176e-03,
                -7.69957759e-04, 2.02317399e-04, -3.50609461e-04,
                6.11150575e-04, -7.47865302e-04, -3.29982825e-04,
                -4.20696403e-04, 1.56684818e-05, 5.56234280e-04,
                -2.96772667e-05, 1.29682588e-04, 2.68795865e-05
            ],
            [
                -2.37017366e-03, -4.49382522e-03, -9.47839769e-03,
                7.95136593e-03, 1.17326455e-03, 5.98949821e-03, 1.35469587e-03,
                -2.03885708e-04, 3.61336356e-05, 1.70919902e-04,
                -2.54675744e-04, 1.82090956e-02, 1.22335566e-02,
                -1.03002427e-04, 2.92180166e-04, -1.01244725e-03,
                -3.02150738e-04, 1.15241026e-03, -9.35392706e-04,
                3.79541663e-05, -2.96772667e-05, 5.40199285e-04,
                -4.49226976e-05, 1.26316530e-04
            ],
            [
                -8.74388233e-05, -2.48564780e-04, -1.17965978e-03,
                -1.48074556e-02, -2.87938251e-03, 1.60790444e-02,
                3.80244967e-03, 8.07360259e-04, -7.66080114e-04,
                -3.23140412e-04, -5.00626111e-04, -4.23176283e-05,
                1.30402088e-04, 1.57612823e-03, -1.43349212e-03, 2.45418827e-02,
                1.22262326e-02, -1.04324188e-03, -1.03371796e-03,
                2.41198150e-05, 1.29682588e-04, -4.49226976e-05, 1.20785238e-03,
                4.69600694e-05
            ],
            [
                -3.81582441e-04, 2.40313871e-03, -3.90031197e-04,
                2.17903892e-03, 1.25026391e-04, 3.33877198e-03, 5.40619038e-04,
                8.75504241e-04, 6.30734975e-04, 9.38691414e-05, -8.72362988e-05,
                4.54100761e-03, 2.65805537e-03, -5.78681857e-05,
                -1.04845305e-04, 8.44393150e-04, 3.91026322e-04, 3.91029859e-04,
                -4.62847551e-04, 2.27994584e-05, 2.68795865e-05, 1.26316530e-04,
                4.69600694e-05, 5.30455980e-05
            ]
        ])

    def test_nuclear_potential_values(self):

        mol, bas = self.get_molecule_and_basis()
        point_coords = self.get_point_coords()
        D = self.get_density_matrix()

        npot_vals = compute_nuclear_potential_values(mol, bas, point_coords, D)

        ref_npot_vals = []
        for coord in point_coords:
            npot_ints = compute_nuclear_potential_integrals(
                mol, bas, [1.0], [coord])
            ref_npot_vals.append(np.sum(npot_ints * D))
        ref_npot_vals = np.array(ref_npot_vals)

        assert np.max(np.abs(npot_vals - ref_npot_vals)) < 1.0e-7

        charges = [-0.676, 0.337, 0.337, -0.676, 0.337, 0.337]
        ref_npot_grad_bfs = np.array([[-0.0075664, 0.07381133, 0.1285646],
                                      [-0.00852576, 0.00165804, 0.01336406],
                                      [-0.00251203, 0.00125916, 0.00465168]])
        npot_grad_bfs = compute_nuclear_potential_gradient_bfs(
            mol, bas, charges, point_coords, D)
        assert np.max(np.abs(npot_grad_bfs - ref_npot_grad_bfs)) < 1.0e-8
