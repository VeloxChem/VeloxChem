import numpy as np

from veloxchem.molecule import Molecule
from veloxchem.molecularbasis import MolecularBasis
from veloxchem.veloxchemlib import compute_electric_field_integrals
from veloxchem.veloxchemlib import compute_electric_field_integrals_gradient
from veloxchem.veloxchemlib import compute_electric_field_values
from veloxchem.oneeints import compute_electric_field_fock_gradient
from veloxchem.oneeints import compute_electric_field_potential_gradient_for_mm


class TestOneElecIntsElectricField:

    def get_molecule_and_basis(self):

        xyz_string = """3
        xyz
        O    1.2361419   1.0137761  -0.0612424
        H    0.5104418   0.8944555   0.5514190
        H    1.9926927   1.1973129   0.4956931
        """
        basis_label = 'def2-svp'

        mol = Molecule.read_xyz_string(xyz_string)
        bas = MolecularBasis.read(mol, basis_label, ostream=None)

        return mol, bas

    def get_dipole_coords(self):

        return np.array([[-1.88163847, 0.03031404, 2.34752286],
                         [-2.74817258, -1.07142577, 3.49085649],
                         [-1.77217571, -0.91045342, 0.80645234],
                         [-0.45964621, -1.92724966, -2.25894233],
                         [0.82534469, -0.71042988, -1.88467999],
                         [-0.95087901, -1.559306, -3.96048026]])

    def get_dipole_moments(self):

        return np.array([[-0.09069712, -0.10380878, -0.02221531],
                         [-0.00828332, -0.01686506, -0.00998045],
                         [-0.00294154, -0.06800037, -0.07692058],
                         [0.10093368, 0.0311379, -0.0960019],
                         [0.07715471, 0.06446605, -0.0004069],
                         [0.01692327, 0.01270822, -0.01215017]])

    def get_ref_efield_ints(self):

        return np.array([
            [
                -3.37530858e-03, 1.16116203e-03, 5.32860108e-04, 1.42422340e-04,
                2.04486622e-04, 1.48895934e-04, 2.06409515e-04, -2.33709773e-04,
                -3.13328549e-05, 2.20590277e-05, -5.96760076e-05,
                -4.19318917e-04, -5.62169850e-05, -1.75504655e-04,
                -1.72014512e-04, 8.56076444e-05, 1.14771918e-05, 1.91982395e-04,
                -2.09238522e-04, 3.95561000e-06, 1.84495191e-05, 3.02437739e-06,
                1.27328286e-05, -1.17770359e-05
            ],
            [
                1.16116203e-03, -3.37530851e-03, -2.66287390e-03,
                2.08409253e-04, -8.84834157e-04, -5.38863622e-04,
                -1.05339476e-03, 1.64050800e-03, 1.29225245e-03, 2.97628981e-04,
                3.32477156e-04, 2.94337731e-03, 2.31865444e-03, 4.73668211e-04,
                8.80414601e-04, -6.00916373e-04, -4.73445080e-04,
                -1.04607482e-05, 2.83005611e-04, -2.02814986e-04,
                -9.45957544e-04, -1.55068145e-04, -6.52847117e-04,
                6.03840996e-04
            ],
            [
                5.32860108e-04, -2.66287390e-03, -3.33790492e-03,
                2.30234810e-03, -6.46689718e-05, -4.13346593e-04,
                -1.25324877e-03, 1.53289884e-03, 3.15541072e-03, 1.33131542e-04,
                4.06308049e-04, 2.75031698e-03, 5.75505321e-03, 1.25305096e-03,
                1.16896635e-03, -5.61508120e-04, -1.23418296e-03,
                -7.88614480e-04, -1.86908130e-04, -2.64108278e-04,
                -1.23186184e-03, -2.01938305e-04, -8.50163460e-04,
                7.86345898e-04
            ],
            [
                1.42422340e-04, 2.08409253e-04, 2.30234810e-03, 1.05173819e-02,
                7.18778255e-03, 3.01653938e-04, 1.92941138e-03, 3.45440744e-04,
                -1.68474000e-04, -1.32749852e-03, -3.88959294e-06,
                1.01571852e-03, 4.12796924e-03, 4.42344666e-03, 2.02550600e-04,
                -4.73818716e-04, -3.92048460e-03, -5.23480469e-03,
                -3.25194653e-04, -1.67791843e-04, -2.82511099e-04,
                5.55569520e-04, -1.64653758e-03, 8.06099657e-04
            ],
            [
                2.04486622e-04, -8.84834157e-04, -6.46689718e-05,
                7.18778255e-03, 9.50704683e-03, 1.49734912e-04, 1.47859136e-03,
                7.57200682e-04, 1.75118873e-03, -1.16732079e-03, 1.67205577e-04,
                1.30789130e-03, 5.56862864e-03, 3.89106064e-03, 6.34461156e-04,
                -2.21720807e-04, -2.75015371e-03, -4.60434872e-03,
                -3.24526168e-04, -2.76180558e-04, -5.97294031e-04,
                1.93344698e-04, -9.52715986e-04, 5.87677939e-04
            ],
            [
                1.48895934e-04, -5.38863622e-04, -4.13346593e-04,
                3.01653938e-04, 1.49734912e-04, -1.55417380e-04,
                -1.06424999e-04, 2.23510411e-04, 3.28657767e-04, 1.15892732e-04,
                4.50485153e-04, 3.94875992e-04, 8.36244332e-04, 2.43455914e-04,
                1.45832218e-03, -5.76447763e-04, -7.39376354e-04,
                2.88268612e-04, -5.50352491e-04, 1.13584356e-04, 7.89003904e-05,
                5.38125780e-04, 4.25433682e-05, -2.81354063e-04
            ],
            [
                2.06409515e-04, -1.05339476e-03, -1.25324877e-03,
                1.92941138e-03, 1.47859136e-03, -1.06424999e-04,
                -1.36529301e-04, 6.20629048e-04, 1.60375792e-03, 1.64636209e-05,
                3.96322562e-04, 1.12435517e-03, 3.49494784e-03, 1.36813688e-03,
                1.28298565e-03, -5.12334230e-04, -1.55912422e-03,
                -3.68766423e-04, -4.84182689e-04, 3.71122436e-05,
                -3.62894440e-04, 2.33813902e-04, -1.66460914e-04, 2.07309866e-04
            ],
            [
                -2.33709773e-04, 1.64050800e-03, 1.53289884e-03, 3.45440744e-04,
                7.57200682e-04, 2.23510411e-04, 6.20629048e-04, -3.67789107e-03,
                -2.00458640e-03, 9.46528187e-05, -3.12459040e-04,
                -5.56529861e-04, -5.69656966e-04, -4.67461848e-04,
                -8.15325576e-05, -1.19321000e-04, -1.22126488e-04,
                3.45969306e-04, -1.86418551e-04, -3.79125875e-04,
                2.57890793e-03, -6.74254845e-04, 1.63802325e-04, -1.39078782e-03
            ],
            [
                -3.13328549e-05, 1.29225245e-03, 3.15541072e-03,
                -1.68474000e-04, 1.75118873e-03, 3.28657767e-04, 1.60375792e-03,
                -2.00458640e-03, -4.78303626e-03, 1.87283053e-03,
                -2.15698450e-04, -5.69656966e-04, -2.81348372e-03,
                -7.01298889e-04, 2.84287633e-05, -1.22126488e-04,
                -5.26086292e-04, 5.09857555e-04, -2.17717216e-04,
                -3.01813750e-04, 2.63006288e-03, -5.98042307e-04,
                2.61347253e-04, -1.39155816e-03
            ],
            [
                2.20590277e-05, 2.97628981e-04, 1.33131542e-04, -1.32749852e-03,
                -1.16732079e-03, 1.15892732e-04, 1.64636209e-05, 9.46528187e-05,
                1.87283053e-03, 1.01613708e-02, 5.83562563e-05, 1.82405441e-04,
                -2.13510850e-04, -9.23401445e-04, 3.18338029e-05,
                -2.49951768e-04, 1.01239269e-04, 1.24262880e-03,
                -1.69057669e-04, -4.68067801e-04, 8.01735658e-04,
                -5.85375617e-05, -3.03524667e-04, 3.71441921e-05
            ],
            [
                -5.96760076e-05, 3.32477156e-04, 4.06308049e-04,
                -3.88959294e-06, 1.67205577e-04, 4.50485153e-04, 3.96322562e-04,
                -3.12459040e-04, -2.15698450e-04, 5.83562563e-05,
                -2.37683664e-04, -1.00820724e-06, 5.46350679e-05,
                -6.22167785e-05, -2.35286920e-04, 3.44599816e-04,
                4.54213720e-04, -4.36862552e-05, -3.11255507e-05,
                -4.99389193e-04, 1.16254711e-04, -2.92590904e-04,
                8.70769585e-05, 1.42221938e-04
            ],
            [
                -4.19318917e-04, 2.94337731e-03, 2.75031698e-03, 1.01571852e-03,
                1.30789130e-03, 3.94875992e-04, 1.12435517e-03, -5.56529861e-04,
                -5.69656966e-04, 1.82405441e-04, -1.00820724e-06,
                -3.48065233e-03, -1.80270129e-03, -3.68495850e-04,
                -1.71541260e-04, -3.84085858e-04, -3.93147524e-04,
                7.67873192e-04, -3.81160855e-04, 1.63802325e-04, 1.45408981e-03,
                2.62624686e-03, -4.39640884e-04, -8.93777736e-05
            ],
            [
                -5.62169850e-05, 2.31865444e-03, 5.75505321e-03, 4.12796924e-03,
                5.56862864e-03, 8.36244332e-04, 3.49494784e-03, -5.69656966e-04,
                -2.81348372e-03, -2.13510850e-04, 5.46350679e-05,
                -1.80270129e-03, -3.83139815e-03, 1.95613800e-03,
                3.23663830e-04, -3.93147524e-04, -1.96556865e-03,
                -4.33049463e-05, -7.35402756e-04, 2.61347253e-04,
                1.49255712e-03, 2.47592589e-03, -3.98361500e-04, -1.42601772e-04
            ],
            [
                -1.75504655e-04, 4.73668211e-04, 1.25305096e-03, 4.42344666e-03,
                3.89106064e-03, 2.43455914e-04, 1.36813688e-03, -4.67461848e-04,
                -7.01298889e-04, -9.23401445e-04, -6.22167785e-05,
                -3.68495850e-04, 1.95613800e-03, 9.56281721e-03, 6.81779864e-05,
                -1.24771648e-04, -9.11915883e-04, -8.12254029e-04,
                -2.13636508e-04, 4.78477508e-04, 1.80296178e-04, 2.21238106e-04,
                7.10006822e-04, -4.77508039e-04
            ],
            [
                -1.72014512e-04, 8.80414601e-04, 1.16896635e-03, 2.02550600e-04,
                6.34461156e-04, 1.45832218e-03, 1.28298565e-03, -8.15325576e-05,
                2.84287633e-05, 3.18338029e-05, -2.35286920e-04,
                -1.71541260e-04, 3.23663830e-04, 6.81779864e-05,
                -3.41888213e-04, 8.98267671e-04, 1.19552222e-03, 2.23599380e-04,
                -2.80488988e-04, -3.80986538e-05, -7.42871005e-06,
                -3.53281275e-04, -1.74721966e-04, 6.10255775e-04
            ],
            [
                8.56076444e-05, -6.00916373e-04, -5.61508120e-04,
                -4.73818716e-04, -2.21720807e-04, -5.76447763e-04,
                -5.12334230e-04, -1.19321000e-04, -1.22126488e-04,
                -2.49951768e-04, 3.44599816e-04, -3.84085858e-04,
                -3.93147524e-04, -1.24771648e-04, 8.98267671e-04,
                -2.96738234e-03, -1.27731427e-03, -8.26750564e-05,
                4.09196155e-04, 1.23114564e-03, 1.63802325e-04, 3.27511140e-04,
                2.40015239e-03, -6.27780944e-04
            ],
            [
                1.14771918e-05, -4.73445080e-04, -1.23418296e-03,
                -3.92048460e-03, -2.75015371e-03, -7.39376354e-04,
                -1.55912422e-03, -1.22126488e-04, -5.26086292e-04,
                1.01239269e-04, 4.54213720e-04, -3.93147524e-04,
                -1.96556865e-03, -9.11915883e-04, 1.19552222e-03,
                -1.27731427e-03, -1.14920093e-03, 2.61945060e-03,
                -9.68249704e-05, 1.13683862e-03, 2.61347253e-04, 3.47559941e-04,
                2.34485934e-03, -6.98539227e-04
            ],
            [
                1.91982395e-04, -1.04607482e-05, -7.88614480e-04,
                -5.23480469e-03, -4.60434872e-03, 2.88268612e-04,
                -3.68766423e-04, 3.45969306e-04, 5.09857555e-04, 1.24262880e-03,
                -4.36862552e-05, 7.67873192e-04, -4.33049463e-05,
                -8.12254029e-04, 2.23599380e-04, -8.26750564e-05,
                2.61945060e-03, 1.18289699e-02, -4.43615813e-04,
                -1.56269702e-04, -1.02428633e-04, 1.07432641e-03,
                -8.15337240e-04, 1.31474420e-04
            ],
            [
                -2.09238522e-04, 2.83005611e-04, -1.86908130e-04,
                -3.25194653e-04, -3.24526168e-04, -5.50352491e-04,
                -4.84182689e-04, -1.86418551e-04, -2.17717216e-04,
                -1.69057669e-04, -3.11255507e-05, -3.81160855e-04,
                -7.35402756e-04, -2.13636508e-04, -2.80488988e-04,
                4.09196155e-04, -9.68249704e-05, -4.43615813e-04,
                1.13319733e-04, -5.46477381e-05, -2.24230857e-04,
                -5.88568819e-04, 2.87927599e-05, 6.86004667e-05
            ],
            [
                3.95561000e-06, -2.02814986e-04, -2.64108278e-04,
                -1.67791843e-04, -2.76180558e-04, 1.13584356e-04,
                3.71122436e-05, -3.79125875e-04, -3.01813750e-04,
                -4.68067801e-04, -4.99389193e-04, 1.63802325e-04,
                2.61347253e-04, 4.78477508e-04, -3.80986538e-05, 1.23114564e-03,
                1.13683862e-03, -1.56269702e-04, -5.46477381e-05,
                -3.23774285e-03, -5.57474913e-04, 1.17309826e-04,
                -6.82424300e-04, 7.38215308e-05
            ],
            [
                1.84495191e-05, -9.45957544e-04, -1.23186184e-03,
                -2.82511099e-04, -5.97294031e-04, 7.89003904e-05,
                -3.62894440e-04, 2.57890793e-03, 2.63006288e-03, 8.01735658e-04,
                1.16254711e-04, 1.45408981e-03, 1.49255712e-03, 1.80296178e-04,
                -7.42871005e-06, 1.63802325e-04, 2.61347253e-04,
                -1.02428633e-04, -2.24230857e-04, -5.57474913e-04,
                -3.97812898e-03, -3.54408964e-04, -2.06097407e-04,
                7.06018543e-04
            ],
            [
                3.02437739e-06, -1.55068145e-04, -2.01938305e-04,
                5.55569520e-04, 1.93344698e-04, 5.38125780e-04, 2.33813902e-04,
                -6.74254845e-04, -5.98042307e-04, -5.85375617e-05,
                -2.92590904e-04, 2.62624686e-03, 2.47592589e-03, 2.21238106e-04,
                -3.53281275e-04, 3.27511140e-04, 3.47559941e-04, 1.07432641e-03,
                -5.88568819e-04, 1.17309826e-04, -3.54408964e-04,
                -3.43055067e-03, -2.49039387e-04, -4.57292731e-04
            ],
            [
                1.27328286e-05, -6.52847117e-04, -8.50163460e-04,
                -1.64653758e-03, -9.52715986e-04, 4.25433682e-05,
                -1.66460914e-04, 1.63802325e-04, 2.61347253e-04,
                -3.03524667e-04, 8.70769585e-05, -4.39640884e-04,
                -3.98361500e-04, 7.10006822e-04, -1.74721966e-04,
                2.40015239e-03, 2.34485934e-03, -8.15337240e-04, 2.87927599e-05,
                -6.82424300e-04, -2.06097407e-04, -2.49039387e-04,
                -3.00037745e-03, -3.98183911e-04
            ],
            [
                -1.17770359e-05, 6.03840996e-04, 7.86345898e-04, 8.06099657e-04,
                5.87677939e-04, -2.81354063e-04, 2.07309866e-04,
                -1.39078782e-03, -1.39155816e-03, 3.71441921e-05,
                1.42221938e-04, -8.93777736e-05, -1.42601772e-04,
                -4.77508039e-04, 6.10255775e-04, -6.27780944e-04,
                -6.98539227e-04, 1.31474420e-04, 6.86004667e-05, 7.38215308e-05,
                7.06018543e-04, -4.57292731e-04, -3.98183911e-04,
                -3.22974295e-03
            ]
        ])

    def get_density_matrix(self):

        return np.array([
            [
                2.13339302e+00, 2.73557830e-01, 2.43455879e-01, 7.27621176e-02,
                -8.10626607e-03, 7.57480846e-02, -7.96385623e-03,
                -1.93475762e-04, -4.93022241e-03, 3.20216961e-03,
                -3.49155699e-03, -5.75394141e-02, -7.22454170e-02,
                -1.38225865e-02, -1.30967759e-02, -3.15495453e-03,
                -5.29571121e-03, 1.60960694e-02, -1.67111162e-02,
                2.37019737e-04, 3.88671875e-04, -2.37017366e-03,
                -8.74388233e-05, -3.81582441e-04
            ],
            [
                2.73557830e-01, 6.73301370e-01, 4.42107854e-01, 1.31828491e-01,
                -9.68947057e-03, 1.40881467e-01, -8.92153794e-03,
                5.54013414e-03, -5.38192462e-03, 5.24205029e-03,
                -4.71336760e-03, -1.10704950e-01, -1.48136982e-01,
                -2.08376621e-02, -2.03177885e-02, -4.53780122e-03,
                -1.02313355e-02, 2.38158420e-02, -2.49932152e-02,
                1.83371203e-03, 1.09209288e-03, -4.49382522e-03,
                -2.48564780e-04, 2.40313871e-03
            ],
            [
                2.43455879e-01, 4.42107854e-01, 3.78598969e-01, -5.84623238e-03,
                -1.65478624e-02, -2.01869913e-02, -2.81288531e-02,
                -2.35767567e-02, -2.51093365e-02, 1.42122578e-04,
                7.28819232e-05, -2.97696314e-01, -2.42404421e-01,
                -1.28974029e-02, -1.33460507e-02, -1.96399881e-02,
                -1.55221555e-02, 5.99256306e-04, -5.72064897e-04,
                4.93572258e-04, 8.53686669e-05, -9.47839769e-03,
                -1.17965978e-03, -3.90031197e-04
            ],
            [
                7.27621176e-02, 1.31828491e-01, -5.84623238e-03, 3.41984616e-01,
                4.98787976e-02, -4.89110875e-02, -2.51801335e-02,
                -4.10974038e-02, -1.61749872e-02, 6.93536380e-03,
                -9.97647262e-04, 2.63665970e-01, 1.53079459e-01,
                -2.63639790e-02, 1.54400118e-02, -2.99377648e-01,
                -1.46733824e-01, 3.83884090e-02, -1.03712536e-02,
                8.63632799e-04, -2.45214231e-03, 7.95136593e-03,
                -1.48074556e-02, 2.17903892e-03
            ],
            [
                -8.10626607e-03, -9.68947057e-03, -1.65478624e-02,
                4.98787976e-02, 9.10691559e-03, -2.65634205e-02,
                -6.23725768e-03, -1.20940673e-02, -5.98249210e-03,
                6.83758110e-04, 2.71030847e-04, 3.61762969e-02, 2.40908044e-02,
                -3.82098076e-03, 4.01378872e-03, -5.77256574e-02,
                -2.78469569e-02, 4.71153589e-03, 7.67217714e-04, 9.81223689e-06,
                -6.19339387e-04, 1.17326455e-03, -2.87938251e-03, 1.25026391e-04
            ],
            [
                7.57480846e-02, 1.40881467e-01, -2.01869913e-02,
                -4.89110875e-02, -2.65634205e-02, 3.62672114e-01,
                7.10926718e-02, 7.35540337e-02, 3.89447366e-02, 2.19434547e-03,
                -9.67004384e-03, 2.34438170e-01, 1.36611991e-01, 1.40072175e-02,
                -2.25539650e-02, 3.19053661e-01, 1.56229962e-01, 9.49116921e-03,
                -3.71858661e-02, 1.50528708e-03, 3.38617482e-03, 5.98949821e-03,
                1.60790444e-02, 3.33877198e-03
            ],
            [
                -7.96385623e-03, -8.92153794e-03, -2.81288531e-02,
                -2.51801335e-02, -6.23725768e-03, 7.10926718e-02,
                1.62959715e-02, 1.23197621e-02, 5.74149025e-03, -1.31656170e-04,
                -1.96535875e-03, 5.05949696e-02, 3.40192177e-02, 4.73309519e-03,
                -4.05016170e-03, 7.59697816e-02, 3.78486145e-02,
                -8.17686898e-05, -6.33174167e-03, 2.05259891e-04,
                6.15488623e-04, 1.35469587e-03, 3.80244967e-03, 5.40619038e-04
            ],
            [
                -1.93475762e-04, 5.54013414e-03, -2.35767567e-02,
                -4.10974038e-02, -1.20940673e-02, 7.35540337e-02,
                1.23197621e-02, 7.75861178e-01, 6.18363269e-01, 3.01860899e-02,
                3.12461237e-02, -1.56582888e-02, -9.98800475e-03,
                3.23819358e-03, -7.18553522e-03, -6.04145208e-02,
                -6.93873491e-02, -8.93568510e-03, -1.22288990e-02,
                4.64058527e-04, 2.05585121e-02, -2.03885708e-04, 8.07360259e-04,
                8.75504241e-04
            ],
            [
                -4.93022241e-03, -5.38192462e-03, -2.51093365e-02,
                -1.61749872e-02, -5.98249210e-03, 3.89447366e-02,
                5.74149025e-03, 6.18363269e-01, 4.94646964e-01, 2.44285743e-02,
                2.55555922e-02, -8.08203797e-03, -4.15940755e-03,
                1.02578926e-03, -3.73606415e-03, -7.69164620e-02,
                -6.95428124e-02, -6.07463975e-03, -8.35244464e-03,
                3.22838266e-04, 1.62420698e-02, 3.61336356e-05, -7.66080114e-04,
                6.30734975e-04
            ],
            [
                3.20216961e-03, 5.24205029e-03, 1.42122578e-04, 6.93536380e-03,
                6.83758110e-04, 2.19434547e-03, -1.31656170e-04, 3.01860899e-02,
                2.44285743e-02, 1.39372010e-03, 1.21659989e-03, 5.41951639e-03,
                2.87957729e-03, -5.61672146e-04, 2.38775659e-05,
                -9.61431422e-03, -6.33155495e-03, 6.32119955e-04,
                -8.13584707e-04, 4.43365305e-05, 7.69774976e-04, 1.70919902e-04,
                -3.23140412e-04, 9.38691414e-05
            ],
            [
                -3.49155699e-03, -4.71336760e-03, 7.28819232e-05,
                -9.97647262e-04, 2.71030847e-04, -9.67004384e-03,
                -1.96535875e-03, 3.12461237e-02, 2.55555922e-02, 1.21659989e-03,
                1.71031415e-03, -1.01000264e-02, -5.99005871e-03,
                -2.98486167e-04, 4.39969586e-04, -1.32426845e-02,
                -8.22340573e-03, -8.36870392e-04, 8.29066505e-04,
                -3.53410528e-05, 7.80999606e-04, -2.54675744e-04,
                -5.00626111e-04, -8.72362988e-05
            ],
            [
                -5.75394141e-02, -1.10704950e-01, -2.97696314e-01,
                2.63665970e-01, 3.61762969e-02, 2.34438170e-01, 5.05949696e-02,
                -1.56582888e-02, -8.08203797e-03, 5.41951639e-03,
                -1.01000264e-02, 6.18455714e-01, 4.10856954e-01,
                -2.96715638e-03, 6.97343528e-03, -3.26258863e-03,
                5.30714634e-03, 3.99663587e-02, -3.49413544e-02, 1.44695391e-03,
                -1.05002176e-03, 1.82090956e-02, -4.23176283e-05, 4.54100761e-03
            ],
            [
                -7.22454170e-02, -1.48136982e-01, -2.42404421e-01,
                1.53079459e-01, 2.40908044e-02, 1.36611991e-01, 3.40192177e-02,
                -9.98800475e-03, -4.15940755e-03, 2.87957729e-03,
                -5.99005871e-03, 4.10856954e-01, 2.81480063e-01, 6.48403667e-04,
                6.65960336e-03, 9.84161244e-04, 5.83238133e-03, 2.28851119e-02,
                -1.97535041e-02, 7.26370728e-04, -7.69957759e-04,
                1.22335566e-02, 1.30402088e-04, 2.65805537e-03
            ],
            [
                -1.38225865e-02, -2.08376621e-02, -1.28974029e-02,
                -2.63639790e-02, -3.82098076e-03, 1.40072175e-02,
                4.73309519e-03, 3.23819358e-03, 1.02578926e-03, -5.61672146e-04,
                -2.98486167e-04, -2.96715638e-03, 6.48403667e-04,
                2.76874778e-03, -1.28351004e-03, 3.18198523e-02, 1.59261315e-02,
                -2.58004850e-03, -1.86043099e-04, -4.02451880e-05,
                2.02317399e-04, -1.03002427e-04, 1.57612823e-03, -5.78681857e-05
            ],
            [
                -1.30967759e-02, -2.03177885e-02, -1.33460507e-02,
                1.54400118e-02, 4.01378872e-03, -2.25539650e-02,
                -4.05016170e-03, -7.18553522e-03, -3.73606415e-03,
                2.38775659e-05, 4.39969586e-04, 6.97343528e-03, 6.65960336e-03,
                -1.28351004e-03, 2.41038383e-03, -2.85594982e-02,
                -1.36484725e-02, 8.12871012e-04, 1.88029310e-03,
                -7.71664578e-05, -3.50609461e-04, 2.92180166e-04,
                -1.43349212e-03, -1.04845305e-04
            ],
            [
                -3.15495453e-03, -4.53780122e-03, -1.96399881e-02,
                -2.99377648e-01, -5.77256574e-02, 3.19053661e-01,
                7.59697816e-02, -6.04145208e-02, -7.69164620e-02,
                -9.61431422e-03, -1.32426845e-02, -3.26258863e-03,
                9.84161244e-04, 3.18198523e-02, -2.85594982e-02, 5.06295471e-01,
                2.56075763e-01, -2.06245881e-02, -1.96463070e-02,
                4.38021037e-04, 6.11150575e-04, -1.01244725e-03, 2.45418827e-02,
                8.44393150e-04
            ],
            [
                -5.29571121e-03, -1.02313355e-02, -1.55221555e-02,
                -1.46733824e-01, -2.78469569e-02, 1.56229962e-01,
                3.78486145e-02, -6.93873491e-02, -6.95428124e-02,
                -6.33155495e-03, -8.22340573e-03, 5.30714634e-03,
                5.83238133e-03, 1.59261315e-02, -1.36484725e-02, 2.56075763e-01,
                1.31608056e-01, -9.77412566e-03, -9.23402866e-03,
                1.88986086e-04, -7.47865302e-04, -3.02150738e-04,
                1.22262326e-02, 3.91026322e-04
            ],
            [
                1.60960694e-02, 2.38158420e-02, 5.99256306e-04, 3.83884090e-02,
                4.71153589e-03, 9.49116921e-03, -8.17686898e-05,
                -8.93568510e-03, -6.07463975e-03, 6.32119955e-04,
                -8.36870392e-04, 3.99663587e-02, 2.28851119e-02,
                -2.58004850e-03, 8.12871012e-04, -2.06245881e-02,
                -9.77412566e-03, 5.02262632e-03, -2.75632827e-03,
                1.65145296e-04, -3.29982825e-04, 1.15241026e-03,
                -1.04324188e-03, 3.91029859e-04
            ],
            [
                -1.67111162e-02, -2.49932152e-02, -5.72064897e-04,
                -1.03712536e-02, 7.67217714e-04, -3.71858661e-02,
                -6.33174167e-03, -1.22288990e-02, -8.35244464e-03,
                -8.13584707e-04, 8.29066505e-04, -3.49413544e-02,
                -1.97535041e-02, -1.86043099e-04, 1.88029310e-03,
                -1.96463070e-02, -9.23402866e-03, -2.75632827e-03,
                4.60008319e-03, -2.09361887e-04, -4.20696403e-04,
                -9.35392706e-04, -1.03371796e-03, -4.62847551e-04
            ],
            [
                2.37019737e-04, 1.83371203e-03, 4.93572258e-04, 8.63632799e-04,
                9.81223689e-06, 1.50528708e-03, 2.05259891e-04, 4.64058527e-04,
                3.22838266e-04, 4.43365305e-05, -3.53410528e-05, 1.44695391e-03,
                7.26370728e-04, -4.02451880e-05, -7.71664578e-05,
                4.38021037e-04, 1.88986086e-04, 1.65145296e-04, -2.09361887e-04,
                1.10067938e-05, 1.56684818e-05, 3.79541663e-05, 2.41198150e-05,
                2.27994584e-05
            ],
            [
                3.88671875e-04, 1.09209288e-03, 8.53686669e-05, -2.45214231e-03,
                -6.19339387e-04, 3.38617482e-03, 6.15488623e-04, 2.05585121e-02,
                1.62420698e-02, 7.69774976e-04, 7.80999606e-04, -1.05002176e-03,
                -7.69957759e-04, 2.02317399e-04, -3.50609461e-04,
                6.11150575e-04, -7.47865302e-04, -3.29982825e-04,
                -4.20696403e-04, 1.56684818e-05, 5.56234280e-04,
                -2.96772667e-05, 1.29682588e-04, 2.68795865e-05
            ],
            [
                -2.37017366e-03, -4.49382522e-03, -9.47839769e-03,
                7.95136593e-03, 1.17326455e-03, 5.98949821e-03, 1.35469587e-03,
                -2.03885708e-04, 3.61336356e-05, 1.70919902e-04,
                -2.54675744e-04, 1.82090956e-02, 1.22335566e-02,
                -1.03002427e-04, 2.92180166e-04, -1.01244725e-03,
                -3.02150738e-04, 1.15241026e-03, -9.35392706e-04,
                3.79541663e-05, -2.96772667e-05, 5.40199285e-04,
                -4.49226976e-05, 1.26316530e-04
            ],
            [
                -8.74388233e-05, -2.48564780e-04, -1.17965978e-03,
                -1.48074556e-02, -2.87938251e-03, 1.60790444e-02,
                3.80244967e-03, 8.07360259e-04, -7.66080114e-04,
                -3.23140412e-04, -5.00626111e-04, -4.23176283e-05,
                1.30402088e-04, 1.57612823e-03, -1.43349212e-03, 2.45418827e-02,
                1.22262326e-02, -1.04324188e-03, -1.03371796e-03,
                2.41198150e-05, 1.29682588e-04, -4.49226976e-05, 1.20785238e-03,
                4.69600694e-05
            ],
            [
                -3.81582441e-04, 2.40313871e-03, -3.90031197e-04,
                2.17903892e-03, 1.25026391e-04, 3.33877198e-03, 5.40619038e-04,
                8.75504241e-04, 6.30734975e-04, 9.38691414e-05, -8.72362988e-05,
                4.54100761e-03, 2.65805537e-03, -5.78681857e-05,
                -1.04845305e-04, 8.44393150e-04, 3.91026322e-04, 3.91029859e-04,
                -4.62847551e-04, 2.27994584e-05, 2.68795865e-05, 1.26316530e-04,
                4.69600694e-05, 5.30455980e-05
            ]
        ])

    def get_ref_efield_values(self):

        return np.array([[0.30819164, 0.1407961, -0.17077593],
                         [0.15878104, 0.09449123, -0.1091145],
                         [0.31941897, 0.22404459, -0.05999211],
                         [0.18979857, 0.26284813, 0.15393668],
                         [0.32900082, 0.57391675, 0.40568029],
                         [0.13652974, 0.14491248, 0.16460436]])

    def test_electric_field_integrals(self):

        mol, bas = self.get_molecule_and_basis()
        dipole_coords = self.get_dipole_coords()
        dipole_moments = self.get_dipole_moments()

        ef_ints = compute_electric_field_integrals(mol, bas, dipole_coords,
                                                   dipole_moments)
        ref_ef_ints = self.get_ref_efield_ints()

        assert np.max(np.abs(ef_ints - ref_ef_ints)) < 1.0e-9

        D = self.get_density_matrix()
        ref_ef_ints_grad = np.array([[-0.01095448, 0.02786098, 0.05138568],
                                     [-0.00363478, -0.00041103, 0.00387827],
                                     [-0.00075801, 0.00065281, 0.00201409]])

        ef_ints_grad = compute_electric_field_integrals_gradient(
            mol, bas, dipole_coords, dipole_moments, D)
        assert np.max(np.abs(ef_ints_grad - ref_ef_ints_grad)) < 1.0e-8

        for i in range(mol.number_of_atoms()):
            ef_fock_grad = compute_electric_field_fock_gradient(
                mol, bas, dipole_coords, dipole_moments, i)
            for d in range(3):
                assert abs(np.sum(ef_fock_grad[d] * D) -
                           ef_ints_grad[i, d]) < 1.0e-10

            ef_grad_for_mm = compute_electric_field_potential_gradient_for_mm(
                mol, bas, dipole_coords, D, i)
            ndipoles = ef_grad_for_mm.shape[1]
            for d in range(3):
                ef_grad = 0.0
                for c in range(ndipoles):
                    ef_grad -= np.dot(ef_grad_for_mm[d, c, :],
                                      dipole_moments[c])
                assert abs(ef_grad - ef_ints_grad[i, d]) < 1.0e-10

    def test_electric_field_values(self):

        mol, bas = self.get_molecule_and_basis()
        dipole_coords = self.get_dipole_coords()
        D = self.get_density_matrix()

        ef_vals = compute_electric_field_values(mol, bas, dipole_coords, D)
        ref_ef_vals = self.get_ref_efield_values()

        assert np.max(np.abs(ef_vals - ref_ef_vals)) < 1.0e-7
